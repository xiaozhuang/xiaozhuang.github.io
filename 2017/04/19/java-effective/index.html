<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Java," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Effective Java2 笔记">
<meta name="keywords" content="Java">
<meta property="og:type" content="article">
<meta property="og:title" content="Effective Java">
<meta property="og:url" content="http://xiaozhuang.github.io/2017/04/19/java-effective/index.html">
<meta property="og:site_name" content="Communicat &amp; Happy Together">
<meta property="og:description" content="Effective Java2 笔记">
<meta property="og:updated_time" content="2019-08-01T05:16:48.406Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Effective Java">
<meta name="twitter:description" content="Effective Java2 笔记">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 6286766081142949000,
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>




  <title> Effective Java | Communicat & Happy Together </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Communicat & Happy Together</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Effective Java
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-04-19T22:14:18+08:00" content="2017-04-19">
              2017-04-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Note/" itemprop="url" rel="index">
                    <span itemprop="name">Note</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Effective Java2 笔记<br><a id="more"></a></p>
<h1 id="创建和销毁对象"><a href="#创建和销毁对象" class="headerlink" title="创建和销毁对象"></a>创建和销毁对象</h1><h2 id="考虑用静态工厂方法代替构造器"><a href="#考虑用静态工厂方法代替构造器" class="headerlink" title="考虑用静态工厂方法代替构造器"></a>考虑用静态工厂方法代替构造器</h2><p><code>tip-1</code><br>需要多个相同签名的构造器时，用静态工厂方法代替构造器</p>
<p>静态工厂方法惯用名称：</p>
<ul>
<li>valueOf</li>
<li>of</li>
<li>getInstance</li>
<li>newInstance</li>
<li>getType</li>
<li>newType</li>
</ul>
<h2 id="遇到多个构造器参数时考虑用构造器"><a href="#遇到多个构造器参数时考虑用构造器" class="headerlink" title="遇到多个构造器参数时考虑用构造器"></a>遇到多个构造器参数时考虑用构造器</h2><p><code>tip-2</code><br>Builder模式解决的问题</p>
<ul>
<li>构造器参数列表过长不易使用</li>
<li>JavaBeans模式阻止了把类做成不可变类的可能，也不易检查参数约束条件</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Baz</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Long id;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer age;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Date birthday;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Baz</span><span class="params">(Long id, String name, Integer age, Date birthday)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.id = id;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.age = age;</div><div class="line">        <span class="keyword">this</span>.birthday = birthday;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> age;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getBirthday</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> birthday;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BazBuilder <span class="title">builder</span><span class="params">(Long id, String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BazBuilder( id, name);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BazBuilder</span></span>&#123;</div><div class="line">        <span class="keyword">private</span> Long id;</div><div class="line">        <span class="keyword">private</span> String name;</div><div class="line">        <span class="keyword">private</span> Integer age;</div><div class="line">        <span class="keyword">private</span> Date birthday;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BazBuilder</span><span class="params">(Long id, String name)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.id = id;</div><div class="line">            <span class="keyword">this</span>.name = name;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> BazBuilder <span class="title">setAge</span><span class="params">(Integer age)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.age = age;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> BazBuilder <span class="title">setBirthday</span><span class="params">(Date birthday)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.birthday = birthday;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> Baz <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Baz(id, name, age, birthday);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Baz baz = Baz.builder(<span class="number">1000L</span>, <span class="string">"Baz"</span>).setAge(<span class="number">7</span>).setBirthday(<span class="keyword">new</span> Date()).build();</div><div class="line">        System.out.println(JSON.toJSON(baz));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>类的构造器或者静态工厂具有多个参数时，<code>Builder模式</code>就是不错的选择</p>
<h2 id="用私有构造器或者枚举类型强化Singleton属性"><a href="#用私有构造器或者枚举类型强化Singleton属性" class="headerlink" title="用私有构造器或者枚举类型强化Singleton属性"></a>用私有构造器或者枚举类型强化Singleton属性</h2><p><code>tip-3</code><br>私有构造器单例需要处理反射调用私有构造器攻击，且需声明所有实例域都是<code>transient</code>，并提供readResolve方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance = <span class="keyword">new</span> Singleton();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">readResolve</span><span class="params">()</span> <span class="keyword">throws</span> ObjectStreamException </span>&#123;  </div><div class="line">      <span class="comment">// instead of the object we're on,   </span></div><div class="line">      <span class="comment">// return the class variable INSTANCE  </span></div><div class="line">      <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>readResolve is used for replacing the object read from the stream. The only use I’ve ever seen for this is enforcing singletons; when an object is read, replace it with the singleton instance. This ensures that nobody can create another instance by serializing and deserializing the singleton.</p>
<a href="https://stackoverflow.com/questions/1168348/java-serialization-readobject-vs-readresolve" title="readResolve()" target="_blank" rel="external">readResolve()</a>
<p>单元素枚举类型，无偿地提供了序列化机制，绝对防止多次实例化，即使是在面对复杂的序列化或 反射攻击的时候。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Employee &#123; <span class="comment">// changed "class" to "enum"</span></div><div class="line"></div><div class="line">   INSTANCE; <span class="comment">// added name of the (single) instance</span></div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">int</span> id; </div><div class="line">   <span class="keyword">private</span> String name; </div><div class="line">   Employee() &#123;&#125;</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> id; </div><div class="line">   &#125;</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">( <span class="keyword">int</span> id )</span> </span>&#123; </div><div class="line">      <span class="keyword">this</span>.id = id; </div><div class="line">   &#125; </div><div class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123; </div><div class="line">      <span class="keyword">return</span> name; </div><div class="line">   &#125; </div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">( String name )</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>.name = name; </div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>单元素的枚举类型已经成为实现Singleton的最佳方法</p>
<h2 id="避免创建不必要的对象"><a href="#避免创建不必要的对象" class="headerlink" title="避免创建不必要的对象"></a>避免创建不必要的对象</h2><p><code>tip-5</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 静态构造方法优先于构造器</span></div><div class="line">Boolean.valueOf(<span class="string">"true"</span>);</div></pre></td></tr></table></figure>
<p>优先使用基本类型而不是装箱的基本类型，要当心无意识的自动装箱</p>
<p>维护自己的对象池（object pool）来避免创建对象<code>并不是</code>一种好的做法</p>
<h2 id="消除过期的对象引用"><a href="#消除过期的对象引用" class="headerlink" title="消除过期的对象引用"></a>消除过期的对象引用</h2><p><code>tip-6</code></p>
<p>只要类自己管理内存，程序员就应该警惕内存泄漏问题</p>
<p>内存泄漏的另一个常见来源是<code>缓存</code></p>
<h2 id="避免使用终结方法"><a href="#避免使用终结方法" class="headerlink" title="避免使用终结方法"></a>避免使用终结方法</h2><p><code>tip-7</code><br>不应该依赖终结方法来更新重要的持久状态</p>
<p>使用终结方法有一个非常严重的（severe）性能损失</p>
<p>如果子类实现覆盖了超类的终结方法，但是忘了手工调用超类的终结方法，<br>那么超类的终结方法将永远也不会被调用</p>
<p>除非作为安全网，或者为了终止非关键的本地资源，否则不要使用终结方法</p>
<h1 id="对所有对象都通用的方法"><a href="#对所有对象都通用的方法" class="headerlink" title="对所有对象都通用的方法"></a>对所有对象都通用的方法</h1><h2 id="覆盖equals时请遵守通用约定"><a href="#覆盖equals时请遵守通用约定" class="headerlink" title="覆盖equals时请遵守通用约定"></a>覆盖equals时请遵守通用约定</h2><p><code>tip-8</code><br>equals方法的通用约定</p>
<ul>
<li>自反性</li>
<li>对称性</li>
<li>传递性</li>
<li>一致性  多次调用，一致地返回true或false</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line">    <span class="comment">//instanceof 第一个参数为null，无论第二个参数是哪种类型，都返回false</span></div><div class="line">    <span class="keyword">if</span>(!(obj <span class="keyword">instanceof</span> MyType))&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于非float 和 double类型的<code>基本类型域</code>，可以使用 == 操作符进行比较<br>float域，使用Float.compare方法<br>double域，使用Double.compare方法<br>数组域使用Arrays.equals方法</p>
<blockquote>
<p>如果 f1 和 f2 都表示 Float.NaN，那么即使 Float.NaN==Float.NaN 的值为 false，equals 方法也将返回 true<br>如果 f1 表示 +0.0f，而 f2 表示 -0.0f，或相反，那么即使 0.0f==-0.0f 的值为 true，equal 测试也将返回 false</p>
</blockquote>
<p>域的比较影响equals方法的性能，应该优先比较<code>最有可能不一致的域</code></p>
<p><code>不要</code>将equals声明中的Object对象替换为其他类型</p>
<h2 id="覆盖equals方法时总要覆盖hashCode"><a href="#覆盖equals方法时总要覆盖hashCode" class="headerlink" title="覆盖equals方法时总要覆盖hashCode"></a>覆盖equals方法时总要覆盖hashCode</h2><p><code>tip-9</code></p>
<ul>
<li>每个覆盖了equals方法的类中，也<code>必须</code>覆盖hashCode方法</li>
<li><p>相等的对象<code>必须</code>具有相等的散列码</p>
</li>
<li><p>hashCode计算必须排除equals比较计算中没有用到的任何域</p>
</li>
</ul>
<h2 id="始终要覆盖toString"><a href="#始终要覆盖toString" class="headerlink" title="始终要覆盖toString"></a>始终要覆盖toString</h2><p><code>tip-10</code></p>
<p>toString通用约定：<code>简洁</code>的，但<code>信息丰富</code>，并且<code>易于阅读</code>的表达形式。</p>
<p>toString方法应该返回对象中包含的<code>所有值得关注的信息</code>。</p>
<p>最好提供一个相匹配的静态工厂或构造器，以便在<code>对象</code>和他的<code>字符串表示法</code>之间转换。</p>
<p>toStrig方法间接提供了对象访问途径，应<code>避免暴露内部数据</code>。</p>
<h1 id="类和接口"><a href="#类和接口" class="headerlink" title="类和接口"></a>类和接口</h1><h2 id="使类和成员的可访问性最小"><a href="#使类和成员的可访问性最小" class="headerlink" title="使类和成员的可访问性最小"></a>使类和成员的可访问性最小</h2><p><code>tip-13</code><br>设计良好的模块会<code>隐藏所有的实现细节</code>，把它的API与它的实现清晰地隔离开来。</p>
<p><code>信息隐藏</code>可以有效地解除组成系统的各模块之间的耦合关系，<br>使得这些模块可以独立地开发、测试、优化、使用、理解和修改。</p>
<p>信息隐藏也降低了构建大型业务系统的风险。</p>
<p><code>尽可能地使每个类或成员不被外界访问</code><br>对于顶层(非嵌套的)类和接口，<code>只有两种</code>可能的访问级别：<br>包级私有的(package-private)和公有的(public)</p>
<p>如果包级私有的顶层类(或者接口)<code>只在某一个类的内部</code>被用到，<br>就应该考虑使它成为唯一使用它的那个类的<code>私有嵌套类</code>。</p>
<p>实例域<code>绝不能</code>是公有的，同样的建议也适用于静态域，只有静态常量可以为公有。</p>
<p>长度非零的数组总是可变的。<br>类具有公有的静态final数组域，或者返回这种域的访问方法，这几乎总是错误的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 可以返回数组的不可变列表</span></div><div class="line">Integer[] values = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</div><div class="line">List&lt;Integer&gt; asList = Collections.unmodifiableList(Arrays.asList(values));</div><div class="line"></div><div class="line"><span class="comment">// 或返回数组的拷贝</span></div><div class="line">Integer[] clone = values.clone();</div></pre></td></tr></table></figure>
<p>如果类可以在它<code>所在的包的外部</code>进行访问，就提供访问方法</p>
<p>如果类是<code>包级私有的</code>，或者是<code>私有的嵌套类</code>，直接暴露他的数据域并没有本质的错误</p>
<h2 id="使可变性最小化"><a href="#使可变性最小化" class="headerlink" title="使可变性最小化"></a>使可变性最小化</h2><p><code>tip-15</code><br>Java平台类库中包含许多不可变类，<br>其中有String、基本类型的包装类、BigInteger和BigDecimal。</p>
<p>BigInteger和BigDecimal使用方法和场景<br>BigInteger：<code>不可变的</code>任意精度的整数。(long型最大只能有19位,但是用BigInteger可以表示更大的数字 )<br>BigDecimal：<code>不可变的</code>任意精度的有符号十进制数。</p>
<p>double转BigDecimal精度问题：<br>new BigDecimal(double d) 会导致精度不准确。 new BigDecimal(doubble+””)或<code>BigDecimal.valueOf(double)</code>可解决。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Create two new BigDecimals</span></div><div class="line">BigDecimal BigDec1 = <span class="keyword">new</span> BigDecimal(<span class="string">"1238126387123"</span>);</div><div class="line">BigDecimal BigDec2 = <span class="keyword">new</span> BigDecimal(<span class="string">"1213669989183"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 加 Addition of two BigDecimals</span></div><div class="line">BigDec1 = BigDec1.add(BigDec2);</div><div class="line">System.out.println(<span class="string">"BigDec1 = "</span> + BigDec1);</div><div class="line"></div><div class="line"><span class="comment">// 减 Multiplication of two BigDecimals</span></div><div class="line">BigDec1 = BigDec1.subtract(BigDec2);</div><div class="line">System.out.println(<span class="string">"BigDec1 = "</span> + BigDec1);</div><div class="line"></div><div class="line"><span class="comment">// 乘 Subtraction of two BigDecimals</span></div><div class="line">BigDec1 = BigDec1.multiply(BigDec2);</div><div class="line">System.out.println(<span class="string">"BigDec1 = "</span> + BigDec1);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 除 Division of two BigDecimals</span></div><div class="line">BigDec1 = BigDec1.divide(BigDec2);</div><div class="line">System.out.println(<span class="string">"BigDec1 = "</span> + BigDec1);</div><div class="line"><span class="comment">// 四舍五入，精度默认0</span></div><div class="line">BigDec11 = BigDec1.divide(BigDec2, RoundingMode.HALF_UP);</div><div class="line"></div><div class="line"><span class="comment">// 幂运算 BigDecima1 raised to the power of 2</span></div><div class="line">BigDec1 = BigDec1.pow(<span class="number">2</span>);</div><div class="line">System.out.println(<span class="string">"BigDec1 = "</span> + BigDec1);</div><div class="line"></div><div class="line"><span class="comment">// 取负值 Negate value of BigDecimal1</span></div><div class="line">BigDec1 = BigDec1.negate();</div><div class="line">System.out.println(<span class="string">"BigDec1 = "</span> + BigDec1);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// BigDecimal 转 double</span></div><div class="line"><span class="comment">// java.math.BigDecimal.doubleValue()</span></div><div class="line"></div><div class="line"><span class="comment">// double 转 BigDecimal</span></div><div class="line"><span class="comment">// java.math.BigDecimal.valueOf(double)</span></div></pre></td></tr></table></figure>
<p>如何进行浮点数精度计算？<br>Java中的简单浮点数类型float和double不能够进行运算。</p>
<p>CPU表示浮点数由两个部分组成：指数和尾数，这样的表示方法一般都会失去一定的精确度，有些浮点数运算也会产生一定的误差。<br>其实java的float只能用来进行科学计算或工程计算，在大多数的商业计算中，一般采用java.math.BigDecimal类来进行精确计算。</p>
<p>在使用BigDecimal类来进行计算的时候，主要分为以下<code>步骤</code>：<br>1、用float或者double变量构建BigDecimal对象。<br>2、通过调用BigDecimal的加，减，乘，除等相应的方法进行算术运算。<br>3、把BigDecimal对象转换成float，double，int等类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 验证double直接计算失精度 </span></div><div class="line">Random random = <span class="keyword">new</span> Random();</div><div class="line">        </div><div class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>;i++)&#123;</div><div class="line">    Double d1 = random.nextDouble();</div><div class="line">    BigDecimal bd1 = BigDecimal.valueOf(d1);</div><div class="line">    bd1 = bd1.setScale(<span class="number">2</span>,BigDecimal.ROUND_HALF_UP);</div><div class="line">    </div><div class="line">    Double d2 = random.nextDouble();</div><div class="line">    BigDecimal bd2 = BigDecimal.valueOf(d2);</div><div class="line">    bd2 = bd2.setScale(<span class="number">2</span>,BigDecimal.ROUND_HALF_UP);</div><div class="line">    </div><div class="line">    System.out.println(bd1.doubleValue() + <span class="string">" + "</span> + bd2.doubleValue() + <span class="string">" = "</span> + (bd1.doubleValue() + bd2.doubleValue()));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Double.valueOf(String) and Float.valueOf(String)都会丢失精度。</p>
</blockquote>
<p>不可变类比可变类更易于设计、实现和使用。</p>
<p>实现不可变类，4条原则：</p>
<ul>
<li>不提供任何会<code>修改对象</code>状态的方法</li>
<li>保证类不会被扩展（final类 或 工厂方法）</li>
<li>使所有域都是<code>私有</code>的<code>final</code>域</li>
<li>客户端无法获取到可变组件引用</li>
</ul>
<p>应该确保没有一个方法能够对对象的状态产生<code>外部可见</code>的改变。</p>
<p>不可变对象方法可以设计为<code>函数式</code>的</p>
<p>不可变对象<code>只有一种状态</code>，即对象创建时的状态。</p>
<p>不可变对象本质是<code>线程安全的</code>，他们不要求同步。</p>
<p>不可变对象可以被<code>自由地共享</code>。</p>
<p>不可变类可以提供一些静态工厂，把频繁被请求的实例缓存起来。</p>
<p>不可变类真正唯一的缺点是：对于每一个不同的值都需要一个单独的对象。<br>解决方法是提供可变配套类。String类，提供了公有的可变配套类StringBuilder。</p>
<p>许多不可变类拥有一个或多个非final的域，它们在第一次被请求执行计算时，把计算结果缓存在这些域中。<br>如：String的HashCode()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// java.lang.String.hashCode()</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> h = hash;</div><div class="line">        <span class="keyword">int</span> len = count;</div><div class="line">    <span class="keyword">if</span> (h == <span class="number">0</span> &amp;&amp; len &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">int</span> off = offset;</div><div class="line">        <span class="keyword">char</span> val[] = value;</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</div><div class="line">                h = <span class="number">31</span>*h + val[off++];</div><div class="line">            &#125;</div><div class="line">            hash = h;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> h;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>除非有令人信服的理由要使域变成非final的，否则要使每个域都是final的。</p>
<h2 id="复合优先于继承"><a href="#复合优先于继承" class="headerlink" title="复合优先于继承"></a>复合优先于继承</h2><p><code>tip-16</code></p>
<p>对<code>普通的具体类</code>进行<code>跨越包边界</code>的继承，是非常危险的</p>
<p>继承打破了封装性</p>
<p>只有当子类真实是超类的子类时，才适合用继承<br>只有两者存在“is-a”关系时，才使用继承</p>
<h2 id="要么为继承而设计，并提提供文档说明，要么就禁止继承"><a href="#要么为继承而设计，并提提供文档说明，要么就禁止继承" class="headerlink" title="要么为继承而设计，并提提供文档说明，要么就禁止继承"></a>要么为继承而设计，并提提供文档说明，要么就禁止继承</h2><p><code>tip-17</code><br>类的文档必须精确地描述覆盖每个方法所带来的影响。</p>
<p>类必须通过某种形式提供适当的钩子（hook），以便能够进入到它的<code>内部工作流程</code>中。<br>y<br>好的API文档应该描述给定方法<code>做了什么工作</code>，<code>而不是</code>描述它是<code>如何做到的</code>。</p>
<p>为继承而设计类，应该尽可能少地暴露受保护的成员。</p>
<p>为了继承而设计的类，唯一测试方法就是编写子类。（3个子类通常足以测试一个可扩展的类）</p>
<p>构造器决不能调用可被覆盖的方法。（因为子类中覆盖版本的方法将会在子类的构造器运行之前被调用）</p>
<h2 id="接口优于抽象类"><a href="#接口优于抽象类" class="headerlink" title="接口优于抽象类"></a>接口优于抽象类</h2><p><code>tip-18</code></p>
<p>通过对每个重要接口都提供一个抽象的骨架实现类，把接口和抽象类的优点结合起来。</p>
<p>实现这个接口的类可以把对于接口的调用，转发到一个内部私有类的实例上，这个内部私有类扩展了骨架实现类。</p>
<h2 id="接口只用于定义类型"><a href="#接口只用于定义类型" class="headerlink" title="接口只用于定义类型"></a>接口只用于定义类型</h2><p><code>tip-19</code><br>类实现接口时，接口就充当可以引用这个类的实例的类型（type）。</p>
<p>类实现接口，表明客户端可以<code>对这个类的实例实施某些动作</code>。任何其他目的定义接口都是不恰当的。</p>
<p>常量接口是对接口的<code>不良使用</code>。</p>
<p>使用<code>枚举类型</code>或不可实例化的<code>工具类</code>导出常量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhysicalConstants</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="title">PhysicalConstants</span><span class="params">()</span> </span>&#123; &#125;  <span class="comment">// Prevents instantiation</span></div><div class="line"></div><div class="line">  <span class="comment">// Avogadro's number (1/mol)</span></div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> AVOGADROS_NUMBER   = <span class="number">6.02214199e23</span>;</div><div class="line"></div><div class="line">  <span class="comment">// Boltzmann constant (J/K)</span></div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> BOLTZMANN_CONSTANT = <span class="number">1.3806503e-23</span>;</div><div class="line"></div><div class="line">  <span class="comment">// Mass of the electron (kg)</span></div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> ELECTRON_MASS      = <span class="number">9.10938188e-31</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="用函数对象表示策略"><a href="#用函数对象表示策略" class="headerlink" title="用函数对象表示策略"></a>用函数对象表示策略</h2><p><code>tip-21</code></p>
<p>函数指针主要用途是实现策略（Strategy）模式</p>
<p>通常被实现为私有的静态成员类，并通过共有的<code>静态final域</code>导出</p>
<h2 id="优先考虑静态成员类"><a href="#优先考虑静态成员类" class="headerlink" title="优先考虑静态成员类"></a>优先考虑静态成员类</h2><p><code>tip-22</code></p>
<p><code>内部类</code></p>
<p>嵌套类 指被定义在另一个类的内部的类。</p>
<p>嵌套类存在的目的<code>只是</code>为它的外围类提供服务。</p>
<p>嵌套类有4种：</p>
<ul>
<li>静态成员类</li>
<li>非静态成员类</li>
<li>匿名类</li>
<li>局部类</li>
</ul>
<p>静态成员类常见用法是作为共有的辅助类。如Calculator.Operation.PLUS</p>
<p>成员类不要求<code>访问外围实例</code>，始终把<code>static</code>修饰放在它的声明中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//非静态内部类，持有有外部类this</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Outer</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> String name = <span class="string">"MAH"</span>;</div><div class="line">    <span class="comment">//非静态内部类</span></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Inner</span></span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span> Num = <span class="number">4</span>; <span class="comment">//非静态内部类的Feild</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acc</span><span class="params">()</span> </span>&#123;</div><div class="line">            System.out.println(name); <span class="comment">//非静态内部类可以直接访问外部类的成员</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accessInner</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"内部类的Num值是："</span> + <span class="keyword">new</span> Inner().Num);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>匿名类的常见用法是动态地创建函数对象、创建过程对象（如Runnable、TimerTask）、静态工厂方法内部。</p>
<p>局部类是4中嵌套类中用的最少的类。 在任何“可以声明局部变量”的地方声明。</p>
<h1 id="泛型（generic）"><a href="#泛型（generic）" class="headerlink" title="泛型（generic）"></a>泛型（generic）</h1><h2 id="请不要在新代码中使用原生态类型"><a href="#请不要在新代码中使用原生态类型" class="headerlink" title="请不要在新代码中使用原生态类型"></a>请不要在新代码中使用原生态类型</h2><p><code>tip-23</code></p>
<p>无限制通配符类型，表示不确定或者不关心实际类型参数。【<code>Set&lt;?&gt;</code>】</p>
<p>两个使用原生态类型的例外，因为运行时类型擦除（erasure）：</p>
<ul>
<li>类文字中必须使用原生态类型</li>
<li>参数化类型上使用instanceof是非法的</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(o <span class="keyword">instanceof</span> Set)&#123;</div><div class="line">    <span class="comment">// 识别类型之后，必须将它转为通配符类型，而不是原生态类型</span></div><div class="line">    Set&lt;?&gt; m = (Set&lt;?&gt;)o;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="消除非受检警告"><a href="#消除非受检警告" class="headerlink" title="消除非受检警告"></a>消除非受检警告</h2><p><code>tip-24</code></p>
<p>尽可能消除每一个非受检警告（unchecked case warning）</p>
<p>无法消除警告，同时可以证明引起警告的代码是安全的，可以使用@SuppressWarnings(“unchecked”)禁止警告，并注释说明</p>
<h2 id="列表优于数组"><a href="#列表优于数组" class="headerlink" title="列表优于数组"></a>列表优于数组</h2><p><code>tip-25</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 运行时异常</span></div><div class="line">Object[] objectArray = <span class="keyword">new</span> Long[<span class="number">1</span>];</div><div class="line">objectArray[<span class="number">0</span>] = <span class="string">"fit"</span>; <span class="comment">// Throws ArrayStoreException</span></div><div class="line"></div><div class="line"><span class="comment">// 无法编译</span></div><div class="line">List&lt;Object&gt; ol = <span class="keyword">new</span> ArrayList&lt;Long&gt;();</div><div class="line">ol.add(<span class="string">"fit"</span>);</div></pre></td></tr></table></figure>
<p>泛型只在编译时强化类型信息，并在运行时丢弃（或者擦除）元素类型信息。</p>
<p>数组和泛型不能很好的混合使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">List&lt;String&gt;[] stringLists = <span class="keyword">new</span> List&lt;String&gt;[<span class="number">1</span>];</div><div class="line">List&lt;Integer&gt;[] intList = Arrays.asList(<span class="number">42</span>);</div><div class="line">Object[] objects = stringLists;</div><div class="line">objects[<span class="number">0</span>] = intList;</div><div class="line"><span class="comment">// 异常</span></div><div class="line">String s = stringLists[<span class="number">0</span>].get(<span class="number">0</span>);</div></pre></td></tr></table></figure>
<p>禁止创建泛型数组。</p>
<h2 id="优先考虑泛型"><a href="#优先考虑泛型" class="headerlink" title="优先考虑泛型"></a>优先考虑泛型</h2><p><code>tip-26</code><br><code>generic</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Stack</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">16</span>;</div><div class="line">    <span class="keyword">private</span> Object[] elements;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Stack</span><span class="params">(Object[] elements)</span> </span>&#123;</div><div class="line">        <span class="comment">// 不能创建不可具化的(non-reifiable)类型的数组</span></div><div class="line">        <span class="keyword">this</span>.elements = <span class="keyword">new</span> Object[DEFAULT_INITIAL_CAPACITY];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(E e)</span></span>&#123;</div><div class="line">        <span class="comment">// ensureCapacity()</span></div><div class="line">        elements[size++] = e;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> E <span class="title">pop</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="number">0</span> == size) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EmptyStackException();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// 把从数组中获取的元素转为E</span></div><div class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">        E result = (E) elements[--size];</div><div class="line">        elements[size] = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>必须确保未受检的转换是安全的；<br>相关的数组保存在一个私有的域中，不会被返回到客户端。</p>
<p>通配符类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// E 必须是Delayed的子类 ps.每个类型都是自身的子类型</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayQueue</span>&lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">Delayed</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">BlockingQueue</span>&lt;<span class="title">E</span>&gt;</span>;</div></pre></td></tr></table></figure>
<h2 id="优先考虑泛型方法"><a href="#优先考虑泛型方法" class="headerlink" title="优先考虑泛型方法"></a>优先考虑泛型方法</h2><p><code>tip-27</code></p>
<p>静态工具方法尤其适合于泛型化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 类型参数在方法修饰符及其返回类型之间</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; <span class="function">Set&lt;E&gt; <span class="title">union</span><span class="params">(Set&lt;E&gt; s1, Set&lt;E&gt; s2)</span></span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 编解码接口</div><div class="line"> * <span class="doctag">@author</span> wangdianzhuang</div><div class="line"> * <span class="doctag">@date</span> 2019/2/20</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Codec</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 解码</div><div class="line">     * <span class="doctag">@param</span> data</div><div class="line">     * <span class="doctag">@param</span> clazz</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    &lt;T&gt; <span class="function">T <span class="title">decode</span><span class="params">(String data, Class&lt;T&gt; clazz)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 编码</div><div class="line">     * <span class="doctag">@param</span> obj</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function">String <span class="title">encode</span><span class="params">(Object obj)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * fastjson 编解码</div><div class="line"> * <span class="doctag">@author</span> wangdianzhuang</div><div class="line"> * <span class="doctag">@date</span> 2019/2/20</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FastjsonCodec</span> <span class="keyword">implements</span> <span class="title">Codec</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">decode</span><span class="params">(String data, Class&lt;T&gt; clazz)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> JSON.parseObject(data, clazz);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> JSON.toJSONString(obj, SerializerFeature.WriteDateUseDateFormat);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>泛型方法 无需明确指定类型参数的值，编译期通过检查参数的类型来计算类型参数的值。</p>
<p><t extend="" comparable<t="">&gt;  针对可以与自身进行比较的每个类型T</t></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// extends 指定两个参数</span></div><div class="line"> <span class="keyword">private</span> &lt;T extends Enum &amp; ConfigOption&gt; <span class="function"><span class="keyword">void</span> <span class="title">parseConfigOptions</span><span class="params">(Class&lt;T&gt; configOptionType)</span></span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>应该确保新方法可以不用转换就能使用。</p>
<h2 id="利用有限制通配符类提升API的灵活性"><a href="#利用有限制通配符类提升API的灵活性" class="headerlink" title="利用有限制通配符类提升API的灵活性"></a>利用有限制通配符类提升API的灵活性</h2><p><code>tip-28</code></p>
<p>&lt;? extends T&gt;： 上界通配符（Upper Bounds Wildcards)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 装水果的盘子</span></div><div class="line">Plate&lt;? extends Fruit&gt;</div></pre></td></tr></table></figure>
<p>&lt;? super T&gt;：下界通配符（Lower Bounds Wildcards)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 一个能放水果以及一切是水果基类的盘子</span></div><div class="line">Plate&lt;? <span class="keyword">super</span> Fruit&gt;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// java.util.Set#addAll</span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(Collection&lt;? extends E&gt; c)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">// 移除此队列中所有可用的元素，并将它们添加到给定 collection 中</span></div><div class="line"><span class="comment">// java.util.concurrent.BlockingQueue#drainTo(java.util.Collection&lt;? super E&gt;)</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">drainTo</span><span class="params">(Collection&lt;? <span class="keyword">super</span> E&gt; c)</span></span></div></pre></td></tr></table></figure>
<p>通配符使用基本原则PECS： producer-extends、consumer-super</p>
<p>PE: 生产数据，可以泛型为下届<br>CS： 消费数据，可以子类作为父类操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1. 入参为T类型，T为上届（入参为T子类）</span></div><div class="line"><span class="comment">// 2. 返回结果Comparable为上届（结果是Comparable 的子类）</span></div><div class="line"><span class="comment">// 3. Comparable泛型参数，T为下届</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Comparable&lt;? <span class="keyword">super</span> T&gt;&gt; <span class="function">T <span class="title">max</span><span class="params">(List&lt;? extends T&gt; list)</span></span></div><div class="line"></div><div class="line"><span class="comment">// 泛型参数分析</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title">max</span><span class="params">(List&lt;T&gt; list)</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Comparable&gt; T <span class="title">max</span><span class="params">(List&lt;T&gt; list)</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Comparable&lt;? <span class="keyword">super</span> T&gt;&gt; T <span class="title">max</span><span class="params">(List&lt;T&gt; list)</span></div><div class="line"></div><div class="line"><span class="comment">// 出参为Comparable类型，入参为Comparable泛型上届</span></div><div class="line"><span class="comment">// 入参为Comparable类型子类</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Comparable&lt;? <span class="keyword">super</span> T&gt;&gt; T <span class="title">max</span><span class="params">(List&lt;? extend T&gt; list)</span></div></pre></td></tr></table></figure>
<p><code>不要用通配符类型作为返回类型</code>，除了为用户提供额外的灵活性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Sets.SetView&lt;? extends Number&gt; unionRet = Sets.&lt;Number&gt;union(integers, longs);</div></pre></td></tr></table></figure>
<p>如果编译期不能推断你希望它所拥有的类型，可以通过<code>显式的类型参数</code>。</p>
<h2 id="优先考虑类型安全的异构容器"><a href="#优先考虑类型安全的异构容器" class="headerlink" title="优先考虑类型安全的异构容器"></a>优先考虑类型安全的异构容器</h2><p><code>tip-29</code></p>
<p>当一个类的字面文字被用在方法中，来传达编译时和运行时的类型信息时，就被称作<code>type token</code>；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// java.lang.Class#cast  将一个对象强制转换成此 Class 对象所表示的类或接口</span></div><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">cast</span><span class="params">(Object obj)</span></span></div></pre></td></tr></table></figure>
<p>Class的case方法，将对象引用动态地转换成Class对象所表示的类型。</p>
<p>List<string>.class 和 List<integer>.class 并返回相同的对象引用List.class</integer></string></p>
<h1 id="枚举和注解"><a href="#枚举和注解" class="headerlink" title="枚举和注解"></a>枚举和注解</h1><h2 id="用enum代替int常量"><a href="#用enum代替int常量" class="headerlink" title="用enum代替int常量"></a>用enum代替int常量</h2><p><code>tip-30</code><br>枚举类型是指由一组固定的常量组成的合法值的类型。</p>
<p>枚举通过共有的静态final域为每一个枚举常量导出实例。</p>
<p>枚举可添加任意的方法和域，并实现任意的接口<br>枚举类实现了Comparable、Serializable接口</p>
<p>枚举静态values方法，按声明顺序返回它的值得数组。<br>toString方法返回枚举值名称。</p>
<h2 id="用实例域代替序数"><a href="#用实例域代替序数" class="headerlink" title="用实例域代替序数"></a>用实例域代替序数</h2><p><code>tip-31</code></p>
<p>永远不要根据枚举的序数导出与它相关联的值</p>
<h2 id="用EnumSet代替位域"><a href="#用EnumSet代替位域" class="headerlink" title="用EnumSet代替位域"></a>用EnumSet代替位域</h2><p><code>tip-32</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> STYLE_BOLD = <span class="number">1</span> &lt;&lt; <span class="number">0</span>;</div><div class="line"><span class="keyword">int</span> STYLE_ITALIC = <span class="number">1</span> &lt;&lt; <span class="number">1</span>;</div><div class="line"><span class="keyword">int</span> STYLE_UNDERLINE = <span class="number">1</span> &lt;&lt; <span class="number">2</span>;</div><div class="line"><span class="keyword">int</span> STYLE_STRIKETHROUGH = <span class="number">1</span> &lt;&lt; <span class="number">3</span>;</div></pre></td></tr></table></figure>
<p>EnumSet 枚举 set 中所有键都必须来自单个枚举类型</p>
<p>底层枚举有64个或更少的元素，整个EnumSet用单个long表示，性能比得上位域。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建一个包含指定元素类型的所有元素的枚举 set</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; <span class="function">EnumSet&lt;E&gt; <span class="title">allOf</span><span class="params">(Class&lt;E&gt; elementType)</span></span></div><div class="line"></div><div class="line"><span class="comment">// 补集</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; EnumSet&lt;E&gt; <span class="title">complementOf</span><span class="params">(EnumSet&lt;E&gt; s)</span></div><div class="line"></div><div class="line"><span class="comment">// 创建一个最初包含指定元素的枚举 set</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; EnumSet&lt;E&gt; <span class="title">of</span><span class="params">(E e)</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; EnumSet&lt;E&gt; <span class="title">of</span><span class="params">(E e1, E e2)</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; EnumSet&lt;E&gt; <span class="title">of</span><span class="params">(E e1, E e2, E e3)</span></div></pre></td></tr></table></figure>
<h2 id="用EnumMap代替序数索引"><a href="#用EnumMap代替序数索引" class="headerlink" title="用EnumMap代替序数索引"></a>用EnumMap代替序数索引</h2><p><code>tip-33</code></p>
<p>EnumMap在运行速度方面能与序数索引的数组相媲美，因为EnumMap内部使用了这种数组。</p>
<p>最好不要使用序数来索引数组，而要使用EnumMap</p>
<h2 id="用接口模拟可伸缩的枚举"><a href="#用接口模拟可伸缩的枚举" class="headerlink" title="用接口模拟可伸缩的枚举"></a>用接口模拟可伸缩的枚举</h2><p>通过编写接口以及实现该接口的基础枚举类型，模拟可扩展的枚举类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 既表示枚举又表示Operation的子类型</span></div><div class="line">(&lt;T extends Enum&lt;T&gt; &amp; Operation&gt; Class&lt;T&gt;)</div><div class="line"></div><div class="line"><span class="comment">// 某个扩展Exception的类的Class对象</span></div><div class="line">Class&lt;? extends Exception&gt;</div></pre></td></tr></table></figure>
<h2 id="注解优于命名模式"><a href="#注解优于命名模式" class="headerlink" title="注解优于命名模式"></a>注解优于命名模式</h2><p><code>tip-35</code></p>
<p>开发需要程序员给源文件添加信息的工具，需要定义注解类型。</p>
<p>除了“工具铁匠（toolsmiths–特定的程序员）”之外，大多数程序员都不必定义注解类型。</p>
<h2 id="坚持使用Override注解"><a href="#坚持使用Override注解" class="headerlink" title="坚持使用Override注解"></a>坚持使用Override注解</h2><p><code>tip-36</code></p>
<p>@Override 表示被注解的方法声明覆盖了超类中的一个声明。</p>
<h2 id="用标记接口定义类型"><a href="#用标记接口定义类型" class="headerlink" title="用标记接口定义类型"></a>用标记接口定义类型</h2><p><code>tip-37</code></p>
<p>标记接口两点胜过标记注解：</p>
<ul>
<li>标记接口定义的类型有被标记的类的实例实现</li>
<li>可以被更精确的锁定</li>
</ul>
<p>需要编写一个或多个接收标记的方法时，使用标记接口。</p>
<h1 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h1><h2 id="必要时进行保护性拷贝"><a href="#必要时进行保护性拷贝" class="headerlink" title="必要时进行保护性拷贝"></a>必要时进行保护性拷贝</h2><p><code>tip-39</code></p>
<p>不可变时间周期类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.sql.Date;</div><div class="line"></div><div class="line"><span class="comment">// Bloken "immutable" time period class</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Period</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Date start;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Date end;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Period</span><span class="params">(Date start, Date end)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(start.compareTo(end) &gt; <span class="number">0</span>)&#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(start + <span class="string">" "</span> + end);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.start = start;</div><div class="line">        <span class="keyword">this</span>.end = end;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getStart</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> start;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getEnd</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> end;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个类似乎是不可变的，并且强加了约束条件<br>因为<code>Date类本身是可变的</code>，所以很容易违反这个约束条件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// attack the internals of a Period instance</span></div><div class="line">Data start = <span class="keyword">new</span> Date();</div><div class="line">Date end = <span class="keyword">new</span> Date();</div><div class="line">Period p = <span class="keyword">new</span> Period(start, end);</div><div class="line"></div><div class="line"><span class="comment">// Deprecated</span></div><div class="line"><span class="comment">// end.setYear(78);</span></div><div class="line"></div><div class="line">Calendar calendar = Calendar.getInstance();</div><div class="line">calendar.setTime(end);</div><div class="line">calendar.set(Calendar.YEAR, <span class="number">1978</span>);</div><div class="line">end.setTime(calendar.getTimeInMillis());</div></pre></td></tr></table></figure>
<p>对构造器的每个可变参数进行<code>保护性拷贝</code>是必要的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Period</span><span class="params">(Date start, Date end)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.start = <span class="keyword">new</span> Date(start.getTime());</div><div class="line">    <span class="keyword">this</span>.end = <span class="keyword">new</span> Date(end.getTime());</div><div class="line">    </div><div class="line">    <span class="keyword">if</span>(start.compareTo(end) &gt; <span class="number">0</span>)&#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(start + <span class="string">" "</span> + end);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>没有使用Date的clone()进行保护性拷贝。<br>因为Date是非final的，不能保证clone()返回java.util.Date的对象</p>
<p>对于参数类型可以被<code>不可信任方</code>子类化的参数，不要使用clone()进行保护性拷贝。</p>
<p>因为访问方法提供了对其<code>可变内部成员</code>的访问能力,修改为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Date <span class="title">getStart</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Date(start.getTime());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Date <span class="title">getEnd</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Date(end.getTime());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果正在考虑由客户提供的<code>对象引用</code>作为内部Set实例的元素，或者做为内部Map的键,<br>就应该意识到，如果这个对象在插入之后再被修改，Set或Map的约束条件就会遭到破坏。</p>
<p>长度非零的数组总是可变的。<br>把内部数组返回给客户端之前，应该总是<code>进行保护性拷贝</code>。另一种解决方案是，给客户端<code>返回数组的不可变视图</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Integer[] values = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</div><div class="line">List&lt;Integer&gt; asList = Collections.unmodifiableList(Arrays.asList(values));</div></pre></td></tr></table></figure>
<p>类具有从客户端得到或返回客户端的<code>可变组件</code>，类就必须<code>保护性的拷贝</code>这些组件。<br>如果<code>拷贝的成本受到限制</code>，并且类信任它的客户端不会不恰当地修改组件，<br>就可以<code>在文档中指明</code>客户端的职责不得修改受到影响的组件，以此来代替保护性拷贝。</p>
<h2 id="复合优先于继承-1"><a href="#复合优先于继承-1" class="headerlink" title="复合优先于继承"></a>复合优先于继承</h2><h2 id="慎用可变参数"><a href="#慎用可变参数" class="headerlink" title="慎用可变参数"></a>慎用可变参数</h2><p><code>tip-42</code><br>Java 1.5 增加了可变参数 variable arity method</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">doMoreThings</span><span class="params">(Foo bar, Object ... things)</span> </span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>可变参数方法接收0个或者多个指定类型的参数。<br>可变参数机制通过创建一个数组，数组大小为调用位置所传参数的数量，然后将参数传到数组，最后将数据组传递给方法。</p>
<p>重视性能情况下，使用可变参数机制要特别小心。<br>可变参数每次调用会导致一次数据分配和初始化。<br>若多数情况下0-3个参数，可使用4个方法重载优化性能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> a1)</span></span>&#123;&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2)</span></span>&#123;&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3)</span></span>&#123;&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> ... rest)</span></span>&#123;&#125;</div></pre></td></tr></table></figure>
<h2 id="返回零长度的数组或者集合，而不是null"><a href="#返回零长度的数组或者集合，而不是null" class="headerlink" title="返回零长度的数组或者集合，而不是null"></a>返回零长度的数组或者集合，而不是null</h2><p><code>tip-43</code></p>
<p>返回类型为数组或集合的方法没有理由返回null，而是应该返回一个零长度的数组或集合。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Collections 提供了不可变的空集合</span></div><div class="line">Collections.emptyList();</div><div class="line">Collections.emptySet();</div><div class="line">Collections.emptyMap();</div></pre></td></tr></table></figure>
<p>每次都返回同一个零长度的空数组是可能的，因为零长度的数组是<code>不可变的</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Cheese[] EMPTY_CHEESE_ARRAY = <span class="keyword">new</span> Cheese[<span class="number">0</span>];</div></pre></td></tr></table></figure>
<h2 id="为所有导出的Api元素编写文档注释"><a href="#为所有导出的Api元素编写文档注释" class="headerlink" title="为所有导出的Api元素编写文档注释"></a>为所有导出的Api元素编写文档注释</h2><p><code>tip-44</code></p>
<h1 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h1><h2 id="同步访问共享的可变数据"><a href="#同步访问共享的可变数据" class="headerlink" title="同步访问共享的可变数据"></a>同步访问共享的可变数据</h2><p><code>tip-66</code></p>
<p>Java语言规范保证<code>读</code>或<code>写</code>一个变量是<code>原子的</code>(atomic)，除非这个变量的类型为long或double。</p>
<p>语言规范保证了线程在读取原子数据的时候，不会看到任意的数值，<br>但并不保证线程写入的值对于另一个线程是可见的。（可见性）</p>
<h2 id="避免过度同步"><a href="#避免过度同步" class="headerlink" title="避免过度同步"></a>避免过度同步</h2><p><code>tip-67</code></p>
<p>不要从同步区域调用外来方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 观察者模式</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(SetObserver&lt;E&gt; observer)</span></span>&#123;</div><div class="line">    <span class="comment">//遍历观察者列表，加锁</span></div><div class="line">    <span class="comment">//避免遍历期间Iterator出现ConcurrentModificationException</span></div><div class="line">    <span class="keyword">synchronized</span>(observers)&#123;</div><div class="line">        <span class="keyword">for</span>(SetObserver&lt;E&gt; observer : observers)&#123;</div><div class="line">            <span class="comment">//调用外部方法(观察者方法)</span></div><div class="line">            <span class="comment">//观察者方法可以获取当前对象，且内置锁可重入</span></div><div class="line">            <span class="comment">//观察者方法中可以修改observers，导致遍历异常</span></div><div class="line">            observer.added(<span class="keyword">this</span>, element);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过将外来方法调用移出同步的代码块解决这个问题，使用observers快照</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(SetObserver observer)</span></span>&#123;</div><div class="line">    List&lt;SetObserver&gt; snapshot = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">synchronized</span>(observers)&#123;</div><div class="line">        snapshot = <span class="keyword">new</span> ArrayList&lt;SetObserver&gt;(observers);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span>(SetObserver observer : snapshot)&#123;</div><div class="line">        observer.added(<span class="keyword">this</span>, element);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>消息通知通常比观察者列表变化更频繁，<br>故使用CopyOnWriteArrayList作为观察者列表更合适</p>
<p>在同步区域调用外来方法，其他线程对受保护资源的访问会遭到不必要的拒绝。<br>应该在同步区域做尽量少的工作。</p>
<p>过度同步实际成本并不是获取锁所花费的CPU时间，而是失去了并行的机会；<br>以及因为需要确保每个核都有一个<code>一致的内存视图</code>而导致的延迟。<br>另一个潜在开销在于，它会限制VM<code>优化代码执行</code>的能力。</p>
<p>当不确定是否需要<code>内部同步</code>时，就不要同步类，<br>而应该建立文档，注明它不是线程安全的。</p>
<p>内部同步可以使用不同的方法来实现高并发。<br>如：拆分锁(lock splitting)、分离锁(lock striping)和非阻塞(nonblocking)</p>
<p>方法修改静态域，<code>必须同步</code>对这个域的访问。<br>客户在这种方法上执行外部同步是不可能的，<br>因为不能保证不相关的客户端也会执行外部同步。</p>
<p>未同步静态域访问示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> nextSerialNumber = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">generateSerialNumber</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> nextSerialNumber++;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="executor和task优先于线程"><a href="#executor和task优先于线程" class="headerlink" title="executor和task优先于线程"></a>executor和task优先于线程</h2><p><code>tip-68</code><br>Executor Framework是一个基于接口的任务执行工具。</p>
<p>java.util.concurrent.Executors类包含静态工厂方法，能提供大多数的executor，<br>使用ThreadPoolExecutor类可以最大限度的定制线程池。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 如果池中当前有多于 corePoolSize 的线程，则这些多出的线程在空闲时间超过 keepAliveTime 时将会终止</span></div><div class="line"><span class="keyword">private</span> ExecutorService singleThreadPool = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>,</div><div class="line">            <span class="number">0L</span>, TimeUnit.MILLISECONDS,</div><div class="line">            <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(<span class="number">1024</span>), <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">            .setNameFormat(<span class="string">"trace-compare-pool-%d"</span>).build(), <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy());</div></pre></td></tr></table></figure>
<p>任务(task)有两种:</p>
<ul>
<li>Runnable</li>
<li>Callable (有返回值)</li>
</ul>
<p>轻载的服务器，可以使用Executors.newCachedThreaPool()<br>大负载的服务器，最好使用Executors.newFixedThreadPool();<br>被调度的线程池 Executors.newScheduledThreadPool()可以替代java.util.Timer</p>
<p>timer唯一的线程抛出未被捕获异常，会停止。</p>
<p>被调度的线程池支持多线程，且优雅的从抛出非受检异常的任务中恢复。</p>
<p>java.util.Timer 任务抛出异常后，线程终止示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">Timer timer = <span class="keyword">new</span> Timer();</div><div class="line"><span class="comment">//初始延迟</span></div><div class="line"><span class="keyword">int</span> initialDelay = <span class="number">1000</span>;</div><div class="line"><span class="comment">//执行周期</span></div><div class="line"><span class="keyword">int</span> period = <span class="number">2000</span>;</div><div class="line"></div><div class="line"><span class="comment">//固定延迟</span></div><div class="line">timer.schedule(<span class="keyword">new</span> TimerTask()&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(System.nanoTime());</div><div class="line">        <span class="comment">//throw new RuntimeException("foo");</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;, initialDelay, period);</div><div class="line"></div><div class="line"><span class="comment">//固定速率</span></div><div class="line">timer.scheduleAtFixedRate(<span class="keyword">new</span> TimerTask()&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(System.nanoTime());</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"foo"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;, initialDelay,period);</div></pre></td></tr></table></figure>
<blockquote>
<p>对 Timer 对象最后的引用消失后，并且 所有未处理的任务都已执行完成，计时器的任务执行线程会正常终止（并且成为垃圾回收的对象）。但是这可能要很长时间后才发生。<br>（Timer任务执行完成之后，执行垃圾回收时才会终止。实验运行阶段造成程序不终止假象 ）</p>
</blockquote>
<p>ScheduledThreadPool 任务抛出异常时，执行当前任务的线程停止，<code>当前任务也会终止</code>；<br>任务执行器不会停止，会有新的线程被创建并执行其他任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//初始延迟</span></div><div class="line"><span class="keyword">int</span> initialDelay = <span class="number">1000</span>;</div><div class="line"><span class="comment">//执行周期</span></div><div class="line"><span class="keyword">int</span> period = <span class="number">2000</span>;</div><div class="line"></div><div class="line"><span class="keyword">int</span> corePoolSize = <span class="number">1</span>;</div><div class="line">ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(corePoolSize);</div><div class="line"><span class="comment">//固定速率，任务1</span></div><div class="line">ScheduledFuture&lt;?&gt; scheduledFuture = scheduler.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"foo:"</span> + Thread.currentThread().getName());</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"foo"</span>);</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">&#125;, initialDelay, period, TimeUnit.MILLISECONDS);</div><div class="line"></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">//获取任务执行结果，任务抛出异常时能够捕获异常</span></div><div class="line">    scheduledFuture.get();</div><div class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//固定延迟的任务，任务2</span></div><div class="line">scheduler.scheduleWithFixedDelay(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"bar:"</span> + Thread.currentThread().getName());</div><div class="line">    &#125;</div><div class="line">&#125;, initialDelay, period, TimeUnit.MILLISECONDS);</div></pre></td></tr></table></figure>
<h2 id="并发工具优先于wait和notify"><a href="#并发工具优先于wait和notify" class="headerlink" title="并发工具优先于wait和notify"></a>并发工具优先于wait和notify</h2><p><code>tip-69</code><br>几乎没有理由再使用wait和notify了，<br>java 1.5提供了更高级的并发工具，<br>他们可以完成以前必须在wait和notify上手写代码才能完成的工作。</p>
<p>java.util.concurrent中更高级的工具分成三类：</p>
<ul>
<li>任务执行工具(Executor Framework)</li>
<li>并发集合(Concurrent Collection)</li>
<li>同步器(Synchronizer)</li>
</ul>
<p>wait方法的标准模式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">synchronized</span>(obj)&#123;</div><div class="line">    <span class="keyword">while</span>(conditionDoesNotHold)&#123;</div><div class="line">        obj.wait();<span class="comment">//Releases lock, and reacquires on wakeup</span></div><div class="line">        <span class="comment">//Perform action appropriate to condition</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>循环会在等待之前和之后测试条件。</p>
<p>一般情况下，应该优先使用notifyAll，而不是notify<br>使用notifyAll代替notify可以避免来自不相关线程的意外或恶意的等待。<br>否则，这样的等待会“吞掉”一个关键的通知，使真正的接收线程无限地等待下去。</p>
<h2 id="线程安全性的文档化"><a href="#线程安全性的文档化" class="headerlink" title="线程安全性的文档化"></a>线程安全性的文档化</h2><p><code>tip-70</code><br>一个类为了可被多线程安全地使用，必须在文档中清楚地说明它所支持的线程安全级别。</p>
<p>线程安全级别：</p>
<ul>
<li>不可变的</li>
<li>无条件的线程安全</li>
<li>有条件的线程安全</li>
<li>非线程安全</li>
<li>线程对立的</li>
</ul>
<blockquote>
<p>线程对立的类不能安全的被多线程并发使用，即时方法调用使用外部同步。<br>线程对立的根源通常在于，没有同步地修改静态数据。<br>如：System.runFinalizersOnExit方法是线程对立的。</p>
</blockquote>
<p>线程安全说明通常放在文档注释中。</p>
<p>静态工厂必须在文档中说明被返回对象的线程安全性。</p>
<p>私有锁对象模式（防止客户端或子类干扰同步）：</p>
<ul>
<li>只能用在无条件的线程安全类上</li>
<li>特别适用于专门为继承设计的类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">synchronized</span>(lock)&#123;</div><div class="line">        <span class="comment">//doSomething</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有条件的线程安全类必须在文档中指明“哪个方法调用序列需外部同步”，<br>以及在执行这些序列时要获取哪个锁。</p>
<h2 id="慎用延迟初始化"><a href="#慎用延迟初始化" class="headerlink" title="慎用延迟初始化"></a>慎用延迟初始化</h2><p><code>tip-71</code><br>延迟初始化是延迟到<code>需要域的值时</code>才将它初始化。</p>
<p>延迟初始化降低了初始化类或创建实例的开销，<br>却增加了访问延迟初始化的域的开销。</p>
<blockquote>
<p>延迟初始化建议:除非绝对必要，否则就不要这么做。</p>
</blockquote>
<p>静态初始化器:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ThreadSafe</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EagerInitialization</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Resource resource = <span class="keyword">new</span> Resource();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Resource <span class="title">getResource</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> resource;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Resource</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote><p>静态初始化器由JVM在<code>类的初始化</code>阶段执行，即在类被加载后并且<code>被线程使用</code>之前。<br>由于JVM将在初始化期间获得一个锁，并且每个线程都至少获取一次这个锁以确保这个类已经被加载，<br>因此在静态初始化期间，内存写入操作将自动对所有线程可见。</p>
<footer><strong>《Java Concurrency In Practice》</strong></footer></blockquote>
<p>静态域初始化使用<code>延迟初始化占位类</code>模式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Resource</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Resource</span><span class="params">()</span></span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Resource <span class="title">getResource</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> ResourceHolder.resource;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceHolder</span></span>&#123;</div><div class="line">        <span class="keyword">static</span> Resource  resource = <span class="keyword">new</span> Resource();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实例域初始化使用<code>双重检查</code>模式：<br><code>不要这么做</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 注意 volitile 必须</span></div><div class="line"><span class="keyword">private</span> volitile FieldType field4;</div><div class="line"><span class="function">FieldType <span class="title">getField4</span><span class="params">()</span></span>&#123;</div><div class="line">    FieldType result = field4;</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">null</span> == result)&#123;</div><div class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</div><div class="line">            result  = field4;</div><div class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> == result)&#123;</div><div class="line">                field4 = result = computeFieldValue();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>局部变量result确保field在已经被初始化的情况下只读取一次，<br>可以提升性能；</p>
</blockquote>
<p>可以接受重复初始化的实例域，可以考虑<code>单重检查模式</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> hash;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> h = hash;</div><div class="line">    <span class="keyword">int</span> len = count;</div><div class="line">    <span class="keyword">if</span> (h == <span class="number">0</span> &amp;&amp; len &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">int</span> off = offset;</div><div class="line">        <span class="keyword">char</span> val[] = value;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</div><div class="line">            h = <span class="number">31</span>*h + val[off++];</div><div class="line">        &#125;</div><div class="line">        hash = h;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> h;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>String 使用单重检查模式缓存散列码</p>
</blockquote>
<h2 id="不要依赖于线程调度器"><a href="#不要依赖于线程调度器" class="headerlink" title="不要依赖于线程调度器"></a>不要依赖于线程调度器</h2><p><code>tip-72</code><br>任何依赖线程调度器来达到正确性或者性能要求的程序，很可能都是<code>不可移植</code>的。</p>
<p>Thread.yield没有可测试的语义，<br>应该使用Thread.sleep(1)替代Thread.yield进行并发测试。</p>
<p>线程优先级是Java平台上最不可移植的特性之一。</p>
<p>线程优先级可以用来提高一个已经<code>能够正常工作</code>的程序的服务质量，<br>但永远不应该用来“修正”一个原本并不能工作的程序。</p>
<h1 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h1><h2 id="保护性地编写readObject方法"><a href="#保护性地编写readObject方法" class="headerlink" title="保护性地编写readObject方法"></a>保护性地编写readObject方法</h2><p><code>tip-76</code><br>readObject是一个“用字节流作为唯一参数”的构造器。</p>
<p>对于每个可序列化的不可变类，<br>如果它包含了<code>私有的可变组件</code>，那么在它的readObject方法中，必须对这些组件进行保护性拷贝。</p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Java/" rel="tag"># Java</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/04/12/design-patterns/" rel="next" title="Design Patterns">
                <i class="fa fa-chevron-left"></i> Design Patterns
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/04/20/java-concurrency-in-practice/" rel="prev" title="Java Concurrency In Practice">
                Java Concurrency In Practice <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="xiaozhuang" />
          <p class="site-author-name" itemprop="name">xiaozhuang</p>
          <p class="site-description motion-element" itemprop="description">O ever youthful</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">27</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">54</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#创建和销毁对象"><span class="nav-number">1.</span> <span class="nav-text">创建和销毁对象</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#考虑用静态工厂方法代替构造器"><span class="nav-number">1.1.</span> <span class="nav-text">考虑用静态工厂方法代替构造器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#遇到多个构造器参数时考虑用构造器"><span class="nav-number">1.2.</span> <span class="nav-text">遇到多个构造器参数时考虑用构造器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用私有构造器或者枚举类型强化Singleton属性"><span class="nav-number">1.3.</span> <span class="nav-text">用私有构造器或者枚举类型强化Singleton属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#避免创建不必要的对象"><span class="nav-number">1.4.</span> <span class="nav-text">避免创建不必要的对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消除过期的对象引用"><span class="nav-number">1.5.</span> <span class="nav-text">消除过期的对象引用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#避免使用终结方法"><span class="nav-number">1.6.</span> <span class="nav-text">避免使用终结方法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#对所有对象都通用的方法"><span class="nav-number">2.</span> <span class="nav-text">对所有对象都通用的方法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#覆盖equals时请遵守通用约定"><span class="nav-number">2.1.</span> <span class="nav-text">覆盖equals时请遵守通用约定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#覆盖equals方法时总要覆盖hashCode"><span class="nav-number">2.2.</span> <span class="nav-text">覆盖equals方法时总要覆盖hashCode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#始终要覆盖toString"><span class="nav-number">2.3.</span> <span class="nav-text">始终要覆盖toString</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#类和接口"><span class="nav-number">3.</span> <span class="nav-text">类和接口</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#使类和成员的可访问性最小"><span class="nav-number">3.1.</span> <span class="nav-text">使类和成员的可访问性最小</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使可变性最小化"><span class="nav-number">3.2.</span> <span class="nav-text">使可变性最小化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#复合优先于继承"><span class="nav-number">3.3.</span> <span class="nav-text">复合优先于继承</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#要么为继承而设计，并提提供文档说明，要么就禁止继承"><span class="nav-number">3.4.</span> <span class="nav-text">要么为继承而设计，并提提供文档说明，要么就禁止继承</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#接口优于抽象类"><span class="nav-number">3.5.</span> <span class="nav-text">接口优于抽象类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#接口只用于定义类型"><span class="nav-number">3.6.</span> <span class="nav-text">接口只用于定义类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用函数对象表示策略"><span class="nav-number">3.7.</span> <span class="nav-text">用函数对象表示策略</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优先考虑静态成员类"><span class="nav-number">3.8.</span> <span class="nav-text">优先考虑静态成员类</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#泛型（generic）"><span class="nav-number">4.</span> <span class="nav-text">泛型（generic）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#请不要在新代码中使用原生态类型"><span class="nav-number">4.1.</span> <span class="nav-text">请不要在新代码中使用原生态类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消除非受检警告"><span class="nav-number">4.2.</span> <span class="nav-text">消除非受检警告</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#列表优于数组"><span class="nav-number">4.3.</span> <span class="nav-text">列表优于数组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优先考虑泛型"><span class="nav-number">4.4.</span> <span class="nav-text">优先考虑泛型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优先考虑泛型方法"><span class="nav-number">4.5.</span> <span class="nav-text">优先考虑泛型方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#利用有限制通配符类提升API的灵活性"><span class="nav-number">4.6.</span> <span class="nav-text">利用有限制通配符类提升API的灵活性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优先考虑类型安全的异构容器"><span class="nav-number">4.7.</span> <span class="nav-text">优先考虑类型安全的异构容器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#枚举和注解"><span class="nav-number">5.</span> <span class="nav-text">枚举和注解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#用enum代替int常量"><span class="nav-number">5.1.</span> <span class="nav-text">用enum代替int常量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用实例域代替序数"><span class="nav-number">5.2.</span> <span class="nav-text">用实例域代替序数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用EnumSet代替位域"><span class="nav-number">5.3.</span> <span class="nav-text">用EnumSet代替位域</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用EnumMap代替序数索引"><span class="nav-number">5.4.</span> <span class="nav-text">用EnumMap代替序数索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用接口模拟可伸缩的枚举"><span class="nav-number">5.5.</span> <span class="nav-text">用接口模拟可伸缩的枚举</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注解优于命名模式"><span class="nav-number">5.6.</span> <span class="nav-text">注解优于命名模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#坚持使用Override注解"><span class="nav-number">5.7.</span> <span class="nav-text">坚持使用Override注解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用标记接口定义类型"><span class="nav-number">5.8.</span> <span class="nav-text">用标记接口定义类型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#方法"><span class="nav-number">6.</span> <span class="nav-text">方法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#必要时进行保护性拷贝"><span class="nav-number">6.1.</span> <span class="nav-text">必要时进行保护性拷贝</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#复合优先于继承-1"><span class="nav-number">6.2.</span> <span class="nav-text">复合优先于继承</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#慎用可变参数"><span class="nav-number">6.3.</span> <span class="nav-text">慎用可变参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#返回零长度的数组或者集合，而不是null"><span class="nav-number">6.4.</span> <span class="nav-text">返回零长度的数组或者集合，而不是null</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为所有导出的Api元素编写文档注释"><span class="nav-number">6.5.</span> <span class="nav-text">为所有导出的Api元素编写文档注释</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#并发"><span class="nav-number">7.</span> <span class="nav-text">并发</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#同步访问共享的可变数据"><span class="nav-number">7.1.</span> <span class="nav-text">同步访问共享的可变数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#避免过度同步"><span class="nav-number">7.2.</span> <span class="nav-text">避免过度同步</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#executor和task优先于线程"><span class="nav-number">7.3.</span> <span class="nav-text">executor和task优先于线程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#并发工具优先于wait和notify"><span class="nav-number">7.4.</span> <span class="nav-text">并发工具优先于wait和notify</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#线程安全性的文档化"><span class="nav-number">7.5.</span> <span class="nav-text">线程安全性的文档化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#慎用延迟初始化"><span class="nav-number">7.6.</span> <span class="nav-text">慎用延迟初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#不要依赖于线程调度器"><span class="nav-number">7.7.</span> <span class="nav-text">不要依赖于线程调度器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#序列化"><span class="nav-number">8.</span> <span class="nav-text">序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#保护性地编写readObject方法"><span class="nav-number">8.1.</span> <span class="nav-text">保护性地编写readObject方法</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xiaozhuang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




  
  
  
  <script type="text/javascript">
    $(document).ready(function () {
      if ( $('#local-search-input').size() === 0) {
        return;
      }

      // Popup Window;
      var isfetched = false;
      // Search DB path;
      var search_path = "search.xml";
      if (search_path.length == 0) {
        search_path = "search.xml";
      }
      var path = "/" + search_path;
      // monitor main search box;

      function proceedsearch() {
        $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
        $('.popup').toggle();

      }
      // search function;
      var searchFunc = function(path, search_id, content_id) {
        'use strict';
        $.ajax({
          url: path,
          dataType: "xml",
          async: true,
          success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
              return {
                title: $( "title", this ).text(),
                content: $("content",this).text(),
                url: $( "url" , this).text()
              };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
              var matchcounts = 0;
              var str='<ul class=\"search-result-list\">';
              var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
              $resultContent.innerHTML = "";
              if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                  var isMatch = true;
                  var content_index = [];
                  var data_title = data.title.trim().toLowerCase();
                  var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                  var data_url = data.url;
                  var index_title = -1;
                  var index_content = -1;
                  var first_occur = -1;
                  // only match artiles with not empty titles and contents
                  if(data_title != '' && data_content != '') {
                    keywords.forEach(function(keyword, i) {
                      index_title = data_title.indexOf(keyword);
                      index_content = data_content.indexOf(keyword);
                      if( index_title < 0 && index_content < 0 ){
                        isMatch = false;
                      } else {
                        if (index_content < 0) {
                          index_content = 0;
                        }
                        if (i == 0) {
                          first_occur = index_content;
                        }
                      }
                    });
                  }
                  // show search results
                  if (isMatch) {
                    matchcounts += 1;
                    str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                    var content = data.content.trim().replace(/<[^>]+>/g,"");
                    if (first_occur >= 0) {
                      // cut out 100 characters
                      var start = first_occur - 20;
                      var end = first_occur + 80;
                      if(start < 0){
                        start = 0;
                      }
                      if(start == 0){
                        end = 50;
                      }
                      if(end > content.length){
                        end = content.length;
                      }
                      var match_content = content.substring(start, end);
                      // highlight all keywords
                      keywords.forEach(function(keyword){
                        var regS = new RegExp(keyword, "gi");
                        match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                      });

                      str += "<p class=\"search-result\">" + match_content +"...</p>"
                    }
                    str += "</li>";
                  }
                })};
              str += "</ul>";
              if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
              if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
              $resultContent.innerHTML = str;
            });
            proceedsearch();
          }
        });}

      // handle and trigger popup window;
      $('.popup-trigger').mousedown(function(e) {
        e.stopPropagation();
        if (isfetched == false) {
          searchFunc(path, 'local-search-input', 'local-search-result');
        } else {
          proceedsearch();
        };

      });

      $('.popup-btn-close').click(function(e){
        $('.popup').hide();
        $(".popoverlay").remove();
        $('body').css('overflow', '');
      });
      $('.popup').click(function(e){
        e.stopPropagation();
      });
    });
  </script>


  

  

  
  


</body>
</html>
