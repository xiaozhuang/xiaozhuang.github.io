<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[Webdriver]]></title>
      <url>http://xiaozhuang.github.io/2018/05/29/webdriver/</url>
      <content type="html"><![CDATA[<p>Webdriver<br><a id="more"></a></p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">System.setProperty(<span class="string">"webdriver.chrome.driver"</span>,<span class="string">"C:\\autoSVN\\driver\\chromedriver.exe"</span>);</div><div class="line">        </div><div class="line"><span class="comment">// 创建了一个 Firefox driver 的实例</span></div><div class="line"><span class="comment">// 注意，其余的代码依赖于接口而非实例</span></div><div class="line">WebDriver driver = <span class="keyword">new</span> ChromeDriver();</div><div class="line"></div><div class="line"><span class="comment">// 使用它访问 Google</span></div><div class="line">driver.get(<span class="string">"http://www.google.com"</span>);</div><div class="line"><span class="comment">// 同样的事情也可以通过以下代码完成</span></div><div class="line"><span class="comment">// driver.navigate().to("http://www.google.com");</span></div><div class="line"></div><div class="line"><span class="comment">// 找到搜索输入框</span></div><div class="line">WebElement element = driver.findElement(By.name(<span class="string">"q"</span>));</div><div class="line"></div><div class="line"><span class="comment">// 输入要查找的词</span></div><div class="line">element.sendKeys(<span class="string">"Cheese!"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 提交表单</span></div><div class="line">element.submit();</div><div class="line"></div><div class="line"><span class="comment">// 检查页面标题</span></div><div class="line">System.out.println(<span class="string">"Page title is: "</span> + driver.getTitle());</div><div class="line"></div><div class="line"><span class="comment">// Google 搜索结果由 JavaScript 动态渲染</span></div><div class="line"><span class="comment">// 等待页面加载完毕，超时时间设为10秒</span></div><div class="line">(<span class="keyword">new</span> WebDriverWait(driver, <span class="number">10</span>)).until(<span class="keyword">new</span> ExpectedCondition&lt;Boolean&gt;() &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">apply</span><span class="params">(WebDriver d)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> d.getTitle().toLowerCase().startsWith(<span class="string">"cheese!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//应该能看到: "cheese! - Google Search"</span></div><div class="line">System.out.println(<span class="string">"Page title is: "</span> + driver.getTitle());</div><div class="line"></div><div class="line"><span class="comment">//关闭浏览器</span></div><div class="line"><span class="comment">//driver.quit();</span></div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Webdriver </tag>
            
            <tag> Selenium </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java 开发规范]]></title>
      <url>http://xiaozhuang.github.io/2017/09/03/java-dev-guid/</url>
      <content type="html"><![CDATA[<p>《阿里巴巴Java开发手册》阅读笔记<br><a id="more"></a></p>
<h1 id="编程规约"><a href="#编程规约" class="headerlink" title="编程规约"></a>编程规约</h1><h2 id="命名规范"><a href="#命名规范" class="headerlink" title="命名规范"></a>命名规范</h2><ul>
<li>抽象类命名使用Abstract或Base开头；异常类命名使用Exception结尾；测试类以被测试类名开始，以Test结尾</li>
<li>中括号是数组类型的一部分，数组定义如下：String[] args</li>
<li>POJO类中布尔类型的变量，都不要加is</li>
<li>包名统一使用<code>小写</code>，点分隔符之间有且仅有一个自然语义的英语单词，包名统一使用<code>单数</code>形式，类名可以使用复数形式</li>
<li>枚举类名建议带上Enum后缀，枚举成员名称全大写</li>
</ul>
<p>Service/DAO层方法命名规约<br>1)获取单个对象get前缀<br>2)获取多个对象list前缀<br>3)统计值方法用count前缀<br>4)插入用<code>save</code>或insert前缀<br>5)删除用<code>remove</code>或delete前缀<br>6)修改的方法用update做前缀</p>
<p>领域模型命名规约<br>1)数据对象，xxxDO<br>2)数据传输对象，xxxDTO<br>3)展示对象：xxxVO<br>4)POJO是DO/DTO/BO/VO的统称</p>
<h2 id="常量定义"><a href="#常量定义" class="headerlink" title="常量定义"></a>常量定义</h2><ul>
<li>不允许任何魔法值</li>
<li>long或者Long初始赋值时，必须使用大写的L</li>
<li>不要使用一个常量类维护所有常量，按常量功能进行分类。缓存<code>CacheConsts</code>、系统配置<code>ConfigConsts</code></li>
<li>常量声明放在constant目录下</li>
</ul>
<h2 id="代码格式"><a href="#代码格式" class="headerlink" title="代码格式"></a>代码格式</h2><ul>
<li>任何二目、三目运算符的左右两边都必须加一个空格</li>
<li>缩进采用4个空格，禁止使用tab字符</li>
<li>单行字符数限制不超过120个</li>
<li>文件编码格式UT-8；IDE中文件的换行符使用Unix格式，不要使用windows格式</li>
</ul>
<h2 id="OOP规约"><a href="#OOP规约" class="headerlink" title="OOP规约"></a>OOP规约</h2><ul>
<li>避免使用对象访问静态变量或静态方法</li>
<li>所有的覆盖方法，必须加@Override注解</li>
<li>不能使用过时的类或方法</li>
<li>Object的equals方法容易抛空指针异常，推荐使用java.util.Objects.equals(Object, Object)（JDK7引入的工具类）</li>
<li>所有的相同类型的包装类对象之间的值的比较，全部使用<code>equals方法</code></li>
</ul>
<ul>
<li>所有的<code>POJO类属性</code>必须使用<code>包装数据类型</code></li>
<li>RPC方法的<code>返回值</code>和<code>参数</code>必须使用<code>包装数据类型</code></li>
<li>所有局部变量使用基本数据类型</li>
<li><p>定义DO/DTO/VO等POJO类时，不要设定任何属性默认值</p>
</li>
<li><p>构造方法里面禁止加入任何业务逻辑，初始化逻辑，放在init方法中</p>
</li>
<li><p>POJO类必须写toString方法</p>
</li>
<li><p>循环体内，字符串的连接方式，使用StringBuilder的append方法</p>
</li>
<li><p>集合转数组使用集合的toArray(T[] array)</p>
</li>
<li>数组转集合使用Arrays.asList()</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">List&lt;String&gt; arrlist = Arrays.asList(<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>);</div><div class="line"></div><div class="line">Integer arr[] = arrlist.toArray(<span class="keyword">new</span> Integer[arrlist.size()]);</div><div class="line"></div><div class="line"></div><div class="line">String[] myStringArray = &#123;<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>&#125;;</div><div class="line">Arrays.asList(myStringArray);</div></pre></td></tr></table></figure>
<ul>
<li><p>不要在foreach循环里进行元素的remove/add操作。remove元素使用Iterator方式</p>
</li>
<li><p>集合初始化时，指定集合初始化大小</p>
</li>
<li>使用entrySet遍历Map类集合KV，而不是keySet方式；JDK8使用Map.foreach方法</li>
</ul>
<h2 id="并发处理"><a href="#并发处理" class="headerlink" title="并发处理"></a>并发处理</h2><ul>
<li>线程资源必须通过线程池提供</li>
<li><p>线程不允许使用Executors去创建，而是通过ThreadPoolExecutor的方式</p>
</li>
<li><p>SimpleDateFormat 是线程不安全的类，定义static必须加锁，或使用DateUtils工具类</p>
</li>
</ul>
<p>JDK8使用Instant代替Date，LocalDateTime代替Calendar，<br>DateTimeFormatter代替Simpledateformatter，官方解释：simple beautiful strong immutable thread-safe</p>
<ul>
<li>并发修改同一记录时，避免更新丢失，需要加锁。缓存加锁或数据库乐观锁。</li>
</ul>
<p>访问冲突概率小于20%，推荐使用乐观锁，否则使用悲观锁。乐观锁重试次数不小于3次。</p>
<ul>
<li>避免Random实例被多线程使用，虽然共享实例线程安全，但因竞争同一seed导致性能下降。(JDK7之后，使用API ThreadLocalRandom)</li>
<li>volatile解决多线程内存不可见问题。对于一写多读，可解决变量同步问题。</li>
</ul>
<p>JDK8推荐LongAdder对象，比AtomicLong性能更好(较少乐观锁重试次数)</p>
<h2 id="控制语句"><a href="#控制语句" class="headerlink" title="控制语句"></a>控制语句</h2><ul>
<li><p>复杂逻辑判断的结果赋值给一个有意义的布尔变量，以提高可读性。</p>
</li>
<li><p>需要参数校验场景：执行开销大的方法；对外开放接口；敏感权限接口。</p>
</li>
<li>不需要参数校验场景：底层调用频度较高的方法；private方法；</li>
</ul>
<h2 id="注释规约"><a href="#注释规约" class="headerlink" title="注释规约"></a>注释规约</h2><ul>
<li>类、类属性、类方法注释必须使用Javadoc规范</li>
<li>所有抽象方法必须用Javadoc注释，除返回值、参数、异常说明外，还必须指出方法功能</li>
<li>所有类都必须添加创建者和创建日期</li>
<li>方法内部单行注释，在被注释语句上方<code>另起一行</code></li>
<li>枚举类型字段必须注释</li>
<li>特殊注释标记：待办事宜（TODO）:（ 标记人，标记时间，[预计处理时间]）；错误，不能工作（FIXME）:（标记人，标记时间，[预计处理时间]）</li>
</ul>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul>
<li>使用正则表达式时，利用预编译功能。不要在方法体内定义：Pattern pattern = Pattern.compile(规则);</li>
<li>注意 Math.random() 这个方法返回是double类型，注意取值的范围 0≤x&lt;1（能够取到零值）</li>
<li>获取当前毫秒数System.currentTimeMillis(); 而不是new Date().getTime();在JDK8中，推荐使用Instant类</li>
<li>对于“明确停止使用的代码和配置”，坚决从程序中清理出去，避免造成过多垃圾。</li>
</ul>
<h2 id="异常日志"><a href="#异常日志" class="headerlink" title="异常日志"></a>异常日志</h2><ul>
<li>最外层的业务使用者，必须处理异常</li>
<li>不能在finally块中使用return，finally块中的return返回后方法结束执行，不会再执行try块中的return语句。</li>
<li>防止NPE：远程调用返回对象时，一律要求进行空指针判断；使用JDK8的<code>Optional</code>类来防止NPE问题</li>
<li>在代码中使用“抛异常”还是“返回错误码”：公司外的http/api开放接口必须使用“错误码”；而应用内部推荐异常抛出；跨应用间RPC调用优先考虑使用Result方式，封装isSuccess()方法、“错误码”、“错误简短信息”。</li>
</ul>
<h2 id="日志规约"><a href="#日志规约" class="headerlink" title="日志规约"></a>日志规约</h2><ul>
<li>不可直接使用日志系统中的API，应该依赖日志框架SLF4J中的API</li>
<li>日志文件推荐至少保存15天</li>
<li><p>对trace/debug/info级别的日志输出，必须使用条件输出格式或占位符的方式</p>
</li>
<li><p>异常信息应该包括两类信息：案发现场信息和异常堆栈信息。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">logger.error(各类参数或者对象toString + <span class="string">"_"</span> + e.getMessage(), e);</div></pre></td></tr></table></figure>
<ul>
<li>可以使用warn日志级别来记录用户输入参数错误的情况</li>
<li>error级别只记录系统逻辑出错、异常等重要的错误信息</li>
</ul>
<h2 id="MySQL数据库"><a href="#MySQL数据库" class="headerlink" title="MySQL数据库"></a>MySQL数据库</h2><h3 id="建表规约"><a href="#建表规约" class="headerlink" title="建表规约"></a>建表规约</h3><ul>
<li>表达是否的字段，必须使用is_xxx的方式命名，类型<code>unsigned tinyint</code>（1表示是，0表示否）；任何字段如果为非负数，必须是unsigned。</li>
<li>表名、字段名必须使用<code>小写字母</code>和数字，禁止数字开头、禁止两个下划线中间只出现数字</li>
<li><code>表名不用复数名词</code></li>
<li>主键索引<code>pk_字段名</code>、唯一索引<code>uk_字段名</code>、普通索引<code>idx_字段名</code></li>
<li>小数类型为decimal，<code>禁止使用</code>float和double</li>
<li>存储的字段长度几乎相等，使用char定长字符串类型</li>
<li>varchar长度不要超过5000</li>
<li>单表数据超过500W或单表容量超过2GB，才推荐分库分表</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>表示范围</th>
</tr>
</thead>
<tbody>
<tr>
<td>unsigned tinyint</td>
<td>无符号值：0到255</td>
</tr>
<tr>
<td>unsigned smallint</td>
<td>无符号值：0到65535</td>
</tr>
<tr>
<td>unsigned int</td>
<td>无符号值：0到约42.9亿</td>
</tr>
<tr>
<td>unsigned bigint</td>
<td>无符号值：0到约10的19次方</td>
</tr>
</tbody>
</table>
<p>TINYINT[(M)] [UNSIGNED] [ZEROFILL]<br>A very small integer. The signed range is <code>-128 to 127</code>. The unsigned range is <code>0 to 255</code>.<br>M indicates the maximum <code>display width</code> for integer types.</p>
<p>无符号，TINYINT 高位按M补0</p>
<h3 id="索引规约"><a href="#索引规约" class="headerlink" title="索引规约"></a>索引规约</h3><ul>
<li>业务上具有唯一特性的字段，即使是多个字段的组合，也必须建成唯一索引。提高查找速度。</li>
<li>超过3个表，禁止join；即使双表join也要注意表索引、SQL性能</li>
<li><p>varchar字段建立索引，必须制定索引长度</p>
</li>
<li><p>SQL性能优化的目标：至少要达到 range 级别，要求是ref级别，如果可以是consts最好。</p>
</li>
</ul>
<p>1）consts 单表中最多只有一个匹配行（主键或者唯一索引），在优化阶段即可读取到数据。<br>2）ref 指的是使用普通的索引（normal index）。<br>3）range 对索引进行范围检索。</p>
<ul>
<li>防止因字段类型不同造成的隐式转换，导致索引失效</li>
</ul>
<h3 id="SQL语句"><a href="#SQL语句" class="headerlink" title="SQL语句"></a>SQL语句</h3><ul>
<li>不要使用count(列明)或count(常量)来代替count(*)</li>
<li>当某一列的值全是NULL时，count(col)的返回结果为0，但sum(col)的返回结果为NULL，因此使用sum()时需注意NPE问题</li>
<li>in操作尽量避免，in后边的集合元素数量，控制在1000个之内</li>
</ul>
<h2 id="ORM映射"><a href="#ORM映射" class="headerlink" title="ORM映射"></a>ORM映射</h2><ul>
<li>不要用resultClass当返回参数，即使所有类属性名与数据库字段一一对应，也需要定义</li>
</ul>
<h2 id="工程结构"><a href="#工程结构" class="headerlink" title="工程结构"></a>工程结构</h2><h3 id="应用分层"><a href="#应用分层" class="headerlink" title="应用分层"></a>应用分层</h3><ul>
<li>开放接口层：RPC接口、HTTP接口、进行网关安全控制、流量控制</li>
<li>终端显示层:各个端的模板渲染并执行显示的层</li>
<li>Web层：对访问控制进行转发，各类基本参数校验，或不复用的业务简单处理</li>
<li><p>Service层：具体业务逻辑服务层</p>
</li>
<li><p>Manager层：通用业务处理层，第三方平台封装层、Service层通用能力下沉（缓存、中间件通用处理）、DAO层交互</p>
</li>
<li>DAO层：数据访问层</li>
</ul>
<p>在DAO层，不需要打印日志，因为日志在Manager/Service层一定需要捕获并打到日志文件中去</p>
<h3 id="分层领域模型"><a href="#分层领域模型" class="headerlink" title="分层领域模型"></a>分层领域模型</h3><ul>
<li>DO（Data Object）：与数据库表结构一一对应</li>
<li>DTO（Data Transfer Object）：数据传输对象，Service和Manager向外传输的对象</li>
<li>BO（Business Object）：业务对象。可以由Service层输出的封装业务逻辑的对象。</li>
<li>Query：数据查询对象，各层接收上层的查询请求。注：超过2个参数的查询封装，禁止使用Map类来传输。</li>
<li>VO（View Object）：显示层对象，通常是Web向模板渲染引擎层传输的对象。</li>
</ul>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> CSS </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Spring]]></title>
      <url>http://xiaozhuang.github.io/2017/05/23/spring/</url>
      <content type="html"><![CDATA[<p>Spring IoC、AOP、SpringMVC<br><a id="more"></a></p>
<h1 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h1><h2 id="Resource"><a href="#Resource" class="headerlink" title="@Resource"></a>@Resource</h2><p>按名称进行装配，名称可以通过name属性指定，<br>没有指定name属性，当注解写在字段上时，默认取字段名</p>
<p>@Resource默认是按照名称来装配注入的，当找不到与名称匹配的bean，按照类型来装配注入</p>
<h2 id="Profile"><a href="#Profile" class="headerlink" title="Profile"></a>Profile</h2><p>Spring 3.1引入，可理解为Spring容器中Bean的逻辑组<br>只有当这些Profile被激活的时候，才会将Profile中所对应的Bean注册到Spring容器中</p>
<h2 id="Autowried"><a href="#Autowried" class="headerlink" title="Autowried"></a>Autowried</h2><p>默认是按照类型进行装配注入<br>默认要求依赖对象必须存在，可以设置required</p>
<h2 id="Qualifier"><a href="#Qualifier" class="headerlink" title="Qualifier"></a>Qualifier</h2><p>Autowried按名称装配</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Autowried</span></div><div class="line"><span class="meta">@Qualifier</span>(<span class="string">"adminDAO"</span>)</div><div class="line"><span class="keyword">private</span> AdminDAO adminDAO;</div></pre></td></tr></table></figure>
<h2 id="ModelAttribute"><a href="#ModelAttribute" class="headerlink" title="ModelAttribute"></a>ModelAttribute</h2><h3 id="方法使用-ModelAttribute标注"><a href="#方法使用-ModelAttribute标注" class="headerlink" title="方法使用@ModelAttribute标注"></a>方法使用@ModelAttribute标注</h3><p>标注了@ModelAttribute的方法实际上会在@RequestMapping方法之前被调用<br>@ModelAttribute说明方法是用于添加一个或多个属性到model上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 方式一，方法接收一个Model对象，然后可以向其中添加任意数量的属性</span></div><div class="line"><span class="meta">@ModelAttribute</span>  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">populateModel</span><span class="params">(@RequestParam String abc, Model model)</span> </span>&#123;  </div><div class="line">   model.addAttribute(<span class="string">"attributeName"</span>, abc);  </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 方式二，方法通过返回值的方式默认地将添加一个属性，框架将根据属性的类型给予一个默认名称</span></div><div class="line"><span class="meta">@ModelAttribute</span></div><div class="line"><span class="function"><span class="keyword">public</span> Account <span class="title">addAccount</span><span class="params">(@RequestParam String number)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> accountManager.findAccount(number);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="方法参数使用-ModelAttribute标注"><a href="#方法参数使用-ModelAttribute标注" class="headerlink" title="方法参数使用@ModelAttribute标注"></a>方法参数使用@ModelAttribute标注</h3><p>标注在方法参数上的@ModelAttribute说明了该方法参数的值将由model中取得</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(path = <span class="string">"/owners/&#123;ownerId&#125;/pets/&#123;petId&#125;/edit"</span>, method = RequestMethod.POST)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">processSubmit</span><span class="params">(@ModelAttribute Pet pet)</span> </span>&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">	<span class="attr">default-lazy-init</span>=<span class="string">"false"</span> <span class="attr">default-autowire</span>=<span class="string">"byName"</span>&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>default-autowire：根据属性名自动装配<br>根据名字查找与属性完全一致的bean，并将其与属性自动装配</p>
<h1 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h1><h2 id="获取User-Agent"><a href="#获取User-Agent" class="headerlink" title="获取User-Agent"></a>获取User-Agent</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//handler加参数</span></div><div class="line"><span class="function"><span class="keyword">public</span> ResultInfo <span class="title">submit</span><span class="params">(HttpServletRequest req, @ModelAttribute(value = <span class="string">"serviceProductInfo"</span>)</span> ServiceProductInfo serviceProductInfo, @<span class="title">RequestHeader</span><span class="params">(<span class="string">"User-Agent"</span>)</span> String userAgent) </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Solutions"><a href="#Solutions" class="headerlink" title="Solutions"></a>Solutions</h1><h2 id="Spring初始化完成事件"><a href="#Spring初始化完成事件" class="headerlink" title="Spring初始化完成事件"></a>Spring初始化完成事件</h2><p>由于worker的启动速度非常快，会出现当spring中的bean还未初始化完毕，worker就开始调用这些bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ApplicationListener&lt;ContextRefreshedEvent&gt;这是spring的事件机制，spring初始化完成后会触发</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageProducerScheduler</span> <span class="keyword">implements</span> <span class="title">IScheduleTaskDealMulti</span>&lt;<span class="title">MessageTask</span>&gt;, <span class="title">ApplicationListener</span>&lt;<span class="title">ContextRefreshedEvent</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">//在spring启动完成后会执行此方法</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextRefreshedEvent event)</span> </span>&#123;</div><div class="line">  	</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="InitializingBean接口"><a href="#InitializingBean接口" class="headerlink" title="InitializingBean接口"></a>InitializingBean接口</h2><p><code>Bean初始化是执行</code><br>InitializingBean接口为bean提供了初始化方法的方式，<br>只包括afterPropertiesSet方法，<br>凡是继承该接口的类，在Spring初始化bean的时候会执行该方法。</p>
<p>实现InitializingBean接口与配置文件中指定init-method不同<br>系统是先调用afterPropertiesSet方法，然后再调用init-method中指定的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InitializingBean</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="通过实现ApplicationContextAware接口获取bean"><a href="#通过实现ApplicationContextAware接口获取bean" class="headerlink" title="通过实现ApplicationContextAware接口获取bean"></a>通过实现ApplicationContextAware接口获取bean</h2><p>场景：<br>在代码中需要动态获取其它bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.company.xxx;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</div><div class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</div><div class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 获取spring容器，以访问容器中定义的其他bean</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringContextUtil</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// Spring应用上下文环境</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext applicationContext;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 实现ApplicationContextAware接口的回调方法，设置上下文环境</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span></span></div><div class="line">			<span class="keyword">throws</span> BeansException &#123;</div><div class="line">		SpringContextUtil.applicationContext = applicationContext;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationContext <span class="title">getApplicationContext</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> applicationContext;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 获取对象 这里重写了bean方法，起主要作用</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> name</div><div class="line">	 * <span class="doctag">@return</span>  Object 一个以所给名字注册的bean的实例</div><div class="line">	 * <span class="doctag">@throws</span> BeansException</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getBean</span><span class="params">(String beanId)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">		<span class="keyword">return</span> applicationContext.getBean(beanId);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"SpringContextUtil"</span><span class="attr">class</span>=<span class="string">"org.company.xxx.SpringContextUtil"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>实现了ApplicationContextAware接口，在Bean的实例化时会自动调用setApplicationContext()方法<br>通过调用静态方法getBean即可获取</p>
<h2 id="xml注入map"><a href="#xml注入map" class="headerlink" title="xml注入map"></a>xml注入map</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">util:map</span> <span class="attr">id</span>=<span class="string">"waybillTaskDaoMap"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"waybill_sync_task"</span> <span class="attr">value-ref</span>=<span class="string">"waybillSyncTaskDao"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"waybill_sync0_task"</span> <span class="attr">value-ref</span>=<span class="string">"waybillSync0TaskDao"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">util:map</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">util:map</span> <span class="attr">id</span>=<span class="string">"waybillSyncTaskTypes"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"0"</span> <span class="attr">value</span>=<span class="string">"doWaybillSync0TaskRedis"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"1"</span> <span class="attr">value</span>=<span class="string">"doWaybillSync1TaskRedis"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">util:map</span>&gt;</span></div></pre></td></tr></table></figure>
<h1 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h1><p>适合场景性能监控、访问控制、事务管理及日志记录</p>
<h2 id="Spring-AOP"><a href="#Spring-AOP" class="headerlink" title="Spring AOP"></a>Spring AOP</h2><h3 id="Pointcut-Expression"><a href="#Pointcut-Expression" class="headerlink" title="Pointcut Expression"></a>Pointcut Expression</h3><h4 id="args"><a href="#args" class="headerlink" title="args"></a>args</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@AfterReturning</span>(value = <span class="string">"target(com.jd.jmq.client.producer.MessageProducer) &amp;&amp; args(message,..))"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendSingleMessage</span><span class="params">( Message message)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">this</span>.addMessage(message);</div><div class="line">    logger.info(JacksonUtil.toJson(message));</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@Before</span>(value=<span class="string">"com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; target(bean) &amp;&amp; @annotation(auditable)"</span>,</div><div class="line">        argNames=<span class="string">"bean,auditable"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">audit</span><span class="params">(Object bean, Auditable auditable)</span> </span>&#123;</div><div class="line">    AuditCode code = auditable.value();</div><div class="line">    <span class="comment">// ... use code and bean</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Before</span>(value=<span class="string">"com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; target(bean) &amp;&amp; @annotation(auditable)"</span>,</div><div class="line">        argNames=<span class="string">"bean,auditable"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">audit</span><span class="params">(JoinPoint jp, Object bean, Auditable auditable)</span> </span>&#123;</div><div class="line">    AuditCode code = auditable.value();</div><div class="line">    <span class="comment">// ... use code, bean, and jp</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="切面顺序"><a href="#切面顺序" class="headerlink" title="切面顺序"></a>切面顺序</h2><p>目标执行前（进入时），优先级高的通知先执行，<br>目标执行后（出来时），优先级高的通知后执行</p>
<p>未指定顺序，Spring AOP将以<code>随机的顺序</code>来织入这两个增强处理。</p>
<p>方法1：实现org.springframework.core.Ordered接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>  </div><div class="line"><span class="meta">@Aspect</span>  </div><div class="line"><span class="meta">@Slf</span>4j  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageQueueAopAspect1</span> <span class="keyword">implements</span> <span class="title">Ordered</span></span>&#123;</div><div class="line">	<span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="comment">// TODO Auto-generated method stub  </span></div><div class="line">        <span class="keyword">return</span> <span class="number">2</span>;  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>方法2：注解：org.springframework.core.annotation.Order </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>  </div><div class="line"><span class="meta">@Aspect</span>  </div><div class="line"><span class="meta">@Slf</span>4j  </div><div class="line"><span class="meta">@Order</span>(<span class="number">1</span>)  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageQueueAopAspect1</span></span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>方法3：配置文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">aop:config</span> <span class="attr">expose-proxy</span>=<span class="string">"true"</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"aopBean"</span> <span class="attr">order</span>=<span class="string">"0"</span>&gt;</span>    </div><div class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"testPointcut"</span>  <span class="attr">expression</span>=<span class="string">"@annotation(xxx.xxx.xxx.annotation.xxx)"</span>/&gt;</span>    </div><div class="line">        <span class="tag">&lt;<span class="name">aop:around</span> <span class="attr">pointcut-ref</span>=<span class="string">"testPointcut"</span> <span class="attr">method</span>=<span class="string">"doAround"</span> /&gt;</span>    </div><div class="line">        <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span>    </div><div class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="AOP-issue"><a href="#AOP-issue" class="headerlink" title="AOP issue"></a>AOP issue</h2><h3 id="自定义AOP-注解-在同一个类中的方法级别调用导致aop注解失效"><a href="#自定义AOP-注解-在同一个类中的方法级别调用导致aop注解失效" class="headerlink" title="自定义AOP 注解 在同一个类中的方法级别调用导致aop注解失效"></a>自定义AOP 注解 在同一个类中的方法级别调用导致aop注解失效</h3><ol>
<li>AOP上下文暴露代理对象</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(TicketService)AopContext.currentProxy()</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span> <span class="attr">expose-proxy</span>=<span class="string">"true"</span>/&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Spring4.3</span></div><div class="line"><span class="meta">@EnableAspectJAutoProxy</span>(exposeProxy=<span class="keyword">true</span>, proxyTargetClass=<span class="keyword">false</span>)</div></pre></td></tr></table></figure>
<ol>
<li>通过ApplicationContext获取代理对象</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringUtil</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext applicationContext;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span></span></div><div class="line">            <span class="keyword">throws</span> BeansException &#123;</div><div class="line">        <span class="keyword">if</span> (SpringUtil.applicationContext == <span class="keyword">null</span>) &#123;</div><div class="line">            SpringUtil.applicationContext = applicationContext;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取applicationContext</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationContext <span class="title">getApplicationContext</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> applicationContext;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//通过name获取 Bean.</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getBean</span><span class="params">(String name)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> getApplicationContext().getBean(name);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//通过class获取Bean.</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(Class&lt;T&gt; clazz)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> getApplicationContext().getBean(clazz);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//通过name,以及Clazz返回指定的Bean</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(String name,Class&lt;T&gt; clazz)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> getApplicationContext().getBean(name, clazz);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="配置加载-properties、xml"><a href="#配置加载-properties、xml" class="headerlink" title="配置加载 properties、xml"></a>配置加载 properties、xml</h1><h2 id="使用Environment"><a href="#使用Environment" class="headerlink" title="使用Environment"></a>使用Environment</h2><p>使用  @PropertySource 加载配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Autowired</span></div><div class="line"><span class="keyword">private</span> Environment env;</div></pre></td></tr></table></figure>
<h2 id="使用SpEL表达式"><a href="#使用SpEL表达式" class="headerlink" title="使用SpEL表达式"></a>使用SpEL表达式</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 通过SpEL表达式#&#123;&#125;获取配置 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">util:properties</span> <span class="attr">id</span>=<span class="string">"config"</span> <span class="attr">location</span>=<span class="string">"classpath:props.properties"</span> /&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"ds"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp.BasicDataSource"</span> <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"#&#123;config.driver&#125;"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"#&#123;config.url&#125;"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"#&#123;config.username&#125;"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"#&#123;config.password&#125;"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="通过Properties实体"><a href="#通过Properties实体" class="headerlink" title="通过Properties实体"></a>通过Properties实体</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- done logo xml 配置--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">util:properties</span> <span class="attr">location</span>=<span class="string">"classpath:system/done_logo.xml"</span> /&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 代码获取properties</span></div><div class="line">Properties doneLogo = applicationContext.getBean(<span class="string">"doneLogo"</span>,Properties.class);</div></pre></td></tr></table></figure>
<h2 id="配置注入"><a href="#配置注入" class="headerlink" title="配置注入"></a>配置注入</h2><p>Spring中的 @Value 注解可以获得Spring容器中加载的全局变量。以注解的形式赋予bean的成员变量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//1. Property Example</span></div><div class="line"><span class="comment">//@PropertySource("classpath:/config.properties&#125;")</span></div><div class="line"><span class="comment">//@Configuration</span></div><div class="line"></div><div class="line"><span class="comment">// 默认值</span></div><div class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;mongodb.url:127.0.0.1&#125;"</span>)</div><div class="line"><span class="keyword">private</span> String mongodbUrl;</div><div class="line"></div><div class="line"><span class="meta">@Value</span>(<span class="string">"#&#123;'$&#123;mongodb.url:172.0.0.1&#125;'&#125;"</span>)</div><div class="line"><span class="keyword">private</span> String mongodbUrl;</div><div class="line"></div><div class="line"><span class="meta">@Value</span>(<span class="string">"#&#123;config['mongodb.url']?:'127.0.0.1'&#125;"</span>)</div><div class="line"><span class="keyword">private</span> String mongodbUrl;</div><div class="line"></div><div class="line"><span class="meta">@Value</span>(<span class="string">"#&#123;aBean.age ?: 21&#125;"</span>)</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> age;</div></pre></td></tr></table></figure>
<h2 id="使用-PropertiesFactoryBean"><a href="#使用-PropertiesFactoryBean" class="headerlink" title="使用 PropertiesFactoryBean"></a>使用 PropertiesFactoryBean</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"emailProps"</span></span></div><div class="line">    <span class="attr">class</span>=<span class="string">"org.springframework.beans.factory.config.PropertiesFactoryBean"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"location"</span></span></div><div class="line">        <span class="attr">value</span>=<span class="string">"classpath:com/smart/fb/mails.properties"</span>&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">PropertiesFactoryBean pfb = <span class="keyword">new</span> PropertiesFactoryBean();</div><div class="line">pfb.setLocation(TEST_PROPS);</div><div class="line">Properties localProps = <span class="keyword">new</span> Properties();</div><div class="line">localProps.setProperty(<span class="string">"key2"</span>, <span class="string">"value2"</span>);</div><div class="line">localProps.setProperty(<span class="string">"tb.array[0].age"</span>, <span class="string">"0"</span>);</div><div class="line">pfb.setProperties(localProps);</div><div class="line"></div><div class="line">pfb.afterPropertiesSet();</div><div class="line">Properties props = pfb.getObject();</div><div class="line">assertEquals(<span class="string">"99"</span>, props.getProperty(<span class="string">"tb.array[0].age"</span>));</div><div class="line">assertEquals(<span class="string">"value2"</span>, props.getProperty(<span class="string">"key2"</span>));</div></pre></td></tr></table></figure>
<h1 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h1><h2 id="Java读取环境变量"><a href="#Java读取环境变量" class="headerlink" title="Java读取环境变量"></a>Java读取环境变量</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># VM arguments指定log4j配置文件</span></div><div class="line">-Dlog4j.configurationFile=path/to/log4j2.xml</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 获取配置</span></div><div class="line">System.getProperty(<span class="string">"log4j.configurationFile"</span>)</div></pre></td></tr></table></figure>
<h1 id="Spring-IOC"><a href="#Spring-IOC" class="headerlink" title="Spring IOC"></a>Spring IOC</h1><h2 id="父子容器"><a href="#父子容器" class="headerlink" title="父子容器"></a>父子容器</h2><p>父容器仅仅是 bean（对象） 对子容器可见，加载的全局变量仍然相互独</p>
<h2 id="BeanFactory和ApplicationContext"><a href="#BeanFactory和ApplicationContext" class="headerlink" title="BeanFactory和ApplicationContext"></a>BeanFactory和ApplicationContext</h2><p>Spring通过配置文件描述Bean之前的依赖关系，利用java<code>反射</code>实例化Bean并建立Bean之间的依赖关系。</p>
<h2 id="WebApplicationContext"><a href="#WebApplicationContext" class="headerlink" title="WebApplicationContext"></a>WebApplicationContext</h2><p>WebApplicationContext必须在拥有web容器的前提下才能完成启动的工作。<br>xml中配置自启动Servlet或ServletContextListenter完成启动Spring Web应用上下文。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// configLocations 中可包含系统变量</span></div><div class="line">ClassPathXmlApplicationContext pFactory = <span class="keyword">new</span> ClassPathXmlApplicationContext(</div><div class="line">                <span class="keyword">new</span> String[]&#123;<span class="string">"com/smart/attr/beans1.xml"</span>&#125;);</div><div class="line"><span class="comment">// 子容器</span></div><div class="line">ApplicationContext factory = <span class="keyword">new</span> ClassPathXmlApplicationContext(</div><div class="line"><span class="keyword">new</span> String[]&#123;<span class="string">"com/smart/attr/beans2.xml"</span>&#125;,pFactory);</div></pre></td></tr></table></figure>
<p><code>ContextLoaderListener</code>通过Web容器上下文参数<code>contextConfigLocation</code>获取Spring配置文件位置。<br>可指定多个配置文件，用逗号、空格或分号分隔。</p>
<p>DispatcherServlet是一个Servlet,<code>可同时配置多个</code>，<br>每个 DispatcherServlet有一个自己的 WebApplicationContext上下文，这个上下文继承了 <code>根上下文</code> 中所有东西。</p>
<p>使用工具类取出上下文：<br>WebApplicationContextUtils.getWebApplicationContext(ServletContext);<br>RequestContextUtils.getWebApplicationContext(request);</p>
<p>可不使用listener监听器来加载spring的配置，改用DispatcherServlet来加载spring的配置，不要双亲上下文，只使用一个DispatcherServlet</p>
<h2 id="Bean命名"><a href="#Bean命名" class="headerlink" title="Bean命名"></a>Bean命名</h2><p>id命名规范：字母开头，后面字母、数字、连字符、下划线、句号、冒号；<br>name命名没有字符限制；<br>id是<code>标识符</code>，name是<code>别名</code>；</p>
<p>id 和 name都可以指定多个，以逗号、分号或空格分隔；<br>id 必须唯一；同名name，后面Bean<code>覆盖</code>前面同名的Bean；<br>为了避免无意间Bean覆盖的隐患，<code>尽量使用id而非name命名Bean</code>。</p>
<p>如果id和name都未指定，Spring自动将<code>完全限定名</code>作为Bean的名称。<br>完全限定名相同的多个未命名bean加#i后缀</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- com.smart.ditype.Car --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.smart.ditype.Car"</span> /&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- com.smart.ditype.Car#1 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.smart.ditype.Car"</span> /&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 两种别名方式 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.smart.ditype.Bar"</span> <span class="attr">id</span>=<span class="string">"bar"</span> <span class="attr">name</span>=<span class="string">"barA,barB"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"bar"</span> <span class="attr">alias</span>=<span class="string">"barC"</span> /&gt;</span></div></pre></td></tr></table></figure>
<h2 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h2><p>一般java属性名以小写字母开头，<br>JavaBean允许大写字母开头的属性变量名，不过必须满足<code>变量的前两个字母要么全部大写，要么全部小写</code></p>
<h3 id="构造器注入"><a href="#构造器注入" class="headerlink" title="构造器注入"></a>构造器注入</h3><p>按类型匹配入参</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--构造函数注入：type --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"car1"</span> <span class="attr">class</span>=<span class="string">"com.smart.ditype.Car"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">type</span>=<span class="string">"java.lang.String"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>红旗CA72<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">type</span>=<span class="string">"double"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>20000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<p>按索引匹配入参</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 构造函数注入：index  --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"car2"</span> <span class="attr">class</span>=<span class="string">"com.smart.ditype.Car"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">value</span>=<span class="string">"红旗CA72"</span> /&gt;</span> </div><div class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"1"</span> <span class="attr">value</span>=<span class="string">"中国一汽"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"2"</span> <span class="attr">value</span>=<span class="string">"20000"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<p>联合使用类型和索引</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--构造函数注入：type&amp;index --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"car3"</span> <span class="attr">class</span>=<span class="string">"com.smart.ditype.Car"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">type</span>=<span class="string">"java.lang.String"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>红旗CA72<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"1"</span> <span class="attr">type</span>=<span class="string">"java.lang.String"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>中国一汽<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"2"</span> <span class="attr">type</span>=<span class="string">"int"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>200<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<p><code>没设置type和index</code>,通过入参值的类型匹配映射</p>
<p>循环依赖问题，将<code>构造函数注入</code>调整为<code>属性注入方式</code>即可</p>
<h3 id="注入参数"><a href="#注入参数" class="headerlink" title="注入参数"></a>注入参数</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"boss1"</span> <span class="attr">class</span>=<span class="string">"com.smart.ditype.Boss"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"car"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">local</span>=<span class="string">"car"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">parent</span>=<span class="string">"office"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<p><ref> 3种方式引用Bean：<br>bean同一容器或父容器的Bean；<br>local同一配置文件中的Bean；<br>parent引用父容器中的Bean；</ref></p>
<h3 id="集合类型属性"><a href="#集合类型属性" class="headerlink" title="集合类型属性"></a>集合类型属性</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"boss1"</span> <span class="attr">class</span>=<span class="string">"com.smart.attr.Boss"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"car"</span> <span class="attr">ref</span>=<span class="string">"car"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"favorites"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- list&gt;</span></div><div class="line">            &lt;value&gt;看报&lt;/value&gt;</div><div class="line">            &lt;/list --&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>看报<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"stage1"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobs"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">map</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">entry</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">value</span>&gt;</span>AM<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>会见客户<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">entry</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">value</span>&gt;</span>PM<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>公司内部会议<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">map</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mails"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- Properties属性配置 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">props</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"jobMail"</span>&gt;</span>john-office@baobaotao.com<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"lifeMail"</span>&gt;</span>john-life@baobaotao.com<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">props</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobTime"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">map</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">entry</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">value</span>&gt;</span>会见客户<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>124<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">map</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="通过util命名空间配置集合类型Bean"><a href="#通过util命名空间配置集合类型Bean" class="headerlink" title="通过util命名空间配置集合类型Bean"></a>通过util命名空间配置集合类型Bean</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">util:list</span> <span class="attr">id</span>=<span class="string">"favoriteList1"</span> <span class="attr">list-class</span>=<span class="string">"java.util.LinkedList"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>看报<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>赛车<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>高尔夫<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">util:list</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">util:set</span> <span class="attr">id</span>=<span class="string">"favoriteSet1"</span>  &gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>看报<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>赛车<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>高尔夫<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">util:set</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">util:map</span> <span class="attr">id</span>=<span class="string">"emails1"</span> &gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"AM"</span> <span class="attr">value</span>=<span class="string">"会见客户"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"PM"</span> <span class="attr">value</span>=<span class="string">"公司内部会议"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">util:map</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"emails"</span></span></div><div class="line">    <span class="attr">class</span>=<span class="string">"org.springframework.beans.factory.config.MapFactoryBean"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sourceMap"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">map</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"AM"</span> <span class="attr">value</span>=<span class="string">"会见客户"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"PM"</span> <span class="attr">value</span>=<span class="string">"公司内部会议"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">map</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"emailProps"</span></span></div><div class="line">    <span class="attr">class</span>=<span class="string">"org.springframework.beans.factory.config.PropertiesFactoryBean"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"location"</span></span></div><div class="line">        <span class="attr">value</span>=<span class="string">"classpath:com/smart/fb/mails.properties"</span>&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">util:properties</span> <span class="attr">id</span>=<span class="string">"emailProps1"</span> <span class="attr">location</span>=<span class="string">"classpath:com/smart/fb/mails.properties"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p>获取类的静态变量:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"car2"</span> <span class="attr">class</span>=<span class="string">"com.smart.fb.Car"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"brand"</span> <span class="attr">ref</span>=<span class="string">"hongQi"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- 获取类的静态变量 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"hongQi"</span></span></div><div class="line">    <span class="attr">class</span>=<span class="string">"org.springframework.beans.factory.config.FieldRetrievingFactoryBean"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"staticField"</span></span></div><div class="line">        <span class="attr">value</span>=<span class="string">"com.smart.fb.CarBrandType.HONG_QI"</span>&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"car3"</span> <span class="attr">class</span>=<span class="string">"com.smart.fb.Car"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"brand"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 用常量的全限定名作为FieldRetrievingFactoryBean的id，其效果和通过配置staticField属性是一样的 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"com.smart.fb.CarBrandType.HONG_QI"</span></span></div><div class="line">            <span class="attr">class</span>=<span class="string">"org.springframework.beans.factory.config.FieldRetrievingFactoryBean"</span>&gt;</div><div class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"car4"</span> <span class="attr">class</span>=<span class="string">"com.smart.fb.Car"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"brand"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">util:constant</span></span></div><div class="line">            <span class="attr">static-field</span>=<span class="string">"com.smart.fb.CarBrandType.HONG_QI"</span> /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<p>属性路径引用：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 属性引用FactoryBean:属性路径引用 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"boss"</span> <span class="attr">class</span>=<span class="string">"com.smart.fb.Boss"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"John"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"car"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.smart.fb.Car"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"brand"</span> <span class="attr">value</span>=<span class="string">"红旗CA72"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"car5"</span> <span class="attr">class</span>=<span class="string">"com.smart.fb.Car"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"brand"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"boss.car.brand"</span></span></div><div class="line">            <span class="attr">class</span>=<span class="string">"org.springframework.beans.factory.config.PropertyPathFactoryBean"</span> /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"car6"</span> <span class="attr">class</span>=<span class="string">"com.smart.fb.Car"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"brand"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">util:property-path</span> <span class="attr">path</span>=<span class="string">"boss.car.brand"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="运行时注入-属性占位符"><a href="#运行时注入-属性占位符" class="headerlink" title="运行时注入-属性占位符"></a>运行时注入-属性占位符</h3><p>TODO</p>
<h3 id="运行时注入-Spring表达式语言-SpEL"><a href="#运行时注入-Spring表达式语言-SpEL" class="headerlink" title="运行时注入-Spring表达式语言(SpEL)"></a>运行时注入-Spring表达式语言(SpEL)</h3><p>TODO</p>
<h2 id="Bean作用域"><a href="#Bean作用域" class="headerlink" title="Bean作用域"></a>Bean作用域</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"person"</span> <span class="attr">class</span>=<span class="string">"com.xxc.scope.domain.Person"</span> <span class="attr">scope</span>=<span class="string">"singleton"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li>singleton: 单例</li>
<li><p>prototype: 每次getBean() 返回新实例</p>
</li>
<li><p>request: 仅web应用中</p>
</li>
<li>session: 仅web应用中</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// proxyMode 解决request域或Session域bean注入单例bean中遇到的问题</span></div><div class="line"><span class="comment">// 1. StoreService是单例的，StoreService在spring上下文加载时创建；此时注入shoppingCart，但shoppingCart还不存在；</span></div><div class="line"><span class="comment">// 2. StoreService中注入的shoppingCart不应该是固定的，而是每个用户一个；</span></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StoreService</span> </span>&#123;</div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setShoppingCart</span><span class="params">(ShoppingCart shoppingCart)</span></span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 配置proxyMode，spring 不会讲实际的ShoppingCart注入到StoreService中，而是注入一个ShoppingCart的代理</span></div><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="meta">@Scope</span>(scopeName=<span class="string">"session"</span>, proxyMode=ScopedProxyMode.TARGET_CLASS)</div><div class="line"><span class="function">ShoppingCart <span class="title">shoppingCart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ShoppingCart();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"shoppingCart"</span> <span class="attr">class</span>=<span class="string">"com.foo.ShoppingCart"</span> <span class="attr">scope</span>=<span class="string">"session"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">aop:scoped-proxy</span> <span class="attr">proxy-target-class</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="校验Bean成员变量是否设置"><a href="#校验Bean成员变量是否设置" class="headerlink" title="校验Bean成员变量是否设置"></a>校验Bean成员变量是否设置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"CustomerBean"</span> <span class="attr">class</span>=<span class="string">"com.mkyong.common.Customer"</span> </span></div><div class="line">     <span class="attr">dependency-check</span>=<span class="string">"simple"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"person"</span> <span class="attr">ref</span>=<span class="string">"PersonBean"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"action"</span> <span class="attr">value</span>=<span class="string">"buy"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"CustomerBean"</span> <span class="attr">class</span>=<span class="string">"com.mkyong.common.Customer"</span> </span></div><div class="line">     <span class="attr">dependency-check</span>=<span class="string">"objects"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"action"</span> <span class="attr">value</span>=<span class="string">"buy"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"type"</span> <span class="attr">value</span>=<span class="string">"1"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"CustomerBean"</span> <span class="attr">class</span>=<span class="string">"com.mkyong.common.Customer"</span> </span></div><div class="line">     <span class="attr">dependency-check</span>=<span class="string">"all"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"action"</span> <span class="attr">value</span>=<span class="string">"buy"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="自动注入配置"><a href="#自动注入配置" class="headerlink" title="自动注入配置"></a>自动注入配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"autowireTest1"</span> <span class="attr">autowire</span>=<span class="string">"no"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="meta元素"><a href="#meta元素" class="headerlink" title="meta元素"></a>meta元素</h2><p>Bean可配置额外的meta声明;可通过BeanDefinition的getAttribute(key)获取</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"footmark.HelloWorld"</span>&gt;</span> </div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">key</span>=<span class="string">"format"</span> <span class="attr">value</span>=<span class="string">"DVD"</span>/&gt;</span> </div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">key</span>=<span class="string">"genre"</span> <span class="attr">value</span>=<span class="string">"Action"</span>/&gt;</span> </div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="lookup-method"><a href="#lookup-method" class="headerlink" title="lookup-method"></a>lookup-method</h2><ul>
<li>spring动态改变bean方法返回的对象</li>
<li>Bean类型可为抽象类（Spring使用cglib实现）</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"bar"</span> <span class="attr">class</span>=<span class="string">"com.sunday.common.domain.Bar"</span> <span class="attr">p:name</span>=<span class="string">"lookup-methond-demo"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"barService"</span> <span class="attr">class</span>=<span class="string">"com.sunday.spring3_learn.api.impl.BarServiceImpl"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">lookup-method</span> <span class="attr">name</span>=<span class="string">"queryBar"</span> <span class="attr">bean</span>=<span class="string">"bar"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="replaced-method"><a href="#replaced-method" class="headerlink" title="replaced-method"></a>replaced-method</h2><p>动态更改原方法的逻辑</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"myValueCalculator"</span> <span class="attr">class</span>=<span class="string">"x.y.z.MyValueCalculator"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- arbitrary method replacement --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">replaced-method</span> <span class="attr">name</span>=<span class="string">"computeValue"</span> <span class="attr">replacer</span>=<span class="string">"replacementComputeValue"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">arg-type</span>&gt;</span>String<span class="tag">&lt;/<span class="name">arg-type</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">replaced-method</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<h1 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h1><p><code>工具方法</code></p>
<h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 字符串分隔</span></div><div class="line">String dependents = <span class="string">"dc1,dc2;dc3"</span>;</div><div class="line">String[] tokenizeToStringArray = StringUtils.tokenizeToStringArray(dependents, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</div><div class="line">System.out.println(JSON.toJSON(tokenizeToStringArray));</div><div class="line"></div><div class="line"><span class="comment">// 数组拼接字符串</span></div><div class="line">String arrayToDelimitedString = StringUtils.arrayToDelimitedString(tokenizeToStringArray, <span class="string">"|"</span>);</div><div class="line">System.out.println(arrayToDelimitedString);</div></pre></td></tr></table></figure>
<h2 id="类加载"><a href="#类加载" class="headerlink" title="类加载"></a>类加载</h2><p><code>org.springframework.util.ClassUtils</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isPresent</span><span class="params">(String className, ClassLoader classLoader)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (classLoader == <span class="keyword">null</span>) &#123;</div><div class="line">        classLoader = ClassUtils.getDefaultClassLoader();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        forName(className, classLoader);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Class&lt;?&gt; forName(String className, ClassLoader classLoader)</div><div class="line">        <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">    <span class="keyword">if</span> (classLoader != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> classLoader.loadClass(className);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> Class.forName(className);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="文件读取"><a href="#文件读取" class="headerlink" title="文件读取"></a>文件读取</h2><p><code>配置文件</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Resource classPathResource = <span class="keyword">new</span> ClassPathResource(<span class="string">"log4j2.xml"</span>);</div><div class="line">        </div><div class="line">FileSystemResource fileSystemResource = <span class="keyword">new</span> FileSystemResource(<span class="string">"F:\\XXX\\log4j2.xml"</span>);</div><div class="line"></div><div class="line">UrlResource urlResource = <span class="keyword">new</span> UrlResource(<span class="string">"http://libs.baidu.com/jquery/1.9.1/jquery.min.js"</span>);</div><div class="line"></div><div class="line">InputStreamResource inputStreamResource = <span class="keyword">new</span> InputStreamResource(<span class="keyword">new</span> FileInputStream(<span class="string">"F:\\XXX\\log4j2.xml"</span>));</div><div class="line"></div><div class="line">ByteArrayResource byteArrayResource = <span class="keyword">new</span> ByteArrayResource(<span class="keyword">new</span> String(<span class="string">"configData"</span>).getBytes());</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Ant模式通配符匹配</span></div><div class="line"><span class="comment">// ?    匹配任何单字符  </span></div><div class="line"><span class="comment">// *   匹配0或者任意数量的字符     </span></div><div class="line"><span class="comment">// **  匹配0或者更多的目录</span></div><div class="line">PathMatchingResourcePatternResolver resolver = <span class="keyword">new</span> PathMatchingResourcePatternResolver();</div><div class="line">Resource[] resources = resolver.getResources(<span class="string">"classpath:mybatis/**/*.xml"</span>);</div><div class="line"></div><div class="line">Resource resources = resolver.getResource(<span class="string">"file:F:\\done-logo.xml"</span>);</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">&lt;!-- classpath：只会到你的class路径中查找找文件;  --&gt;</span></div><div class="line"><span class="comment">&lt;!-- classpath*：不仅包含class路径，还包括jar文件中(class路径)进行查找 --&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- &lt;context:property-placeholder location="classpath*:conf/conf*.properties" /&gt; --&gt;</span></div><div class="line"><span class="comment">&lt;!-- &lt;context:property-placeholder location="classpath:conf/conf*.properties" ignore-unresolvable="true"/&gt; --&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- ignore-resource-not-found：如果属性文件找不到，是否忽略，默认false，即不忽略，找不到将抛出异常  --&gt;</span></div><div class="line"><span class="comment">&lt;!-- ignore-unresolvable：是否忽略解析不到的属性，如果不忽略，找不到将抛出异常  --&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath:redis.properties"</span> </span></div><div class="line">    <span class="attr">ignore-unresolvable</span>=<span class="string">"true"</span></div><div class="line">    <span class="attr">ignore-resource-not-found</span>=<span class="string">"true"</span>/&gt;</div><div class="line"></div><div class="line"></div><div class="line">    </div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jedisConnFactory"</span> <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.connection.jedis.JedisConnectionFactory"</span></span></div><div class="line">    <span class="attr">p:host-name</span>=<span class="string">"$&#123;redis.hostName&#125;"</span> </div><div class="line">    <span class="attr">p:port</span>=<span class="string">"$&#123;resis.port&#125;"</span> </div><div class="line">    <span class="attr">p:timeout</span>=<span class="string">"$&#123;redis.timeout&#125;"</span></div><div class="line">    <span class="attr">p:password</span>=<span class="string">"$&#123;redis.password&#125;"</span> </div><div class="line">    <span class="attr">p:use-pool</span>=<span class="string">"$&#123;redis.usePool&#125;"</span> /&gt;</div></pre></td></tr></table></figure>
<h2 id="断言"><a href="#断言" class="headerlink" title="断言"></a>断言</h2><p>org.springframework.util.Assert</p>
<h2 id="xml解析"><a href="#xml解析" class="headerlink" title="xml解析"></a>xml解析</h2><p>org.springframework.util.xml.DomUtils#getChildElementValueByTagName</p>
<h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><h2 id="最好不要配置xsd文件的版本号"><a href="#最好不要配置xsd文件的版本号" class="headerlink" title="最好不要配置xsd文件的版本号"></a>最好不要配置xsd文件的版本号</h2><p>因为如果没有配置版本号，取的就是当前jar里的XSD文件，减少了各种风险。<br>而且这样约定大于配置的方式很优雅。</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Nginx]]></title>
      <url>http://xiaozhuang.github.io/2017/05/14/nginx/</url>
      <content type="html"><![CDATA[<p>Tengine 负载均衡、健康检查<br><a id="more"></a></p>
<h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><h2 id="安装必要的库"><a href="#安装必要的库" class="headerlink" title="安装必要的库"></a>安装必要的库</h2><p>选定<code>/usr/local</code>为安装目录</p>
<p>gzip模块需要 zlib 库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/</div><div class="line">wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.40.tar.gz</div><div class="line">tar -zxvf pcre-8.40.tar.gz</div><div class="line"><span class="built_in">cd</span> pcre-8.40</div><div class="line">./configure</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure>
<p>rewrite模块需要 pcre 库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/ </div><div class="line">wget http://zlib.net/zlib-1.2.8.tar.gz</div><div class="line">tar -zxvf zlib-1.2.8.tar.gz</div><div class="line"><span class="built_in">cd</span> zlib-1.2.8</div><div class="line">./configure</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure>
<p>ssl 功能需要openssl库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/</div><div class="line">wget http://www.openssl.org/<span class="built_in">source</span>/openssl-1.0.1j.tar.gz</div><div class="line">tar -zxvf openssl-1.0.1j.tar.gz</div><div class="line"><span class="built_in">cd</span> openssl-1.0.1j</div><div class="line">./config</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure>
<h2 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/</div><div class="line">wget http://nginx.org/download/nginx-1.8.0.tar.gz</div><div class="line">tar -zxvf nginx-1.8.0.tar.gz</div><div class="line"><span class="built_in">cd</span> nginx-1.8.0</div><div class="line">./configure --prefix=/usr/<span class="built_in">local</span>/nginx --with-pcre=/usr/<span class="built_in">local</span>/pcre-8.40 --with-zlib=/usr/<span class="built_in">local</span>/zlib-1.2.8 --with-openssl=/usr/<span class="built_in">local</span>/openssl-1.0.1j</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 启动</span></div><div class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx</div><div class="line"><span class="comment"># 重启</span></div><div class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx –s reload</div><div class="line"></div><div class="line"><span class="comment"># 停止</span></div><div class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx –s stop</div><div class="line"></div><div class="line"><span class="comment"># 测试配置文件是否正常</span></div><div class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx –t</div><div class="line"></div><div class="line"><span class="comment"># 强制关</span></div><div class="line">pkill nginx</div></pre></td></tr></table></figure>
<h2 id="开端口"><a href="#开端口" class="headerlink" title="开端口"></a>开端口</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/sbin/iptables -I INPUT -p tcp --dport 80 -j ACCEPT</div><div class="line">/etc/rc.d/init.d/iptables save</div><div class="line">/etc/init.d/iptables status</div></pre></td></tr></table></figure>
<h1 id="Tengine"><a href="#Tengine" class="headerlink" title="Tengine"></a>Tengine</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>Tengine完全兼容Nginx，因此可以参照Nginx的方式来配置Tengine</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">./configure --prefix=/usr/<span class="built_in">local</span>/tengine --with-pcre=/usr/<span class="built_in">local</span>/pcre-8.40 --with-zlib=/usr/<span class="built_in">local</span>/zlib-1.2.8 --with-openssl=/usr/<span class="built_in">local</span>/openssl-1.0.1j</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure>
<h2 id="负载均衡及健康检查"><a href="#负载均衡及健康检查" class="headerlink" title="负载均衡及健康检查"></a>负载均衡及健康检查</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    upstream cluster1 &#123;</div><div class="line">        # simple round-robin</div><div class="line">        server 192.168.1.105:8080;</div><div class="line">        server 192.168.1.105:18080;</div><div class="line">        check interval=3000 rise=2 fall=5 timeout=1000 type=http;</div><div class="line">        check_http_send &quot;HEAD /ping HTTP/1.0\r\n\r\n&quot;;</div><div class="line">        check_http_expect_alive http_2xx http_3xx;</div><div class="line">    &#125;</div><div class="line">    #upstream cluster2 &#123;</div><div class="line">        # simple round-robin</div><div class="line">        #server 192.168.0.3:80;</div><div class="line">        #server 192.168.0.4:80;</div><div class="line">        #check interval=3000 rise=2 fall=5 timeout=1000 type=http;</div><div class="line">        #check_keepalive_requests 100;</div><div class="line">        #check_http_send &quot;HEAD / HTTP/1.1\r\nConnection: keep-alive\r\n\r\n&quot;;</div><div class="line">        #check_http_expect_alive http_2xx http_3xx;</div><div class="line">    #&#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen 80;</div><div class="line">        location / &#123;</div><div class="line">            proxy_pass http://cluster1;</div><div class="line">        &#125;</div><div class="line">		#location /2 &#123;</div><div class="line">        #    proxy_pass http://cluster2;</div><div class="line">        #&#125;</div><div class="line">        location /status &#123;</div><div class="line">            check_status;</div><div class="line">            access_log   off;</div><div class="line">			allow 192.168.1.0/24;</div><div class="line">            deny all;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="HealthCheckController"><a href="#HealthCheckController" class="headerlink" title="HealthCheckController"></a>HealthCheckController</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HealthCheckController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@ResponseStatus</span>(HttpStatus.OK)</div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/ping"</span>, method = RequestMethod.HEAD)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ping</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Spring Boot]]></title>
      <url>http://xiaozhuang.github.io/2017/05/14/spring-boot/</url>
      <content type="html"><![CDATA[<p>Spring Boot是由Pivotal团队提供的全新框架，其设计目的是用来简化新Spring应用的初始搭建以及开发过程。<br>该框架使用了特定的方式来进行配置，从而使开发人员不再需要定义样板化的配置<br><a id="more"></a></p>
<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><p>方式1：mvn命令启动</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 项目目录下</span></div><div class="line">mvn spring-boot:run</div></pre></td></tr></table></figure>
<p>方式2：编译jar包启动</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 打包</span></div><div class="line">mvn clean package</div><div class="line"><span class="comment"># 启动</span></div><div class="line">java -jar spring_boot_learn-0.0.1-SNAPSHOT.jar</div><div class="line"></div><div class="line"><span class="comment"># 指定多环境配置</span></div><div class="line">java -jar spring_boot_learn-</div><div class="line">0.0.1-SNAPSHOT.jar --spring.profiles.active=prod</div></pre></td></tr></table></figure>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>application.properties</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">server.port=8080</div><div class="line">server.context-path=/learn</div></pre></td></tr></table></figure>
<p>application.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">server:</div><div class="line">  port: 8081</div><div class="line">  context-path: /learn</div></pre></td></tr></table></figure>
<h1 id="Conf"><a href="#Conf" class="headerlink" title="Conf"></a>Conf</h1><h2 id="ConfigurationProperties"><a href="#ConfigurationProperties" class="headerlink" title="ConfigurationProperties"></a>ConfigurationProperties</h2><p><code>加载properties文件</code></p>
<p>方案1：<br>ConfigurationProperties + EnableConfigurationProperties</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ConfigurationProperties</span>(locations = <span class="string">"classpath:mail.properties"</span>, </div><div class="line">                         ignoreUnknownFields = <span class="keyword">false</span>, </div><div class="line">                         prefix = <span class="string">"mail"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailProperties</span> </span>&#123; </div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Smtp</span> </span>&#123;  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> auth;  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> starttlsEnable;  </div><div class="line">    <span class="comment">// ... getters and setters </span></div><div class="line">  &#125;</div><div class="line">  <span class="meta">@NotBlank</span> <span class="keyword">private</span> String host;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> port;  </div><div class="line">  <span class="keyword">private</span> String from; </div><div class="line">  <span class="keyword">private</span> String username;</div><div class="line">  <span class="keyword">private</span> String password; </div><div class="line">  <span class="meta">@NotNull</span> <span class="keyword">private</span> Smtp smtp; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mail.host=localhost</div><div class="line">mail.port=25</div><div class="line">mail.smtp.auth=false</div><div class="line">mail.smtp.starttls-enable=false</div><div class="line">mail.from=me@localhost</div><div class="line">mail.username=</div><div class="line">mail.password=</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@EnableConfigurationProperties</span>(MailProperties.class)</div><div class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailConfiguration</span> </span>&#123; </div><div class="line">    <span class="meta">@Autowired</span> <span class="keyword">private</span> MailProperties mailProperties; </div><div class="line"></div><div class="line">    <span class="meta">@Bean</span> <span class="function"><span class="keyword">public</span> JavaMailSender <span class="title">javaMailSender</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="comment">// omitted for readability</span></div><div class="line">    &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>方案2：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@ConfigurationProperties</span>(locations = <span class="string">"classpath:mail.properties"</span>, </div><div class="line">                         prefix = <span class="string">"mail"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailConfiguration</span> </span>&#123; </div><div class="line">	 <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Smtp</span> </span>&#123;</div><div class="line">	    <span class="keyword">private</span> <span class="keyword">boolean</span> auth;</div><div class="line">	    <span class="keyword">private</span> <span class="keyword">boolean</span> starttlsEnable;</div><div class="line">	    <span class="comment">// ... getters and setters</span></div><div class="line">	 &#125;</div><div class="line"></div><div class="line">	 <span class="meta">@NotBlank</span> <span class="keyword">private</span> String host; </div><div class="line">	 <span class="keyword">private</span> <span class="keyword">int</span> port;</div><div class="line">	 <span class="keyword">private</span> String from; </div><div class="line">	 <span class="keyword">private</span> String username;</div><div class="line">	 <span class="keyword">private</span> String password; </div><div class="line">	</div><div class="line">	 <span class="meta">@NotNull</span> <span class="keyword">private</span> Smtp smtp; </div><div class="line">	 <span class="comment">// ... getters and setters  </span></div><div class="line">	 </div><div class="line">	 <span class="meta">@Bean</span> <span class="function"><span class="keyword">public</span> JavaMailSender <span class="title">javaMailSender</span><span class="params">()</span> </span>&#123;</div><div class="line">	  <span class="comment">// omitted for readability</span></div><div class="line">	 &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Spring </tag>
            
            <tag> Spring Boot </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[SpringData Redis]]></title>
      <url>http://xiaozhuang.github.io/2017/05/10/redis-spring-data/</url>
      <content type="html"><![CDATA[<p>SpringData Redis 学习笔记<br><a id="more"></a></p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Redis </tag>
            
            <tag> SpringData </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Redis Codis]]></title>
      <url>http://xiaozhuang.github.io/2017/05/04/redis-codis/</url>
      <content type="html"><![CDATA[<p>Codis 是一个分布式 Redis 解决方案， 对于上层的应用来说, 连接到 Codis Proxy 和连接原生的 Redis Server 没有显著区别。<br><a id="more"></a></p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[高性能 MySQL]]></title>
      <url>http://xiaozhuang.github.io/2017/04/25/mysql/</url>
      <content type="html"><![CDATA[<p>MySQL 笔记<br><a id="more"></a></p>
<h1 id="创建高性能的索引"><a href="#创建高性能的索引" class="headerlink" title="创建高性能的索引"></a>创建高性能的索引</h1><p>索引是存储引擎用于快速找到记录的一种数据结构。</p>
<p>索引能够轻易将查询性能提高<code>几个数量级</code>，<br>“最优”的索引有时比一个“好的”索引性能好<code>两个数量级</code>。</p>
<p>创建一个真正“最优”的索引经常需要重写查询。</p>
<h2 id="索引基础"><a href="#索引基础" class="headerlink" title="索引基础"></a>索引基础</h2><h3 id="索引的类型"><a href="#索引的类型" class="headerlink" title="索引的类型"></a>索引的类型</h3><p>MySQL中，索引是在存储引擎层而不是服务器层实现的。</p>
<h4 id="B-Tree索引"><a href="#B-Tree索引" class="headerlink" title="B-Tree索引"></a>B-Tree索引</h4><p>InnoDB使用B+Tree<br><img src="/2017/04/25/mysql/btreeIndexBtree.png" alt="btreeIndexBtree.png" title=""><br><blockquote><footer><strong>图片来源</strong><cite><a href="http://zhongmingmao.me/2017/05/13/innodb-btree-index/" target="_blank" rel="external">InnoDB备忘录B+Tree索引</a></cite></footer></blockquote></p>
<p>B+Tree，即每一个叶子节点都包含指向下一个叶子节点的指针，从而方便叶子节点的范围遍历。</p>
<p>B-Tree对索引列是<code>顺序</code>存储的，很适合查找范围数据。</p>
<p>B-Tree索引的查询类型：</p>
<ul>
<li>全值匹配</li>
<li>匹配最左前缀（只使用索引第一列）</li>
<li>匹配列前缀（只使用某一列索引开头部分）</li>
<li>匹配范围值</li>
<li>精确匹配某一列并范围匹配另外一列</li>
</ul>
<p>B-Tree索引的限制：</p>
<ul>
<li>不是按最左列开始查找，则无法使用索引</li>
<li>不能跳过索引中的列</li>
<li>查询中有某个列的范围查询，则其右边所有列都无法使用索引（可通过多个等于条件替换范围条件）</li>
</ul>
<blockquote>
<p>优化性能的时候，可能需要使用<code>相同的列</code>但<code>顺序不同</code>的索引来满足不同类型的查询需求</p>
</blockquote>
<h4 id="哈希索引"><a href="#哈希索引" class="headerlink" title="哈希索引"></a>哈希索引</h4><p>哈希索引基于哈希表实现</p>
<p>MySQL中只有Memory存储引擎显式支持哈希索引</p>
<p>哈希索引本身只需存储对应的哈希值和行指针，索引结构十分紧凑，<code>查找速度非常快</code>。</p>
<p>哈希索引限制：</p>
<ul>
<li>哈希索引只包含哈希值和行指针，不存储字段值，不能使用索引中的值避免读取行（性能影响不明显）</li>
<li>哈希索引数据不是按照<code>索引值顺序</code>存储的，也就无法用于排序</li>
<li>哈希索引不支持<code>部分索引列</code>匹配查找，因为哈希索引使用索引列全部内容计算哈希值</li>
<li>哈希索引只支持等值比较查询（包括=、IN()、&lt;=&gt;），不支持范围查询</li>
<li>哈希冲突很多的话，索引维护代价很高，查询速度降低</li>
</ul>
<blockquote>
<p><code>&lt;=&gt;</code> is MySQL’s null-safe “equal to” operator</p>
</blockquote>
<p>自定义哈希索引：<br>在B-Tree基础上创建伪哈希索引。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> <span class="keyword">url</span> <span class="keyword">where</span> <span class="keyword">url</span>=<span class="string">"http://www.mysql.com"</span>;</div></pre></td></tr></table></figure>
<p>新增一个被索引的url_crc列，使用CRC32做哈希(可以使用触发器实现)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> <span class="keyword">url</span> <span class="keyword">where</span> <span class="keyword">url</span>=<span class="string">"http://www.mysql.com"</span></div><div class="line">	<span class="keyword">and</span> url_crc=<span class="keyword">CRC32</span>(<span class="string">"http://www.mysql.com"</span>)</div></pre></td></tr></table></figure>
<p>避免CRC32产生大量冲突，可以使用FNV64()作为哈希函数</p>
<blockquote>
<p>FNV64() 移植自PerconaServer的函数，<br>可以以插件的方式在任何MySQL版本中使用</p>
</blockquote>
<h2 id="索引的优点"><a href="#索引的优点" class="headerlink" title="索引的优点"></a>索引的优点</h2><ul>
<li>大大减少的服务器需要扫描的数据量</li>
<li>帮助服务器避免排序和临时表</li>
<li>将随机IO变为顺序IO</li>
</ul>
<p>如何评价一个索引是否合适某个查询（三星系统）：</p>
<ul>
<li>索引将<code>相关记录放在一起</code>则获得一星；</li>
<li>索引中数据顺序和查找中的排列顺序一致 则获得二星；</li>
<li>索引中的列 包含了查询中需要的全部列 则获得三星；</li>
</ul>
<p>索引是最好的解决方案吗?<br>非常小的表，全表扫描更高效<br>中到大型表，索引非常有效<br>TB级别的数据，定位单条记录的意义不大，经常使用块级别元数据技术替代索引。</p>
<h2 id="高性能的索引策略"><a href="#高性能的索引策略" class="headerlink" title="高性能的索引策略"></a>高性能的索引策略</h2><h3 id="独立的列"><a href="#独立的列" class="headerlink" title="独立的列"></a>独立的列</h3><p>如果查询中的列不是独立的，则MySQL就不会使用索引。</p>
<p>“独立的列”指索引列不能是表达式的一部分，也不能是函数的参数。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- where TO_DAYS(create_data) = 'xxx'</span></div><div class="line"><span class="keyword">SELECT</span> actor_id	</div><div class="line"><span class="keyword">FROM</span> actor</div><div class="line"><span class="keyword">WHERE</span> actor_id + <span class="number">1</span> = <span class="number">5</span></div></pre></td></tr></table></figure>
<h3 id="前缀索引和索引选择性"><a href="#前缀索引和索引选择性" class="headerlink" title="前缀索引和索引选择性"></a>前缀索引和索引选择性</h3><p>索引很长的字符列，会让索引变得大且慢。</p>
<p>可索引开始的部分字符，以大大节约索引空间，从而提高索引效率。</p>
<p>对于blob、text或很长的varchar类型的列，必须使用前缀索引。</p>
<p>选择足够长的前缀以保证较高的选择性。</p>
<p>选择性：不重复的索引值和数据表的记录总数的比值。</p>
<p>使前缀选择性接近完整列选择性：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 计算完整列选择性</span></div><div class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">DISTINCT</span> city)/<span class="keyword">COUNT</span>(*) <span class="keyword">from</span> sakila.city_demo;</div><div class="line"></div><div class="line"><span class="comment">-- 计算前缀选择性</span></div><div class="line"><span class="keyword">select</span> <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">LEFT</span>(city, <span class="number">6</span>))/<span class="keyword">COUNT</span>(*) <span class="keyword">as</span> sel6,</div><div class="line"><span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">LEFT</span>(city, <span class="number">7</span>))/<span class="keyword">COUNT</span>(*) <span class="keyword">as</span> sel7</div><div class="line"><span class="keyword">from</span> sakila.city_demo;</div></pre></td></tr></table></figure>
<p>创建前缀索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">alert table sakila.city_demo ADD Key (city(7));</div></pre></td></tr></table></figure>
<blockquote>
<p>有时候后缀索引也有用途，如查找某个域名的所有电子邮件；<br>MySQL不支持反向索引，需把字符串反转后存储，并建立索引，可使用触发器实现。</p>
</blockquote>
<h3 id="多列索引"><a href="#多列索引" class="headerlink" title="多列索引"></a>多列索引</h3><p>在多个列上建立独立的单列索引大部分情况下并不能提高MySQL的查询性能。</p>
<p>MySQL5.0及更新版本引入了“索引合并”策略，<br>查询能够使用两个单列索引进行扫描，并将结果进行合并。</p>
<p>通过Explain的Extra列可以看到嵌套操作。</p>
<p>索引合并策略有时候是一种优化结果，<br>更多时候说明表上的索引建立的很糟糕。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 关闭索引合并优化</span></div><div class="line"><span class="keyword">set</span> <span class="keyword">global</span> optimizer_switch=<span class="string">"index_merge=off"</span></div><div class="line"></div><div class="line"><span class="comment">-- 禁止某个索引（force index(索引名或者主键PRI)）</span></div><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">ignore</span> <span class="keyword">index</span>(PRI) <span class="keyword">limit</span> <span class="number">2</span>;</div><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">ignore</span> <span class="keyword">index</span>(ziduan1_index) <span class="keyword">limit</span> <span class="number">2</span>;</div><div class="line"></div><div class="line"><span class="comment">-- 强制使用索引（force index(索引名或者主键PRI)）</span></div><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">force</span> <span class="keyword">index</span>(PRI) <span class="keyword">limit</span> <span class="number">2</span>;</div><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">force</span> <span class="keyword">index</span>(ziduan1_index) <span class="keyword">limit</span> <span class="number">2</span>;</div></pre></td></tr></table></figure>
<h3 id="选择合适的索引顺序"><a href="#选择合适的索引顺序" class="headerlink" title="选择合适的索引顺序"></a>选择合适的索引顺序</h3><p>当不需要考虑排序和分组时，将选择性最高的列放在最前面通常是很好的。</p>
<p>可能需要根据运行频率最高的查询来调整索引列的顺序，<br>让这种情况下索引的选择性最高。</p>
<h3 id="聚簇索引"><a href="#聚簇索引" class="headerlink" title="聚簇索引"></a>聚簇索引</h3><p>聚簇索引是一种数据存储方式。</p>
<p>InnoDB的聚簇索引实际上在<code>同一结构</code>中保存了B-Tree<code>索引</code>和<code>数据行</code>。</p>
<p>表有聚簇索引时，它的<code>数据行</code>实际上存放在索引的<code>叶子页</code>中。</p>
<p>InnoDB通过主键聚集数据，二级索引的叶子节点存储的不是“行指针”而是主键值。</p>
<h4 id="聚簇索引优点："><a href="#聚簇索引优点：" class="headerlink" title="聚簇索引优点："></a>聚簇索引优点：</h4><ul>
<li>可以把相关数据放在一起</li>
<li>数据访问更快（索引和数据保存在同一个B-Tree中）</li>
<li>覆盖索引扫描的查询可以直接使用叶子节点中的主键值</li>
</ul>
<h4 id="聚簇索引缺点："><a href="#聚簇索引缺点：" class="headerlink" title="聚簇索引缺点："></a>聚簇索引缺点：</h4><ul>
<li>插入速度严重依赖插入顺序</li>
<li>更新主键代价高（InnoDB会将每个被更新行移动到新位置）</li>
<li>插入新行或更新主键，可能面临“页分裂”问题</li>
<li>可能导致全表扫描变慢</li>
<li>二级索引可能较大（包含引用行主键）</li>
<li>二级索引访问需要两次索引查找</li>
</ul>
<h4 id="InnoDB表中按主键顺序插入行"><a href="#InnoDB表中按主键顺序插入行" class="headerlink" title="InnoDB表中按主键顺序插入行"></a>InnoDB表中按主键顺序插入行</h4><p>InnoDB按主键顺序插入数据速度最快。</p>
<p>使用auto_increment自增列可以保证数据行按顺序写入，<br>根据主键做关联操作性能也会更好。</p>
<p>InnoDB默认的填充因子为页大小的15/16，留出部分空间用于以后修改。</p>
<p>InnoDB应该尽可能按主键顺序插入数据，<br>并尽可能使用单调递增的主键插入新行。</p>
<h4 id="UUID聚簇索引缺点"><a href="#UUID聚簇索引缺点" class="headerlink" title="UUID聚簇索引缺点"></a>UUID聚簇索引缺点</h4><ul>
<li>写入的目标页可能不在缓存中，导致大量随机I/O</li>
<li>写入是乱序的，InnoDB频繁做页分裂操作，以便为新行分配空间（页分裂导致移动大量数据）</li>
<li>频繁页分裂，页会变得稀疏并不规则地填充，最终会有碎片</li>
</ul>
<p>从性能角度考虑，使用UUID作为聚簇索引会很糟糕（空间占用、页分裂、碎片）。<br>不按主键顺序插入数据，完成后最好使用optimize table命令重新组织一下表。</p>
<h3 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h3><p>一个索引包含所有需要查询的字段的值，称之为“覆盖索引”</p>
<p>由于InnoDB的聚簇索引，覆盖索引对InnnoDB表特别有用。<br>二级索引叶子节点保存行的主键，<br>如果二级索引能够覆盖查询，可以避免对主键索引的二次查询。</p>
<p>MySQL只能使用B-Tree索引做覆盖索引。</p>
<p>索引覆盖查询，在explain的extra列可以看到<code>Using Index</code>信息。</p>
<p>InnoDB二级索引叶子节点包含主键值，<br>二级索引可以有效地利用这些“额外”的主键来覆盖查询。</p>
<p>延迟关联：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> *</div><div class="line"><span class="keyword">from</span> products</div><div class="line"><span class="keyword">where</span> actor = <span class="string">'SEAN CARREY'</span></div><div class="line"><span class="keyword">AND</span> title <span class="keyword">like</span> <span class="string">'%APOLLO%'</span></div></pre></td></tr></table></figure>
<p>MySQL能在索引中做<code>最左前缀</code>匹配的LIKE比较（通配符开头LIKE不使用索引），<br>故该SQL只是用actor索引。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> *</div><div class="line"><span class="keyword">from</span> <span class="string">`products`</span></div><div class="line"><span class="keyword">JOIN</span>(</div><div class="line">	<span class="keyword">select</span> <span class="string">`prod_id`</span></div><div class="line">	<span class="keyword">from</span> <span class="string">`products`</span></div><div class="line">	<span class="string">`actor`</span> = <span class="string">'SEAN CARREY'</span> <span class="keyword">AND</span> <span class="string">`title`</span> <span class="keyword">like</span> <span class="string">'%APOLLO%'</span></div><div class="line">) <span class="keyword">as</span> t1 <span class="keyword">on</span> (t1.<span class="string">`prod_id`</span> = <span class="string">`products`</span>.<span class="string">`prod_id`</span>)</div></pre></td></tr></table></figure>
<p>子查询使用覆盖索引（actor、title、prod_id）执行like过滤，较少数据行访问</p>
<p>使用延迟关联优化limit分页：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="string">`cols`</span> <span class="keyword">from</span> <span class="keyword">profiles</span> <span class="keyword">JOIN</span>(</div><div class="line">	<span class="keyword">select</span> <span class="string">`primary_key`</span> <span class="keyword">from</span> <span class="keyword">profiles</span></div><div class="line">	<span class="keyword">where</span> <span class="string">`x`</span>.<span class="string">`sex`</span> = <span class="string">'M'</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> rating <span class="keyword">limit</span> <span class="number">10000</span>, <span class="number">10</span> </div><div class="line">) <span class="keyword">AS</span> <span class="string">`x`</span> <span class="keyword">USING</span>(<span class="string">'primary_key'</span>)</div></pre></td></tr></table></figure>
<h3 id="使用索引扫描来做排序"><a href="#使用索引扫描来做排序" class="headerlink" title="使用索引扫描来做排序"></a>使用索引扫描来做排序</h3><p>MySQL中两种方式生成有序结果：</p>
<ul>
<li>排序操作</li>
<li>按索引顺序扫描</li>
</ul>
<p>只有当索引的列顺序和ORDER BY子句的顺序<code>完全一致</code>，并且所有列的排序方向都一样时，<br>才能够使用索引来对结果做排序。</p>
<p>查询需要关联多张表，只有当ORDER BY子句引用的字段<code>全部为第一个表</code>时，才能使用索引做排序。</p>
<blockquote>
<p>索引列都是正序排序的</p>
</blockquote>
<h3 id="冗余和重复索引"><a href="#冗余和重复索引" class="headerlink" title="冗余和重复索引"></a>冗余和重复索引</h3><p>重复索引：<code>相同列</code>上按照<code>相同的顺序</code>创建的相同类型的索引。</p>
<p>应该避免创建重复索引，发现时也应该立即移除。</p>
<p>大多数情况下都不需要冗余索引，应该尽量扩展已有索引而不是创建新索引。</p>
<p>表中索引越多插入速度越慢。</p>
<h3 id="未使用的索引"><a href="#未使用的索引" class="headerlink" title="未使用的索引"></a>未使用的索引</h3><p>pt-index-usage分析查询日志，找出未使用的索引</p>
<h3 id="索引和锁"><a href="#索引和锁" class="headerlink" title="索引和锁"></a>索引和锁</h3><p>索引可以让查询锁定更少的行</p>
<p>InnoDB只有访问行时才会加锁，索引能减少InnoDB访问的行数</p>
<p>InnoDB在二级索引上使用共享锁，访问主键索引需要排他锁</p>
<h3 id="索引注意事项"><a href="#索引注意事项" class="headerlink" title="索引注意事项"></a>索引注意事项</h3><p>查询类型不一致，隐式类型转换，不走索引；</p>
<h2 id="索引案例学习"><a href="#索引案例学习" class="headerlink" title="索引案例学习"></a>索引案例学习</h2><h3 id="支持多种过滤条件"><a href="#支持多种过滤条件" class="headerlink" title="支持多种过滤条件"></a>支持多种过滤条件</h3><p>可以在索引中加入更多列，并通过IN()的方式覆盖那些不在WHERE子句中的列。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 通过添加覆盖所有值的in条件，以满足不跳过索引中列的条件</span></div><div class="line">where `sex` IN('M' , 'F')</div></pre></td></tr></table></figure>
<blockquote>
<p>IN()列很多时，会影响查询优化器效率</p>
</blockquote>
<h3 id="避免多个范围条件"><a href="#避免多个范围条件" class="headerlink" title="避免多个范围条件"></a>避免多个范围条件</h3><p>如：查询几周上线过的用户，可以事先计算好active列，并由定时任务维护。</p>
<h1 id="查询性能优化"><a href="#查询性能优化" class="headerlink" title="查询性能优化"></a>查询性能优化</h1><p>查询生命周期：<br>从客户端到服务器，在服务器上进行解析，生成执行计划，执行，并返回结果给客户端。</p>
<h2 id="慢查询基础：优化数据访问"><a href="#慢查询基础：优化数据访问" class="headerlink" title="慢查询基础：优化数据访问"></a>慢查询基础：优化数据访问</h2><h3 id="取出全部列"><a href="#取出全部列" class="headerlink" title="取出全部列"></a>取出全部列</h3><p>使用<code>select *</code>时需确认是否真的需要全部列</p>
<p>如果程序使用某种缓存机制，获取超过需要的数据可能有其好处。</p>
<h3 id="是否在扫描额外的记录"><a href="#是否在扫描额外的记录" class="headerlink" title="是否在扫描额外的记录"></a>是否在扫描额外的记录</h3><p>衡量查询开销的三个指标：</p>
<ul>
<li>响应时间</li>
<li>扫描的行数</li>
<li>返回的行数</li>
</ul>
<p>MySQL应用where条件的三种方式，从好到坏依次是：</p>
<ul>
<li>索引中使用where条件过滤不匹配元素</li>
<li>覆盖索引扫描返回记录，然后过滤（Extra，Using index）</li>
<li>从数据表返回数据，然后过滤（Extra，Using where）</li>
</ul>
<h2 id="重构查询的方式"><a href="#重构查询的方式" class="headerlink" title="重构查询的方式"></a>重构查询的方式</h2><h3 id="切分查询"><a href="#切分查询" class="headerlink" title="切分查询"></a>切分查询</h3><p>定期清除大量数据：一次删除1w行一般来说是比较高效而且对服务器影响较小的做法。</p>
<p>每次删除数据后，暂停一会儿，可将原本一次性的压力分散到一个很长的时间段中。</p>
<h3 id="分解关联查询"><a href="#分解关联查询" class="headerlink" title="分解关联查询"></a>分解关联查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`tag`</span></div><div class="line">	<span class="keyword">JOIN</span> <span class="string">`tag_post`</span> <span class="keyword">ON</span> <span class="string">`tag_post`</span>.<span class="string">`tag_id`</span> = <span class="string">`tag`</span>.<span class="string">`id`</span></div><div class="line">	<span class="keyword">JOIN</span> <span class="string">`post`</span> <span class="keyword">ON</span> <span class="string">`tag_post`</span>.<span class="string">`id`</span> = <span class="string">`post`</span>.<span class="string">`id`</span></div><div class="line"><span class="keyword">Where</span> <span class="string">`tag`</span>.<span class="string">`tag`</span> = <span class="string">'mysql'</span></div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="string">`tag`</span> <span class="keyword">where</span> <span class="string">`tag`</span> = <span class="string">'mysql'</span>;</div><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="string">`tag_post`</span> <span class="keyword">where</span> <span class="string">`tag_id`</span> = <span class="string">'1234'</span>;</div><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="string">`post`</span> <span class="keyword">where</span> <span class="string">`post`</span>.<span class="string">`id`</span> <span class="keyword">in</span> (<span class="number">123</span>, <span class="number">356</span>, <span class="number">567</span>, <span class="number">9098</span>, <span class="number">8904</span>);</div></pre></td></tr></table></figure>
<p><code>分解关联查询</code>优势：</p>
<ul>
<li>让缓存更高效（许多应用可以方便地缓存<code>单表查询</code>的结果对象）</li>
<li>分解后，执行单个查询减少锁竞争</li>
<li>在应用层做关联，容易对数据库进行拆分</li>
<li>相当于在应用中实现哈希关联</li>
</ul>
<p>应用场景：</p>
<ul>
<li>能够方便缓存单个查询结果时</li>
<li>可以将数据分布到不同MySQL服务器上时</li>
<li>能够使用IN()替换关联查询时</li>
<li>使用同一数据表时</li>
</ul>
<h2 id="查询执行的基础"><a href="#查询执行的基础" class="headerlink" title="查询执行的基础"></a>查询执行的基础</h2><h3 id="MySQL客户端-服务器通信协议"><a href="#MySQL客户端-服务器通信协议" class="headerlink" title="MySQL客户端/服务器通信协议"></a>MySQL客户端/服务器通信协议</h3><p>通信协议是<code>半双工</code>的:要么服务器向客户端发送数据，要么客户端向服务器发送数据。</p>
<p>客户端用一个<code>单独的</code>数据包将查询传递给服务器。<br>查询语句很长时，参数<code>max_allowed_packet</code>就特别重要了。</p>
<p>服务器响应给客户的数据通常很多，由<code>多个数据包</code>组成。<br>服务器开始响应客户端请求时，客户端必须完整地接收整个返回结果，而不能简单的只取前几条结果。</p>
<p>客户端从服务器取数据时，实际上是MySQL向客户端<code>推送</code>数据的过程。</p>
<h3 id="查询优化器"><a href="#查询优化器" class="headerlink" title="查询优化器"></a>查询优化器</h3><p>优化器将合法的语法树，转化成执行计划。</p>
<p>一条查询可以有很<code>多种执行方式</code>，最后返回相同结果。优化器的作用是找到其中最好的执行计划。</p>
<p>查询当前会话的<code>last_query_cost</code>，得知MySQL计算的当前查询的成本</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> SQL_NO_CACHE <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> <span class="string">`person`</span></div><div class="line"></div><div class="line"><span class="keyword">SHOW</span> <span class="keyword">STATUS</span> <span class="keyword">LIKE</span> <span class="string">'last_query_cost'</span></div></pre></td></tr></table></figure>
<p>MySQL如何执行关联查询：<code>嵌套循环关联</code><br>MySQL先在一个表中循环取出单条数据，然后再嵌套循环到下一个表中寻找匹配的行，<br>以此下去，直到找到所有表中匹配的行为止。<br>然后根据各个表匹配的行，返回查询中所需要的各个列。</p>
<h3 id="排序优化"><a href="#排序优化" class="headerlink" title="排序优化"></a>排序优化</h3><p>MySQL中两种排序算法：</p>
<p>两次传输排序（旧版本使用）：<br>读取行指针和需要排序的字段，对其进行排序，然后再根据排序后的结果读取所需要的数据行。</p>
<p>单次传输排序（新版本使用）：<br>先读取查询所需的所有列，然后再根据给定的列进行排序，最后直接返回排序结果。</p>
<p>当查询需要所有列的总长度不超过参数<code>max_length_for_sort_data</code>,MySQL则使用<code>单次传输排序</code></p>
<p>MySQL进行文件排序时需要使用的<code>临时存储空间</code>可能<code>比想象的要大得多</code>。<br>MySQL在排序时，对每一个排序记录都会分配一个足够长的<code>定长空间</code>来存放，<br>这个定长空间必须足够长以容纳其中<code>最长</code>的字符串。</p>
<p>MySQL中分两种情况处理关联查询文件排序：<br>ORDER BY子句中所有列都来自关联的第一个表，关联处理第一个表的时候进行文件排序（Extra，Using filesort）。</p>
<p>除此之外的所有情况，MySQL先将关联的结果存放到一个临时表，再进行文件排序（Extra，Using temporary；Using filesort）。</p>
<h2 id="MySQL查询优化器的局限性"><a href="#MySQL查询优化器的局限性" class="headerlink" title="MySQL查询优化器的局限性"></a>MySQL查询优化器的局限性</h2><h3 id="关联子查询"><a href="#关联子查询" class="headerlink" title="关联子查询"></a>关联子查询</h3><h4 id="最糟糕的一类查询是WHERE条件中包含IN-的子查询语句"><a href="#最糟糕的一类查询是WHERE条件中包含IN-的子查询语句" class="headerlink" title="最糟糕的一类查询是WHERE条件中包含IN()的子查询语句"></a>最糟糕的一类查询是WHERE条件中包含IN()的子查询语句</h4><p><code>《高性能MySQL第3版》示例，MySQL5.6.26、5.7.11实验未复现</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="string">`film`</span>.* <span class="keyword">FROM</span> <span class="string">`sakila`</span>.<span class="string">`film`</span></div><div class="line"><span class="keyword">WHERE</span> <span class="string">`film_id`</span> <span class="keyword">IN</span> (</div><div class="line">  <span class="keyword">SELECT</span> <span class="string">`film_id`</span> <span class="keyword">FROM</span> <span class="string">`sakila`</span>.<span class="string">`film_actor`</span> <span class="keyword">WHERE</span> <span class="string">`actor_id`</span> = <span class="number">1</span>)</div></pre></td></tr></table></figure>
<p>IN子查询会被MySQL改写，且因为第二个子查询使用第一个查询film_id，导致第一个表全扫描</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="string">`film`</span>.* <span class="keyword">FROM</span> <span class="string">`sakila`</span>.<span class="string">`film`</span></div><div class="line"><span class="keyword">WHERE</span> <span class="keyword">EXISTS</span> (</div><div class="line">  <span class="keyword">SELECT</span> <span class="string">`film_id`</span> <span class="keyword">FROM</span> <span class="string">`sakila`</span>.<span class="string">`film_actor`</span> <span class="keyword">WHERE</span> <span class="string">`actor_id`</span> = <span class="number">1</span></div><div class="line">  <span class="keyword">AND</span> <span class="string">`film`</span>.<span class="string">`film_id`</span> = <span class="string">`film_actor`</span>.<span class="string">`film_id`</span>)</div></pre></td></tr></table></figure>
<p>优化方式1（内连接）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="string">`film`</span>.*</div><div class="line"><span class="keyword">FROM</span> <span class="string">`sakila`</span>.<span class="string">`film`</span></div><div class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> <span class="string">`sakila`</span>.<span class="string">`film_actor`</span> <span class="keyword">USING</span>(film_id)</div><div class="line"><span class="keyword">WHERE</span> actor_id = <span class="number">1</span>;</div></pre></td></tr></table></figure>
<p>优化方式2（GROUP_CONCAT）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`sakila`</span>.<span class="string">`film`</span></div><div class="line"><span class="keyword">WHERE</span> FIND_IN_SET(<span class="string">`film_id`</span>,</div><div class="line">  (<span class="keyword">SELECT</span> <span class="keyword">GROUP_CONCAT</span>(<span class="string">`film_id`</span>) <span class="keyword">FROM</span> <span class="string">`sakila`</span>.<span class="string">`film_actor`</span> <span class="keyword">WHERE</span> <span class="string">`actor_id`</span> = <span class="number">1</span>))</div></pre></td></tr></table></figure>
<h4 id="如何用好关联子查询"><a href="#如何用好关联子查询" class="headerlink" title="如何用好关联子查询"></a>如何用好关联子查询</h4><p>如果有人跟你说：“别用关联子查询”，那么不要理他。<br>先测试，然后做出自己的判断。</p>
<p>很多时候，关联子查询是一种非常合理、自然，甚至性能最好的写法。</p>
<p>查询有演员的电影：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span></div><div class="line">  <span class="keyword">DISTINCT</span> <span class="string">`film`</span>.<span class="string">`film_id`</span></div><div class="line"><span class="keyword">FROM</span></div><div class="line">  <span class="string">`sakila`</span>.<span class="string">`film`</span></div><div class="line">  <span class="keyword">INNER</span> <span class="keyword">JOIN</span> <span class="string">`sakila`</span>.<span class="string">`film_actor`</span> <span class="keyword">USING</span> (<span class="string">`film_id`</span>)</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span></div><div class="line">  <span class="string">`film`</span>.<span class="string">`film_id`</span></div><div class="line"><span class="keyword">FROM</span></div><div class="line">  <span class="string">`sakila`</span>.<span class="string">`film`</span></div><div class="line"><span class="keyword">WHERE</span> <span class="keyword">EXISTS</span>(</div><div class="line">   <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`sakila`</span>.<span class="string">`film_actor`</span> <span class="keyword">WHERE</span> <span class="string">`film_actor`</span>.<span class="string">`film_id`</span> = <span class="string">`film`</span>.<span class="string">`film_id`</span></div><div class="line">)</div></pre></td></tr></table></figure>
<blockquote>
<p>《高性能MySQL第3版》介绍，关联子查询效率更高；EXPLAIN显示第一个查询用到了临时表</p>
</blockquote>
<ul>
<li>不需要听取那些关于子查询的<code>“绝对真理”</code></li>
<li>应该用<code>测试验证</code>对子查询的执行计划和响应时间的假设</li>
</ul>
<h3 id="同一个表上同时查询和更新"><a href="#同一个表上同时查询和更新" class="headerlink" title="同一个表上同时查询和更新"></a>同一个表上同时查询和更新</h3><p>MySQL不允许对同一张表同时进行查询和更新。</p>
<p>可使用<code>生成表</code>的形势绕过该限制。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">update</span> tb1</div><div class="line">	<span class="keyword">inner</span> <span class="keyword">join</span> (</div><div class="line">		<span class="keyword">select</span> <span class="string">`type`</span>, <span class="keyword">count</span>(*) <span class="keyword">AS</span> <span class="keyword">count</span></div><div class="line">		<span class="keyword">from</span> <span class="string">`tb1`</span></div><div class="line">		<span class="keyword">group</span> <span class="keyword">by</span> <span class="string">`type`</span>) <span class="keyword">as</span> <span class="string">`der`</span> <span class="keyword">using</span>(<span class="string">`type`</span>)</div><div class="line"><span class="keyword">set</span> <span class="string">`tb1`</span>.<span class="string">`cnt`</span> = <span class="string">`der`</span>.<span class="string">`cnt`</span>;</div></pre></td></tr></table></figure>
<p>执行了2个查询：</p>
<ul>
<li>子查询中SELECT语句</li>
<li>多表关联UPDATE，关联的表时临时表</li>
</ul>
<h2 id="优化特定类型的查询"><a href="#优化特定类型的查询" class="headerlink" title="优化特定类型的查询"></a>优化特定类型的查询</h2><h3 id="优化COUNT-查询"><a href="#优化COUNT-查询" class="headerlink" title="优化COUNT()查询"></a>优化COUNT()查询</h3><p>COUNT()的作用：</p>
<ul>
<li>统计某列值的数量</li>
<li>统计行数</li>
</ul>
<p>统计列值时，要求列值<code>是非空的</code>（不统计NULL）</p>
<p>COUNT(*) 会忽略所有列的值，直接统计所有的行数</p>
<p>统计颜色数量：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 1.使用sum()</span></div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">SUM</span>(<span class="keyword">IF</span>(<span class="string">`color`</span> = <span class="string">'blue'</span>, <span class="number">1</span>, <span class="number">0</span>)) <span class="keyword">AS</span> <span class="string">`blue`</span>, <span class="keyword">SUM</span>(<span class="keyword">IF</span>(<span class="string">`color`</span> = <span class="string">'red'</span>, <span class="number">1</span>, <span class="number">0</span>)) <span class="keyword">AS</span> <span class="string">`red`</span></div><div class="line"><span class="keyword">FROM</span> <span class="string">`items`</span></div><div class="line"></div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">SUM</span>(<span class="string">`color`</span> = <span class="string">'blue'</span>) <span class="keyword">AS</span> <span class="string">`blue`</span>, <span class="keyword">SUM</span>(<span class="string">`color`</span> = <span class="string">'red'</span>) <span class="keyword">AS</span> <span class="string">`red`</span></div><div class="line"><span class="keyword">FROM</span> <span class="string">`items`</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">-- 2.使用count()</span></div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="string">`color`</span> = <span class="string">'blue'</span> <span class="keyword">OR</span> <span class="literal">NULL</span>), <span class="keyword">COUNT</span>(<span class="string">`color`</span> = <span class="string">'red'</span> <span class="keyword">OR</span> <span class="literal">NULL</span>)</div><div class="line"><span class="keyword">FROM</span> <span class="string">`items`</span></div></pre></td></tr></table></figure>
<h3 id="优化关联查询"><a href="#优化关联查询" class="headerlink" title="优化关联查询"></a>优化关联查询</h3><ul>
<li>确保on或者using子句中的列上有索引（一般只需关联顺序中<code>第二个表</code>相应列上创建索引）</li>
<li>确保任何group by和order by表达式只涉及一个表中的列（这样才能使用索引优化）</li>
</ul>
<h3 id="优化子查询"><a href="#优化子查询" class="headerlink" title="优化子查询"></a>优化子查询</h3><p>建议: 尽可能使用关联查询替代。</p>
<p>子查询需要创建和填充<code>临时表</code>，而子查询中创建的临时表是<code>没有任何索引</code>的。</p>
<h3 id="优化group-by-和-distinct"><a href="#优化group-by-和-distinct" class="headerlink" title="优化group by 和 distinct"></a>优化group by 和 distinct</h3><p>采用查找表的<code>标识列</code>分组的效率会比其他列更高。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="string">`actor`</span>.<span class="string">`first_name`</span>,<span class="string">`actor`</span>.<span class="string">`last_name`</span>,<span class="keyword">COUNT</span>(*)</div><div class="line"><span class="keyword">FROM</span> <span class="string">`film_actor`</span></div><div class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> <span class="string">`actor`</span> <span class="keyword">USING</span>(<span class="string">`actor_id`</span>)</div><div class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="string">`actor`</span>.<span class="string">`first_name`</span>,<span class="string">`actor`</span>.<span class="string">`last_name`</span></div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="string">`actor`</span>.<span class="string">`first_name`</span>,<span class="string">`actor`</span>.<span class="string">`last_name`</span></div><div class="line"><span class="keyword">FROM</span> <span class="string">`actor`</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</div><div class="line">   <span class="keyword">SELECT</span> <span class="string">`actor_id`</span>,<span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> <span class="string">`cnt`</span> <span class="keyword">FROM</span> <span class="string">`film_actor`</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="string">`actor_id`</span></div><div class="line">)<span class="keyword">AS</span> <span class="string">`t2`</span> <span class="keyword">USING</span>(<span class="string">`actor_id`</span>)</div></pre></td></tr></table></figure>
<p>分组查询的select中直接使用<code>非分组列</code>通常都不是什么好主意，<br>因为这样的结果通常是<code>不确定的</code>。</p>
<p>建议将MySQL的SQL_MODE设置为：<code>ONLY_FULL_GROUP_BY</code></p>
<p>使用group by子句时，若<code>无</code>order by子句，结果会按分组字段排序；<br>可在group by子句中使用desc或asc；<br>可使用order by null，不再进行排序；</p>
<h3 id="优化LIMIT分页"><a href="#优化LIMIT分页" class="headerlink" title="优化LIMIT分页"></a>优化LIMIT分页</h3><p>方式1：使用覆盖索引扫描，然后关联操作返回所需列。（延迟关联）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="string">`cols`</span> <span class="keyword">from</span> <span class="keyword">profiles</span> <span class="keyword">JOIN</span>(</div><div class="line">	<span class="keyword">select</span> <span class="string">`primary_key`</span> <span class="keyword">from</span> <span class="keyword">profiles</span></div><div class="line">	<span class="keyword">where</span> <span class="string">`x`</span>.<span class="string">`sex`</span> = <span class="string">'M'</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> rating <span class="keyword">limit</span> <span class="number">10000</span>, <span class="number">10</span> </div><div class="line">) <span class="keyword">AS</span> <span class="string">`x`</span> <span class="keyword">USING</span>(<span class="string">'primary_key'</span>)</div></pre></td></tr></table></figure>
<p>方式2：存储排名</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="string">`film_id`</span>,<span class="string">`description`</span></div><div class="line"><span class="keyword">FROM</span> <span class="string">`sakila`</span>.<span class="string">`film`</span></div><div class="line"><span class="keyword">WHERE</span> <span class="string">`position`</span> <span class="keyword">BETWEEN</span> <span class="number">50</span> <span class="keyword">AND</span> <span class="number">54</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`position`</span></div></pre></td></tr></table></figure>
<h3 id="优化union查询"><a href="#优化union查询" class="headerlink" title="优化union查询"></a>优化union查询</h3><p>MySQL<code>总是</code>通过创建并填充<code>临时表</code>的方式来执行UNION查询。</p>
<p>除非确实需要服务器消除重复行，否则一定要使用<code>union all</code>。</p>
<p>如果没有ALL关键字，MySQL会给临时表加上distinct，导致临时表的数据做唯一性检查。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> aid,title <span class="keyword">FROM</span> article </div><div class="line"><span class="keyword">UNION</span> ALL </div><div class="line"><span class="keyword">SELECT</span> bid,title <span class="keyword">FROM</span> blog</div></pre></td></tr></table></figure>
<h3 id="静态查询分析"><a href="#静态查询分析" class="headerlink" title="静态查询分析"></a>静态查询分析</h3><p>pt-query-advisor分析查询日志、分析查询模式，<br>然后给出所有可能存在潜在问题的查询，并给出足够详细的建议。</p>
<h3 id="使用用户自定义变量"><a href="#使用用户自定义变量" class="headerlink" title="使用用户自定义变量"></a>使用用户自定义变量</h3><p>用户自定义变量是一个用来存储内容的<code>临时容器</code>，在连接MySQL的整个过程中都存在。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SET</span> @min_actor := (<span class="keyword">SELECT</span> <span class="keyword">MIN</span>(<span class="string">`actor_id`</span>) <span class="keyword">FROM</span> <span class="string">`actor`</span>);</div></pre></td></tr></table></figure>
<p>避免重复查询刚刚更新的数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">UPDATE</span> <span class="string">`person`</span> <span class="keyword">SET</span> <span class="string">`last_update`</span> = <span class="keyword">NOW</span>() <span class="keyword">WHERE</span> <span class="string">`id`</span> = <span class="string">'4'</span> <span class="keyword">AND</span> @tmp_name := <span class="keyword">NOW</span>();</div><div class="line"><span class="comment">-- 查询用户自定义变量，不用查询任何数据表，速度很快</span></div><div class="line"><span class="keyword">SELECT</span> @tmp_name;</div></pre></td></tr></table></figure>
<h1 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h1><h2 id="查看建表语句"><a href="#查看建表语句" class="headerlink" title="查看建表语句"></a>查看建表语句</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 查看数据库表</span></div><div class="line"><span class="keyword">show</span> <span class="keyword">tables</span>;</div><div class="line"><span class="comment">-- 查看建表语句</span></div><div class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> &lt;table_neme&gt;</div></pre></td></tr></table></figure>
<h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><h2 id="ROUND"><a href="#ROUND" class="headerlink" title="ROUND()"></a>ROUND()</h2><p>四舍五入</p>
<h2 id="时间"><a href="#时间" class="headerlink" title="时间"></a>时间</h2><table>
<thead>
<tr>
<th>函数</th>
<th>结果</th>
</tr>
</thead>
<tbody>
<tr>
<td>NOW()</td>
<td>2008-12-29 16:25:46</td>
</tr>
<tr>
<td>CURDATE()</td>
<td>2008-12-29</td>
</tr>
<tr>
<td>CURTIME()</td>
<td>16:25:46</td>
</tr>
</tbody>
</table>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ts_e = ROUND(UNIX_TIMESTAMP(CURTIME(4)) * 1000)</div></pre></td></tr></table></figure>
<h2 id="时间计算"><a href="#时间计算" class="headerlink" title="时间计算"></a>时间计算</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> (<span class="keyword">NOW</span>()-<span class="built_in">INTERVAL</span> <span class="number">10</span> <span class="keyword">MINUTE</span>)</div></pre></td></tr></table></figure>
<h2 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h2><h3 id="建表添加分区"><a href="#建表添加分区" class="headerlink" title="建表添加分区"></a>建表添加分区</h3><p>分区字段与Id作联合主键</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`waybill_sync_task`</span> (</div><div class="line">  <span class="string">`SYNC_TASK_ID`</span> <span class="built_in">BIGINT</span> (<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">  <span class="string">`WAYBILL_CODE`</span> <span class="built_in">VARCHAR</span> (<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`OPERATE_TYPE`</span> <span class="built_in">INT</span> (<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`TASK_DATA`</span> <span class="built_in">VARCHAR</span> (<span class="number">4096</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`TASK_EXE_COUNT`</span> <span class="built_in">INT</span> (<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`STATUS`</span> <span class="built_in">INT</span> (<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`CREATE_TIME`</span> DATETIME <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0000-00-00 00:00:00'</span>,</div><div class="line">  <span class="string">`UPDATE_TIME`</span> DATETIME <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`REMARK`</span> <span class="built_in">VARCHAR</span> (<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`YN`</span> <span class="built_in">INT</span> (<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`FROM_METHOD`</span> <span class="built_in">VARCHAR</span> (<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`UNIQUE_HASHCODE`</span> <span class="built_in">VARCHAR</span> (<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`QUEUE_ID`</span> <span class="built_in">VARCHAR</span> (<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'??????'</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`SYNC_TASK_ID`</span>, <span class="string">`CREATE_TIME`</span>),</div><div class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`UNQ_WAYBILL_SYNC_TASK_HCODE`</span> (</div><div class="line">    <span class="string">`UNIQUE_HASHCODE`</span>,</div><div class="line">    <span class="string">`CREATE_TIME`</span></div><div class="line">  ),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`IND_WAYBILL_SYNC_TASK_STATUS`</span> (<span class="string">`STATUS`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`idx_qid_sta`</span> (<span class="string">`QUEUE_ID`</span>, <span class="string">`STATUS`</span>)</div><div class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">INNODB</span> AUTO_INCREMENT = <span class="number">18566180</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8 <span class="comment">/*!50500 PARTITION BY RANGE COLUMNS(CREATE_TIME) (</span></div><div class="line"> PARTITION P201705 VALUES LESS THAN ('2017-06-01 00:00:00') ENGINE = InnoDB,</div><div class="line"> PARTITION P201706 VALUES LESS THAN ('2017-07-01 00:00:00') ENGINE = InnoDB,</div><div class="line"> PARTITION P201707 VALUES LESS THAN ('2017-08-01 00:00:00') ENGINE = InnoDB,</div><div class="line"> PARTITION P201708 VALUES LESS THAN ('2017-09-01 00:00:00') ENGINE = InnoDB,</div><div class="line"> PARTITION P201709 VALUES LESS THAN ('2017-10-01 00:00:00') ENGINE = InnoDB,</div><div class="line"> PARTITION P201710 VALUES LESS THAN ('2017-11-01 00:00:00') ENGINE = InnoDB,</div><div class="line"> PARTITION P201711 VALUES LESS THAN ('2017-12-01 00:00:00') ENGINE = InnoDB,</div><div class="line"> PARTITION P201712 VALUES LESS THAN ('2018-01-01 00:00:00') ENGINE = InnoDB)*/;</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`pickup_goods_0`</span> (</div><div class="line">  <span class="string">`PICKUP_GOOD_ID`</span> <span class="built_in">BIGINT</span> (<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`PICKUP_CODE`</span> <span class="built_in">VARCHAR</span> (<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'取件单编码'</span>,</div><div class="line">  <span class="string">`PRODUCT_NAME`</span> <span class="built_in">VARCHAR</span> (<span class="number">2000</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`PRODUCT_COUNT`</span> <span class="built_in">INT</span> (<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品数量'</span>,</div><div class="line">  <span class="string">`PRODUCT_SOURCE`</span> <span class="built_in">INT</span> (<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品来源 1为京东、2为千寻、3为好药师、4为奢侈品360Top'''</span>,</div><div class="line">  <span class="string">`PRODUCT_TYPE`</span> <span class="built_in">INT</span> (<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品类型 1-普通商品、2-大家电商品、3-奢侈品商品、4-为合约订单商品、5-发票商品名称为发票号、6-发票复印件商品名称为发票号、7-外包装、8-检测报告、9-附件明细商品名称为附件明细'</span>,</div><div class="line">  <span class="string">`PRODUCT_WEIGHT`</span> <span class="keyword">DOUBLE</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品重量'</span>,</div><div class="line">  <span class="string">`PRODUCT_VOLUME`</span> <span class="keyword">DOUBLE</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品体积'</span>,</div><div class="line">  <span class="string">`REMARK`</span> <span class="built_in">VARCHAR</span> (<span class="number">400</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`CREATE_TIME`</span> <span class="keyword">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0000-00-00 00:00:00'</span>,</div><div class="line">  <span class="string">`YN`</span> <span class="built_in">INT</span> (<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`SKU`</span> <span class="built_in">VARCHAR</span> (<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'取件单商品编号'</span>,</div><div class="line">  <span class="string">`UPDATE_TIME`</span> <span class="keyword">TIMESTAMP</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</div><div class="line">  <span class="string">`PRODUCT_ATTRIBUTE`</span> <span class="built_in">VARCHAR</span> (<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品属性名'</span>,</div><div class="line">  <span class="string">`HALF_RECEIVE_REASON`</span> <span class="built_in">INT</span> (<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'半收原因 1：少货2：错货3：破损4：临保5：包装破损6：内物破损'</span>,</div><div class="line">  <span class="string">`serial_no`</span> <span class="built_in">VARCHAR</span> (<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'SN或69码'</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`PICKUP_GOOD_ID`</span>, <span class="string">`CREATE_TIME`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`PICKUP_CODE`</span> (<span class="string">`PICKUP_CODE`</span>)</div><div class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">INNODB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8 <span class="comment">/*!50100 PARTITION BY RANGE ( UNIX_TIMESTAMP(CREATE_TIME)) (</span></div><div class="line"> PARTITION p201601 VALUES LESS THAN (1451577600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201602 VALUES LESS THAN (1454169600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201603 VALUES LESS THAN (1456761600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201604 VALUES LESS THAN (1459353600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201605 VALUES LESS THAN (1461945600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201606 VALUES LESS THAN (1464537600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201607 VALUES LESS THAN (1467129600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201608 VALUES LESS THAN (1469721600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201609 VALUES LESS THAN (1472313600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201610 VALUES LESS THAN (1474905600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201611 VALUES LESS THAN (1477497600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201612 VALUES LESS THAN (1480089600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201701 VALUES LESS THAN (1482681600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201702 VALUES LESS THAN (1485273600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201703 VALUES LESS THAN (1487865600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201704 VALUES LESS THAN (1490457600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201705 VALUES LESS THAN (1493049600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201706 VALUES LESS THAN (1495641600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201707 VALUES LESS THAN (1498233600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201708 VALUES LESS THAN (1500825600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201709 VALUES LESS THAN (1503417600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201710 VALUES LESS THAN (1506009600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201711 VALUES LESS THAN (1508601600) ENGINE = InnoDB,</div><div class="line"> PARTITION p201712 VALUES LESS THAN (1511193600) ENGINE = InnoDB)*/;</div></pre></td></tr></table></figure>
<h3 id="添加分区"><a href="#添加分区" class="headerlink" title="添加分区"></a>添加分区</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 原分区将被覆盖更新</span></div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`waybill_c_0`</span> <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span>(<span class="keyword">UNIX_TIMESTAMP</span>(CREATE_TIME))</div><div class="line">(<span class="keyword">PARTITION</span> p201701 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1485878400</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201702 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1488297600</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201703 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1490976000</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201704 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1493568000</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201705 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1496246400</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201706 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1498838400</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201707 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1501516800</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201708 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1504195200</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201709 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1506787200</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201710 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1509465600</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201711 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1512057600</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201712 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1514736000</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201801 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1517414400</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201802 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1519833600</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201803 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1522512000</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201804 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1525104000</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201805 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1527782400</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201806 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1530374400</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201807 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1533052800</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201808 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1535731200</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201809 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1538323200</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201810 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1541001600</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201811 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1543593600</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>,</div><div class="line"> <span class="keyword">PARTITION</span> p201812 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1546272000</span>) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>);</div><div class="line"></div><div class="line"><span class="comment">-- 添加分区</span></div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`waybill_extend_0`</span></div><div class="line">	<span class="keyword">ADD</span> <span class="keyword">PARTITION</span> (</div><div class="line">		<span class="keyword">PARTITION</span> p201801 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1517414400</span>),</div><div class="line">		<span class="keyword">PARTITION</span> p201802 <span class="keyword">VALUES</span> <span class="keyword">LESS</span> <span class="keyword">THAN</span> (<span class="number">1519833600</span>));</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">alter</span> <span class="keyword">table</span> waybill_extend_0 <span class="keyword">drop</span> <span class="keyword">partition</span> p201801</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">-- 查询分区数据量</span></div><div class="line"><span class="keyword">SELECT</span> PARTITION_NAME,TABLE_ROWS</div><div class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.PARTITIONS</div><div class="line"><span class="keyword">WHERE</span> TABLE_NAME = <span class="string">'common_task_mq'</span>;</div><div class="line"></div><div class="line"><span class="comment">-- 表information_schema</span></div><div class="line"><span class="comment">-- 对InnoDB表统计信息持久化时，表的row发生变化大于10%(counter &gt; n_rows / 10 /* 10%)并且innodb_stats_auto_recalc=on，统计信信息会更新</span></div><div class="line"><span class="keyword">SELECT</span> TABLE_SCHEMA,TABLE_NAME,PARTITION_NAME,PARTITION_DESCRIPTION,TABLE_ROWS</div><div class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.PARTITIONS</div><div class="line"><span class="keyword">WHERE</span> TABLE_NAME = <span class="string">'waybill_c'</span> <span class="keyword">AND</span> TABLE_SCHEMA = <span class="string">'wmdb'</span>;</div></pre></td></tr></table></figure>
<p>information_schema.partitions中数据项<br>TABLE_SCHEMA  库名<br>TABLE_NAME  表名<br>PARTITION_NAME  分区名<br>PARTITION_DESCRIPTION 分区范围的值<br>TABLE_ROWS  分区上数据行数</p>
<h3 id="无分区表添加分区"><a href="#无分区表添加分区" class="headerlink" title="无分区表添加分区"></a>无分区表添加分区</h3><p>如果想在已经建好的表上进行分区，如果使用alter添加分区的话，mysql会提示错误：<br>ERROR 1505 <hy000> Partition management on a not partitioned table is not possible<br>正确的方法是新建一个具有分区的表，结构一致，然后用insert into 分区表 select * from 原始表</hy000></p>
<h2 id="执行脚本文件"><a href="#执行脚本文件" class="headerlink" title="执行脚本文件"></a>执行脚本文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql -h10.10.10.10 -P3306 -uroot -p123456 yourdatabase &lt; text_file &gt; out_file</div><div class="line"></div><div class="line">mysql -uroot -p123456 -P3306 -Ne <span class="string">"show create table `waybill_0`.`waybill_c_0`"</span> &gt; d:\a.txt</div></pre></td></tr></table></figure>
<h2 id="导出数据库建表语句"><a href="#导出数据库建表语句" class="headerlink" title="导出数据库建表语句"></a>导出数据库建表语句</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mysqldump -h192.168.137.155 -uroot -p123456 waybill_10 &gt; d:\waybill_10.sql</div><div class="line">mysqldump -h192.168.137.155 -uroot -p123456 --databases db1 db2 db3 &gt; d:\dump.sql</div><div class="line"></div><div class="line"><span class="comment"># --skip-add-locks Do not add locks</span></div><div class="line"><span class="comment"># --no-data Do not dump table contents</span></div><div class="line">mysqldump -h192.168.137.155 -uroot -p123456 --skip-add-locks --no-data waybill_10 &gt; d:\waybill_10.sql</div><div class="line">mysqldump -h192.168.137.155 -uroot -p123456 --port 3306 --skip-add-locks --no-data waybill_10 &gt; d:\waybill_10.sql</div><div class="line"></div><div class="line">mysqldump -h127.0.0.1 -uroot -p123456 --port 3307 --skip-add-locks --no-data --databases waybill_0 waybill_1 waybill_2 waybill_3 &gt; d:\waybill_1-4.sql</div></pre></td></tr></table></figure>
<h2 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; drop database &lt;db_name&gt;;</div></pre></td></tr></table></figure>
<h2 id="事务验证"><a href="#事务验证" class="headerlink" title="事务验证"></a>事务验证</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">set</span> autocommit=0;</div><div class="line">begin;</div><div class="line"></div><div class="line">delete from `<span class="built_in">test</span>`.`num` <span class="built_in">where</span> number = <span class="string">'2'</span>;</div><div class="line">delete from `<span class="built_in">test</span>`.`num` <span class="built_in">where</span> number = <span class="string">'3'</span>;</div><div class="line"></div><div class="line">INSERT INTO `<span class="built_in">test</span>`.`num` (`number`, `content`) VALUES (<span class="string">'2'</span>, <span class="string">'content'</span>);</div><div class="line">INSERT INTO `<span class="built_in">test</span>`.`num` (`number`, `content`) VALUES (<span class="string">'3'</span>, <span class="string">'content'</span>);</div><div class="line"></div><div class="line">commit;</div></pre></td></tr></table></figure>
<h2 id="查看数据库版本"><a href="#查看数据库版本" class="headerlink" title="查看数据库版本"></a>查看数据库版本</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">"%version%"</span>;</div></pre></td></tr></table></figure>
<h2 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="string">`waybill_task`</span> <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8 */</span>;</div></pre></td></tr></table></figure>
<h2 id="删除数据库-1"><a href="#删除数据库-1" class="headerlink" title="删除数据库"></a>删除数据库</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">drop</span> <span class="keyword">database</span> <span class="string">`waybill_task`</span>;</div></pre></td></tr></table></figure>
<h2 id="添加唯一索引"><a href="#添加唯一索引" class="headerlink" title="添加唯一索引"></a>添加唯一索引</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`phone`</span> </div><div class="line"><span class="keyword">ADD</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> <span class="string">`ix_phone`</span> (<span class="string">`country`</span>, <span class="string">`area`</span>, <span class="string">`number`</span>, <span class="string">`extension`</span>);</div><div class="line"></div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> waybill_extend_0 <span class="keyword">ADD</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> idx_unq_waybill_code_data_key(waybill_code,data_key);</div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`$&#123;dbName&#125;`</span>.<span class="string">`$&#123;tbName&#125;`</span> <span class="keyword">ADD</span> <span class="keyword">INDEX</span> idx_unq_waybill_code_data_key(waybill_code,data_key);</div></pre></td></tr></table></figure>
<h2 id="添加普通索引"><a href="#添加普通索引" class="headerlink" title="添加普通索引"></a>添加普通索引</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`blocker_work_task_his`</span>   </div><div class="line">  <span class="keyword">ADD</span>  <span class="keyword">INDEX</span> <span class="string">`idx_ref_id`</span> (<span class="string">`ref_id`</span>);</div></pre></td></tr></table></figure>
<blockquote>
<p>What are differences between Index v.s. Key in MySQL<br>There’s no difference. They are synonyms.</p>
</blockquote>
<h1 id="连接池配置"><a href="#连接池配置" class="headerlink" title="连接池配置"></a>连接池配置</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp.BasicDataSource"</span> <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"$&#123;db.driverClassName&#125;"</span>/&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;db.url&#125;"</span>/&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;db.username&#125;"</span>/&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;db.password&#125;"</span>/&gt;</span> </div><div class="line"><span class="comment">&lt;!--initialSize: 初始化连接--&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"initialSize"</span> <span class="attr">value</span>=<span class="string">"5"</span>/&gt;</span> </div><div class="line"><span class="comment">&lt;!--maxIdle: 最大空闲连接--&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"10"</span>/&gt;</span> </div><div class="line"><span class="comment">&lt;!--minIdle: 最小空闲连接--&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minIdle"</span> <span class="attr">value</span>=<span class="string">"5"</span>/&gt;</span> </div><div class="line"><span class="comment">&lt;!--maxActive: 最大连接数量--&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxActive"</span> <span class="attr">value</span>=<span class="string">"15"</span>/&gt;</span> </div><div class="line"><span class="comment">&lt;!--removeAbandoned: 是否自动回收超时连接--&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"removeAbandoned"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span> </div><div class="line"><span class="comment">&lt;!--removeAbandonedTimeout: 超时时间(以秒数为单位)--&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"removeAbandonedTimeout"</span> <span class="attr">value</span>=<span class="string">"55"</span>/&gt;</span> </div><div class="line"><span class="comment">&lt;!--maxWait: 超时等待时间以毫秒为单位 6000毫秒/1000等于6秒--&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWait"</span> <span class="attr">value</span>=<span class="string">"3000"</span>/&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"validationQuery"</span>&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>SELECT 1<span class="tag">&lt;/<span class="name">value</span>&gt;</span> </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"testOnBorrow"</span>&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span> </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span> </div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">waybill.main.datasource.driverClassName=com.mysql.jdbc.Driver</div><div class="line">waybill.main.datasource.url=jdbc:mysql://qlwyoth.mysql.jddb.com:3358/waybill_oth?characterEncoding=UTF-8</div><div class="line">waybill.main.datasource.defaultAutoCommit=true</div><div class="line">waybill.main.datasource.maxActive=10</div><div class="line">waybill.main.datasource.maxIdle=5</div><div class="line">waybill.main.datasource.maxWait=3000</div><div class="line">waybill.main.datasource.initialSize=2</div><div class="line">waybill.main.datasource.minIdle=2</div><div class="line">waybill.main.datasource.minEvictableIdleTimeMillis=300000</div><div class="line">waybill.main.datasource.timeBetweenEvictionRunsMillis=120000</div><div class="line">waybill.main.datasource.removeAbandoned=true</div><div class="line">waybill.main.datasource.removeAbandonedTimeout=120</div><div class="line">waybill.main.datasource.logAbandoned=true</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>validationQuery</code></td>
<td>SQL查询</td>
<td>用来验证从连接池取出的连接,在将连接返回给调用者之前.如果指定,则查询必须是一个SQL SELECT并且必须返回至少一行记录</td>
</tr>
<tr>
<td>timeBetweenEvictionRunsMillis</td>
<td>-1</td>
<td>在空闲连接回收器线程运行期间休眠的时间值,以毫秒为单位.如果设置为非正数,则不运行空闲连接回收器线程</td>
</tr>
<tr>
<td>testWhileIdle</td>
<td>false</td>
<td>指明连接是否被空闲连接回收器(如果有)进行检验.如果检测失败,则连接将被从池中去除.注意:设置为true后如果要生效,validationQuery参数必须设置为非空字符串</td>
</tr>
<tr>
<td>testOnReturn</td>
<td>false</td>
<td>指明是否在归还到池中前进行检验。注意: 设置为true后如果要生效,validationQuery参数必须设置为非空字符串</td>
</tr>
<tr>
<td><code>testOnBorrow</code></td>
<td>true</td>
<td>指明是否在从池中取出连接前进行检验,如果检验失败,则从池中去除连接并尝试取出另一个.注意: 设置为true后如果要生效,validationQuery参数必须设置为非空字符串</td>
</tr>
<tr>
<td><code>removeAbandonedTimeout</code></td>
<td>300</td>
<td>泄露的连接可以被删除的超时值,单位秒</td>
</tr>
<tr>
<td><code>removeAbandoned</code></td>
<td>false</td>
<td>标记是否删除泄露的连接,如果他们超过了removeAbandonedTimout的限制.如果设置为true,连接被认为是被泄露并且可以被删除,如果空闲时间超过removeAbandonedTimeout.设置为true可以为写法糟糕的没有关闭连接的程序修复数据库连接.</td>
</tr>
<tr>
<td>poolPreparedStatements</td>
<td>false</td>
<td>开启池的prepared statement池功能</td>
</tr>
<tr>
<td>numTestsPerEvictionRun</td>
<td>3</td>
<td>在每次空闲连接回收器线程(如果有)运行时检查的连接数量</td>
</tr>
<tr>
<td><code>minIdle</code></td>
<td>0</td>
<td>最小空闲连接:连接池中容许保持空闲状态的最小连接数量,低于这个数量将创建新的连接,如果设置为0则不创建</td>
</tr>
<tr>
<td>minEvictableIdleTimeMillis</td>
<td>1000 <em> 60 </em> 30</td>
<td>连接在池中保持空闲而不被空闲连接回收器线程，(如果有)回收的最小时间值，单位毫秒</td>
</tr>
<tr>
<td><code>maxWait</code></td>
<td>-1</td>
<td>最大等待时间:当没有可用连接时,连接池等待连接被归还的最大时间(以毫秒计数),超过时间则抛出异常,如果设置为-1表示无限等待</td>
</tr>
<tr>
<td>maxOpenPreparedStatements</td>
<td>不限制</td>
<td>statement池能够同时分配的打开的statements的最大数量,如果设置为0表示不限制</td>
</tr>
<tr>
<td><code>maxIdle</code></td>
<td>8</td>
<td>最大空闲连接:连接池中容许保持空闲状态的最大连接数量,超过的空闲连接将被释放,如果设置为负数表示不限制</td>
</tr>
<tr>
<td><code>maxActive</code></td>
<td>8</td>
<td>最大活动连接:连接池在同一时间能够分配的最大活动连接的数量, 如果设置为非正数则表示不限制</td>
</tr>
<tr>
<td>logAbandoned</td>
<td>false</td>
<td>标记当Statement或连接被泄露时是否打印程序的stack traces日志。被泄露的Statements和连接的日志添加在每个连接打开或者生成新的Statement,因为需要生成stack trace。</td>
</tr>
<tr>
<td><code>initialSize</code></td>
<td>0</td>
<td>初始化连接:连接池启动时创建的初始化连接数量,1.2版本后支持</td>
</tr>
</tbody>
</table>
<h1 id="间隙锁"><a href="#间隙锁" class="headerlink" title="间隙锁"></a>间隙锁</h1><p>当我们通过一个参数去删除或者更新一条记录的时候， 如果参数在数据库中存在， 那么这个时候产生的是普通行锁， 锁住这个记录， 然后删除， 然后释放锁。</p>
<p>如果这条记录不存在，问题就来了， 数据库会扫描索引，发现这个记录不存在， 这个时候的delete或者update语句获取到的就是一个间隙锁，然后数据库会向左扫描扫到第一个比给定参数小的值， 向右扫描扫描到第一个比给定参数大的值， 然后以此为界，构建一个区间， 锁住整个区间内的数据</p>
<p>如果此时另一个事务对锁住的区域进行写操作，一个特别容易出现死锁的间隙锁诞生了</p>
<p>系统中存在一些老的代码，这些代码逻辑在接收到数据时直接先更新或者删除，然后使用返回结果，进行判断是否需要插入，在高并发情况下，如果同时操作了临近的数据，死锁就产生了。</p>
<p>最优方案为修改程序中使用事务的代码，避免对不存在的数据进行delete或者update（可先使用查询明确数据是否存在，可使用redis避免查库）后执行insert</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[JavaSE JVM]]></title>
      <url>http://xiaozhuang.github.io/2017/04/25/javase-jvm/</url>
      <content type="html"><![CDATA[<p>Java 虚拟机<br><a id="more"></a></p>
<h1 id="Java内存模型"><a href="#Java内存模型" class="headerlink" title="Java内存模型"></a>Java内存模型</h1><p>运行时内存模型，分为<code>线程私有</code>和<code>共享数据区</code>两大类。<br>其中线程私有的数据区包含<code>程序计数器</code>、<code>虚拟机栈</code>、<code>本地方法栈</code>，<br>所有线程共享的数据区包含<code>Java堆</code>、<code>方法区</code>，在方法区内包含<code>常量池</code>。</p>
<blockquote><p>参考文档：<br><a href="http://gityuan.com/2016/01/09/java-memory/" target="_blank" rel="external">http://gityuan.com/2016/01/09/java-memory/</a><br><a href="https://www.zhihu.com/question/29884421" target="_blank" rel="external">https://www.zhihu.com/question/29884421</a></p>
</blockquote>
<img src="/2017/04/25/javase-jvm/jvmMemory1.png" alt="jvmMemory1.png" title="">
<p>详细模型</p>
<img src="/2017/04/25/javase-jvm/stackHeapInfo.png" alt="stackHeapInfo.png" title="">
<h2 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h2><p>存放虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。</p>
<p>方法区的内存回收目标主要是针对常量池的回收和类型的卸载。</p>
<blockquote>
<p>java虚拟机规范把方法区描述为堆的一个逻辑部分，它有一个别名叫Non-Heap</p>
</blockquote>
<h3 id="运行时常量池"><a href="#运行时常量池" class="headerlink" title="运行时常量池"></a>运行时常量池</h3><p>运行时常量池：是<code>方法区的一部分</code>，<br>是类或接口class文件中<code>常量池表</code>的运行时表示形式，<br>常量池表用于存放<code>字面量</code>和<code>符号引用</code>。</p>
<p>字面量：包含文本字符串、声明为final的常量值等。<br>符号引用：类和接口的全限定名、字段的名称和描述符、方法的名称和描述符。</p>
<p>Java虚拟机为每个类型都维护着一个常量池。</p>
<h3 id="String类中的intern-方法"><a href="#String类中的intern-方法" class="headerlink" title="String类中的intern()方法"></a>String类中的intern()方法</h3><p>运行时常量池除了编译期产生的Class文件的常量池，还可以在运行期间，将新的常量加入常量池，<br>比较常见的是String类的intern()方法。</p>
<img src="/2017/04/25/javase-jvm/StringIiteral.png" alt="StringIiteral.png" title="">
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1.String定义时赋值，表达式右侧只有字符串常量，变量存放在常量池里</span></div><div class="line"><span class="comment">// 2.new出来的字符串是放在堆中</span></div><div class="line"><span class="comment">// 3.对字符串进行拼接操作，分2中情况： </span></div><div class="line"><span class="comment">//      右侧是纯字符串常量，存于字符串常量池；</span></div><div class="line"><span class="comment">//      右侧存在字符串对象句柄，存放在堆中。</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 在heap堆重新创建一个对象</span></div><div class="line"><span class="comment">// 然后把 弱引用驻留到字符串常量区。</span></div><div class="line"><span class="comment">// 然后再把引用复制栈帧的局部变量表。</span></div><div class="line">String str = <span class="string">"Hello"</span>;</div><div class="line"></div><div class="line"><span class="comment">// 在heap堆重新创建一个对象</span></div><div class="line">String str2 = <span class="keyword">new</span> String(<span class="string">"Hello"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 能手动检查字符串常量池，把有新字面值的字符串地址驻留到常量池里</span></div><div class="line">String str3 = str2.intern();</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># server模式 打印GC</span></div><div class="line">java -server -verbose:gc -XX:+PrintCompilation C2EscapeAnalysisDemo </div><div class="line"><span class="comment"># 逃逸分析和空间分配消除功能</span></div><div class="line">java -server -verbose:gc -XX:+PrintCompilation -XX:+DoEscapeAnalysis -XX:+EliminateAllocations C2EscapeAnalysisDemo</div></pre></td></tr></table></figure>
<blockquote><footer><strong>参考文档:</strong><cite><a href="https://www.zhihu.com/question/22739143" target="_blank" rel="external">www.zhihu.com/question/22739143</a></cite></footer></blockquote>
<p>Java的8种基本类型(Byte, Short, Integer, Long, Character, Boolean, Float, Double), 除Float和Double以外, 其它六种都实现了常量池,<br>但是它们只在大于等于-128并且小于等于127时才使用常量池。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </div><div class="line">    Integer a = <span class="number">127</span>;  </div><div class="line">    Integer b = <span class="number">127</span>;  </div><div class="line">    System.out.println(<span class="string">"等于127:"</span>);  </div><div class="line">    System.out.println(a == b);  </div><div class="line">    System.out.println(<span class="string">"*****************"</span>);  </div><div class="line">  </div><div class="line">    a = <span class="number">128</span>;  </div><div class="line">    b = <span class="number">128</span>;  </div><div class="line">    System.out.println(<span class="string">"等于128:"</span>);  </div><div class="line">    System.out.println(a == b);  </div><div class="line">    System.out.println(<span class="string">"*****************"</span>);  </div><div class="line">  </div><div class="line">    a = -<span class="number">128</span>;  </div><div class="line">    b = -<span class="number">128</span>;  </div><div class="line">    System.out.println(<span class="string">"等于-128:"</span>);  </div><div class="line">    System.out.println(a == b);  </div><div class="line">    System.out.println(<span class="string">"*****************"</span>);  </div><div class="line">  </div><div class="line">    a = -<span class="number">129</span>;  </div><div class="line">    b = -<span class="number">129</span>;  </div><div class="line">    System.out.println(<span class="string">"等于-129:"</span>);  </div><div class="line">    System.out.println(a == b);  </div><div class="line">    System.out.println(<span class="string">"*****************"</span>);  </div><div class="line">  </div><div class="line">    <span class="comment">// &lt;a href="http://lib.csdn.net/base/softwaretest" class='replace_word' title="软件测试知识库" target='_blank' style='color:#df3434; font-weight:bold;'&gt;测试&lt;/a&gt;Boolean  </span></div><div class="line">    System.out.println(<span class="string">"测试Boolean"</span>);  </div><div class="line">    Boolean c = <span class="keyword">true</span>;  </div><div class="line">    Boolean d = <span class="keyword">true</span>;  </div><div class="line">    System.out.println(c == d);  </div><div class="line">    d = <span class="keyword">new</span> Boolean(<span class="keyword">true</span>);  </div><div class="line">    System.out.println(c == d);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">等于127:</div><div class="line">true</div><div class="line">*****************</div><div class="line">等于128:</div><div class="line">false</div><div class="line">*****************</div><div class="line">等于-128:</div><div class="line">true</div><div class="line">*****************</div><div class="line">等于-129:</div><div class="line">false</div><div class="line">*****************</div><div class="line">测试Boolean</div><div class="line">true</div><div class="line">false</div></pre></td></tr></table></figure>
<blockquote><footer><strong>参考文档:</strong><cite><a href="http://blog.csdn.net/shw2004/article/details/5678703" target="_blank" rel="external">blog.csdn.net/shw2004/article/details/5678703</a></cite></footer></blockquote>
<h2 id="Java堆"><a href="#Java堆" class="headerlink" title="Java堆"></a>Java堆</h2><p>存放对象实例和数组数据</p>
<h2 id="程序计数器"><a href="#程序计数器" class="headerlink" title="程序计数器"></a>程序计数器</h2><p>当前线程所执行的字节码的行号指示器</p>
<blockquote>
<p>如果正在执行Native方法，计数器值为空（Undefined）</p>
</blockquote>
<h2 id="虚拟机栈"><a href="#虚拟机栈" class="headerlink" title="虚拟机栈"></a>虚拟机栈</h2><p>Java方法执行的内存模型：栈帧随着方法调用而创建，随着方法结束而销毁。</p>
<h3 id="栈帧"><a href="#栈帧" class="headerlink" title="栈帧"></a>栈帧</h3><p>栈帧是方法执行的数据结构</p>
<p>栈帧包括:</p>
<ul>
<li>局部变量表</li>
<li>操作数栈</li>
<li>方法返回地址</li>
<li>动态链接</li>
<li>额外附加信息</li>
</ul>
<h4 id="局部变量表"><a href="#局部变量表" class="headerlink" title="局部变量表"></a>局部变量表</h4><p>用于存放方法参数和局部变量</p>
<p>局部变量表中存放了<code>基本数据类型</code>、<code>对象引用</code>和<code>returnAddress类型</code></p>
<p>一个局部变量可保存一个类型为boolean、byte、char、short、int、float、reference或returnAddress的数据。<br>两个局部变量可保存一个类型为long或double的数据。</p>
<h4 id="操作数栈"><a href="#操作数栈" class="headerlink" title="操作数栈"></a>操作数栈</h4><p>方法调用时，操作数栈用来准备调用方法的<code>参数</code>及接收方法<code>返回结果</code></p>
<p>任意时刻，操作数栈都会有一个明确的栈深度，<br>long和double类型数据占用两个单位栈深度，其他数据类型占用一个单位栈深度。</p>
<h4 id="方法返回地址"><a href="#方法返回地址" class="headerlink" title="方法返回地址"></a>方法返回地址</h4><p>正常退出，执行引擎遇到方法返回的字节码，将返回值传递给调用者<br>异常退出，遇到Exception,并且方法未捕捉异常，那么不会有任何返回值</p>
<h4 id="动态链接"><a href="#动态链接" class="headerlink" title="动态链接"></a>动态链接</h4><p>每个栈帧都包含执行当前方法所在类型的运行时常量池的引用，<br>以便对当前方法的代码实现动态链接。</p>
<p>动态链接的作用是将以<code>符号引用</code>表示的方法转换为实际方法的<code>直接引用</code>。</p>
<h4 id="额外附加信息"><a href="#额外附加信息" class="headerlink" title="额外附加信息"></a>额外附加信息</h4><p>与Java虚拟机实现相关的附加信息</p>
<p>如：对程序调试提供支持的信息</p>
<h1 id="HotSpot虚拟机"><a href="#HotSpot虚拟机" class="headerlink" title="HotSpot虚拟机"></a>HotSpot虚拟机</h1><h2 id="对象的访问定位"><a href="#对象的访问定位" class="headerlink" title="对象的访问定位"></a>对象的访问定位</h2><p>直接指针访问（Sun HotSpot使用该方式）：<br>reference中存储<code>实例数据地址</code>，实例数据中包含对象类型数据地址</p>
<p>句柄访问：<br>堆区包含句柄池，reference中存储对象句柄地址，<br>句柄中包含对象<code>实例数据地址</code>和<code>类型数据地址</code>。</p>
<h1 id="JVM概览"><a href="#JVM概览" class="headerlink" title="JVM概览"></a>JVM概览</h1><h2 id="编译策略"><a href="#编译策略" class="headerlink" title="编译策略"></a>编译策略</h2><p>代码最初都是在解释器中运行。<br>方法被调用的次数变多，可能变成编译。</p>
<h2 id="混合式JIT编译器"><a href="#混合式JIT编译器" class="headerlink" title="混合式JIT编译器"></a>混合式JIT编译器</h2><p>混合式JIT编译器采用分层编译，融合了Client JIT编译器和Server JIT编译器的主要特征。</p>
<p>Java6 Update 25、Java7或更高的版本，<br>可以用-server -XX: +TieredCompilation替代Client JIT编译器。</p>
<h2 id="HotSpot-VM-自适应调优"><a href="#HotSpot-VM-自适应调优" class="headerlink" title="HotSpot VM 自适应调优"></a>HotSpot VM 自适应调优</h2><p>Java5 HotSport VM新特性，<br>依据JVM启动时底层平台和系统配置自动选择<code>垃圾收集器</code>、<code>配置Java堆</code>、<code>JIT编译器</code>。</p>
<p>命令行选项-XX:+PrintCommandLineFlags可打印HotSpot VM采用的自动优化参数。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">java -XX:+PrintCommandLineFlags -version</div><div class="line"></div><div class="line"><span class="comment"># 关闭自适应调优</span></div><div class="line">-XX:-UseAdaptiveSizePolicy</div></pre></td></tr></table></figure>
<h1 id="JVM性能监控"><a href="#JVM性能监控" class="headerlink" title="JVM性能监控"></a>JVM性能监控</h1><p>生产环境中应该<code>自始至终</code>地监控应用JVM。</p>
<p>JVM是应用软件栈的重要组成部分，应该想监控应用本身和操作系统那样监控JVM。</p>
<h2 id="垃圾收集"><a href="#垃圾收集" class="headerlink" title="垃圾收集"></a>垃圾收集</h2><p>垃圾收集报告：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 报告垃圾收集信息</span></div><div class="line">-verbose:gc</div><div class="line"><span class="comment"># 报告详细垃圾收集信息</span></div><div class="line">-XX:+PrintGCDetails</div><div class="line"></div><div class="line"><span class="comment"># gc报告包含时间戳</span></div><div class="line">-XX:+PrintGCTimeStamps</div><div class="line">-XX:+PrintGCDateStamps</div><div class="line"></div><div class="line"><span class="comment"># 垃圾收集统计数据输出到文件</span></div><div class="line">-Xloggc:&lt;filename&gt;</div></pre></td></tr></table></figure>
<h2 id="垃圾收集数据的离线分析"><a href="#垃圾收集数据的离线分析" class="headerlink" title="垃圾收集数据的离线分析"></a>垃圾收集数据的离线分析</h2><p>gchisto gc报告离线分析工具</p>
<p>GC Pause Stats显示垃圾收集的次数、开销和持续时间等</p>
<p>一般性准则，并发垃圾收集的开销应该小于10%<br>Throughput收集器，垃圾收集开销接近1%，说明垃圾收集调的很好，3%或更高则说明调优可以改善应用的性能</p>
<p>GC Timeline显示整个时间线上所有垃圾收集的停顿。</p>
<h2 id="jconsole"><a href="#jconsole" class="headerlink" title="jconsole"></a>jconsole</h2><p>JConsole 是一个内置 Java 性能分析器，Java 某个进程的内存、线程、类加载、jvm 概要</p>
<h3 id="启动JConsole"><a href="#启动JConsole" class="headerlink" title="启动JConsole"></a>启动JConsole</h3><ul>
<li>JDK 在 PATH 上，运行 jconsole 即可</li>
<li>JDK 安装路径，打开 bin 文件夹，双击 jconsole</li>
</ul>
<h3 id="JConsole连接远程机器的JAVA程序"><a href="#JConsole连接远程机器的JAVA程序" class="headerlink" title="JConsole连接远程机器的JAVA程序"></a>JConsole连接远程机器的JAVA程序</h3><p>远程JVM开启远程监控;<br>MBean调用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">java -cp . </div><div class="line">-Dcom.sun.management.jmxremote.port=8999 </div><div class="line">-Dcom.sun.managent.jmxremote.authenticate=<span class="literal">false</span> </div><div class="line">-Dcom.sun.management.jmxremote.ssl=<span class="literal">false</span> </div><div class="line">JConsoleTest</div></pre></td></tr></table></figure>
<p>连接远程JVM：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jconsole.exe 192.168.0.181:8999</div></pre></td></tr></table></figure>
<p>tianj<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">jconsole.exe -J-Djava.class.path=%JAVA_HOME%/lib/jconsole.jar;path_to_newjar_/newjar.jar</div><div class="line"></div><div class="line">jconsole.exe -J-Djava.class.path=D:\Program Files\Java\jdk1.7.0_79\binlibjconsole.jar;d:\common-domain-0.0.1-SNAPSHOT.jar</div></pre></td></tr></table></figure></p>
<h2 id="jvisualvm"><a href="#jvisualvm" class="headerlink" title="jvisualvm"></a>jvisualvm</h2><p>VisualVM，JDK自带监控工具，它被认为是第2代JConsole，能够监控线程，内存情况，查看方法的CPU时间和内存中的对象，已被GC的对象，反向查看分配的堆栈(如100个String对象分别由哪几个对象分配出来的).</p>
<h3 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h3><ul>
<li>本地机器的程序直接可以监听到</li>
<li>远程机器的程序需要加上JVM参数</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-Dcom.sun.management.jmxremote= <span class="literal">true</span></div><div class="line">-Dcom.sun.management.jmxremote.port= 9090</div><div class="line">-Dcom.sun.management.jmxremote.ssl= <span class="literal">false</span></div><div class="line">-Dcom.sun.management.jmxremote.authenticate= <span class="literal">false</span></div></pre></td></tr></table></figure>
<p>tomcat配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xport CATALINA_OPTS=&quot;$CATALINA_OPTS -Dcom.sun.management.jmxremote -Djava.rmi.server.hostname=xxx.xxx.xxx.xxx  -Dcom.sun.management.jmxremote.port=xxx -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=true -Dcom.sun.management.jmxremote.password.file=../conf/jmxremote.password  -Dcom.sun.management.jmxremote.access.file=../conf/jmxremote.access&quot;</div></pre></td></tr></table></figure>
<p>开启认证：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 是否开启认证、false的时候可以不使用密码访问</span></div><div class="line"><span class="comment"># -Dcom.sun.management.jmxremote.authenticate=true</span></div><div class="line"></div><div class="line"><span class="comment"># 以上配置是开启认证时使用的access文件和password文件</span></div><div class="line"><span class="comment"># -Dcom.sun.management.jmxremote.password.file=../conf/jmxremote.password </span></div><div class="line"><span class="comment"># -Dcom.sun.management.jmxremote.access.file=../conf/jmxremote.access</span></div></pre></td></tr></table></figure>
<p>其中jmxremote.access文件的内容可以配置为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">username1 readonly</div><div class="line">username2 readwrite</div></pre></td></tr></table></figure>
<p>jmxremote.password文件可以配置为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">username1 password1</div><div class="line">username2 password2</div></pre></td></tr></table></figure>
<p>将以上俩文件放在对应配置目录tomcat/conf/下<br>并且将以上俩个文件访问权限配置成：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chmod 600 jmx*</div></pre></td></tr></table></figure>
<p>如果没有这一步、使用startup启动不了tomcat。</p>
<ul>
<li><a href="http://www.cnblogs.com/jager/p/5683455.html" title="JAVA内存泄露分析及解决" target="_blank" rel="external">JAVA内存泄露分析及解决</a></li>
<li><a href="https://my.oschina.net/kone/blog/157239" title="使用JDK自带jvisualvm监控tomcat" target="_blank" rel="external">使用JDK自带jvisualvm监控tomcat</a>
</li>
</ul>
<h3 id="导出堆dump"><a href="#导出堆dump" class="headerlink" title="导出堆dump"></a>导出堆dump</h3><p>jvisualvm导出堆dump：应用程序 -&gt; 堆dump</p>
<p>java命令导出堆dump：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># java5 生成堆dump命令，保存于执行命令目录下heap.bin文件中</span></div><div class="line">jmap -heap:format=b,&lt;jvm pid&gt;</div><div class="line"></div><div class="line"><span class="comment"># java6 生成堆dump命令</span></div><div class="line">jmap -dump:format=b,file=&lt;filename&gt; &lt;jvm pid&gt;</div></pre></td></tr></table></figure>
<h3 id="分析Dump文件"><a href="#分析Dump文件" class="headerlink" title="分析Dump文件"></a>分析Dump文件</h3><p>堆dump文件分析工具：MemoryAnalyzerTool</p>
<p>使用内存分析工具从众多的对象中进行分析，快速的计算出在内存中对象的占用大小，看看是谁阻止了垃圾收集器的回收工作，并可以通过报表直观的查看到可能造成这种结果的对象。</p>
<h3 id="VisualGC"><a href="#VisualGC" class="headerlink" title="VisualGC"></a>VisualGC</h3><p>VisualGC 是JVisualVM的插件，可以监控垃圾收集、类加载和JIT编译。</p>
<h2 id="JIT编译"><a href="#JIT编译" class="headerlink" title="JIT编译"></a>JIT编译</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 监控HotSport JIT编译器</span></div><div class="line">-XX:+PrintCompilation</div></pre></td></tr></table></figure>
<p>图形化工具JConsole、JVisualVM或VisualGC插件提供哪个方法正被JIT编译的信息。</p>
<h1 id="类加载"><a href="#类加载" class="headerlink" title="类加载"></a>类加载</h1><p>需要加载其他类而空间不足时，未使用的类会从永久代中被卸载。<br>从永久代卸载类，意味着需要Full GC。</p>
<p>Full GC时有类被卸载，说明永久代需要扩大，或者它的初始大小需要扩大</p>
<p>避免Full GC扩大或缩小永久代的可分配空间，可以设置-XX:PermSize和-XX:MaxPermSize为相同值</p>
<p>图形工具JConsole、JVisualVM和VisualGC插件可以监视类加载</p>
<p>类数据共享是指在同一个系统内的JVM之间<code>共享类</code>、减少内存占用的特性。</p>
<h1 id="jdk源码debug不显示变量值"><a href="#jdk源码debug不显示变量值" class="headerlink" title="jdk源码debug不显示变量值"></a>jdk源码debug不显示变量值</h1><p>原因：<br>    Oracle提供的jre中rt.jar不带debug信息：orcale在编译src时使用了 javac -g:none，意思是不带任何调试信息，这样可以减小rt.jar的大小。<br>    若想正常调试jdk，可以重新编译src.zip或带有Debug信息的JDK</p>
<p>解决方法：<br>    编译jdk目录下src.zip中java、javax包下类文件，打包为rt_debug.jar,<br>    放到<code>$JAVA_HOME/jre/lib/endorsed</code>文件夹下</p>
<p>参考文档：<br><a href="http://www.thejavageek.com/2016/04/03/debug-jdk-source-code/" title="debug-jdk-source-code" target="_blank" rel="external">debug-jdk-source-code</a></p>
<p>编译后jar包及参考文档：<br></p>
<h2 id="编译src-zip报错问题"><a href="#编译src-zip报错问题" class="headerlink" title="编译src.zip报错问题"></a>编译src.zip报错问题</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Type mismatch: cannot convert from Annotation to ConstructorProperties</span></div><div class="line">java.beans.MetaData.getAnnotationValue(Constructor)</div></pre></td></tr></table></figure>
<p>解决方法；<br><a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=167952" title="Invalid compilation errors for rt.jar for Java 1.6 annotations" target="_blank" rel="external">Invalid compilation errors for rt.jar for Java 1.6 annotations</a></p>
<h2 id="Java-覆盖系统类：endorsed-技术"><a href="#Java-覆盖系统类：endorsed-技术" class="headerlink" title="Java 覆盖系统类：endorsed 技术"></a>Java 覆盖系统类：endorsed 技术</h2><p>/ɪnˈdɔ:sd/</p>
<p>jvm的两个参数-Djava.endorsed.dirs和-Djava.ext.dirs<br>{java.ext.dirs} 可选包扩展机制<br>{java.endorsed.dirs} 包升级替换机制，一般默认是lib/endorsed文件夹，就是说，可以把你自己的jar包放在这里，代替原有的系统的jar包</p>
<p>如果不想添加-D参数，如果我们希望基于这个JDK下的都统一改变，那么我们可以将我们修改的jar放到：<code>$JAVA_HOME/jre/lib/endorsed</code></p>
<blockquote>
<p>参考信息:<br><a href="http://blog.csdn.net/conquer0715/article/details/51243353" title="Java 覆盖系统类：endorsed 技术" target="_blank" rel="external">Java 覆盖系统类：endorsed 技术</a><br><a href="http://www.iteye.com/problems/75087" title="endorsed文件夹的作用" target="_blank" rel="external">endorsed文件夹的作用</a></p>
</blockquote>
<h2 id="classpath路径的先后顺序是有意义的"><a href="#classpath路径的先后顺序是有意义的" class="headerlink" title="classpath路径的先后顺序是有意义的"></a>classpath路径的先后顺序是有意义的</h2><p><code>可用于覆盖jar包中的类</code></p>
<p>-classpath路径的先后顺序是有意义的</p>
<blockquote><p>Of particular importance, and much consternation, the class loader will load classes in the order they appear in the classpath. Starting with the first classpath entry, the class loader visits each specified directory or archive file attempting to find the class to load. The first class it finds with the proper name is loaded, and any remaining classpath entries are ignored.<br>Sounds simple, right?</p>
<footer><strong>Mastering the classpath with JWhich</strong><cite><a href="http://www.javaworld.com/javaworld/javatips/jw-javatip105.html" target="_blank" rel="external">Mastering the classpath with JWhich</a></cite></footer></blockquote>
<p>上面说明了，java xx -classpath “.;a.jar;b.jar;” 时，如果a.jar和b.jar有重名的类，那么会以a.jar的为准，忽略b.jar的，因为jvm按照-classpath参数的路径先后顺序去load类，后续加载的同名的类会被忽略。</p>
<p>jvm查找类，不仅仅是按名字找，还有包，如果包不同，也视为不同的class，<br>如果package+class都相同，则根据classpath的设置顺序，前面的优先加载，一旦前面的被加载，后面的就再也不会被加载了,<br>也就是说其实还是有一定的加载规则加载顺序的,你不能寄希望与系统，让它智能的加载你想要的。如果系统出现了重名class，危险性是非常高的。</p>
<h2 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h2><p>类加载器大致可以分成两类</p>
<ul>
<li>系统提供</li>
<li>Java 应用开发人员编写</li>
</ul>
<p>系统提供的类加载器</p>
<ul>
<li>引导类加载器（bootstrap class loader）：用来加载 Java 核心库，原生代码来实现，不继承自java.lang.ClassLoader</li>
<li>扩展类加载器（extensions class loader）：用来加载 Java 的扩展库。Java 虚拟机的实现会提供一个扩展库目录。该类加载器在此目录里面查找并加载 Java 类</li>
<li>系统类加载器（system class loader）：根据 Java 应用的类路径（CLASSPATH）来加载 Java 类。一般，Java 应用的类都是由它完成加载。可以通过 ClassLoader.getSystemClassLoader()来获取它</li>
</ul>
<p>开发人员可以通过继承 java.lang.ClassLoader类的方式实现自己的类加载器</p>
<h3 id="双亲委托模型"><a href="#双亲委托模型" class="headerlink" title="双亲委托模型"></a>双亲委托模型</h3><p>当前classLoader的缓存中没有找到被加载的类的时候，委托父类加载器去加载，父类加载器采用同样的策略，首先查看自己的缓存，然后委托父类的父类去加载，一直到bootstrp ClassLoader</p>
<p>当所有的父类加载器都没有加载的时候，再由当前的类加载器加载，并将其放入它自己的缓存中，以便下次有加载请求的时候直接返回</p>
<h2 id="快速监控锁竞争"><a href="#快速监控锁竞争" class="headerlink" title="快速监控锁竞争"></a>快速监控锁竞争</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 命令生成线程转储</span></div><div class="line">jstack &lt;jvm pid&gt;</div><div class="line"></div><div class="line"><span class="comment"># linux</span></div><div class="line"><span class="built_in">kill</span> -3</div><div class="line"></div><div class="line"><span class="comment"># window</span></div><div class="line">Ctrl + Break</div></pre></td></tr></table></figure>
<p>JVisualVM 可生成线程转储</p>
<h1 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h1><h2 id="垃圾收集器"><a href="#垃圾收集器" class="headerlink" title="垃圾收集器"></a>垃圾收集器</h2><p>CMS收集器，低延迟为先，减少stop the world的时间，让GC线程和业务线程并发</p>
<p>-Xms4096m -Xmx4096m，Java堆的初始和最小值，最大值<br>-XX:MaxPermSize=512m，最大持久代内存512M</p>
<p>-XX:+UseConcMarkSweepGC，新生代和老年代都并发gc的方式<br>-Xmn2048M，置新生代内存的上限大小为2g</p>
<p>-XX:+UseCMSInitiatingOccupancyOnly，当旧生代空间使用率达到92%时会无条件执行Full GC，不根据成本计算<br>-XX:+CMSClassUnloadingEnabled，开启对永久代垃圾回收，CMS收集器默认不会对永久代进行垃圾回收</p>
<p>-XX:CMSInitiatingOccupancyFraction=80，当旧生代空间使用到一定比率时, 强制执行旧生代的Full GC，默认92%<br>-XX:CMSInitiatingPermOccupancyFraction=80，当持久代里的使用比例达到一定比率时，进行持久代内存 的回收，默认为92%</p>
<p>-Xss 每个线程的堆栈大小 JDK5.0以后每个线程堆栈大小为1M,以前每个线程堆栈大小为256K;<br>如果栈不是很深， 应该是128k够用的 大的应用建议使用256k。这个选项对性能影响比较大，需要严格的测试。</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java Concurrency In Practice]]></title>
      <url>http://xiaozhuang.github.io/2017/04/20/java-concurrency-in-practice/</url>
      <content type="html"><![CDATA[<p>《Java并发编程实战》笔记<br><a id="more"></a></p>
<h1 id="线程安全性"><a href="#线程安全性" class="headerlink" title="线程安全性"></a>线程安全性</h1><p>编写线程安全的代码，核心在于<code>对状态访问操作</code>进行管理，<br>特别是对<code>共享的</code>和<code>可变的</code>状态的访问。</p>
<p>实现线程安全:</p>
<ul>
<li>不在线程之间共享状态变量</li>
<li>状态变量修改为不可变变量</li>
<li>访问状态变量时使用同步</li>
</ul>
<p>编写并发程序原则：<br>首先使代码<code>正确运行</code>，然后再提高代码的速度。</p>
<blockquote>
<p>应该始终遵循这个原则。由于并发错误难以重现和调试。</p>
</blockquote>
<h2 id="什么是线程安全性"><a href="#什么是线程安全性" class="headerlink" title="什么是线程安全性"></a>什么是线程安全性</h2><p>线程安全类：多个线程访问某个类时，类始终能表现出<code>正确的行为</code></p>
<p>正确性的含义：某个类的<code>行为</code>与其<code>规范</code>完全一致</p>
<p>线程安全类中封装了必要的同步机制，客户端无须进一步采取同步措施</p>
<p><code>无状态对象</code>一定是线程安全的。</p>
<h2 id="竞态条件"><a href="#竞态条件" class="headerlink" title="竞态条件"></a>竞态条件</h2><p>竞态条件：当某个计算的正确性取决于多个线程的交替执行时序时，那么就会发生竞态条件。</p>
<p>最常见的竞态条件是“先检查后执行”操作</p>
<p>竞态条件本质:基于一种可能失效的观察结果来做出判断或执行某个计算。</p>
<h2 id="内置锁"><a href="#内置锁" class="headerlink" title="内置锁"></a>内置锁</h2><p>内置锁提供了独占的加锁方式（原子性、顺序性、可见性）</p>
<p>每个java<code>对象</code>都可以用做实现同步的锁，<br>这些锁被称为内置锁（Intrinsic Lock）或监视器锁（Monitor Lock）</p>
<p>Java内置锁相当于一种互斥体，最多<code>只有一个</code>线程能持有锁</p>
<p>同步代码块（Synchronized Block）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">synchronized</span>(lock)&#123;</div><div class="line">    <span class="comment">//访问或修改由锁保护的共享状态</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>每次<code>只有一个</code>线程执行内置锁保护的代码块，<br>由锁保护的代码块会以<code>原子方式</code>执行。</p>
<p>原子性：一组语句作为一个不可分割的单元被执行。</p>
<p>原子性和可见性 JMM关于synchronized的两条规定:</p>
<ul>
<li>线程解锁前，必须把共享变量的最新值刷新到主内存</li>
<li>线程加锁前，清空工作内存中共享变量，从主内存中重新读取最新的值</li>
</ul>
<h2 id="重入"><a href="#重入" class="headerlink" title="重入"></a>重入</h2><p>重入：某个线程试图获得一个已经由它持有的锁，那么这个请求会成功</p>
<p>重入的一种实现方法，为每个锁关联一个<code>获取计数值</code>和一个<code>所有者线程</code></p>
<p>内置锁是可重入的</p>
<h2 id="用锁来保护状态"><a href="#用锁来保护状态" class="headerlink" title="用锁来保护状态"></a>用锁来保护状态</h2><p>使用锁来协调对某个变量的访问时，在访问变量的所有位置上都需要使用<code>同一个锁</code></p>
<p>当获取与某个对象关联的锁时，并<code>不能阻止</code>其他线程<code>访问</code>该对象，<br>某个线程在获得对象的锁之后，能阻止其他线程获得同一个锁。 </p>
<p>某个变量由锁保护时，意味着每次访问这个变量都需要首先获得锁，<br>这样就确保在同一时刻只有一个线程访问这个变量。</p>
<p>对于每个包含<code>多个变量</code>的<code>不变性条件</code>，<br>其中涉及的所有变量都需要由<code>同一个</code>锁来保护。</p>
<p>执行<code>时间较长</code>的计算或可能无法快速完成的操作时（网络I/O、控制台I/O），<br>一定<code>不要</code>持有锁。</p>
<h1 id="对象的共享"><a href="#对象的共享" class="headerlink" title="对象的共享"></a>对象的共享</h1><p>访问共享的可变状态时需要进行正确的管理。</p>
<h2 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h2><p>没有同步情况下，无法确保执行读操作的线程能适时地看到其他线程写入的值。</p>
<h2 id="重排序"><a href="#重排序" class="headerlink" title="重排序"></a>重排序</h2><p>在没有同步的情况下，编译器、处理器以及运行时等都可能对<code>操作的执行顺序</code>进行一些意想不到的调整。</p>
<p>在缺乏足够同步的多线程程序中，无法对内存操作的执行顺序进行判断</p>
<h2 id="非原子的64位操作"><a href="#非原子的64位操作" class="headerlink" title="非原子的64位操作"></a>非原子的64位操作</h2><p>最低安全性：在没有同步的情况下读取变量，可能得到一个失效值，<br>但至少这个值是由之前某个线程设置的，而不是一个随机值。</p>
<p>最低安全性适用于绝大多数变量，非volatile类型64位数值变量例外。</p>
<p>Java内存模型要求，变量<code>读取</code>和<code>写入</code>操作都必须是原子操作，<br>但对非volatile类型的long和double变量，JVM允许将64位的读操作和写操作分解为两个32位操作。</p>
<p>读取一个非volatile类型long变量时，<br>如果变量的读操作和写操作在不同的线程中执行，那么可能会读到某个值的高32位和另一个值的低32位。</p>
<p>即使不考虑失效数据问题，多线程程序中使用共享且可变的long和double类型变量也是不安全的。<br>除非使用volatile声明它们或使用锁进行保护。</p>
<h2 id="加锁与可见性"><a href="#加锁与可见性" class="headerlink" title="加锁与可见性"></a>加锁与可见性</h2><p>加锁的含义不仅仅局限于互斥行为，还包括内存可见性。</p>
<p>为了确保所有线程都能看到共享变量的最新值，<br>所有执行读操作或写操作的线程都必须在<code>同一个锁</code>上同步。</p>
<h2 id="volatile变量"><a href="#volatile变量" class="headerlink" title="volatile变量"></a>volatile变量</h2><p>volatile变量确保将变量的更新操作通知到其他线程。</p>
<p>编译器与运行时<code>不会</code>将volatile变量上的操作与其他内存操作<code>重排序</code>。</p>
<p>volatile变量<code>不会被缓存</code>在寄存器或对其他处理器不可见的地方。</p>
<p>volatile使用场景：</p>
<ul>
<li>确保自身状态的可见性</li>
<li>确保引用对象的状态的可见性</li>
</ul>
<p>volatile变量通常用做某个操作的<code>状态标识</code></p>
<p>当且仅当满足以下所有条件时，才应该使用volatile变量：</p>
<ul>
<li>对变量的写入操作不依赖变量的当前值</li>
<li>该变量不会与其他状态变量一起纳入不变性条件</li>
<li>访问变量时不需要加锁</li>
</ul>
<h2 id="发布与逸出"><a href="#发布与逸出" class="headerlink" title="发布与逸出"></a>发布与逸出</h2><p>发布：使对象能够在当前作用域之外的代码中使用。</p>
<p>逸出：某个不应该发布的对象被发布。</p>
<p>发布内部类实例导致，隐式地this引用逸出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThisEscape</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThisEscape</span><span class="params">(EventSource source)</span> </span>&#123;</div><div class="line">        source.registerListener(<span class="keyword">new</span> EventListener() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(Event e)</span> </span>&#123;</div><div class="line">                <span class="comment">//ThisEscape.this.doSomething()肯能在构造函数完成前被调用</span></div><div class="line">                doSomething(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doSomething</span><span class="params">(Event e)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">EventSource</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">registerListener</span><span class="params">(EventListener e)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">EventListener</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(Event e)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Event</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="安全的对象构造过程"><a href="#安全的对象构造过程" class="headerlink" title="安全的对象构造过程"></a>安全的对象构造过程</h2><p>当且仅当对象的构造函数返回时，对象才处于可预测的和一致的状态。</p>
<p>不要在构造函数中使this引用逸出。</p>
<p>构造过程中使this引用逸出的常见错误：在构造函数中启动一个线程(由于Thread或Runnable是该对象的内部类)。</p>
<h2 id="线程封闭"><a href="#线程封闭" class="headerlink" title="线程封闭"></a>线程封闭</h2><p>访问共享的可变数据时，通常需要使用同步。</p>
<p>一种避免使用同步的方式是不共享数据。</p>
<p>线程封闭是实现线程安全最简单方式之一。<br>当某个对象封闭在一个线程中时，将自动实现线程安全，即使被封闭的对象本身不是线程安全的。</p>
<h3 id="栈封闭"><a href="#栈封闭" class="headerlink" title="栈封闭"></a>栈封闭</h3><p>局部变量的固有属性之一就是封闭在执行线程中。</p>
<p>任何方法都无法获得基本数据类型的引用，<br>基本类型局部变量始终封闭在线程内。</p>
<p>维持对象引用的栈封闭时，需要确保被引用的对象不会逸出。</p>
<h3 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h3><p>ThreadLocal类能够使线程中的某个值与ThreadLocal对象关联起来。</p>
<p>从概念上看，可以将ThreadLocal<t>视为包含了Map<thread,t>对象，<br>其中保存了特定于该线程的值，但ThreadLocal的实现并非如此。</thread,t></t></p>
<p>特定于线程的值保存在Thread对象中，线程终止后，这些值会被回收。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ThreadLocal&lt;Integer&gt; dataHolder = <span class="keyword">new</span> ThreadLocal&lt;Integer&gt;()&#123;</div><div class="line">    <span class="comment">// 初次调用ThreadLocal.get方法时，会调用initialValue获取初始值</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Integer <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Random().nextInt();</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">public</span> Integer <span class="title">getData</span><span class="params">()</span></span>&#123;</div><div class="line">    Integer integer = dataHolder.get();</div><div class="line">    <span class="keyword">return</span> integer;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(<span class="keyword">int</span> data)</span></span>&#123;</div><div class="line">    dataHolder.set(data);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="不变性"><a href="#不变性" class="headerlink" title="不变性"></a>不变性</h2><p>不可变对象：对象在被创建后状态不能被修改。</p>
<p>线程安全性是不可变对象的固有属性。</p>
<p>不可变对象一定是线程安全的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Immutable</span></div><div class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreeStooges</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; stooges = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreeStooges</span><span class="params">()</span> </span>&#123;</div><div class="line">        stooges.add(<span class="string">"Moe"</span>);</div><div class="line">        stooges.add(<span class="string">"Larry"</span>);</div><div class="line">        stooges.add(<span class="string">"Curly"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStooge</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> stooges.contains(name);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getStoogeNames</span><span class="params">()</span> </span>&#123;</div><div class="line">        List&lt;String&gt; stooges = <span class="keyword">new</span> Vector&lt;String&gt;();</div><div class="line">        stooges.add(<span class="string">"Moe"</span>);</div><div class="line">        stooges.add(<span class="string">"Larry"</span>);</div><div class="line">        stooges.add(<span class="string">"Curly"</span>);</div><div class="line">        <span class="keyword">return</span> stooges.toString();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>实现不可变对象方法，参考《EffectiveJava》tip-15</p>
</blockquote>
<h3 id="Final域"><a href="#Final域" class="headerlink" title="Final域"></a>Final域</h3><p>final类型的域是不能修改的</p>
<p>java内存模型中，final域有着特殊的语义。<br>final域能确保<code>初始化过程</code>的安全性，共享这些对象时无需同步。</p>
<p>初始化安全性只能保证通过final域<code>可达</code>的值从构造过程完成时开始的可见性。<br>对于通过非final域可达的值，或在<code>构造过程完成后</code>可能<code>改变</code>的值，必须采用同步确保可见性。</p>
<p>除非需要某个域是可变的，否则应将其声明为final域</p>
<h3 id="使用volatile类型发布不可变对象"><a href="#使用volatile类型发布不可变对象" class="headerlink" title="使用volatile类型发布不可变对象"></a>使用volatile类型发布不可变对象</h3><p>某些情况下，不可变对象能提供一种弱形式的原子性</p>
<p>需要对一组相关数据以原子方式执行某个操作时，<br>可以考虑创建一个不可变的类来包含这些数据。</p>
<h2 id="安全发布"><a href="#安全发布" class="headerlink" title="安全发布"></a>安全发布</h2><p>多线程间共享对象，必须确保安全地进行共享。</p>
<h3 id="不正确的发布：正确的对象被破坏"><a href="#不正确的发布：正确的对象被破坏" class="headerlink" title="不正确的发布：正确的对象被破坏"></a>不正确的发布：正确的对象被破坏</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StuffIntoPublic</span> </span>&#123;</div><div class="line">    <span class="comment">//不安全发布</span></div><div class="line">    <span class="keyword">public</span> Holder holder;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</div><div class="line">        holder = <span class="keyword">new</span> Holder(<span class="number">42</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Holder</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> n;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Holder</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.n = n;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">assertSanity</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (n != n)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"This statement is false."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>问题并不在于Holder本身，而是在于Holder类未被安全的发布。</p>
<p>两种不安全情况：</p>
<ul>
<li>其他线程可能看到Holder域是一个失效值。</li>
<li>其他线程可能看到Holder引用的值是最新的，但Holder状态的值却是失效的。</li>
</ul>
<p>由于未被正确发布，另一个线程调用assertSanity()将抛出AssertionError（不理解）</p>
<h3 id="不可变对象与初始化安全性"><a href="#不可变对象与初始化安全性" class="headerlink" title="不可变对象与初始化安全性"></a>不可变对象与初始化安全性</h3><p>java内存模型为不可变对象的共享提供了特殊的初始化安全性保证。</p>
<p>即使发布不可变对象的引用时没有使用同步，仍然可以安全的访问该对象。</p>
<h3 id="安全发布的常用模式"><a href="#安全发布的常用模式" class="headerlink" title="安全发布的常用模式"></a>安全发布的常用模式</h3><p>安全地发布一个对象，对象地<code>引用</code>以及对象的<code>状态</code>必须同时对其他线程可见。</p>
<p><code>正确构造</code>的对象可以通过以下方式来安全发布：</p>
<ul>
<li><code>静态初始化函数</code>中初始化一个对象引用</li>
<li>对象引用保存到<code>volatile</code>类型域或<code>AtomicReferance</code>对象中</li>
<li>对象引用保存到某个正确构造对象的<code>final</code>域中</li>
<li>对象引用保存到一个<code>由锁保护</code>的域中</li>
</ul>
<p>线程安全容器通过将对象应用保存在由锁保护的域中，<br>保证对象安全发布。</p>
<p>静态初始化器由JVM在类初始化阶段执行，即在类被加载后并且被线程使用之前。</p>
<p>由于JVM将在初始化期间获得一个锁，<br>并且每个线程都至少获取一次这个锁以确保这个类已经加载，<br>因此在静态初始化期间，内存写入操作将自动对所有线程可见。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ThreadSafe</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EagerInitialization</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Resource resource = <span class="keyword">new</span> Resource();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Resource <span class="title">getResource</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> resource;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Resource</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="事实不可变对象"><a href="#事实不可变对象" class="headerlink" title="事实不可变对象"></a>事实不可变对象</h3><p>事实不可变对象：对象从技术上看是可变的，但其状态在发布后不会再改变。</p>
<p>没有额外同步的情况下，任何线程都可以安全地使用<code>被安全发布</code>的事实不可变对象。</p>
<h3 id="可变对象"><a href="#可变对象" class="headerlink" title="可变对象"></a>可变对象</h3><p>安全发布只能确保<code>发布当时</code>状态的可见性。</p>
<p>可变对象每次访问都需要使用同步来确保<code>后续修改</code>操作的可见性。</p>
<h3 id="安全的共享对象"><a href="#安全的共享对象" class="headerlink" title="安全的共享对象"></a>安全的共享对象</h3><ul>
<li>不可变对象可以通过任意机制发布</li>
<li>事实不可变对象必须通过安全方式发布</li>
<li>可变对象必须通过安全方式发布，并且必须线程安全的或由锁保护起来</li>
</ul>
<h1 id="基础构建模块"><a href="#基础构建模块" class="headerlink" title="基础构建模块"></a>基础构建模块</h1><h2 id="同步工具类"><a href="#同步工具类" class="headerlink" title="同步工具类"></a>同步工具类</h2><h3 id="锁闭"><a href="#锁闭" class="headerlink" title="锁闭"></a>锁闭</h3><p>锁闭是一种同步工具，可以延迟线程的进度<code>直到其到达终止状态</code>。</p>
<p>锁闭可以用来确保某些活动<code>直到其他活动都完成</code>才执行。<br>例如：确保某个计算在其所需要的所有资源都初始化之后继续执行。</p>
<p>锁闭是一次性对象，一旦进入终止状态，就不能被重置。</p>
<p>CountDownLatch测试n个线程并发执行某个任务需要的时间。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentTimer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ConcurrentTimer</span><span class="params">()</span></span>&#123;&#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">time</span><span class="params">(ExecutorService executor, <span class="keyword">int</span> concurrency, <span class="keyword">final</span> Runnable action)</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</div><div class="line">        <span class="keyword">final</span> CountDownLatch ready = <span class="keyword">new</span> CountDownLatch(concurrency);</div><div class="line">        <span class="keyword">final</span> CountDownLatch start = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</div><div class="line">        <span class="keyword">final</span> CountDownLatch done = <span class="keyword">new</span> CountDownLatch(concurrency);</div><div class="line">        </div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; concurrency; i++)&#123;</div><div class="line">            <span class="keyword">try</span>&#123;</div><div class="line">                executor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                    </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        ready.countDown();</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            start.await();</div><div class="line">                            action.run();</div><div class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                            Thread.currentThread().interrupt();</div><div class="line">                            e.printStackTrace();</div><div class="line">                        &#125;<span class="keyword">finally</span> &#123;</div><div class="line">                            done.countDown();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;<span class="keyword">finally</span>&#123;</div><div class="line">                executor.shutdown();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        ready.await();</div><div class="line">        <span class="keyword">long</span> startNanos = System.nanoTime();</div><div class="line">        start.countDown();</div><div class="line">        done.await();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> System.nanoTime() - startNanos;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> concurrency = <span class="number">3</span>;</div><div class="line">        ExecutorService newCachedThreadPool = Executors.newCachedThreadPool();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            </div><div class="line">            <span class="keyword">long</span> timecost = time(newCachedThreadPool, concurrency, <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    System.out.println(<span class="string">"run..."</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            System.out.println(timecost);</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="FutureTask"><a href="#FutureTask" class="headerlink" title="FutureTask"></a>FutureTask</h2><p>FutureTask 也可以用做锁闭。<br>FutureTask 表示一种抽象的可生成结果的计算，通过Callable实现。</p>
<p>FutureTask 在Executor框架中表示异步任务。</p>
<p>FutureTask是Future、Runnable的合体。</p>
<p>Future.get() 如果任务已完成，立即返回结果；<br>否则，阻塞直到任务进入完成状态，然后返回结果或抛出异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"> FutureTask&lt;String&gt; futureTask = <span class="keyword">new</span> FutureTask&lt;String&gt;(<span class="keyword">new</span> Callable&lt;String&gt;() &#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"foo"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">new</span> Thread(futureTask).start();</div><div class="line"></div><div class="line">String result = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    result = futureTask.get();</div><div class="line">    System.out.println(result);</div><div class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h2><p>计数信号量(Counting Semaphore)<br>限制对资源的使用，或者同时执行某个指定操作的数量。</p>
<p>默认为非公平锁，可指定为公平锁。</p>
<p>Semaphore中管理着一组虚拟的许可(permit)，<br>许可初始数量可通过构造函数指定。</p>
<p>执行操作时先获得许可，使用之后释放许可。如果没有许可，acquire()将阻塞直到有许可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="comment">//创建许可</span></div><div class="line">semaphore.release();</div><div class="line">System.out.println(semaphore.availablePermits());</div><div class="line"></div><div class="line"><span class="comment">//获取许可</span></div><div class="line">semaphore.acquire();</div></pre></td></tr></table></figure>
<p>Semaphore <code>不会</code>将许可与线程关联起来，<br>一个线程获得的许可，可以在另一个线程中释放。<br>可以将acquire操作视为<code>消费</code>一个许可，release操作视为<code>创建</code>一个许可。</p>
<h2 id="栅栏"><a href="#栅栏" class="headerlink" title="栅栏"></a>栅栏</h2><p>栅栏(Barrier)能阻塞一组线程直到某个事件发生<br>Barrier 在释放等待线程后可以重用</p>
<p>用于并行迭代算法：将一个问题拆分成一系列相互独立的子问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentTimer2</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ConcurrentTimer2</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">time</span><span class="params">(ExecutorService executor, <span class="keyword">int</span> concurrency, <span class="keyword">final</span> Runnable action)</span></span></div><div class="line">            <span class="keyword">throws</span> InterruptedException, BrokenBarrierException &#123;</div><div class="line">        <span class="comment">// 使用栅栏控制并发</span></div><div class="line">        <span class="keyword">final</span> CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(concurrency + <span class="number">1</span>);</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; concurrency; i++) &#123;</div><div class="line">            executor.submit(<span class="keyword">new</span> Callable&lt;Void&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> Void <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                    barrier.await();</div><div class="line">                    action.run();</div><div class="line">                    barrier.await();</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        executor.shutdown();</div><div class="line"></div><div class="line">        barrier.await();</div><div class="line">        <span class="keyword">long</span> startNanos = System.nanoTime();</div><div class="line">        barrier.await();</div><div class="line">        <span class="keyword">return</span> System.nanoTime() - startNanos;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> concurrency = <span class="number">3</span>;</div><div class="line">        ExecutorService newCachedThreadPool = Executors.newCachedThreadPool();</div><div class="line">        <span class="keyword">long</span> timecost = <span class="number">0</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            timecost = time(newCachedThreadPool, concurrency, <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    System.out.println(<span class="string">"run..."</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (BrokenBarrierException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        System.out.println(timecost);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>在不涉及I/O操作和共享数据访问的计算问题中，<br>当线程数量等于CPU数量或CPU数量+1时将获得最优的吞吐量。</p>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>所有并发问题都可以归结为如何协调对并发状态的访问</li>
<li>不可变对象一定是线程安全的</li>
<li>保护同一个不可变性条件中的所有变量时，使用同一个锁。</li>
</ul>
<h1 id="任务执行"><a href="#任务执行" class="headerlink" title="任务执行"></a>任务执行</h1><h1 id="取消与关闭"><a href="#取消与关闭" class="headerlink" title="取消与关闭"></a>取消与关闭</h1><h1 id="线程池的了使用"><a href="#线程池的了使用" class="headerlink" title="线程池的了使用"></a>线程池的了使用</h1><h1 id="避免活跃性危险"><a href="#避免活跃性危险" class="headerlink" title="避免活跃性危险"></a>避免活跃性危险</h1><p>Java程序无法从死锁中恢复过来，在设计时一定要排除那些可能导致死锁出现的条件。</p>
<h2 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h2><p>当一个线程永远地持有一个锁，并且其他线程都尝试获得这个锁，<br>那么他们将永远被阻塞。</p>
<p>哲学家进餐问题：<br>5个哲学家，5只筷子，交替地进行思考和进餐。</p>
<p>解决办法：</p>
<ul>
<li>至多4个哲学家拿起左边筷子</li>
<li>奇数号科学家先拿左边筷子，再拿右边筷子；偶数号科学家相反。</li>
<li>仅当两支筷子均可用时，才允许他拿起筷子进餐。(只有一个哲学家取筷子、轮询锁)</li>
</ul>
<h3 id="锁顺序死锁"><a href="#锁顺序死锁" class="headerlink" title="锁顺序死锁"></a>锁顺序死锁</h3><p>原因：两个线程以不同的顺序获得2个锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeftRightDeadLock</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object left = <span class="keyword">new</span> Object();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object right = <span class="keyword">new</span> Object();</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">leftRight</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (left) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (right) &#123;</div><div class="line">                <span class="comment">//doSomething</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rightLeft</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (right) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (left) &#123;</div><div class="line">                <span class="comment">//doSomething</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所有线程以固定的顺序来获得锁，就不会出现锁顺序死锁。</p>
<h3 id="动态顺序死锁"><a href="#动态顺序死锁" class="headerlink" title="动态顺序死锁"></a>动态顺序死锁</h3><p>使用方法传入的两个参数作为锁对象。</p>
<p>解决方法：<br>使用System.identityHashCode()来定义锁的顺序，<br>极少数情况下，两个对象有相同的散列值，可使用加时赛（TieBreaking）锁，<br>从而保证只有一个线程以未知的顺序获得两个锁。</p>
<p>若参数对象包含唯一的、不可变的，并且具备比较性的属性，<br>可通过该属性决定获得锁的顺序。</p>
<h3 id="协作对象之间发生的死锁"><a href="#协作对象之间发生的死锁" class="headerlink" title="协作对象之间发生的死锁"></a>协作对象之间发生的死锁</h3><p>持有锁时调用某个外部方法，外部方法中可能获取其他锁，<br>或阻塞时间过长，导致其他线程无法及时获得当前被持有的锁。</p>
<h3 id="开放调用"><a href="#开放调用" class="headerlink" title="开放调用"></a>开放调用</h3><p>调用某个方法时不持有锁，称为开放调用。</p>
<p>通过开放调用避免在相互协作的对象之间产生死锁。</p>
<p>在程序中尽量使用开放调用。<br>开放调用的程序更易于进行死锁分析。</p>
<h2 id="死锁避免与诊断"><a href="#死锁避免与诊断" class="headerlink" title="死锁避免与诊断"></a>死锁避免与诊断</h2><ul>
<li>尽量减少潜在的加锁交互数量</li>
<li>尽可能使用开放调用</li>
</ul>
<h3 id="支持定时的锁"><a href="#支持定时的锁" class="headerlink" title="支持定时的锁"></a>支持定时的锁</h3><p>使用轮询锁、定时锁代替内置锁</p>
<h3 id="通过线程转储信息来分析死锁"><a href="#通过线程转储信息来分析死锁" class="headerlink" title="通过线程转储信息来分析死锁"></a>通过线程转储信息来分析死锁</h3><p>在生成线程转储之前，JVM将在等待关系图中通过搜索循环来找出死锁。</p>
<h2 id="其他活跃性危险"><a href="#其他活跃性危险" class="headerlink" title="其他活跃性危险"></a>其他活跃性危险</h2><p>饥饿、丢失信号、活锁</p>
<h3 id="饥饿"><a href="#饥饿" class="headerlink" title="饥饿"></a>饥饿</h3><p>当线程由于无法访问它所需要的资源而不能继续执行时，就发生了“饥饿”。</p>
<p>要尽量避免使用线程优先级，这会增加平台依赖性，<br>并可能导致活跃性问题。<br>大多数并发程序中，都可以使用默认的线程优先级。</p>
<h3 id="活锁"><a href="#活锁" class="headerlink" title="活锁"></a>活锁</h3><p>多个相互协作的线程都对彼此进行响应从而修改各自的状态，<br>并使得任何一个线程都无法继续执行时，就发生了活锁。</p>
<p>通过等待随机长度的时间和回退可以有效地避免活锁的发生。</p>
<h3 id="丢失信号"><a href="#丢失信号" class="headerlink" title="丢失信号"></a>丢失信号</h3><p>线程等待一个已经为真的条件，但开始等待之前没有检查条件谓词。</p>
<p>如：没有在调用wait之前检查条件谓词。</p>
<h1 id="性能与可伸缩性"><a href="#性能与可伸缩性" class="headerlink" title="性能与可伸缩性"></a>性能与可伸缩性</h1><p>线程的主要目的：提升程序的运行性能。<br>线程可在运行现有任务时立即开始新的任务，提升系统响应性。</p>
<h2 id="对性能的思考"><a href="#对性能的思考" class="headerlink" title="对性能的思考"></a>对性能的思考</h2><p>多线程总会引入一些额外的性能开销：</p>
<ul>
<li>线程之间的协调（加锁、触发信号、内存同步）</li>
<li>增加上下文切换</li>
<li>线程的创建和销毁</li>
<li>线程的调度</li>
</ul>
<h2 id="性能与可伸缩性-1"><a href="#性能与可伸缩性-1" class="headerlink" title="性能与可伸缩性"></a>性能与可伸缩性</h2><p>伸缩性：增加计算资源时，程序吞吐量或处理能力相应增加。</p>
<p>性能调优：用更小的代价完成相同的工作（缓存、算法）。<br>可伸缩性调优：设法将问题的计算并行化，从而能利用更多的计算资源。</p>
<h2 id="评估各种性能权衡因素"><a href="#评估各种性能权衡因素" class="headerlink" title="评估各种性能权衡因素"></a>评估各种性能权衡因素</h2><p>避免不成熟的优化。<br>首先使程序正确，然后在提高运行速度——如果运行得不够快。</p>
<p>对性能调优时，一定要有明确的性能需求，<br>还需要一个测试程序以及真实的配置和负载等环境。</p>
<h2 id="Amdahl定律"><a href="#Amdahl定律" class="headerlink" title="Amdahl定律"></a>Amdahl定律</h2><p>程序的可伸缩性取决于所有代码中必须被串行执行的代码比例。</p>
<h2 id="减少锁的竞争"><a href="#减少锁的竞争" class="headerlink" title="减少锁的竞争"></a>减少锁的竞争</h2><p>减少锁的竞争能够提高性能和可伸缩性。</p>
<h3 id="缩小锁的范围"><a href="#缩小锁的范围" class="headerlink" title="缩小锁的范围"></a>缩小锁的范围</h3><p>尽可能缩短锁的持有时间。</p>
<p>同步需要一定的开销，<br>把一个同步代码块分解为多个同步代码块时，<br>反而会对性能提升产生负面影响。</p>
<p>仅当可以将一些“大量”计算或阻塞操作从同步代码块中移出时，<br>才应该考虑分解同步代码块。</p>
<h3 id="减小锁的粒度"><a href="#减小锁的粒度" class="headerlink" title="减小锁的粒度"></a>减小锁的粒度</h3><p>另一个减小锁的持有时间的方式：降低线程请求锁的频率（从而减小发生竞争的可能性）。<br>可通过锁分解和锁分段实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ThreadSafe</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerStatusBeforeSplit</span> </span>&#123;</div><div class="line">    <span class="meta">@GuardedBy</span>(<span class="string">"this"</span>) <span class="keyword">public</span> <span class="keyword">final</span> Set&lt;String&gt; users;</div><div class="line">    <span class="meta">@GuardedBy</span>(<span class="string">"this"</span>) <span class="keyword">public</span> <span class="keyword">final</span> Set&lt;String&gt; queries;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ThreadSafe</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerStatusAfterSplit</span> </span>&#123;</div><div class="line">    <span class="meta">@GuardedBy</span>(<span class="string">"users"</span>) <span class="keyword">public</span> <span class="keyword">final</span> Set&lt;String&gt; users;</div><div class="line">    <span class="meta">@GuardedBy</span>(<span class="string">"queries"</span>) <span class="keyword">public</span> <span class="keyword">final</span> Set&lt;String&gt; queries;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="锁分段"><a href="#锁分段" class="headerlink" title="锁分段"></a>锁分段</h3><p>ConcurrentHashMap使用了包含16个锁的数组，<br>每个锁保护所有散列桶的1/16。</p>
<p>锁分段劣势：获取所有锁实现独占访问困难且开销高。</p>
<p>ConcurrentHashMap中size():<br>将每个分段中元素数量相加，而不是维护一个全局计数（避免热点域）。<br>每个分段维护一个独立计数，通过每个分段的锁维护这个值。</p>
<h3 id="一些替代独占锁的方法"><a href="#一些替代独占锁的方法" class="headerlink" title="一些替代独占锁的方法"></a>一些替代独占锁的方法</h3><p>并发容器、读-写锁、不可变对象、原子变量。</p>
<h1 id="显式锁"><a href="#显式锁" class="headerlink" title="显式锁"></a>显式锁</h1><p>使用一致的锁协议协调对共享状态的访问，能采用独占方式访问变量，<br>对变量的任何修改对随后获得这个锁的线程都可见。</p>
<p>显式锁和内置锁在加锁和解锁等操作上有相同的内存语义。</p>
<p>ReentrantLock并不是一种替代内置锁的方法，<br>而是当内置加锁机制不适用时，作为一种可选择的高级功能。</p>
<p>Reentrantlock实现了Lock接口，<br>提供了与synchronized相同的的互斥性和内存可见性，<br>提供了可重入的加锁语义。</p>
<p>必须在finally块中释放锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Lock lock = <span class="keyword">new</span> ReentrantLock();<span class="comment">//获取锁</span></div><div class="line"></div><div class="line">lock.lock();</div><div class="line"></div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    <span class="comment">//更新对象状态</span></div><div class="line">&#125;<span class="keyword">finally</span>&#123;</div><div class="line">    lock.unlock();<span class="comment">//释放锁</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="轮询锁和定时锁"><a href="#轮询锁和定时锁" class="headerlink" title="轮询锁和定时锁"></a>轮询锁和定时锁</h2><p>内置锁中，死锁是一个严重的问题，<br>恢复程序的唯一办法是重新启动程序，<br>防止死锁的唯一办法是构造程序时避免出现不一致的锁顺序。</p>
<p>定时锁和可轮询锁提供了另一种选择：避免死锁的发生。</p>
<p>定时锁示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Lock lock = <span class="keyword">new</span> ReentrantLock();<span class="comment">//获取锁</span></div><div class="line"><span class="comment">//时长</span></div><div class="line"><span class="keyword">long</span> nanosToLock = <span class="number">1000</span>;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (lock.tryLock(nanosToLock, TimeUnit.NANOSECONDS))&#123;</div><div class="line">    <span class="keyword">try</span>&#123;</div><div class="line">        <span class="comment">//更新对象状态</span></div><div class="line">    &#125;<span class="keyword">finally</span>&#123;</div><div class="line">        lock.unlock();<span class="comment">//释放锁</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>轮询锁示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">transferMoney</span><span class="params">(Account fromAcct,</span></span></div><div class="line">                             Account toAcct,</div><div class="line">                             DollarAmount amount,</div><div class="line">                             <span class="keyword">long</span> timeout,</div><div class="line">                             TimeUnit unit)</div><div class="line">        <span class="keyword">throws</span> InsufficientFundsException, InterruptedException &#123;</div><div class="line">    <span class="comment">//轮询固定延时</span></div><div class="line">    <span class="keyword">long</span> fixedDelay = getFixedDelayComponentNanos(timeout, unit);</div><div class="line">    <span class="comment">//轮询随机延时</span></div><div class="line">    <span class="keyword">long</span> randMod = getRandomDelayModulusNanos(timeout, unit);</div><div class="line">    <span class="comment">//计算超时时间</span></div><div class="line">    <span class="keyword">long</span> stopTime = System.nanoTime() + unit.toNanos(timeout);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (fromAcct.lock.tryLock()) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">if</span> (toAcct.lock.tryLock()) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        fromAcct.debit(amount);</div><div class="line">                        toAcct.credit(amount);</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        toAcct.lock.unlock();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                fromAcct.lock.unlock();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (System.nanoTime() &lt; stopTime)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        NANOSECONDS.sleep(fixedDelay + rnd.nextLong() % randMod);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="可中断的锁"><a href="#可中断的锁" class="headerlink" title="可中断的锁"></a>可中断的锁</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Lock lock = <span class="keyword">new</span> ReentrantLock();<span class="comment">//获取锁</span></div><div class="line"></div><div class="line">lock.lockInterruptibly();</div><div class="line"></div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    <span class="comment">//更新对象状态</span></div><div class="line">&#125;<span class="keyword">finally</span>&#123;</div><div class="line">    lock.unlock();<span class="comment">//释放锁</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="非块状结构锁"><a href="#非块状结构锁" class="headerlink" title="非块状结构锁"></a>非块状结构锁</h2><p>使用细粒度锁保护链表，<br>每个链表节点一个独立的锁，<br>使不同的线程能独立地对链表的不同部分进行操作。</p>
<p>每个节点的锁将保护链接指针及该节点中存储的数据。<br>遍历或修改链表时，必须持有节点上的锁，<br>直到获得下一个节点的锁，才能是释放前一个节点的锁。</p>
<h2 id="公平性"><a href="#公平性" class="headerlink" title="公平性"></a>公平性</h2><p>ReentrantLock提供两种公平性选择：非公平锁(默认)、公平锁</p>
<blockquote>
<p>注：即使公平锁，tryLock()仍然会插队。</p>
</blockquote>
<p>公平性由于在<code>挂起线程</code>和<code>恢复线程</code>时存在的开销而极大地降低性能。</p>
<p>与默认的ReentrantLock一样，内置锁不提供确定的公平性保证。</p>
<h2 id="在synchronized和ReentrantLock之间选择"><a href="#在synchronized和ReentrantLock之间选择" class="headerlink" title="在synchronized和ReentrantLock之间选择"></a>在synchronized和ReentrantLock之间选择</h2><p>ReentrantLock在性能上似乎优于内置锁，<br>其中Java 6中略有胜出，而在java 5中则是远远胜出。</p>
<p>与显式锁相比，内置锁任然具有很多的优势。<br>内置锁为许多开发人员熟悉，并且简单紧凑。</p>
<p>未来更可能会提升synchronized性能。<br>因为synchronized是JVM的内置属性，它能执行一些优化。</p>
<p>线程转储能给出在哪些线程获得了哪些锁，并能够检测和识别发生死锁的线程。<br>线程转储中显式锁信息比内置锁信息精确度低。<br>内置锁与<code>栈帧</code>关联，显式锁与<code>线程</code>关联。</p>
<p>线程转储：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># windows Ctrl + Break</span></div><div class="line"><span class="comment"># Unix</span></div><div class="line"><span class="built_in">kill</span> -3 pid</div></pre></td></tr></table></figure>
<p>应该优先使用sysnchronized，<br>仅当内置锁不能满足需求时，才可以考虑使用ReentrantLock。</p>
<p>实现 定时锁、轮询锁、可中断锁、非块状锁和公平锁，<br>可以考虑使用ReentrantLock。</p>
<h2 id="读写锁"><a href="#读写锁" class="headerlink" title="读写锁"></a>读写锁</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ReadWriteLock</span> </span>&#123;</div><div class="line">    <span class="function">Lock <span class="title">readLock</span><span class="params">()</span></span>;</div><div class="line">    <span class="function">Lock <span class="title">writeLock</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>读/写锁：<br>一个资源可以被<code>多个读</code>操作访问，或被<code>一个写</code>操作访问，但两者不能同时进行。</p>
<p>在多处理器系统上频繁读取的数据结构，读-写锁能够提升性能。</p>
<p>ReentrantReadWriteLock特点：</p>
<ul>
<li>支持公平锁和非公平锁</li>
<li>可重入</li>
<li>写锁可降级为读锁，读锁不可升级为写锁。</li>
</ul>
<p>线程插队：<br>公平锁中，等待时间最长的线程将优先获得锁。<br>如果锁由读线程持有，另一个线程在请求写锁，<br>那么其他读线程都不能获得读取锁，直到写线程使用完并释放写锁。</p>
<p>非公平锁中，线程获得访问许可的顺序是不确定的。</p>
<p>写锁降级为读锁：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock();<span class="comment">// 读写锁  </span></div><div class="line">lock.writeLock().lock();  </div><div class="line"></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">try</span> &#123;  </div><div class="line">        <span class="comment">// do something</span></div><div class="line">    &#125; <span class="keyword">finally</span> &#123;  </div><div class="line">        <span class="comment">// 重入——&gt;降级锁的步骤：先获取写锁，然后获取读锁，最后释放写锁（重点）  </span></div><div class="line">        lock.readLock().lock();  </div><div class="line">        lock.writeLock().unlock();  </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// do something</span></div><div class="line">&#125; <span class="keyword">finally</span>&#123;</div><div class="line">    lock.readLock().unlock();  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>读锁不能升级为写锁，<br>两个线程在不释放读锁情况下，同时请求写锁将产生死锁。</p>
<p>写入锁提供了条件变量(Condition)的支持，<br>读取锁不允许获取条件变量，将得到一个UnsupportedOperationException异常。</p>
<p>ReentrantReadWriteLock实现线程安全的Map示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadWriteMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;K,V&gt; map;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock r = lock.readLock();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock w = lock.writeLock();</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReadWriteMap</span><span class="params">(Map&lt;K,V&gt; map)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.map = map;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span></span>&#123;</div><div class="line">        w.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> map.put(key, value);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            w.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span></span>&#123;</div><div class="line">        r.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> map.get(key);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            r.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>如果需要基于散列的映射，可以使用ConcurrentHashMap；<br>需要LinkedHashMap并发访问，可以使用使用读写锁包装。</p>
</blockquote>
<h1 id="原子变量与非阻塞同步机制"><a href="#原子变量与非阻塞同步机制" class="headerlink" title="原子变量与非阻塞同步机制"></a>原子变量与非阻塞同步机制</h1><p>非阻塞算法用底层的<code>原子机器命令</code>（如比较并交换命令）确保数据并发访问的一致性。</p>
<p>非阻塞算法不存在死锁和优先级反转问题。</p>
<p>原子变量提供了与volatile变量相同的内存语义。</p>
<h2 id="锁的劣势"><a href="#锁的劣势" class="headerlink" title="锁的劣势"></a>锁的劣势</h2><ul>
<li>线程挂起和恢复开销高，且存在较长时间中断</li>
<li>优先级反转（高优先级等待低优先级持有的锁）</li>
<li>持有锁线程永久阻塞，影响其他线程</li>
<li>对于细粒度操作(如计数器)锁是高开销机制</li>
</ul>
<h2 id="比较并交换"><a href="#比较并交换" class="headerlink" title="比较并交换"></a>比较并交换</h2><p>CAS包含3个操作数————内存位置V、比较值A、拟写入新值B</p>
<p>当且仅当V等于A时，CAS才会通过原子方式用新值B更新V，否则不会执行任何操作。</p>
<p>CAS含义：<br>“我认为V的值应该为A，如果是，那么将V的值更新为B，<br>否则不修改并告诉V的值实际为多少。”</p>
<p>由于CAS能检测到来自其他线程的干扰，<br>因此即使不使用锁也能够实现原子的读-改-写操作。</p>
<h2 id="非阻塞计数器"><a href="#非阻塞计数器" class="headerlink" title="非阻塞计数器"></a>非阻塞计数器</h2><p>CAS的主要缺点：需调用者处理处理竞争问题（通过重试、回退、放弃）</p>
<p>事实上，CAS最大的缺陷在于难以围绕着CAS正确的构建外部算法。</p>
<h2 id="原子变量类"><a href="#原子变量类" class="headerlink" title="原子变量类"></a>原子变量类</h2><p>原子变量的compareAndSet()像锁机制一样，<br>既能提供原子性，又能提供可见性。</p>
<p>12个原子变量类，分为4组:</p>
<ul>
<li>标量（Scalar）</li>
<li>更新器类</li>
<li>数组类</li>
<li>复合变量类</li>
</ul>
<p>标量类AtomicInteger、AtomicLong、AtomicBoolean、AtomicReference，都支持CAS，<br>AtomicInteger、AtomicLong还支持算术运算。</p>
<p>模拟其他基本类型的原子变量，<br>可将short或byte转为int，<br>使用Float.floatToIntBits()、Double.doubleToLongBits()转换浮点数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">AtomicInteger count = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</div><div class="line"><span class="comment">//以原子方式将当前值加 1</span></div><div class="line"><span class="keyword">int</span> incrementAndGet = count.incrementAndGet();</div><div class="line">System.out.println(incrementAndGet);</div><div class="line"></div><div class="line"><span class="keyword">int</span> x = count.get();</div><div class="line"><span class="comment">// 如果当前值 == 预期值，则以原子方式将该值设置为给定的更新值。</span></div><div class="line"><span class="keyword">boolean</span> compareAndSet = count.compareAndSet(x,x+<span class="number">10</span>);</div><div class="line">System.out.println(count.get());</div></pre></td></tr></table></figure>
<p>原子数组类AtomicIntegerArray、AtomicLongArray、AtomicReferenceArray，<br>为数组元素提供了volatile类型的访问语义。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">AtomicReferenceArray&lt;Person&gt; atomicReferenceArray = <span class="keyword">new</span> AtomicReferenceArray&lt;Person&gt;(<span class="number">10</span>);</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; atomicReferenceArray.length(); i++) &#123;  </div><div class="line">    <span class="keyword">boolean</span> compareAndSet = atomicReferenceArray.compareAndSet(i, <span class="keyword">null</span>, <span class="keyword">new</span> Person());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//设置AtomicInteger</span></div><div class="line"><span class="keyword">int</span> current, next;</div><div class="line"><span class="keyword">do</span> &#123;</div><div class="line">    current = get();</div><div class="line">    next = current + delta;</div><div class="line">&#125; <span class="keyword">while</span> (!compareAndSet(current, next));</div></pre></td></tr></table></figure>
<p>原子变量没有重新定义hashCode与equals方法，每个实例都是不同的。<br>与其他可变对象相同，他们也不宜用做基于散列的容器中的键值。</p>
<p>原子域更新器：AtomicIntegerFieldUpdater、AtomicLongFieldUpdater、AtomicReferenceFieldUpdater</p>
<p>能够在已有的volatile域上使用CAS</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">AtomicReferenceFieldUpdater&lt;InnerPerson, String&gt; nameUpdater = AtomicReferenceFieldUpdater.newUpdater(InnerPerson.class, String.class, <span class="string">"name"</span>);</div><div class="line">       </div><div class="line">InnerPerson person = <span class="keyword">new</span> InnerPerson(<span class="string">"sunday"</span>);</div><div class="line">String personName = person.name;</div><div class="line">nameUpdater.compareAndSet(person, personName, <span class="string">"wangdz"</span>);</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerPerson</span></span>&#123;</div><div class="line">    <span class="comment">// 字段为非private的volatile类型</span></div><div class="line">    <span class="keyword">volatile</span> String name;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InnerPerson</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InnerPerson</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"InnerPerson [name="</span> + name + <span class="string">"]"</span>;</div><div class="line">    &#125;   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="性能比较：锁与原子变量"><a href="#性能比较：锁与原子变量" class="headerlink" title="性能比较：锁与原子变量"></a>性能比较：锁与原子变量</h2><p>原子变量在可伸缩性上高于锁。</p>
<p>在中低程度竞争下，原子变量能提供更高的可伸缩性。<br>在高强度竞争下，锁能够更高效的避免竞争。</p>
<p>若可以使用ThreadLocal避免使用共享状态，开销更小。<br>可以通过提高处理竞争的效率提高可伸缩性，只有完全消除竞争，才能实现真正的可伸缩性。</p>
<h2 id="非阻塞算法"><a href="#非阻塞算法" class="headerlink" title="非阻塞算法"></a>非阻塞算法</h2><p>若某算法中，一个线程的失败或挂起不会导致其他线程的失败或挂起，<br>这种算法被称为非阻塞算法。</p>
<p>非阻塞算法通常不会出现死锁和优先级反转问题，<br>可能会出现饥饿和活锁问题（因为算法中反复地重试）</p>
<h2 id="非阻塞的栈"><a href="#非阻塞的栈" class="headerlink" title="非阻塞的栈"></a>非阻塞的栈</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentStack</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">    AtomicReference&lt;Node&lt;E&gt;&gt; top = <span class="keyword">new</span> AtomicReference&lt;Node&lt;E&gt;&gt;();</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(E item)</span></span>&#123;</div><div class="line">        Node&lt;E&gt; newTop = <span class="keyword">new</span> Node&lt;E&gt;(item);</div><div class="line">        Node&lt;E&gt; oldTop;</div><div class="line">        </div><div class="line">        <span class="keyword">do</span>&#123;</div><div class="line">            oldTop = top.get();</div><div class="line">            newTop.next = oldTop;</div><div class="line">        &#125;<span class="keyword">while</span>(!top.compareAndSet(oldTop, newTop));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt;</span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">final</span> E item;</div><div class="line">        <span class="keyword">public</span> Node&lt;E&gt; next;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(E item)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.item = item;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="非阻塞的链表"><a href="#非阻塞的链表" class="headerlink" title="非阻塞的链表"></a>非阻塞的链表</h2><p>技巧一：<br>即使一个包含多个步骤的更新操作，<br>也要确保数据结构总是处于一致的状态。</p>
<p>技巧二：<br>如果线程B到达时发现线程A正在修改数据结构，<br>那么数据结构中应该有足够多的信息，<br>使得线程B能够完成A的更新操作。</p>
<p>添加元素步骤（更新两个指针）：</p>
<ul>
<li>更新最后一个元素next指针，将新节点链接到列表队尾</li>
<li>更新尾节点</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ThreadSafe</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedQueue</span> &lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> &lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">final</span> E item;</div><div class="line">        <span class="keyword">final</span> AtomicReference&lt;LinkedQueue.Node&lt;E&gt;&gt; next;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(E item, LinkedQueue.Node&lt;E&gt; next)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.item = item;</div><div class="line">            <span class="keyword">this</span>.next = <span class="keyword">new</span> AtomicReference&lt;LinkedQueue.Node&lt;E&gt;&gt;(next);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 哑节点，初始化时头节点和尾节点都指向该节点</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkedQueue.Node&lt;E&gt; dummy = <span class="keyword">new</span> LinkedQueue.Node&lt;E&gt;(<span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;LinkedQueue.Node&lt;E&gt;&gt; head</div><div class="line">            = <span class="keyword">new</span> AtomicReference&lt;LinkedQueue.Node&lt;E&gt;&gt;(dummy);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;LinkedQueue.Node&lt;E&gt;&gt; tail</div><div class="line">            = <span class="keyword">new</span> AtomicReference&lt;LinkedQueue.Node&lt;E&gt;&gt;(dummy);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">put</span><span class="params">(E item)</span> </span>&#123;</div><div class="line">        LinkedQueue.Node&lt;E&gt; newNode = <span class="keyword">new</span> LinkedQueue.Node&lt;E&gt;(item, <span class="keyword">null</span>);</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            LinkedQueue.Node&lt;E&gt; curTail = tail.get();</div><div class="line">            LinkedQueue.Node&lt;E&gt; tailNext = curTail.next.get();</div><div class="line">            <span class="keyword">if</span> (curTail == tail.get()) &#123;</div><div class="line">                <span class="keyword">if</span> (tailNext != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">// 队列处于中间状态，推进尾节点</span></div><div class="line">                    tail.compareAndSet(curTail, tailNext);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// 处于稳定状态，尝试插入新节点</span></div><div class="line">                    <span class="keyword">if</span> (curTail.next.compareAndSet(<span class="keyword">null</span>, newNode)) &#123;</div><div class="line">                        <span class="comment">// 插入成功，尝试推进尾节点</span></div><div class="line">                        tail.compareAndSet(curTail, newNode);</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>LinkedQueue说明了ConcurrentLinkedQueue使用的算法，<br>不同的是ConcurrentLinkedQueue中没有使用原子引用表示Node，<br>而是使用volatile类型引用，并通过原子域更新器进行更新，<br>以避免AtomicReference创建，提升性能。</p>
<h2 id="ABA问题"><a href="#ABA问题" class="headerlink" title="ABA问题"></a>ABA问题</h2><p>如果算法的<code>节点可以被循环使用</code>，<br>那么在使用“比较并交换”指令时可能出现这种问题(主要在没有垃圾回收机制的环境中)。</p>
<p>某些算法中，如果V值首先由A变成B，再由B变成A，<br>那么仍然被认为发生了变化，并需要执行算法中某些步骤。</p>
<p>AtomicMarkableReference 维护带有标记位的对象引用，可以原子方式对其进行更新<br>AtomicStampedReference 维护带有整数“标志”的对象引用，可以用原子方式对其进行更新</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">AtomicStampedReference&lt;Integer&gt; atomicStampedRef = <span class="keyword">new</span> AtomicStampedReference&lt;Integer&gt;(<span class="number">100</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="comment">// 获取对象引用和获取版本号，能否当前版本号为当前元素版本号的不变性? </span></div><div class="line">Integer reference = atomicStampedRef.getReference();</div><div class="line"><span class="keyword">int</span> stamp = atomicStampedRef.getStamp();</div><div class="line"></div><div class="line">Integer newReference = <span class="keyword">new</span> Integer(reference+<span class="number">1</span>);</div><div class="line"><span class="keyword">int</span> newStamp = stamp + <span class="number">1</span>;</div><div class="line"></div><div class="line">atomicStampedRef.compareAndSet(reference, newReference, stamp, newStamp);</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Effective Java]]></title>
      <url>http://xiaozhuang.github.io/2017/04/19/java-effective/</url>
      <content type="html"><![CDATA[<p>Effective Java2 笔记<br><a id="more"></a></p>
<h1 id="创建和销毁对象"><a href="#创建和销毁对象" class="headerlink" title="创建和销毁对象"></a>创建和销毁对象</h1><h2 id="考虑用静态工厂方法代替构造器"><a href="#考虑用静态工厂方法代替构造器" class="headerlink" title="考虑用静态工厂方法代替构造器"></a>考虑用静态工厂方法代替构造器</h2><p><code>tip-1</code><br>需要多个相同签名的构造器时，用静态工厂方法代替构造器</p>
<p>静态工厂方法惯用名称：</p>
<ul>
<li>valueOf</li>
<li>of</li>
<li>getInstance</li>
<li>newInstance</li>
<li>getType</li>
<li>newType</li>
</ul>
<h2 id="遇到多个构造器参数时考虑用构造器"><a href="#遇到多个构造器参数时考虑用构造器" class="headerlink" title="遇到多个构造器参数时考虑用构造器"></a>遇到多个构造器参数时考虑用构造器</h2><p><code>tip-2</code><br>Builder模式解决的问题</p>
<ul>
<li>构造器参数列表过长不易使用</li>
<li>JavaBeans模式阻止了把类做成不可变类的可能，也不易检查参数约束条件</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Date;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Baz</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Long id;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer age;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Date birthday;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Baz</span><span class="params">(Builder builder)</span></span>&#123;</div><div class="line">        id = builder.getId();</div><div class="line">        name = builder.getName();</div><div class="line">        age = builder.getAge();</div><div class="line">        birthday = builder.getBirthday();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> id;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span></div><div class="line">        return name;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> age;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getBirthday</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> birthday;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span></span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Long id;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line">        </div><div class="line">        <span class="keyword">private</span> Integer age;</div><div class="line">        <span class="keyword">private</span> Date birthday;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">(Long id, String name)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>();</div><div class="line">            <span class="keyword">this</span>.id = id;</div><div class="line">            <span class="keyword">this</span>.name = name;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> age;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">setAge</span><span class="params">(Integer age)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.age = age;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> Date <span class="title">getBirthday</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> birthday;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">setBirthday</span><span class="params">(Date birthday)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.birthday = birthday;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> id;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> name;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">public</span> Baz <span class="title">build</span><span class="params">()</span></span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Baz(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Baz baz = <span class="keyword">new</span> Baz.Builder(<span class="number">1000L</span>, <span class="string">"Baz"</span>).setAge(<span class="number">7</span>).setBirthday(<span class="keyword">new</span> Date()).build();</div><div class="line">        System.out.println(JSON.toJSON(baz));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>类的构造器或者静态工厂具有多个参数时，<code>Builder模式</code>就是不错的选择</p>
<h2 id="用私有构造器或者枚举类型强化Singleton属性"><a href="#用私有构造器或者枚举类型强化Singleton属性" class="headerlink" title="用私有构造器或者枚举类型强化Singleton属性"></a>用私有构造器或者枚举类型强化Singleton属性</h2><p><code>tip-3</code><br>私有构造器单例需要处理反射调用私有构造器攻击，且需声明所有实例域都是<code>transient</code>，并提供readResolve方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance = <span class="keyword">new</span> Singleton();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">readResolve</span><span class="params">()</span> <span class="keyword">throws</span> ObjectStreamException </span>&#123;  </div><div class="line">      <span class="comment">// instead of the object we're on,   </span></div><div class="line">      <span class="comment">// return the class variable INSTANCE  </span></div><div class="line">      <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>单元素枚举类型，无偿地提供了序列化机制，绝对防止多次实例化，即使是在面对复杂的序列化或 反射攻击的时候。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Employee &#123; <span class="comment">// changed "class" to "enum"</span></div><div class="line"></div><div class="line">   INSTANCE; <span class="comment">// added name of the (single) instance</span></div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">int</span> id; </div><div class="line">   <span class="keyword">private</span> String name; </div><div class="line">   Employee() &#123;&#125;</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> id; </div><div class="line">   &#125;</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">( <span class="keyword">int</span> id )</span> </span>&#123; </div><div class="line">      <span class="keyword">this</span>.id = id; </div><div class="line">   &#125; </div><div class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123; </div><div class="line">      <span class="keyword">return</span> name; </div><div class="line">   &#125; </div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">( String name )</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>.name = name; </div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>单元素的枚举类型已经成为实现Singleton的最佳方法</p>
<h2 id="避免创建不必要的对象"><a href="#避免创建不必要的对象" class="headerlink" title="避免创建不必要的对象"></a>避免创建不必要的对象</h2><p><code>tip-5</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 静态构造方法优先于构造器</span></div><div class="line">Boolean.valueOf(<span class="string">"true"</span>);</div></pre></td></tr></table></figure>
<p>优先使用基本类型而不是装箱的基本类型，要当心无意识的自动装箱</p>
<p>维护自己的对象池（object pool）来避免创建对象<code>并不是</code>一种好的做法</p>
<h2 id="消除过期的对象引用"><a href="#消除过期的对象引用" class="headerlink" title="消除过期的对象引用"></a>消除过期的对象引用</h2><p><code>tip-6</code></p>
<p>只要类自己管理内存，程序员就应该警惕内存泄漏问题</p>
<p>内存泄漏的另一个常见来源是<code>缓存</code></p>
<h2 id="避免使用终结方法"><a href="#避免使用终结方法" class="headerlink" title="避免使用终结方法"></a>避免使用终结方法</h2><p><code>tip-7</code><br>不应该依赖终结方法来更新重要的持久状态</p>
<p>使用终结方法有一个非常严重的（severe）性能损失</p>
<p>如果子类实现覆盖了超类的终结方法，但是忘了手工调用超类的终结方法，<br>那么超类的终结方法将永远也不会被调用</p>
<p>除非作为安全网，或者为了终止非关键的本地资源，否则不要使用终结方法</p>
<h1 id="对所有对象都通用的方法"><a href="#对所有对象都通用的方法" class="headerlink" title="对所有对象都通用的方法"></a>对所有对象都通用的方法</h1><h2 id="覆盖equals时请遵守通用约定"><a href="#覆盖equals时请遵守通用约定" class="headerlink" title="覆盖equals时请遵守通用约定"></a>覆盖equals时请遵守通用约定</h2><p><code>tip-8</code><br>equals方法的通用约定</p>
<ul>
<li>自反性</li>
<li>对称性</li>
<li>传递性</li>
<li>一致性  多次调用，一致地返回true或false</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line">    <span class="comment">//instanceof 第一个参数为null，无论第二个参数是哪种类型，都返回false</span></div><div class="line">    <span class="keyword">if</span>(!(obj <span class="keyword">instanceof</span> MyType))&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于非float 和 double类型的<code>基本类型域</code>，可以使用 == 操作符进行比较<br>float域，使用Float.compare方法<br>double域，使用Double.compare方法<br>数组域使用Arrays.equals方法</p>
<blockquote>
<p>如果 f1 和 f2 都表示 Float.NaN，那么即使 Float.NaN==Float.NaN 的值为 false，equals 方法也将返回 true<br>如果 f1 表示 +0.0f，而 f2 表示 -0.0f，或相反，那么即使 0.0f==-0.0f 的值为 true，equal 测试也将返回 false</p>
</blockquote>
<p>域的比较影响equals方法的性能，应该优先比较<code>最有可能不一致的域</code></p>
<p><code>不要</code>将equals声明中的Object对象替换为其他类型</p>
<h2 id="覆盖equals方法时总要覆盖hashCode"><a href="#覆盖equals方法时总要覆盖hashCode" class="headerlink" title="覆盖equals方法时总要覆盖hashCode"></a>覆盖equals方法时总要覆盖hashCode</h2><p><code>tip-9</code></p>
<ul>
<li>每个覆盖了equals方法的类中，也<code>必须</code>覆盖hashCode方法</li>
<li><p>相等的对象<code>必须</code>具有相等的散列码</p>
</li>
<li><p>hashCode计算必须排除equals比较计算中没有用到的任何域</p>
</li>
</ul>
<h2 id="始终要覆盖toString"><a href="#始终要覆盖toString" class="headerlink" title="始终要覆盖toString"></a>始终要覆盖toString</h2><p><code>tip-10</code></p>
<p>toString通用约定：<code>简洁</code>的，但<code>信息丰富</code>，并且<code>易于阅读</code>的表达形式。</p>
<p>toString方法应该返回对象中包含的<code>所有值得关注的信息</code>。</p>
<p>最好提供一个相匹配的静态工厂或构造器，以便在<code>对象</code>和他的<code>字符串表示法</code>之间转换。</p>
<p>toStrig方法间接提供了对象访问途径，应<code>避免暴露内部数据</code>。</p>
<h1 id="类和接口"><a href="#类和接口" class="headerlink" title="类和接口"></a>类和接口</h1><h2 id="使类和成员的可访问性最小"><a href="#使类和成员的可访问性最小" class="headerlink" title="使类和成员的可访问性最小"></a>使类和成员的可访问性最小</h2><p><code>tip-13</code><br>设计良好的模块会<code>隐藏所有的实现细节</code>，把它的API与它的实现清晰地隔离开来。</p>
<p><code>信息隐藏</code>可以有效地解除组成系统的各模块之间的耦合关系，<br>使得这些模块可以独立地开发、测试、优化、使用、理解和修改。</p>
<p>信息隐藏也降低了构建大型业务系统的风险。</p>
<p><code>尽可能地使每个类或成员不被外界访问</code><br>对于顶层(非嵌套的)类和接口，<code>只有两种</code>可能的访问级别：<br>包级私有的(package-private)和公有的(public)</p>
<p>如果包级私有的顶层类(或者接口)<code>只在某一个类的内部</code>被用到，<br>就应该考虑使它成为唯一使用它的那个类的<code>私有嵌套类</code>。</p>
<p>实例域<code>绝不能</code>是公有的，同样的建议也适用于静态域，只有静态常量可以为公有。</p>
<p>长度非零的数组总是可变的。<br>类具有公有的静态final数组域，或者返回这种域的访问方法，这几乎总是错误的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 可以返回数组的不可变列表</span></div><div class="line">Integer[] values = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</div><div class="line">List&lt;Integer&gt; asList = Collections.unmodifiableList(Arrays.asList(values));</div><div class="line"></div><div class="line"><span class="comment">// 或返回数组的拷贝</span></div><div class="line">Integer[] clone = values.clone();</div></pre></td></tr></table></figure>
<h2 id="在公有类中使用访问方法而非公有域"><a href="#在公有类中使用访问方法而非公有域" class="headerlink" title="在公有类中使用访问方法而非公有域"></a>在公有类中使用访问方法而非公有域</h2><p>如果类可以在它<code>所在的包的外部</code>进行访问，就提供访问方法</p>
<p>如果类是<code>包级私有的</code>，或者是<code>私有的嵌套类</code>，直接暴露他的数据域并没有本质的错误</p>
<h2 id="使可变性最小化"><a href="#使可变性最小化" class="headerlink" title="使可变性最小化"></a>使可变性最小化</h2><p><code>tip-15</code><br>Java平台类库中包含许多不可变类，<br>其中有String、基本类型的包装类、BigInteger和BigDecimal。</p>
<p>BigInteger和BigDecimal使用方法和场景<br>BigInteger：<code>不可变的</code>任意精度的整数。<br>BigDecimal：<code>不可变的</code>任意精度的有符号十进制数。</p>
<p>double转BigDecimal精度问题：<br>new BigDecimal(double d) 会导致精度不准确。 new BigDecimal(doubble+””)或<code>BigDecimal.valueOf(double)</code>可解决。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Create two new BigDecimals</span></div><div class="line">BigDecimal BigDec1 = <span class="keyword">new</span> BigDecimal(<span class="string">"1238126387123"</span>);</div><div class="line">BigDecimal BigDec2 = <span class="keyword">new</span> BigDecimal(<span class="string">"1213669989183"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 加 Addition of two BigDecimals</span></div><div class="line">BigDec1 = BigDec1.add(BigDec2);</div><div class="line">System.out.println(<span class="string">"BigDec1 = "</span> + BigDec1);</div><div class="line"></div><div class="line"><span class="comment">// 减 Multiplication of two BigDecimals</span></div><div class="line">BigDec1 = BigDec1.subtract(BigDec2);</div><div class="line">System.out.println(<span class="string">"BigDec1 = "</span> + BigDec1);</div><div class="line"></div><div class="line"><span class="comment">// 乘 Subtraction of two BigDecimals</span></div><div class="line">BigDec1 = BigDec1.multiply(BigDec2);</div><div class="line">System.out.println(<span class="string">"BigDec1 = "</span> + BigDec1);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 除 Division of two BigDecimals</span></div><div class="line">BigDec1 = BigDec1.divide(BigDec2);</div><div class="line">System.out.println(<span class="string">"BigDec1 = "</span> + BigDec1);</div><div class="line"></div><div class="line"><span class="comment">// 幂运算 BigDecima1 raised to the power of 2</span></div><div class="line">BigDec1 = BigDec1.pow(<span class="number">2</span>);</div><div class="line">System.out.println(<span class="string">"BigDec1 = "</span> + BigDec1);</div><div class="line"></div><div class="line"><span class="comment">// 取负值 Negate value of BigDecimal1</span></div><div class="line">BigDec1 = BigDec1.negate();</div><div class="line">System.out.println(<span class="string">"BigDec1 = "</span> + BigDec1);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// BigDecimal 转 double</span></div><div class="line"><span class="comment">// java.math.BigDecimal.doubleValue()</span></div><div class="line"></div><div class="line"><span class="comment">// double 转 BigDecimal</span></div><div class="line"><span class="comment">// java.math.BigDecimal.valueOf(double)</span></div></pre></td></tr></table></figure>
<p>如何进行浮点数精度计算？<br>Java中的简单浮点数类型float和double不能够进行运算。</p>
<p>CPU表示浮点数由两个部分组成：指数和尾数，这样的表示方法一般都会失去一定的精确度，有些浮点数运算也会产生一定的误差。<br>其实java的float只能用来进行科学计算或工程计算，在大多数的商业计算中，一般采用java.math.BigDecimal类来进行精确计算。</p>
<p>在使用BigDecimal类来进行计算的时候，主要分为以下<code>步骤</code>：<br>1、用float或者double变量构建BigDecimal对象。<br>2、通过调用BigDecimal的加，减，乘，除等相应的方法进行算术运算。<br>3、把BigDecimal对象转换成float，double，int等类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 验证double直接计算失精度 </span></div><div class="line">Random random = <span class="keyword">new</span> Random();</div><div class="line">        </div><div class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>;i++)&#123;</div><div class="line">    Double d1 = random.nextDouble();</div><div class="line">    BigDecimal bd1 = BigDecimal.valueOf(d1);</div><div class="line">    bd1 = bd1.setScale(<span class="number">2</span>,BigDecimal.ROUND_HALF_UP);</div><div class="line">    </div><div class="line">    Double d2 = random.nextDouble();</div><div class="line">    BigDecimal bd2 = BigDecimal.valueOf(d2);</div><div class="line">    bd2 = bd2.setScale(<span class="number">2</span>,BigDecimal.ROUND_HALF_UP);</div><div class="line">    </div><div class="line">    System.out.println(bd1.doubleValue() + <span class="string">" + "</span> + bd2.doubleValue() + <span class="string">" = "</span> + (bd1.doubleValue() + bd2.doubleValue()));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不可变类比可变类更易于设计、实现和使用。</p>
<p>实现不可变类，4条原则：</p>
<ul>
<li>不提供任何会<code>修改对象</code>状态的方法</li>
<li>保证类不会被扩展（final类 或 工厂方法）</li>
<li>使所有域都是<code>私有</code>的<code>final</code>域</li>
<li>客户端无法获取到可变组件引用</li>
</ul>
<p>应该确保没有一个方法能够对对象的状态产生<code>外部可见</code>的改变。</p>
<p>不可变对象方法可以设计为<code>函数式</code>的</p>
<p>不可变对象<code>只有一种状态</code>，即对象创建时的状态。</p>
<p>不可变对象本质是<code>线程安全的</code>，他们不要求同步。</p>
<p>不可变对象可以被<code>自由地共享</code>。</p>
<p>不可变类可以提供一些静态工厂，把频繁被请求的实例缓存起来。</p>
<p>不可变类真正唯一的缺点是：对于每一个不同的值都需要一个单独的对象。<br>解决方法是提供可变配套类。String类，提供了公有的可变配套类StringBuilder。</p>
<p>许多不可变类拥有一个或多个非final的域，它们在第一次被请求执行计算时，把计算结果缓存在这些域中。<br>如：String的HashCode()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// java.lang.String.hashCode()</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> h = hash;</div><div class="line">        <span class="keyword">int</span> len = count;</div><div class="line">    <span class="keyword">if</span> (h == <span class="number">0</span> &amp;&amp; len &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">int</span> off = offset;</div><div class="line">        <span class="keyword">char</span> val[] = value;</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</div><div class="line">                h = <span class="number">31</span>*h + val[off++];</div><div class="line">            &#125;</div><div class="line">            hash = h;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> h;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>除非有令人信服的理由要使域变成非final的，否则要使每个域都是final的。</p>
<h2 id="复合优先于继承"><a href="#复合优先于继承" class="headerlink" title="复合优先于继承"></a>复合优先于继承</h2><p><code>tip-16</code></p>
<p>对<code>普通的具体类</code>进行<code>跨越包边界</code>的继承，是非常危险的</p>
<p>继承打破了封装性</p>
<p>只有当子类真实是超类的子类时，才适合用继承<br>只有两者存在“is-a”关系时，才使用继承</p>
<h2 id="要么为继承而设计，并提提供文档说明，要么就禁止继承"><a href="#要么为继承而设计，并提提供文档说明，要么就禁止继承" class="headerlink" title="要么为继承而设计，并提提供文档说明，要么就禁止继承"></a>要么为继承而设计，并提提供文档说明，要么就禁止继承</h2><p><code>tip-17</code><br>类的文档必须精确地描述覆盖每个方法所带来的影响。</p>
<p>类必须通过某种形式提供适当的钩子（hook），以便能够进入到它的<code>内部工作流程</code>中。<br>y<br>好的API文档应该描述给定方法<code>做了什么工作</code>，<code>而不是</code>描述它是<code>如何做到的</code>。</p>
<p>为继承而设计类，应该尽可能少地暴露受保护的成员。</p>
<p>为了继承而设计的类，唯一测试方法就是编写子类。（3个子类通常足以测试一个可扩展的类）</p>
<p>构造器决不能调用可被覆盖的方法。（因为子类中覆盖版本的方法将会在子类的构造器运行之前被调用）</p>
<h2 id="接口优于抽象类"><a href="#接口优于抽象类" class="headerlink" title="接口优于抽象类"></a>接口优于抽象类</h2><p><code>tip-18</code></p>
<p>通过对每个重要接口都提供一个抽象的骨架实现类，把接口和抽象类的优点结合起来。</p>
<p>实现这个接口的类可以把对于接口的调用，转发到一个内部私有类的实例上，这个内部私有类扩展了骨架实现类。</p>
<h2 id="接口只用于定义类型"><a href="#接口只用于定义类型" class="headerlink" title="接口只用于定义类型"></a>接口只用于定义类型</h2><p><code>tip-19</code><br>类实现接口时，接口就充当可以引用这个类的实例的类型（type）。</p>
<p>类实现接口，表明客户端可以<code>对这个类的实例实施某些动作</code>。任何其他目的定义接口都是不恰当的。</p>
<p>常量接口是对接口的<code>不良使用</code>。</p>
<p>使用<code>枚举类型</code>或不可实例化的<code>工具类</code>导出常量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhysicalConstants</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="title">PhysicalConstants</span><span class="params">()</span> </span>&#123; &#125;  <span class="comment">// Prevents instantiation</span></div><div class="line"></div><div class="line">  <span class="comment">// Avogadro's number (1/mol)</span></div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> AVOGADROS_NUMBER   = <span class="number">6.02214199e23</span>;</div><div class="line"></div><div class="line">  <span class="comment">// Boltzmann constant (J/K)</span></div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> BOLTZMANN_CONSTANT = <span class="number">1.3806503e-23</span>;</div><div class="line"></div><div class="line">  <span class="comment">// Mass of the electron (kg)</span></div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> ELECTRON_MASS      = <span class="number">9.10938188e-31</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="用函数对象表示策略"><a href="#用函数对象表示策略" class="headerlink" title="用函数对象表示策略"></a>用函数对象表示策略</h2><p><code>tip-21</code></p>
<h1 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h1><h2 id="必要时进行保护性拷贝"><a href="#必要时进行保护性拷贝" class="headerlink" title="必要时进行保护性拷贝"></a>必要时进行保护性拷贝</h2><p><code>tip-39</code></p>
<p>不可变时间周期类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.sql.Date;</div><div class="line"></div><div class="line"><span class="comment">// Bloken "immutable" time period class</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Period</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Date start;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Date end;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Period</span><span class="params">(Date start, Date end)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(start.compareTo(end) &gt; <span class="number">0</span>)&#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(start + <span class="string">" "</span> + end);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.start = start;</div><div class="line">        <span class="keyword">this</span>.end = end;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getStart</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> start;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getEnd</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> end;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个类似乎是不可变的，并且强加了约束条件<br>因为<code>Date类本身是可变的</code>，所以很容易违反这个约束条件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// attack the internals of a Period instance</span></div><div class="line">Data start = <span class="keyword">new</span> Date();</div><div class="line">Date end = <span class="keyword">new</span> Date();</div><div class="line">Period p = <span class="keyword">new</span> Period(start, end);</div><div class="line"></div><div class="line"><span class="comment">// Deprecated</span></div><div class="line"><span class="comment">// end.setYear(78);</span></div><div class="line"></div><div class="line">Calendar calendar = Calendar.getInstance();</div><div class="line">calendar.setTime(end);</div><div class="line">calendar.set(Calendar.YEAR, <span class="number">1978</span>);</div><div class="line">end.setTime(calendar.getTimeInMillis());</div></pre></td></tr></table></figure>
<p>对构造器的每个可变参数进行<code>保护性拷贝</code>是必要的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Period</span><span class="params">(Date start, Date end)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.start = <span class="keyword">new</span> Date(start.getTime());</div><div class="line">    <span class="keyword">this</span>.end = <span class="keyword">new</span> Date(end.getTime());</div><div class="line">    </div><div class="line">    <span class="keyword">if</span>(start.compareTo(end) &gt; <span class="number">0</span>)&#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(start + <span class="string">" "</span> + end);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>没有使用Date的clone()进行保护性拷贝。<br>因为Date是非final的，不能保证clone()返回java.util.Date的对象</p>
<p>对于参数类型可以被<code>不可信任方</code>子类化的参数，不要使用clone()进行保护性拷贝。</p>
<p>因为访问方法提供了对其<code>可变内部成员</code>的访问能力,修改为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Date <span class="title">getStart</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Date(start.getTime());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Date <span class="title">getEnd</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Date(end.getTime());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果正在考虑由客户提供的<code>对象引用</code>作为内部Set实例的元素，或者做为内部Map的键,<br>就应该意识到，如果这个对象在插入之后再被修改，Set或Map的约束条件就会遭到破坏。</p>
<p>长度非零的数组总是可变的。<br>把内部数组返回给客户端之前，应该总是<code>进行保护性拷贝</code>。另一种解决方案是，给客户端<code>返回数组的不可变视图</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Integer[] values = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</div><div class="line">List&lt;Integer&gt; asList = Collections.unmodifiableList(Arrays.asList(values));</div></pre></td></tr></table></figure>
<p>类具有从客户端得到或返回客户端的<code>可变组件</code>，类就必须<code>保护性的拷贝</code>这些组件。<br>如果<code>拷贝的成本受到限制</code>，并且类信任它的客户端不会不恰当地修改组件，<br>就可以<code>在文档中指明</code>客户端的职责不得修改受到影响的组件，以此来代替保护性拷贝。</p>
<h2 id="复合优先于继承-1"><a href="#复合优先于继承-1" class="headerlink" title="复合优先于继承"></a>复合优先于继承</h2><h1 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h1><h2 id="同步访问共享的可变数据"><a href="#同步访问共享的可变数据" class="headerlink" title="同步访问共享的可变数据"></a>同步访问共享的可变数据</h2><p><code>tip-66</code></p>
<p>Java语言规范保证<code>读</code>或<code>写</code>一个变量是<code>原子的</code>(atomic)，除非这个变量的类型为long或double。</p>
<p>语言规范保证了线程在读取原子数据的时候，不会看到任意的数值，<br>但并不保证线程写入的值对于另一个线程是可见的。（可见性）</p>
<h2 id="避免过度同步"><a href="#避免过度同步" class="headerlink" title="避免过度同步"></a>避免过度同步</h2><p><code>tip-67</code></p>
<p>不要从同步区域调用外来方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 观察者模式</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(SetObserver&lt;E&gt; observer)</span></span>&#123;</div><div class="line">    <span class="comment">//遍历观察者列表，加锁</span></div><div class="line">    <span class="comment">//避免遍历期间Iterator出现ConcurrentModificationException</span></div><div class="line">    <span class="keyword">synchronized</span>(observers)&#123;</div><div class="line">        <span class="keyword">for</span>(SetObserver&lt;E&gt; observer : observers)&#123;</div><div class="line">            <span class="comment">//调用外部方法(观察者方法)</span></div><div class="line">            <span class="comment">//观察者方法可以获取当前对象，且内置锁可重入</span></div><div class="line">            <span class="comment">//观察者方法中可以修改observers，导致遍历异常</span></div><div class="line">            observer.added(<span class="keyword">this</span>, element);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过将外来方法调用移出同步的代码块解决这个问题，使用observers快照</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(SetObserver observer)</span></span>&#123;</div><div class="line">    List&lt;SetObserver&gt; snapshot = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">synchronized</span>(observers)&#123;</div><div class="line">        snapshot = <span class="keyword">new</span> ArrayList&lt;SetObserver&gt;(observers);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span>(SetObserver observer : snapshot)&#123;</div><div class="line">        observer.added(<span class="keyword">this</span>, element);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>消息通知通常比观察者列表变化更频繁，<br>故使用CopyOnWriteArrayList作为观察者列表更合适</p>
<p>在同步区域调用外来方法，其他线程对受保护资源的访问会遭到不必要的拒绝。<br>应该在同步区域做尽量少的工作。</p>
<p>过度同步实际成本并不是获取锁所花费的CPU时间，而是失去了并行的机会；<br>以及因为需要确保每个核都有一个<code>一致的内存视图</code>而导致的延迟。<br>另一个潜在开销在于，它会限制VM<code>优化代码执行</code>的能力。</p>
<p>当不确定是否需要<code>内部同步</code>时，就不要同步类，<br>而应该建立文档，注明它不是线程安全的。</p>
<p>内部同步可以使用不同的方法来实现高并发。<br>如：拆分锁(lock splitting)、分离锁(lock striping)和非阻塞(nonblocking)</p>
<p>方法修改静态域，<code>必须同步</code>对这个域的访问。<br>客户在这种方法上执行外部同步是不可能的，<br>因为不能保证不相关的客户端也会执行外部同步。</p>
<p>未同步静态域访问示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> nextSerialNumber = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">generateSerialNumber</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> nextSerialNumber++;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="executor和task优先于线程"><a href="#executor和task优先于线程" class="headerlink" title="executor和task优先于线程"></a>executor和task优先于线程</h2><p><code>tip-68</code><br>Executor Framework是一个基于接口的任务执行工具。</p>
<p>java.util.concurrent.Executors类包含静态工厂方法，能提供大多数的executor，<br>使用ThreadPoolExecutor类可以最大限度的定制线程池。</p>
<p>任务(task)有两种:</p>
<ul>
<li>Runnable</li>
<li>Callable (有返回值)</li>
</ul>
<p>轻载的服务器，可以使用Executors.newCachedThreaPool()<br>大负载的服务器，最好使用Executors.newFixedThreadPool();<br>被调度的线程池 Executors.newScheduledThreadPool()可以替代java.util.Timer</p>
<p>timer唯一的线程抛出未被捕获异常，会停止。</p>
<p>被调度的线程池支持多线程，且优雅的从抛出非受检异常的任务中恢复。</p>
<p>java.util.Timer 任务抛出异常后，线程终止示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">Timer timer = <span class="keyword">new</span> Timer();</div><div class="line"><span class="comment">//初始延迟</span></div><div class="line"><span class="keyword">int</span> initialDelay = <span class="number">1000</span>;</div><div class="line"><span class="comment">//执行周期</span></div><div class="line"><span class="keyword">int</span> period = <span class="number">2000</span>;</div><div class="line"></div><div class="line"><span class="comment">//固定延迟</span></div><div class="line">timer.schedule(<span class="keyword">new</span> TimerTask()&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(System.nanoTime());</div><div class="line">        <span class="comment">//throw new RuntimeException("foo");</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;, initialDelay, period);</div><div class="line"></div><div class="line"><span class="comment">//固定速率</span></div><div class="line">timer.scheduleAtFixedRate(<span class="keyword">new</span> TimerTask()&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(System.nanoTime());</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"foo"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;, initialDelay,period);</div></pre></td></tr></table></figure>
<blockquote>
<p>对 Timer 对象最后的引用消失后，并且 所有未处理的任务都已执行完成，计时器的任务执行线程会正常终止（并且成为垃圾回收的对象）。但是这可能要很长时间后才发生。<br>（Timer任务执行完成之后，执行垃圾回收时才会终止。实验运行阶段造成程序不终止假象 ）</p>
</blockquote>
<p>ScheduledThreadPool 任务抛出异常时，执行当前任务的线程停止，<code>当前任务也会终止</code>；<br>任务执行器不会停止，会有新的线程被创建并执行其他任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//初始延迟</span></div><div class="line"><span class="keyword">int</span> initialDelay = <span class="number">1000</span>;</div><div class="line"><span class="comment">//执行周期</span></div><div class="line"><span class="keyword">int</span> period = <span class="number">2000</span>;</div><div class="line"></div><div class="line"><span class="keyword">int</span> corePoolSize = <span class="number">1</span>;</div><div class="line">ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(corePoolSize);</div><div class="line"><span class="comment">//固定速率，任务1</span></div><div class="line">ScheduledFuture&lt;?&gt; scheduledFuture = scheduler.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"foo:"</span> + Thread.currentThread().getName());</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"foo"</span>);</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">&#125;, initialDelay, period, TimeUnit.MILLISECONDS);</div><div class="line"></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">//获取任务执行结果，任务抛出异常时能够捕获异常</span></div><div class="line">    scheduledFuture.get();</div><div class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//固定延迟的任务，任务2</span></div><div class="line">scheduler.scheduleWithFixedDelay(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"bar:"</span> + Thread.currentThread().getName());</div><div class="line">    &#125;</div><div class="line">&#125;, initialDelay, period, TimeUnit.MILLISECONDS);</div></pre></td></tr></table></figure>
<h2 id="并发工具优先于wait和notify"><a href="#并发工具优先于wait和notify" class="headerlink" title="并发工具优先于wait和notify"></a>并发工具优先于wait和notify</h2><p><code>tip-69</code><br>几乎没有理由再使用wait和notify了，<br>java 1.5提供了更高级的并发工具，<br>他们可以完成以前必须在wait和notify上手写代码才能完成的工作。</p>
<p>java.util.concurrent中更高级的工具分成三类：</p>
<ul>
<li>任务执行工具(Executor Framework)</li>
<li>并发集合(Concurrent Collection)</li>
<li>同步器(Synchronizer)</li>
</ul>
<p>wait方法的标准模式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">synchronized</span>(obj)&#123;</div><div class="line">    <span class="keyword">while</span>(conditionDoesNotHold)&#123;</div><div class="line">        obj.wait();<span class="comment">//Releases lock, and reacquires on wakeup</span></div><div class="line">        <span class="comment">//Perform action appropriate to condition</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>循环会在等待之前和之后测试条件。</p>
<p>一般情况下，应该优先使用notifyAll，而不是notify<br>使用notifyAll代替notify可以避免来自不相关线程的意外或恶意的等待。<br>否则，这样的等待会“吞掉”一个关键的通知，使真正的接收线程无限地等待下去。</p>
<h2 id="线程安全性的文档化"><a href="#线程安全性的文档化" class="headerlink" title="线程安全性的文档化"></a>线程安全性的文档化</h2><p><code>tip-70</code><br>一个类为了可被多线程安全地使用，必须在文档中清楚地说明它所支持的线程安全级别。</p>
<p>线程安全级别：</p>
<ul>
<li>不可变的</li>
<li>无条件的线程安全</li>
<li>有条件的线程安全</li>
<li>非线程安全</li>
<li>线程对立的</li>
</ul>
<blockquote>
<p>线程对立的类不能安全的被多线程并发使用，即时方法调用使用外部同步。<br>线程对立的根源通常在于，没有同步地修改静态数据。<br>如：System.runFinalizersOnExit方法是线程对立的。</p>
</blockquote>
<p>线程安全说明通常放在文档注释中。</p>
<p>静态工厂必须在文档中说明被返回对象的线程安全性。</p>
<p>私有锁对象模式（防止客户端或子类干扰同步）：</p>
<ul>
<li>只能用在无条件的线程安全类上</li>
<li>特别适用于专门为继承设计的类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">synchronized</span>(lock)&#123;</div><div class="line">        <span class="comment">//doSomething</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有条件的线程安全类必须在文档中指明“哪个方法调用序列需外部同步”，<br>以及在执行这些序列时要获取哪个锁。</p>
<h2 id="慎用延迟初始化"><a href="#慎用延迟初始化" class="headerlink" title="慎用延迟初始化"></a>慎用延迟初始化</h2><p><code>tip-71</code><br>延迟初始化是延迟到<code>需要域的值时</code>才将它初始化。</p>
<p>延迟初始化降低了初始化类或创建实例的开销，<br>却增加了访问延迟初始化的域的开销。</p>
<blockquote>
<p>延迟初始化建议:除非绝对必要，否则就不要这么做。</p>
</blockquote>
<p>静态初始化器:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ThreadSafe</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EagerInitialization</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Resource resource = <span class="keyword">new</span> Resource();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Resource <span class="title">getResource</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> resource;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Resource</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote><p>静态初始化器由JVM在<code>类的初始化</code>阶段执行，即在类被加载后并且<code>被线程使用</code>之前。<br>由于JVM将在初始化期间获得一个锁，并且每个线程都至少获取一次这个锁以确保这个类已经被加载，<br>因此在静态初始化期间，内存写入操作将自动对所有线程可见。</p>
<footer><strong>《Java Concurrency In Practice》</strong></footer></blockquote>
<p>静态域初始化使用<code>延迟初始化占位类</code>模式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Resource</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Resource</span><span class="params">()</span></span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Resource <span class="title">getResource</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> ResourceHolder.resource;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceHolder</span></span>&#123;</div><div class="line">        <span class="keyword">static</span> Resource  resource = <span class="keyword">new</span> Resource();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实例域初始化使用<code>双重检查</code>模式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> volitile FieldType field4;</div><div class="line"><span class="function">FieldType <span class="title">getField4</span><span class="params">()</span></span>&#123;</div><div class="line">    FieldType result = field4;</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">null</span> == result)&#123;</div><div class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</div><div class="line">            result  = field4;</div><div class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> == result)&#123;</div><div class="line">                field4 = result = computeFieldValue();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>局部变量result确保field在已经被初始化的情况下只读取一次，<br>可以提升性能；</p>
</blockquote>
<p>可以接受重复初始化的实例域，可以考虑<code>单重检查模式</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> hash;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> h = hash;</div><div class="line">    <span class="keyword">int</span> len = count;</div><div class="line">    <span class="keyword">if</span> (h == <span class="number">0</span> &amp;&amp; len &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">int</span> off = offset;</div><div class="line">        <span class="keyword">char</span> val[] = value;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</div><div class="line">            h = <span class="number">31</span>*h + val[off++];</div><div class="line">        &#125;</div><div class="line">        hash = h;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> h;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>String 使用单重检查模式缓存散列码</p>
</blockquote>
<h2 id="不要依赖于线程调度器"><a href="#不要依赖于线程调度器" class="headerlink" title="不要依赖于线程调度器"></a>不要依赖于线程调度器</h2><p><code>tip-72</code><br>任何依赖线程调度器来达到正确性或者性能要求的程序，很可能都是<code>不可移植</code>的。</p>
<p>Thread.yield没有可测试的语义，<br>应该使用Thread.sleep(1)替代Thread.yield进行并发测试。</p>
<p>线程优先级是Java平台上最不可移植的特性之一。</p>
<p>线程优先级可以用来提高一个已经<code>能够正常工作</code>的程序的服务质量，<br>但永远不应该用来“修正”一个原本并不能工作的程序。</p>
<h1 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h1><h2 id="保护性地编写readObject方法"><a href="#保护性地编写readObject方法" class="headerlink" title="保护性地编写readObject方法"></a>保护性地编写readObject方法</h2><p><code>tip-76</code><br>readObject是一个“用字节流作为唯一参数”的构造器。</p>
<p>对于每个可序列化的不可变类，<br>如果它包含了<code>私有的可变组件</code>，那么在它的readObject方法中，必须对这些组件进行保护性拷贝。</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Think In Java]]></title>
      <url>http://xiaozhuang.github.io/2017/04/12/javase-thinkinjava/</url>
      <content type="html"><![CDATA[<p>Think In Java 学习笔记<br><a id="more"></a></p>
<h1 id="一切都是对象"><a href="#一切都是对象" class="headerlink" title="一切都是对象"></a>一切都是对象</h1><p>Java中（几乎）一切都是对象</p>
<h2 id="存储到什么地方"><a href="#存储到什么地方" class="headerlink" title="存储到什么地方"></a>存储到什么地方</h2><p>栈：位于RAM中，存储<code>对象引用</code>和<code>基本类型</code>数据<br>堆：一种通用的内存池，位于RAM中，存放所有的java对象。<br>常量存储：<code>常量值</code>通常直接存放在<code>程序代码内部</code>。</p>
<h2 id="基本类型"><a href="#基本类型" class="headerlink" title="基本类型"></a>基本类型</h2><p>基本类型不用new创建变量，而是创建一个并非是引用的“自动”变量，变量直接存储“值”<br>并置与栈中。</p>
<p>数值类型都有正负号</p>
<h2 id="字段和方法"><a href="#字段和方法" class="headerlink" title="字段和方法"></a>字段和方法</h2><p>基本数据类型默认值<br>基本数据类型<code>成员变量</code>有默认值，<code>局部变量</code>没有默认值<br>对象引用默认为null</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>默认值 </th>
</tr>
</thead>
<tbody>
<tr>
<td>boolean</td>
<td>false</td>
</tr>
<tr>
<td>char</td>
<td>0</td>
</tr>
<tr>
<td>byte</td>
<td>0</td>
</tr>
<tr>
<td>short</td>
<td>0</td>
</tr>
<tr>
<td>int</td>
<td>0</td>
</tr>
<tr>
<td>long</td>
<td>0L</td>
</tr>
<tr>
<td>float</td>
<td>0.0f</td>
</tr>
<tr>
<td>double</td>
<td>0.0d</td>
</tr>
</tbody>
</table>
<h2 id="参数列表"><a href="#参数列表" class="headerlink" title="参数列表"></a>参数列表</h2><p>基本类型，<code>值保存在变量中</code>。<br>引用类型，变量中保存的是<code>实际对象的地址</code>。</p>
<img src="/2017/04/12/javase-thinkinjava/passByReferenceOrPassByValue.png" alt="passByReferenceOrPassByValue.png" title="">
<blockquote>
<p>图片来源：<a href="https://www.zhihu.com/question/31203609" title="java到底是值传递还是引用传递" target="_blank" rel="external">java到底是值传递还是引用传递</a></p>
</blockquote>
<p>java中方法参数传递方式是<code>按值传递</code>。<br>如果参数是基本类型，传递的是<code>字面量值</code>的拷贝。<br>如果参数是引用类型，传递的是<code>引用</code>的拷贝。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tricky</span><span class="params">(Point arg1, Point arg2)</span></span>&#123;</div><div class="line">  arg1.x = <span class="number">100</span>;</div><div class="line">  arg1.y = <span class="number">100</span>;</div><div class="line">  Point temp = arg1;</div><div class="line">  arg1 = arg2;</div><div class="line">  arg2 = temp;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String [] args)</span></span>&#123;</div><div class="line">  Point pnt1 = <span class="keyword">new</span> Point(<span class="number">0</span>,<span class="number">0</span>);</div><div class="line">  Point pnt2 = <span class="keyword">new</span> Point(<span class="number">0</span>,<span class="number">0</span>);</div><div class="line">  System.out.println(<span class="string">"X: "</span> + pnt1.x + <span class="string">" Y: "</span> +pnt1.y); </div><div class="line">  System.out.println(<span class="string">"X: "</span> + pnt2.x + <span class="string">" Y: "</span> +pnt2.y);</div><div class="line">  System.out.println(<span class="string">" "</span>);</div><div class="line">  tricky(pnt1,pnt2);</div><div class="line">  System.out.println(<span class="string">"X: "</span> + pnt1.x + <span class="string">" Y:"</span> + pnt1.y); </div><div class="line">  System.out.println(<span class="string">"X: "</span> + pnt2.x + <span class="string">" Y: "</span> +pnt2.y);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">X: 0 Y: 0</div><div class="line">X: 0 Y: 0</div><div class="line">X: 100 Y: 100</div><div class="line">X: 0 Y: 0</div></pre></td></tr></table></figure>
<h1 id="初始化和清除"><a href="#初始化和清除" class="headerlink" title="初始化和清除"></a>初始化和清除</h1><h2 id="方法重载"><a href="#方法重载" class="headerlink" title="方法重载"></a>方法重载</h2><p>独一无二的<code>形参类型</code>列表<br>顺序不同也可以，但会产生难以维护的代码<br><code>不能</code>根据返回值类型区分方法重载</p>
<h2 id="this关键字"><a href="#this关键字" class="headerlink" title="this关键字"></a>this关键字</h2><p>在方法内部，可用this获得当前对象的句柄。</p>
<p>可在一个构建器中调用另一个构建器，使用this实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Class Flower&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> petals;</div><div class="line">    <span class="keyword">private</span> String s;</div><div class="line"></div><div class="line">    Flower(<span class="keyword">int</span> petals)&#123;</div><div class="line">        <span class="keyword">this</span>.petals = petals;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Flower(String s, <span class="keyword">int</span> petals)&#123;</div><div class="line">        <span class="keyword">this</span>(petals);</div><div class="line">        <span class="keyword">this</span>.s = s;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="finalize-用途何在"><a href="#finalize-用途何在" class="headerlink" title="finalize() 用途何在"></a>finalize() 用途何在</h2><p>如果对象分配了一个<code>特殊</code>内存区域，没有使用new<br>垃圾收集器只释放那些由new分配的内存</p>
<p>之所以使用finalize()，是因为有时需要采用与java的普通方法不同的方法，<br>通过分配内存做一些具有C风格的事情(通过<code>本地方法</code>实现)</p>
<h2 id="你必须实施清理"><a href="#你必须实施清理" class="headerlink" title="你必须实施清理"></a>你必须实施清理</h2><p>无论是<code>垃圾回收</code>还是<code>终结</code>,都不保证一定会发生。<br>如果JVM并未面临内存耗尽的情形，它不会浪费时间去执行垃圾回收以恢复内存。</p>
<h2 id="垃圾收集器如何工作"><a href="#垃圾收集器如何工作" class="headerlink" title="垃圾收集器如何工作"></a>垃圾收集器如何工作</h2><h3 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h3><p>引用计数是一种<code>简单</code>但<code>速度很慢</code>的垃圾回收技术。<br>管理引用计数开销很大，且如果对象之间存在循环引用，<br>会出现“对象应该被回收，但引用计数不为0”的情况。</p>
<p>引用计数常用来说明垃圾收集的工作方式，<br>但似乎<code>从未被应用于</code>任何一种Java虚拟机实现中。</p>
<h3 id="可达性分析"><a href="#可达性分析" class="headerlink" title="可达性分析"></a>可达性分析</h3><p>对于任何“活”的对象，一定能最终追溯到其存活在<code>堆栈或静态存储区</code>中的引用</p>
<h3 id="垃圾回收器自适应"><a href="#垃圾回收器自适应" class="headerlink" title="垃圾回收器自适应"></a>垃圾回收器自适应</h3><p>“自适应的、分代的、停止-复制、标记-清扫”式垃圾回收器。</p>
<h3 id="即时编译器技术-Just-In-Time-JIT"><a href="#即时编译器技术-Just-In-Time-JIT" class="headerlink" title="即时编译器技术(Just-In-Time,JIT)"></a>即时编译器技术(Just-In-Time,JIT)</h3><p>这种技术可以把程序全部或部分翻译成本地机器码。</p>
<p>两种方案：</p>
<ul>
<li>即时编译器编译所有代码（增加可执行代码的长度，导致页面调度，降低程序速度）</li>
<li>惰性评估(即时编译器只在必要时编译代码)</li>
</ul>
<h2 id="成员初始化"><a href="#成员初始化" class="headerlink" title="成员初始化"></a>成员初始化</h2><p>静态初始化只有在必要时刻才会进行</p>
<ul>
<li>创建对象前</li>
<li>引用静态变量</li>
</ul>
<p>Java类实例化执行顺序：</p>
<ul>
<li>静态声明</li>
<li>静态初始化块</li>
<li>成员声明</li>
<li>实例初始化块</li>
<li>构造函数</li>
</ul>
<h1 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h1><h2 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h2><p>AND ( &amp;&amp; )<br>OR ( || )<br>NOT ( ! )</p>
<p>只能将AND、OR、NOT应用于布尔值</p>
<h2 id="按位运算"><a href="#按位运算" class="headerlink" title="按位运算"></a>按位运算</h2><ul>
<li>位OR   |   或</li>
<li>位AND  &amp;   与</li>
<li>位NOT  ~   非</li>
<li>位XOR  ^   异或</li>
</ul>
<blockquote>
<p>两值不同，异或结果为真</p>
</blockquote>
<h2 id="移位运算"><a href="#移位运算" class="headerlink" title="移位运算"></a>移位运算</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;&lt; 有符号左移运算符（低位补0）</div><div class="line">&gt;&gt; 有符号右移运算符（正数高位补0，负数高位补1）</div><div class="line">&gt;&gt;&gt; 无符号右移运算符（无论正负，高位补0）</div></pre></td></tr></table></figure>
<p>char、byte、short 进行移位处理，在移位前，会自动转换为int</p>
<h1 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h1><h2 id="对象同名属性拷贝"><a href="#对象同名属性拷贝" class="headerlink" title="对象同名属性拷贝"></a>对象同名属性拷贝</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//方式1：</span></div><div class="line"><span class="comment">// import net.sf.cglib.beans.BeanCopier;</span></div><div class="line"></div><div class="line">Foo foo = <span class="keyword">new</span> Foo();</div><div class="line"><span class="comment">//set foo</span></div><div class="line">Bar bar = <span class="keyword">new</span> Bar();</div><div class="line">BeanCopier bc = BeanCopier.create(Foo.class,Bar.class,<span class="keyword">false</span>);</div><div class="line">bc.copy(foo, bar, <span class="keyword">null</span>);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 方式2：</span></div><div class="line">Bar orig = <span class="keyword">new</span> Bar();</div><div class="line"><span class="comment">//set orig</span></div><div class="line">Foo dest = <span class="keyword">new</span> Foo();</div><div class="line"><span class="comment">//方式1</span></div><div class="line">BeanUtils.copyProperties(dest, orig);</div></pre></td></tr></table></figure>
<h2 id="对象深拷贝"><a href="#对象深拷贝" class="headerlink" title="对象深拷贝"></a>对象深拷贝</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> Foo foo = <span class="keyword">new</span> Foo();</div><div class="line">foo.setId(<span class="number">1</span>);</div><div class="line">Foo clone = SerializationUtils.clone(foo);</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Design Patterns]]></title>
      <url>http://xiaozhuang.github.io/2017/04/12/design-patterns/</url>
      <content type="html"><![CDATA[<p>Java 设计模式<br><a id="more"></a></p>
<h1 id="面向对象设计原则"><a href="#面向对象设计原则" class="headerlink" title="面向对象设计原则"></a>面向对象设计原则</h1><h2 id="单一职责原则"><a href="#单一职责原则" class="headerlink" title="单一职责原则"></a>单一职责原则</h2><p>类的职责要单一，不能将大多的职责放在一个类中。</p>
<h2 id="开闭原则"><a href="#开闭原则" class="headerlink" title="开闭原则"></a>开闭原则</h2><p>软件实体对扩展是开放的，但对修改是关闭的。<br>即在不修改软件实体的基础上去扩展其功能。</p>
<h2 id="里氏替换原则"><a href="#里氏替换原则" class="headerlink" title="里氏替换原则"></a>里氏替换原则</h2><p>在软件系统中，一个可以接受基类对象的地方，必然可以接受一个子类对象。</p>
<h2 id="依赖倒转原则"><a href="#依赖倒转原则" class="headerlink" title="依赖倒转原则"></a>依赖倒转原则</h2><p>要针对抽象层编程，而不要针对具体类编程。</p>
<h2 id="接口隔离原则"><a href="#接口隔离原则" class="headerlink" title="接口隔离原则"></a>接口隔离原则</h2><p>使用多个专门的接口来取代一个统一的接口。</p>
<h2 id="合成复用原则"><a href="#合成复用原则" class="headerlink" title="合成复用原则"></a>合成复用原则</h2><p>在系统中应该尽量多使用组合和聚合关系，尽量少使用甚至不适用继承关系。</p>
<h2 id="迪米特法则"><a href="#迪米特法则" class="headerlink" title="迪米特法则"></a>迪米特法则</h2><p>一个软件实体对其他实体的引用越少越好，<br>或者说如果两个类不必彼此直接通信，<br>那么这两个类就不应当发生直接的相互作用，<br>而是通过引入一个第三者发生间接交互。</p>
<h1 id="策略模式（Strategy-Pattern）"><a href="#策略模式（Strategy-Pattern）" class="headerlink" title="策略模式（Strategy Pattern）"></a>策略模式（Strategy Pattern）</h1><p>定义了算法族，分别封装起来，让他们之间可以相互替换，<br>此模式让算法的变化独立于使用算法的客户。</p>
<img src="/2017/04/12/design-patterns/StrategyPattern.png" alt="StrategyPattern.png" title="">
<h1 id="观察则模式"><a href="#观察则模式" class="headerlink" title="观察则模式"></a>观察则模式</h1><img src="/2017/04/12/design-patterns/Observer.png" alt="Observer.png" title="">
<p>定义了对象之间的一对多依赖，当对象改变状态时，<br>依赖它的对象会收到通知，并自动更新。</p>
<p>观察者模式让主题和观察者之间松耦合。</p>
<p>使用场景（购票为核心业务）：</p>
<ul>
<li>购票后记录文本日志</li>
<li>购票后记录数据库日志</li>
<li>购票后发送短信</li>
<li>购票送抵扣卷、兑换卷、积分</li>
<li>其他各类活动等</li>
</ul>
<p>HeadFirst示例：气象站布告板</p>
<p>Guava EventBus 观察者模式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.common.eventbus.DeadEvent;</div><div class="line"><span class="keyword">import</span> com.google.common.eventbus.EventBus;</div><div class="line"><span class="keyword">import</span> com.google.common.eventbus.Subscribe;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverExample</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(ObserverExample.class);</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EventMessage</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> msgcode;</div><div class="line">        <span class="keyword">final</span> String msg;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">EventMessage</span><span class="params">(<span class="keyword">int</span> msgcode, String msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.msgcode = msgcode;</div><div class="line">            <span class="keyword">this</span>.msg = msg;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"EventMessage [msgcode="</span> + msgcode + <span class="string">", msg="</span> + msg + <span class="string">"]"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * DeadEvent：死信（没有订阅者关注的事件）对象</div><div class="line">     * EventBus会把所有发布后没有监听者处理的事件包装为DeadEvent</div><div class="line">     * <span class="doctag">@author</span> Sunday</div><div class="line">     *</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadEventsSubscriver</span> </span>&#123;</div><div class="line">        <span class="comment">//使用注解注册事件处理器</span></div><div class="line">        <span class="meta">@Subscribe</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDeadEvent</span><span class="params">(DeadEvent deadEvent)</span> </span>&#123;</div><div class="line">            log.error(<span class="string">"DEAD EVENT: &#123;&#125;"</span>, deadEvent.getEvent());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * EventBus自动把事件分发给事件超类的监听者</div><div class="line">     * <span class="doctag">@author</span> Sunday</div><div class="line">     *</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EventMessageSubscriver</span> </span>&#123;</div><div class="line">        <span class="comment">//处理方法必须要明确地声明参数类型——期望的事件类型（或事件的父类型）</span></div><div class="line">        <span class="meta">@Subscribe</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleEventMessageEvent</span><span class="params">(EventMessage eventMessage)</span> </span>&#123;</div><div class="line">            log.error(eventMessage.toString());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">            <span class="keyword">final</span> EventBus eventBus = <span class="keyword">new</span> EventBus(<span class="string">"example-events"</span>);</div><div class="line">            <span class="keyword">final</span> DeadEventsSubscriver deadEventsSubscriver = <span class="keyword">new</span> DeadEventsSubscriver();</div><div class="line">            EventMessageSubscriver eventMessageSubscriver = <span class="keyword">new</span> EventMessageSubscriver();</div><div class="line">            </div><div class="line">            eventBus.register(deadEventsSubscriver);</div><div class="line">            eventBus.register(eventMessageSubscriver);</div><div class="line">            </div><div class="line">            <span class="comment">// published</span></div><div class="line">            eventBus.post(<span class="string">"This is dead event"</span>);</div><div class="line">            eventBus.post(<span class="keyword">new</span> EventMessage(<span class="number">5000</span>, <span class="string">"This message from hoge"</span>));</div><div class="line">            eventBus.post(<span class="keyword">new</span> EventMessage(<span class="number">1000</span>, <span class="string">"This message from fuga"</span>)); </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="装饰者模式"><a href="#装饰者模式" class="headerlink" title="装饰者模式"></a>装饰者模式</h1><p>动态地将功能附加到对象上。</p>
<img src="/2017/04/12/design-patterns/decorate.png" alt="decorate.png" title="">
<p>使用组合和委托运行时动态扩展行为；</p>
<p>使用场景：<br>Java I/O、Java线程安全结合包装器、RequestWrapper</p>
<p>HeadFirst示例：星巴兹咖啡订单系统，包装添加不同调料的咖啡</p>
<h1 id="工厂模式"><a href="#工厂模式" class="headerlink" title="工厂模式"></a>工厂模式</h1><h2 id="简单工厂模式"><a href="#简单工厂模式" class="headerlink" title="简单工厂模式"></a>简单工厂模式</h2><p>简单工厂模式由一个工厂决定创建出哪一种产品类的实例。</p>
<h2 id="工厂方法模式"><a href="#工厂方法模式" class="headerlink" title="工厂方法模式"></a>工厂方法模式</h2><p>定义一个创建对象的接口，但由子类决定要实例化的类是哪一个。<br>工厂方法模式让类把实例化推迟到子类。</p>
<p>工厂类不再负责所有产品的创建，而是将具体创建的工作交给子类。</p>
<p>加入新产品，只需向系统中加入这个产品及其所对应的工厂类。</p>
<p>HeadFirst示例：不同地区披萨店</p>
<h2 id="抽象工厂模式"><a href="#抽象工厂模式" class="headerlink" title="抽象工厂模式"></a>抽象工厂模式</h2><p>抽象工厂模式可以向客户端提供一个接口，使客户端在不指定产品的具体类型情况下，<br>创建多个产品族中的产品对象。</p>
<p>提供一个接口，用于创建相关或依赖对象的家族，并不需要明确指定具体类。</p>
<p>抽象工厂模式可以向客户端提供一个接口，使客户端在不指定产品的具体类型情况下，<br>创建多个产品族中的产品对象。</p>
<p>使用场景：电脑配件工厂（pc、mac）<br>HeadFirst示例：不同地区披萨原料工厂</p>
<h1 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h1><p>代码示例，参考《Effective Java》tip-71</p>
<h1 id="适配器模式与外观模式"><a href="#适配器模式与外观模式" class="headerlink" title="适配器模式与外观模式"></a>适配器模式与外观模式</h1><h2 id="适配器模式"><a href="#适配器模式" class="headerlink" title="适配器模式"></a>适配器模式</h2><p>将一个类的接口，转换成客户期望的另一个接口。<br>适配器让原本接口不兼容的类可以合作无间。</p>
<img src="/2017/04/12/design-patterns/adapterPattern.png" alt="adapterPattern.png" title="">
<h2 id="外观模式"><a href="#外观模式" class="headerlink" title="外观模式"></a>外观模式</h2><p>提供一个统一的接口，用来访问子系统中的一群接口。<br>外观定义了一个高层接口，让子系统更容易使用。</p>
<img src="/2017/04/12/design-patterns/facadePattern.png" alt="facadePattern.png" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="https://sourcemaking.com/design_patterns/facade" target="_blank" rel="external">Facade Design Pattern</a></cite></footer></blockquote>
<p>外观不只<code>简化</code>了接口，也将客户从组件的子系统中<code>解耦</code>。</p>
<h1 id="模板方法模式"><a href="#模板方法模式" class="headerlink" title="模板方法模式"></a>模板方法模式</h1><p>在一个方法中定义一个<code>算法的骨架</code>，而将一些步骤延迟到子类中。<br>模板方法使得子类可以在不改变算法结构的情况下，重新定义算法中的某些步骤。</p>
<img src="/2017/04/12/design-patterns/templateMethod.png" alt="templateMethod.png" title="">
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractClass</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">templateMethod</span><span class="params">()</span></span>&#123;</div><div class="line">        primitiveOperation1();</div><div class="line">        primitiveOperation2();</div><div class="line">        concreteOperation();</div><div class="line">        hook();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//抽象方法</span></div><div class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">primitiveOperation1</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">primitiveOperation2</span><span class="params">()</span></span>;</div><div class="line">    <span class="comment">//具体方法</span></div><div class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">concreteOperation</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="comment">//...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//钩子</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">hook</span><span class="params">()</span></span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>模板方法的抽象类可以定义<code>具体方法</code>、<code>抽象方法</code>和<code>钩子</code>。</p>
<p>钩子可以不做任何事情或只做默认的事情。</p>
<p>钩子可以让子类实现算法中<code>可选</code>的部分，<br>或让子类对模板中某些即将发生（或刚刚发生）的步骤作出反应。</p>
<p>使用场景：SpringMVC HandlerMethodAdapter（子类RequestMappingHandlerAdapter）<br>Spring MVC ViewResolver（子类）</p>
<h1 id="状态模式"><a href="#状态模式" class="headerlink" title="状态模式"></a>状态模式</h1><p>通过<code>改变对象内部状态</code>帮助对象<code>控制行为</code>。</p>
<img src="/2017/04/12/design-patterns/StatePattern.png" alt="StatePattern.png" title="">
<p>Context将行为委托给当前状态</p>
<p>状态模式和策略模式类图一样，区别在于“意图”</p>
<p>策略模式通常用行为类或算法来<code>配置</code>Content，<br>可作为除继承外的弹性替代方案。</p>
<p>状态模式允许Context随状态的改变而<code>改变行为</code>，<br>可作为Context中放置很多<code>条件判断</code>的替代方案。</p>
<blockquote>
<p>使用抽象类实现状态模式，抽象类中容易添加新方法，<br>不需要打破具体状态实现。</p>
<p>状态转换放置在状态类中的缺点：状态类之间产生依赖。<br>通过使用Context上的getter方法把依赖减到最小。</p>
</blockquote>
<p>使用场景：酒店房间，未预定状态、已预定状态</p>
<p>HeadFirst示例：糖果机，等待投币、已投币、正在出售、已售罄</p>
<h1 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h1><p>为另一个对象提供一个替身或占位符以控制对这个对象的访问。</p>
<img src="/2017/04/12/design-patterns/proxyPattern.png" alt="proxyPattern.png" title="">
<p>应用场景：</p>
<ul>
<li>远程代理</li>
<li>虚拟代理</li>
<li>保护代理</li>
</ul>
<blockquote>
<p>虚拟代理：作为创建开销大的对象的代表。如：ImageProxy，图片加载完成前输出提示信息，加载完成刷新显示</p>
</blockquote>
<p>静态代理：代理类是在编译时就实现好的。代理类是一个实际的 class 文件。<br>动态代理：代理类是在运行时生成的。在<code>运行时动态生成的类字节码</code>，并加载到JVM中。</p>
<p>1.使用动态代理，动态为接口生成实现类(仅写接口不写实现)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 接口</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Subject</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">request</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 代理类的调用处理器</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">// do something</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicProxyDemo</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="comment">// 1.创建调用处理器对象</span></div><div class="line">        ProxyHandler handler = <span class="keyword">new</span> ProxyHandler(); </div><div class="line">        <span class="comment">// 2.动态生成代理对象</span></div><div class="line">        Subject proxySubject = (Subject) Proxy.newProxyInstance(Subject.class.getClassLoader(),</div><div class="line">                <span class="keyword">new</span> Class[] &#123; Subject.class &#125;, handler); </div><div class="line">        <span class="comment">//3.调用接口方法</span></div><div class="line">        proxySubject.request();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2.动态代理保护对象访问</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 接口</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Subject2</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Subject2Impl</span> <span class="keyword">implements</span> <span class="title">Subject2</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span> </span>&#123;</div><div class="line">        log();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Overrid</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;</div><div class="line">        log();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">()</span></span>&#123;</div><div class="line">        String className = <span class="keyword">this</span>.getClass().getName();</div><div class="line">        String methodName = Thread.currentThread().getStackTrace()[<span class="number">1</span>].getMethodName();</div><div class="line">        System.out.println(className + <span class="string">"."</span> + methodName + <span class="string">"() invoked."</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 代理类的调用处理器</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyHandler2</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Subject2 subject2;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProxyHandler2</span><span class="params">(Subject2 subject2)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.subject2 = subject2;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">// do something</span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span>(method.getName().equals(<span class="string">"method1"</span>))&#123;</div><div class="line">            <span class="keyword">return</span> method.invoke(subject2, args);</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            System.out.println(<span class="string">"You Have No permissions Invoke This Method"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicProxyDemo2</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Subject2 subject2 = <span class="keyword">new</span> Subject2Impl();</div><div class="line">        <span class="comment">// 1.创建调用处理器对象</span></div><div class="line">        ProxyHandler2 handler2 = <span class="keyword">new</span> ProxyHandler2(subject2); </div><div class="line">        <span class="comment">// 2.动态生成代理对象</span></div><div class="line">        Subject2 proxySubject2 = (Subject2) Proxy.newProxyInstance(Subject2.class.getClassLoader(),</div><div class="line">                <span class="keyword">new</span> Class[] &#123; Subject2.class &#125;, handler2); </div><div class="line">        </div><div class="line">        <span class="comment">//3.调用接口方法</span></div><div class="line">        proxySubject2.method1();</div><div class="line">        </div><div class="line">        proxySubject2.method2();</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>JDK中所要进行动态代理的类必须要实现一个接口，也就是说只能对该类所实现接口中定义的方法进行代理，这在实际编程中具有一定的局限性，而且使用反射的效率也并不是很高。</p>
<p>CGLIB是一个功能强大，高性能的代码生成包。它为没有实现接口的类提供代理，为JDK的动态代理提供了很好的补充。</p>
<p>CGLib不能对声明为final的方法进行代理</p>
<p>CGLib拦截类方法调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"></div><div class="line"><span class="keyword">import</span> net.sf.cglib.proxy.Enhancer;</div><div class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodInterceptor;</div><div class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodProxy;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TableDAO</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"create() is running !"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"query() is running !"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"update() is running !"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"delete() is running !"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TableDAOMethodInterceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy paoxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">            System.out.println(<span class="string">"before invoke "</span> + method.getName() + <span class="string">"()"</span>);</div><div class="line">            Object result = paoxy.invokeSuper(obj, args);</div><div class="line">            System.out.println(<span class="string">"after invoke "</span> + method.getName() + <span class="string">"()"</span>);</div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="comment">//拦截方法调用</span></div><div class="line">        Enhancer enhancer = <span class="keyword">new</span> Enhancer();</div><div class="line">        enhancer.setSuperclass(TableDAO.class);</div><div class="line">        enhancer.setCallback(<span class="keyword">new</span> TableDAOMethodInterceptor());</div><div class="line"></div><div class="line">        TableDAO tableDAOProxy = (TableDAO) enhancer.create();</div><div class="line"></div><div class="line">        System.out.println(tableDAOProxy.getClass().getName());</div><div class="line">        tableDAOProxy.create();</div><div class="line">        tableDAOProxy.delete();</div><div class="line">        tableDAOProxy.update();</div><div class="line">        tableDAOProxy.query();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>CGLib拦截接口方法调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"></div><div class="line"><span class="keyword">import</span> net.sf.cglib.proxy.Enhancer;</div><div class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodInterceptor;</div><div class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodProxy;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TableDAO</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">DAO</span></span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span></span>;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TableDAOMethodInterceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">            System.out.println(<span class="string">"before invoke "</span> + method.getName() + <span class="string">"()"</span>);</div><div class="line">            <span class="comment">//Object result = proxy.invokeSuper(obj, args);</span></div><div class="line">            System.out.println(<span class="string">"after invoke "</span> + method.getName() + <span class="string">"()"</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="comment">//拦截方法调用</span></div><div class="line">        Enhancer enhancer = <span class="keyword">new</span> Enhancer();</div><div class="line">        enhancer.setSuperclass(DAO.class);</div><div class="line">        enhancer.setCallback(<span class="keyword">new</span> TableDAOMethodInterceptor());</div><div class="line"></div><div class="line">        DAO tableDAOProxy = (DAO) enhancer.create();</div><div class="line"></div><div class="line">        <span class="comment">//System.out.println(tableDAOProxy.getClass().getName());</span></div><div class="line">        tableDAOProxy.create();</div><div class="line">        tableDAOProxy.delete();</div><div class="line">        tableDAOProxy.update();</div><div class="line">        tableDAOProxy.query();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>CGLIB原理：动态生成一个要代理类的子类，子类重写要代理的类的所有不是final的方法。<br>在子类中采用方法拦截的技术拦截所有父类方法的调用，顺势织入横切逻辑。<br>它比使用java反射的JDK动态代理要快。</p>
<p>CGLIB底层：使用字节码处理框架ASM，来转换字节码并生成新的类。</p>
<p>RMI：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.rmi.Remote;</div><div class="line"><span class="keyword">import</span> java.rmi.RemoteException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RMIInterface</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">helloTo</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.net.MalformedURLException;</div><div class="line"><span class="keyword">import</span> java.rmi.Naming;</div><div class="line"><span class="keyword">import</span> java.rmi.RemoteException;</div><div class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</div><div class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerOperation</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">RMIInterface</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">783820609710107386L</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">ServerOperation</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">helloTo</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException</span>&#123;</div><div class="line">        System.out.println(name + <span class="string">" is trying to contact!"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="string">"Server says hello to "</span> + name;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            LocateRegistry.createRegistry (<span class="number">1099</span>);</div><div class="line">            Naming.rebind(<span class="string">"//localhost/MyServer"</span>, <span class="keyword">new</span> ServerOperation());</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.net.MalformedURLException;</div><div class="line"><span class="keyword">import</span> java.rmi.Naming;</div><div class="line"><span class="keyword">import</span> java.rmi.NotBoundException;</div><div class="line"><span class="keyword">import</span> java.rmi.RemoteException;</div><div class="line"><span class="keyword">import</span> java.util.Scanner;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.sunday.rmi_learn.rmi.RMIInterface;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RmiClient</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            RMIInterface look_up = (RMIInterface) Naming.lookup(<span class="string">"rmi://localhost/MyServer"</span>);</div><div class="line">            Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</div><div class="line">            <span class="keyword">try</span>&#123;</div><div class="line">                <span class="keyword">if</span>(scanner.hasNext())&#123;</div><div class="line">                    String txt = scanner.nextLine();</div><div class="line">                    String response = look_up.helloTo(txt);</div><div class="line">                    System.out.println(response);</div><div class="line">                &#125;</div><div class="line">            &#125;<span class="keyword">finally</span> &#123;</div><div class="line">                scanner.close();</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">//String txt = JOptionPane.showInputDialog("What is your name?");</span></div><div class="line">            <span class="comment">//JOptionPane.showMessageDialog(null, reponse);</span></div><div class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (NotBoundException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代理模式与装饰着模式区别：<br>代理模式，使用组合模式；装饰者模式使用组合模式。<br>装饰着为对象增加行为，代理是控制对象的访问。</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[JavaSE集合]]></title>
      <url>http://xiaozhuang.github.io/2017/03/23/javase-collection/</url>
      <content type="html"><![CDATA[<p>JavaSE 集合笔记<br><a id="more"></a></p>
<h1 id="Collection"><a href="#Collection" class="headerlink" title="Collection"></a>Collection</h1><img src="/2017/03/23/javase-collection/JavaCollectionsAPICollection.jpg" alt="JavaCollectionsAPICollection.jpg" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="https://www.karambelkar.info/2012/06/java-1.7-collections---uml-class-diagrams/" target="_blank" rel="external">Java 1.7 Collections - UML Class Diagrams</a></cite></footer></blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// java.util.Collection&lt;E&gt; 1.2 API</span></div><div class="line"><span class="keyword">package</span> java.util;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Collection</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">Iterable</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">    <span class="function">Iterator&lt;E&gt; <span class="title">iterator</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">containsAll</span><span class="params">(Collection&lt;?&gt; c)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// 确实改变了集合返回true，否则返回false</span></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(Collection&lt;? extends E&gt; c)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">removeAll</span><span class="params">(Collection&lt;?&gt; c)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// 仅保留此指定 collection 包含的元素</span></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">retainAll</span><span class="params">(Collection&lt;?&gt; c)</span></span>;</div><div class="line"></div><div class="line">    Object[] toArray();</div><div class="line">    <span class="comment">// 若arrayToFill足够大，就将集合中的元素填入数组，剩余空间补null；否则创建一个新数组</span></div><div class="line">    &lt;T&gt; T[] toArray(T[] a);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// java.util.Iterator&lt;E&gt; 1.2 API</span></div><div class="line"><span class="keyword">package</span> java.util;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Iterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// 返回将要访问的下一个元素</span></div><div class="line">    <span class="function">E <span class="title">next</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// 删除上次调用next方法返回的元素</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 遍历过程中移除元素</span></div><div class="line">Iterator&lt;Goods&gt; goodsIterator = goodsList.iterator();</div><div class="line"><span class="keyword">while</span> (goodsIterator.hasNext()) &#123;</div><div class="line">    Goods goods = goodsIterator.next();</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == goods) &#123;</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (matchSku.equals(String.valueOf(expectSku)) &amp;&amp; goodCount.equals(expectGoodsCount)) &#123;</div><div class="line">        goodsRelation.setGoodsId(goods.getGoodId());</div><div class="line">        goodsIterator.remove();<span class="comment">//goods表中记录仅被匹配一次</span></div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>“for each”循环可以与任何实现了Iterable接口的对象一起工作</li>
<li>应该将Java迭代器认为是位于<code>两个元素之间</code>。当调用next时，迭代器越过下一个元素，并返回刚刚越过的那个元素的引用。</li>
</ul>
<img src="/2017/03/23/javase-collection/Iterator.jpeg" alt="Iterator.jpeg" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="http://blog.csdn.net/u011240877/article/details/52752589" target="_blank" rel="external">Java 集合源码解析（2）:ListIterator</a></cite></footer></blockquote>
<h1 id="List"><a href="#List" class="headerlink" title="List"></a>List</h1><img src="/2017/03/23/javase-collection/JavaCollectionsList.png" alt="JavaCollectionsList.png" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="https://www.karambelkar.info/2012/06/java-1.7-collections---uml-class-diagrams/" target="_blank" rel="external">Java 1.7 Collections - UML Class Diagrams</a></cite></footer></blockquote>
<p>通过索引添加、删除元素，提供ListIterator</p>
<p>ListIterator允许按任一方向遍历列表、迭代期间修改列表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> java.util;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ListIterator</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">Iterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">// 在迭代器位置之前添加一个对象</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(E e)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(E e)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasPrevious</span><span class="params">()</span></span>;</div><div class="line">    <span class="function">E <span class="title">previous</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>;</div><div class="line">    <span class="function">E <span class="title">next</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// 返回下次调用next()方法返回的元素的索引</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">nextIndex</span><span class="params">()</span></span>;</div><div class="line">    <span class="comment">// 返回下次调用previous()将返回的元素索引</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">previousIndex</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h2><img src="/2017/03/23/javase-collection/arraylist.png" alt="arraylist.png" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="https://www.javatpoint.com/java-arraylist" target="_blank" rel="external">Java ArrayList class</a></cite></footer></blockquote>
<p>采用<code>动态数组</code>存储元素</p>
<ul>
<li>可以包含重复元素</li>
<li>维持元素插入顺序</li>
<li>非线程安全的</li>
<li>通过索引随机访问</li>
<li>列表中间增删元素慢（需要移动大量元素）</li>
</ul>
<blockquote>
<p>public interface RandomAccess，List 实现所使用的标记接口，用来表明其支持快速（通常是固定时间）随机访问。</p>
</blockquote>
<p>数组扩容：ArrayList在插入元素时，会检查当前的数组大小是否足够，如果不够，将会扩容到<code>当前容量</code> * <code>1.5</code> + <code>1</code>（加1是为了当前容量为1时，也能扩展到2），把元素全部添加到新数组，将旧数组抛弃掉(等待垃圾回收)。<br>扩容操作比较耗时，建议在创建ArrayList时，根据需要<code>初步估计</code>Capacity，并初始化ArrayList</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractList</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">        <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt;, <span class="title">RandomAccess</span>, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">8683452581122892189L</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Object[] elementData;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal Capacity: "</span>+</div><div class="line">                                               initialCapacity);</div><div class="line">        <span class="keyword">this</span>.elementData = <span class="keyword">new</span> Object[initialCapacity];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(<span class="number">10</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</div><div class="line">        elementData = c.toArray();</div><div class="line">        size = elementData.length;</div><div class="line">        <span class="comment">// c.toArray might (incorrectly) not return Object[] (see 6260652)</span></div><div class="line">        <span class="comment">// bug 6260652:Arrays.asList(x).toArray().getClass() should be Object[].class</span></div><div class="line">        <span class="keyword">if</span> (elementData.getClass() != Object[].class)</div><div class="line">            elementData = Arrays.copyOf(elementData, size, Object[].class);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ensureCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</div><div class="line">        modCount++;</div><div class="line">        <span class="keyword">int</span> oldCapacity = elementData.length;</div><div class="line">        <span class="keyword">if</span> (minCapacity &gt; oldCapacity) &#123;</div><div class="line">            Object oldData[] = elementData;</div><div class="line">            <span class="keyword">int</span> newCapacity = (oldCapacity * <span class="number">3</span>)/<span class="number">2</span> + <span class="number">1</span>;</div><div class="line">                <span class="keyword">if</span> (newCapacity &lt; minCapacity)</div><div class="line">            newCapacity = minCapacity;</div><div class="line">                <span class="comment">// minCapacity is usually close to size, so this is a win:</span></div><div class="line">                elementData = Arrays.copyOf(elementData, newCapacity);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h2><img src="/2017/03/23/javase-collection/linkedlist.png" alt="linkedlist.png" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="https://www.javatpoint.com/java-linkedlist" target="_blank" rel="external">Java ArrayList class</a></cite></footer></blockquote>
<p>使用<code>双向链表</code>实现</p>
<ul>
<li>可包含重复元素</li>
<li>维持元素插入顺序</li>
<li>非线程安全的</li>
<li>列表中间增删元素快（不需要移动元素）</li>
<li>可以被用作列表、栈 或 队列</li>
</ul>
<p>Difference between ArrayList and LinkedList</p>
<table>
<thead>
<tr>
<th>ArrayList</th>
<th>LinkedList</th>
</tr>
</thead>
<tbody>
<tr>
<td>动态数组实现</td>
<td>链表实现</td>
</tr>
<tr>
<td>随机访问效率高，随机插入、删除效率低</td>
<td>随机访问效率低，随机插入、删除效率高</td>
</tr>
</tbody>
</table>
<p>使用链表的唯一理由是尽可能地<code>减少</code>在列表中间<code>插入</code>或<code>删除</code>元素所付出的代价<br>建议避免使用以<code>整数索引</code>表示链表中位置的所有方法</p>
<p>多个线程同时访问一个链表，则必须 使用外部同步。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractSequentialList</span>&lt;<span class="title">E</span>&gt; </span></div><div class="line">        <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt;, <span class="title">Deque</span>&lt;<span class="title">E</span>&gt;, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Entry&lt;E&gt; header = <span class="keyword">new</span> Entry&lt;E&gt;(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">int</span> size = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LinkedList</span><span class="params">()</span> </span>&#123;</div><div class="line">        header.next = header.previous = header;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LinkedList</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>();</div><div class="line">        addAll(c);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">        E element;</div><div class="line">        Entry&lt;E&gt; next;</div><div class="line">        Entry&lt;E&gt; previous;</div><div class="line">        Entry(E element, Entry&lt;E&gt; next, Entry&lt;E&gt; previous) &#123;</div><div class="line">            <span class="keyword">this</span>.element = element;</div><div class="line">            <span class="keyword">this</span>.next = next;</div><div class="line">            <span class="keyword">this</span>.previous = previous;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Vector"><a href="#Vector" class="headerlink" title="Vector"></a>Vector</h2><p>Vector是ArrayList的线程同步版本</p>
<p>已过时（不足）：</p>
<ul>
<li>同步每个方法，不能对同步进行细粒度控制</li>
<li>以2倍进行扩容</li>
<li>Vector将<code>动态数组</code>和<code>同步每个方法</code>整合在一起不是一个好的设计</li>
<li>集合上需包含一组<code>以原子方式</code>执行的操作时，需要外部加锁，造成集合本身锁冗余</li>
</ul>
<p>Vector的Iterator不支持修改(抛出异常)</p>
<h2 id="Stack"><a href="#Stack" class="headerlink" title="Stack"></a>Stack</h2><p>后进先出（LIFO）的对象堆栈。承自Vector类。</p>
<p>Deque 接口及其实现提供了 LIFO 堆栈更完整和更一致的操作，应该优先使用Deque，而非Stack</p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Deque&lt;Integer&gt; stack = <span class="keyword">new</span> ArrayDeque&lt;Integer&gt;();</div></pre></td></tr></table></figure>
<h2 id="集合同步包装器"><a href="#集合同步包装器" class="headerlink" title="集合同步包装器"></a>集合同步包装器</h2><p>Vector 和 Hashtable类提供了线程安全的动态数组和散列表的实现。<br>现在这些类<code>被弃用</code>了，取而代之的是ArrayList 和 HashMap。</p>
<p>任何集合类通过使用同步包装器（synchronization wrapper）变成线程安全的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">List&lt;E&gt; synchArrayList = Collections.synchronizedList(<span class="keyword">new</span> ArrayList&lt;E&gt;());</div><div class="line">Map&lt;K, V&gt; synchHashMap = Collections.synchronizedMap(<span class="keyword">new</span> HashMap&lt;K ,V&gt;());</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// java.util.Collections.synchronizedList(List&lt;T&gt;)</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">synchronizedList</span><span class="params">(List&lt;T&gt; list)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (list <span class="keyword">instanceof</span> RandomAccess ?</div><div class="line">                <span class="keyword">new</span> SynchronizedRandomAccessList&lt;T&gt;(list) :</div><div class="line">                <span class="keyword">new</span> SynchronizedList&lt;T&gt;(list));</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// java.util.Collections.SynchronizedList&lt;E&gt;</span></div><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedList</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">    <span class="keyword">extends</span> <span class="title">SynchronizedCollection</span>&lt;<span class="title">E</span>&gt;</div><div class="line">    <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt; &#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">7754090372962971524L</span>;</div><div class="line"></div><div class="line">    <span class="comment">//聚合</span></div><div class="line">    <span class="comment">//final域</span></div><div class="line">    <span class="keyword">final</span> List&lt;E&gt; list;</div><div class="line"></div><div class="line">    SynchronizedList(List&lt;E&gt; list) &#123;</div><div class="line">        <span class="keyword">super</span>(list);</div><div class="line">        <span class="keyword">this</span>.list = list;</div><div class="line">    &#125;</div><div class="line">    SynchronizedList(List&lt;E&gt; list, Object mutex) &#123;</div><div class="line">        <span class="keyword">super</span>(list, mutex);</div><div class="line">        <span class="keyword">this</span>.list = list;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">        <span class="comment">//默认使用this作为锁对象，可以指定锁对象</span></div><div class="line">        <span class="keyword">synchronized</span>(mutex) &#123;<span class="keyword">return</span> list.get(index);&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>包装后集合的方法<code>使用锁保护</code>，提供了线程的安全访问。</p>
<p>如果一个线程进行修改时要对集合<code>迭代</code>，仍然需要使用“客户端”锁定:<br>因为若迭代过程中，其他线程修改集合结构，<br>迭代器会失效，抛出ConcurrentMedificationException</p>
<p>结构修改指<code>添加</code>或<code>删除</code>一个或多个元素的任何操作；仅设置元素的值不是结构修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">synchronized</span> (synchHashMap)&#123;</div><div class="line">    Iterator&lt;K&gt; iter = synchHashMap.keySet().iterator();</div><div class="line">    <span class="keyword">while</span>(iter.hasNext())&#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="CopyOnWriteArrayList"><a href="#CopyOnWriteArrayList" class="headerlink" title="CopyOnWriteArrayList"></a>CopyOnWriteArrayList</h1><p><code>java.util.concurrent.CopyOnWriteArrayList&lt;E&gt;</code></p>
<p>基于<code>数组</code>实现</p>
<ul>
<li>线程安全</li>
<li>适用于迭代多，修改极少场景（如事件处理器列表，即观察者列表）</li>
</ul>
<p>其所有可变操作（add、set、remove等）都是通过对<code>底层数组</code>进行一次<code>复制</code>来实现的。<br><code>快照</code>风格的迭代器方法在创建迭代器时使用了对数组状态的引用。<br>创建迭代器以后，迭代器就不会反映列表的添加、移除或者更改。<br>在迭代器上进行的元素更改操作（remove、set 和 add）<code>不受支持</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CopyOnWriteArrayList</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">    <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt;, <span class="title">RandomAccess</span>, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> &#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">8673264195747942595L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** The lock protecting all mutators */</span></div><div class="line">    <span class="keyword">transient</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line"></div><div class="line">    <span class="comment">/** The array, accessed only via getArray/setArray. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">transient</span> Object[] array;</div><div class="line"></div><div class="line">    <span class="comment">// 添加元素</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</div><div class="line">        lock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Object[] elements = getArray();</div><div class="line">            <span class="keyword">int</span> len = elements.length;</div><div class="line">            Object[] newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);</div><div class="line">            newElements[len] = e;</div><div class="line">            setArray(newElements);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Iterator&lt;E&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> COWIterator&lt;E&gt;(getArray(), <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">COWIterator</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">ListIterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">        <span class="comment">/** Snapshot of the array **/</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Object[] snapshot;</div><div class="line">        <span class="comment">/** Index of element to be returned by subsequent call to next.  */</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> cursor;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">COWIterator</span><span class="params">(Object[] elements, <span class="keyword">int</span> initialCursor)</span> </span>&#123;</div><div class="line">            cursor = initialCursor;</div><div class="line">            snapshot = elements;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> cursor &lt; snapshot.length;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> E <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (! hasNext())</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</div><div class="line">        <span class="keyword">return</span> (E) snapshot[cursor++];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Set接口"><a href="#Set接口" class="headerlink" title="Set接口"></a>Set接口</h1><img src="/2017/03/23/javase-collection/JavaCollectionsAPISet.jpg" alt="JavaCollectionsAPISet.jpg" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="https://www.karambelkar.info/2012/06/java-1.7-collections---uml-class-diagrams/" target="_blank" rel="external">Java 1.7 Collections - UML Class Diagrams</a></cite></footer></blockquote>
<p>Set是不能包含<code>重复元素</code>的容器</p>
<p>Set最常使用的场景是<code>测试归属性</code>，可以很容易的寻找某个对象是否在某个Set中。</p>
<h2 id="HashSet"><a href="#HashSet" class="headerlink" title="HashSet"></a>HashSet</h2><img src="/2017/03/23/javase-collection/hashset.png" alt="hashset.png" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="https://www.karambelkar.info/2012/06/java-1.7-collections---uml-class-diagrams/" target="_blank" rel="external">Java HashSet class</a></cite></footer></blockquote>
<p>基于<code>HashMap</code>实现</p>
<ul>
<li>不包含重复元素</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 元素已存在，添加到set中并返回false</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> map.put(e, PRESENT)==<span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="LinkedHashSet"><a href="#LinkedHashSet" class="headerlink" title="LinkedHashSet"></a>LinkedHashSet</h2><img src="/2017/03/23/javase-collection/linkedhashset.png" alt="linkedhashset.png" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="https://www.javatpoint.com/java-linkedhashset" target="_blank" rel="external">Java LinkedHashSet class</a></cite></footer></blockquote>
<p>基于<code>LinkedHashMap</code>实现</p>
<ul>
<li>维持元素插入顺序</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedHashSet</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">    <span class="keyword">extends</span> <span class="title">HashSet</span>&lt;<span class="title">E</span>&gt;</div><div class="line">    <span class="keyword">implements</span> <span class="title">Set</span>&lt;<span class="title">E</span>&gt;, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> &#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">2851667679971038690L</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LinkedHashSet</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(initialCapacity, loadFactor, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LinkedHashSet</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(initialCapacity, .<span class="number">75f</span>, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LinkedHashSet</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(<span class="number">16</span>, .<span class="number">75f</span>, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LinkedHashSet</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(Math.max(<span class="number">2</span>*c.size(), <span class="number">11</span>), .<span class="number">75f</span>, <span class="keyword">true</span>);</div><div class="line">        addAll(c);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// HashSet 同包访问权限 构造函数；使用虚拟参数dummy作为重载标示 </span></div><div class="line">HashSet(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor, <span class="keyword">boolean</span> dummy) &#123;</div><div class="line">    map = <span class="keyword">new</span> LinkedHashMap&lt;E,Object&gt;(initialCapacity, loadFactor);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="TreeSet"><a href="#TreeSet" class="headerlink" title="TreeSet"></a>TreeSet</h2><img src="/2017/03/23/javase-collection/treeset.png" alt="treeset.png" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="https://www.javatpoint.com/java-treeset" target="_blank" rel="external">Java TreeSet class</a></cite></footer></blockquote>
<p>基于<code>TreeMap</code>实现</p>
<ul>
<li>使用元素<code>自然顺序</code>进行排序</li>
<li>添加元素比HashSet慢，比将元素添加到<code>数组</code>或<code>链表</code>的<code>正确位置</code>上快很多</li>
</ul>
<p>此实现为基本操作（add、remove 和 contains）提供受保证的 <code>O(log(n))</code> 时间开销</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// java.util.SortedSet&lt;E&gt; 1.2</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SortedSet</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">Set</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">// 返回此 set 的部分视图</span></div><div class="line">    <span class="comment">// fromElement - 返回 set 的低端点（包括）</span></div><div class="line">    <span class="comment">// toElement - 返回 set 的高端点（不包括）</span></div><div class="line">    <span class="function">SortedSet&lt;E&gt; <span class="title">subSet</span><span class="params">(E fromElement, E toElement)</span></span>;</div><div class="line">    <span class="function">SortedSet&lt;E&gt; <span class="title">headSet</span><span class="params">(E toElement)</span></span>;</div><div class="line">    <span class="function">SortedSet&lt;E&gt; <span class="title">tailSet</span><span class="params">(E fromElement)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">//最小元素</span></div><div class="line">    <span class="function">E <span class="title">first</span><span class="params">()</span></span>;</div><div class="line">    <span class="function">E <span class="title">last</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// 用于元素排序的比较器</span></div><div class="line">    Comparator&lt;? <span class="keyword">super</span> E&gt; comparator();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NavigableSet</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">SortedSet</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">//小于e的最大元素 </span></div><div class="line">    <span class="function">E <span class="title">lower</span><span class="params">(E e)</span></span>;</div><div class="line">    <span class="comment">//大于e的最小元素</span></div><div class="line">    <span class="function">E <span class="title">higher</span><span class="params">(E e)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">//小于等于e的最大元素</span></div><div class="line">    <span class="function">E <span class="title">floor</span><span class="params">(E e)</span></span>;</div><div class="line">    <span class="comment">//大于等于e的最小元素</span></div><div class="line">    <span class="function">E <span class="title">ceiling</span><span class="params">(E e)</span></span>;</div><div class="line">    </div><div class="line">    <span class="comment">//删除并返回最小元素</span></div><div class="line">    <span class="function">E <span class="title">pollFirst</span><span class="params">()</span></span>;</div><div class="line">    <span class="comment">//删除并返回最大元素</span></div><div class="line">    <span class="function">E <span class="title">pollLast</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="comment">//返回此 set 中所包含元素的逆序视图</span></div><div class="line">    <span class="function">NavigableSet&lt;E&gt; <span class="title">descendingSet</span><span class="params">()</span></span>;</div><div class="line">    <span class="comment">//以降序返回在此 set 的元素上进行迭代的迭代器</span></div><div class="line">    <span class="function">Iterator&lt;E&gt; <span class="title">descendingIterator</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// 返回此 set 的部分视图</span></div><div class="line">    <span class="function">NavigableSet&lt;E&gt; <span class="title">subSet</span><span class="params">(E fromElement, <span class="keyword">boolean</span> fromInclusive,</span></span></div><div class="line">                           E toElement,   <span class="keyword">boolean</span> toInclusive);</div><div class="line">    <span class="function">NavigableSet&lt;E&gt; <span class="title">headSet</span><span class="params">(E toElement, <span class="keyword">boolean</span> inclusive)</span></span>;</div><div class="line">    <span class="function">NavigableSet&lt;E&gt; <span class="title">tailSet</span><span class="params">(E fromElement, <span class="keyword">boolean</span> inclusive)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>存放的对象实现<code>Comparable</code>接口或提供<code>Comparator</code></p>
<p>使用Comparable接口定义排序有局限性，一个类<code>只能实现一种排序策略</code>；<br>通过定义多个Comparator，可定义<code>不同的排序策略</code>；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Comparable接口</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Comparable</span>&lt;<span class="title">T</span>&gt;</span>&#123;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(T other)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Item</span>&gt;</span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Item other)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> partNumber - other.partNumber;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// Comparator接口</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Comparator</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">compare</span><span class="params">(T o1, T o2)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">//从另一个集合添加元素，从使用相同比较器的另一个集合添加元素，实现equals方法，TreeSet的addAll()效率会更高</span></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ItemComparator</span>&lt;<span class="title">Item</span>&gt;</span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Item a, Item b)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> a.partNumber - b.partNumber;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>比较器没有任何数据。这种对象称为函数对象。<br>函数对象通常<code>动态定义</code>,即定义为<code>匿名内部类</code>的实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">SortedSet&lt;Item&gt; sortByDescription = <span class="keyword">new</span> TreeSet&lt;Item&gt;(<span class="keyword">new</span> Comparator&lt;Item&gt;()&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Item a, Item b)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> a.partNumber - b.partNumber;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="EnumSet"><a href="#EnumSet" class="headerlink" title="EnumSet"></a>EnumSet</h2><img src="/2017/03/23/javase-collection/enumset.png" alt="enumset.png" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="https://www.javatpoint.com/java-enumset" target="_blank" rel="external">Java EnumSet class</a></cite></footer></blockquote>
<p>与枚举类型一起使用的专用 Set 实现。<br>所有基本操作都在固定时间内执行。虽然并不保证，但它们很可能比其 HashSet 副本更快。<br>如果其参数也是一个枚举 set ，则批量操作会在固定时间内执行。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnumSetExample</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">enum</span> DayEnum &#123;</div><div class="line">        SUNDAY, MONDAY, TUESDAY, WEDNESDAY, THURSDAY, FRIDAY, SATURDAY;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </div><div class="line">        Set&lt;DayEnum&gt; dayEnums = EnumSet.allOf(DayEnum.class);  </div><div class="line"></div><div class="line">        EnumSet&lt;DayEnum&gt; emptyDayEnums = EnumSet.noneOf(DayEnum.class);</div><div class="line">        emptyDayEnums.add(DayEnum.SUNDAY);  </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="CopyOnWriteArraySet"><a href="#CopyOnWriteArraySet" class="headerlink" title="CopyOnWriteArraySet"></a>CopyOnWriteArraySet</h2><p><code>java.util.concurrent.CopyOnWriteArraySet&lt;E&gt;</code></p>
<p>使用组合模式，基于CopyOnWriteArrayList实现</p>
<ul>
<li>线程安全</li>
<li>使用于迭代多，修改极少且不包含重复元素场景（如事件处理器集合）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CopyOnWriteArraySet</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractSet</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">        <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> &#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">5457747651344034263L</span>;</div><div class="line"></div><div class="line">    <span class="comment">//final域</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CopyOnWriteArrayList&lt;E&gt; al;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates an empty set.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CopyOnWriteArraySet</span><span class="params">()</span> </span>&#123;</div><div class="line">        al = <span class="keyword">new</span> CopyOnWriteArrayList&lt;E&gt;();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a set containing all of the elements of the specified</div><div class="line">     * collection.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> c the collection of elements to initially contain</div><div class="line">     * <span class="doctag">@throws</span> NullPointerException if the specified collection is null</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CopyOnWriteArraySet</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</div><div class="line">        al = <span class="keyword">new</span> CopyOnWriteArrayList&lt;E&gt;();</div><div class="line">        al.addAllAbsent(c);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ConcurrentSkipListSet"><a href="#ConcurrentSkipListSet" class="headerlink" title="ConcurrentSkipListSet"></a>ConcurrentSkipListSet</h2><p><code>java.util.concurrent.ConcurrentSkipListSet&lt;E&gt;</code></p>
<p>基于 <code>ConcurrentSkipListMap</code></p>
<ul>
<li>线程安全</li>
<li>使用元素<code>自然顺序</code>进行排序（实现NavigableSet<e>接口）</e></li>
</ul>
<p>此实现为 contains、add、remove 操作提供预期平均 log(n) 时间开销<br>迭代器是 <code>弱一致</code> 的，返回的元素将反映迭代器<code>创建时</code>或<code>创建后某一时刻</code>的 set 状态</p>
<p>用来替代<code>同步</code>的SortedSet</p>
<h1 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h1><img src="/2017/03/23/javase-collection/JavaCollectionsAPIQueue.jpg" alt="JavaCollectionsAPIQueue.jpg" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="https://www.karambelkar.info/2012/06/java-1.7-collections---uml-class-diagrams/" target="_blank" rel="external">Java 1.7 Collections - UML Class Diagrams</a></cite></footer></blockquote>
<p>队列通常（但并非一定）以 FIFO（先进先出）的方式排序各个元素</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>抛出异常</th>
<th>返回特殊值</th>
</tr>
</thead>
<tbody>
<tr>
<td>添加</td>
<td>boolean add(E e)</td>
<td>boolean offer(E e)</td>
</tr>
<tr>
<td>移除</td>
<td>E remove()</td>
<td>E poll()</td>
</tr>
<tr>
<td>检查</td>
<td>E element()</td>
<td>E peek()</td>
</tr>
</tbody>
</table>
<h2 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h2><p>一个基于优先级堆的<code>无界</code>优先级队列。<br>优先级队列使用一个高雅且高效的数据结构，堆(heap)。<br>堆是一个可以自我调整的二叉树，对树执行添加(add)和删除(remove)操作，可以让<code>最小</code>的元素移动到根，而<code>不必花费时间对元素进行排序</code>。</p>
<p>典型示例，huffman编码压缩算法(构建二叉树)、任务调度。</p>
<blockquote>
<a href="http://coolshell.cn/articles/7459.html" title="huffman编码压缩算法" target="_blank" rel="external">huffman编码压缩算法</a>
</blockquote>
<p>方法 iterator() 提供的迭代器<code>不保证</code>以任何特定的顺序遍历优先级队列中的元素。</p>
<p>此实现为排队和出队方法（<code>offer</code>、<code>poll</code>、remove 和 add）提供 <code>O(log(n))</code> 时间开销；<br>为方法 contains(Object) 提供<code>O(n)</code>时间开销；<br>为方法（<code>peek</code>、element 和 size）提供<code>O(1)</code>时间开销。</p>
<img src="/2017/03/23/javase-collection/20170412095010290.gif" alt="20170412095010290.gif" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="http://blog.csdn.net/jim_cainiaoxiaolang/article/details/70139324" target="_blank" rel="external">深入Java集合系列之五：PriorityQueue</a></cite></footer></blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PriorityQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractQueue</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">    <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> &#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">7720805057305804111L</span>;</div><div class="line"></div><div class="line">    <span class="comment">//默认容量 11</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">11</span>;</div><div class="line"></div><div class="line">    <span class="comment">//动态数组存储元素</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Object[] queue;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Comparator&lt;? <span class="keyword">super</span> E&gt; comparator;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">int</span> modCount = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PriorityQueue</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(DEFAULT_INITIAL_CAPACITY, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PriorityQueue</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(initialCapacity, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PriorityQueue</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></div><div class="line">                         Comparator&lt;? <span class="keyword">super</span> E&gt; comparator) &#123;</div><div class="line">        <span class="comment">// Note: This restriction of at least one is not actually needed,</span></div><div class="line">        <span class="comment">// but continues for 1.5 compatibility</span></div><div class="line">        <span class="keyword">if</span> (initialCapacity &lt; <span class="number">1</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</div><div class="line">        <span class="keyword">this</span>.queue = <span class="keyword">new</span> Object[initialCapacity];</div><div class="line">        <span class="keyword">this</span>.comparator = comparator;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//添加元素</span></div><div class="line">    <span class="comment">//当前节点元素小于父节点元素，将父元素移动至当前节点，以父节点为当前节点继续检查</span></div><div class="line">    <span class="comment">//当前节点不小于父节点，将元素放置到当前节点</span></div><div class="line">    <span class="comment">//最终构造一棵子节点不大于父节点的二叉树树</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">siftUpComparable</span><span class="params">(<span class="keyword">int</span> k, E x)</span> </span>&#123;</div><div class="line">        Comparable&lt;? <span class="keyword">super</span> E&gt; key = (Comparable&lt;? <span class="keyword">super</span> E&gt;) x;</div><div class="line">        <span class="keyword">while</span> (k &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">//父节点</span></div><div class="line">            <span class="keyword">int</span> parent = (k - <span class="number">1</span>) &gt;&gt;&gt; <span class="number">1</span>;</div><div class="line">            Object e = queue[parent];</div><div class="line">            <span class="keyword">if</span> (key.compareTo((E) e) &gt;= <span class="number">0</span>)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            queue[k] = e;</div><div class="line">            k = parent;</div><div class="line">        &#125;</div><div class="line">        queue[k] = key;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取元素</span></div><div class="line">    <span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (size == <span class="number">0</span>)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">int</span> s = --size;</div><div class="line">        modCount++;</div><div class="line">        <span class="comment">//获取第一个元素，作为返回结果</span></div><div class="line">        E result = (E) queue[<span class="number">0</span>];</div><div class="line">        <span class="comment">//获取最后一个元素</span></div><div class="line">        E x = (E) queue[s];</div><div class="line">        queue[s] = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (s != <span class="number">0</span>)</div><div class="line">            <span class="comment">//最后一个元素从顶端执行下调</span></div><div class="line">            siftDown(<span class="number">0</span>, x);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">siftDownComparable</span><span class="params">(<span class="keyword">int</span> k, E x)</span> </span>&#123;</div><div class="line">        Comparable&lt;? <span class="keyword">super</span> E&gt; key = (Comparable&lt;? <span class="keyword">super</span> E&gt;)x;</div><div class="line">        <span class="comment">// 非叶子节点元素的最大位置(叶子节点数等于非叶子节点数或非叶子节点数加一)</span></div><div class="line">        <span class="keyword">int</span> half = size &gt;&gt;&gt; <span class="number">1</span>;        <span class="comment">// loop while a non-leaf</span></div><div class="line">        <span class="keyword">while</span> (k &lt; half) &#123;</div><div class="line">            <span class="keyword">int</span> child = (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>; <span class="comment">// assume left child is least</span></div><div class="line">            Object c = queue[child];</div><div class="line">            <span class="keyword">int</span> right = child + <span class="number">1</span>;</div><div class="line">            <span class="keyword">if</span> (right &lt; size &amp;&amp;</div><div class="line">                ((Comparable&lt;? <span class="keyword">super</span> E&gt;) c).compareTo((E) queue[right]) &gt; <span class="number">0</span>)</div><div class="line">                c = queue[child = right];</div><div class="line">            <span class="keyword">if</span> (key.compareTo((E) c) &lt;= <span class="number">0</span>)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            queue[k] = c;</div><div class="line">            k = child;</div><div class="line">        &#125;</div><div class="line">        queue[k] = key;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="BlockingQueue"><a href="#BlockingQueue" class="headerlink" title="BlockingQueue"></a>BlockingQueue</h2><p><code>java.util.concurrent.BlockingQueue&lt;E&gt;</code></p>
<p>支持两个附加操作的 Queue<br>这两个操作是：获取元素时<code>等待队列变为非空</code>，以及存储元素时<code>等待空间变得可用</code>。 </p>
<table>
<thead>
<tr>
<th>操作</th>
<th>抛出异常</th>
<th>特殊值</th>
<th>阻塞</th>
<th>超时 </th>
</tr>
</thead>
<tbody>
<tr>
<td>插入</td>
<td>add(e)</td>
<td>offer(e)</td>
<td>put(e)</td>
<td>offer(e, time, unit) </td>
</tr>
<tr>
<td>移除</td>
<td>remove()</td>
<td>poll()</td>
<td>take()</td>
<td>poll(time, unit) </td>
</tr>
<tr>
<td>检查</td>
<td>element()</td>
<td>peek()</td>
<td>不可用</td>
<td>不可用 </td>
</tr>
</tbody>
</table>
<h2 id="PriorityBlockingQueue"><a href="#PriorityBlockingQueue" class="headerlink" title="PriorityBlockingQueue"></a>PriorityBlockingQueue</h2><p><code>java.util.concurrent.PriorityBlockingQueue&lt;E&gt;</code></p>
<p>一个无界阻塞队列，提供了阻塞获取操作,使用与 PriorityQueue 相同的顺序规则。</p>
<p>基于组合模式，使用PriorityQueue和ReentrantLock实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PriorityBlockingQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractQueue</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">    <span class="keyword">implements</span> <span class="title">BlockingQueue</span>&lt;<span class="title">E</span>&gt;, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> &#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">5595510919245408276L</span>;</div><div class="line"></div><div class="line">    <span class="comment">//final域</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PriorityQueue&lt;E&gt; q;</div><div class="line">    <span class="comment">//参数fair，公平锁</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition notEmpty = lock.newCondition();</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PriorityBlockingQueue</span><span class="params">()</span> </span>&#123;</div><div class="line">        q = <span class="keyword">new</span> PriorityQueue&lt;E&gt;();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//线程安全添加元素</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</div><div class="line">        lock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">boolean</span> ok = q.offer(e);</div><div class="line">            <span class="keyword">assert</span> ok;</div><div class="line">            <span class="comment">//唤醒一个等待线程</span></div><div class="line">            notEmpty.signal();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//阻塞方式获取元素</span></div><div class="line">    <span class="function"><span class="keyword">public</span> E <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</div><div class="line">        <span class="comment">//如果当前线程未被中断，则获取锁</span></div><div class="line">        <span class="comment">//如果锁可用，则获取锁，并立即返回。 </span></div><div class="line">        <span class="comment">//如果锁不可用，该线程将一直处于休眠状态，直到锁由当前线程获得或当前线程被中断</span></div><div class="line">        lock.lockInterruptibly();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">//Condition 应该总是在一个循环中被等待，并测试正被等待的状态声明</span></div><div class="line">                <span class="keyword">while</span> (q.size() == <span class="number">0</span>)</div><div class="line">                    notEmpty.await();</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</div><div class="line">                notEmpty.signal(); <span class="comment">// propagate to non-interrupted thread</span></div><div class="line">                <span class="keyword">throw</span> ie;</div><div class="line">            &#125;</div><div class="line">            E x = q.poll();</div><div class="line">            <span class="keyword">assert</span> x != <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">return</span> x;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ArrayBlockingQueue"><a href="#ArrayBlockingQueue" class="headerlink" title="ArrayBlockingQueue"></a>ArrayBlockingQueue</h2><p><code>java.util.concurrent.ArrayBlockingQueue&lt;E&gt;</code></p>
<p>使用<code>数组</code>和<code>ReentrantLock</code>实现</p>
<p>适合于<code>消费者生产者</code>模式</p>
<p>一个由<code>数组</code>支持的<code>有界阻塞</code>队列。此队列按 FIFO（先进先出）原则对元素进行排序。</p>
<p>此类支持对等待的生产者线程和使用者线程进行排序的<code>可选公平策略</code>。默认情况下，不保证是这种排序。<br>公平性通常会<code>降低吞吐量</code>，但也减少了可变性和避免了“不平衡性”。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayBlockingQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractQueue</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">        <span class="keyword">implements</span> <span class="title">BlockingQueue</span>&lt;<span class="title">E</span>&gt;, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> &#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">817911632652898426L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** The queued items  */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> E[] items;</div><div class="line">    <span class="comment">/** items index for next take, poll or remove */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> takeIndex;</div><div class="line">    <span class="comment">/** items index for next put, offer, or add. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> putIndex;</div><div class="line">    <span class="comment">/** Number of items in the queue */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</div><div class="line"></div><div class="line">    <span class="comment">/** Main lock guarding all access */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock lock;</div><div class="line">    <span class="comment">/** Condition for waiting takes */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition notEmpty;</div><div class="line">    <span class="comment">/** Condition for waiting puts */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition notFull;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="LinkedBlockingQueue"><a href="#LinkedBlockingQueue" class="headerlink" title="LinkedBlockingQueue"></a>LinkedBlockingQueue</h2><p><code>java.util.concurrent.LinkedBlockingQueue&lt;E&gt;</code><br>使用<code>单向链表</code>和2个<code>ReentrantLock</code>实现，存取各一个锁</p>
<p><code>适合于实现“消费者生产者”模式</code></p>
<p>一个基于已链接节点的、范围任意的 Blocking Queue<br>链接队列的吞吐量通常要高于基于数组的队列，但是在大多数并发应用程序中，其可预知的性能要低。</p>
<p><code>默认</code>最大容量：Integer.MAX_VALUE</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedBlockingQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractQueue</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">        <span class="keyword">implements</span> <span class="title">BlockingQueue</span>&lt;<span class="title">E</span>&gt;, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> &#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">6903933977591709194L</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Linked list node class</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">        E item;</div><div class="line">        Node&lt;E&gt; next;</div><div class="line">        Node(E x) &#123; item = x; &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** The capacity bound, or Integer.MAX_VALUE if none */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> capacity;</div><div class="line"></div><div class="line">    <span class="comment">/** Current number of elements */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger count = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">/** Head of linked list */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node&lt;E&gt; head;</div><div class="line"></div><div class="line">    <span class="comment">/** Tail of linked list */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node&lt;E&gt; last;</div><div class="line"></div><div class="line">    <span class="comment">/** Lock held by take, poll, etc */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock takeLock = <span class="keyword">new</span> ReentrantLock();</div><div class="line"></div><div class="line">    <span class="comment">/** Wait queue for waiting takes */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition notEmpty = takeLock.newCondition();</div><div class="line"></div><div class="line">    <span class="comment">/** Lock held by put, offer, etc */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">new</span> ReentrantLock();</div><div class="line"></div><div class="line">    <span class="comment">/** Wait queue for waiting puts */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition notFull = putLock.newCondition();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LinkedBlockingQueue</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(Integer.MAX_VALUE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//指定队列容量</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LinkedBlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (capacity &lt;= <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</div><div class="line">        <span class="keyword">this</span>.capacity = capacity;</div><div class="line">        last = head = <span class="keyword">new</span> Node&lt;E&gt;(<span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ConcurrentLinkedQueue"><a href="#ConcurrentLinkedQueue" class="headerlink" title="ConcurrentLinkedQueue"></a>ConcurrentLinkedQueue</h2><p><code>java.util.concurrent.ConcurrentLinkedQueue&lt;E&gt;</code></p>
<p>采用<code>循环CAS</code>方式来实现</p>
<p>一个基于链接节点的无界线程安全队列。此队列按照 FIFO（先进先出）原则对元素进行排序<br>size() 不是固定时间操作。由于队列的异步特性，确定当前元素的数量需要遍历这些元素</p>
<p>多用于消息队列（多个线程发送消息)</p>
<h2 id="SynchronousQueue"><a href="#SynchronousQueue" class="headerlink" title="SynchronousQueue"></a>SynchronousQueue</h2><p><code>java.util.concurrent.SynchronousQueue&lt;E&gt;</code><br>一种阻塞队列，其中每个插入操作必须等待另一个线程的对应移除操作 ，反之亦然。</p>
<p>同步队列<code>没有任何内部容量</code><br>默认为<code>非公平访问策略</code></p>
<p>SynchronousQueue经常用来,一端或者双端严格遵守”单工”(单工作者)模式的场景,队列的两个操作端分别是productor和consumer.常用于一个productor多个consumer的场景。</p>
<p>CachedThreadPool使用SynchronousQueue作为任务队列<br>线程池中Thread对象的绑定的Runable实例并不是传递给execute()的Runnable实例<br>Thread对象上绑定的Runnable实例负责从<code>任务队列</code>获取Runnable实例并调用run()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (poolSize &gt;= corePoolSize || !addIfUnderCorePoolSize(command)) &#123;</div><div class="line">    <span class="comment">//尝试添加到任务队列，如果添加成功，则由现有线程执行，否则创建线程执行</span></div><div class="line">    <span class="keyword">if</span> (runState == RUNNING &amp;&amp; workQueue.offer(command)) &#123;</div><div class="line">        <span class="keyword">if</span> (runState != RUNNING || poolSize == <span class="number">0</span>)</div><div class="line">            ensureQueuedTaskHandled(command);</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (!addIfUnderMaximumPoolSize(command))</div><div class="line">        reject(command); <span class="comment">// is shutdown or saturated</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">Runnable <span class="title">getTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (;;) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">int</span> state = runState;</div><div class="line">            <span class="keyword">if</span> (state &gt; SHUTDOWN)</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            Runnable r;</div><div class="line">            <span class="keyword">if</span> (state == SHUTDOWN)  <span class="comment">// Help drain queue</span></div><div class="line">                <span class="comment">//尝试获取，立即返回</span></div><div class="line">                r = workQueue.poll();</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (poolSize &gt; corePoolSize || allowCoreThreadTimeOut)</div><div class="line">                <span class="comment">//尝试获取，指定时间内等待</span></div><div class="line">                r = workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS);</div><div class="line">            <span class="keyword">else</span></div><div class="line">                <span class="comment">//阻塞获取</span></div><div class="line">                r = workQueue.take();</div><div class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>)</div><div class="line">                <span class="keyword">return</span> r;</div><div class="line">            <span class="keyword">if</span> (workerCanExit()) &#123;</div><div class="line">                <span class="keyword">if</span> (runState &gt;= SHUTDOWN) <span class="comment">// Wake up others</span></div><div class="line">                    interruptIdleWorkers();</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// Else retry</span></div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</div><div class="line">            <span class="comment">// On interruption, re-check runState</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="DelayQueue"><a href="#DelayQueue" class="headerlink" title="DelayQueue"></a>DelayQueue</h2><p><code>java.util.concurrent.DelayQueue&lt;E&gt;</code><br>基于组合模式，使用<code>PriorityQueue</code>实现的<code>阻塞队列</code></p>
<p>Delayed 元素的一个<code>无界阻塞</code>队列，只有在<code>延迟期满</code>时才能从中提取元素。</p>
<p>Delayed接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Delayed</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;<span class="title">Delayed</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns the remaining delay associated with this object, in the</div><div class="line">     * given time unit.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> unit the time unit</div><div class="line">     * <span class="doctag">@return</span> the remaining delay; zero or negative values indicate</div><div class="line">     * that the delay has already elapsed</div><div class="line">     * 返回剩余的延迟时间（根据当前时间计算获得）</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getDelay</span><span class="params">(TimeUnit unit)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>DelayQueue示例：<br><a href="/2017/03/23/javase-collection/DelayQueueDemo.java" title="DelayQueue示例代码">DelayQueue示例代码</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sunday.jdk6_learn;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Random;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.DelayQueue;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.Delayed;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DelayedTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span>, <span class="title">Delayed</span> </span>&#123;</div><div class="line">    <span class="comment">// 延迟时间单位</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> TimeUnit delayUnit = TimeUnit.MILLISECONDS;</div><div class="line">    <span class="comment">// 延迟时间</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> delayTime;</div><div class="line">    <span class="comment">// 触发时间</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> triggerTime;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DelayedTask</span><span class="params">(<span class="keyword">int</span> delayInMillis)</span> </span>&#123;</div><div class="line">        delayTime = delayInMillis;</div><div class="line">        <span class="comment">//System.nanoTime()相比System.currentTimeMillis()更加准确也更加精确</span></div><div class="line">        triggerTime = System.nanoTime() + TimeUnit.NANOSECONDS.convert(delayTime, delayUnit);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Delayed o)</span> </span>&#123;</div><div class="line">        DelayedTask that = (DelayedTask)o;</div><div class="line">        <span class="keyword">if</span> (triggerTime &lt; that.triggerTime) <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span> (triggerTime &gt; that.triggerTime) <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 剩余的延迟时间</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDelay</span><span class="params">(TimeUnit unit)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> unit.convert(triggerTime - System.nanoTime(), TimeUnit.NANOSECONDS);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"DelayedTask [delayTime="</span> + delayTime + <span class="string">"]"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayQueueDemo</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="comment">//延迟任务队列</span></div><div class="line">        <span class="keyword">final</span> DelayQueue&lt;DelayedTask&gt; queue = <span class="keyword">new</span> DelayQueue&lt;DelayedTask&gt;();</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> maxDelayTime = <span class="number">5000</span>;<span class="comment">//milliseconds</span></div><div class="line">        Random random = <span class="keyword">new</span> Random();</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>;i++)&#123;</div><div class="line">             DelayedTask delayedTask = <span class="keyword">new</span> DelayedTask(random.nextInt(maxDelayTime));</div><div class="line">             queue.put(delayedTask);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">while</span> (queue.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        DelayedTask take = queue.take();</div><div class="line">                        take.run();</div><div class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        </div><div class="line">        thread.start();</div><div class="line">        </div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            thread.join();</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Deque"><a href="#Deque" class="headerlink" title="Deque"></a>Deque</h1><p>双端队列</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>抛出异常(头部)</th>
<th>返回特殊值(头部)</th>
<th>抛出异常(尾部)</th>
<th>返回特殊值(尾部)</th>
</tr>
</thead>
<tbody>
<tr>
<td>插入</td>
<td>addFirst(e)</td>
<td>offerFirst(e)</td>
<td>addLast(e)</td>
<td>offerLast(e) </td>
</tr>
<tr>
<td>移除</td>
<td>removeFirst()</td>
<td>pollFirst()</td>
<td>removeLast()</td>
<td>pollLast() </td>
</tr>
<tr>
<td>检查</td>
<td>getFirst()</td>
<td>peekFirst()</td>
<td>getLast()</td>
<td>peekLast() </td>
</tr>
</tbody>
</table>
<h2 id="ArrayDeque"><a href="#ArrayDeque" class="headerlink" title="ArrayDeque"></a>ArrayDeque</h2><img src="/2017/03/23/javase-collection/arraydeque.png" alt="arraydeque.png" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="https://www.javatpoint.com/java-deque-arraydeque" target="_blank" rel="external">ArrayDeque class</a></cite></footer></blockquote>
<p>基于动态<code>循环数组</code>实现</p>
<ul>
<li>两端添加或删除元素</li>
<li>禁止null元素</li>
<li>无容量限制</li>
<li>非线程安全的</li>
</ul>
<p>此类很可能在用作<code>堆栈</code>时快于 Stack，在用作<code>队列</code>时快于 LinkedList。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//分配初始数组，大小为：大于numElements的最小2的整数幂</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">allocateElements</span><span class="params">(<span class="keyword">int</span> numElements)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> initialCapacity = MIN_INITIAL_CAPACITY;</div><div class="line">    <span class="comment">// Find the best power of two to hold elements.</span></div><div class="line">    <span class="comment">// Tests "&lt;=" because arrays aren't kept full.</span></div><div class="line">    <span class="keyword">if</span> (numElements &gt;= initialCapacity) &#123;</div><div class="line">        initialCapacity = numElements;</div><div class="line">        initialCapacity |= (initialCapacity &gt;&gt;&gt;  <span class="number">1</span>);</div><div class="line">        initialCapacity |= (initialCapacity &gt;&gt;&gt;  <span class="number">2</span>);</div><div class="line">        initialCapacity |= (initialCapacity &gt;&gt;&gt;  <span class="number">4</span>);</div><div class="line">        initialCapacity |= (initialCapacity &gt;&gt;&gt;  <span class="number">8</span>);</div><div class="line">        initialCapacity |= (initialCapacity &gt;&gt;&gt; <span class="number">16</span>);</div><div class="line">        initialCapacity++;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)   <span class="comment">// Too many elements, must back off</span></div><div class="line">            initialCapacity &gt;&gt;&gt;= <span class="number">1</span>;<span class="comment">// Good luck allocating 2 ^ 30 elements</span></div><div class="line">    &#125;</div><div class="line">    elements = (E[]) <span class="keyword">new</span> Object[initialCapacity];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//以2倍进行扩容</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doubleCapacity</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">assert</span> head == tail;</div><div class="line">    <span class="keyword">int</span> p = head;</div><div class="line">    <span class="keyword">int</span> n = elements.length;</div><div class="line">    <span class="keyword">int</span> r = n - p; <span class="comment">// number of elements to the right of p</span></div><div class="line">    <span class="keyword">int</span> newCapacity = n &lt;&lt; <span class="number">1</span>;</div><div class="line">    <span class="keyword">if</span> (newCapacity &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Sorry, deque too big"</span>);</div><div class="line">    Object[] a = <span class="keyword">new</span> Object[newCapacity];</div><div class="line">    System.arraycopy(elements, p, a, <span class="number">0</span>, r);</div><div class="line">    System.arraycopy(elements, <span class="number">0</span>, a, r, p);</div><div class="line">    elements = (E[])a;</div><div class="line">    head = <span class="number">0</span>;</div><div class="line">    tail = n;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 添加元素</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLast</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (e == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">    elements[tail] = e;</div><div class="line">    <span class="comment">// 因容量为2的整数幂，容量减1，二进制全部为1；</span></div><div class="line">    <span class="comment">// 位与运算，小于该值，数值不变；小于该值，高位变为0，低位不变；</span></div><div class="line">    <span class="comment">// 等于容量时，高位为1，其余全部为0，位与后变为0</span></div><div class="line">    <span class="keyword">if</span> ((tail = (tail + <span class="number">1</span>) &amp; (elements.length - <span class="number">1</span>)) == head)</div><div class="line">        doubleCapacity();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="LinkedBlockingDeque"><a href="#LinkedBlockingDeque" class="headerlink" title="LinkedBlockingDeque"></a>LinkedBlockingDeque</h2><p><code>java.util.concurrent.LinkedBlockingDeque&lt;E&gt;</code><br>使用<code>双向链表</code>和<code>ReentrantLock</code>实现</p>
<p>一个基于<code>已链接节点</code>的、任选范围的<code>阻塞双端队列</code><br><code>默认</code>最大容量：Integer.MAX_VALUE</p>
<p>适用于<code>工作密取（work-stealing）</code>模式<br>区别于生产者消费者模式中所有消费者共享一个工作队列，工作窃取模式每一个消费者都有自己的双端队列，如果一个消费者完成自己的全部工作，就可以偷取其它消费者队列<code>队尾</code>的任务。</p>
<p>工作密取非常适用于既是消费者也是生产者问题–当执行摸个工作时可能导致出现更多的工作。<br>例如：网页爬虫程序中处理一个页面时，通常会发现有更多的页面需要处理。</p>
<h1 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h1><img src="/2017/03/23/javase-collection/JavaCollectionsMapAPI.png" alt="JavaCollectionsMapAPI.png" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="https://www.karambelkar.info/2012/06/java-1.7-collections---uml-class-diagrams/" target="_blank" rel="external">Java 1.7 Collections - UML Class Diagrams</a></cite></footer></blockquote>
<p>将键映射到值的对象。一个映射不能包含重复的键；每个键最多只能映射到一个值</p>
<p>Map 接口提供三种 collection 视图，允许以<code>键集</code>、<code>值集</code>或<code>键-值映射关系集</code>的形式查看某个映射的内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 键集，可删除元素，不能添加元素</span></div><div class="line"><span class="function">Set&lt;K&gt; <span class="title">keySet</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"><span class="comment">// 值集，所有值的集合视图，可删除元素，不能添加元素</span></div><div class="line"><span class="function">Collection&lt;V&gt; <span class="title">values</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"><span class="comment">//键-值映射关系集，可删除元素，不能添加元素</span></div><div class="line">Set&lt;Map.Entry&lt;K, V&gt;&gt; entrySet();</div></pre></td></tr></table></figure>
<h2 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h2><img src="/2017/03/23/javase-collection/hashmap.png" alt="hashmap.png" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="https://www.javatpoint.com/java-hashmap" target="_blank" rel="external">Java HashMap class</a></cite></footer></blockquote>
<p>基于<code>数组</code>和<code>链表</code></p>
<ul>
<li>基于键保存元素</li>
<li><code>键</code>不重复</li>
<li><code>不</code>维持<code>键</code>排序</li>
</ul>
<p>此实现假定哈希函数将元素适当地分布在各桶之间，可为基本操作（get 、put 、remove）提供<code>稳定的性能</code>。</p>
<p>迭代 collection 视图所需的时间与 HashMap 实例的“容量”（桶的数量）及其大小（键-值映射关系数）成比例。<br>所以，如果迭代性能很重要，则不要将初始容量设置得太高（或将加载因子设置得太低）。 </p>
<blockquote>
<p>将可变对象用作映射键时必须格外小心。当对象是映射中某个键时，如果以影响 equals 比较的方式更改了对象的值，则映射的行为将是不确定的。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// initialCapacity 初始容量,初始容量16</span></div><div class="line"><span class="comment">// loadFactor 加载因子,默认加载因子0.75</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span></span></div></pre></td></tr></table></figure>
<p><code>初始容量</code>和<code>加载因子</code><br>容量是哈希表中桶(Entry数组)的数量，初始容量只是哈希表在创建时的容量。<br>加载因子是哈希表在其容量自动增加之前可以达到多满的一种尺度。<br>当哈希表中的条目数超出了<code>initialCapacity</code> * <code>loadFactor</code>时，通过调用 rehash 方法将<code>容量翻倍</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></div><div class="line">    <span class="keyword">extends</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</div><div class="line">    <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;, <span class="title">Cloneable</span>, <span class="title">Serializable</span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">16</span>;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</div><div class="line"></div><div class="line">    <span class="keyword">transient</span> Entry[] table;</div><div class="line"></div><div class="line">    <span class="keyword">transient</span> <span class="keyword">int</span> size;</div><div class="line"></div><div class="line">    <span class="comment">//扩容临界值</span></div><div class="line">    <span class="keyword">int</span> threshold;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">float</span> loadFactor;</div><div class="line"></div><div class="line">    <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> modCount;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR;</div><div class="line">        threshold = (<span class="keyword">int</span>)(DEFAULT_INITIAL_CAPACITY * DEFAULT_LOAD_FACTOR);</div><div class="line">        table = <span class="keyword">new</span> Entry[DEFAULT_INITIAL_CAPACITY];</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal initial capacity: "</span> +</div><div class="line">                                               initialCapacity);</div><div class="line">        <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</div><div class="line">            initialCapacity = MAXIMUM_CAPACITY;</div><div class="line">        <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal load factor: "</span> +</div><div class="line">                                               loadFactor);</div><div class="line"></div><div class="line">        <span class="comment">//初始容量为&gt;=指定容量的2的整数幂</span></div><div class="line">        <span class="comment">// Find a power of 2 &gt;= initialCapacity</span></div><div class="line">        <span class="keyword">int</span> capacity = <span class="number">1</span>;</div><div class="line">        <span class="keyword">while</span> (capacity &lt; initialCapacity)</div><div class="line">            capacity &lt;&lt;= <span class="number">1</span>;</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.loadFactor = loadFactor;</div><div class="line">        threshold = (<span class="keyword">int</span>)(capacity * loadFactor);</div><div class="line">        table = <span class="keyword">new</span> Entry[capacity];</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//添加数据</span></div><div class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> putForNullKey(value);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> hash = hash(key.hashCode());</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> i = indexFor(hash, table.length);</div><div class="line">        </div><div class="line">        <span class="comment">//hash桶不为空，遍历hash桶</span></div><div class="line">        <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</div><div class="line">            Object k;</div><div class="line">            <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</div><div class="line">                <span class="comment">//若找到相同key，替换就值并返回旧值</span></div><div class="line">                V oldValue = e.value;</div><div class="line">                e.value = value;</div><div class="line">                e.recordAccess(<span class="keyword">this</span>);</div><div class="line">                <span class="keyword">return</span> oldValue;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        modCount++;</div><div class="line">        <span class="comment">//添加新映射</span></div><div class="line">        addEntry(hash, key, value, i);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//添加映射</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</div><div class="line">        <span class="comment">//hash桶中第一个元素</span></div><div class="line">        Entry&lt;K,V&gt; e = table[bucketIndex];</div><div class="line">        <span class="comment">//新映射添加到hash桶前端</span></div><div class="line">        table[bucketIndex] = <span class="keyword">new</span> Entry&lt;K,V&gt;(hash, key, value, e);</div><div class="line">        <span class="keyword">if</span> (size++ &gt;= threshold)</div><div class="line">            <span class="comment">//2倍扩容</span></div><div class="line">            resize(<span class="number">2</span> * table.length);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//链表元素</span></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">final</span> K key;</div><div class="line">        V value;</div><div class="line">        Entry&lt;K,V&gt; next;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> hash;</div><div class="line"></div><div class="line">        Entry(<span class="keyword">int</span> h, K k, V v, Entry&lt;K,V&gt; n) &#123;</div><div class="line">            value = v;</div><div class="line">            next = n;</div><div class="line">            key = k;</div><div class="line">            hash = h;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="equals-与-hashcode"><a href="#equals-与-hashcode" class="headerlink" title="equals() 与 hashcode()"></a>equals() 与 hashcode()</h3><p>equals()比较两个对象的<code>逻辑意义</code>是否相同<br>hashcode() 是对一个对象进行hash计算得到的一个散列值</p>
<blockquote>
<p>谨记：重载 equals() 时要保证：两个equal的对象一定有相同的hashcode</p>
</blockquote>
<ul>
<li>对象x和y的hashcode相同，不代表两个对象就相同(x.equals(y)=true)，可能存在hash碰撞；不过hashcode如果不相同，那么一定是两个不同的对象</li>
<li>如果两个对象的equals()相等，那么hashcode一定相等</li>
</ul>
<h2 id="LinkedHashMap"><a href="#LinkedHashMap" class="headerlink" title="LinkedHashMap"></a>LinkedHashMap</h2><img src="/2017/03/23/javase-collection/linkedhashmap.png" alt="linkedhashmap.png" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="https://www.javatpoint.com/java-linkedhashmap" target="_blank" rel="external">Java LinkedHashMap class</a></cite></footer></blockquote>
<ul>
<li>维持插入顺序或按LRU(最近最少使用)排序</li>
</ul>
<p>由于增加了维护链接列表的开支，其性能很可能比 HashMap 稍逊一筹，<br>不过这一点例外：LinkedHashMap 的 collection 视图迭代所需时间与<code>映射的大小</code>成比例。<br>HashMap 迭代时间很可能开支较大，因为它所需要的时间与其<code>容量</code> 成比例。 </p>
<p>继承自HashMap，添加Entry<k,v> header和accessOrder<br>重写init()，实现head引用初始化，<code>head.before</code>指向最新元素，<code>head.after</code>指向最老元素<br>重写createEntry(int, K, V, int)、addEntry(int, K, V, int)实现添加元素时<code>添加链接</code>和<code>按访问排序时</code>检查是否元素移除<br>重写transfer(Entry[])实现扩容时链接处理<br>重写recordAccess(HashMap<k, v="">)实现按访问排序时，访问元素时更新链接</k,></k,v></p>
<p>扩展HashMap.Entry添加 Entry<k,v> before, after</k,v></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedHashMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></div><div class="line">    <span class="keyword">extends</span> <span class="title">HashMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</div><div class="line">    <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">3801124242820219131L</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Entry&lt;K,V&gt; header;</div><div class="line"></div><div class="line">    <span class="comment">//对于访问顺序</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> accessOrder;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * This override differs from addEntry in that it doesn't resize the</div><div class="line">     * table or remove the eldest entry.</div><div class="line">     * 添加元素</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</div><div class="line">        createEntry(hash, key, value, bucketIndex);</div><div class="line"></div><div class="line">        <span class="comment">// Remove eldest entry if instructed, else grow capacity if appropriate</span></div><div class="line">        Entry&lt;K,V&gt; eldest = header.after;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (removeEldestEntry(eldest)) &#123;</div><div class="line">            <span class="comment">//移除最老元素</span></div><div class="line">            removeEntryForKey(eldest.key);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (size &gt;= threshold)</div><div class="line">                resize(<span class="number">2</span> * table.length);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * This override alters behavior of superclass put method. It causes newly</div><div class="line">     * allocated entry to get inserted at the end of the linked list and</div><div class="line">     * removes the eldest entry if appropriate.</div><div class="line">     * 创建映射，添加值哈希桶，并添加到链表</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">createEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</div><div class="line">        HashMap.Entry&lt;K,V&gt; old = table[bucketIndex];</div><div class="line">        Entry&lt;K,V&gt; e = <span class="keyword">new</span> Entry&lt;K,V&gt;(hash, key, value, old);</div><div class="line">        table[bucketIndex] = e;</div><div class="line">        <span class="comment">//添加到header前面</span></div><div class="line">        e.addBefore(header);</div><div class="line">        size++;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">HashMap</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">        <span class="comment">// These fields comprise the doubly linked list used for iteration.</span></div><div class="line">        Entry&lt;K,V&gt; before, after;</div><div class="line"></div><div class="line">        Entry(<span class="keyword">int</span> hash, K key, V value, HashMap.Entry&lt;K,V&gt; next) &#123;</div><div class="line">            <span class="keyword">super</span>(hash, key, value, next);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Removes this entry from the linked list.</div><div class="line">         * 从链表中移除元素</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</div><div class="line">            before.after = after;</div><div class="line">            after.before = before;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Inserts this entry before the specified existing entry in the list.</div><div class="line">         * 添加元素至指定元素前</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addBefore</span><span class="params">(Entry&lt;K,V&gt; existingEntry)</span> </span>&#123;</div><div class="line">            after  = existingEntry;</div><div class="line">            before = existingEntry.before;</div><div class="line">            before.after = <span class="keyword">this</span>;</div><div class="line">            after.before = <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * This method is invoked by the superclass whenever the value</div><div class="line">         * of a pre-existing entry is read by Map.get or modified by Map.set.</div><div class="line">         * If the enclosing Map is access-ordered, it moves the entry</div><div class="line">         * to the end of the list; otherwise, it does nothing.</div><div class="line">         * 元素访问，按访问排序模式下，更新链表排序</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">recordAccess</span><span class="params">(HashMap&lt;K,V&gt; m)</span> </span>&#123;</div><div class="line">            LinkedHashMap&lt;K,V&gt; lm = (LinkedHashMap&lt;K,V&gt;)m;</div><div class="line">            <span class="keyword">if</span> (lm.accessOrder) &#123;</div><div class="line">                lm.modCount++;</div><div class="line">                remove();</div><div class="line">                addBefore(lm.header);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">recordRemoval</span><span class="params">(HashMap&lt;K,V&gt; m)</span> </span>&#123;</div><div class="line">            remove();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>LRU限制容量缓存</p>
<blockquote>
<p>容量限制与LRU无联系</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 使用访问顺序排序</span></div><div class="line">LinkedHashMap&lt;String, String&gt; cache = <span class="keyword">new</span> LinkedHashMap&lt;String,String&gt;(<span class="number">16</span>, <span class="number">0.75f</span>, <span class="keyword">true</span>)&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">967610939207233408L</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 重写 removeEldestEntry(Map.Entry) 方法实现元素移除策略</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Entry&lt;String, String&gt; eldest)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> size() &gt; <span class="number">100</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">cache.put(<span class="string">"a"</span>, <span class="string">"a"</span>);</div><div class="line">cache.put(<span class="string">"b"</span>, <span class="string">"b"</span>);</div><div class="line">cache.put(<span class="string">"c"</span>, <span class="string">"c"</span>);</div><div class="line"></div><div class="line">Collection&lt;String&gt; values = cache.values();</div><div class="line"><span class="keyword">for</span>(String str : values)&#123;</div><div class="line">    System.out.println(str);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="TreeMap"><a href="#TreeMap" class="headerlink" title="TreeMap"></a>TreeMap</h2><img src="/2017/03/23/javase-collection/treemap.png" alt="treemap.png" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="https://www.javatpoint.com/java-treeset" target="_blank" rel="external">Java TreeMap class</a></cite></footer></blockquote>
<p>基于红黑树（Red-Black tree）的 NavigableMap 实现。<br>根据<code>键</code>的自然顺序进行排序，或根据提供的 Comparator 进行排序</p>
<ul>
<li>基于键保存元素</li>
<li><code>键</code>不重复</li>
<li><code>键</code>维持<code>自然排序</code></li>
</ul>
<p>此实现为 containsKey、<code>get</code>、<code>put</code> 和 <code>remove</code> 操作提供受保证的 O(log(n)) 时间开销。</p>
<h2 id="EnumMap"><a href="#EnumMap" class="headerlink" title="EnumMap"></a>EnumMap</h2><img src="/2017/03/23/javase-collection/enummap.png" alt="enummap.png" title="">
<blockquote><footer><strong>图片来源</strong><cite><a href="https://www.javatpoint.com/java-enummap" target="_blank" rel="external">TreeMap class</a></cite></footer></blockquote>
<p>与枚举类型键一起使用的专用 Map 实现。枚举映射中所有键都必须来自单个枚举类型</p>
<p>枚举映射根据其<code>键</code>的<code>自然顺序</code> 来维护（该顺序是声明枚举常量的顺序）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">EnumMap&lt;Days, String&gt; map = <span class="keyword">new</span> EnumMap&lt;Days, String&gt;(Days.class);  </div><div class="line">map.put(Days.Monday, <span class="string">"1"</span>);</div><div class="line">map.put(Days.Tuesday, <span class="string">"2"</span>);</div></pre></td></tr></table></figure>
<h2 id="WeakHashMap"><a href="#WeakHashMap" class="headerlink" title="WeakHashMap"></a>WeakHashMap</h2><p>以弱键 实现的基于哈希表的 Map。</p>
<p>对于一个给定的键，其映射的存在并不阻止垃圾回收器对该键的丢弃。<br>丢弃某个键时，其条目从映射中有效地移除</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Map&lt;String, String&gt; weakHashMap = <span class="keyword">new</span> WeakHashMap&lt;String, String&gt;();</div><div class="line"></div><div class="line">String keyWeakHashMap = <span class="keyword">new</span> String(<span class="string">"keyWeakHashMap"</span>);</div><div class="line"></div><div class="line">weakHashMap.put(keyWeakHashMap, <span class="string">"helloWeakHash"</span>);</div><div class="line">System.out.println(<span class="string">"Before: weak hash map value:"</span> + weakHashMap.get(<span class="string">"keyWeakHashMap"</span>));</div><div class="line"></div><div class="line">keyWeakHashMap = <span class="keyword">null</span>;</div><div class="line"></div><div class="line"><span class="comment">//运行垃圾回收器</span></div><div class="line">System.gc();</div><div class="line"></div><div class="line">System.out.println(<span class="string">"After: weak hash map value:"</span> + weakHashMap.get(<span class="string">"keyWeakHashMap"</span>));</div></pre></td></tr></table></figure>
<h3 id="JAVA中四种引用方式"><a href="#JAVA中四种引用方式" class="headerlink" title="JAVA中四种引用方式"></a>JAVA中四种引用方式</h3><ul>
<li>强引用（StrongReference）</li>
<li>软引用（SoftReference）</li>
<li>弱引用（WeakReference）</li>
<li>虚引用（PhantomReference）</li>
</ul>
<h4 id="强引用"><a href="#强引用" class="headerlink" title="强引用"></a>强引用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">String str=<span class="keyword">new</span> String(<span class="string">"abc"</span>);</div></pre></td></tr></table></figure>
<h4 id="软引用"><a href="#软引用" class="headerlink" title="软引用"></a>软引用</h4><p>如果内存空间不足了，就会回收这些对象的内存。</p>
<p>软引用可用来实现<code>内存敏感</code>的<code>高速缓存</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String str=<span class="keyword">new</span> String(<span class="string">"abc"</span>);</div><div class="line">SoftReference&lt;String&gt; softRef=<span class="keyword">new</span> SoftReference&lt;String&gt;(str);</div></pre></td></tr></table></figure>
<h4 id="弱引用"><a href="#弱引用" class="headerlink" title="弱引用"></a>弱引用</h4><p>不管当前内存空间足够与否，都会回收它的内存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String str=<span class="keyword">new</span> String(<span class="string">"abc"</span>);      </div><div class="line">WeakReference&lt;String&gt; weakRef = <span class="keyword">new</span> WeakReference&lt;String&gt;(str);</div></pre></td></tr></table></figure>
<h4 id="虚引用"><a href="#虚引用" class="headerlink" title="虚引用"></a>虚引用</h4><p>get()方法总是返回null，而得不到它指向的对象<br>当对象变得弱可达（weakly reachable）时会立即被放到ReferenceQueue中<br>虚引用适合用来查看对象什么时候被回收,优化内存的时候使用</p>
<h2 id="IdentityHashMap"><a href="#IdentityHashMap" class="headerlink" title="IdentityHashMap"></a>IdentityHashMap</h2><p>此类利用哈希表实现 Map 接口，比较两个对象时使用==，而不是equals()<br>使用System.identityHashCode()计算hashCode</p>
<p>实现对象遍历算法（如对象序列化）时，这个类非常有用，可以用来跟踪每个对象的遍历情况。</p>
<h2 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h2><p><code>java.util.concurrent.ConcurrentHashMap&lt;K, V&gt;</code></p>
<p>支持获取的<code>完全并发</code>和更新的<code>可调整并发</code>的哈希表</p>
<p>读线程几乎不会因加锁而阻塞（除非读线程刚好读到这个 Segment 中某个 HashEntry 的 value 域的值为 null，此时需要加锁后重新读取该值）。</p>
<ul>
<li>线程安全(分段锁)</li>
<li>提供原子复合操作</li>
<li>迭代器弱一致性</li>
</ul>
<p>弱一致性：<br>迭代器创建后，遍历过程中，内部元素可能发生变化，<br>变化发生在已遍历的部分，迭代器不会反映出来，<br>变化发生在未遍历的部分，迭代器会发现并反映出来。 </p>
<p>ConcurrentHashMap 的高并发性主要来自于三个方面：</p>
<ul>
<li>用分离锁实现多个线程间的更深层次的共享访问。</li>
<li>用 HashEntery 对象的不变性来降低执行读操作的线程在遍历链表期间对加锁的需求。</li>
<li>通过对同一个 Volatile 变量的写 / 读访问，协调不同线程间读 / 写操作的内存可见性。</li>
</ul>
<p>remove实现：<br>找到需要删除的节点。再将需要删除的节点所在链表的前趋全部复制一遍，但直接前趋的Next是指向需要删除节点的后继的。最后，将复制的前趋替换掉之前的前趋。</p>
<p>无锁读：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function">V <span class="title">get</span><span class="params">(Object key, <span class="keyword">int</span> hash)</span> </span>&#123;</div><div class="line">    <span class="comment">//第一步是访问count变量，这是一个volatile变量，由于所有修改操作在进行结构修改时都会在最后一步写count变量，通过这种机制保证get操作能够得到最新的结构更新</span></div><div class="line">    <span class="keyword">if</span> (count != <span class="number">0</span>) &#123; <span class="comment">// read-volatile</span></div><div class="line">        HashEntry&lt;K,V&gt; e = getFirst(hash);</div><div class="line">        <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (e.hash == hash &amp;&amp; key.equals(e.key)) &#123;</div><div class="line">                V v = e.value;</div><div class="line">                <span class="keyword">if</span> (v != <span class="keyword">null</span>)</div><div class="line">                    <span class="keyword">return</span> v;</div><div class="line">                <span class="keyword">return</span> readValueUnderLock(e); <span class="comment">// recheck</span></div><div class="line">            &#125;</div><div class="line">            e = e.next;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ConcurrentSkipListMap"><a href="#ConcurrentSkipListMap" class="headerlink" title="ConcurrentSkipListMap"></a>ConcurrentSkipListMap</h2><p><code>java.util.concurrent.ConcurrentSkipListMap&lt;K, V&gt;</code><br>基于SkipList和CAS实现，因为跳表易于实现高效并发算法。</p>
<ul>
<li>非阻塞算法</li>
<li>实现SortedMap和NavigableMap接口</li>
<li>支持复合原子操作</li>
</ul>
<p>映射可以根据键的<code>自然顺序</code>进行排序或使用提供的 Comparator 进行排序</p>
<p>containsKey、get、put、remove 操作及其变体提供预期平均 <code>log(n)</code> 时间开销</p>
<p>迭代器是<code>弱一致</code>的，返回的元素将反映迭代器创建时或创建后某一时刻的映射状态。</p>
<p>此类视图中的方法返回的所有 Map.Entry 对，表示他们产生时的<code>映射关系快照</code>。</p>
<p>size 方法不是 一个固定时间 (constant-time) 操作</p>
<p>用来替代同步的SortedMap</p>
<h1 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h1><h2 id="Arrays"><a href="#Arrays" class="headerlink" title="Arrays"></a>Arrays</h2><p><code>java.util.Arrays</code><br>此类包含用来操作数组（比如排序和搜索）的各种方法。此类还包含一个允许将数组作为列表来查看的静态工厂。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 复制指定的数组，截取或用 null 填充（如有必要），以使副本具有指定的长度</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span>[] copyOf(<span class="keyword">boolean</span>[] original,<span class="keyword">int</span> newLength);</div></pre></td></tr></table></figure>
<h2 id="System"><a href="#System" class="headerlink" title="System"></a>System</h2><p><code>java.lang.System</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src      源数组。</span></div><div class="line"><span class="comment">// srcPos   源数组中的起始位置。</span></div><div class="line"><span class="comment">// dest     目标数组。</span></div><div class="line"><span class="comment">// destPos  目标数据中的起始位置。</span></div><div class="line"><span class="comment">// length   要复制的数组元素的数量</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">arraycopy</span><span class="params">(Object src,  <span class="keyword">int</span>  srcPos, Object dest, <span class="keyword">int</span> destPos,<span class="keyword">int</span> length)</span></span>;</div></pre></td></tr></table></figure>
<h2 id="TimeUnit"><a href="#TimeUnit" class="headerlink" title="TimeUnit"></a>TimeUnit</h2><p>时间转换工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> minuts = <span class="number">1</span>;</div><div class="line">TimeUnit unit = TimeUnit.MINUTES;</div><div class="line"></div><div class="line">System.out.println(unit.toSeconds(minuts));</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> centos6 </tag>
            
            <tag> linux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Centos6 Note]]></title>
      <url>http://xiaozhuang.github.io/2017/03/16/centos6-note/</url>
      <content type="html"><![CDATA[<p>CentOS（Community Enterprise Operating System，中文意思是：社区企业操作系统）是Linux发行版之一，它是来自于Red Hat Enterprise Linux依照开放源代码规定释出的源代码所编译而成。<br><a id="more"></a></p>
<h1 id="Linxu-基础"><a href="#Linxu-基础" class="headerlink" title="Linxu 基础"></a>Linxu 基础</h1><h2 id="服务器特点"><a href="#服务器特点" class="headerlink" title="服务器特点"></a>服务器特点</h2><ul>
<li>稳定</li>
<li>安全</li>
</ul>
<blockquote>
<p>服务器不会装图形界面</p>
</blockquote>
<h2 id="Linux与window的不同"><a href="#Linux与window的不同" class="headerlink" title="Linux与window的不同"></a>Linux与window的不同</h2><ul>
<li>Linux 严格区分大小写</li>
<li>Linxu 所有内容以文件形式保存，包括硬件</li>
<li>Linxu不靠扩展名区分文件类型（靠权限区分）</li>
</ul>
<p>Linux约定扩展名：<br>格式 | 扩展名<br>————|————–<br>压缩包 | <em>.gz </em>.bz <em>.tar.bz2 </em>.tgz<br>二进制 | .rpm<br>脚本 | .sh<br>配置文件 | .config</p>
<h2 id="字符界面优势"><a href="#字符界面优势" class="headerlink" title="字符界面优势"></a>字符界面优势</h2><ul>
<li>字符界面占用系统资源更少</li>
<li>字符界面减少出错、被攻击的可能性（启动程序越多，出错可能越大）</li>
</ul>
<h2 id="系统分区"><a href="#系统分区" class="headerlink" title="系统分区"></a>系统分区</h2><!-- TODO -->
<h2 id="Linux安装"><a href="#Linux安装" class="headerlink" title="Linux安装"></a>Linux安装</h2><p>VMware中，新建虚拟机</p>
<ul>
<li>“典型”</li>
<li>安装来源，”稍后安装操作系统”（选择CentOS安装，将简化安装过程，故不选这种方式）</li>
<li>选择系统：Linux，版本：CentOS</li>
<li>硬盘</li>
<li>虚拟机设置（网络视频器：桥接模式，虚拟机将获取与真实主机同一网段ip）</li>
</ul>
<p>安装过程：</p>
<ul>
<li>Install or upgrade an existing system (安装或升级现有系统)</li>
<li>跳过镜像检测</li>
<li>语言，中文</li>
<li>键盘，美国英语式</li>
<li>存储设备，基本存储设备</li>
<li>存储设备可能包含数据警告，忽略所有数据</li>
<li>主机名，Linux不通过主机名，在局域网内访问，保持默认</li>
<li>时区，亚洲/上海（包含北京时区）</li>
<li>设置管理员密码</li>
<li>分区方式，自定义（参考下方自定义分区）</li>
<li>格式化</li>
<li>软件包选择，（minimal：最小化安装；BasicServer 基本服务器）</li>
<li>重启</li>
</ul>
<p>自定义分区：(创建分区，标准分区)<br>/home    上传默认目录（2G）    ext4<br>/boot    启动分区（200M）    ext4<br>无        交换分区（内存2倍）    swap<br>/        根分区（全部可用）    ext4</p>
<h2 id="安装日志"><a href="#安装日志" class="headerlink" title="安装日志"></a>安装日志</h2><!-- TODO -->
<h1 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h1><h2 id="命令基本格式"><a href="#命令基本格式" class="headerlink" title="命令基本格式"></a>命令基本格式</h2><!-- TODO -->
<h2 id="关机"><a href="#关机" class="headerlink" title="关机"></a>关机</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shutdown -h now</div></pre></td></tr></table></figure>
<h2 id="文件搜索"><a href="#文件搜索" class="headerlink" title="文件搜索"></a>文件搜索</h2><h3 id="locate"><a href="#locate" class="headerlink" title="locate"></a>locate</h3><p>在后台数据库中<code>按文件名</code>搜索，搜索速度快，</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Centos6 Minimal安装，没有安装locate</span></div><div class="line">yum install mlocate</div><div class="line"><span class="comment">#locate 文件名</span></div><div class="line">locate my.cnf</div></pre></td></tr></table></figure>
<p>locate搜索数据库的文件信息，一天更新一次</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#手动更新文件数据库</span></div><div class="line">updatedb</div></pre></td></tr></table></figure>
<h2 id="tar-gz"><a href="#tar-gz" class="headerlink" title=".tar.gz"></a>.tar.gz</h2><h3 id="打包：tar-zcvf-打包文件名-源文件"><a href="#打包：tar-zcvf-打包文件名-源文件" class="headerlink" title="打包：tar -zcvf 打包文件名 源文件"></a>打包：tar -zcvf 打包文件名 源文件</h3><table>
<thead>
<tr>
<th>选项</th>
<th>作用 </th>
</tr>
</thead>
<tbody>
<tr>
<td>-z</td>
<td>压缩为.tar.gz格式</td>
</tr>
<tr>
<td>-c</td>
<td>打包</td>
</tr>
<tr>
<td>-v</td>
<td>显示过程</td>
</tr>
<tr>
<td>-f</td>
<td>指定打包后的文件名</td>
</tr>
</tbody>
</table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#压缩</span></div><div class="line">tar -czvf mysql_install.tar.gz [path1 path2]</div></pre></td></tr></table></figure>
<h3 id="解打包：tar-xzvf-打包文件名"><a href="#解打包：tar-xzvf-打包文件名" class="headerlink" title="解打包：tar -xzvf 打包文件名"></a>解打包：tar -xzvf 打包文件名</h3><table>
<thead>
<tr>
<th>选项</th>
<th>作用 </th>
</tr>
</thead>
<tbody>
<tr>
<td>-z</td>
<td>解压缩.tar.gz格式</td>
</tr>
<tr>
<td>-x</td>
<td>解打包</td>
</tr>
</tbody>
</table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#解压缩</span></div><div class="line">tar -xzvf file.tar.gz</div><div class="line"><span class="comment">#解压缩到指定目录</span></div><div class="line">tar -xzvf file.tar.gz -C /home/aaa</div></pre></td></tr></table></figure>
<h3 id="查看：tar-tzvf-打包文件名"><a href="#查看：tar-tzvf-打包文件名" class="headerlink" title="查看：tar -tzvf 打包文件名"></a>查看：tar -tzvf 打包文件名</h3><table>
<thead>
<tr>
<th>选项</th>
<th>作用 </th>
</tr>
</thead>
<tbody>
<tr>
<td>-t</td>
<td>查看打包文件</td>
</tr>
</tbody>
</table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar -tzvf mongodb-linux-x86_64-rhel62-3.2.9.tgz</div></pre></td></tr></table></figure>
<h1 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">yum install zip unzip</div><div class="line"><span class="comment"># 打包目录</span></div><div class="line">zip -r backup.zip /root/backup</div></pre></td></tr></table></figure>
<h2 id="vim"><a href="#vim" class="headerlink" title="vim"></a>vim</h2><h2 id="rpm包"><a href="#rpm包" class="headerlink" title="rpm包"></a>rpm包</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装</span></div><div class="line"><span class="comment"># -i  (install)安装</span></div><div class="line"><span class="comment"># -v  (verbose)显示详细信息</span></div><div class="line"><span class="comment"># -h  (hash)显示进度</span></div><div class="line"><span class="comment"># --nodeps 不检测依赖性</span></div><div class="line">rpm -ivh 包全名</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 查询是否安装</span></div><div class="line">rpm -q 包名</div><div class="line"><span class="comment"># 查询所有已装包</span></div><div class="line">rpm -qa</div><div class="line"></div><div class="line"><span class="comment"># 查询rpm包安装信息</span></div><div class="line">rpm -qi 包名</div><div class="line"></div><div class="line"><span class="comment"># 查询系统文件属于哪个软件</span></div><div class="line">rpm -qf 系统文件名</div><div class="line"></div><div class="line"><span class="comment"># 查询包依赖性</span></div><div class="line">rpm -qr 包名</div><div class="line"></div><div class="line"><span class="comment"># 校验</span></div><div class="line">rpm -v 包名</div></pre></td></tr></table></figure>
<h2 id="yum在线安装"><a href="#yum在线安装" class="headerlink" title="yum在线安装"></a>yum在线安装</h2><p>RPM包在线安装方法，解决了RPM包依赖问题</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install -y wget</div><div class="line">yum install zip unzip</div></pre></td></tr></table></figure>
<h3 id="查询安装包"><a href="#查询安装包" class="headerlink" title="查询安装包"></a>查询安装包</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum search key_word</div></pre></td></tr></table></figure>
<h3 id="修改yum源为163-yum源"><a href="#修改yum源为163-yum源" class="headerlink" title="修改yum源为163 yum源"></a>修改yum源为163 yum源</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/yum.repos.d</div><div class="line">mv CentOS-Base.repo CentOS-Base.repo.bak</div><div class="line">wget http://mirrors.163.com/.<span class="built_in">help</span>/CentOS6-Base-163.repo</div><div class="line">mv CentOS6-Base-163.repo CentOS-Base.repo</div><div class="line">yum clean all</div></pre></td></tr></table></figure>
<h3 id="修改aliyun-yum源"><a href="#修改aliyun-yum源" class="headerlink" title="修改aliyun yum源"></a>修改aliyun yum源</h3><a href="http://mirrors.aliyun.com/help/centos?spm=5176.bbsr150321.0.0.d6ykiD" title="参考文档" target="_blank" rel="external">参考文档</a>
<ul>
<li>备份</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</div></pre></td></tr></table></figure>
<ul>
<li>下载新的CentOS-Base.repo 到/etc/yum.repos.d/</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># CentOS 5</span></div><div class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-5.repo</div><div class="line"><span class="comment"># CentOS 6</span></div><div class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo</div><div class="line"><span class="comment"># CentOS 7</span></div><div class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</div></pre></td></tr></table></figure>
<ul>
<li>运行<code>yum clean all</code>, <code>yum makecache</code>生成缓存</li>
</ul>
<h2 id="查看系统版本"><a href="#查看系统版本" class="headerlink" title="查看系统版本"></a>查看系统版本</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cat /etc/redhat-release</div><div class="line"><span class="comment">#或</span></div><div class="line">rpm -q centos-release</div></pre></td></tr></table></figure>
<h2 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h2><h3 id="查看用户登录记录"><a href="#查看用户登录记录" class="headerlink" title="查看用户登录记录"></a>查看用户登录记录</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">who</div></pre></td></tr></table></figure>
<h3 id="查看系统中有哪些用户："><a href="#查看系统中有哪些用户：" class="headerlink" title="查看系统中有哪些用户："></a>查看系统中有哪些用户：</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cut -d : -f 1 /etc/passwd</div></pre></td></tr></table></figure>
<h3 id="查看可以登录系统的用户："><a href="#查看可以登录系统的用户：" class="headerlink" title="查看可以登录系统的用户："></a>查看可以登录系统的用户：</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat /etc/passwd | grep -v /sbin/nologin | cut -d : -f 1</div></pre></td></tr></table></figure>
<h2 id="scp-远程拷贝文件的命令"><a href="#scp-远程拷贝文件的命令" class="headerlink" title="scp 远程拷贝文件的命令"></a>scp 远程拷贝文件的命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">scp local_file remote_username@remote_ip:remote_folder</div><div class="line">scp -r local_folder remote_username@remote_ip:remote_folder</div></pre></td></tr></table></figure>
<h2 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h2><p>SSH为Secure Shell的缩写，是创建在应用层和传输层基础上的安全协议。</p>
<h3 id="ssh远程登录"><a href="#ssh远程登录" class="headerlink" title="ssh远程登录"></a>ssh远程登录</h3><p>格式：ssh 用户名@ip</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装ssh</span></div><div class="line">yum -y install openssh-clients</div><div class="line"><span class="comment">#使用ssh远程连接其他主机</span></div><div class="line"><span class="comment">#执行命令后，提示下载目标主机公钥</span></div><div class="line">ssh root@192.168.47.129cd</div></pre></td></tr></table></figure>
<h2 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h2><h3 id="权限修改"><a href="#权限修改" class="headerlink" title="权限修改"></a>权限修改</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#修改文件或目录所属的用户</span></div><div class="line">chown qq /home/qq</div><div class="line"></div><div class="line"><span class="comment">#修改文件或目录所属的组</span></div><div class="line">chgrp qq /home/qq</div></pre></td></tr></table></figure>
<h2 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h2><h3 id="查看系统进程"><a href="#查看系统进程" class="headerlink" title="查看系统进程"></a>查看系统进程</h3><p>ps -ef | grep java</p>
<h3 id="终止进程"><a href="#终止进程" class="headerlink" title="终止进程"></a>终止进程</h3><p>kill -15 [PID]</p>
<h2 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h2><h3 id="开端口"><a href="#开端口" class="headerlink" title="开端口"></a>开端口</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 添加：</span></div><div class="line"><span class="comment"># (删除iptables -D chain rulenum,如：删除INPUT里序号为8的规则-&gt;iptables -D INPUT 8)</span></div><div class="line"><span class="comment"># (删除指定端口规则:iptables -D  INPUT -p tcp -m tcp --dport "3306" -j ACCEPT)</span></div><div class="line">iptables -I INPUT -p tcp --dport 8080 -j ACCEPT</div><div class="line"></div><div class="line"><span class="comment"># 保存：</span></div><div class="line">service iptables save</div><div class="line"></div><div class="line"><span class="comment"># 查看：</span></div><div class="line">/etc/init.d/iptables status</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 防火墙开关：</span></div><div class="line"><span class="comment"># 	1)永久性生效，重启后不会复原 </span></div><div class="line"><span class="comment"># 	开启： chkconfig iptables on 关闭： chkconfig iptables off </span></div><div class="line"><span class="comment"># 	2)即时生效，重启后复原 </span></div><div class="line"><span class="comment"># 	开启： service iptables start 关闭： service iptables stop</span></div></pre></td></tr></table></figure>
<h1 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h1><p>添加定时任务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">crontab -e</div><div class="line"><span class="comment"># 每5分钟执行一次</span></div><div class="line">*/5 * * * * /home/hexo_sh/hexo_checkout_svn.sh</div></pre></td></tr></table></figure>
<h1 id="开机运行"><a href="#开机运行" class="headerlink" title="开机运行"></a>开机运行</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">vi /etc/rc.local</div><div class="line">/home/hexo_sh/hexo_generate_watch.sh</div></pre></td></tr></table></figure>
<h1 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h1><h2 id="源码包安装位置"><a href="#源码包安装位置" class="headerlink" title="源码包安装位置"></a>源码包安装位置</h2><p>/usr/local</p>
<h1 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#仅当前回话有效</span></div><div class="line"><span class="comment">#以jdk为例</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/jdk7/bin:<span class="variable">$PATH</span></div></pre></td></tr></table></figure>
<p>生效方法：立即生效<br>有效期限：临时改变，只能在当前的终端窗口中有效，当前窗口关闭后就会恢复原有的path配置<br>用户局限：仅对当前用户</p>
<h1 id="性能监控"><a href="#性能监控" class="headerlink" title="性能监控"></a>性能监控</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vmstat</div></pre></td></tr></table></figure>
<p>procs ———–memory———- —swap– —–io—- –system– —–cpu—–<br> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st<br> 0  0      0 813472  11720 141636    0    0    22    18   16   15  0  0 99  0  0    </p>
<ul>
<li>us用户态cpu使用率， sy系统态cpu使用率， id空闲率</li>
<li>第一列为 调度程序运行队列长度</li>
<li>si 和 so 分别表示内存页面换入和换出的量</li>
</ul>
<h2 id="监控锁竞争"><a href="#监控锁竞争" class="headerlink" title="监控锁竞争"></a>监控锁竞争</h2><p><code>sysstat</code>包中的pidstat命令监控锁竞争</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 每秒让步式上下文切换</span></div><div class="line">pidstat -w</div><div class="line"></div><div class="line"><span class="comment"># 每5秒监控进程id为9391的应用</span></div><div class="line">pidstat -w -I -p 9391 -5</div></pre></td></tr></table></figure>
<p>01时34分40秒       PID   cswch/s nvcswch/s  Command<br>01时34分40秒         1      0.11      0.01  init<br>01时34分40秒         2      0.01      0.00  kthreadd<br>01时34分40秒         3      0.00      0.00  migration/0<br>01时34分40秒         4      0.05      0.00  ksoftirqd/0<br>01时34分40秒         5      0.00      0.00  stopper/0</p>
<p>cswch/s是让步上下文切换<br>cswch/s是总的让步式上下文切换数，除以虚拟处理器数目为每cup让步式上下文切换数</p>
<p>让步式上下文切换耗费的时钟周期代价非常高，通常高达<code>80 000</code>个时钟周期</p>
<blockquote>
<p>如果让步式上下文切换占去5%或更多的时钟周期，说明它可能遇到锁竞争<br>3.0GHz处理器每秒能执行3 000 000 000个时钟周期</p>
</blockquote>
<p>nvcswch/s是抢占式上下文切换<br>抢占式上下文切换率高表明预备运行的线程数多于可用的虚拟处理器</p>
<p>减少抢占式上下文切换的策略：</p>
<ul>
<li>创建处理器组</li>
<li>减少运行的应用线程数</li>
</ul>
<p>Linux上使用teskset创建处理器组，并将应用分配给这些处理器组。</p>
<h2 id="磁盘IO使用率"><a href="#磁盘IO使用率" class="headerlink" title="磁盘IO使用率"></a>磁盘IO使用率</h2><p><code>sysstat</code>包中的iostat命令查看磁盘IO使用率</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iostat -xm</div></pre></td></tr></table></figure>
<h1 id="rpm卸载"><a href="#rpm卸载" class="headerlink" title="rpm卸载"></a>rpm卸载</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">rpm -q dsc20</div><div class="line">rpm -q cassandra20</div><div class="line"></div><div class="line">rpm -e dsc20</div><div class="line">rpm -e cassandra20</div></pre></td></tr></table></figure>
<h1 id="Systemctl"><a href="#Systemctl" class="headerlink" title="Systemctl"></a>Systemctl</h1><p>Systemctl是一个systemd工具，主要负责控制systemd系统和服务管理器。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure>
<h1 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h1><h2 id="拷贝虚拟机后无法联网"><a href="#拷贝虚拟机后无法联网" class="headerlink" title="拷贝虚拟机后无法联网"></a>拷贝虚拟机后无法联网</h2><p>ifcfg-eth0已经配置了开机启动<br>执行service network restart报错：device eth0 does not seem to be present, delaying initialization</p>
<p>引起原因：ifcfg-eth0的配置文件里保存了以前的MAC地址</p>
<p>解决方法：<br>删除ifcfg-eth0中MAC地址信息<br>/etc/sysconfig/network-scripts/ifcfg-eth0<br>删除文件：<br>/etc/udev/rules.d/70-persistent-net.rules 删除后重启机器</p>
<h1 id="rsync命令"><a href="#rsync命令" class="headerlink" title="rsync命令"></a>rsync命令</h1><p>rsync命令是一个远程数据同步工具，可通过LAN/WAN快速同步多台主机间的文件。rsync使用所谓的“rsync算法”来使本地和远程两个主机之间的文件达到同步，这个算法只传送两个文件的不同部分，而不是每次都整份传送，因此速度相当快。</p>
<h1 id="清屏"><a href="#清屏" class="headerlink" title="清屏"></a>清屏</h1><p>clear</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> centos6 </tag>
            
            <tag> linux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[RabbitMQ]]></title>
      <url>http://xiaozhuang.github.io/2017/03/11/rabbit-mq/</url>
      <content type="html"><![CDATA[<p>RabbitMQ是实现了AMQP标准的代理服务器，RabbitMQ运行集群简单可靠。<br><a id="more"></a></p>
<h1 id="RabbitMQ简介"><a href="#RabbitMQ简介" class="headerlink" title="RabbitMQ简介"></a>RabbitMQ简介</h1><ul>
<li>除了Qpid之外，RabbitMQ是唯一实现了AMQP标准的代理服务器</li>
<li>由于RabbitMQ使用Erlang开发，RabbitMQ集群不可思议的简单</li>
<li>RabbitMQ可靠</li>
</ul>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="rabbitmq-server"><a href="#rabbitmq-server" class="headerlink" title="rabbitmq-server"></a>rabbitmq-server</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">yum install gcc glibc-devel make ncurses-devel openssl-devel autoconf wget</div><div class="line"></div><div class="line"><span class="comment"># Installing erlang via EPEL</span></div><div class="line"><span class="comment"># 1.Download the EPEL RPM.</span></div><div class="line">wget http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</div><div class="line"></div><div class="line"><span class="comment"># 2.Install the EPEL RPM.</span></div><div class="line">rpm -Uvh epel-release-6*.rpm</div><div class="line"></div><div class="line"><span class="comment"># 3.Install Erlang via "yum"</span></div><div class="line">yum install erlang</div><div class="line"></div><div class="line"><span class="comment"># 安装rabbitmq</span></div><div class="line">yum install rabbitmq-server</div><div class="line"></div><div class="line"><span class="comment"># 启动rabbitmq</span></div><div class="line">service rabbitmq-server start</div></pre></td></tr></table></figure>
<blockquote>
<p>记得防火墙开启端口，默认：5672<br>默认用户：guest，默认密码：guest</p>
</blockquote>
<h2 id="Management插件"><a href="#Management插件" class="headerlink" title="Management插件"></a>Management插件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/lib/rabbitmq/lib/rabbitmq_server-3.1.5/sbin/</div><div class="line">./rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</div><div class="line">service rabbitmq-server status</div><div class="line">service rabbitmq-server restart</div><div class="line"></div><div class="line">/sbin/iptables -I INPUT -p tcp --dport 15672 -j ACCEPT</div><div class="line">/etc/rc.d/init.d/iptables save</div><div class="line">/etc/rc.d/init.d/iptables status</div></pre></td></tr></table></figure>
<h2 id="Python驱动"><a href="#Python驱动" class="headerlink" title="Python驱动"></a>Python驱动</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install pika</div></pre></td></tr></table></figure>
<h1 id="查看RabbitMQ-命令行管理管理工具rabbitmqctl"><a href="#查看RabbitMQ-命令行管理管理工具rabbitmqctl" class="headerlink" title="查看RabbitMQ 命令行管理管理工具rabbitmqctl"></a>查看RabbitMQ 命令行管理管理工具rabbitmqctl</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 查询RabbitMQ状态</span></div><div class="line">rabbitmqctl status</div></pre></td></tr></table></figure>
<h1 id="消息通信"><a href="#消息通信" class="headerlink" title="消息通信"></a>消息通信</h1><p>AMQP消息能以一对多的广播方式进行路由，也可以以一对一的方式路由</p>
<p>消息包含两部分内容：有效负荷（payload）和标签（label）</p>
<p>有效负荷是要传输的数据；标签描述了有效负荷。</p>
<p>生产者创建消息并设置标签。<br>消费者接收消息时，只得到消息的一部分，有效负荷。<br>如果消费者需要明确知道生产者信息，生产者需将发送方信息放入有效负荷中。</p>
<h2 id="信道"><a href="#信道" class="headerlink" title="信道"></a>信道</h2><p>应用程序和RabbitMQ代理服务器之间创建一条TCP连接。<br>线程启动后，会在现成的连接上创建一条信道，可就获得了连接到RabbitMQ上的私密通信路径。<br>所有线程只使用一条TCP连接以满足性能方面的要求，又能保证每个线程的私密性。</p>
<p>在一条TCP连接上创建多少条信道是没有限制的。</p>
<h2 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h2>]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Redis Note]]></title>
      <url>http://xiaozhuang.github.io/2017/03/09/redis-note/</url>
      <content type="html"><![CDATA[<p>Redis是一个远程内存数据库，不仅性能强劲，还具有复制特性以及为解决为题而生的独一无二的数据模型。<br><a id="more"></a></p>
<h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><p>Redis是非常高性能和轻量级的数据存储。<br>提供了键/值的数据访问方式来持久化数组、列表、集合以及哈希数据结构部。<br>支持<code>原子级</code>的计数器(counter)并具有高效的<code>基于主题</code>的发布/订阅消息功能。</p>
<h1 id="Geode与Redis"><a href="#Geode与Redis" class="headerlink" title="Geode与Redis"></a>Geode与Redis</h1><p>Apache Geode是一个相当成熟、强健的的数据管理平台，提供实时的、一致的、贯穿整个云架构地访问数据关键型应用。</p>
<p>Geode自身功能比较多，首先它是一个基于JVM的NoSQL分布式数据处理平台，同时集中间件、缓存、消息队列、事件处理引擎、NoSQL数据库于一身的分布式内存数据处理平台。可用来进行完成分布式缓存、数据持久化、，分布式事物、动态扩展等功能。</p>
<h1 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h1><blockquote>
<p>连接Redis前，别忘记防火墙开端口</p>
</blockquote>
<h2 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 安装redis驱动</span></div><div class="line"><span class="comment"># install redis-py</span></div><div class="line">pip install redis</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> redis</div><div class="line"><span class="comment"># r = redis.StrictRedis(host='192.168.47.131', port=6379, db=0, password='system')</span></div><div class="line">r = redis.StrictRedis(host=<span class="string">'localhost'</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</div><div class="line">print(r.set(<span class="string">'foo'</span>, <span class="string">'bar'</span>))</div><div class="line">print(r.get(<span class="string">'foo'</span>))</div></pre></td></tr></table></figure>
<h2 id="windows客户端RedisDesktopManager"><a href="#windows客户端RedisDesktopManager" class="headerlink" title="windows客户端RedisDesktopManager"></a>windows客户端RedisDesktopManager</h2><a href="https://redisdesktop.com/" title="RedisDesktopManager官网" target="_blank" rel="external">RedisDesktopManager官网</a>
<a href="http://docs.redisdesktop.com/en/latest/quick-start/" title="RedisDesktopManager文档" target="_blank" rel="external">RedisDesktopManager文档</a>
<h1 id="Redis-数据结构使用场景"><a href="#Redis-数据结构使用场景" class="headerlink" title="Redis 数据结构使用场景"></a>Redis 数据结构使用场景</h1><h1 id="Redis命令"><a href="#Redis命令" class="headerlink" title="Redis命令"></a>Redis命令</h1><h2 id="Redis中的字符串-string"><a href="#Redis中的字符串-string" class="headerlink" title="Redis中的字符串(string)"></a>Redis中的字符串(string)</h2><table>
<thead>
<tr>
<th>命令</th>
<th>作用 </th>
</tr>
</thead>
<tbody>
<tr>
<td>get</td>
<td>获取</td>
</tr>
<tr>
<td>set</td>
<td>设置</td>
</tr>
<tr>
<td>del</td>
<td>删除（<code>可用于所有类型</code>）</td>
</tr>
<tr>
<td>setnx</td>
<td>将 key 的值设为 value，当且仅当 key 不存在</td>
</tr>
</tbody>
</table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> hello world</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; get hello</div><div class="line"><span class="string">"world"</span></div><div class="line">127.0.0.1:6379&gt; get foo</div><div class="line"><span class="string">"bar"</span></div><div class="line">127.0.0.1:6379&gt; </div><div class="line">127.0.0.1:6379&gt; del hello foo2</div><div class="line">(<span class="built_in">integer</span>) 2</div><div class="line">127.0.0.1:6379&gt; get hello</div><div class="line">(nil)</div></pre></td></tr></table></figure>
<p>自增和自减命令</p>
<p>如果对不存在的键或者保存了空串的键执行自增或者自减操作，Redis将值当做0处理</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>作用 </th>
</tr>
</thead>
<tbody>
<tr>
<td>incr</td>
<td>值加一</td>
</tr>
<tr>
<td>decr</td>
<td>值减一</td>
</tr>
<tr>
<td>incrby</td>
<td>加上整数</td>
</tr>
<tr>
<td>decrby</td>
<td>减去整数</td>
</tr>
<tr>
<td>incrbyfloat</td>
<td>加上浮点数</td>
</tr>
</tbody>
</table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; incr key</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; incrby key 10</div><div class="line">(<span class="built_in">integer</span>) 11</div><div class="line">127.0.0.1:6379&gt; decr key</div><div class="line">(<span class="built_in">integer</span>) 10</div><div class="line">127.0.0.1:6379&gt; decrby key 10</div><div class="line">(<span class="built_in">integer</span>) 0</div><div class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> data_float 1.1</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; incrbyfloat data_float 0.1</div></pre></td></tr></table></figure>
<p>处理子串和二进制位的命令</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>作用 </th>
</tr>
</thead>
<tbody>
<tr>
<td>append</td>
<td>追加到末尾</td>
</tr>
<tr>
<td>getrange</td>
<td>获取指定范围子串</td>
</tr>
<tr>
<td>setrange</td>
<td>从指定位置开始子串设定为给定值</td>
</tr>
<tr>
<td>getbit</td>
<td>字符串看做二进制位串，返回指定偏移量的二进制值</td>
</tr>
<tr>
<td>setbit</td>
<td>设置二进制位的值</td>
</tr>
<tr>
<td>bitcount</td>
<td>统计二进制位串里值为1的二进制数量</td>
</tr>
<tr>
<td>bitop</td>
<td>对一个或多个二进制串执行并（AND）、或（OR）、异或（XOR）、非（NOT）按位操作</td>
</tr>
</tbody>
</table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; append new-string-key <span class="string">'hello '</span></div><div class="line">(<span class="built_in">integer</span>) 11</div><div class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> new-string-key <span class="string">'hello '</span></div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; </div><div class="line">127.0.0.1:6379&gt; append new-string-key world!</div><div class="line">(<span class="built_in">integer</span>) 12</div><div class="line">127.0.0.1:6379&gt; substr new-string-key 3 7</div><div class="line"><span class="string">"lo wo"</span></div><div class="line">127.0.0.1:6379&gt; setrange new-string-key 0 H</div><div class="line">(<span class="built_in">integer</span>) 12</div><div class="line">127.0.0.1:6379&gt; setrange new-string-key 6 W</div><div class="line">(<span class="built_in">integer</span>) 12</div><div class="line">127.0.0.1:6379&gt; get new-string-key</div><div class="line"><span class="string">"Hello World!"</span></div><div class="line">127.0.0.1:6379&gt; setrange new-string-key 11 <span class="string">', how are you?'</span></div><div class="line">(<span class="built_in">integer</span>) 25</div><div class="line">127.0.0.1:6379&gt; setbit another-key 2 1</div><div class="line">(<span class="built_in">integer</span>) 0</div><div class="line">127.0.0.1:6379&gt; setbit another-key 7 1</div><div class="line">(<span class="built_in">integer</span>) 0</div><div class="line">127.0.0.1:6379&gt; get another-key</div><div class="line"><span class="string">"!"</span></div></pre></td></tr></table></figure>
<h3 id="过期时间"><a href="#过期时间" class="headerlink" title="过期时间"></a>过期时间</h3><p>EXPIRE key seconds  为给定 key 设置生存时间，当 key 过期时(生存时间为 0 )，它会被自动删除。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">redis&gt; EXPIRE cache_page 30  <span class="comment"># 设置过期时间为 30 秒</span></div><div class="line">(<span class="built_in">integer</span>) 1</div></pre></td></tr></table></figure>
<h2 id="Redis中列表-list"><a href="#Redis中列表-list" class="headerlink" title="Redis中列表(list)"></a>Redis中列表(list)</h2><p>Redis对链表（<code>linked-list</code>）结构的支持使得它在键值存储的世界中独树一帜</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>作用 </th>
</tr>
</thead>
<tbody>
<tr>
<td>rpush</td>
<td>推入左端</td>
</tr>
<tr>
<td>lpush</td>
<td>推入右端</td>
</tr>
<tr>
<td>lpop</td>
<td>左端弹出 </td>
</tr>
<tr>
<td>rpop</td>
<td>右端弹出</td>
</tr>
<tr>
<td>lindex</td>
<td>获取列表指定位置元素</td>
</tr>
<tr>
<td>lrange</td>
<td>获取给定范围内元素（包含偏移量两端元素,0,-1返回全部）</td>
</tr>
<tr>
<td>ltrim</td>
<td>修剪列表（偏移量两端的元素会保留）</td>
</tr>
</tbody>
</table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; rpush list-key item</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; rpush list-key item2</div><div class="line">(<span class="built_in">integer</span>) 2</div><div class="line">127.0.0.1:6379&gt; lrange list-key 0 -1</div><div class="line">1) <span class="string">"item"</span></div><div class="line">2) <span class="string">"item2"</span></div><div class="line">127.0.0.1:6379&gt; rpush list-key item</div><div class="line">(<span class="built_in">integer</span>) 3</div><div class="line"><span class="comment"># </span></div><div class="line">127.0.0.1:6379&gt; lrange list-key 0 -1</div><div class="line">1) <span class="string">"item"</span></div><div class="line">2) <span class="string">"item2"</span></div><div class="line">3) <span class="string">"item"</span></div><div class="line">127.0.0.1:6379&gt; lindex list-key 0</div><div class="line"><span class="string">"item"</span></div><div class="line">127.0.0.1:6379&gt; lpop list-key</div><div class="line"><span class="string">"item"</span></div></pre></td></tr></table></figure>
<p>阻塞是列表弹出命令以及在列表之间移动元素的命令</p>
<p>阻塞弹出命令和弹出并推入命令，常见用例是<code>消息传递（messageing）</code>和<code>任务队列（task queue）</code></p>
<table>
<thead>
<tr>
<th>命令</th>
<th>作用 </th>
</tr>
</thead>
<tbody>
<tr>
<td>blpop</td>
<td>弹出左端元素 或阻塞等待</td>
</tr>
<tr>
<td>brpop</td>
<td>弹出右端元素 或阻塞等待</td>
</tr>
<tr>
<td>rpoplpush</td>
<td>从源列表右侧弹出，推入目标列表左侧，并返回该元素</td>
</tr>
<tr>
<td>brpoplpush</td>
<td>从源列表右侧弹出，推入目标列表左侧，并返回该元素 或阻塞等待</td>
</tr>
</tbody>
</table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; lpush list item1</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; </div><div class="line">127.0.0.1:6379&gt; rpush list item1</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; rpush list item2</div><div class="line">(<span class="built_in">integer</span>) 2</div><div class="line">127.0.0.1:6379&gt; rpush list item3</div><div class="line">(<span class="built_in">integer</span>) 3</div><div class="line">127.0.0.1:6379&gt; </div><div class="line">127.0.0.1:6379&gt; rpush list2 item3</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; brpoplpush list2 list 1</div><div class="line"><span class="string">"item3"</span></div><div class="line">127.0.0.1:6379&gt; brpoplpush list2 list 1</div><div class="line">(nil)</div><div class="line">(1.08s)</div><div class="line">127.0.0.1:6379&gt; lrange list 0 -1</div><div class="line">1) <span class="string">"item3"</span></div><div class="line">2) <span class="string">"item1"</span></div><div class="line">3) <span class="string">"item2"</span></div></pre></td></tr></table></figure>
<h2 id="Redis集合-set"><a href="#Redis集合-set" class="headerlink" title="Redis集合(set)"></a>Redis集合(set)</h2><table>
<thead>
<tr>
<th>命令</th>
<th>作用 </th>
</tr>
</thead>
<tbody>
<tr>
<td>sadd</td>
<td>添加元素</td>
</tr>
<tr>
<td>srem</td>
<td>移除元素</td>
</tr>
<tr>
<td>scard</td>
<td>元素数量</td>
</tr>
<tr>
<td>sismember</td>
<td>检查是否存在</td>
</tr>
<tr>
<td>srandmember</td>
<td>随机返回一个或多个元素</td>
</tr>
<tr>
<td>smembers</td>
<td>获取所有（注：若元素非常多，会很慢，谨慎使用）</td>
</tr>
<tr>
<td>spop</td>
<td>随机移除一个元素，并返回该元素</td>
</tr>
<tr>
<td>smove</td>
<td>从源集合移动至目标集合</td>
</tr>
</tbody>
</table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; sadd <span class="built_in">set</span>-key item</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; sadd <span class="built_in">set</span>-key item2</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; sadd <span class="built_in">set</span>-key item3</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; sadd <span class="built_in">set</span>-key item</div><div class="line">(<span class="built_in">integer</span>) 0</div><div class="line">127.0.0.1:6379&gt; smembers <span class="built_in">set</span>-key</div><div class="line">1) <span class="string">"item3"</span></div><div class="line">2) <span class="string">"item2"</span></div><div class="line">3) <span class="string">"item"</span></div><div class="line">127.0.0.1:6379&gt; sismember <span class="built_in">set</span>-key item</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; sismember <span class="built_in">set</span>-key item4</div><div class="line">(<span class="built_in">integer</span>) 0</div><div class="line">127.0.0.1:6379&gt; srem <span class="built_in">set</span>-key item3</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; smembers <span class="built_in">set</span>-key</div><div class="line">1) <span class="string">"item2"</span></div><div class="line">2) <span class="string">"item"</span></div></pre></td></tr></table></figure>
<p>用于组合和处理多个集合的Redis命令</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>作用 </th>
</tr>
</thead>
<tbody>
<tr>
<td>sdiff</td>
<td>返回存在于第一个集合，不存在与其他集合的元素（<code>差集计算</code>） </td>
</tr>
<tr>
<td>sdiffstore</td>
<td><code>差集计算</code>并存储结果</td>
</tr>
<tr>
<td>sinter</td>
<td>同时存在于所有集合中的元素（<code>交集计算</code>）</td>
</tr>
<tr>
<td>sinterstore</td>
<td><code>交集计算</code>并存储结果</td>
</tr>
<tr>
<td>sunion</td>
<td>至少存在于一个集合中的元素（<code>并集计算</code>）</td>
</tr>
<tr>
<td>sunionstore</td>
<td><code>并集计算</code>并存储结果</td>
</tr>
</tbody>
</table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; sadd skey1 a b c d</div><div class="line">(<span class="built_in">integer</span>) 4</div><div class="line">127.0.0.1:6379&gt; sadd skey2 c d e f</div><div class="line">(<span class="built_in">integer</span>) 4</div><div class="line">127.0.0.1:6379&gt; sdiff skey1 skey2</div><div class="line">1) <span class="string">"a"</span></div><div class="line">2) <span class="string">"b"</span></div><div class="line">127.0.0.1:6379&gt; sinter skey1 skey2</div><div class="line">1) <span class="string">"c"</span></div><div class="line">2) <span class="string">"d"</span></div><div class="line">127.0.0.1:6379&gt; sunion skey1 skey2</div><div class="line">1) <span class="string">"c"</span></div><div class="line">2) <span class="string">"d"</span></div><div class="line">3) <span class="string">"e"</span></div><div class="line">4) <span class="string">"b"</span></div><div class="line">5) <span class="string">"a"</span></div><div class="line">6) <span class="string">"f"</span></div></pre></td></tr></table></figure>
<h2 id="Redis的散列-hash"><a href="#Redis的散列-hash" class="headerlink" title="Redis的散列(hash)"></a>Redis的散列(hash)</h2><table>
<thead>
<tr>
<th>命令</th>
<th>作用 </th>
</tr>
</thead>
<tbody>
<tr>
<td>hset</td>
<td>添加一个键值对</td>
</tr>
<tr>
<td>hmset</td>
<td>设置一个或多个键的值</td>
</tr>
<tr>
<td>hget</td>
<td>获取单个键的值</td>
</tr>
<tr>
<td>hmget</td>
<td>获取一个或多个键的值</td>
</tr>
<tr>
<td>hdel</td>
<td>移除键值对</td>
</tr>
<tr>
<td>hgetall</td>
<td>获取所有键值对</td>
</tr>
<tr>
<td>hlen</td>
<td>散列包含价值对数量</td>
</tr>
</tbody>
</table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; hset <span class="built_in">hash</span>-key sub-key value</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; hset <span class="built_in">hash</span>-key sub-key2 value2</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; hset <span class="built_in">hash</span>-key sub-key value</div><div class="line">(<span class="built_in">integer</span>) 0</div><div class="line">127.0.0.1:6379&gt; hgetall <span class="built_in">hash</span>-key</div><div class="line">1) <span class="string">"sub-key"</span></div><div class="line">2) <span class="string">"value"</span></div><div class="line">3) <span class="string">"sub-key2"</span></div><div class="line">4) <span class="string">"value2"</span></div><div class="line">127.0.0.1:6379&gt; hdel <span class="built_in">hash</span>-key sub-key</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; hdel <span class="built_in">hash</span>-key sub-key</div><div class="line">(<span class="built_in">integer</span>) 0</div><div class="line">127.0.0.1:6379&gt; hgetall <span class="built_in">hash</span>-key</div><div class="line">1) <span class="string">"sub-key2"</span></div><div class="line">2) <span class="string">"value2"</span></div></pre></td></tr></table></figure>
<p>散列批处理命令<br>命令 | 作用<br>————|————–<br>hexists | 检查指定键是否存在于散列中<br>hkeys | 获取散列所有键<br>hvals | 获取散列所有值<br>hgetall | 散列包含的所有键值对<br>hincrby | 将键保存的值加上整数<br>hincrbyfloat | 将键保存的值加上浮点数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; hmset <span class="built_in">hash</span>-key2 short hello long 1000*<span class="string">'1'</span></div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; hkeys <span class="built_in">hash</span>-key2</div><div class="line">1) <span class="string">"short"</span></div><div class="line">2) <span class="string">"long"</span></div><div class="line">127.0.0.1:6379&gt; hexists <span class="built_in">hash</span>-key2 num</div><div class="line">(<span class="built_in">integer</span>) 0</div><div class="line">127.0.0.1:6379&gt; hincrby <span class="built_in">hash</span>-key2 num 1</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; hexists <span class="built_in">hash</span>-key2 num</div><div class="line">(<span class="built_in">integer</span>) 1</div></pre></td></tr></table></figure>
<h2 id="Redis的有序集合-zset"><a href="#Redis的有序集合-zset" class="headerlink" title="Redis的有序集合(zset)"></a>Redis的有序集合(zset)</h2><p>存储键值对，键被称为成员(member)，值被称为分值(score),分值必须为浮点数<br>既可以根据成员访问元素，又可以根据分值及分值排序访问元素</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>作用 </th>
</tr>
</thead>
<tbody>
<tr>
<td>zadd</td>
<td>添加成员</td>
</tr>
<tr>
<td>zrem</td>
<td>移除成员</td>
</tr>
<tr>
<td>zcard</td>
<td>成员数量</td>
</tr>
<tr>
<td>zincrby</td>
<td>增加成员分值</td>
</tr>
<tr>
<td>zrange</td>
<td>根据排序位置，获取集合中元素</td>
</tr>
<tr>
<td>zrangebyscore</td>
<td>获取给定分值范围内元素</td>
</tr>
<tr>
<td>zcount</td>
<td>分值介于min和max之间的成员数量</td>
</tr>
<tr>
<td>zsore</td>
<td>返回成员分值</td>
</tr>
<tr>
<td>zrank</td>
<td>获取成员排名</td>
</tr>
</tbody>
</table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; zadd zset-key 728 member1</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; zadd zset-key 982 member0</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; zadd zset-key 982 member0</div><div class="line">(<span class="built_in">integer</span>) 0</div><div class="line">127.0.0.1:6379&gt; zrange zset-key 0 -1 </div><div class="line">1) <span class="string">"member1"</span></div><div class="line">2) <span class="string">"member0"</span></div><div class="line">127.0.0.1:6379&gt; zrange zset-key 0 -1 withscores</div><div class="line">1) <span class="string">"member1"</span></div><div class="line">2) <span class="string">"728"</span></div><div class="line">3) <span class="string">"member0"</span></div><div class="line">4) <span class="string">"982"</span></div><div class="line">127.0.0.1:6379&gt; zrangebyscore zset-key 0 800 withscores</div><div class="line">1) <span class="string">"member1"</span></div><div class="line">2) <span class="string">"728"</span></div><div class="line">127.0.0.1:6379&gt; zrem zset-key member1</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; zrem zset-key member1</div><div class="line">(<span class="built_in">integer</span>) 0</div><div class="line">127.0.0.1:6379&gt; zrange zset-key 0 -1 withscores</div><div class="line">1) <span class="string">"member0"</span></div><div class="line">2) <span class="string">"982"</span></div><div class="line"></div><div class="line"></div><div class="line">127.0.0.1:6379&gt; zadd zset-key a|3 b|2 c|1</div><div class="line">(error) ERR syntax error</div><div class="line">127.0.0.1:6379&gt; zadd zset-key a 3 b 2 c 1</div><div class="line">(error) ERR value is not a valid <span class="built_in">float</span></div><div class="line">127.0.0.1:6379&gt; zadd zset-key 3|a 2|b 1|c</div><div class="line">(error) ERR syntax error</div><div class="line">127.0.0.1:6379&gt; zadd zset-key 3 a 2 b 1 c</div><div class="line">(<span class="built_in">integer</span>) 3</div><div class="line">127.0.0.1:6379&gt; zrem zset-key a b</div><div class="line">(<span class="built_in">integer</span>) 2</div><div class="line">127.0.0.1:6379&gt; zcard zset-key</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; zincrby zset-key 3 c</div><div class="line"><span class="string">"4"</span></div><div class="line">127.0.0.1:6379&gt; zscore zset-key c</div><div class="line"><span class="string">"4"</span></div><div class="line">127.0.0.1:6379&gt; zcount zset-key 3 9</div><div class="line">(<span class="built_in">integer</span>) 1</div><div class="line">127.0.0.1:6379&gt; zrank zset-key c</div><div class="line">(<span class="built_in">integer</span>) 0</div><div class="line">127.0.0.1:6379&gt; zrange zset-key 0 100</div><div class="line">1) <span class="string">"c"</span></div><div class="line">127.0.0.1:6379&gt;</div></pre></td></tr></table></figure>
<h1 id="共享锁、排他锁"><a href="#共享锁、排他锁" class="headerlink" title="共享锁、排他锁"></a>共享锁、排他锁</h1><p>X锁 eXclusive<br>S锁 Share</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[JavaEE Thymeleaf]]></title>
      <url>http://xiaozhuang.github.io/2017/02/27/javaee-thymeleaf/</url>
      <content type="html"><![CDATA[<p>JavaEE Thymeleaf学习笔记<br><a id="more"></a></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>[taim li:f]</p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><h2 id="url拼接"><a href="#url拼接" class="headerlink" title="url拼接"></a>url拼接</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">th:if</span>=<span class="string">"$&#123;workreportInfo!=null&#125;"</span> <span class="attr">th:attr</span>=<span class="string">"nav-url=$&#123;'~/entities/WorkReportManage/edit?id='+workreportInfo.id + '&amp;amp;view=design'&#125;"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"workreport_create_btn"</span> <span class="attr">class</span>=<span class="string">"btn blue span3"</span> <span class="attr">nav-url</span>=<span class="string">"~/entities/WorkReportManage/create?view=design"</span>&gt;</span> </div><div class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>填报项目信息<span class="tag">&lt;/<span class="name">span</span>&gt;</span> </div><div class="line">    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"m-icon-swapright m-icon-white"</span>&gt;</span> <span class="tag">&lt;/<span class="name">i</span>&gt;</span> </div><div class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="多条件判断"><a href="#多条件判断" class="headerlink" title="多条件判断"></a>多条件判断</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">th:if</span>=<span class="string">"$&#123;workreportInfo == null or workreportInfo.entityName == null&#125;"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"workreport_template_select_btn"</span> <span class="attr">class</span>=<span class="string">"btn green span4"</span> <span class="attr">nav-url</span>=<span class="string">"~/workreportDesign/template_select"</span>&gt;</span> </div><div class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>模板选择<span class="tag">&lt;/<span class="name">span</span>&gt;</span> </div><div class="line">    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"m-icon-swapright m-icon-white"</span>&gt;</span> <span class="tag">&lt;/<span class="name">i</span>&gt;</span> </div><div class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">th:if</span>=<span class="string">"$&#123;workreportInfo != null and workreportInfo.entityName != null&#125;"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"workreport_template_view_design_btn"</span> <span class="attr">class</span>=<span class="string">"btn yellow span4"</span> <span class="attr">nav-url</span>=<span class="string">"~/workreportDesign/view_design"</span>&gt;</span> </div><div class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>视图设计<span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"m-icon-swapright m-icon-white"</span>&gt;</span> <span class="tag">&lt;/<span class="name">i</span>&gt;</span> </div><div class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- Process thymeleaf variable as html code and not string --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"span12"</span> <span class="attr">th:utext</span>=<span class="string">"$&#123;field.component_dom&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="条件添加样式"><a href="#条件添加样式" class="headerlink" title="条件添加样式"></a>条件添加样式</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">th:classappend</span>=<span class="string">"$&#123;workreportInfo != null and workreportInfo.referenceMenu != null&#125; ? 'hide' : 'show'"</span>  <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"workreport_template_select_btn"</span> <span class="attr">class</span>=<span class="string">"btn green span4"</span> <span class="attr">nav-url</span>=<span class="string">"~/workreportDesign/template_select"</span>&gt;</span> </div><div class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>模板选择<span class="tag">&lt;/<span class="name">span</span>&gt;</span> </div><div class="line">    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"m-icon-swapright m-icon-white"</span>&gt;</span> <span class="tag">&lt;/<span class="name">i</span>&gt;</span> </div><div class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="Dom属性"><a href="#Dom属性" class="headerlink" title="Dom属性"></a>Dom属性</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"workreport_info_btn"</span> <span class="attr">th:attr</span>=<span class="string">"nav-url=$&#123;'~/entities/WorkReportManage/view?id='+workreportInfo.id + '&amp;amp;view=design'&#125;"</span> </span></div><div class="line">	<span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn orange_btn span3 btn_active"</span> <span class="attr">nav-url</span>=<span class="string">"~/entities/WorkReportManage/create?view=design"</span>&gt; </div><div class="line">	<span class="tag">&lt;<span class="name">span</span>&gt;</span>填报项目信息<span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"m-icon-swapright m-icon-white"</span>&gt;</span> <span class="tag">&lt;/<span class="name">i</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="原样输出HTML"><a href="#原样输出HTML" class="headerlink" title="原样输出HTML"></a>原样输出HTML</h2><p>th:utext</p>
<h2 id="url及参数拼接"><a href="#url及参数拼接" class="headerlink" title="url及参数拼接"></a>url及参数拼接</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">th:href="$&#123;contextPath&#125; + '/portal/' + @&#123;detail(orderId=$&#123;notice.get('id')&#125;,mod=0,ur='index')&#125;"</div></pre></td></tr></table></figure>
<h2 id="使用param参数"><a href="#使用param参数" class="headerlink" title="使用param参数"></a>使用param参数</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">meta:placeholder</span> <span class="attr">th:if</span>=<span class="string">"$&#123;param.mod[0]!=null&#125;"</span> &gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">"@&#123;$&#123;'/portal/' + param.ur[0]&#125;(mod=$&#123;param.mod[0]&#125;)&#125;"</span>&gt;</span>返回<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">meta:placeholder</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta:placeholder</span> <span class="attr">th:if</span>=<span class="string">"$&#123;param.mod[0]==null&#125;"</span> &gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">"@&#123;$&#123;'/portal/' + param.ur[0]&#125;&#125;"</span>&gt;</span>返回<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">meta:placeholder</span>&gt;</span></div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java Multithread]]></title>
      <url>http://xiaozhuang.github.io/2017/02/09/javase-multithread/</url>
      <content type="html"><![CDATA[<p>Java多线程<br><a id="more"></a></p>
<h1 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h1><p>在并发编程中，我们通常会遇到以下三个问题：原子性问题，可见性问题，有序性问题。</p>
<h2 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h2><p>在java中基本类型的大部分读取和写入操作是原子性的,但是long和double除外。<br>在32位操作系统上对64位的数据的读写要分两步完成。<br>jvm将long和double读取和写入当作分离的两次32位操作来执行。<br>使用volatile关键字来防止此类现象。<br>volatile本身不保证获取和设置操作的原子性，仅仅保持修改的可见性。java<code>内存模型</code>保证声明为<code>volatile的long和double变量的get和set操作是原子的</code>。</p>
<h2 id="volatile-变量特征"><a href="#volatile-变量特征" class="headerlink" title="volatile 变量特征"></a>volatile 变量特征</h2><ul>
<li>保证此变量对所有线程可见,也就是说一个线程修改了值，其他线程可以立刻得知</li>
</ul>
<h2 id="主内存和本地内存"><a href="#主内存和本地内存" class="headerlink" title="主内存和本地内存"></a>主内存和本地内存</h2><p>线程之间的共享变量存储在主内存（main memory）中，每个线程都有一个私有的本地内存（local memory），<br>本地内存中存储了该线程可读/写共享变量的副本。<br>本地内存是JMM的一个抽象概念，并不真实存在。它是寄存器和高速缓存的抽象描述。</p>
<p>每个线程都有自己的执行空间(即工作内存)，<br>线程执行的时候用到某变量，首先要将变量从主内存拷贝的自己的工作内存，然后对变量进行操作：读取，修改，赋值等，这些均在工作内存完成，<br>操作完成后再将变量写回主内存；</p>
<h2 id="Java内存模型"><a href="#Java内存模型" class="headerlink" title="Java内存模型"></a>Java内存模型</h2><p>在java中，所有实例域、静态域和数组元素存储在堆内存中，堆内存在线程之间共享。</p>
<h2 id="synchronized关键字"><a href="#synchronized关键字" class="headerlink" title="synchronized关键字"></a>synchronized关键字</h2><p>Synchronized保证了数据<code>读写一致</code>和<code>可见性</code>等<br>synchronized能够<code>防止多个线程同时进入并访问程序的临界区</code></p>
<h2 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h2><p>ReentrantLock, ReentrantReadWriteLock.ReadLock, ReentrantReadWriteLock.WriteLock </p>
<p>实现Lock接口的基本思想<br>实现锁的功能，两个必备元素，一个是表示（锁）状态的变量。<br>另一个是队列，队列中的节点表示因未能获取锁而阻塞的线程。</p>
<p>Lock接口</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>lock()</td>
<td>获取锁，否则block</td>
</tr>
<tr>
<td>tryLock()</td>
<td>尝试性地获取锁，不管有没有获取到都马上返回，拿到锁返回true，否则返回false 。</td>
</tr>
<tr>
<td>tryLock(long time, TimeUnit unit)</td>
<td>如果获取不到锁，就等待一段时间，超时返回false</td>
</tr>
<tr>
<td>lockInterruptibly()</td>
<td>如果当前线程未被中断，则获取锁</td>
</tr>
</tbody>
</table>
<p>线程中断</p>
<ul>
<li>线程在sleep、wait或者join,调用该线程的 interrupt()方法,此线程会被唤醒并被要求处理InterruptedException</li>
<li>如果线程处在运行状态，在调用该线程的interrupt()方法时，不会响应该中断</li>
</ul>
<h2 id="Lock与synchronized的区别"><a href="#Lock与synchronized的区别" class="headerlink" title="Lock与synchronized的区别"></a>Lock与synchronized的区别</h2><ul>
<li>Lock的加锁和解锁都是由java代码配合<code>native方法</code>（调用操作系统的相关方法） 实现的，而synchronize的加锁和解锁的过程是由<code>JVM管理</code>的</li>
<li>当一个线程使用synchronize获取锁时，若锁被其他线程占用着，那么当前线程只能被阻塞，直到成功获取锁。而Lock则提供<code>超时锁</code>和<code>可中断</code>等更加灵活的方式，在未能获取锁的条件下提供一种退出的机制。</li>
<li>一个锁内部可以有<code>多个Condition实例</code>，即有<code>多路条件队列</code>，而synchronize只有一路条件队列；同样Condition也提供灵活的阻塞方式，在未获得通知之前可以通过中断线程以及设置等待时限等方式退出条件队列。</li>
<li>synchronize对线程的同步<code>仅提供独占模式</code>，而Lock即可以提供<code>独占模式</code>，也可以提供<code>共享模式</code></li>
</ul>
<h2 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h2><p>Condition实例的内部实际上维护了一个队列，<br>队列中的节点表示由于（某些条件不满足而）线程自身调用await方法阻塞的线程。</p>
<p>对于await方法，它内部会执行释放锁的操作</p>
<p>被唤醒后执行，尝试去获取锁，执行到这里时线程已不在条件队列中，而是位于等待（锁的）队列中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// java.util.concurrent.locks.Condition</span></div><div class="line"><span class="comment">// 造成当前线程在接到信号、被中断或到达指定等待时间之前一直处于等待状态</span></div><div class="line"><span class="comment">// nanosTimeout - 等待的最长时间，以毫微秒为单位</span></div><div class="line"><span class="function"><span class="keyword">long</span> <span class="title">awaitNanos</span><span class="params">(<span class="keyword">long</span> nanosTimeout)</span> <span class="keyword">throws</span> InterruptedException</span>;</div></pre></td></tr></table></figure>
<h2 id="synchronized和wait-、notify"><a href="#synchronized和wait-、notify" class="headerlink" title="synchronized和wait()、notify()"></a>synchronized和wait()、notify()</h2><p>几乎没有理由再使用wait和notify了。java 1.5提供了更高级的并发工具。<br>java.util.concurrent中更高级的工具分成三类：<code>Executor Fragment</code>、并发集合（<code>Concurrent Collection</code>）、同步器（<code>Synchronizer</code>）</p>
<p>wait方法必须在同步区域内部调用。<br>应该使用<code>while</code>循环模式调用wait,在等待<code>之前</code>和<code>之后</code>测试条件</p>
<h2 id="同步器"><a href="#同步器" class="headerlink" title="同步器"></a>同步器</h2><p>CyclicBarrier<br>\ˈsaɪklɪk\ \ˈbæriə(r)\</p>
<h2 id="AtomicInteger"><a href="#AtomicInteger" class="headerlink" title="AtomicInteger"></a>AtomicInteger</h2><p>AtomicInteger，可以用原子方式更新的 int 值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">AtomicInteger ai = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</div><div class="line"><span class="comment">// 以原子方式将给定值与当前值相加</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">addAndGet</span><span class="params">(<span class="keyword">int</span> delta)</span></span></div></pre></td></tr></table></figure>
<h1 id="守护线程-amp-非守护线程"><a href="#守护线程-amp-非守护线程" class="headerlink" title="守护线程&amp;非守护线程"></a>守护线程&amp;非守护线程</h1><p>守护线程：创建线程的父线程结束时，守护线程自动结束<br>非守护线程：即使父线程死亡，非守护线程仍然存活</p>
<h1 id="Executor-框架"><a href="#Executor-框架" class="headerlink" title="Executor 框架"></a>Executor 框架</h1><p>/ɪgˈzekjətə/<br>在 Java 5之后，通过 Executor 来启动线程比使用 Thread 的 start 方法更好，除了更易管理，效率更好（用线程池实现，节约开销）外，还有关键的一点：有助于避免 this 逃逸问题</p>
<p>this逃逸指在构造函数返回之前其他线程就持有该对象的引用. 调用尚未构造完全的对象的方法可能引发令人疑惑的错误</p>
<p>ExecutorService 的 shutdown()方法来平滑地关闭 ExecutorService，调用该方法后，将导致 ExecutorService 停止接受任何新的任务且等待已经提交的任务执行完成</p>
<p>ExecutorService 的生命周期包括三种状态：运行、关闭、终止</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 四种方法都是用的 Executors 中的 ThreadFactory 建立的线程</span></div><div class="line"></div><div class="line"><span class="comment">//创建固定数目线程的线程池。</span></div><div class="line"><span class="comment">//FixedThreadPool 多数针对一些很稳定很固定的正规并发线程，多用于服务器</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> nThreads)</span></span></div><div class="line"></div><div class="line"><span class="comment">//创建一个可缓存的线程池,终止并从缓存中移除那些已有 60 秒钟未被使用的线程</span></div><div class="line"><span class="comment">//缓存型池子通常用于执行一些生存期很短的异步型任务</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newCachedThreadPool</span><span class="params">()</span></div><div class="line"></div><div class="line"><span class="comment">//创建一个单个 worker 线程的 Executor,以无界队列方式来运行该线程</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newSingleThreadExecutor</span><span class="params">()</span></div><div class="line"></div><div class="line"><span class="comment">//创建一个支持定时及周期性的任务执行的线程池</span></div><div class="line"><span class="comment">//池子里的线程可以按 schedule 依次 delay 执行，或周期执行</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title">newScheduledThreadPool</span><span class="params">(<span class="keyword">int</span> corePoolSize)</span></div></pre></td></tr></table></figure>
<blockquote>
<p>一般来说，CachedTheadPool 在程序执行过程中通常会创建与所需数量相同的线程，然后在它回收旧线程时停止创建新线程，因此它是合理的 Executor 的首选，只有当这种方式会引发问题时（比如需要大量长时间面向连接的线程时），才需要考虑用 FixedThreadPool。（摘自《Thinking in Java》第四版）</p>
<p>如果队列容量已达上限，并且当前大小poolSize没有达到maximumPoolSize，那么就新增线程来处理任务</p>
</blockquote>
<h2 id="Runnable接口"><a href="#Runnable接口" class="headerlink" title="Runnable接口"></a>Runnable接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sunday.multithread_demo;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ScheduledExecutorService;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.security.keys.keyresolver.implementations.PrivateKeyResolver;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleThreadPool</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> nThreads = <span class="number">5</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> corePoolSize = <span class="number">5</span>;</div><div class="line">    </div><div class="line">    <span class="comment">//首次执行延迟</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> initialDelay = <span class="number">2</span>;</div><div class="line">    </div><div class="line">    <span class="comment">//连续执行之间的周期</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> period = <span class="number">5</span>;</div><div class="line">    </div><div class="line">    <span class="comment">//一次执行终止和下一次执行开始之间的延迟</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> delay = <span class="number">5</span>;</div><div class="line">    </div><div class="line">    <span class="comment">//处理工作</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doWrok</span><span class="params">(ExecutorService executor)</span></span>&#123;</div><div class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">                Runnable worker = <span class="keyword">new</span> WorkerThread(i);</div><div class="line">                executor.execute(worker);</div><div class="line">              &#125;</div><div class="line">            executor.shutdown();</div><div class="line">            <span class="comment">//关闭后所有任务都已完成，则返回 true </span></div><div class="line">            <span class="keyword">while</span> (!executor.isTerminated()) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Thread.sleep(<span class="number">1000</span>);</div><div class="line">                    System.out.println(<span class="string">"wait..."</span>);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            System.out.println(<span class="string">"Finished all threads"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//固定线程数的线程池</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixed</span><span class="params">()</span></span>&#123;</div><div class="line">        ExecutorService executor = Executors.newFixedThreadPool(nThreads);</div><div class="line">        doWrok(executor);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">//根据需要创建新线程的可缓存线程池</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">cached</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="comment">//根据需要创建新线程的线程池</span></div><div class="line">        ExecutorService executor = Executors.newCachedThreadPool();</div><div class="line">        doWrok(executor);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">//单个 worker 线程的 Executor</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">single</span><span class="params">()</span></span>&#123;</div><div class="line">        ExecutorService executor = Executors.newSingleThreadExecutor();</div><div class="line">        doWrok(executor);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scheduled</span><span class="params">()</span></span>&#123;        </div><div class="line">        ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(corePoolSize);</div><div class="line">        </div><div class="line">        <span class="comment">//创建并执行在给定延迟后启用的一次性操作</span></div><div class="line">        <span class="comment">//scheduler.schedule(new WorkerThread(), initialDelay, TimeUnit.SECONDS);</span></div><div class="line">        <span class="comment">//scheduler.shutdown();</span></div><div class="line">        </div><div class="line">        <span class="comment">//固定速率</span></div><div class="line">        scheduler.scheduleAtFixedRate(<span class="keyword">new</span> WorkerThread(), initialDelay, period, TimeUnit.SECONDS);</div><div class="line">        </div><div class="line">        <span class="comment">//固定延迟</span></div><div class="line">        scheduler.scheduleWithFixedDelay(<span class="keyword">new</span> WorkerThread(), initialDelay, delay, TimeUnit.SECONDS);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"><span class="comment">//      fixed();</span></div><div class="line">        </div><div class="line"><span class="comment">//      cached();</span></div><div class="line">        </div><div class="line">        </div><div class="line">        single();</div><div class="line">        </div><div class="line"><span class="comment">//      scheduled();</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WorkerThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">      </div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> command;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WorkerThread</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.command = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WorkerThread</span><span class="params">(<span class="keyword">int</span> s)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.command = s;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">" Start. Command = "</span>+(command++));</div><div class="line">        processCommand();</div><div class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">" End."</span>); </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processCommand</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Thread.sleep(<span class="number">5000</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.command + <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<a href="/2017/02/09/javase-multithread/SimpleThreadPool.java" title="SimpleThreadPool.java">SimpleThreadPool.java</a>
<h2 id="Callable-接口"><a href="#Callable-接口" class="headerlink" title="Callable 接口"></a>Callable 接口</h2><p>在 Java 5 之后，任务分两类：一类是实现了 Runnable 接口的类，一类是实现了 Callable 接口的类。两者都可以被 ExecutorService 执行，但是 Runnable 任务没有返回值，而 Callable 任务有返回值</p>
<p>当将一个 Callable 的对象传递给 ExecutorService 的 submit 方法，则该 call 方法自动在一个线程上执行，并且会返回执行结果 Future 对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sunday.multithread_demo;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException; </div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.Future;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CallableDemo</span></span>&#123;   </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] ar,gs)</span></span>&#123;   </div><div class="line">        ExecutorService executorService = Executors.newCachedThreadPool();   </div><div class="line">        List&lt;Future&lt;String&gt;&gt; resultList = <span class="keyword">new</span> ArrayList&lt;Future&lt;String&gt;&gt;();   </div><div class="line"></div><div class="line">        <span class="comment">//创建10个任务并执行   </span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;   </div><div class="line">            <span class="comment">//使用ExecutorService执行Callable类型的任务，并将结果保存在future变量中   </span></div><div class="line">            Future&lt;String&gt; future = executorService.submit(<span class="keyword">new</span> TaskWithResult(i));</div><div class="line">            <span class="comment">//将任务执行结果存储到List中   </span></div><div class="line">            resultList.add(future);   </div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">//启动一次顺序关闭，执行以前提交的任务，但不接受新任务  </span></div><div class="line">        executorService.shutdown();   </div><div class="line"></div><div class="line">        <span class="comment">//遍历任务的结果   </span></div><div class="line">        <span class="keyword">for</span> (Future&lt;String&gt; fs : resultList)&#123;   </div><div class="line">                <span class="keyword">try</span>&#123;</div><div class="line">                    System.out.println(fs.get());     <span class="comment">//打印各个线程（任务）执行的结果  </span></div><div class="line">                &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;   </div><div class="line">                    e.printStackTrace();   </div><div class="line">                &#125;<span class="keyword">catch</span>(ExecutionException e)&#123;   </div><div class="line">                    e.printStackTrace();   </div><div class="line">                &#125; </div><div class="line">        &#125;   </div><div class="line">    &#125;   </div><div class="line">&#125;   </div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskWithResult</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">String</span>&gt;</span>&#123;   </div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;   </div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TaskWithResult</span><span class="params">(<span class="keyword">int</span> id)</span></span>&#123;   </div><div class="line">        <span class="keyword">this</span>.id = id;   </div><div class="line">    &#125;   </div><div class="line"></div><div class="line">    <span class="comment">/**  </span></div><div class="line">     * 任务的具体过程，一旦任务传给ExecutorService的submit方法， </div><div class="line">     * 则该方法自动在一个线程上执行 </div><div class="line">     */   </div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;  </div><div class="line">        System.out.println(<span class="string">"call()方法被自动调用！！！    "</span> + Thread.currentThread().getName());   </div><div class="line">        <span class="comment">//该返回结果将被Future的get方法得到  </span></div><div class="line">        <span class="keyword">return</span> <span class="string">"call()方法被自动调用，任务返回的结果是："</span> + id + <span class="string">"    "</span> + Thread.currentThread().getName();   </div><div class="line">    &#125;   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果Future的返回尚未完成，则get()方法会阻塞等待，直到Future完成返回，可以通过调用 isDone()方法判断 Future 是否完成了返回</p>
<h1 id="伪共享"><a href="#伪共享" class="headerlink" title="伪共享"></a>伪共享</h1><blockquote>
<p>参考文档：<a href="http://tech.meituan.com/disruptor.html" title="高性能队列——Disruptor" target="_blank" rel="external">高性能队列——Disruptor</a></p>
</blockquote>
<h2 id="CPU缓存行"><a href="#CPU缓存行" class="headerlink" title="CPU缓存行"></a>CPU缓存行</h2><p>Cache是由很多个cache line组成的。每个cache line通常是64字节，并且它有效地引用主内存中的一块儿地址。<br>CPU每次从主存中拉取数据时，会把相邻的数据也存入同一个cache line。</p>
<p>一个Java的long类型变量是8字节，因此在一个缓存行中可以存8个long类型的变量。<br>在访问一个long数组的时候，如果数组中的一个值被加载到缓存中，它会自动加载另外7个。因此可以非常快的遍历这个数组。<br>事实上，你可以非常快速的遍历在连续内存块中分配的任意数据结构。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 测试利用cache line的特性和不利用cache line的特性的效果对比</span></div><div class="line"><span class="keyword">package</span> com.meituan.FalseSharing;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> gongming</div><div class="line"> * <span class="doctag">@description</span></div><div class="line"> * <span class="doctag">@date</span> 16/6/4</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheLineEffect</span> </span>&#123;</div><div class="line">    <span class="comment">//考虑一般缓存行大小是64字节，一个 long 类型占8字节</span></div><div class="line">    <span class="keyword">static</span>  <span class="keyword">long</span>[][] arr;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        arr = <span class="keyword">new</span> <span class="keyword">long</span>[<span class="number">1024</span> * <span class="number">1024</span>][];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1024</span> * <span class="number">1024</span>; i++) &#123;</div><div class="line">            arr[i] = <span class="keyword">new</span> <span class="keyword">long</span>[<span class="number">8</span>];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) &#123;</div><div class="line">                arr[i][j] = <span class="number">0L</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">long</span> sum = <span class="number">0L</span>;</div><div class="line">        <span class="keyword">long</span> marked = System.currentTimeMillis();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1024</span> * <span class="number">1024</span>; i+=<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j =<span class="number">0</span>; j&lt; <span class="number">8</span>;j++)&#123;</div><div class="line">                sum = arr[i][j];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        System.out.println(<span class="string">"Loop times:"</span> + (System.currentTimeMillis() - marked) + <span class="string">"ms"</span>);</div><div class="line"></div><div class="line">        marked = System.currentTimeMillis();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i+=<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j =<span class="number">0</span>; j&lt; <span class="number">1024</span> * <span class="number">1024</span>;j++)&#123;</div><div class="line">                sum = arr[j][i];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        System.out.println(<span class="string">"Loop times:"</span> + (System.currentTimeMillis() - marked) + <span class="string">"ms"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>在2G Hz、2核、8G内存的运行环境中测试，速度差一倍。<br>结果：<br>Loop times:30ms<br>Loop times:65ms</p>
</blockquote>
<h2 id="什么是伪共享"><a href="#什么是伪共享" class="headerlink" title="什么是伪共享"></a>什么是伪共享</h2><p>ArrayBlockingQueue有三个成员变量：</p>
<ul>
<li>takeIndex：需要被取走的元素下标</li>
<li>putIndex：可被元素插入的位置的下标</li>
<li>count：队列中元素的数量</li>
</ul>
<p>这三个变量很容易放到一个缓存行中，但是之间修改没有太多的关联。所以每次修改，都会使之前缓存的数据失效，从而不能完全达到共享的效果。</p>

<p>如上图所示，当生产者线程put一个元素到ArrayBlockingQueue时，putIndex会修改，从而导致消费者线程的缓存中的缓存行无效，需要从主存中重新读取。</p>
<p>这种无法充分使用缓存行特性的现象，称为伪共享。</p>
<p>对于伪共享，一般的解决方案是，增大数组元素的间隔使得由不同线程存取的元素位于不同的缓存行上，以空间换时间。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.meituan.FalseSharing;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FalseSharing</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> ITERATIONS = <span class="number">500L</span> * <span class="number">1000L</span> * <span class="number">100L</span>;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> arrayIndex = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> ValuePadding[] longs;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FalseSharing</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> arrayIndex)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.arrayIndex = arrayIndex;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;<span class="number">10</span>;i++)&#123;</div><div class="line">                System.gc();</div><div class="line">                <span class="keyword">final</span> <span class="keyword">long</span> start = System.currentTimeMillis();</div><div class="line">                runTest(i);</div><div class="line">                System.out.println(<span class="string">"Thread num "</span>+i+<span class="string">" duration = "</span> + (System.currentTimeMillis() - start));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runTest</span><span class="params">(<span class="keyword">int</span> NUM_THREADS)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">            Thread[] threads = <span class="keyword">new</span> Thread[NUM_THREADS];</div><div class="line">            longs = <span class="keyword">new</span> ValuePadding[NUM_THREADS];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; longs.length; i++) &#123;</div><div class="line">                longs[i] = <span class="keyword">new</span> ValuePadding();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; threads.length; i++) &#123;</div><div class="line">                threads[i] = <span class="keyword">new</span> Thread(<span class="keyword">new</span> FalseSharing(i));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (Thread t : threads) &#123;</div><div class="line">                t.start();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (Thread t : threads) &#123;</div><div class="line">                t.join();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">long</span> i = ITERATIONS + <span class="number">1</span>;</div><div class="line">            <span class="keyword">while</span> (<span class="number">0</span> != --i) &#123;</div><div class="line">                longs[arrayIndex].value = <span class="number">0L</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ValuePadding</span> </span>&#123;</div><div class="line">            <span class="keyword">protected</span> <span class="keyword">long</span> p1, p2, p3, p4, p5, p6, p7;</div><div class="line">            <span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="keyword">long</span> value = <span class="number">0L</span>;</div><div class="line">            <span class="keyword">protected</span> <span class="keyword">long</span> p9, p10, p11, p12, p13, p14;</div><div class="line">            <span class="keyword">protected</span> <span class="keyword">long</span> p15;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ValueNoPadding</span> </span>&#123;</div><div class="line">            <span class="comment">// protected long p1, p2, p3, p4, p5, p6, p7;</span></div><div class="line">            <span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="keyword">long</span> value = <span class="number">0L</span>;</div><div class="line">            <span class="comment">// protected long p9, p10, p11, p12, p13, p14, p15;</span></div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在2G Hz，2核，8G内存, jdk 1.7.0_45 的运行环境下，使用了共享机制比没有使用共享机制，速度快了4倍左右。</p>
<p>结果：<br>Thread num 1 duration = 447<br>Thread num 2 duration = 463<br>Thread num 3 duration = 454<br>Thread num 4 duration = 464<br>Thread num 5 duration = 561<br>Thread num 6 duration = 606<br>Thread num 7 duration = 684<br>Thread num 8 duration = 870<br>Thread num 9 duration = 823</p>
<p>把代码中ValuePadding都替换为ValueNoPadding后的结果：<br>Thread num 1 duration = 446<br>Thread num 2 duration = 2549<br>Thread num 3 duration = 2898<br>Thread num 4 duration = 3931<br>Thread num 5 duration = 4716<br>Thread num 6 duration = 5424<br>Thread num 7 duration = 4868<br>Thread num 8 duration = 4595<br>Thread num 9 duration = 4540</p>
<p>备注：在jdk1.8中，有专门的注解@Contended来避免伪共享，更优雅地解决问题。</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[SoftwareEngineering]]></title>
      <url>http://xiaozhuang.github.io/2017/01/15/SoftwareEngineering/</url>
      <content type="html"><![CDATA[<p>软件开发基本原则<br><a id="more"></a></p>
<p>软件工程中复制粘贴的危险————给一个做了更新和修正，却忘了另一个。</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java Core]]></title>
      <url>http://xiaozhuang.github.io/2017/01/12/java-core/</url>
      <content type="html"><![CDATA[<p>Java 核心技术学习笔记<br><a id="more"></a></p>
<h1 id="流和文件"><a href="#流和文件" class="headerlink" title="流和文件"></a>流和文件</h1><h2 id="Scanner"><a href="#Scanner" class="headerlink" title="Scanner"></a>Scanner</h2><p><code>jdk5.0</code><br>可使用正则表达式来解析基本类型和字符串的简单文本扫描器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Scanner scanner = <span class="keyword">null</span>;</div><div class="line"><span class="comment">//scanner = new Scanner(System.in);</span></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">	scanner = <span class="keyword">new</span> Scanner(<span class="keyword">new</span> File(<span class="string">"data.dat"</span>));</div><div class="line">&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</div><div class="line">	e.printStackTrace();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//按行读取内容</span></div><div class="line"><span class="keyword">while</span>(scanner.hasNextLine())&#123;</div><div class="line">	String nextLine = scanner.nextLine();</div><div class="line">	<span class="keyword">if</span>(<span class="string">"exit"</span>.equals(nextLine))&#123;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">	System.out.println(nextLine);</div><div class="line">&#125;</div><div class="line">scanner.close();</div></pre></td></tr></table></figure>
<h2 id="DataInputStream和DataOutputStream"><a href="#DataInputStream和DataOutputStream" class="headerlink" title="DataInputStream和DataOutputStream"></a>DataInputStream和DataOutputStream</h2><p>以二进制格式读写所有的基本java类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> num = <span class="number">1</span>;</div><div class="line"><span class="keyword">try</span> (FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(<span class="string">"employee.dat"</span>);DataOutputStream dataOutputStream = <span class="keyword">new</span> DataOutputStream(fileOutputStream))&#123;</div><div class="line">	dataOutputStream.writeInt(num);</div><div class="line">&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</div><div class="line">	e.printStackTrace();</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e1) &#123;</div><div class="line">	e1.printStackTrace();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="文件路径"><a href="#文件路径" class="headerlink" title="文件路径"></a>文件路径</h2><p>java.io中的类都将相对路径名解释为以<code>用户工作目录</code>开始，即VM启动时所设置的工作目录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 获取用户工作目录</span></div><div class="line">System.getProperty(<span class="string">"user.dir"</span>)</div><div class="line"><span class="comment">// C:\Users\登录用户~1\AppData\Local\Temp\</span></div><div class="line">System.getProperty(<span class="string">"java.io.tmpdir"</span>)</div><div class="line"><span class="comment">// 获取运行平台文件分隔符</span></div><div class="line">File.separator</div><div class="line"><span class="comment">// 获取运行平台行结束符</span></div><div class="line">System.getProperty(<span class="string">"line.separator"</span>)</div><div class="line"></div><div class="line"><span class="comment">//create a temp file</span></div><div class="line">File temp = File.createTempFile(<span class="string">"tmpDataSave"</span>, <span class="string">".tmp"</span>);</div></pre></td></tr></table></figure>
<h2 id="字符集"><a href="#字符集" class="headerlink" title="字符集"></a>字符集</h2><p>Java SE1.4引入java.nio包用Charset类统一对字符集转换</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 获取Charset，参数为字符名字或别名</span></div><div class="line">Charset charset = Charset.forName(<span class="string">"UTF-8"</span>);</div><div class="line"><span class="comment">// 获取字符别名</span></div><div class="line">Set&lt;String&gt; aliases = charset.aliases();</div><div class="line"><span class="comment">// 获得所有可用字符集名字</span></div><div class="line">SortedMap&lt;String, Charset&gt; availableCharsets = Charset.availableCharsets();</div><div class="line"></div><div class="line"><span class="comment">//使用指定字符集，编码字符串；如果某个字符不能表示，将被转换为？</span></div><div class="line">String string = <span class="string">"sunday"</span>;</div><div class="line">ByteBuffer encode = charset.encode(string);</div><div class="line"><span class="keyword">byte</span>[] array = encode.array();</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 解码字符序列</span></div><div class="line">ByteBuffer bbuf = ByteBuffer.wrap(array);</div><div class="line">CharBuffer cbuf = charset.decode(bbuf);</div><div class="line">String string2 = cbuf.toString();</div><div class="line">System.out.println(string2);</div></pre></td></tr></table></figure>
<h2 id="随机访问文件"><a href="#随机访问文件" class="headerlink" title="随机访问文件"></a>随机访问文件</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 读入模式访问</span></div><div class="line">RandomAccessFile in = <span class="keyword">new</span> RandomAccessFile(<span class="string">"employee.dat"</span>,<span class="string">"r"</span>);</div><div class="line"><span class="comment">// 读入&amp;写出模式</span></div><div class="line">RandomAccessFile inOut = <span class="keyword">new</span> RandomAccessFile(<span class="string">"employee.dat"</span>,<span class="string">"rw"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 写入数据</span></div><div class="line">inOut.writeFloat(<span class="number">1.1f</span>);</div><div class="line"><span class="comment">// 文件指针设置为距文件开头pos个字节处</span></div><div class="line">inOut.seek(<span class="number">5</span>);</div><div class="line">inOut.writeFloat(<span class="number">1.2f</span>);</div><div class="line"></div><div class="line">inOut.seek(<span class="number">0</span>);</div><div class="line"><span class="comment">// 读出数据</span></div><div class="line"><span class="keyword">float</span> readFloat = inOut.readFloat();</div><div class="line"></div><div class="line"><span class="comment">// 文件指针位置</span></div><div class="line"><span class="keyword">long</span> filePointer = inOut.getFilePointer();</div><div class="line"></div><div class="line"><span class="comment">// 文件按字节度量的长度</span></div><div class="line"><span class="keyword">long</span> length = inOut.length();</div><div class="line"></div><div class="line">in.close();</div><div class="line">inOut.close();</div></pre></td></tr></table></figure>
<h2 id="对象流与序列化"><a href="#对象流与序列化" class="headerlink" title="对象流与序列化"></a>对象流与序列化</h2><h2 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h2><h1 id="Java的基本程序设计结构"><a href="#Java的基本程序设计结构" class="headerlink" title="Java的基本程序设计结构"></a>Java的基本程序设计结构</h1><h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><p>每个用双引号括起来的字符串都是String类的一个实例。</p>
<h3 id="子串"><a href="#子串" class="headerlink" title="子串"></a>子串</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String greeting = <span class="string">"Hello"</span>;</div><div class="line">String s = greeting.substring(<span class="number">0</span>,<span class="number">3</span>);</div></pre></td></tr></table></figure>
<p>第二个参数是<code>不想复制</code>的第一个位置</p>
<h3 id="不可变字符串"><a href="#不可变字符串" class="headerlink" title="不可变字符串"></a>不可变字符串</h3><p>String 类没有提供用于<code>修改</code>字符串的方法。<br>String 类对象为不可变字符串。</p>
<p>不可变字符串有一个优点：编译器可以让字符串<code>共享</code></p>
<h3 id="检测字符串是否相等"><a href="#检测字符串是否相等" class="headerlink" title="检测字符串是否相等"></a>检测字符串是否相等</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">s.equals(t)</div><div class="line"><span class="comment">// 检测字符串相等，不区分大小写</span></div><div class="line"><span class="string">"Hello"</span>.equalIgnoreCase(<span class="string">"hello"</span>)</div></pre></td></tr></table></figure>
<p>千万不要使用 == 运算符测试字符串的相等性<br>只有字符串<code>常量</code>是共享的，而 + 和 substring 等操作产生的结果并不是共享的。</p>
<h3 id="构建字符串"><a href="#构建字符串" class="headerlink" title="构建字符串"></a>构建字符串</h3><p>由较短的字符串构建字符串。<br>每次连接字符串，都会构建一个新的String对象，<br>既耗时，又浪费空间。</p>
<p>字符串构建器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">StringBuilder builder = <span class="keyword">new</span> StringBuilder();</div><div class="line"></div><div class="line">builder.append(<span class="string">"ch"</span>);</div><div class="line">builder.append(<span class="string">"str"</span>)</div><div class="line"></div><div class="line">String completedString = builder.toString();</div></pre></td></tr></table></figure>
<h1 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h1><h2 id="枚举类"><a href="#枚举类" class="headerlink" title="枚举类"></a>枚举类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> WeekDays &#123;</div><div class="line">    MONDAY, TUESDAY, WEDNESDAY, THURSDAY, FRIDAY, SATURDAY, SUNDAY;</div><div class="line"></div><div class="line">    <span class="comment">//字符串转枚举</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WeekDays <span class="title">getEnum</span><span class="params">(String str)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> != str &amp;&amp; !<span class="string">""</span>.equals(str))&#123;</div><div class="line">            <span class="keyword">for</span> (WeekDays enumItem : WeekDays.values()) &#123;</div><div class="line">                <span class="keyword">if</span> (enumItem.name().equalsIgnoreCase(str))</div><div class="line">                    <span class="keyword">return</span> enumItem;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> List&lt;Map&lt;String,Integer&gt;&gt; transferToListMap()&#123;</div><div class="line">        ArrayList&lt;Map&lt;String, Integer&gt;&gt; days = <span class="keyword">new</span> ArrayList&lt;Map&lt;String, Integer&gt;&gt;();</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (WeekDays enumItem : WeekDays.values()) &#123;</div><div class="line">            HashMap&lt;String, Integer&gt; day = <span class="keyword">new</span> HashMap&lt;String,Integer&gt;();</div><div class="line">            day.put(enumItem.name(), enumItem.ordinal());</div><div class="line">            </div><div class="line">            days.add(day);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> days;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Integer&gt; <span class="title">transferToMap</span><span class="params">()</span></span>&#123;</div><div class="line">        Map&lt;String, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;();</div><div class="line">        <span class="keyword">for</span>(WeekDays enumItem : WeekDays.values())&#123;</div><div class="line">            map.put(enumItem.name(), enumItem.ordinal());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> map;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;Integer,String&gt; <span class="title">transferToReverseMap</span><span class="params">()</span></span>&#123;</div><div class="line">        Map&lt;Integer,String&gt; map = <span class="keyword">new</span> HashMap&lt;Integer,String&gt;();</div><div class="line">        <span class="keyword">for</span>(WeekDays enumItem : WeekDays.values())&#123;</div><div class="line">            map.put(enumItem.ordinal(),enumItem.name());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> map;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeekDaysList</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="comment">//int -&gt; enum</span></div><div class="line">        WeekDays int2enum = WeekDays.values()[<span class="number">0</span>];</div><div class="line">        <span class="comment">//String -&gt; enum</span></div><div class="line">        WeekDays string2enum1 = WeekDays.valueOf(<span class="string">"MONDAY"</span>);</div><div class="line">        WeekDays string2enum2 = Enum.valueOf(WeekDays.class, <span class="string">"MONDAY"</span>);</div><div class="line">        <span class="comment">//enum -&gt; String</span></div><div class="line">        System.out.println(WeekDays.MONDAY.name());</div><div class="line">        <span class="comment">//enum -&gt; int:ordinal()获取当前枚举常量的位置</span></div><div class="line">        System.out.println(WeekDays.MONDAY.ordinal());</div><div class="line">        </div><div class="line">        <span class="comment">//按位置比较</span></div><div class="line">        System.out.println(WeekDays.MONDAY.compareTo(WeekDays.WEDNESDAY));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>该声明定义了一个类，它有7个实例常量。<br>比较两个枚举类型不需要调用equals，使用“==”就可以</p>
</blockquote>
<p>枚举类型可以添加构造器、方法和域。<br>构造器只在<code>构造枚举常量</code>时被调用。</p>
<h2 id="枚举中添加属性和方法"><a href="#枚举中添加属性和方法" class="headerlink" title="枚举中添加属性和方法"></a>枚举中添加属性和方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> Apple &#123;</div><div class="line"></div><div class="line">    AURORA(<span class="number">10</span>), BELMAC(<span class="number">12</span>), CORTLAND(<span class="number">15</span>), EMPIRE(<span class="number">8</span>), GRAVENSTEIN(<span class="number">11</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> price;</div><div class="line">    </div><div class="line">    Apple(<span class="keyword">int</span> price) &#123;</div><div class="line">        <span class="keyword">this</span>.price = price;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> price;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="枚举实例实现抽象方法"><a href="#枚举实例实现抽象方法" class="headerlink" title="枚举实例实现抽象方法"></a>枚举实例实现抽象方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 英镑换算枚举</span></div><div class="line"><span class="keyword">enum</span> Converter &#123;</div><div class="line">    KG(<span class="string">"KG"</span>) &#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">double</span> <span class="title">performConversion</span><span class="params">(<span class="keyword">double</span> f)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> f *= <span class="number">0.45359237</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">//克拉</span></div><div class="line">    CARAT(<span class="string">"carat"</span>) &#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">double</span> <span class="title">performConversion</span><span class="params">(<span class="keyword">double</span> f)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> f *= <span class="number">2267.96185</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    <span class="comment">//符号</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String symbol;</div><div class="line"></div><div class="line">    Converter(String symbol) &#123;</div><div class="line">        <span class="keyword">this</span>.symbol = symbol;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> symbol;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">double</span> <span class="title">performConversion</span><span class="params">(<span class="keyword">double</span> f)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h2><p>能够分析类能力的程序称为反射。</p>
<h3 id="Class类"><a href="#Class类" class="headerlink" title="Class类"></a>Class类</h3><p>java运行时加载类到内存中时，会创建<code>Class类实例</code>来代表加载的类或接口。</p>
<p>获取Class实例<code>方式1</code>，Object类中的getClass()方法返回一个Class类型实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Employee e;</div><div class="line"><span class="comment">//...</span></div><div class="line">Class cl = e.getClass();</div></pre></td></tr></table></figure>
<p>获取Class实例<code>方式2</code>，调用静态方法forName获得类名对应的Class对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Class&lt;?&gt; forName = Class.forName(<span class="string">"java.util.Date"</span>);</div><div class="line">System.out.println(forName.getName());</div></pre></td></tr></table></figure>
<blockquote>
<p>java.util.Date</p>
</blockquote>
<p>获取Class实例<code>方式3</code>，T为任意java类型，T.class代表匹配的类对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Class cl1 = Date.class;</div><div class="line">Class cl2 = <span class="keyword">int</span>.class;</div><div class="line">Class cl3 = Double[].class;</div></pre></td></tr></table></figure>
<p>创建对象实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Class&lt;?&gt; forName = Class.forName(<span class="string">"com.foo.reflect_learn.StrategyImpl"</span>);</div><div class="line"><span class="comment">// 默认构造函数创建对象</span></div><div class="line"><span class="comment">// Object newInstance = forName.newInstance();</span></div><div class="line"></div><div class="line"><span class="comment">// 获得指定参数的Constructor并创建对象</span></div><div class="line">Constructor&lt;?&gt; argsConstructor = forName.getDeclaredConstructor(String.class);</div><div class="line">Object newInstance = declaredConstructor.newInstance(<span class="string">"foo"</span>);</div></pre></td></tr></table></figure>
<h3 id="利用反射分析类的能力"><a href="#利用反射分析类的能力" class="headerlink" title="利用反射分析类的能力"></a>利用反射分析类的能力</h3><p>Class类的getFields, getMethods, getConstructors分别返回<code>public</code>域、方法、构造器数组，<br>其中<code>包括</code>超类的公有成员。</p>
<p>Class类的getDeclaredFields, getDeclaredMethods, getDeclaredConstructors分别返回<code>全部</code>域、方法、构造器数组，<br>其中包括private和protected成员，但<code>不包括</code>超类的成员。</p>
<p>通过反射，获取类public域列表、构造器列表、方法列表。</p>
<h3 id="调用任意方法"><a href="#调用任意方法" class="headerlink" title="调用任意方法"></a>调用任意方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Class&lt;?&gt; forName = Class.forName(<span class="string">"com.foo.reflect_learn.StrategyImpl"</span>);</div><div class="line">Method method1 = forName.getMethod(<span class="string">"methond1"</span>, <span class="keyword">null</span>);</div><div class="line">Object invoke = method1.invoke(newInstance, <span class="keyword">null</span>);</div></pre></td></tr></table></figure>
<p>这种设计风格不太简便，出错的可能性也比较大。</p>
<p>另外，invoke的参数和返回值是Object类型。<br>意味着必须进行多次类型转换，会使编译器错过代码检查机会。</p>
<p>使用反射获得方法指针的代码比直接调用方法慢。</p>
<blockquote>
<p>注：建议java开发者不要使用Method对象的回调功能。</p>
</blockquote>
<h3 id="运行时使用反射分析对象"><a href="#运行时使用反射分析对象" class="headerlink" title="运行时使用反射分析对象"></a>运行时使用反射分析对象</h3><p>运行时查看数据域的实际内容</p>
<p>反射访问私有域：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Class&lt;?&gt; strategy = Class.forName(<span class="string">"com.sunday.jdk6_learn.reflect_learn.StrategyImpl"</span>);</div><div class="line">            </div><div class="line">Object newInstance = strategy.newInstance();</div><div class="line"></div><div class="line"><span class="keyword">if</span>(newInstance <span class="keyword">instanceof</span> Strategy)&#123;</div><div class="line">    <span class="comment">//获取私有属性</span></div><div class="line">    Field infoField = strategy.getDeclaredField(<span class="string">"info"</span>);</div><div class="line">    <span class="comment">//闭安全检查</span></div><div class="line">    <span class="comment">//setAccessible()是AccessibleObject类中方法，它是Field、Method和Constructor类的超类。</span></div><div class="line">    infoField.setAccessible(<span class="keyword">true</span>);</div><div class="line">    </div><div class="line">    <span class="comment">//读取私有属性</span></div><div class="line">    Object object = infoField.get(newInstance);</div><div class="line">    System.out.println(object);</div><div class="line">    <span class="comment">//设置私有属性</span></div><div class="line">    infoField.set(newInstance, <span class="string">"foo"</span>);</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="泛型程序设计"><a href="#泛型程序设计" class="headerlink" title="泛型程序设计"></a>泛型程序设计</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 泛型方法</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; List&lt;T&gt; <span class="title">getRecords</span><span class="params">(Class&lt;T&gt; c, Selector s)</span> </span>&#123;</div><div class="line">     <span class="comment">// Use Selector to select rows </span></div><div class="line">     List&lt;T&gt; list = <span class="keyword">new</span> ArrayList&lt;T&gt;();</div><div class="line">     <span class="keyword">for</span> (<span class="comment">/* iterate over results */</span>) &#123;</div><div class="line">         T row = c.newInstance(); <span class="comment">// use reflection to set fields from result </span></div><div class="line">         list.add(row); </div><div class="line">      &#125; </div><div class="line">      <span class="keyword">return</span> list; </div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// org.springframework.core.env.PropertySourcesPropertyResolver#getProperty(java.lang.String, java.lang.Class&lt;T&gt;)</span></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProperty</span><span class="params">(String key, Class&lt;T&gt; targetValueType)</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> debugEnabled = logger.isDebugEnabled();</div><div class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</div><div class="line">        logger.trace(format(<span class="string">"getProperty(\"%s\", %s)"</span>, key, targetValueType.getSimpleName()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (PropertySource&lt;?&gt; propertySource : <span class="keyword">this</span>.propertySources) &#123;</div><div class="line">        <span class="keyword">if</span> (debugEnabled) &#123;</div><div class="line">            logger.debug(format(<span class="string">"Searching for key '%s' in [%s]"</span>, key, propertySource.getName()));</div><div class="line">        &#125;</div><div class="line">        Object value;</div><div class="line">        <span class="keyword">if</span> ((value = propertySource.getProperty(key)) != <span class="keyword">null</span>) &#123;</div><div class="line">            Class&lt;?&gt; valueType = value.getClass();</div><div class="line">            <span class="keyword">if</span> (debugEnabled) &#123;</div><div class="line">                logger.debug(</div><div class="line">                        format(<span class="string">"Found key '%s' in [%s] with type [%s] and value '%s'"</span>,</div><div class="line">                                key, propertySource.getName(), valueType.getSimpleName(), value));</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.conversionService.canConvert(valueType, targetValueType)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                        format(<span class="string">"Cannot convert value [%s] from source type [%s] to target type [%s]"</span>,</div><div class="line">                                value, valueType.getSimpleName(), targetValueType.getSimpleName()));</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> conversionService.convert(value, targetValueType);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (debugEnabled) &#123;</div><div class="line">        logger.debug(format(<span class="string">"Could not find key '%s' in any property source. Returning [null]"</span>, key));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[HTML]]></title>
      <url>http://xiaozhuang.github.io/2017/01/07/html/</url>
      <content type="html"><![CDATA[<p>HTML 笔记<br><a id="more"></a></p>
<h1 id="meta"><a href="#meta" class="headerlink" title="meta"></a>meta</h1><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--  intial-scale:页面首次被显示是可视区域的缩放级别，取值1.0则页面按实际尺寸显示，无任何缩放 --&gt;</span></div><div class="line"><span class="comment">&lt;!--  user-scalable:是否可对页面进行缩放，no 禁止缩放 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"initial-scale=1.0, user-scalable=no"</span> /&gt;</span></div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java 8]]></title>
      <url>http://xiaozhuang.github.io/2017/01/03/java8/</url>
      <content type="html"><![CDATA[<p>“编程语言的某个新特性还会时不时地让我感到兴奋，因为它让我花更少的时间就能够写出更清晰、更简洁的代码。”<br>————JAVA8实战<br><a id="more"></a></p>
<h1 id="方法和Lambda作为一等公民"><a href="#方法和Lambda作为一等公民" class="headerlink" title="方法和Lambda作为一等公民"></a>方法和Lambda作为一等公民</h1><p>java8的第一个新功能是方法引用。</p>
<p>方法传递的形参是接口，实参是方法或Lambda</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterApples</span><span class="params">(List&lt;Apple&gt; inventory, Predicate&lt;Apple&gt; p)</span></span>&#123;</div><div class="line">	List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">	<span class="keyword">for</span>(Apple apple : inventory)&#123;</div><div class="line">		<span class="keyword">if</span>(p.test(apple))&#123;</div><div class="line">			result.add(apple);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isHeavyApple</span><span class="params">(Apple p)</span></span>&#123;</div><div class="line">	<span class="keyword">return</span> p.getWeight() &gt; <span class="number">150</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//库存</span></div><div class="line">List&lt;Apple&gt; inventory = Arrays.asList(<span class="keyword">new</span> Apple(<span class="number">80</span>,<span class="string">"green"</span>),</div><div class="line">        <span class="keyword">new</span> Apple(<span class="number">155</span>, <span class="string">"green"</span>),</div><div class="line">        <span class="keyword">new</span> Apple(<span class="number">120</span>, <span class="string">"red"</span>));</div><div class="line"></div><div class="line"></div><div class="line">List&lt;Apple&gt; filterApples = filterApples(inventory,(Apple a) -&gt; <span class="string">"green"</span>.equals(a.getColor()));</div><div class="line">System.out.println(filterApples);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 方法引用::语法</span></div><div class="line">List&lt;Apple&gt; filterApples2 = filterApples(inventory,App::isHeavyApple);</div><div class="line">System.out.println(filterApples2);</div></pre></td></tr></table></figure>
<h1 id="流"><a href="#流" class="headerlink" title="流"></a>流</h1><p>java8用Stream API解决两个问题；</p>
<ul>
<li>集合处理时的套路和晦涩</li>
<li>难以利用多核</li>
</ul>
<p>Collection主要为了存储和访问数据，Stream主要用于描述对数据的计算。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//库存</span></div><div class="line">List&lt;Apple&gt; inventory = Arrays.asList(<span class="keyword">new</span> Apple(<span class="number">80</span>,<span class="string">"green"</span>),</div><div class="line">        <span class="keyword">new</span> Apple(<span class="number">155</span>, <span class="string">"green"</span>),</div><div class="line">        <span class="keyword">new</span> Apple(<span class="number">120</span>, <span class="string">"red"</span>));</div><div class="line"></div><div class="line">List&lt;Apple&gt; collect = inventory.stream().filter((Apple a) -&gt; a.getWeight() &gt; <span class="number">150</span>).collect(Collectors.toList());</div><div class="line"></div><div class="line">System.out.println(collect);</div></pre></td></tr></table></figure>
<p>Java中并行与无共享可变状态<br>库负责分块，即把大的流分成几个小的流，以便并行处理。<br>其次，流提供几乎免费的并行，只有传递给filter之类的库方法不会互动时才能工作。</p>
<p><code>函数式编程</code>函数的主要意思：</p>
<ul>
<li>把函数作为一等值</li>
<li>执行时在元素之间无互动</li>
</ul>
<h1 id="默认方法"><a href="#默认方法" class="headerlink" title="默认方法"></a>默认方法</h1><p>java8中，接口可以包含实现类没有提供实现的方法签名，缺失的方法主体随接口提供</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DemoInterface</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">testFun</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="comment">//TODO default implementation</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>默认方法主要为了支持库设计是，让他们能够写出<code>更容易改进</code>的接口</p>
<p>无默认方法时，给接口加入一个新方法，意味着所有的实现类都必须为其提供一个实现</p>
<h1 id="新的日期和时间API"><a href="#新的日期和时间API" class="headerlink" title="新的日期和时间API"></a>新的日期和时间API</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//LocalDate：只包含日期，比如：2016-10-20</span></div><div class="line"><span class="comment">//LocalTime：只包含时间，比如：23:12:10</span></div><div class="line">LocalDate localDate = LocalDate.of(<span class="number">2017</span>, <span class="number">7</span>, <span class="number">1</span>);</div><div class="line">LocalTime localTime = LocalTime.of(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="comment">//当前月份最后一秒</span></div><div class="line"><span class="comment">//LocalDateTime：包含日期和时间，比如：2016-10-20 23:14:21</span></div><div class="line">LocalDateTime localDateTime = LocalDateTime.of(localDate, localTime)</div><div class="line">        .plusMonths(<span class="number">1</span>)</div><div class="line">        .minusSeconds(<span class="number">1</span>);<span class="comment">//当前月第一天，后一个月，前一秒</span></div><div class="line"></div><div class="line"><span class="comment">//日期</span></div><div class="line">LocalDateTime now = LocalDateTime.now();</div><div class="line"><span class="comment">//日期格式化</span></div><div class="line">DateTimeFormatter formatter = DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</div><div class="line">String localDateTimeFormat = localDateTime.format(formatter);</div><div class="line">System.out.println(<span class="string">"LocalDateTime Date Formate: "</span> + localDateTimeFormat);</div><div class="line">String formatDateTime = now.format(formatter);</div><div class="line">System.out.println(<span class="string">"Now Date Formate: "</span> + formatDateTime);</div><div class="line"></div><div class="line"><span class="comment">//日期转时间戳</span></div><div class="line">Instant instant = localDateTime.toInstant(ZoneOffset.UTC);</div><div class="line">System.out.println(instant.getEpochSecond());</div><div class="line"></div><div class="line"><span class="comment">// String -&gt; LocalDateTime</span></div><div class="line">String dateStr = <span class="string">"2016-11-09 10:30"</span>;</div><div class="line">DateTimeFormatter dateStrFormatter = DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd HH:mm"</span>);</div><div class="line">LocalDateTime dateStrLocalDateTime = LocalDateTime.parse(dateStr, dateStrFormatter);</div><div class="line">System.out.println(<span class="string">"String -&gt; LocalDateTime: "</span> + dateStrLocalDateTime);</div></pre></td></tr></table></figure>
<h2 id="读取文件"><a href="#读取文件" class="headerlink" title="读取文件"></a>读取文件</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">StringBuilder contentBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line"><span class="keyword">try</span> (Stream&lt;String&gt; stream = Files.lines(Paths.get(filePath), StandardCharsets.UTF_8)) &#123;</div><div class="line">    stream.forEach(s -&gt; contentBuilder.append(s).append(<span class="string">"\n"</span>));</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> contentBuilder.toString();</div><div class="line"></div><div class="line"><span class="comment">//读取全部文本</span></div><div class="line">String data = <span class="keyword">new</span> String(Files.readAllBytes(Paths.get(System.getProperty(<span class="string">"user.dir"</span>) + System.getProperty(<span class="string">"line.separator"</span>) + tmpDataSave + tmpDataSaveSuffix)), StandardCharsets.UTF_8);</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Windows 7]]></title>
      <url>http://xiaozhuang.github.io/2016/12/31/windows/</url>
      <content type="html"><![CDATA[<p>windows使用方法及高效工具记录<br><a id="more"></a></p>
<h1 id="关闭休眠并删除休眠文件"><a href="#关闭休眠并删除休眠文件" class="headerlink" title="关闭休眠并删除休眠文件"></a>关闭休眠并删除休眠文件</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#cmd运行</span></div><div class="line">powercfg -h off</div></pre></td></tr></table></figure>
<h1 id="查看计划任务"><a href="#查看计划任务" class="headerlink" title="查看计划任务"></a>查看计划任务</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">taskschd.msc</div></pre></td></tr></table></figure>
<h1 id="查看端口占用"><a href="#查看端口占用" class="headerlink" title="查看端口占用"></a>查看端口占用</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">netstat -ano</div></pre></td></tr></table></figure>
<h1 id="测试端口是否可访问"><a href="#测试端口是否可访问" class="headerlink" title="测试端口是否可访问"></a>测试端口是否可访问</h1><p>windwos telnet不是内部或外部命令，控制面板 -&gt; 程序和功能 -&gt; 启用或关闭功能 -&gt; Telnet客户端</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">telnet 127.0.0.1 3306</div></pre></td></tr></table></figure>
<h1 id="查看pid"><a href="#查看pid" class="headerlink" title="查看pid"></a>查看pid</h1><p>在任务管理器中找到对应进程<br>    如果任务管理器未显示PID<br>    查看-&gt;选择列-&gt;PID,显示PID列</p>
<h1 id="host文件位置"><a href="#host文件位置" class="headerlink" title="host文件位置"></a>host文件位置</h1><p>C:\Windows\System32\drivers\etc</p>
<h1 id="win8-添加开机启动项"><a href="#win8-添加开机启动项" class="headerlink" title="win8 添加开机启动项"></a>win8 添加开机启动项</h1><p>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp</p>
<h1 id="合并文本文件"><a href="#合并文本文件" class="headerlink" title="合并文本文件"></a>合并文本文件</h1><figure class="highlight cmd"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">copy</span> *.txt  book.txt</div></pre></td></tr></table></figure>
<h2 id="Win7域账号背景锁定"><a href="#Win7域账号背景锁定" class="headerlink" title="Win7域账号背景锁定"></a>Win7域账号背景锁定</h2><p>开始搜索框中输入<code>轻松访问中心</code>,<code>使计算机更易于查看</code>,<code>删除背景图像</code></p>
<h2 id="注册表开启远程桌面"><a href="#注册表开启远程桌面" class="headerlink" title="注册表开启远程桌面"></a>注册表开启远程桌面</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 打开注册表</span></div><div class="line"><span class="comment"># regedit</span></div><div class="line"></div><div class="line"><span class="comment"># 允许远程连接</span></div><div class="line"><span class="comment"># HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server下的fDenyTSConnections，修改为0</span></div><div class="line"></div><div class="line"><span class="comment"># 修改远程连接端口号</span></div><div class="line"><span class="comment"># HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\PortNumber</span></div><div class="line"></div><div class="line"><span class="comment"># 防火墙添加允许入站规则</span></div><div class="line"></div><div class="line"><span class="comment"># 重启电脑</span></div></pre></td></tr></table></figure>
<h2 id="windows-查看局域网ip"><a href="#windows-查看局域网ip" class="headerlink" title="windows 查看局域网ip"></a>windows 查看局域网ip</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">arp -a</div></pre></td></tr></table></figure>
<h2 id="thinkpad互换FN-和-Ctrl"><a href="#thinkpad互换FN-和-Ctrl" class="headerlink" title="thinkpad互换FN 和 Ctrl"></a>thinkpad互换FN 和 Ctrl</h2><p>键盘管理器中设置</p>
<h1 id="无线联网有线共享"><a href="#无线联网有线共享" class="headerlink" title="无线联网有线共享"></a>无线联网有线共享</h1><p>netsh wlan set hostednetwork mode=allow</p>
<p>电脑通过无线联网，通过有线将网络共享给其他电脑或路由器</p>
<p>控制面板\网络和 Internet\网络连接 -&gt; 无线网络连接设置 -&gt; 共享网络给本地连接</p>
<p>修改共享网络网段：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 注册表REGEDIT </span></div><div class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\SharedAccess\Parameters.</div><div class="line"><span class="comment"># 修改</span></div><div class="line">ScopeAddress and StandaloneDHCPAddress</div></pre></td></tr></table></figure>
<h1 id="路由器当作交换机用"><a href="#路由器当作交换机用" class="headerlink" title="路由器当作交换机用"></a>路由器当作交换机用</h1><p>前端路由器—-LAN口—-路由器—-LAN口—-计算机</p>
<ul>
<li>打开路由器的设置界面，把无线路由器的DHCP 服务关掉</li>
<li>LAN口设置前端路由分配给路由器的IP地址</li>
<li>不使用路由器上的WAN口，将前端路由器的网线接入路由器的LAN口，电脑也接入LAN口</li>
</ul>
<h1 id="Navicat-执行选中"><a href="#Navicat-执行选中" class="headerlink" title="Navicat 执行选中"></a>Navicat 执行选中</h1><p>Ctrl + Shift + R</p>
<h1 id="虚拟机启动报错"><a href="#虚拟机启动报错" class="headerlink" title="虚拟机启动报错"></a>虚拟机启动报错</h1><p>Intel VT-x 处于禁用状态</p>
<ul>
<li>进入BIOS</li>
<li>advanced选项卡，选择CPU setup</li>
<li>选择选择Intel Virtualization Technology</li>
</ul>
<h1 id="删除过期文件"><a href="#删除过期文件" class="headerlink" title="删除过期文件"></a>删除过期文件</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">forfiles /p <span class="string">"d:\tmp"</span> /s /m *.* /D -&lt;number of days&gt; /C <span class="string">"cmd /c del @path"</span></div></pre></td></tr></table></figure>
<h1 id="端口映射"><a href="#端口映射" class="headerlink" title="端口映射"></a>端口映射</h1><p>任何到<code>本地</code>端口的TCP连接都能够被转发到任意一个<code>本地</code>端口，或远程主机的某个端口</p>
<p>添加一个IPV4到IPV4的端口映射<br>netsh interface portproxy add v4tov4 listenaddress=127.0.0.1 listenport=3306 connectaddress=192.168.101.53 connectport=3306</p>
<p>指定监听ip和端口可以删除<br>netsh interface portproxy delete v4tov4 listenaddress=127.0.0.1 listenport=3306</p>
<p>查看转发了哪些端口<br>netsh interface portproxy show all</p>
<h1 id="添加路由"><a href="#添加路由" class="headerlink" title="添加路由"></a>添加路由</h1><p>打印所有route<br>route print</p>
<p>route add 192.168.101.53 MASK 255.255.255.255  127.0.0.1<br>route delete 192.168.101.53</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Windows </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java EE Servlet]]></title>
      <url>http://xiaozhuang.github.io/2016/12/25/javaee-servlet/</url>
      <content type="html"><![CDATA[<p>Java EE（Java Platform，Enterprise Edition）是sun公司推出的企业级应用程序版本。<br><a id="more"></a></p>
<h1 id="获取服务器访问根路径"><a href="#获取服务器访问根路径" class="headerlink" title="获取服务器访问根路径"></a>获取服务器访问根路径</h1><figure class="highlight jsp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;%</div><div class="line">request.setAttribute(<span class="string">"contextPath"</span>, request.getContextPath());</div><div class="line">request.setAttribute(<span class="string">"serverPath"</span>, request.getScheme() + <span class="string">"://"</span> + request.getServerName() + <span class="string">":"</span> + request.getServerPort() + request.getContextPath());</div><div class="line">%&gt;</div></pre></td></tr></table></figure>
<h1 id="Servlet-Request-amp-Reponse-编码"><a href="#Servlet-Request-amp-Reponse-编码" class="headerlink" title="Servlet Request&amp;Reponse 编码"></a>Servlet Request&amp;Reponse 编码</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">request.setCharacterEncoding(<span class="string">"UTF-8"</span>);</div><div class="line">response.setCharacterEncoding(<span class="string">"UTF-8"</span>);</div></pre></td></tr></table></figure>
<h1 id="获取请求中全部参数"><a href="#获取请求中全部参数" class="headerlink" title="获取请求中全部参数"></a>获取请求中全部参数</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Enumeration&lt;String&gt; enu = request.getParameterNames();  </div><div class="line"><span class="keyword">while</span>(enu.hasMoreElements())&#123;  </div><div class="line">	String paraName=enu.nextElement();  </div><div class="line">	System.out.println(paraName+<span class="string">": "</span>+request.getParameter(paraName));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="获取请求信息"><a href="#获取请求信息" class="headerlink" title="获取请求信息"></a>获取请求信息</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 请求协议http 或 https</span></div><div class="line">request.getScheme()</div><div class="line"><span class="comment">//获取端口号</span></div><div class="line">request.getServerPort()</div><div class="line"><span class="comment">//获取ContextPath</span></div><div class="line">request.getContextPath()</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Eclipse]]></title>
      <url>http://xiaozhuang.github.io/2016/12/25/eclipse/</url>
      <content type="html"><![CDATA[<p>eclipse 笔记<br><a id="more"></a></p>
<h1 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h1><p>F5    进入方法<br>F6    单步执行<br>F7    执行完方法，返回调用此方法的后一条语句<br>F8    继续执行，到下一个断点或程序结束</p>
<p>Ctrl + Shift + B    添加或移除断点</p>
<p>ctrl+shift+x   转为大写<br>ctrl+shift+y   转为小写</p>
<p>Alt+Shift+M   提取方法</p>
<h1 id="字体大小"><a href="#字体大小" class="headerlink" title="字体大小"></a>字体大小</h1><p>五号　　10.5</p>
<h1 id="删除多于工作空间"><a href="#删除多于工作空间" class="headerlink" title="删除多于工作空间"></a>删除多于工作空间</h1><p>configuration.settings\org.eclipse.ui.ide.prefs</p>
<h1 id="使用4个空格代替Tab"><a href="#使用4个空格代替Tab" class="headerlink" title="使用4个空格代替Tab"></a>使用4个空格代替Tab</h1><p>文件里面有制表符，通常是使用TAB键缩进造成的。<br>代码中缩进不推荐使用制表符，建议将制表符替换为4个空格</p>
<p>eclipse 设置方式<br>window-&gt;Preferences-&gt;java-&gt;Code Style-&gt;Formatter</p>
<p>点击New…创建自定义格式化策略，基于默认的格式化策略修改</p>
<p>点击Edit<br>    1.在Indentation选项卡中<br>    2.General settings-&gt;下拉选择Spaces only<br>    3.实现按“Tab”时使用4个空格代替</p>
<p>isissue:<br>因为前段引起页面错乱<br>百思，发现是tab问题,js将页面上tab替换为4个nbsp</p>
<h1 id="删除多余工作空间"><a href="#删除多余工作空间" class="headerlink" title="删除多余工作空间"></a>删除多余工作空间</h1><p>打开eclipse的根目录 依次进入 configuration &gt;&gt; .settings<br>用notepad++打开 org.eclipse.ui.ide.prefs<br>找到你需要删除的  包括前面的“\n”一起删除</p>
<h1 id="Eclipse-To-String-Template"><a href="#Eclipse-To-String-Template" class="headerlink" title="Eclipse To String Template"></a>Eclipse To String Template</h1><p>Json Template</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;$&#123;member.name&#125;&quot;:&quot;$&#123;member.value&#125;&quot;,&quot;$&#123;otherMembers&#125;&quot;&#125;</div></pre></td></tr></table></figure>
<h1 id="全部替换"><a href="#全部替换" class="headerlink" title="全部替换"></a>全部替换</h1><p>Search→Text→Project，这样就会在整个项目中查找单词。<br>然后在Search的Console中，单击项目，右键选择Replace All</p>
<h1 id="将常用外部jar作为用户库"><a href="#将常用外部jar作为用户库" class="headerlink" title="将常用外部jar作为用户库"></a>将常用外部jar作为用户库</h1><p>1.window-&gt;Preferences-&gt;java-&gt;Build Path-&gt;User Libraries<br>    Add External Jars</p>
<p>2.使用User Libraries<br>    项目-&gt;properties-&gt;java Build Path-&gt;Libraries-&gt;Add Library-&gt;User Library</p>
<h1 id="eclipse运行java配置"><a href="#eclipse运行java配置" class="headerlink" title="eclipse运行java配置"></a>eclipse运行java配置</h1><p>-vm should be before -vmargs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-vm</div><div class="line">D:\Program Files\Java\jdk1.8.0_131\bin</div></pre></td></tr></table></figure>
<h1 id="plugins"><a href="#plugins" class="headerlink" title="plugins"></a>plugins</h1><h2 id="Velocity-Editor"><a href="#Velocity-Editor" class="headerlink" title="Velocity Editor"></a>Velocity Editor</h2><p>veloedit</p>
<h1 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-Xmx2048m -Xms2048m -Xmn512m -XX:MaxPermSize=128m</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> DeveloperTools </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Css Note]]></title>
      <url>http://xiaozhuang.github.io/2016/12/23/css-note/</url>
      <content type="html"><![CDATA[<p>层叠样式表(英文全称：Cascading Style Sheets)是一种用来表现HTML（标准通用标记语言的一个应用）或XML（标准通用标记语言的一个子集）等文件样式的计算机语言。<br><a id="more"></a></p>
<h1 id="Solutions"><a href="#Solutions" class="headerlink" title="Solutions"></a>Solutions</h1><h2 id="div全屏"><a href="#div全屏" class="headerlink" title="div全屏"></a>div全屏</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">html</span>,<span class="selector-tag">body</span>,<span class="selector-id">#container</span>&#123;</div><div class="line">	<span class="attribute">width</span>: <span class="number">100%</span>;<span class="attribute">height</span>: <span class="number">100%</span>;<span class="attribute">overflow</span>: hidden;<span class="attribute">margin</span>:<span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="圆角"><a href="#圆角" class="headerlink" title="圆角"></a>圆角</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">border-radius</span>: <span class="number">15px</span> <span class="number">5px</span>;</div><div class="line"><span class="comment">//用斜杠设置第二组值,第一组值表示水平半径，第二组值表示垂直半径</span></div><div class="line"><span class="attribute">border-radius</span>: <span class="number">15px</span> <span class="number">5px</span> <span class="number">25px</span> <span class="number">5px</span>/<span class="number">3px</span> <span class="number">5px</span> <span class="number">10px</span> <span class="number">15px</span>;</div></pre></td></tr></table></figure>
<h2 id="边框"><a href="#边框" class="headerlink" title="边框"></a>边框</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//上边框是点状,右边框是实线,下边框是双线,左边框是虚线</span></div><div class="line"><span class="attribute">border-style</span>:dotted solid double dashed;</div></pre></td></tr></table></figure>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 第一个值是水平位置，第二个值是垂直位置</span></div><div class="line"><span class="attribute">background-position</span>:center;</div><div class="line"></div><div class="line"><span class="comment">//背景图片自适应</span></div><div class="line"><span class="attribute">background-size</span>:cover;</div><div class="line"></div><div class="line"><span class="attribute">background-image</span>: url(<span class="string">"../images/sky.jpg"</span>) <span class="meta">!important</span>;</div><div class="line"><span class="attribute">background-repeat</span>: no-repeat;</div><div class="line"><span class="attribute">background-position</span>: center center;</div><div class="line"><span class="attribute">background-size</span>: cover <span class="meta">!important</span>;</div></pre></td></tr></table></figure>
<h2 id="阴影"><a href="#阴影" class="headerlink" title="阴影"></a>阴影</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 默认值none</span></div><div class="line"><span class="attribute">box-shadow</span>: <span class="number">10px</span> <span class="number">10px</span> <span class="number">5px</span> <span class="number">#888888</span>;</div></pre></td></tr></table></figure>
<h2 id="透明度"><a href="#透明度" class="headerlink" title="透明度"></a>透明度</h2><p>filter: progid:DXImageTransform.Microsoft.Alpha(Opacity=10);<br>opacity: 0.1;</p>
<h2 id="恢复默认样式"><a href="#恢复默认样式" class="headerlink" title="恢复默认样式"></a>恢复默认样式</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">initial</span> 关键字用于设置 CSS 属性为它的默认值</div><div class="line"></div><div class="line"><span class="selector-tag">h1</span> &#123;<span class="attribute">color</span>: initial; &#125;</div></pre></td></tr></table></figure>
<h2 id="超出部分显示省略号"><a href="#超出部分显示省略号" class="headerlink" title="超出部分显示省略号"></a>超出部分显示省略号</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">overflow</span>: hidden;</div><div class="line"><span class="attribute">text-overflow</span>:ellipsis;</div><div class="line"><span class="attribute">white-space</span>: nowrap;</div></pre></td></tr></table></figure>
<h2 id="人民币符号问题"><a href="#人民币符号问题" class="headerlink" title="人民币符号问题"></a>人民币符号问题</h2><p>部分手机热门民币符号显示为单横线</p>
<p>使用转义字符：&yen;</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="selector-class">.money</span>&#123;</div><div class="line">	<span class="attribute">font-family</span>: <span class="string">"Microsoft Yahei"</span>,tahoma,arial;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-class">.money</span>&#123;</div><div class="line">	<span class="attribute">font-family</span>: PingFangSC-Regular,Helvetica,<span class="string">"Droid Sans"</span>,Arial,sans-serif;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="M端输入框光标遮盖文字"><a href="#M端输入框光标遮盖文字" class="headerlink" title="M端输入框光标遮盖文字"></a>M端输入框光标遮盖文字</h2><p>暂未解决</p>
<h2 id="强制换行"><a href="#强制换行" class="headerlink" title="强制换行"></a>强制换行</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">word-break</span>: break-all;</div><div class="line"><span class="attribute">word-wrap</span>: break-word;</div></pre></td></tr></table></figure>
<h2 id="flex-布局"><a href="#flex-布局" class="headerlink" title="flex 布局"></a>flex 布局</h2><h1 id="Autoprefixer"><a href="#Autoprefixer" class="headerlink" title="Autoprefixer"></a>Autoprefixer</h1><p>直接写原生的css3即可，最后生成的仍然是兼容性代码</p>
<a href="https://github.com/postcss/autoprefixer" title="Autoprefixer官网" target="_blank" rel="external">Autoprefixer官网</a>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm install autoprefixer -g</div><div class="line">npm install gulp-postcss -g</div></pre></td></tr></table></figure>
<p>gulp配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> postcss      = <span class="built_in">require</span>(<span class="string">'gulp-postcss'</span>);</div><div class="line"><span class="keyword">var</span> autoprefixer = <span class="built_in">require</span>(<span class="string">'autoprefixer'</span>);</div><div class="line"><span class="comment">// css</span></div><div class="line">gulp.task(<span class="string">'css'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    gulp.src([</div><div class="line">            <span class="string">'css/**/*.css'</span>,</div><div class="line">            <span class="string">'!css/**/*.min.css'</span></div><div class="line">        ])</div><div class="line">        .pipe(postcss([</div><div class="line">            autoprefixer(&#123;</div><div class="line">                <span class="attr">browsers</span>:[<span class="string">'&gt; 1%'</span>, <span class="string">'last 2 versions'</span>]  <span class="comment">//主流浏览器最近2个版本用“last 2 versions”(2可以随心更改);全球统计有超过1%的使用率使用“&gt;1%”;</span></div><div class="line">            &#125;)</div><div class="line">        ]))</div><div class="line">        .pipe(wrapper(&#123;</div><div class="line">            <span class="attr">header</span>: <span class="string">'/* @update: '</span> + projectUtil.getNowDate() + <span class="string">' */ \n'</span></div><div class="line">        &#125;))</div><div class="line">        .pipe(gulp.dest(<span class="string">'build/css'</span>))</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h1 id="重置样式"><a href="#重置样式" class="headerlink" title="重置样式"></a>重置样式</h1><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">font-size</span><span class="selector-pseudo">:initial</span>;</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> CSS </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[JQuery Note]]></title>
      <url>http://xiaozhuang.github.io/2016/12/21/js-jquery-note/</url>
      <content type="html"><![CDATA[<p>jQuery is a fast, small, and feature-rich JavaScript library.<br><a id="more"></a></p>
<h1 id="查看JQuery版本"><a href="#查看JQuery版本" class="headerlink" title="查看JQuery版本"></a>查看JQuery版本</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$.fn.jquery</div></pre></td></tr></table></figure>
<h1 id="事件绑定"><a href="#事件绑定" class="headerlink" title="事件绑定"></a>事件绑定</h1><p>自 jQuery 版本 1.7 起，on() 方法是 bind()、live() 和 delegate() 方法的新的替代品。</p>
<p>移除事件处理程序，使用 off() 方法。<br>添加只运行一次的事件，使用 one() 方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">"p"</span>).on(<span class="string">"click"</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	alert(<span class="string">"The paragraph was clicked."</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h1 id="全局时间绑定与触发"><a href="#全局时间绑定与触发" class="headerlink" title="全局时间绑定与触发"></a>全局时间绑定与触发</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$(<span class="built_in">document</span>).on(<span class="string">'show.uk.slideset'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  alert(<span class="string">'show.uk.slideset trigger'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">$(<span class="built_in">document</span>).trigger(<span class="string">'show.uk.slideset'</span>);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//参数传递</span></div><div class="line">$(<span class="built_in">document</span>).on(<span class="string">'show.uk.slideset'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">event,data</span>)</span>&#123;</div><div class="line">  alert(<span class="built_in">JSON</span>.stringify(data));</div><div class="line">&#125;);</div><div class="line"></div><div class="line">$(<span class="built_in">document</span>).trigger(<span class="string">'show.uk.slideset'</span>,&#123;<span class="string">'name'</span>:<span class="string">'s'</span>&#125;);</div></pre></td></tr></table></figure>
<h1 id="选择器"><a href="#选择器" class="headerlink" title="选择器"></a>选择器</h1><h2 id="序号选择"><a href="#序号选择" class="headerlink" title="序号选择"></a>序号选择</h2><p>:eq() ,index 值从 0 开始</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 选择第二个p元素</span></div><div class="line">$(<span class="string">"p:eq(1)"</span>)</div></pre></td></tr></table></figure>
<h2 id="同辈"><a href="#同辈" class="headerlink" title="同辈"></a>同辈</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">"p"</span>).siblings(<span class="string">".selected"</span>)</div></pre></td></tr></table></figure>
<h1 id="键盘事件"><a href="#键盘事件" class="headerlink" title="键盘事件"></a>键盘事件</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$(<span class="built_in">document</span>).keydown(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>(event.which == <span class="number">13</span>)&#123;</div><div class="line">   	alert(<span class="string">'Enter Pressed'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h1 id="proxy-function-context"><a href="#proxy-function-context" class="headerlink" title="$.proxy(function, context)"></a>$.proxy(function, context)</h1><p>接受一个函数，然后返回一个新函数，并且这个新函数始终保持了特定的上下文语境</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;!-- <span class="number">1.4</span> --&gt;</div><div class="line"><span class="xml"><span class="comment">&lt;!-- context:函数的上下文语境(this)会被设置成这个 object 对象。 --&gt;</span></span></div><div class="line"></div><div class="line">$.proxy(fun, context)</div><div class="line"></div><div class="line"><span class="comment">&lt;!-- name:将要改变上下文语境的函数名(这个函数必须是前一个参数 context 对象的属性) --&gt;</span></div><div class="line">$.proxy(context, name)</div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 1.6 --&gt;</span></div><div class="line"><span class="comment">&lt;!-- additionalArguments:任何数目的参数传递给function参数的函数引用 --&gt;</span></div><div class="line">$.proxy( fun, context [, dditionalArguments])</div><div class="line"></div><div class="line">$.proxy( context, name [, additionalArguments ] )</div></pre></td></tr></table></figure>
<h1 id="选择器-1"><a href="#选择器-1" class="headerlink" title="选择器"></a>选择器</h1><h2 id="取得匹配的元素集合中每一个元素紧邻的后面同辈元素的元素集合。"><a href="#取得匹配的元素集合中每一个元素紧邻的后面同辈元素的元素集合。" class="headerlink" title="取得匹配的元素集合中每一个元素紧邻的后面同辈元素的元素集合。"></a>取得匹配的元素集合中每一个元素紧邻的后面同辈元素的元素集合。</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;!-- $.next([selector]) --&gt;</div><div class="line">$(<span class="string">'li.third-item'</span>).next().css(<span class="string">'background-color'</span>, <span class="string">'red'</span>);</div><div class="line"></div><div class="line">$(<span class="string">'li.third-item'</span>).next(<span class="string">':eq(0)'</span>).css(<span class="string">'background-color'</span>, <span class="string">'red'</span>);</div></pre></td></tr></table></figure>
<h2 id="获取匹配元素集合中第一个元素。"><a href="#获取匹配元素集合中第一个元素。" class="headerlink" title="获取匹配元素集合中第一个元素。"></a>获取匹配元素集合中第一个元素。</h2><p><code>$.first()</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>list item 1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>list item 2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>list item 3<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>list item 4<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>list item 5<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">'li'</span>).first().css(<span class="string">'background-color'</span>, <span class="string">'red'</span>);</div></pre></td></tr></table></figure>
<h2 id="获取同辈元素"><a href="#获取同辈元素" class="headerlink" title="获取同辈元素"></a>获取同辈元素</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">siblings([selector])</div></pre></td></tr></table></figure>
<h2 id="closest"><a href="#closest" class="headerlink" title="closest()"></a>closest()</h2><p>closest() 方法获得匹配选择器的第一个祖先元素，从当前元素开始沿 DOM 树向上</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$(<span class="built_in">document</span>).bind(<span class="string">"click"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"> e </span>) </span>&#123;</div><div class="line">	$(e.target).closest(<span class="string">"li"</span>).toggleClass(<span class="string">"hilight"</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h1 id="动画"><a href="#动画" class="headerlink" title="动画"></a>动画</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">'.avatarMaskWinnerClassName'</span>).fadeOut();</div><div class="line">$(<span class="string">'.avatarMaskWinnerClassName'</span>).fadeIn();</div><div class="line"></div><div class="line">$(<span class="string">"#image"</span>).stop().animate(&#123;<span class="attr">opacity</span>: <span class="number">0</span>&#125;,<span class="number">1000</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    $(<span class="keyword">this</span>).css(&#123;<span class="string">'background-image'</span>: <span class="string">"url('/images/alt_image.png')"</span>&#125;)</div><div class="line">            .animate(&#123;<span class="attr">opacity</span>: <span class="number">1</span>&#125;,&#123;<span class="attr">duration</span>:<span class="number">1000</span>&#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h1 id="样式"><a href="#样式" class="headerlink" title="样式"></a>样式</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">"div"</span>).css(<span class="string">"backgroundImage"</span>,<span class="string">"url(imgs/right.png)"</span>);</div></pre></td></tr></table></figure>
<h1 id="url参数拼接"><a href="#url参数拼接" class="headerlink" title="url参数拼接"></a>url参数拼接</h1><p>$.param()</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> urlparam = &#123;</div><div class="line">  <span class="attr">param1</span>:<span class="string">"param1"</span>,</div><div class="line">  <span class="attr">param2</span>:<span class="string">"param2"</span></div><div class="line">&#125;;</div><div class="line"><span class="built_in">console</span>.log($.param(urlparam));</div></pre></td></tr></table></figure>
<h1 id="按键监听"><a href="#按键监听" class="headerlink" title="按键监听"></a>按键监听</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">"input"</span>).keydown(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  $(<span class="string">"input"</span>).css(<span class="string">"background-color"</span>,<span class="string">"#FFFFCC"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">$(<span class="string">"input"</span>).keyup(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  $(<span class="string">"input"</span>).css(<span class="string">"background-color"</span>,<span class="string">"#D6D6FF"</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h1 id="获取radio-value"><a href="#获取radio-value" class="headerlink" title="获取radio value"></a>获取radio value</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">":radio[name='repairType']:checked"</span>).val();</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> JavaScript </tag>
            
            <tag> JQuery </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[IntelliJ IDEA使用笔记]]></title>
      <url>http://xiaozhuang.github.io/2016/12/10/intellij-idea/</url>
      <content type="html"><![CDATA[<p>IDEA  全称 IntelliJ IDEA，是java语言开发的集成环境，IntelliJ在业界被公认为最好的java开发工具之一，尤其在智能代码助手、代码自动提示、重构、J2EE支持、各类版本工具(git、svn、github等)、JUnit、CVS整合、代码分析、 创新的GUI设计等方面的功能可以说是超常的。<br><a id="more"></a></p>
<h1 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h1><ul>
<li>Alt + Insert    生成getter和setter</li>
<li>Ctrl + O    覆盖基类方法</li>
<li>Ctrl + Alt + O            移除未使用引用</li>
</ul>
<ul>
<li>Alt + Enter    快速修正，创建接口实现类</li>
</ul>
<ul>
<li>Ctrl + Shift + U    大小写转换</li>
<li>Ctrl + Shift + Alt + L    格式化代码</li>
</ul>
<ul>
<li>Ctrl + Space    基本的代码提示</li>
<li>Ctrl + Shift + Space    智能提示</li>
</ul>
<ul>
<li>Ctrl + Shift + Enter    <code>自动补全末尾的字符</code></li>
<li>Shift + Enter    光标换行</li>
</ul>
<ul>
<li>Ctrl + N            快速打开类</li>
<li>Ctrl + Shift + N            快速打开文件</li>
<li>Ctrl + Shift + Alt + N    快速打开方法</li>
<li>Ctrl + H                    打开类继承关系    </li>
<li>Ctrl + Alt + H   查找方法使用</li>
<li><p>Shift + Shift 快速查找</p>
</li>
<li><p>Ctrl + Alt + T    选中代码，添加try catch</p>
</li>
<li>Ctrl + Alt + L    格式化代码</li>
</ul>
<ul>
<li>Ctrl + Shift + T    创建单元测试</li>
<li>Ctrl + Shift + F10    测试当前方法</li>
</ul>
<ul>
<li><p>Ctrl+F12 显示当前文件的结构</p>
</li>
<li><p>Shift + Esc 隐藏项目导航</p>
</li>
<li><p>Alt + Esc 显示项目导航</p>
</li>
<li><p>Ctrl + D 复制当前行</p>
</li>
<li><p>Ctrl + Y 删除当前行</p>
</li>
<li><p>Ctrl + E 最近的文件</p>
</li>
<li><p>Ctrl + Alt 点击类方法，打开方法实现</p>
</li>
</ul>
<ul>
<li><p>Ctrl + Shift + A  查找快捷键</p>
</li>
<li><p>Alt + 数字  打开侧边栏</p>
</li>
<li>Alt + Shift + [ 项目切换</li>
<li></li>
<li><p>F11        添加书签</p>
</li>
<li><p>Shift + F11        查看书签</p>
</li>
<li><p>Alt + Shift + F   添加收藏</p>
</li>
<li><p>Ctrl+Alt+S   插件启停</p>
</li>
<li><p>Ctrl + Shift + Alt + J 编辑相同内容</p>
</li>
<li><p>Alt + Insert 在测试类名上执行，添加测试方法</p>
</li>
<li><p>sout –&gt;  System.out.println();</p>
</li>
<li>soutp –&gt;  System.out.println(“”);</li>
<li>soutv –&gt;  System.out.println(“变量名 = “ + 变量);</li>
<li>soutm –&gt;  System.out.println(“当前类名.当前方法”);</li>
<li>psvm –&gt;  public static void main(String[] args) {}</li>
</ul>
<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><ul>
<li>F7 单步进入</li>
<li>F8 下一步yi</li>
<li>Shift + F8 跳至下一个断点</li>
</ul>
<h3 id="重构"><a href="#重构" class="headerlink" title="重构"></a>重构</h3><ul>
<li>Shift + F6  重命名</li>
<li><p>Ctrl + F6 方法重构</p>
</li>
<li><p>Ctrl + Shift + Alt + T    重构</p>
</li>
<li>Ctrl + Alt + V    提取变量</li>
<li>Ctrl + Alt + M    方法提取</li>
</ul>
<h3 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h3><p>右键–&gt;git–&gt;annotate  idea中查看java文件修改历史</p>
<h2 id="智能提示"><a href="#智能提示" class="headerlink" title="智能提示"></a>智能提示</h2><h2 id="代码生成"><a href="#代码生成" class="headerlink" title="代码生成"></a>代码生成</h2><p>常用的有fori/sout/psvm+Tab即可生成循环、System.out、main方法等boilerplate样板代码<br>用Ctrl+J可以查看所有模板</p>
<p>后缀自动补全功能(Postfix Completion)，比模板生成更加灵活和强大。<br>for(User user : users)  –&gt;  user.for + Tab<br>Date birthday = user.getBirthday();   –&gt;  user.getBirthday().var + Tab<br>user.nn –&gt; if(user != null)</p>
<h1 id="configure-Spring-facet-in-IntelliJ-IDEA"><a href="#configure-Spring-facet-in-IntelliJ-IDEA" class="headerlink" title="configure Spring facet in IntelliJ IDEA"></a>configure Spring facet in IntelliJ IDEA</h1><p>Go to File/Project Structure/Modules, click the green plus icon, select Spring from the dropdown and select your module in the next dialog.<br>Then click the green plus in the right pane, click plus and select your Spring configuration files and classes and click OK.</p>
<h1 id="取消重启时从新打开项目"><a href="#取消重启时从新打开项目" class="headerlink" title="取消重启时从新打开项目"></a>取消重启时从新打开项目</h1><p>File-&gt;settings-&gt;system Settings-&gt; Reopen last project on startup  取消勾选</p>
<h1 id="Tomcat-VM-options"><a href="#Tomcat-VM-options" class="headerlink" title="Tomcat VM options"></a>Tomcat VM options</h1><p>-Xms512m -Xmx1024m -XX:PermSize=256M -XX:MaxPermSize=512M -Dfile.encoding=UTF-8</p>
<p>-Xmx2048m -Xms2048m -Xmn512m -XX:MaxPermSize=512m</p>
<h1 id="idea-把一个add到git的文件去掉"><a href="#idea-把一个add到git的文件去掉" class="headerlink" title="idea 把一个add到git的文件去掉"></a>idea 把一个add到git的文件去掉</h1><p>Git -&gt; Repository -&gt; Reset HEAD…</p>
<h1 id="idea-Override-is-not-allowed-when-implementing-interface-method"><a href="#idea-Override-is-not-allowed-when-implementing-interface-method" class="headerlink" title="idea @Override is not allowed when implementing interface method"></a>idea @Override is not allowed when implementing interface method</h1><ul>
<li><p>在project/module上，右键选择菜单“Open Module Settings” ;</p>
</li>
<li><p>选择Modules，修改“Language Level” 为 “8-Lambdas,……”;</p>
</li>
<li><p>选择Project， 修改“Project language level” 为 “SDK default”。</p>
</li>
</ul>
<h1 id="JDK配置"><a href="#JDK配置" class="headerlink" title="JDK配置"></a>JDK配置</h1><h1 id="idea乱码"><a href="#idea乱码" class="headerlink" title="idea乱码"></a>idea乱码</h1><p>Settings → File Encoding → Project Encoding → IDE Encoding.</p>
<h1 id="IntelliJ-IDEA-Tomcat-Debug启动非常慢，系统运行非常慢"><a href="#IntelliJ-IDEA-Tomcat-Debug启动非常慢，系统运行非常慢" class="headerlink" title="IntelliJ IDEA Tomcat Debug启动非常慢，系统运行非常慢"></a>IntelliJ IDEA Tomcat Debug启动非常慢，系统运行非常慢</h1><p>看看你在debug的时候是否在方法上加了断点，如果在方法上加了断点，那么运行时非常慢。</p>
<h1 id="maven本地jar包在idea中dependencies总是有红线解决办法"><a href="#maven本地jar包在idea中dependencies总是有红线解决办法" class="headerlink" title="maven本地jar包在idea中dependencies总是有红线解决办法"></a>maven本地jar包在idea中dependencies总是有红线解决办法</h1><p>对于有波浪线的dependency，将其从pom中删除，保存后，再撤销回来，然后reimport<br>就ok了</p>
<h1 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h1><h2 id="比较两个分支"><a href="#比较两个分支" class="headerlink" title="比较两个分支"></a>比较两个分支</h2><p>选择分支与当前分支比较</p>
<p>右键项目 -&gt; Git -&gt; Compare with Branche</p>
<h1 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h1><h2 id="Live-Template"><a href="#Live-Template" class="headerlink" title="Live Template"></a>Live Template</h2><p>File-&gt;Settings-&gt;Editor-&gt;Live Template</p>
<p><a href="https://www.jetbrains.com/help/phpstorm/2016.1/edit-template-variables-dialog.html" target="_blank" rel="external">https://www.jetbrains.com/help/phpstorm/2016.1/edit-template-variables-dialog.html</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1.添加模板</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * </div><div class="line"> * <span class="doctag">@Author</span> wangdianzhuang</div><div class="line"> * <span class="doctag">@Date</span> : $CREAT_DATE$</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="comment">// 2.设置模板中占位符匹配的变量(Edit variables)</span></div><div class="line"><span class="comment">// $CREAT_DATE$</span></div><div class="line"><span class="comment">// date("yyyy-MM-dd HH:mm:ss")</span></div><div class="line"></div><div class="line"><span class="comment">// 3.设置模板生效范围</span></div></pre></td></tr></table></figure>
<h2 id="重建索引"><a href="#重建索引" class="headerlink" title="重建索引"></a>重建索引</h2><p>File -&gt; Invalidate caches…</p>
<h2 id="idea-maven自动下载源码和文档"><a href="#idea-maven自动下载源码和文档" class="headerlink" title="idea maven自动下载源码和文档"></a>idea maven自动下载源码和文档</h2><p>File =&gt; Setting =&gt; Build, Execution, Deployment =&gt; Build Tools =&gt; Maven =&gt; Importing</p>
<p>然后勾选自动下载 Sources，Documentation即可</p>
<h2 id="修改idea默认通用"><a href="#修改idea默认通用" class="headerlink" title="修改idea默认通用"></a>修改idea默认通用</h2><p>File -&gt; Other settings -&gt; default settings</p>
<h2 id="修改控制台缓冲大小"><a href="#修改控制台缓冲大小" class="headerlink" title="修改控制台缓冲大小"></a>修改控制台缓冲大小</h2><p>Settings→Editor→General→Console</p>
<h1 id="默认JDK"><a href="#默认JDK" class="headerlink" title="默认JDK"></a>默认JDK</h1><p>File -&gt; other settins -&gt; Default Project Structrue -&gt; Project</p>
<h2 id="修改终端为git-bash"><a href="#修改终端为git-bash" class="headerlink" title="修改终端为git bash"></a>修改终端为git bash</h2><p>File -&gt; Settings -&gt; Tools -&gt; Terminal</p>
<p>shell path 为”C:\Program Files (x86)\Git\bin\sh.exe” –login -i</p>
<h2 id="修改日志字体"><a href="#修改日志字体" class="headerlink" title="修改日志字体"></a>修改日志字体</h2><p>File -&gt; Settings -&gt; Editor -&gt; Colors &amp; Fonts -&gt; Console Font.</p>
<h2 id="Intellij-IDEA-自动生成-serialVersionUID"><a href="#Intellij-IDEA-自动生成-serialVersionUID" class="headerlink" title="Intellij IDEA 自动生成 serialVersionUID"></a>Intellij IDEA 自动生成 serialVersionUID</h2><ol>
<li><p>安装GenerateSerialVersionUID插件（File -&gt; Plugins -&gt; GenerateSerialVersionUID）</p>
</li>
<li><p>Setting-&gt;Inspections-&gt;Serialization issues-&gt;Serializable class without ’serialVersionUID’<br>选上以后，在你的class中：Alt+Enter就会提示自动创建serialVersionUID了。</p>
</li>
</ol>
<h2 id="IDEA更新快照"><a href="#IDEA更新快照" class="headerlink" title="IDEA更新快照"></a>IDEA更新快照</h2><p>Settings -&gt; Maven -&gt; Always update snapshots</p>
<h2 id="修改idea自动添加import时使用import"><a href="#修改idea自动添加import时使用import" class="headerlink" title="修改idea自动添加import时使用import*"></a>修改idea自动添加import时使用import*</h2><p>settings -&gt; Code Style -&gt; Java<br>class count to use import with ‘<em>‘      设置500<br>Names count to use static import with ‘</em>‘   设置500</p>
<h2 id="Markdown插件"><a href="#Markdown插件" class="headerlink" title="Markdown插件"></a>Markdown插件</h2><p>Markdown support</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
            <tag> IDE </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Seckill]]></title>
      <url>http://xiaozhuang.github.io/2016/12/10/seckill/</url>
      <content type="html"><![CDATA[<p>Java高并发秒杀，学习笔记<br><a href="http://www.imooc.com/learn/587" target="_blank" rel="external">http://www.imooc.com/learn/587</a><br><a id="more"></a></p>
<h1 id="秒杀业务分析"><a href="#秒杀业务分析" class="headerlink" title="秒杀业务分析"></a>秒杀业务分析</h1><p>秒杀业务核心 –&gt; 库存处理</p>
<p>减库存 &amp; 购买明细 –&gt; 完整事务 –&gt; 数据落地</p>
<p>事务机制是目前最可靠的落地方案</p>
<p>MySQL实现秒杀 –&gt; 事务 + 行级锁<br>Start Transaction<br><code>Update 库存数量</code><br>Insert 购买明细<br>Commit</p>
<p>竞争出现在减库存（update）上</p>
<p>秒杀功能： 秒杀接口暴露 –&gt; 执行秒杀 –&gt; 相关查询</p>
<h1 id="DAO"><a href="#DAO" class="headerlink" title="DAO"></a>DAO</h1><h2 id="MyBatis-Mapper自动实现DAO接口"><a href="#MyBatis-Mapper自动实现DAO接口" class="headerlink" title="MyBatis Mapper自动实现DAO接口"></a>MyBatis Mapper自动实现DAO接口</h2><p>定义DAO接口，并配置Dao接口SQl，由MyBatis自动实现接口，并将实现类注入Spring</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--配置扫描Dao接口包，动态实现Dao接口，注入Spring容器--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span> &gt;</span></div><div class="line">    <span class="comment">&lt;!--注入sqlSessionFactory--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sqlSessionFactoryBeanName"</span> <span class="attr">value</span>=<span class="string">"sqlSessionFactory"</span>/&gt;</span></div><div class="line">    <span class="comment">&lt;!--扫描Dao接口包--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"basePackage"</span> <span class="attr">value</span>=<span class="string">"org.seckill.dao"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="MyBatis-扫描SQL配置和类别名"><a href="#MyBatis-扫描SQL配置和类别名" class="headerlink" title="MyBatis 扫描SQL配置和类别名"></a>MyBatis 扫描SQL配置和类别名</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--配置SqlSessionFactory对象--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sqlSessionFactory"</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.SqlSessionFactoryBean"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!--注入数据库连接池--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></div><div class="line">    <span class="comment">&lt;!--MyBatis全局配置文件--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"configLocation"</span> <span class="attr">value</span>=<span class="string">"classpath:mybatis-config"</span> /&gt;</span></div><div class="line">    <span class="comment">&lt;!--扫描entity包 使用别名--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"typeAliasesPackage"</span> <span class="attr">value</span>=<span class="string">"org.seckill.entity"</span> /&gt;</span></div><div class="line">    <span class="comment">&lt;!--扫描sql配置文件：mapper需要的xml文件--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mapperLocations"</span> <span class="attr">value</span>=<span class="string">"classpath:mapper/*.xml"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="MyBatis接口多参数"><a href="#MyBatis接口多参数" class="headerlink" title="MyBatis接口多参数"></a>MyBatis接口多参数</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 根据偏移量查询秒杀商品列表</div><div class="line"> * <span class="doctag">@param</span> offet</div><div class="line"> * <span class="doctag">@param</span> limit</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"><span class="function">List&lt;Seckill&gt; <span class="title">queryAll</span><span class="params">(@Param(<span class="string">"offet"</span>)</span> <span class="keyword">int</span> offet, @<span class="title">Param</span><span class="params">(<span class="string">"limit"</span>)</span> <span class="keyword">int</span> limit)</span>;</div></pre></td></tr></table></figure>
<p>@Param注解，指定形参在MyBatis Sql配置中绑定的参数</p>
<h2 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h2><h3 id="Spring-xml配置中使用properties配置"><a href="#Spring-xml配置中使用properties配置" class="headerlink" title="Spring xml配置中使用properties配置"></a>Spring xml配置中使用properties配置</h3><p>配置${username}被替换为系统用户名</p>
<h3 id="数据库连接警告"><a href="#数据库连接警告" class="headerlink" title="数据库连接警告"></a>数据库连接警告</h3><p>Fri Dec 11 18:28:21 CST 2015 WARN: Establishing SSL connection without server’s identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn’t set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to ‘false’. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.</p>
<p>数据库连接地址添加：useSSL=false</p>
<h3 id="idea-warning"><a href="#idea-warning" class="headerlink" title="idea warning"></a>idea warning</h3><p>Warning:java: 源值1.5已过时, 将在未来所有发行版中删除</p>
<p>solution:<br>maven settings.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>jdk-1.8<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">jdk</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">jdk</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">maven.compiler.compilerVersion</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.compilerVersion</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></div></pre></td></tr></table></figure>
<h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><p>Service层接口，站在“使用者”角度设计接口<br>三个方面：方法定义粒度、参数、返回类型</p>
<h2 id="Spring注解事务"><a href="#Spring注解事务" class="headerlink" title="Spring注解事务"></a>Spring注解事务</h2><p><code>Spring注解事务，只有非受检异常才执行事务回滚</code></p>
<p>事务方法嵌套,默认传播行为，若已有事务，则加入已有事务；否则，开启事务；</p>
<p>使用注解控制事务：<br>1.明确标注事务方法的编程风格<br>2.保证事务方法的执行时间尽可能短，不要穿插其他网络操作RPC/HTTP请求或剥离到事务方法之外<br>3.不是所有方法都需要事务，只有一条修改操作不需要事务</p>
<p>DTO(data transfer object):数据传输对象<br>负责web与service间的数据传递,其实是service接口返回数据的封装</p>
<h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><p>@RequestMapping注解</p>
<ul>
<li>支持标准URL</li>
<li>ant风格URL（即？、<em> 和 *</em>等字符）</li>
<li>在{xxx}站位符的URL</li>
</ul>
<p>重定向：”redirect:/seckill/list”<br>请求转发：”forword:/seckill/list”</p>
<p>@RequestMapping<br>添加请求头：produces={“application/json;charset=UTF-8”}</p>
<h2 id="问题记录-1"><a href="#问题记录-1" class="headerlink" title="问题记录"></a>问题记录</h2><h3 id="web-xml"><a href="#web-xml" class="headerlink" title="web.xml"></a>web.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee"</span></span></div><div class="line">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee</span></div><div class="line">                      http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"</div><div class="line">         <span class="attr">version</span>=<span class="string">"3.1"</span></div><div class="line">         <span class="attr">metadata-complete</span>=<span class="string">"true"</span>&gt;</div></pre></td></tr></table></figure>
<p>servlet配置报错：element servletname is not allowed here<br>原因：Servlet 3.1可以实现无xml配置SpringMVC</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring </tag>
            
            <tag> MyBatis </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Guava Note]]></title>
      <url>http://xiaozhuang.github.io/2016/11/20/guava-note/</url>
      <content type="html"><![CDATA[<p>Guava工程包含了若干被Google的 Java项目广泛依赖 的核心库，例如：集合 [collections] 、缓存 [caching] 、原生类型支持 [primitives support] 、并发库 [concurrency libraries] 、通用注解 [common annotations] 、字符串处理 [string processing] 、I/O 等等</p>
<a id="more"></a>
<h1 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h1><h2 id="不可变集合"><a href="#不可变集合" class="headerlink" title="不可变集合"></a>不可变集合</h2><p>用不变的集合进行防御性编程和性能提升。</p>
<h3 id="三种创建方式"><a href="#三种创建方式" class="headerlink" title="三种创建方式"></a>三种创建方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// of方法</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ImmutableSet&lt;String&gt; COLOR_NAMES = ImmutableSet.of(</div><div class="line">        <span class="string">"red"</span>,</div><div class="line">        <span class="string">"orange"</span>,</div><div class="line">        <span class="string">"yellow"</span>,</div><div class="line">        <span class="string">"green"</span>,</div><div class="line">        <span class="string">"blue"</span>,</div><div class="line">        <span class="string">"purple"</span>);</div><div class="line"></div><div class="line"><span class="comment">//copyOf方法</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</div><div class="line">    Set&lt;Bar&gt; bars;</div><div class="line">    Foo(Set&lt;Bar&gt; bars) &#123;</div><div class="line">        <span class="keyword">this</span>.bars = ImmutableSet.copyOf(bars); <span class="comment">// 防御性拷贝!</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//Builder工具</span></div><div class="line">ImmutableSet&lt;Color&gt; GOOGLE_COLORS =</div><div class="line">                ImmutableSet.&lt;Color&gt;builder()</div><div class="line">                    .addAll(WEBSAFE_COLORS)</div><div class="line">                    .add(<span class="keyword">new</span> Color(<span class="number">0</span>, <span class="number">191</span>, <span class="number">255</span>))</div><div class="line">                    .build();</div></pre></td></tr></table></figure>
<h3 id="asList视图"><a href="#asList视图" class="headerlink" title="asList视图"></a>asList视图</h3><p>所有不可变集合都有一个asList()方法提供ImmutableList视图，方便用列表形式地读取集合元素。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ImmutableList&lt;String&gt; asList = COLORNAME.asList();</div><div class="line">System.out.println(asList.get(<span class="number">0</span>));</div></pre></td></tr></table></figure>
<h3 id="关联可变集合和不可变集合"><a href="#关联可变集合和不可变集合" class="headerlink" title="关联可变集合和不可变集合"></a>关联可变集合和不可变集合</h3><table>
<thead>
<tr>
<th>可变集合接口</th>
<th>属于JDK还是Guava</th>
<th>不可变版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>Collection</td>
<td>JDK</td>
<td>ImmutableCollection</td>
</tr>
<tr>
<td>List</td>
<td>JDK</td>
<td>ImmutableList</td>
</tr>
<tr>
<td>Set</td>
<td>JDK</td>
<td>ImmutableSet</td>
</tr>
<tr>
<td>SortedSet/NavigableSet</td>
<td>JDK</td>
<td>ImmutableSortedSet</td>
</tr>
<tr>
<td>Map</td>
<td>JDK</td>
<td>ImmutableMap</td>
</tr>
<tr>
<td>SortedMap</td>
<td>JDK</td>
<td>ImmutableSortedMap</td>
</tr>
<tr>
<td>Multiset</td>
<td>Guava</td>
<td>ImmutableMultiset</td>
</tr>
<tr>
<td>SortedMultiset</td>
<td>Guava</td>
<td>ImmutableSortedMultiset</td>
</tr>
<tr>
<td>Multimap</td>
<td>Guava</td>
<td>ImmutableMultimap</td>
</tr>
<tr>
<td>ListMultimap</td>
<td>Guava</td>
<td>ImmutableListMultimap</td>
</tr>
<tr>
<td>SetMultimap</td>
<td>Guava</td>
<td>ImmutableSetMultimap</td>
</tr>
<tr>
<td>BiMap</td>
<td>Guava</td>
<td>ImmutableBiMap</td>
</tr>
<tr>
<td>ClassToInstanceMap</td>
<td>Guava</td>
<td>ImmutableClassToInstanceMap</td>
</tr>
<tr>
<td>Table</td>
<td>Guava</td>
<td>ImmutableTable</td>
</tr>
</tbody>
</table>
<h2 id="新集合类型-Multiset"><a href="#新集合类型-Multiset" class="headerlink" title="新集合类型-Multiset"></a>新集合类型-Multiset</h2><h3 id="Multiset"><a href="#Multiset" class="headerlink" title="Multiset"></a>Multiset</h3><p>Multiset，它可以多次添加相等的元素，包含元素计数<br>HashMultiset.count的复杂度为O(1)，TreeMultiset.count的复杂度为O(log n)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Person</span>&gt;</span>&#123;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> prime = <span class="number">31</span>;</div><div class="line">        <span class="keyword">int</span> result = <span class="number">1</span>;</div><div class="line">        result = prime * result + ((name == <span class="keyword">null</span>) ? <span class="number">0</span> : name.hashCode());</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == obj)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">if</span> (getClass() != obj.getClass())</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        Person other = (Person) obj;</div><div class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (other.name != <span class="keyword">null</span>)</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!name.equals(other.name))</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Person [name="</span> + name + <span class="string">"]"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Person other)</span> </span>&#123;</div><div class="line">        <span class="comment">// TODO Auto-generated method stub</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name.compareTo(other.getName());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">System.out.println(<span class="string">"--- HashMultiset ---"</span>);</div><div class="line">        </div><div class="line">Multiset&lt;Person&gt; hashMultiset = HashMultiset.create();</div><div class="line"></div><div class="line">Person wangdz = <span class="keyword">new</span> Person(<span class="string">"wangdz"</span>);</div><div class="line">hashMultiset.add(wangdz);</div><div class="line"></div><div class="line">Person wangdz2 = <span class="keyword">new</span> Person(<span class="string">"wangdz"</span>);</div><div class="line">hashMultiset.add(wangdz2);</div><div class="line"></div><div class="line">Person sunday = <span class="keyword">new</span> Person(<span class="string">"sunday"</span>);</div><div class="line">hashMultiset.add(sunday);</div><div class="line"></div><div class="line"><span class="keyword">int</span> sunday_count = hashMultiset.count(sunday);</div><div class="line">System.out.println(sunday_count);</div><div class="line"></div><div class="line"><span class="keyword">int</span> wangdz_count = hashMultiset.count(wangdz);</div><div class="line">System.out.println(wangdz_count);</div><div class="line"></div><div class="line"><span class="keyword">for</span>(Person person: hashMultiset)&#123;</div><div class="line">    System.out.println(person);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//elementSet()返回所有不重复元素的Set&lt;E&gt;</span></div><div class="line">Set&lt;Person&gt; elementSet = hashMultiset.elementSet();</div><div class="line"></div><div class="line"><span class="comment">//和Map的entrySet类似，返回Set&lt;Multiset.Entry&lt;E&gt;&gt;</span></div><div class="line">Set&lt;Entry&lt;Person&gt;&gt; entrySet = hashMultiset.entrySet();</div><div class="line"><span class="keyword">for</span>(Entry&lt;Person&gt; entry : entrySet)&#123;</div><div class="line">    Person element = entry.getElement();</div><div class="line">    System.out.println(element);</div><div class="line">    <span class="keyword">int</span> element_count = entry.getCount();</div><div class="line">    System.out.println(element_count);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//Multiset.addAll(Collection)可以添加Collection中的所有元素并进行计数</span></div><div class="line"></div><div class="line">System.out.println(<span class="string">"--- TreeMultiset ---"</span>);</div><div class="line"></div><div class="line">Multiset&lt;Person&gt; multiset2 = TreeMultiset.create();</div><div class="line">multiset2.add(wangdz);</div><div class="line">multiset2.add(wangdz2);</div><div class="line">multiset2.add(sunday);</div><div class="line"></div><div class="line"><span class="keyword">for</span>(Person person: hashMultiset)&#123;</div><div class="line">    System.out.println(person);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Multiset-方法"><a href="#Multiset-方法" class="headerlink" title="Multiset 方法"></a>Multiset 方法</h3><table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>count(E)</td>
<td>给定元素在Multiset中的计数</td>
</tr>
<tr>
<td>elementSet()</td>
<td>Multiset中不重复元素的集合，类型为Set<e></e></td>
</tr>
<tr>
<td>entrySet()</td>
<td>和Map的entrySet类似，返回Set<multiset.entry<e>&gt;，其中包含的Entry支持getElement()和getCount()方法</multiset.entry<e></td>
</tr>
<tr>
<td>add(E, int)</td>
<td>增加给定元素在Multiset中的计数</td>
</tr>
<tr>
<td>remove(E, int)</td>
<td>减少给定元素在Multiset中的计数</td>
</tr>
<tr>
<td>setCount(E, int)</td>
<td>设置给定元素在Multiset中的计数，不可以为负数</td>
</tr>
<tr>
<td>size()</td>
<td>返回集合元素的总个数（包括重复的元素）</td>
</tr>
</tbody>
</table>
<h3 id="Multiset的各种实现"><a href="#Multiset的各种实现" class="headerlink" title="Multiset的各种实现"></a>Multiset的各种实现</h3><table>
<thead>
<tr>
<th>Map</th>
<th>对应的Multiset</th>
<th>是否支持null元素</th>
</tr>
</thead>
<tbody>
<tr>
<td>HashMap</td>
<td>HashMultiset</td>
<td>是</td>
</tr>
<tr>
<td>TreeMap</td>
<td>TreeMultiset</td>
<td>是（如果comparator支持的话）</td>
</tr>
<tr>
<td>LinkedHashMap</td>
<td>LinkedHashMultiset</td>
<td>是</td>
</tr>
<tr>
<td>ConcurrentHashMap</td>
<td>ConcurrentHashMultiset</td>
<td>否</td>
</tr>
<tr>
<td>ImmutableMap</td>
<td>ImmutableMultiset</td>
<td>否</td>
</tr>
</tbody>
</table>
<h2 id="SortedMultiset"><a href="#SortedMultiset" class="headerlink" title="SortedMultiset"></a>SortedMultiset</h2><p>SortedMultiset是Multiset 接口的变种，它支持高效地获取指定范围的子集。</p>
<p>如：用 latencies.subMultiset(0,BoundType.CLOSED, 100, BoundType.OPEN).size()来统计你的站点中延迟在100毫秒以内的访问</p>
<p>TreeMultiset实现SortedMultiset接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">SortedMultiset&lt;Integer&gt; latencies = TreeMultiset.create();</div><div class="line">latencies.add(<span class="number">10</span>);</div><div class="line">latencies.add(<span class="number">90</span>);</div><div class="line">latencies.add(<span class="number">90</span>);</div><div class="line">latencies.add(<span class="number">100</span>);</div><div class="line"><span class="comment">//统计指定范围内数据，范围不止int类型，依赖compare方法</span></div><div class="line"><span class="keyword">int</span> count = latencies.subMultiset(<span class="number">0</span>,BoundType.CLOSED, <span class="number">100</span>, BoundType.OPEN).size();</div><div class="line">System.out.println(count);</div></pre></td></tr></table></figure>
<h2 id="Multimap"><a href="#Multimap" class="headerlink" title="Multimap"></a>Multimap</h2><p>Guava的 Multimap可以很容易地把一个键映射到多个值<br>ListMultimap或SetMultimap接口，它们分别把键映射到List或Set</p>
<h3 id="ListMultimap"><a href="#ListMultimap" class="headerlink" title="ListMultimap"></a>ListMultimap</h3><p><code>优化Map&lt;K, List&lt;V&gt;&gt;</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">List&lt;Person&gt; persons = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">persons.add(<span class="keyword">new</span> Person(<span class="string">"sunday"</span>));</div><div class="line">persons.add(<span class="keyword">new</span> Person(<span class="string">"wangdz"</span>));</div><div class="line"></div><div class="line">ListMultimap&lt;String,Person&gt; listMultimap = ArrayListMultimap.create();</div><div class="line">listMultimap.put(<span class="string">"person"</span>, <span class="keyword">new</span> Person(<span class="string">"person1"</span>));</div><div class="line">listMultimap.put(<span class="string">"person"</span>, <span class="keyword">new</span> Person(<span class="string">"person2"</span>));</div><div class="line"></div><div class="line"></div><div class="line">List&lt;Person&gt; list = listMultimap.get(<span class="string">"person"</span>);</div><div class="line">System.out.println(list);</div><div class="line"></div><div class="line">listMultimap.putAll(<span class="string">"me"</span>, persons);</div><div class="line">List&lt;Person&gt; list2 = listMultimap.get(<span class="string">"me"</span>);</div><div class="line">System.out.println(list2);</div></pre></td></tr></table></figure>
<h3 id="SetMultimap"><a href="#SetMultimap" class="headerlink" title="SetMultimap"></a>SetMultimap</h3><p><code>优化Map&lt;K, Set&lt;V&gt;&gt;</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Set&lt;Person&gt; persons = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">persons.add(<span class="keyword">new</span> Person(<span class="string">"sunday"</span>));</div><div class="line">persons.add(<span class="keyword">new</span> Person(<span class="string">"wangdz"</span>));</div><div class="line"></div><div class="line">SetMultimap&lt;String,Person&gt; hashMultimap = HashMultimap.create();</div><div class="line">hashMultimap.put(<span class="string">"person"</span>, <span class="keyword">new</span> Person(<span class="string">"person1"</span>));</div><div class="line">hashMultimap.put(<span class="string">"person"</span>, <span class="keyword">new</span> Person(<span class="string">"person1"</span>));</div><div class="line"></div><div class="line">Set&lt;Person&gt; set = hashMultimap.get(<span class="string">"person"</span>);</div><div class="line">System.out.println(set);</div><div class="line"></div><div class="line">hashMultimap.putAll(<span class="string">"me"</span>,persons);</div><div class="line">Set&lt;Person&gt; list2 = hashMultimap.get(<span class="string">"me"</span>);</div><div class="line">System.out.println(list2);</div></pre></td></tr></table></figure>
<h3 id="Multimap方法"><a href="#Multimap方法" class="headerlink" title="Multimap方法"></a>Multimap方法</h3><table>
<thead>
<tr>
<th>方法签名</th>
<th>描述</th>
<th>等价于</th>
</tr>
</thead>
<tbody>
<tr>
<td>put(K, V)</td>
<td>添加键到单个值的映射</td>
<td>multimap.get(key).add(value)</td>
</tr>
<tr>
<td>putAll(K, Iterable<v>)</v></td>
<td>依次添加键到多个值的映射</td>
<td>Iterables.addAll(multimap.get(key), values)</td>
</tr>
<tr>
<td>remove(K, V)</td>
<td>移除键到值的映射；如果有这样的键值并成功移除，返回true。</td>
<td>multimap.get(key).remove(value)</td>
</tr>
<tr>
<td>removeAll(K)</td>
<td>清除键对应的所有值，返回的集合包含所有之前映射到K的值，但修改这个集合就不会影响Multimap了。</td>
<td>multimap.get(key).clear()</td>
</tr>
<tr>
<td>replaceValues(K, Iterable<v>)</v></td>
<td>清除键对应的所有值，并重新把key关联到Iterable中的每个元素。返回的集合包含所有之前映射到K的值。</td>
<td>multimap.get(key).clear(); Iterables.addAll(multimap.get(key), values)</td>
</tr>
</tbody>
</table>
<h3 id="Multimap的视图"><a href="#Multimap的视图" class="headerlink" title="Multimap的视图"></a>Multimap的视图</h3><ul>
<li>asMap：<code>Multimap&lt;K, V&gt;</code>提供<code>Map&lt;K,Collection&lt;V&gt;&gt;</code>形式的视图</li>
<li>entries用<code>Collection&lt;Map.Entry&lt;K, V&gt;&gt;</code>返回Multimap中所有”键-单个值映射”——包括重复键。（对SetMultimap，返回的是Set）</li>
<li>keySet用Set表示Multimap中所有不同的键。</li>
<li>keys用Multiset表示Multimap中的所有键，每个键重复出现的次数等于它映射的值的个数。可以从这个Multiset中移除元素，但不能做添加操作；移除操作会反映到底层的Multimap。</li>
<li>values()用一个”扁平”的<code>Collection&lt;V&gt;</code>包含Multimap中的所有值。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">List&lt;Person&gt; persons = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">persons.add(<span class="keyword">new</span> Person(<span class="string">"sunday"</span>));</div><div class="line">persons.add(<span class="keyword">new</span> Person(<span class="string">"wangdz"</span>));</div><div class="line"></div><div class="line">ListMultimap&lt;String,Person&gt; listMultimap = ArrayListMultimap.create();</div><div class="line">listMultimap.put(<span class="string">"person"</span>, <span class="keyword">new</span> Person(<span class="string">"person1"</span>));</div><div class="line">listMultimap.put(<span class="string">"person"</span>, <span class="keyword">new</span> Person(<span class="string">"person1"</span>));</div><div class="line"></div><div class="line">listMultimap.putAll(<span class="string">"me"</span>, persons);</div><div class="line"></div><div class="line">System.out.println(<span class="string">"---- asMap() ----"</span>);</div><div class="line">Map&lt;String, Collection&lt;Person&gt;&gt; asMap = listMultimap.asMap();</div><div class="line"></div><div class="line">System.out.println(<span class="string">"---- entries() ----"</span>);</div><div class="line">Collection&lt;Entry&lt;String, Person&gt;&gt; entries = listMultimap.entries();</div><div class="line"><span class="keyword">for</span>(Entry&lt;String, Person&gt; entry : entries)&#123;</div><div class="line">  String key = entry.getKey();</div><div class="line">  Person value = entry.getValue();</div><div class="line">  System.out.println(<span class="string">"key:"</span>+ key + <span class="string">" value:"</span> + value);</div><div class="line">&#125;</div><div class="line"></div><div class="line">System.out.println(<span class="string">"---- keySet() ----"</span>);</div><div class="line">Set&lt;String&gt; keySet = listMultimap.keySet();</div><div class="line"><span class="keyword">for</span>(String key : keySet)&#123;</div><div class="line">  System.out.println(<span class="string">"key:"</span>+key);</div><div class="line">&#125;</div><div class="line"></div><div class="line">System.out.println(<span class="string">"---- keys() ----"</span>);</div><div class="line">Multiset&lt;String&gt; keys = listMultimap.keys();</div><div class="line"><span class="keyword">for</span>(String key : keys)&#123;</div><div class="line">  System.out.println(<span class="string">"key:"</span> + key);</div><div class="line">&#125;</div><div class="line"></div><div class="line">System.out.println(<span class="string">"---- values() ----"</span>);</div><div class="line">Collection&lt;Person&gt; values = listMultimap.values();</div><div class="line"><span class="keyword">for</span>(Person person : values)&#123;</div><div class="line">  System.out.println(person);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>—- entries() —-<br>key:person value:Person [name=person1]<br>key:person value:Person [name=person1]<br>key:me value:Person [name=sunday]<br>key:me value:Person [name=wangdz]<br>—- keySet() —-<br>key:person<br>key:me<br>—- keys() —-<br>key:person<br>key:person<br>key:me<br>key:me<br>—- values() —-<br>Person [name=person1]<br>Person [name=person1]<br>Person [name=sunday]<br>Person [name=wangdz]</p>
</blockquote>
<h3 id="Multimap不是Map"><a href="#Multimap不是Map" class="headerlink" title="Multimap不是Map"></a>Multimap不是Map</h3><ul>
<li>Multimap.get(key)总是返回非null、但是可能空的集合</li>
<li>当且仅当有值映射到键时，Multimap.containsKey(key)才会返回true</li>
<li>Multimap.size()返回所有”键-单个值映射”的个数，而非不同键的个数。要得到不同键的个数，请改用Multimap.keySet().size()</li>
</ul>
<h3 id="Multimap的各种实现"><a href="#Multimap的各种实现" class="headerlink" title="Multimap的各种实现"></a>Multimap的各种实现</h3><table>
<thead>
<tr>
<th>实现</th>
<th>键行为类似</th>
<th>值行为类似</th>
</tr>
</thead>
<tbody>
<tr>
<td>ArrayListMultimap</td>
<td>HashMap</td>
<td>ArrayList</td>
</tr>
<tr>
<td>HashMultimap</td>
<td>HashMap</td>
<td>HashSet</td>
</tr>
<tr>
<td>LinkedListMultimap*</td>
<td>LinkedHashMap*</td>
<td>LinkedList*</td>
</tr>
<tr>
<td>LinkedHashMultimap**</td>
<td>LinkedHashMap</td>
<td>LinkedHashMap</td>
</tr>
<tr>
<td>TreeMultimap</td>
<td>TreeMap</td>
<td>TreeSet</td>
</tr>
<tr>
<td>ImmutableListMultimap</td>
<td>ImmutableMap</td>
<td>ImmutableList</td>
</tr>
<tr>
<td>ImmutableSetMultimap</td>
<td>ImmutableMap</td>
<td>ImmutableSet</td>
</tr>
</tbody>
</table>
<p>除了两个不可变形式的实现，其他所有实现都支持null键和null值<br><em>LinkedListMultimap.entries()保留了所有键和值的迭代顺序<br>*</em>LinkedHashMultimap保留了映射项的插入顺序，包括键插入的顺序，以及键映射的所有值的插入顺序<br>如果你想要更大的定制化，请用Multimaps.newMultimap(Map, Supplier<collection>)或list和 set版本，使用自定义的Collection、List或Set实现Multimap。</collection></p>
<h2 id="新集合类型-BiMap"><a href="#新集合类型-BiMap" class="headerlink" title="新集合类型-BiMap"></a>新集合类型-BiMap</h2><p>BiMap<k, v="">是双向映射Map:</k,></p>
<ul>
<li>可以用 inverse()反转BiMap<k, v="">的键值映射</k,></li>
<li>保证值是唯一的，因此 values()返回Set而不是普通的Collection</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">BiMap&lt;String, Integer&gt; userIds = HashBiMap.create();</div><div class="line">userIds.put(<span class="string">"sunday"</span>, <span class="number">17</span>);</div><div class="line"></div><div class="line">BiMap&lt;Integer, String&gt; userIdsInverse = userIds.inverse();</div><div class="line">userIdsInverse.put(<span class="number">19</span>, <span class="string">"wangdz"</span>);</div><div class="line"></div><div class="line">System.out.println(<span class="string">"---- keySet ergodic ----"</span>);</div><div class="line">Set&lt;String&gt; keySet = userIds.keySet();</div><div class="line"><span class="keyword">for</span>(String key : keySet)&#123;</div><div class="line">    System.out.println(<span class="string">"key:"</span> + key + <span class="string">"value:"</span> + userIds.get(key));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//把键映射到已经存在的值，会抛出IllegalArgumentException异常。如果对特定值，你想要强制替换它的键，请使用 BiMap.forcePut(key, value)。</span></div><div class="line">userIds.forcePut(<span class="string">"sunday"</span>, <span class="number">21</span>);</div><div class="line"></div><div class="line">System.out.println(<span class="string">"---- entrySet ergodic ----"</span>);</div><div class="line">Set&lt;Entry&lt;String, Integer&gt;&gt; entrySet = userIds.entrySet();</div><div class="line"><span class="keyword">for</span>(Entry&lt;String, Integer&gt; entry : entrySet)&#123;</div><div class="line">    System.out.println(<span class="string">"key:"</span> + entry.getKey() + <span class="string">" value:"</span> +entry.getValue());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>BiMap的各种实现</p>
<table>
<thead>
<tr>
<th>键–值实现</th>
<th>值–键实现</th>
<th>对应的BiMap实现</th>
</tr>
</thead>
<tbody>
<tr>
<td>HashMap</td>
<td>HashMap</td>
<td>HashBiMap</td>
</tr>
<tr>
<td>ImmutableMap</td>
<td>ImmutableMap</td>
<td>ImmutableBiMap</td>
</tr>
<tr>
<td>EnumMap</td>
<td>EnumMap</td>
<td>EnumBiMap</td>
</tr>
<tr>
<td>EnumMap</td>
<td>HashMap</td>
<td>EnumHashBiMap</td>
</tr>
</tbody>
</table>
<p>注：Maps类中还有一些诸如synchronizedBiMap的BiMap工具方法.</p>
<h2 id="新集合类型-Table"><a href="#新集合类型-Table" class="headerlink" title="新集合类型-Table"></a>新集合类型-Table</h2><p><code>Table&lt;R, C, V&gt;</code><br>Table有两个支持所有类型的键：“行”和“列”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Table&lt;Integer, Integer, Integer&gt; matrix = HashBasedTable.create();</div><div class="line">matrix.put(<span class="number">1</span>, <span class="number">1</span>, <span class="number">11</span>);</div><div class="line">matrix.put(<span class="number">1</span>, <span class="number">2</span>, <span class="number">12</span>);</div><div class="line">matrix.put(<span class="number">1</span>, <span class="number">3</span>, <span class="number">13</span>);</div><div class="line"></div><div class="line">matrix.put(<span class="number">2</span>, <span class="number">1</span>, <span class="number">21</span>);</div><div class="line">matrix.put(<span class="number">2</span>, <span class="number">2</span>, <span class="number">22</span>);</div><div class="line">matrix.put(<span class="number">2</span>, <span class="number">3</span>, <span class="number">23</span>);</div><div class="line"></div><div class="line">Map&lt;Integer, Integer&gt; row = matrix.row(<span class="number">1</span>); <span class="comment">//第一行</span></div><div class="line">Set&lt;Integer&gt; rowkeySet = row.keySet();</div><div class="line"><span class="keyword">for</span>(Integer rowKey : rowkeySet)&#123;</div><div class="line">    System.out.println(<span class="string">"rowKey:"</span>+rowKey + <span class="string">"rowValue:"</span>+row.get(rowKey));</div><div class="line">&#125;</div><div class="line"></div><div class="line">Map&lt;Integer, Integer&gt; column = matrix.column(<span class="number">2</span>); <span class="comment">//第二列</span></div><div class="line">Set&lt;Entry&lt;Integer, Integer&gt;&gt; entrySet = column.entrySet();</div><div class="line"><span class="keyword">for</span>(Entry&lt;Integer, Integer&gt; entry : entrySet)&#123;</div><div class="line">    System.out.println(<span class="string">"columnKey:"</span> + entry.getKey() + <span class="string">"columnValue:"</span>+entry.getValue());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>rowKey:1rowValue:11<br>rowKey:2rowValue:12<br>rowKey:3rowValue:13<br>columnKey:1columnValue:12<br>columnKey:2columnValue:22</p>
</blockquote>
<ul>
<li>rowMap()：用<code>Map&lt;R, Map&lt;C, V&gt;&gt;</code>表现<code>able&lt;R, C, V&gt;</code></li>
<li>rowKeySet()：返回“行”的集合Set<r></r></li>
<li><p>row(r)：用<code>Map&lt;C, V&gt;</code>返回给定”行”的所有列，对这个map进行的写操作也将写入Table中</p>
</li>
<li><p>类似的列访问方法：columnMap()、columnKeySet()、column(c)。（基于列的访问会比基于的行访问稍微低效点）</p>
</li>
<li><p>cellSet()：用元素类型为<code>Table.Cell&lt;R, C, V&gt;</code>的Set表现<code>Table&lt;R, C, V&gt;</code>。Cell类似于Map.Entry</p>
</li>
</ul>
<p>Table有如下几种实现：</p>
<table>
<thead>
<tr>
<th>类名</th>
<th>实现方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>HashBasedTable</td>
<td>本质上用<code>HashMap&lt;R, HashMap&lt;C, V&gt;&gt;</code>实现；</td>
</tr>
<tr>
<td>TreeBasedTable</td>
<td>本质上用<code>TreeMap&lt;R, TreeMap&lt;C,V&gt;&gt;</code>实现；</td>
</tr>
<tr>
<td>ImmutableTable</td>
<td>本质上用<code>ImmutableMap&lt;R, ImmutableMap&lt;C, V&gt;&gt;</code>实现；注：ImmutableTable对稀疏或密集的数据集都有优化。</td>
</tr>
<tr>
<td>ArrayTable</td>
<td>要求在构造时就指定行和列的大小，本质上由一个二维数组实现，以提升访问速度和密集Table的内存利用率。ArrayTable与其他Table的工作原理有点不同，请参见Javadoc了解详情。</td>
</tr>
</tbody>
</table>
<h2 id="新集合类型-ClassToInstanceMap"><a href="#新集合类型-ClassToInstanceMap" class="headerlink" title="新集合类型-ClassToInstanceMap"></a>新集合类型-ClassToInstanceMap</h2><p>ClassToInstanceMap是一种特殊的Map：它的键是类型，而值是符合键所指类型的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> ClassToInstanceMap&lt;Number&gt; numberDefaults=MutableClassToInstanceMap.create();</div><div class="line">numberDefaults.putInstance(Integer.class, <span class="number">0</span>);</div><div class="line">numberDefaults.put(Long.class, <span class="number">1L</span>);</div><div class="line"></div><div class="line">System.out.println(numberDefaults.getInstance(Integer.class));</div><div class="line">System.out.println(numberDefaults.getInstance(Long.class));</div></pre></td></tr></table></figure>
<blockquote>
<p>0<br>1</p>
</blockquote>
<p>从技术上讲，ClassToInstanceMap<b>实现了Map<class<? extends="" b="">, B&gt;<br>或者换句话说，是一个映射B的子类型到对应实例的Map<br>B始终是Map所支持类型的上界——通常B就是Object</class<?></b></p>
<p>Guava提供了两种有用的ClassToInstanceMap实现:<br>MutableClassToInstanceMap和 ImmutableClassToInstanceMap</p>
<h2 id="新集合类型-RangeSet"><a href="#新集合类型-RangeSet" class="headerlink" title="新集合类型-RangeSet"></a>新集合类型-RangeSet</h2><p>RangeSet描述了一组不相连的、非空的区间。当把一个区间添加到可变的RangeSet时，所有相连的区间会被合并，空区间会被忽略。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">RangeSet&lt;Integer&gt; rangeSet = TreeRangeSet.create();</div><div class="line">rangeSet.add(Range.closed(<span class="number">1</span>, <span class="number">10</span>)); <span class="comment">// &#123;[1,10]&#125;</span></div><div class="line">rangeSet.add(Range.closedOpen(<span class="number">11</span>, <span class="number">15</span>));<span class="comment">//不相连区间:&#123;[1,10], [11,15)&#125;</span></div><div class="line">rangeSet.add(Range.closedOpen(<span class="number">15</span>, <span class="number">20</span>)); <span class="comment">//相连区间; &#123;[1,10], [11,20)&#125;</span></div><div class="line">rangeSet.add(Range.openClosed(<span class="number">0</span>, <span class="number">0</span>)); <span class="comment">//空区间; &#123;[1,10], [11,20)&#125;</span></div><div class="line">rangeSet.remove(Range.open(<span class="number">5</span>, <span class="number">10</span>)); <span class="comment">//分割[1, 10]; &#123;[1,5], [10,10], [11,20)&#125;</span></div></pre></td></tr></table></figure>
<blockquote>
<p>[[1..5], [10..10], [11..20)]</p>
</blockquote>
<p>请注意，要合并Range.closed(1, 10)和Range.closedOpen(11, 15)这样的区间，你需要首先用Range.canonical(DiscreteDomain)对区间进行预处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> RangeSet&lt;Integer&gt; rangeSet = TreeRangeSet.create();</div><div class="line">rangeSet.add(Range.closed(<span class="number">1</span>, <span class="number">10</span>));</div><div class="line">rangeSet.add(Range.closedOpen(<span class="number">11</span>, <span class="number">15</span>));</div><div class="line">System.out.println(rangeSet);</div></pre></td></tr></table></figure>
<blockquote>
<p>[[1..10], [11..15)]</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">RangeSet&lt;Integer&gt; rangeSet = TreeRangeSet.create();</div><div class="line">rangeSet.add(Range.closed(<span class="number">1</span>, <span class="number">10</span>).canonical(DiscreteDomain.integers()));</div><div class="line">rangeSet.add(Range.closedOpen(<span class="number">11</span>, <span class="number">15</span>).canonical(DiscreteDomain.integers()));</div><div class="line">System.out.println(rangeSet);</div></pre></td></tr></table></figure>
<blockquote>
<p>[[1..15)]</p>
</blockquote>
<p>Building Ranges</p>
<table>
<thead>
<tr>
<th>类名</th>
<th>实现方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>(a..b)</td>
<td>open(C, C)</td>
</tr>
<tr>
<td>[a..b]</td>
<td>closed(C, C)</td>
</tr>
<tr>
<td>[a..b)</td>
<td>closedOpen(C, C)</td>
</tr>
<tr>
<td>(a..b]</td>
<td>openClosed(C, C)</td>
</tr>
<tr>
<td>(a..+∞)</td>
<td>greaterThan(C)</td>
</tr>
<tr>
<td>[a..+∞)</td>
<td>atLeast(C)</td>
</tr>
<tr>
<td>(-∞..b)</td>
<td>lessThan(C)</td>
</tr>
<tr>
<td>(-∞..b]</td>
<td>atMost(C)</td>
</tr>
<tr>
<td>(-∞..+∞)</td>
<td>all()</td>
</tr>
</tbody>
</table>
<h3 id="RangeSet的视图"><a href="#RangeSet的视图" class="headerlink" title="RangeSet的视图"></a>RangeSet的视图</h3><table>
<thead>
<tr>
<th>方法名</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>complement()</td>
<td>返回RangeSet的补集视图</td>
</tr>
<tr>
<td>subRangeSet(Range<c>)</c></td>
<td>返回RangeSet与给定Range的交集视图</td>
</tr>
<tr>
<td>asRanges()</td>
<td>用Set<range<c>&gt;表现RangeSet，这样可以遍历其中的Range</range<c></td>
</tr>
<tr>
<td>asSet(DiscreteDomain<c>)（仅ImmutableRangeSet支持）</c></td>
<td>用ImmutableSortedSet<c>表现RangeSet，以区间中所有元素的形式而不是区间本身的形式查看（这个操作不支持DiscreteDomain 和RangeSet都没有上边界，或都没有下边界的情况）</c></td>
</tr>
</tbody>
</table>
<p>注：没有下边界(-∞..b]等</p>
<h3 id="RangeSet的查询方法"><a href="#RangeSet的查询方法" class="headerlink" title="RangeSet的查询方法"></a>RangeSet的查询方法</h3><table>
<thead>
<tr>
<th>方法名</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>contains(C)</td>
<td>RangeSet最基本的操作，判断RangeSet中是否有任何区间包含给定元素。</td>
</tr>
<tr>
<td>rangeContaining(C)</td>
<td>返回包含给定元素的区间；若没有这样的区间，则返回null。</td>
</tr>
<tr>
<td>encloses(Range<c>)</c></td>
<td>简单明了，判断RangeSet中是否有任何区间包括给定区间。</td>
</tr>
<tr>
<td>span()</td>
<td>返回包括RangeSet中所有区间的最小区间。</td>
</tr>
</tbody>
</table>
<h2 id="新集合类型-RangeMap"><a href="#新集合类型-RangeMap" class="headerlink" title="新集合类型-RangeMap"></a>新集合类型-RangeMap</h2><p>RangeMap描述了”不相交的、非空的区间”到特定值的映射<br>和RangeSet不同，RangeMap不会合并相邻的映射，即便相邻的区间映射到相同的值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">RangeMap&lt;Integer, String&gt; rangeMap = TreeRangeMap.create();</div><div class="line">rangeMap.put(Range.closed(<span class="number">1</span>, <span class="number">10</span>), <span class="string">"foo"</span>); <span class="comment">//&#123;[1,10] =&gt; "foo"&#125;</span></div><div class="line">rangeMap.put(Range.open(<span class="number">3</span>, <span class="number">6</span>), <span class="string">"bar"</span>); <span class="comment">//&#123;[1,3] =&gt; "foo", (3,6) =&gt; "bar", [6,10] =&gt; "foo"&#125;</span></div><div class="line">rangeMap.put(Range.open(<span class="number">10</span>, <span class="number">20</span>), <span class="string">"foo"</span>); <span class="comment">//&#123;[1,3] =&gt; "foo", (3,6) =&gt; "bar", [6,10] =&gt; "foo", (10,20) =&gt; "foo"&#125;</span></div><div class="line">rangeMap.remove(Range.closed(<span class="number">5</span>, <span class="number">11</span>)); <span class="comment">//&#123;[1,3] =&gt; "foo", (3,5) =&gt; "bar", (11,20) =&gt; "foo"&#125;</span></div><div class="line"></div><div class="line">System.out.println(rangeMap);</div></pre></td></tr></table></figure>
<blockquote>
<p>[[1..3]=foo, (3..5)=bar, (11..20)=foo]</p>
</blockquote>
<h3 id="RangeMap的视图"><a href="#RangeMap的视图" class="headerlink" title="RangeMap的视图"></a>RangeMap的视图</h3><table>
<thead>
<tr>
<th>方法名</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>asMapOfRanges()</td>
<td>用Map<range<k>, V&gt;表现RangeMap。这可以用来遍历RangeMap</range<k></td>
</tr>
<tr>
<td>subRangeMap(Range<k>)</k></td>
<td>用RangeMap类型返回RangeMap与给定Range的交集视图</td>
</tr>
</tbody>
</table>
<h2 id="强大的集合工具类：java-util-Collections中未包含的集合工具"><a href="#强大的集合工具类：java-util-Collections中未包含的集合工具" class="headerlink" title="强大的集合工具类：java.util.Collections中未包含的集合工具"></a>强大的集合工具类：java.util.Collections中未包含的集合工具</h2><p>任何对JDK集合框架有经验的程序员都熟悉和喜欢java.util.Collections包含的工具方法。Guava沿着这些路线提供了更多的工具方法：适用于所有集合的静态方法。这是Guava最流行和成熟的部分之一。</p>
<table>
<thead>
<tr>
<th>集合接口</th>
<th>属于JDK还是Guava</th>
<th>对应的Guava工具类</th>
</tr>
</thead>
<tbody>
<tr>
<td>Collection</td>
<td>JDK</td>
<td>Collections2：不要和java.util.Collections混淆</td>
</tr>
<tr>
<td>List</td>
<td>JDK</td>
<td>Lists</td>
</tr>
<tr>
<td>Set</td>
<td>JDK</td>
<td>Sets</td>
</tr>
<tr>
<td>SortedSet</td>
<td>JDK</td>
<td>Sets</td>
</tr>
<tr>
<td>Map</td>
<td>JDK</td>
<td>Maps</td>
</tr>
<tr>
<td>SortedMap</td>
<td>JDK</td>
<td>Maps</td>
</tr>
<tr>
<td>Queue</td>
<td>JDK</td>
<td>Queues</td>
</tr>
<tr>
<td>Multiset</td>
<td>Guava</td>
<td>Multisets</td>
</tr>
<tr>
<td>Multimap</td>
<td>Guava</td>
<td>Multimaps</td>
</tr>
<tr>
<td>BiMap</td>
<td>Guava</td>
<td>Maps</td>
</tr>
<tr>
<td>Table</td>
<td>Guava</td>
<td>Tables</td>
</tr>
</tbody>
</table>
<h3 id="静态工厂方法"><a href="#静态工厂方法" class="headerlink" title="静态工厂方法"></a>静态工厂方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//推断范型</span></div><div class="line">List&lt;String&gt; list = Lists.newArrayList();</div><div class="line"></div><div class="line"><span class="comment">//初始化时就指定起始元素</span></div><div class="line">List&lt;String&gt; theseElements = Lists.newArrayList(<span class="string">"alpha"</span>, <span class="string">"beta"</span>, <span class="string">"gamma"</span>);</div><div class="line">System.out.println(theseElements);</div><div class="line"></div><div class="line"><span class="comment">//提高集合初始化大小的可读性</span></div><div class="line">List&lt;Type&gt; exactly100 = Lists.newArrayListWithCapacity(<span class="number">100</span>);</div><div class="line">List&lt;Type&gt; approx100 = Lists.newArrayListWithExpectedSize(<span class="number">100</span>);</div><div class="line">Set&lt;Type&gt; approx100Set = Sets.newHashSetWithExpectedSize(<span class="number">100</span>);</div></pre></td></tr></table></figure>
<h3 id="Iterables"><a href="#Iterables" class="headerlink" title="Iterables"></a>Iterables</h3><p>在可能的情况下，Guava提供的工具方法更偏向于接受Iterable而不是Collection类型</p>
<h3 id="FluentIterable"><a href="#FluentIterable" class="headerlink" title="FluentIterable"></a>FluentIterable</h3><h3 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h3><h3 id="Sets"><a href="#Sets" class="headerlink" title="Sets"></a>Sets</h3><p>标准的集合运算（Set-Theoretic）方法,这些方法接受Set参数并返回SetView</p>
<p>SetView可用于：</p>
<ul>
<li>直接当作Set使用，因为SetView也实现了Set接口</li>
<li>用copyInto(Set)拷贝进另一个可变集合</li>
<li>用immutableCopy()对自己做不可变拷贝</li>
</ul>
<table>
<thead>
<tr>
<th>方法</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>union(Set, Set)</td>
<td>并集</td>
</tr>
<tr>
<td>intersection(Set, Set)</td>
<td>交集</td>
</tr>
<tr>
<td>difference(Set, Set)</td>
<td>差集</td>
</tr>
<tr>
<td>symmetricDifference(Set,   Set)</td>
<td>对称差集 </td>
</tr>
<tr>
<td>cartesianProduct(List<set>)</set></td>
<td>返回所有集合的笛卡儿积</td>
</tr>
<tr>
<td>powerSet(Set)</td>
<td>返回给定集合的所有子集</td>
</tr>
</tbody>
</table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">List&lt;Set&lt;String&gt;&gt; sets = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">HashSet&lt;String&gt; newHashSet = Sets.newHashSet(<span class="string">"a"</span>,<span class="string">"b"</span>);</div><div class="line">HashSet&lt;String&gt; newHashSet2 = Sets.newHashSet(<span class="string">"a"</span>,<span class="string">"c"</span>);</div><div class="line">sets.add(newHashSet);</div><div class="line">sets.add(newHashSet2);</div><div class="line"></div><div class="line"><span class="comment">//并集</span></div><div class="line">SetView&lt;String&gt; union = Sets.union(newHashSet,newHashSet2);</div><div class="line">System.out.println(<span class="string">"---Sets.union ---"</span>);</div><div class="line">System.out.println(union);</div><div class="line"></div><div class="line"><span class="comment">//交集</span></div><div class="line">SetView&lt;String&gt; intersection = Sets.intersection(newHashSet, newHashSet2);</div><div class="line">System.out.println(<span class="string">"---Sets.intersection ---"</span>);</div><div class="line">System.out.println(intersection);</div><div class="line"></div><div class="line"><span class="comment">//差集</span></div><div class="line">SetView&lt;String&gt; difference = Sets.difference(newHashSet, newHashSet2);</div><div class="line">System.out.println(<span class="string">"---Sets.difference ---"</span>);</div><div class="line">System.out.println(difference);</div><div class="line"></div><div class="line"><span class="comment">//对称差集 </span></div><div class="line">SetView&lt;String&gt; symmetricDifference = Sets.symmetricDifference(newHashSet,newHashSet2);</div><div class="line">System.out.println(<span class="string">"---Sets.symmetricDifference ---"</span>);</div><div class="line">System.out.println(symmetricDifference);</div><div class="line"></div><div class="line"><span class="comment">//笛卡尔积</span></div><div class="line">Set&lt;List&lt;String&gt;&gt; cartesianProduct = Sets.cartesianProduct(sets);</div><div class="line">System.out.println(<span class="string">"--- Sets.cartesianProduct ----"</span>);</div><div class="line"><span class="keyword">for</span>(List&lt;String&gt; list : cartesianProduct)&#123;</div><div class="line">    System.out.println(list);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//子集</span></div><div class="line">Set&lt;Set&lt;String&gt;&gt; powerSet = Sets.powerSet(newHashSet);</div><div class="line">System.out.println(<span class="string">"--- Sets.powerSet ----"</span>);</div><div class="line"><span class="keyword">for</span>(Set&lt;String&gt; set : powerSet)&#123;</div><div class="line">    System.out.println(set);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>—Sets.union —<br>[b, a, c]<br>—Sets.intersection —<br>[a]<br>—Sets.difference —<br>[b]<br>—Sets.symmetricDifference —<br>[b, c]<br>— Sets.cartesianProduct —-<br>[b, c]<br>[b, a]<br>[a, c]<br>[a, a]<br>— Sets.powerSet —-<br>[]<br>[b]<br>[a]<br>[b, a]</p>
</blockquote>
<h3 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h3><h1 id="参数校验"><a href="#参数校验" class="headerlink" title="参数校验"></a>参数校验</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Preconditions.checkArgument(ValidateUtil.isWaybillCode(waybillCode), <span class="string">"添加商品信息单号为"</span> + waybillCode + <span class="string">"不合法！"</span>);</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
            <tag> Guava </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Sublime Note]]></title>
      <url>http://xiaozhuang.github.io/2016/11/16/sublime_note/</url>
      <content type="html"><![CDATA[<p>Sublime Text：一款具有代码高亮、语法提示、自动完成且反应快速的编辑器软件，不仅具有华丽的界面，还支持插件扩展机制<br><a id="more"></a></p>
<h1 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h1><p>Ctrl + K + U：转大写<br>Ctrl + K + L：转小写</p>
<p>列选择 ：Shift + 鼠标右键<br>添加多光标编辑：Ctrl + 左键<br>相同文本编辑：Alt + F3</p>
<p>JSON格式化：Ctrl + Alt + F<br>代码合并单行：Ctrl + J</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Sublime </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Nodejs]]></title>
      <url>http://xiaozhuang.github.io/2016/11/15/nodejs/</url>
      <content type="html"><![CDATA[<p>Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境。Node.js 使用了一个事件驱动、非阻塞式 I/O 的模型，使其轻量又高效。Node.js 的包管理器 npm，是全球最大的开源库生态系统。<br><a id="more"></a></p>
<h1 id="使用cnpm-gzip-压缩支持-命令行工具代替默认的-npm"><a href="#使用cnpm-gzip-压缩支持-命令行工具代替默认的-npm" class="headerlink" title="使用cnpm (gzip 压缩支持) 命令行工具代替默认的 npm"></a>使用cnpm (gzip 压缩支持) 命令行工具代替默认的 npm</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装</span></div><div class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</div><div class="line"><span class="comment">#使用</span></div><div class="line">cnpm install [name]</div></pre></td></tr></table></figure>
<h1 id="安装bower"><a href="#安装bower" class="headerlink" title="安装bower"></a>安装bower</h1><p>Bower是一个客户端技术的软件包管理器，它可用于搜索、安装和卸载如JavaScript、HTML、CSS之类的网络资源</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">npm install -g bower</div><div class="line"></div><div class="line">bower install jquery --save</div><div class="line">bower install https://github.com/rochal/jQuery-slimScroll.git --save</div><div class="line"></div><div class="line"><span class="comment"># installs the project dependencies listed in bower.json</span></div><div class="line">$ bower install</div><div class="line"><span class="comment"># registered package</span></div><div class="line">$ bower install jquery</div><div class="line"><span class="comment"># GitHub shorthand</span></div><div class="line">$ bower install desandro/masonry</div><div class="line"><span class="comment"># Git endpoint</span></div><div class="line">$ bower install git://github.com/user/package.git</div><div class="line"><span class="comment"># URL</span></div><div class="line">$ bower install http://example.com/script.js</div></pre></td></tr></table></figure>
<h1 id="安装grunt"><a href="#安装grunt" class="headerlink" title="安装grunt"></a>安装grunt</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">npm install -g grunt-cli</div><div class="line"></div><div class="line"><span class="comment">#执行编译</span></div><div class="line">grunt</div><div class="line"></div><div class="line"><span class="comment">#监听文件变化</span></div><div class="line">grunt watch</div></pre></td></tr></table></figure>
<h1 id="npm初始化来创建package-json"><a href="#npm初始化来创建package-json" class="headerlink" title="npm初始化来创建package.json"></a>npm初始化来创建package.json</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 依据提示输入项目信息</span></div><div class="line">npm init</div></pre></td></tr></table></figure>
<h1 id="安装http-server"><a href="#安装http-server" class="headerlink" title="安装http-server"></a>安装http-server</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install http-server -g</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> NodeJS </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Sass & Compass]]></title>
      <url>http://xiaozhuang.github.io/2016/11/15/sass-compass/</url>
      <content type="html"><![CDATA[<p>Sass 是对 CSS 的扩展，让 CSS 语言更强大、优雅。 它允许你使用变量、嵌套规则、 mixins、导入等众多功能， 并且完全兼容 CSS 语法。<br>Compass is an open-source CSS Authoring Framework<br><a id="more"></a></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="更换rem-源"><a href="#更换rem-源" class="headerlink" title="更换rem 源"></a>更换rem 源</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#移除默认gem源</span></div><div class="line">gem <span class="built_in">source</span> -remove https://rubygems.org/</div><div class="line"><span class="comment">#添加国内gem源</span></div><div class="line">gem sources -a http://gems.ruby-china.org/</div><div class="line"><span class="comment">#查看gem源列表，确认是否修改成功</span></div><div class="line">gem sources -l</div></pre></td></tr></table></figure>
<h2 id="安装sass"><a href="#安装sass" class="headerlink" title="安装sass"></a>安装sass</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">gem install sass</div><div class="line"><span class="comment">#查看sass版本</span></div><div class="line">sass --v</div></pre></td></tr></table></figure>
<h2 id="安装compass"><a href="#安装compass" class="headerlink" title="安装compass"></a>安装compass</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">gem install compass</div><div class="line"><span class="comment">#查看compass版本</span></div><div class="line">compass -v</div></pre></td></tr></table></figure>
<h2 id="安装normalize"><a href="#安装normalize" class="headerlink" title="安装normalize"></a>安装normalize</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">gem install compass-normalize</div><div class="line"><span class="comment">#查看所有安装程序</span></div><div class="line">gem list</div></pre></td></tr></table></figure>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="Compass生成sourcemap"><a href="#Compass生成sourcemap" class="headerlink" title="Compass生成sourcemap"></a>Compass生成sourcemap</h2><p>config.rb添加sourcemap = true</p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><ul>
<li><a href="http://sass.bootcss.com/" title="SASS中文文档" target="_blank" rel="external">SASS中文文档</a></li>
<li><a href="http://www.w3cplus.com/sassguide/" title="SASS入门教程" target="_blank" rel="external">SASS入门教程</a></li>
<li><a href="http://compass-style.org/" title="Compass官网" target="_blank" rel="external">Compass官网</a>
</li>
</ul>
<h1 id="flexbox-布局"><a href="#flexbox-布局" class="headerlink" title="flexbox 布局"></a>flexbox 布局</h1><h1 id="SCSS"><a href="#SCSS" class="headerlink" title="SCSS"></a>SCSS</h1><h2 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="selector-class">.icon-detailed</span>&#123;</div><div class="line">	@<span class="keyword">extend</span> h1;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="输出方式"><a href="#输出方式" class="headerlink" title="输出方式"></a>输出方式</h1><p>嵌套输出方式 nested<br>展开输出方式 expanded<br>紧凑输出方式 compact<br>压缩输出方式 compressed</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Sass </tag>
            
            <tag> Compass </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Maven]]></title>
      <url>http://xiaozhuang.github.io/2016/11/10/maven-note/</url>
      <content type="html"><![CDATA[<p>Apache Maven is a software project management and comprehension tool.<br><a id="more"></a></p>
<h1 id="Maven命令"><a href="#Maven命令" class="headerlink" title="Maven命令"></a>Maven命令</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 清理</span></div><div class="line">mvn clean</div><div class="line"><span class="comment"># 清理并编译</span></div><div class="line">mvn clean compile</div><div class="line">mvn clean <span class="built_in">test</span></div><div class="line">mvn clean package</div><div class="line">mvn clean install</div><div class="line"><span class="comment"># 清理并发布（私服）</span></div><div class="line">mvn clean deploy</div><div class="line"><span class="comment"># 打包同时打源码包</span></div><div class="line">clean <span class="built_in">source</span>:jar package</div><div class="line"></div><div class="line"><span class="comment"># 跳过测试</span></div><div class="line">mvn package -Dmaven.test.skip=<span class="literal">true</span></div><div class="line">mvn package -D skipTests=<span class="literal">true</span></div></pre></td></tr></table></figure>
<h1 id="阿里云中央仓库"><a href="#阿里云中央仓库" class="headerlink" title="阿里云中央仓库"></a>阿里云中央仓库</h1><p>修改settings.xml，在mirrors节点下添加配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- maven阿里云中央仓库 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>        </div><div class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></div></pre></td></tr></table></figure>
<h1 id="scope标签"><a href="#scope标签" class="headerlink" title="scope标签"></a>scope标签</h1><ul>
<li>compile(默认) 需要参与当前项目的编译，打包时包含进去</li>
<li>test 仅仅参与测试相关的工作</li>
<li>provided 打包时不包含，运行时提供</li>
<li>system 参与度与provided相同，依赖项不从maven仓库取，从本地文件系统取</li>
<li>runtime 运行时依赖，编译时不需要</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;servlet-api-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h1 id="聚合和继承"><a href="#聚合和继承" class="headerlink" title="聚合和继承"></a>聚合和继承</h1><h2 id="依赖管理"><a href="#依赖管理" class="headerlink" title="依赖管理"></a>依赖管理</h2><p>可在父POM中dependencyManagement，<br>使用dependencyManagement声明的依赖不会引入依赖，也不会给子模块引入依赖</p>
<p>子模块中添加父POM在dependencyManagement中声明的依赖，只需要声明groupId 和 artifactId</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.juvenxu.mvnbook.account<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>account-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Account Parent<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">springframework.version</span>&gt;</span>2.5.6<span class="tag">&lt;/<span class="name">springframework.version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.7<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;springframework.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;springframework.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;springframework.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;springframework.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">pluginManagement</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.5<span class="tag">&lt;/<span class="name">source</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.5<span class="tag">&lt;/<span class="name">target</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-resources-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">pluginManagement</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.juvenxu.mvnbook.account<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>account-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../account-parent/pom.xml<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>account-email<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Account Email<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">javax.mail.version</span>&gt;</span>1.4.1<span class="tag">&lt;/<span class="name">javax.mail.version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">greenmail.version</span>&gt;</span>1.3.1b<span class="tag">&lt;/<span class="name">greenmail.version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>        </div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>           </div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>         </div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>         </div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.mail<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;javax.mail.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>       </div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.icegreen<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>greenmail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;greenmail.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<h1 id="依赖调节"><a href="#依赖调节" class="headerlink" title="依赖调节"></a>依赖调节</h1><ul>
<li>路径最近者优先</li>
<li>第一声明者优先（Version：2.0.9+）</li>
</ul>
<p>排除依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- Spring exclude commons-logging--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;springframework.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h1 id="优化依赖"><a href="#优化依赖" class="headerlink" title="优化依赖"></a>优化依赖</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 参看已解析的依赖</span></div><div class="line">mvn dependency:list</div><div class="line"></div><div class="line"><span class="comment"># 查看依赖树</span></div><div class="line">mvn dependency:tree</div><div class="line"></div><div class="line">idea的main工程的pom文件里右键-&gt;manve-&gt;show dependencies查看</div><div class="line"></div><div class="line"><span class="comment"># 依赖分析</span></div><div class="line"><span class="comment"># Used undeclared dependencies，项目中用到，但没有显示声明的依赖</span></div><div class="line"><span class="comment"># Unused declared dependencies，项目中未使用的依赖（只分析主代码和项目代码中依赖）</span></div><div class="line">mvn dependency:analyze</div></pre></td></tr></table></figure>
<h1 id="排除依赖"><a href="#排除依赖" class="headerlink" title="排除依赖"></a>排除依赖</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpmime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h1 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a>Issues</h1><h2 id="添加install本地仓库jar包报错"><a href="#添加install本地仓库jar包报错" class="headerlink" title="添加install本地仓库jar包报错"></a>添加install本地仓库jar包报错</h2><p>was cached in the local repository, resolution will not be reattempted until the update interval of</p>
<p>原因：<br>    install到本地仓库的jar包，其parent pom 既不在中央参考，又不在本地仓库</p>
<p>解决方法：<br>    parent pom install到本地仓库</p>
<h2 id="idea-找不到符号"><a href="#idea-找不到符号" class="headerlink" title="idea 找不到符号"></a>idea 找不到符号</h2><p>idea运行tomcat报错，”找不到符号”，报错类可以打开类文件<br>问题原因：<br>    idea maven无法加载jar包</p>
<p>解决办法：<br>    修改ideamaven配置，不使用默认配置</p>
<h2 id="web项目同时打jar和war"><a href="#web项目同时打jar和war" class="headerlink" title="web项目同时打jar和war"></a>web项目同时打jar和war</h2><p>Making both a War and Jar at the same time</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-a-jar<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div></pre></td></tr></table></figure>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[JavaScript Note]]></title>
      <url>http://xiaozhuang.github.io/2016/11/07/js-note/</url>
      <content type="html"><![CDATA[<p>web前端现在处于一个什么样的位置？<br>node侵占后台，ionic react侵占移动端，angular vue让前端分层，webGL攻入VR，unity支持js，nw.js侵入客户端。jquery bootstrap人人都会。<br><a id="more"></a></p>
<h1 id="Chrome调试"><a href="#Chrome调试" class="headerlink" title="Chrome调试"></a>Chrome调试</h1><h2 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h2><ul>
<li>F8    继续</li>
<li>F10    跳过</li>
<li>F11    跳入</li>
</ul>
<h1 id="Dom"><a href="#Dom" class="headerlink" title="Dom"></a>Dom</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 设置元素属性</span></div><div class="line"><span class="built_in">document</span>.getElementsByTagName(<span class="string">"INPUT"</span>)[<span class="number">0</span>].setAttribute(<span class="string">"type"</span>, <span class="string">"button"</span>)</div><div class="line"><span class="comment">// 或</span></div><div class="line"><span class="built_in">document</span>.getElementsByTagName(<span class="string">"INPUT"</span>)[<span class="number">0</span>].type = <span class="string">'button'</span></div></pre></td></tr></table></figure>
<h1 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h1><h2 id="转小写"><a href="#转小写" class="headerlink" title="转小写"></a>转小写</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> str=<span class="string">"Hello World!"</span></div><div class="line">str.toLowerCase();</div></pre></td></tr></table></figure>
<h1 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> a= <span class="keyword">new</span> <span class="built_in">Array</span>();</div><div class="line"></div><div class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</div><div class="line"><span class="comment">//删除元素</span></div><div class="line"><span class="comment">//arrayObject.splice(index,howmany,item1,.....,itemX)</span></div><div class="line"><span class="comment">//item1, ..., itemX	可选。向数组添加的新项目。</span></div><div class="line">arr.splice(<span class="number">0</span>,<span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="comment">//数组拷贝</span></div><div class="line"><span class="keyword">var</span> arr2 = arr.slice();</div><div class="line"></div><div class="line"><span class="comment">// 数组和并</span></div><div class="line"><span class="keyword">var</span> arr1 = [&#123;<span class="attr">name</span>:<span class="string">"wang"</span>&#125;];</div><div class="line"><span class="keyword">var</span> arr2 = [&#123;<span class="attr">name</span>:<span class="string">"sunday"</span>&#125;];</div><div class="line"><span class="keyword">var</span> arr3 = arr1.concat(arr2);</div><div class="line"><span class="built_in">console</span>.log(arr3);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 把数组中的所有元素放入一个字符串</span></div><div class="line"><span class="keyword">var</span> arr3_join = arr3.join(<span class="string">','</span>);</div><div class="line"></div><div class="line"><span class="comment">//向数组的末尾添加一个或多个元素，并返回新的长度</span></div><div class="line"><span class="keyword">var</span> push_r = arr.push(<span class="number">4</span>);</div><div class="line"><span class="comment">// 删除并返回数组的最后一个元素</span></div><div class="line"><span class="keyword">var</span> pop_r = arr.pop();</div></pre></td></tr></table></figure>
<h1 id="正则"><a href="#正则" class="headerlink" title="正则"></a>正则</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> url = <span class="string">"http://10.10.60.49:8080/app/entities/supportingplatformbuild201611/create?_masterpage=workreport/form_master"</span>;</div><div class="line"><span class="comment">//正则表达式使用\转义</span></div><div class="line"><span class="keyword">var</span> match_arr = url.match(<span class="regexp">/^.*\/entities\/[^/]+\//</span>);</div><div class="line"><span class="built_in">console</span>.log(match_arr[<span class="number">0</span>]);</div><div class="line"></div><div class="line"><span class="comment">//捕获</span></div><div class="line"><span class="keyword">var</span> re = <span class="regexp">/quick\s(brown).+?(jumps)/ig</span>;</div><div class="line"><span class="keyword">var</span> result = re.exec(<span class="string">'The Quick Brown Fox Jumps Over The Lazy Dog'</span>);</div><div class="line"><span class="built_in">console</span>.log(result[<span class="number">0</span>]);</div><div class="line"><span class="built_in">console</span>.log(result[<span class="number">1</span>]);</div></pre></td></tr></table></figure>
<blockquote>
<p><a href="http://10.10.60.49:8080/app/entities/supportingplatformbuild201611/" target="_blank" rel="external">http://10.10.60.49:8080/app/entities/supportingplatformbuild201611/</a><br>Quick Brown Fox Jumps<br>Brown</p>
</blockquote>
<h1 id="替换"><a href="#替换" class="headerlink" title="替换"></a>替换</h1><p>只能替换目标字符串中第一个匹配的字符串<br>stringObject.replace(regexp/substr,replacement)</p>
<p>replaceAll</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">str.replace(<span class="regexp">/word/g</span>,<span class="string">"Excel"</span>) ;</div><div class="line"></div><div class="line"><span class="comment">//g	执行全局匹配（查找所有匹配而非在找到第一个匹配后停止）</span></div><div class="line"><span class="comment">// m	执行多行匹配</span></div><div class="line"><span class="built_in">String</span>.prototype.replaceAll  = <span class="function"><span class="keyword">function</span>(<span class="params">s1,s2</span>)</span>&#123;     </div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(s1,<span class="string">"gm"</span>),s2);     </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="获取当前浏览器的地址"><a href="#获取当前浏览器的地址" class="headerlink" title="获取当前浏览器的地址"></a>获取当前浏览器的地址</h1><ul>
<li>document表示的是一个文档对象，window表示的是一个窗口对象，一个窗口下可以有多个文档对象。所以一个窗口下只有一个window.location.href，但是可能有多个document.URL、document.location.href</li>
<li>window.location.href和document.location.href可以被赋值，然后跳转到其它页面，document.URL只能读不能写<br>-document.location.href和document.location.replace都可以实现从A页面切换到B页面，区别是：<br>用document.location.href切换后，可以退回到原页面。<br>而用document.location.replace()切换后，不可以通过“后退”退回到原页面。</li>
</ul>
<h1 id="js字符串编码"><a href="#js字符串编码" class="headerlink" title="js字符串编码"></a>js字符串编码</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//encodeURI(),把字符串作为 URI 进行编码;</span></div><div class="line"><span class="comment">//decodeURI()</span></div><div class="line"><span class="built_in">encodeURI</span>(URIstring)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// encodeURIComponent(),把字符串作为 URI 组件进行编码</span></div><div class="line"><span class="comment">// decodeURIComponent()</span></div><div class="line"><span class="built_in">encodeURIComponent</span>(URIstring)</div><div class="line"></div><div class="line"><span class="comment">//总结</span></div><div class="line"><span class="comment">//encodeURI() 用于编码整个URI,因此URI中的合法字符都不会被编码转换。</span></div><div class="line"><span class="comment">//encodeURIComponent方法在编码单个URIComponent（指请求参 数）应当是最常用的，它可以讲参数中的中文、特殊字符进行转义，而不会影响整个URL。</span></div></pre></td></tr></table></figure>
<h1 id="指示对象自身属性中是否具有指定的属性"><a href="#指示对象自身属性中是否具有指定的属性" class="headerlink" title="指示对象自身属性中是否具有指定的属性"></a>指示对象自身属性中是否具有指定的属性</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">obj.hasOwnProperty(prop)</div></pre></td></tr></table></figure>
<h1 id="Json与对象转换"><a href="#Json与对象转换" class="headerlink" title="Json与对象转换"></a>Json与对象转换</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> obj = &#123;<span class="attr">id</span>:<span class="string">"7"</span>,<span class="attr">name</span>:<span class="string">"sunday"</span>&#125;;</div><div class="line"><span class="comment">//object转josn</span></div><div class="line"><span class="keyword">var</span> str = <span class="built_in">JSON</span>.stringify(obj);</div><div class="line"><span class="built_in">console</span>.log(str);</div><div class="line"><span class="comment">//josn转object</span></div><div class="line"><span class="keyword">var</span> obj2 = <span class="built_in">JSON</span>.parse(str);</div><div class="line"><span class="built_in">console</span>.log(obj2);</div></pre></td></tr></table></figure>
<h1 id="定时执行"><a href="#定时执行" class="headerlink" title="定时执行"></a>定时执行</h1><p>延迟执行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	alert(<span class="string">'2 seconds!'</span>);</div><div class="line">&#125;,<span class="number">1000</span>);</div><div class="line"></div><div class="line"><span class="comment">//取消定时</span></div><div class="line"><span class="keyword">var</span> timeout = setTimeout(<span class="string">"alert('5 seconds!')"</span>,<span class="number">5000</span>);</div><div class="line">clearTimeout(timeout);</div></pre></td></tr></table></figure>
<p>定时循环执行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 	定时循环执行</span></div><div class="line"><span class="keyword">var</span> i = <span class="number">3</span>;</div><div class="line"><span class="keyword">var</span> intervalID = <span class="built_in">window</span>.setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(i);</div><div class="line">	i-- ;</div><div class="line">	<span class="keyword">if</span>(i == <span class="number">0</span>)&#123;</div><div class="line">		clearTimeout(intervalID);</div><div class="line">	&#125;</div><div class="line">&#125;,<span class="number">1000</span>);</div></pre></td></tr></table></figure>
<h1 id="近似值"><a href="#近似值" class="headerlink" title="近似值"></a>近似值</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 四舍五入</span></div><div class="line"><span class="built_in">Math</span>.round(x)</div><div class="line"></div><div class="line"><span class="comment">// 进一法</span></div><div class="line"><span class="built_in">Math</span>.ceil(x)</div><div class="line"></div><div class="line"><span class="comment">// 去尾法</span></div><div class="line"><span class="built_in">Math</span>.floor(x)</div></pre></td></tr></table></figure>
<h1 id="Img-onerror"><a href="#Img-onerror" class="headerlink" title="Img onerror"></a>Img onerror</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure>
<h1 id="获取时间戳"><a href="#获取时间戳" class="headerlink" title="获取时间戳"></a>获取时间戳</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</div></pre></td></tr></table></figure>
<h1 id="打开下载链接"><a href="#打开下载链接" class="headerlink" title="打开下载链接"></a>打开下载链接</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">window</span>.open(url)</div></pre></td></tr></table></figure>
<h1 id="页面适应窗口"><a href="#页面适应窗口" class="headerlink" title="页面适应窗口"></a>页面适应窗口</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$(<span class="built_in">window</span>).resize(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    autoHeight();</div><div class="line">&#125;);</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">autoHeight</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    contentHei = $(<span class="built_in">window</span>).height();</div><div class="line">    $(<span class="string">'.page-sidebar'</span>).height(contentHei);</div><div class="line">    $(<span class="string">'.page-content'</span>).height(contentHei<span class="number">-20</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="scene"><a href="#scene" class="headerlink" title="scene"></a>scene</h1><p>图片加载文成时，设定图片宽高</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;img onload=<span class="string">"this.height = this.height;this.width = this.width;"</span> src=<span class="string">"IMG_1884.JPG"</span> title=<span class="string">"5646582724.png"</span>&gt;</div></pre></td></tr></table></figure>
<h1 id="阻止事件冒泡"><a href="#阻止事件冒泡" class="headerlink" title="阻止事件冒泡"></a>阻止事件冒泡</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//阻止事件冒泡</span></div><div class="line">e.stopPropagation();</div><div class="line"><span class="comment">//取消默认行为</span></div><div class="line">e.preventDefault();</div></pre></td></tr></table></figure>
<h1 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h1><p>函数外部无法读取函数内的局部变量。<br>定义在一个函数内部的函数。<br>在本质上，闭包就是将函数内部和函数外部连接起来的一座桥梁。</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL性能优化]]></title>
      <url>http://xiaozhuang.github.io/2016/11/06/mysql_optimization/</url>
      <content type="html"><![CDATA[<p>《性能优化之MySQL优化》课程学习笔记<br><a href="http://www.imooc.com/learn/194/" target="_blank" rel="external">http://www.imooc.com/learn/194/</a><br><a id="more"></a></p>
<h1 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h1><p>版本:MySQL5.5<br>实例数据库:sakila database(<a href="http://dev.mysql.com/doc/index-other.html" target="_blank" rel="external">http://dev.mysql.com/doc/index-other.html</a>)</p>
<h1 id="优化目的"><a href="#优化目的" class="headerlink" title="优化目的"></a>优化目的</h1><h2 id="避免出现页面错误"><a href="#避免出现页面错误" class="headerlink" title="避免出现页面错误"></a>避免出现页面错误</h2><ul>
<li>数据库连接超时</li>
<li>慢查询导致无法加载</li>
<li>阻塞造成数据无法提交</li>
</ul>
<h2 id="增加数据库稳定性"><a href="#增加数据库稳定性" class="headerlink" title="增加数据库稳定性"></a>增加数据库稳定性</h2><ul>
<li>很多数据库问题由于低效查询引起</li>
</ul>
<h2 id="优化用户体验"><a href="#优化用户体验" class="headerlink" title="优化用户体验"></a>优化用户体验</h2><ul>
<li>页面访问速度</li>
</ul>
<h1 id="优化途径"><a href="#优化途径" class="headerlink" title="优化途径"></a>优化途径</h1><p>成本：低  –&gt;  高<br>效果：高  –&gt;  低<br>SQL及索引 -&gt; 数据库表结构 -&gt; 系统配置 -&gt; 硬件</p>
<p>系统配置：linux打开文件数配置<br>硬件：CPU、内存、IO</p>
<h1 id="SQL及索引"><a href="#SQL及索引" class="headerlink" title="SQL及索引"></a>SQL及索引</h1><h2 id="发现有问题SQL"><a href="#发现有问题SQL" class="headerlink" title="发现有问题SQL"></a>发现有问题SQL</h2><h3 id="开启慢查询日志"><a href="#开启慢查询日志" class="headerlink" title="开启慢查询日志"></a>开启慢查询日志</h3><p>通过sql开启的慢查询日志，立即生效，重启后不再有效</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 查询日志配置</span></div><div class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'%log%'</span></div><div class="line"><span class="comment">-- 慢查询日志是否开启</span></div><div class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'slow_query_log'</span></div><div class="line"><span class="comment">-- 慢查询界定时间</span></div><div class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'long_query_time'</span></div><div class="line"></div><div class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slow_query_log_file=<span class="string">'e:\\mysql-5.7.11-winx64\\log\\mysql-slow.log'</span></div><div class="line"><span class="comment">-- set global slow_query_log_file='/usr/home/mysql/sql_log/mysql-slow.log'</span></div><div class="line"></div><div class="line"><span class="comment">-- 记录未使用索引的查询</span></div><div class="line"><span class="keyword">set</span> <span class="keyword">global</span> log_queries_not_using_indexes=<span class="keyword">on</span></div><div class="line"></div><div class="line"><span class="comment">-- 1s</span></div><div class="line"><span class="comment">-- 设置long_query_time后，查询获取的long_query_time没变；断开当前mysql回话，重新连接，查询获取的long_query_time，显示设置后值</span></div><div class="line"><span class="keyword">set</span> <span class="keyword">global</span> long_query_time=<span class="number">1</span></div><div class="line"></div><div class="line"><span class="comment">-- 开启慢查询日志</span></div><div class="line"><span class="keyword">set</span> <span class="keyword">global</span> slow_query_log=<span class="keyword">on</span></div><div class="line"></div><div class="line"><span class="comment">-- 测试慢查询日志记录</span></div><div class="line"><span class="keyword">select</span> <span class="keyword">sleep</span>(<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="comment">-- linux命令，查看日志：tail -50 /usr/home/mysql/sql_log/mysql-slow.log</span></div></pre></td></tr></table></figure>
<h3 id="日志内容"><a href="#日志内容" class="headerlink" title="日志内容"></a>日志内容</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">执行时间</div><div class="line"># Time: 2016-11-07T13:57:37.774253Z</div><div class="line">执行SQL的主机信息</div><div class="line"># User@Host: root[root] @ localhost [127.0.0.1]  Id:     3</div><div class="line">SQL执行信息</div><div class="line"># Query_time: 0.000000  Lock_time: 0.000000 Rows_sent: 12  Rows_examined: 108</div><div class="line">SQL内容</div><div class="line">use sakila;</div><div class="line">时间戳记录的执行时间</div><div class="line">SET timestamp=1478527057;</div></pre></td></tr></table></figure>
<h3 id="慢查询日志分析工具"><a href="#慢查询日志分析工具" class="headerlink" title="慢查询日志分析工具"></a>慢查询日志分析工具</h3><h4 id="mysqldumpslow"><a href="#mysqldumpslow" class="headerlink" title="mysqldumpslow"></a>mysqldumpslow</h4><p>官方提供，默认安装，统计信息较少</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./mysqldumpslow -t 10 /usr/<span class="built_in">local</span>/mysql-5.7.11-glibc2.5-i686/data/localhost-slow.log</div></pre></td></tr></table></figure>
<p>mysqldumpslow -h 查看帮助<br>-s 排序<br>-t 数量</p>
<h4 id="pt-query-digest"><a href="#pt-query-digest" class="headerlink" title="pt-query-digest"></a>pt-query-digest</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-query-digest /usr/<span class="built_in">local</span>/mysql-5.7.11-glibc2.5-i686/data/localhost-slow.log | more</div></pre></td></tr></table></figure>
<h3 id="通过慢查询日志发现有问题的SQL"><a href="#通过慢查询日志发现有问题的SQL" class="headerlink" title="通过慢查询日志发现有问题的SQL"></a>通过慢查询日志发现有问题的SQL</h3><h4 id="查询次数多且占用时间长的SQL"><a href="#查询次数多且占用时间长的SQL" class="headerlink" title="查询次数多且占用时间长的SQL"></a>查询次数多且占用时间长的SQL</h4><p>通常是pt-query-digest分析的前几个SQL</p>
<h4 id="IO大的SQL"><a href="#IO大的SQL" class="headerlink" title="IO大的SQL"></a>IO大的SQL</h4><p>pt-query-digest分析中Row examine项</p>
<h4 id="未命中索引的SQL"><a href="#未命中索引的SQL" class="headerlink" title="未命中索引的SQL"></a>未命中索引的SQL</h4><p>pt-query-digest分析中Row examine和Rows Send的对比</p>
<h1 id="分析SQL和优化"><a href="#分析SQL和优化" class="headerlink" title="分析SQL和优化"></a>分析SQL和优化</h1><p>使用explain，查询SQL的执行计划<br>数据库中，先进行执行计划分析，再进行查询<br>执行计划从侧面反映SQL执行效率</p>
<p>explain返回各列含义：</p>
<ul>
<li>table关于哪个表</li>
<li>type连接使用何种类型，最好到最差的连接类型<br>  const(主键、唯一索引)<br>  eq_ref(主键、唯一索引范围查找)<br>  ref(索引查找)<br>  range(有限制的索引扫描)<br>  index(全索引扫描，按索引次序扫描表)<br>  all(全表扫描)</li>
<li>possible_keys:可能应用的索引</li>
<li>key:实际使用的索引</li>
<li>key_len:使用索引的长度；不损失精确性的情况下，长度越短越好</li>
<li>ref：显示索引的哪一列被使用了，常数最好</li>
<li>rows：表扫描的行数</li>
<li>Extra：<br>  Using filesort：查询需要优化；用到了文件排序，order by从句常见<br>  Using temporary：查询需要优化；对结果排序时用到了临时表，通常发生在对不同列集进行order by上<br>  Using index: 使用覆盖索引<br>  Using where：MySQL服务器在存储引擎检索行后再进行过滤</li>
</ul>
<h1 id="SQL语句优化"><a href="#SQL语句优化" class="headerlink" title="SQL语句优化"></a>SQL语句优化</h1><h2 id="优化Count-和-Max"><a href="#优化Count-和-Max" class="headerlink" title="优化Count() 和 Max()"></a>优化Count() 和 Max()</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">MAX</span>(<span class="string">`payment_date`</span>) <span class="keyword">FROM</span> <span class="string">`payment`</span></div><div class="line"></div><div class="line"><span class="comment">--  在payment_date列，创建索引;</span></div><div class="line"><span class="comment">-- 创建索引后，能够进通过所以查询到结果</span></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_paydate <span class="keyword">ON</span> payment(<span class="string">`payment_date`</span>)</div><div class="line"></div><div class="line"><span class="comment">-- 查询年份为2006的电影；</span></div><div class="line"><span class="comment">-- `year` = '2016'进行计数，否则返回NULL,count函数不对NULL进行计数</span></div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="string">`year`</span> = <span class="string">'2016'</span> <span class="keyword">OR</span> <span class="literal">NULL</span>) <span class="keyword">FROM</span> t</div></pre></td></tr></table></figure>
<h2 id="子查询优化"><a href="#子查询优化" class="headerlink" title="子查询优化"></a>子查询优化</h2><p>子查询优化为连接查询(join)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="string">`id`</span>,<span class="string">`year`</span> <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> <span class="keyword">id</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> t_id <span class="keyword">FROM</span> t1)</div><div class="line"></div><div class="line"><span class="keyword">SELECT</span> t.<span class="string">`id`</span>,t.<span class="string">`year`</span> <span class="keyword">FROM</span> t <span class="keyword">JOIN</span> t1 <span class="keyword">ON</span> t1.t_id = t.<span class="string">`id`</span></div><div class="line"><span class="comment">-- 存在一对多关系时，查询结果可能存在重复行，使用DISTINCT函数去重</span></div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> t.<span class="string">`id`</span>,t.<span class="string">`year`</span> <span class="keyword">FROM</span> t <span class="keyword">JOIN</span> t1 <span class="keyword">ON</span> t1.t_id = t.<span class="string">`id`</span></div></pre></td></tr></table></figure>
<h2 id="优化limit"><a href="#优化limit" class="headerlink" title="优化limit"></a>优化limit</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- type：All，Extra：Using filesort</span></div><div class="line"><span class="comment">-- 扫描1000行，使用文件排序</span></div><div class="line"><span class="keyword">SELECT</span> <span class="string">`film_id`</span>,<span class="string">`description`</span> <span class="keyword">FROM</span> <span class="string">`film`</span></div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`title`</span> <span class="keyword">LIMIT</span> <span class="number">50</span>,<span class="number">5</span></div><div class="line"></div><div class="line"><span class="comment">-- 使用有索引的列或主键进行order by</span></div><div class="line"><span class="comment">-- type：index</span></div><div class="line"><span class="comment">-- 扫描55行，随之查询靠后，扫描行数变多，效率降低</span></div><div class="line"><span class="keyword">SELECT</span> <span class="string">`film_id`</span>,<span class="string">`description`</span> <span class="keyword">FROM</span> <span class="string">`film`</span></div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`film_id`</span> <span class="keyword">LIMIT</span> <span class="number">50</span>,<span class="number">5</span></div><div class="line"></div><div class="line"><span class="comment">-- 使用主键过滤，避免数据量大时扫描过多的记录</span></div><div class="line"><span class="comment">-- 优化后，扫描行数仅为5行，效率固定</span></div><div class="line"><span class="comment">-- 依赖主键连续</span></div><div class="line"><span class="comment">-- 如果主键不连续，可以添加附加列(如：index_id)，保证附加列连续，并为附加列添加索引</span></div><div class="line"><span class="keyword">SELECT</span> <span class="string">`film_id`</span>,<span class="string">`description`</span></div><div class="line"><span class="keyword">FROM</span> <span class="string">`film`</span></div><div class="line"><span class="keyword">WHERE</span> <span class="string">`film_id`</span> &gt; <span class="number">50</span> <span class="keyword">AND</span> <span class="string">`film_id`</span> &lt;= <span class="number">55</span></div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`film_id`</span> <span class="keyword">LIMIT</span> <span class="number">1</span>,<span class="number">5</span></div></pre></td></tr></table></figure>
<h1 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h1><p>通常为where、group by、order by、on从句中使用列添加索引<br>有时会在select从句中添加索引</p>
<p>索引包含查询中所有列，称为覆盖索引，查询通过索引的获取数据，不用查询表<br>对使用频率高，包含列较少的查询，可使用覆盖索引进行优化</p>
<p>索引字段，越小越好（数据库中，数据以页为单位存储，一页中存储的数据越多，一次IO获取的数据量越大，IO效率越好）</p>
<h2 id="联合索引优化"><a href="#联合索引优化" class="headerlink" title="联合索引优化"></a>联合索引优化</h2><p>联合索引，离散度高的列，放在联合索引的前面</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 离散度判断</span></div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="string">`customer_id`</span>),<span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="string">`staff_id`</span>)</div><div class="line"><span class="keyword">FROM</span> <span class="string">`payment`</span></div></pre></td></tr></table></figure>
<h2 id="重复及冗余索引"><a href="#重复及冗余索引" class="headerlink" title="重复及冗余索引"></a>重复及冗余索引</h2><p>查询分析时需要分析使用哪一索引进行查询，索引越多，分析越慢</p>
<p>重复索引：相同列以相同顺序建立的同类型的索引；如primary key和Id列上唯一索引，主键已经是唯一索引。<br>冗余索引：多个索引的前缀相同或联合索引中包含了主键索引；Innodb特性：每个索引都会附加主键，如果联合索引添加了主键，则冗余。</p>
<h3 id="使用工具分析重复和冗余索引"><a href="#使用工具分析重复和冗余索引" class="headerlink" title="使用工具分析重复和冗余索引"></a>使用工具分析重复和冗余索引</h3><p>pt-duplicate-key-checker<br>安装pt-query-digest之后，可以使用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">pt-duplicate-key-checker -uroot -p <span class="string">'123456'</span> -h 127.0.0.1</div><div class="line"></div><div class="line">pt-duplicate-key-checker -uroot -p <span class="string">'123456'</span> -h 127.0.0.1 --database=sakilapt</div></pre></td></tr></table></figure>
<h3 id="删除不用的索引"><a href="#删除不用的索引" class="headerlink" title="删除不用的索引"></a>删除不用的索引</h3><p>通过慢查询日志配合pt-index-usage工具进行索引使用情况的分析</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-index-usage -uroot -p <span class="string">'123456'</span> --host 127.0.0.1 /usr/<span class="built_in">local</span>/mysql-5.7.11-glibc2.5-i686/data/localhost-slow.log</div></pre></td></tr></table></figure>
<h1 id="表结构优化"><a href="#表结构优化" class="headerlink" title="表结构优化"></a>表结构优化</h1><p>选择合适的数据类型</p>
<ul>
<li>选择可以存下数据的最小的数据类型</li>
<li>使用简单的数据类型（int比varchar类型简单）</li>
<li>尽可能的使用not null定义字段，并设定默认值（Innodb存储特性，对非not null字段需要额外存储）</li>
<li>尽少使用text类型，非用不可最好分表，通过附加表的方式，提高主表查询效率</li>
</ul>
<h2 id="使用int存储时间"><a href="#使用int存储时间" class="headerlink" title="使用int存储时间"></a>使用int存储时间</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 日期转int</span></div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">UNIX_TIMESTAMP</span>(<span class="string">'2014-06-01 13:12:00'</span>)</div><div class="line"></div><div class="line"><span class="comment">-- int转日期</span></div><div class="line"><span class="keyword">SELECT</span> FROM_UNIXTIME(<span class="string">'1401599520'</span>)</div></pre></td></tr></table></figure>
<h2 id="ip地址存储"><a href="#ip地址存储" class="headerlink" title="ip地址存储"></a>ip地址存储</h2><p>使用bigint存储IP地址，节省空间，查询高效<br>varchar：15字节<br>bigint：7字节</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">INET_ATON</span>(<span class="string">'10.10.60.149'</span>)</div><div class="line"></div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">INET_NTOA</span>(<span class="string">'168443029'</span>)</div></pre></td></tr></table></figure>
<h1 id="范式化"><a href="#范式化" class="headerlink" title="范式化"></a>范式化</h1><p>目前范式化一般指第三范式<br>要求数据表中不存在非关键字段对任意候选关键字段的传递函数依赖</p>
<p>如：<br>    商品名称 -&gt; 分类 -&gt; 分类描述</p>
<p>不满足第三范式，存在的问题：<br>    1.数据冗余<br>    2.插入异常(添加没有商品分类)<br>    3.更新异常(更新分类，更新多列)<br>    4.删除异常(删除全部商品，同时删除了分类)</p>
<p>解决方法：<br>拆分表，产品、分类、关系</p>
<h1 id="反范式化"><a href="#反范式化" class="headerlink" title="反范式化"></a>反范式化</h1><p>反范式化指为提高查询效率，把原本符合第三范式的表适当的增加冗余，已达到优化查询效率的目的。<br>反范式化是一种以空间换取时间的操作。</p>
<h1 id="表垂直拆分"><a href="#表垂直拆分" class="headerlink" title="表垂直拆分"></a>表垂直拆分</h1><p>垂直拆分：把原来一个有很多列的表拆分成多个表，解决表的宽度问题。</p>
<p>垂直拆分原则：</p>
<ul>
<li>不常用的字段单独一个表</li>
<li>大字段单独一个表</li>
<li>经常一起使用的字段放到一起</li>
</ul>
<h1 id="水平拆分"><a href="#水平拆分" class="headerlink" title="水平拆分"></a>水平拆分</h1><p>水平拆分解决单表数据量过大的问题，水平拆分的表每一个表的结构都完全一致。</p>
<p>常用方法：<br>    对id进行hash运算，不同的hashID存到不同的表中。</p>
<p>挑战：<br>    跨分区表进行数据查询<br>    统计及后台报表操作（前台业务使用拆分表，后台业务使用汇总表查询）</p>
<h1 id="系统配置优化"><a href="#系统配置优化" class="headerlink" title="系统配置优化"></a>系统配置优化</h1><h2 id="网络方面配置"><a href="#网络方面配置" class="headerlink" title="网络方面配置"></a>网络方面配置</h2><p>/etc/sysctl.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#增加tcp支持的队列数</div><div class="line">net.ipv4.tcp_max_syn_backlog = 65535</div><div class="line">#减少断开连接时，资源回收</div><div class="line">net.ipv4.tcp_max_tw_buckets = 8000</div><div class="line">net.ipv4.tcp_tw_reuse = 1</div><div class="line">net.ipv4.tcp_fin_timeout = 10</div></pre></td></tr></table></figure>
<h2 id="修改打开文件数限制"><a href="#修改打开文件数限制" class="headerlink" title="修改打开文件数限制"></a>修改打开文件数限制</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查看目录打开文件数</span></div><div class="line"><span class="built_in">ulimit</span> -a</div></pre></td></tr></table></figure>
<p>修改/etc/security/limits.conf<br>添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">* soft nofile 65535 </div><div class="line">* hard nofile 65535</div></pre></td></tr></table></figure>
<p>注：<br>soft nofile：单个用户可用的最大进程数量(软限制)<br>hard nofile：单个用户可用的最大进程数量(硬限制)</p>
<h2 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><p>关闭iptables、selinux等防火墙软件，使用硬件防火墙代替</p>
<h1 id="MySQL配置优化"><a href="#MySQL配置优化" class="headerlink" title="MySQL配置优化"></a>MySQL配置优化</h1><p>MySQL查找配置文件的顺序<br>如果在多个位置存在配置文件，后面的会覆盖前面的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/<span class="built_in">local</span>/mysql/bin/mysqld --verbose --<span class="built_in">help</span> | grep -A 1 <span class="string">'Default options'</span></div></pre></td></tr></table></figure>
<h2 id="常用参数"><a href="#常用参数" class="headerlink" title="常用参数"></a>常用参数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">#innodb缓冲池大小，推荐配置总内存75%</div><div class="line">innodb_buffer_pool_size=128M</div><div class="line"></div><div class="line">#5.5新增配置，innodb缓冲池个数</div><div class="line">innodb_buffer_pool_instances=4</div><div class="line"></div><div class="line">#innodb log缓冲大小</div><div class="line">innodb_log_buffer_size=4M</div><div class="line"></div><div class="line">#数据库多长时间刷新到磁盘</div><div class="line">#1:每次提交刷新到磁盘,保证事务部丢失；</div><div class="line">#2:每次提交刷新到缓冲区，每一秒钟，把缓冲区刷新到磁盘</div><div class="line">#0:每次提交不刷新，每一秒钟刷新到磁盘</div><div class="line">#为了更好IO性能，推荐2</div><div class="line">innodb_flush_logs_at_trx_commit=2</div></pre></td></tr></table></figure>
<h1 id="Fragments"><a href="#Fragments" class="headerlink" title="Fragments"></a>Fragments</h1><h2 id="MySQL-4种int类型"><a href="#MySQL-4种int类型" class="headerlink" title="MySQL 4种int类型"></a>MySQL 4种int类型</h2><ul>
<li>bigint    从 -2^63 (-9223372036854775808) 到 2^63-1 (9223372036854775807) 的整型数据（所有数字）。存储大小为 8 个字节。</li>
<li>int    从-2^31 (-2,147,483,648) 到 2^31 – 1 (2,147,483,647) 的整型数据（所有数字）。存储大小为 4 个字节</li>
<li>smallint    从 -2^15 (-32,768) 到 2^15 – 1 (32,767) 的整型数据。存储大小为 2 个字节。</li>
<li>tinyint    带符号的范围是-128到127。无符号的范围是0到255。存储大小为 1 字节。</li>
</ul>
<h2 id="向日期添加指定的时间间隔"><a href="#向日期添加指定的时间间隔" class="headerlink" title="向日期添加指定的时间间隔"></a>向日期添加指定的时间间隔</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">date_add</span>(<span class="keyword">now</span>(), <span class="built_in">interval</span> <span class="number">1</span> <span class="keyword">day</span>); <span class="comment">--加1天</span></div><div class="line"><span class="keyword">select</span> <span class="keyword">date_add</span>(<span class="keyword">now</span>(), <span class="built_in">interval</span> <span class="number">1</span> <span class="keyword">hour</span>); <span class="comment">--加1小时</span></div><div class="line"><span class="keyword">select</span> <span class="keyword">date_add</span>(<span class="keyword">now</span>(), <span class="built_in">interval</span> <span class="number">1</span> <span class="keyword">minute</span>); <span class="comment">--加1分钟</span></div><div class="line"><span class="keyword">select</span> <span class="keyword">date_add</span>(<span class="keyword">now</span>(), <span class="built_in">interval</span> <span class="number">1</span> <span class="keyword">second</span>); <span class="comment">--加1秒</span></div><div class="line"><span class="keyword">select</span> <span class="keyword">date_add</span>(<span class="keyword">now</span>(), <span class="built_in">interval</span> <span class="number">1</span> <span class="keyword">microsecond</span>); <span class="comment">--加1毫秒</span></div><div class="line"><span class="keyword">select</span> <span class="keyword">date_add</span>(<span class="keyword">now</span>(), <span class="built_in">interval</span> <span class="number">1</span> <span class="keyword">week</span>); <span class="comment">--加1周</span></div><div class="line"><span class="keyword">select</span> <span class="keyword">date_add</span>(<span class="keyword">now</span>(), <span class="built_in">interval</span> <span class="number">1</span> <span class="keyword">month</span>); <span class="comment">--加1月</span></div><div class="line"><span class="keyword">select</span> <span class="keyword">date_add</span>(<span class="keyword">now</span>(), <span class="built_in">interval</span> <span class="number">1</span> <span class="keyword">quarter</span>); <span class="comment">--加1季</span></div><div class="line"><span class="keyword">select</span> <span class="keyword">date_add</span>(<span class="keyword">now</span>(), <span class="built_in">interval</span> <span class="number">1</span> <span class="keyword">year</span>); <span class="comment">--加1年</span></div><div class="line"></div><div class="line"><span class="keyword">select</span> <span class="keyword">date_add</span>(<span class="keyword">now</span>(), <span class="built_in">interval</span> <span class="number">-1</span> <span class="keyword">year</span>); <span class="comment">--减1年</span></div></pre></td></tr></table></figure>
<h2 id="同一张表，两个TIMESTAMP字段，表创建报错"><a href="#同一张表，两个TIMESTAMP字段，表创建报错" class="headerlink" title="同一张表，两个TIMESTAMP字段，表创建报错"></a>同一张表，两个TIMESTAMP字段，表创建报错</h2><p>MySQL5.6可以创建多个timestamps字段（未验证）<br><a href="http://stackoverflow.com/questions/4851672/one-mysql-table-with-multiple-timestamp-columns" target="_blank" rel="external">http://stackoverflow.com/questions/4851672/one-mysql-table-with-multiple-timestamp-columns</a><br>With MySQL 5.6.5 multiple timestamps can be independently controlled in one table so the rules for this have changed.</p>
<p>MySQL5.7.11，无法创建两个timestamps字段<br>In addition, you can initialize or update any TIMESTAMP column to the current date and time by assigning it a NULL value, unless it has been defined with the NULL attribute to permit NULL values.</p>
<h1 id="数据库事务"><a href="#数据库事务" class="headerlink" title="数据库事务"></a>数据库事务</h1><p>数据库事务具备ACID特征</p>
<ul>
<li>原子性</li>
<li>一致性</li>
<li>隔离性</li>
<li>持久性</li>
</ul>
<h1 id="Innodb中的事务隔离级别和锁"><a href="#Innodb中的事务隔离级别和锁" class="headerlink" title="Innodb中的事务隔离级别和锁"></a>Innodb中的事务隔离级别和锁</h1><p>InnoDB存储引擎既支持行级锁（row-level locking），也支持表级锁，但默认情况下是采用行级锁。</p>
<blockquote>
<p>数据库为了维护这些性质，尤其是一致性和隔离性，一般使用加锁这种方式。</p>
</blockquote>
<h2 id="两段锁"><a href="#两段锁" class="headerlink" title="两段锁"></a>两段锁</h2><p>数据库遵循的是两段锁协议，将事务分成两个阶段，<code>加锁阶段</code>和<code>解锁阶段</code>（所以叫两段锁）。<br>加锁阶段：在该阶段可以进行加锁操作。<br>在对任何数据进行读操作之前要申请并获得S锁（共享锁，其它事务可以继续加共享锁，但不能加排它锁）;<br>在进行写操作之前要申请并获得X锁（排它锁，其它事务不能再获得任何锁）。<br>加锁不成功，则事务进入等待状态，直到加锁成功才继续执行。<br>解锁阶段：当事务释放了一个封锁以后，事务进入解锁阶段，在该阶段只能进行解锁操作不能再进行加锁操作。</p>
<table>
<thead>
<tr>
<th>事务</th>
<th>加锁/解锁处理</th>
</tr>
</thead>
<tbody>
<tr>
<td>begin;</td>
<td></td>
</tr>
<tr>
<td>insert into test …..</td>
<td>加insert对应的锁</td>
</tr>
<tr>
<td>update test set…</td>
<td>加update对应的锁</td>
</tr>
<tr>
<td>delete from test ….</td>
<td>加delete对应的锁</td>
</tr>
<tr>
<td>commit;</td>
<td></td>
</tr>
</tbody>
</table>
<p>两段锁协议可以保证事务的并发调度是串行化的。</p>
<h2 id="事务的四种隔离级别"><a href="#事务的四种隔离级别" class="headerlink" title="事务的四种隔离级别"></a>事务的四种隔离级别</h2><p>效保证并发读取数据的正确性，提出的事务隔离级别。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">-- 查看当前会话隔离级别</span></div><div class="line"><span class="keyword">select</span> @@tx_isolation;</div><div class="line"></div><div class="line"><span class="comment">-- 查看系统当前隔离级别</span></div><div class="line"><span class="keyword">select</span> @@global.tx_isolation;</div><div class="line"></div><div class="line"><span class="comment">-- 设置当前会话隔离级别</span></div><div class="line"><span class="keyword">set</span> <span class="keyword">session</span> <span class="keyword">transaction</span> isolatin <span class="keyword">level</span> repeatable <span class="keyword">read</span>;</div><div class="line"><span class="comment">-- 设置系统当前隔离级别</span></div><div class="line"><span class="keyword">set</span> <span class="keyword">global</span> <span class="keyword">transaction</span> <span class="keyword">isolation</span> <span class="keyword">level</span> repeatable <span class="keyword">read</span>;</div></pre></td></tr></table></figure>
<h2 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a>悲观锁</h2><p>SELECT … LOCK IN SHARE MODE</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">parent</span> <span class="keyword">WHERE</span> <span class="keyword">NAME</span> = <span class="string">'Jones'</span> <span class="keyword">LOCK</span> <span class="keyword">IN</span> <span class="keyword">SHARE</span> <span class="keyword">MODE</span>;</div></pre></td></tr></table></figure>
<p>SELECT … FOR UPDATE</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> counter_field <span class="keyword">FROM</span> child_codes <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</div><div class="line"><span class="keyword">UPDATE</span> child_codes <span class="keyword">SET</span> counter_field = counter_field + <span class="number">1</span>;</div></pre></td></tr></table></figure>
<h1 id="字段类型"><a href="#字段类型" class="headerlink" title="字段类型"></a>字段类型</h1><h2 id="tinyint"><a href="#tinyint" class="headerlink" title="tinyint"></a>tinyint</h2><p>tinyint存储只是用一个字节,就是8位,只能存储2^8个数字,也就是256个数字,<br>在mysql实现中,有符号是-128-127,无符号是0-255</p>
<p>tinyint后面的括号带的数字,以后称之为M,<br>和存贮的值没有任何关系,只是在某些情况下和显示的宽度有关系</p>
<p>M其实没用,tinyint默认是4,其余的也有默认值,以后程序开发中,<br>涉及整形数字的M时,可以不必纠结,直接忽略,最后使用数据库默认的M值即可</p>
<h1 id="ICP"><a href="#ICP" class="headerlink" title="ICP"></a>ICP</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">set</span> @@optimizer_switch = <span class="string">"index_condition_pushdown=on"</span></div><div class="line"></div><div class="line"><span class="keyword">set</span> @@optimizer_switch = <span class="string">"index_condition_pushdown=off"</span></div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[C++]]></title>
      <url>http://xiaozhuang.github.io/2016/11/04/cpp/</url>
      <content type="html"><![CDATA[<p>C++ 复习笔记<br><a id="more"></a></p>
<h1 id="Visual-Studio"><a href="#Visual-Studio" class="headerlink" title="Visual Studio"></a>Visual Studio</h1><p>F11 调试运行</p>
<h1 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"请输入一个整数"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">	<span class="comment">//变量定义</span></div><div class="line">	<span class="keyword">int</span> x = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="built_in">cin</span> &gt;&gt; x;</div><div class="line">	<span class="comment">//分别以八进制、十进制、十六进制输出</span></div><div class="line">	<span class="built_in">cout</span> &lt;&lt; oct &lt;&lt; x &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">	<span class="built_in">cout</span> &lt;&lt; dec &lt;&lt; x &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">	<span class="built_in">cout</span> &lt;&lt; hex &lt;&lt; x &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"请输入一个布尔值（0或1）:"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">	<span class="keyword">bool</span> y = <span class="literal">false</span>;</div><div class="line">	<span class="built_in">cin</span> &gt;&gt; y;</div><div class="line"></div><div class="line">	<span class="comment">//输出布尔值</span></div><div class="line">	<span class="built_in">cout</span> &lt;&lt; boolalpha &lt;&lt; y &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">	system(<span class="string">"pause"</span>);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="指针、取地址符、解引用、常亮"><a href="#指针、取地址符、解引用、常亮" class="headerlink" title="指针、取地址符、解引用、常亮"></a>指针、取地址符、解引用、常亮</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="keyword">int</span> a = <span class="number">1</span>;</div><div class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"a的值为："</span> &lt;&lt; a &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">	<span class="comment">//定义a的指针p,指针语法*变量名</span></div><div class="line">	<span class="comment">//&amp;为取地址符</span></div><div class="line">	<span class="keyword">int</span>* p = &amp;a; </div><div class="line">	<span class="comment">//通过指针改变指针指向的变量</span></div><div class="line">	*p = <span class="number">2</span>;</div><div class="line">	<span class="comment">//通过指针访问变量，*为解引用操作符</span></div><div class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"通过a的指针访问获取a:"</span> &lt;&lt; *p &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="comment">//常量,b的值不可变</span></div><div class="line">	<span class="keyword">const</span> <span class="keyword">int</span> b = <span class="number">2</span>;</div><div class="line">	<span class="comment">//b=3;	//编译器提示错误，b为常量</span></div><div class="line"></div><div class="line"></div><div class="line">	<span class="keyword">int</span> c = <span class="number">3</span>;</div><div class="line">	<span class="comment">//指针指向常量，即不能通过*p2改变p2指向的变量</span></div><div class="line">	<span class="comment">//p2是可以改变的</span></div><div class="line">	<span class="keyword">const</span> <span class="keyword">int</span>* p2 = &amp;c;</div><div class="line">	<span class="comment">//*p2 = 4;	//编译器提示错误</span></div><div class="line">	<span class="keyword">int</span> d = <span class="number">4</span>;</div><div class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"当前p2指向c，值为："</span>&lt;&lt; *p2 &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">	<span class="comment">//改变p2，让p2指向d</span></div><div class="line">	p2 = &amp;d;</div><div class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"当前p2指向d，值为："</span>&lt;&lt; *p2 &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="keyword">int</span> e = <span class="number">5</span>;</div><div class="line">	<span class="comment">//指针常量,指针自身为常量，该指针不能指向其他变量</span></div><div class="line">	<span class="keyword">int</span>* <span class="keyword">const</span> p3 = &amp;e;</div><div class="line">	<span class="comment">//p3  = &amp;d;		//编译报错</span></div><div class="line"></div><div class="line">	</div><div class="line">	</div><div class="line">	<span class="keyword">int</span> f = <span class="number">6</span>;</div><div class="line">	<span class="comment">//指向常量的，指针常量</span></div><div class="line">	<span class="keyword">const</span> <span class="keyword">int</span>* <span class="keyword">const</span> p4 = &amp;f;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> x = <span class="number">10</span>;</div><div class="line">	<span class="keyword">int</span>* <span class="keyword">const</span> &amp;rx = &amp;x;</div><div class="line"></div><div class="line">	<span class="built_in">cout</span> &lt;&lt; *rx;</div><div class="line"></div><div class="line"></div><div class="line">	system(<span class="string">"pause"</span>);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="对象实例化"><a href="#对象实例化" class="headerlink" title="对象实例化"></a>对象实例化</h2><p>两种方式：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//静态分配内存</span></div><div class="line">A aa;				<span class="comment">//在栈(stack)上分配空间</span></div><div class="line">aa.xxx();</div><div class="line"></div><div class="line"><span class="comment">//动态分配内存</span></div><div class="line">B* b = <span class="keyword">new</span> B();	<span class="comment">//在堆(heap)上分配空间</span></div><div class="line">aa-&gt;xxx();		<span class="comment">//两种方式，函数调用方式不同</span></div></pre></td></tr></table></figure>
<p>栈上空间自动回收，堆空间需要程序员手动回收</p>
<p>静态分配内存适合于编译时就已经可以确定需要占用内存多少的情况，而在编译时不能确定内存需求量时可使用动态分配内存</p>
<h2 id="构造函数和析构函数"><a href="#构造函数和析构函数" class="headerlink" title="构造函数和析构函数"></a>构造函数和析构函数</h2><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><p>派生类构造函数调用顺序</p>
<p>父类 -&gt; 子对象 -&gt; 本类<br>多个子对象，构造函数按声明顺序调用</p>
<h3 id="析构函数"><a href="#析构函数" class="headerlink" title="析构函数"></a>析构函数</h3><p>与构造函数调用顺序相反</p>
<p>如果定义了一个全局对象，则在程序的流程离开其作用域时(如main函数结束或调用exit函数) 时，调用该全局对象的析构函数。</p>
<h2 id="const"><a href="#const" class="headerlink" title="const"></a>const</h2><p>const 是constant 的缩写，“恒定不变”的意思</p>
<h3 id="用const-修饰函数的参数"><a href="#用const-修饰函数的参数" class="headerlink" title="用const 修饰函数的参数"></a>用const 修饰函数的参数</h3><h3 id="const成员函数"><a href="#const成员函数" class="headerlink" title="const成员函数"></a>const成员函数</h3><p>const数据成员不能被修改</p>
<p>const函数只能应用本类数据成员不能修改</p>
<p>const对象只能访问const成员函数</p>
<h2 id="引用传递和值传递"><a href="#引用传递和值传递" class="headerlink" title="引用传递和值传递"></a>引用传递和值传递</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//值传递，调用时参数拷贝一份，传递给x</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">addOne</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</div><div class="line">	x += <span class="number">1</span>;<span class="comment">//等价于x = x+ 1；</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//引用传参，y为参数引用，对y的所有操作，都作用在传递的参数上</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">addTwo</span><span class="params">(<span class="keyword">int</span> &amp;y)</span></span>&#123;</div><div class="line">	y += <span class="number">2</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="keyword">int</span> m = <span class="number">1</span>;</div><div class="line">	addOne(m);</div><div class="line">	<span class="built_in">cout</span> &lt;&lt; m &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> n = <span class="number">1</span>;</div><div class="line">	addTwo(n);</div><div class="line">	<span class="built_in">cout</span> &lt;&lt; n &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">	system(<span class="string">"pause"</span>);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> c++ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[LiveReload Note]]></title>
      <url>http://xiaozhuang.github.io/2016/09/21/livereload-note/</url>
      <content type="html"><![CDATA[<p>修改网页源代码后自动刷新浏览器<br><a id="more"></a></p>
<h1 id="browsersync"><a href="#browsersync" class="headerlink" title="browsersync"></a>browsersync</h1><p><a href="https://www.browsersync.io/" target="_blank" rel="external">https://www.browsersync.io/</a></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -g browser-sync</div></pre></td></tr></table></figure>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">browser-sync start --server --files <span class="string">"**"</span></div><div class="line"></div><div class="line">// --files 路径是相对于运行该命令的项目（目录） </div><div class="line">browser-sync start --server --files <span class="string">"css/*.css, *.html"</span></div><div class="line">// 如果你的文件层级比较深，您可以考虑使用 **（表示任意目录）匹配，任意目录下任意.css 或 .html文件。 </div><div class="line">browser-sync start --server --files <span class="string">"**/*.css, **/*.html"</span></div></pre></td></tr></table></figure>
<h2 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h2><p><a href="http://10.10.60.49:3000/" target="_blank" rel="external">http://10.10.60.49:3000/</a></p>
<p>browser-sync设置:<br><a href="http://10.10.60.49:3001/" target="_blank" rel="external">http://10.10.60.49:3001/</a></p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Powerful Development Tool </tag>
            
            <tag> WEB </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL5.7 Note]]></title>
      <url>http://xiaozhuang.github.io/2016/09/17/MySQL5-7-note/</url>
      <content type="html"><![CDATA[<p>MySQL5.7安装及新特性<br><a id="more"></a></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="windows版"><a href="#windows版" class="headerlink" title="windows版"></a>windows版</h2><p>系统：win7x64安装<br>MySQL：5.7.15</p>
<h3 id="解压mysql-5-7-15-winx64-zip"><a href="#解压mysql-5-7-15-winx64-zip" class="headerlink" title="解压mysql-5.7.15-winx64.zip"></a>解压mysql-5.7.15-winx64.zip</h3><h3 id="复制my-default-ini命名为my-ini，创建保存数据data文件夹"><a href="#复制my-default-ini命名为my-ini，创建保存数据data文件夹" class="headerlink" title="复制my-default.ini命名为my.ini，创建保存数据data文件夹"></a>复制my-default.ini命名为my.ini，创建保存数据data文件夹</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#修改配置</span></div><div class="line">[client]</div><div class="line">default-character-set=utf8</div><div class="line"></div><div class="line">[mysqld]</div><div class="line">basedir = <span class="string">"E:\mysql-5.7.15-winx64"</span></div><div class="line">datadir = <span class="string">"E:\mysql-5.7.15-winx64\data"</span></div></pre></td></tr></table></figure>
<h3 id="管理员运行cmd，进入mysql下bin目录，初试化数据"><a href="#管理员运行cmd，进入mysql下bin目录，初试化数据" class="headerlink" title="管理员运行cmd，进入mysql下bin目录，初试化数据"></a>管理员运行cmd，进入mysql下bin目录，初试化数据</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqld --initialize-insecure</div></pre></td></tr></table></figure>
<h3 id="安装MySQL为windows服务"><a href="#安装MySQL为windows服务" class="headerlink" title="安装MySQL为windows服务"></a>安装MySQL为windows服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">mysqld install</div><div class="line">mysqld --install &lt;server_name&gt;</div><div class="line">mysqld --install MySQL5.7.11-3307</div><div class="line"></div><div class="line"><span class="comment"># 一台机器，安装多个MySQL</span></div><div class="line">mysqld --install MySQL5.6.26:3306-SSD  --defaults-file=<span class="string">"C:\Program Files\mysql-5.6.26-winx64\3306\my.ini"</span></div><div class="line">mysqld --install MySQL5.6.26:3307-SSD  --defaults-file=<span class="string">"C:\Program Files\mysql-5.6.26-winx64\3307\my.ini"</span></div><div class="line"></div><div class="line"><span class="comment">#卸载mysql的windows服务命令：</span></div><div class="line">mysqld --remove</div><div class="line">mysqld --remove &lt;server_name&gt;</div><div class="line">mysqld --remove MySQL5.7.11-3307</div></pre></td></tr></table></figure>
<h3 id="启动MySQL"><a href="#启动MySQL" class="headerlink" title="启动MySQL"></a>启动MySQL</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">net start mysql</div></pre></td></tr></table></figure>
<h3 id="将mysql添加到系统环境变量"><a href="#将mysql添加到系统环境变量" class="headerlink" title="将mysql添加到系统环境变量"></a>将mysql添加到系统环境变量</h3><p>添加path环境变量添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">;%MYSQL_HOME%\bin</div></pre></td></tr></table></figure>
<p>添加系统环境变量MYSQL_HOME，指向mysql根目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">E:\mysql-5.7.15-winx64</div></pre></td></tr></table></figure>
<p>注：<br>与Linux版MySQL5.7不同，windows版MySQL5.7不会初试化随机密码<br>windows版MySQL5.7安装完成后，密码为空</p>
<h2 id="Linux版"><a href="#Linux版" class="headerlink" title="Linux版"></a>Linux版</h2><h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#解压</span></div><div class="line">tar -xzvf mysql-5.7.16-linux-glibc2.5-x86_64.tar.gz</div><div class="line"></div><div class="line"><span class="comment">#移动到usr/local</span></div><div class="line">mv mysql-5.7.16-linux-glibc2.5-x86_64 /usr/<span class="built_in">local</span>/mysql-5.7.11-glibc2.5-i686</div><div class="line"></div><div class="line"><span class="comment">#创建软链接后，可以使用/usr/local/mysql/support-files/mysql.server 启动</span></div><div class="line">ln -s mysql-5.7.11-glibc2.5-i686 mysql</div><div class="line"></div><div class="line"><span class="comment">#创建mysql用户</span></div><div class="line">useradd -s /sbin/nologin mysql</div><div class="line">chown -R mysql:mysql /usr/<span class="built_in">local</span>/mysql-5.7.11-glibc2.5-i686</div><div class="line">usermod -s /bin/bash mysql</div><div class="line"></div><div class="line"><span class="comment">#安装MySQL依赖库libaio</span></div><div class="line">yum install libaio</div><div class="line"></div><div class="line"><span class="comment">#MySQL5.7使用mysqld初试化，初试化完成后，输出中包含随机生成的root用户密码</span></div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/mysql/</div><div class="line">bin/mysqld --initialize --user=mysql --basedir=/usr/<span class="built_in">local</span>/mysql --datadir=/usr/<span class="built_in">local</span>/mysql/date</div><div class="line"></div><div class="line"><span class="comment">#启动</span></div><div class="line">nohup bin/mysqld_safe --defaults-file=./my.cnf &gt; /dev/null 2&gt;&amp;1 &amp;</div><div class="line"><span class="comment">#或</span></div><div class="line">/usr/<span class="built_in">local</span>/mysql/support-files/mysql.server start</div><div class="line"></div><div class="line"><span class="comment">#解决mysql.server start启动后mysql -uroot -p 连接报错：</span></div><div class="line"><span class="comment">#ERROR 2002 (HY000): Can't connect to local MySQL server through socket '/tmp/mysql.sock' (2)</span></div><div class="line">ln -s /var/lib/mysql/mysql.sock   /tmp/mysql.sock</div><div class="line"></div><div class="line"><span class="comment">#查询配置文件加载顺序</span></div><div class="line"><span class="comment">#/usr/local/mysql/bin/mysqld --verbose --help | grep -A 1 'Default options'</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#重置密码：SQL</span></div><div class="line"><span class="comment">#set password for 'root'@'localhost'=password('123456');</span></div><div class="line"></div><div class="line"><span class="comment"># 允许远程连接：--SQL</span></div><div class="line">use mysql;</div><div class="line">update user <span class="built_in">set</span> Host=<span class="string">'%'</span> <span class="built_in">where</span> User =<span class="string">'root'</span> <span class="built_in">limit</span> 1;</div><div class="line">flush privileges;</div><div class="line"><span class="comment">#或--SQL</span></div><div class="line">use mysql;</div><div class="line">Grant all on *.* to <span class="string">'root'</span>@<span class="string">'%'</span> identified by <span class="string">'root用户的密码'</span> with grant option;</div><div class="line">flush privileges;</div><div class="line"></div><div class="line"><span class="comment"># 打开3306</span></div><div class="line">/sbin/iptables -I INPUT -p tcp --dport 3306 -j ACCEPT</div><div class="line">/etc/rc.d/init.d/iptables save</div><div class="line">/etc/init.d/iptables status</div></pre></td></tr></table></figure>
<p>注：<br>    CentOS版MySQL</p>
<h3 id="命令行登录"><a href="#命令行登录" class="headerlink" title="命令行登录"></a>命令行登录</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mysql -u root -p</div><div class="line"><span class="comment">#或</span></div><div class="line">mysql -uroot -p</div><div class="line"><span class="comment">#或</span></div><div class="line">mysql --user=root --password=123456</div></pre></td></tr></table></figure>
<h1 id="MySQL5-7新特性"><a href="#MySQL5-7新特性" class="headerlink" title="MySQL5.7新特性"></a>MySQL5.7新特性</h1><h2 id="功能增强"><a href="#功能增强" class="headerlink" title="功能增强"></a>功能增强</h2><ul>
<li>数据库初试化方式变更</li>
<li>表增加计算列</li>
<li>引入JSON列类型及相关函数</li>
</ul>
<h2 id="支持计算列"><a href="#支持计算列" class="headerlink" title="支持计算列"></a>支持计算列</h2><p>通过触发器实现计算列</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 插入触发器</span></div><div class="line">DELIMITER $$</div><div class="line"><span class="keyword">CREATE</span></div><div class="line">    <span class="keyword">TRIGGER</span> <span class="string">`sakila`</span>.<span class="string">`inst_t`</span> <span class="keyword">BEFORE</span> <span class="keyword">INSERT</span></div><div class="line">    <span class="keyword">ON</span> <span class="string">`sakila`</span>.<span class="string">`t4`</span></div><div class="line">    <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">BEGIN</span></div><div class="line">    <span class="keyword">SET</span> new.c3 = new.c1 + new.c2;</div><div class="line">    <span class="keyword">END</span>$$</div><div class="line"></div><div class="line">DELIMITER ;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">--更新触发器</span></div><div class="line">DELIMITER $$</div><div class="line"><span class="keyword">CREATE</span></div><div class="line">    <span class="keyword">TRIGGER</span> <span class="string">`sakila`</span>.<span class="string">`upd_t4`</span> <span class="keyword">BEFORE</span> <span class="keyword">UPDATE</span></div><div class="line">    <span class="keyword">ON</span> <span class="string">`sakila`</span>.<span class="string">`t4`</span></div><div class="line">    <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">BEGIN</span></div><div class="line">    <span class="keyword">SET</span> new.c3 = new.c2 + new.c1;</div><div class="line">    <span class="keyword">END</span>$$</div><div class="line"></div><div class="line">DELIMITER ;</div></pre></td></tr></table></figure>
<p>通过视图实现计算列</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span></div><div class="line">    <span class="keyword">VIEW</span> <span class="string">`sakila`</span>.<span class="string">`vw_t4`</span> </div><div class="line">    <span class="keyword">AS</span></div><div class="line">(<span class="keyword">SELECT</span> c1,c2,c1+c2 <span class="keyword">AS</span> c3 <span class="keyword">FROM</span> t4);</div></pre></td></tr></table></figure>
<p>触发器和视图会影响效率</p>
<p>MySQL5.7计算列</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`sakila`</span>.<span class="string">`t4`</span>(		<span class="comment">/* 未指定表名 */</span>  </div><div class="line">  <span class="string">`id`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">  <span class="string">`c1`</span> <span class="built_in">INT</span>,</div><div class="line">  <span class="string">`c2`</span> <span class="built_in">INT</span>,</div><div class="line">  <span class="string">`c3`</span> <span class="built_in">INT</span> <span class="keyword">AS</span> (c1 + c2),</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">);</div></pre></td></tr></table></figure>
<h1 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h1><ul>
<li>master 创建主从复制用户</li>
<li>master 备份数据</li>
<li>slaver 恢复数据，并制定日志和日志点</li>
</ul>
<h2 id="创建复制用户"><a href="#创建复制用户" class="headerlink" title="创建复制用户"></a>创建复制用户</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 查现有用户</span></div><div class="line"><span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> mysql.user;</div><div class="line"><span class="comment">-- 创建主从复制用户</span></div><div class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">'dba'</span>@<span class="string">'192.168.117.%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'123456'</span>;</div><div class="line"><span class="keyword">grant</span> <span class="keyword">replication</span> <span class="keyword">slave</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'dba'</span>@<span class="string">'192.168.117.%'</span>;</div></pre></td></tr></table></figure>
<h2 id="主数据备份"><a href="#主数据备份" class="headerlink" title="主数据备份"></a>主数据备份</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#数据备份</span></div><div class="line">mysqldump --single-transaction --master-data=2 --triggers --routines --all-databases -uroot -p &gt; all.sql</div><div class="line"><span class="comment"># 拷贝到从服务器</span></div><div class="line">scp all.sql root@192.168.117.133:/tmp</div></pre></td></tr></table></figure>
<p>数据备份报错：mysqldump: Error: Binlogging on server not active<br>my.conf配置文件中添加，重启mysql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">server_id = 128</div><div class="line">log_bin=mysql-bin</div></pre></td></tr></table></figure>
<h2 id="从恢复数据并开启同步"><a href="#从恢复数据并开启同步" class="headerlink" title="从恢复数据并开启同步"></a>从恢复数据并开启同步</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 恢复数据</span></div><div class="line">mysql -uroot -p &lt; all.sql</div><div class="line"><span class="comment">#从备份文件中获取日志文件和日志点信息</span></div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 设定主节点</span></div><div class="line"><span class="keyword">change</span> <span class="keyword">master</span> <span class="keyword">to</span> master_host=<span class="string">'192.168.117.128'</span>, master_user=<span class="string">'dba'</span>, master_password=<span class="string">'123456'</span>, master_log_file=<span class="string">'mysql-bin.000001'</span>, master_log_pos=<span class="number">154</span>;</div><div class="line"></div><div class="line"><span class="comment">-- 查看同步配置信息和状态</span></div><div class="line"><span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>\G</div></pre></td></tr></table></figure>
<blockquote>
<p>未开启同步时状态<br>Slave_IO_Running: No<br>Slave_SQL_Running: No</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 开启主从同步</span></div><div class="line"><span class="keyword">start</span> <span class="keyword">slave</span>;</div><div class="line"><span class="comment">-- 停止主从同步</span></div><div class="line"><span class="comment">-- stop slave;</span></div></pre></td></tr></table></figure>
<p>同步状态信息报错<br>Last_IO_Error: Fatal error: The slave I/O thread stops because master and slave have equal MySQL server UUIDs; these UUIDs must be different for replication to work.<br>因虚拟机拷贝mysql/data/auto.cnf中server-uuid一样</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 移除auto.cnf，重启mysql会重新生成auto.cnf文件</span></div><div class="line">mv auto.cnf auto.cnf.bak</div><div class="line"><span class="comment"># 重启mysql后，主从同步正常</span></div></pre></td></tr></table></figure>
<p>同步状态中Slave_IO_Running，Slave_SQL_Running同时为yes，表示同步正常</p>
<h2 id="MySQL5-7主从管理视图"><a href="#MySQL5-7主从管理视图" class="headerlink" title="MySQL5.7主从管理视图"></a>MySQL5.7主从管理视图</h2><p>performance_schema 数据库中</p>
<p>复制链路延迟配置：<br>replication_applier_configuration</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">replication_applier_configuration       </div><div class="line">replication_applier_status              </div><div class="line">replication_applier_status_by_coordinator </div><div class="line">replication_applier_status_by_worker    </div><div class="line">replication_connection_configuration    </div><div class="line">replication_connection_status           </div><div class="line">replication_group_member_stats          </div><div class="line">replication_group_members</div></pre></td></tr></table></figure>
<h1 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a>Issues</h1><h2 id="MySQL-Window服务启动失败1053"><a href="#MySQL-Window服务启动失败1053" class="headerlink" title="MySQL Window服务启动失败1053"></a>MySQL Window服务启动失败1053</h2><p>1053错误是服务应答超时</p>
<p>服务列表，双击服务，打开服务属性窗口<br>停止服务，重新启动                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Solr Note]]></title>
      <url>http://xiaozhuang.github.io/2016/09/05/solr-note/</url>
      <content type="html"><![CDATA[<p>Solr是一个独立的企业级搜索应用服务器，它对外提供类似于Web-service的API接口。用户可以通过http请求，向搜索引擎服务器提交一定格式的XML文件，生成索引；也可以通过Http Get操作提出查找请求，并得到XML格式的返回结果。<br><a id="more"></a></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h2><p>windows:解压solr-5.5.2.zip，cmd进入bin目录</p>
<p>安装windows服务：<a href="https://www.norconex.com/how-to-run-solr5-as-a-service-on-windows/" target="_blank" rel="external">https://www.norconex.com/how-to-run-solr5-as-a-service-on-windows/</a></p>
<h2 id="Centos"><a href="#Centos" class="headerlink" title="Centos"></a>Centos</h2><p><a href="http://idroot.net/tutorials/how-to-install-apache-solr-on-centos-7/" target="_blank" rel="external">http://idroot.net/tutorials/how-to-install-apache-solr-on-centos-7/</a></p>
<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#启动windows：solr.cmd start</span></div><div class="line">solr start</div><div class="line"></div><div class="line"><span class="comment">#指定端口号，默认8983</span></div><div class="line">solr start -p 8984</div><div class="line"></div><div class="line"><span class="comment">#solr默认后台运行，通过参数使solr不在后台运行</span></div><div class="line">solr start -f</div><div class="line"></div><div class="line"><span class="comment">#使用示例配置启动solr</span></div><div class="line">solr -e techproducts</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#检查solr状态</span></div><div class="line">solr status</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#停止</span></div><div class="line">solr stop -p 8983</div></pre></td></tr></table></figure>
<p>访问：<a href="http://localhost:8983/solr/" target="_blank" rel="external">http://localhost:8983/solr/</a><br>进入管理界面</p>
<h1 id="Create-a-Core"><a href="#Create-a-Core" class="headerlink" title="Create a Core"></a>Create a Core</h1><p>Solr里面的core就像数据库里的表，用来管理索引和相关配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#指令创建</span></div><div class="line">solr create -c &lt;name&gt;</div></pre></td></tr></table></figure>
<h1 id="Ask-Questions"><a href="#Ask-Questions" class="headerlink" title="Ask Questions"></a>Ask Questions</h1><h2 id="全文检索（searches-all-document-fields-for-“video”）"><a href="#全文检索（searches-all-document-fields-for-“video”）" class="headerlink" title="全文检索（searches all document fields for “video”）"></a>全文检索（searches all document fields for “video”）</h2><p>搜索关键字，默认不区分大小写</p>
<p>返回json：<a href="http://10.10.60.61:8983/solr/techproducts/select?q=video&amp;wt=json&amp;indent=true" target="_blank" rel="external">http://10.10.60.61:8983/solr/techproducts/select?q=video&amp;wt=json&amp;indent=true</a><br>返回xml：<a href="http://10.10.60.61:8983/solr/techproducts/select?q=utf-8&amp;wt=xml&amp;indent=true" target="_blank" rel="external">http://10.10.60.61:8983/solr/techproducts/select?q=utf-8&amp;wt=xml&amp;indent=true</a></p>
<p>Solr can output the results in JSON, PHP, Ruby and even user-defined formats</p>
<h2 id="指定返回字段"><a href="#指定返回字段" class="headerlink" title="指定返回字段"></a>指定返回字段</h2><p><a href="http://localhost:8983/solr/gettingstarted/select?q=video&amp;fl=id,name,price" target="_blank" rel="external">http://localhost:8983/solr/gettingstarted/select?q=video&amp;fl=id,name,price</a></p>
<blockquote>
<p>only contain the ID, name, and price for each returned document.</p>
</blockquote>
<h2 id="指定搜索字段"><a href="#指定搜索字段" class="headerlink" title="指定搜索字段"></a>指定搜索字段</h2><p><a href="http://localhost:8983/solr/gettingstarted/select?q=name:black" target="_blank" rel="external">http://localhost:8983/solr/gettingstarted/select?q=name:black</a></p>
<blockquote>
<p>searches for “black” in the name field only</p>
</blockquote>
<h2 id="范围条件查询"><a href="#范围条件查询" class="headerlink" title="范围条件查询"></a>范围条件查询</h2><p><a href="http://localhost:8983/solr/gettingstarted/select?q=price:[0" target="_blank" rel="external">http://localhost:8983/solr/gettingstarted/select?q=price:[0</a> TO 400]&amp;fl=id,name,price</p>
<h2 id="facet"><a href="#facet" class="headerlink" title="facet"></a>facet</h2><p>Facet是Solr的高级搜索功能之一，Solr作者给出的定义是导航(Guided Navigation)、参数化查询(Paramatic Search)。Facet的主要好处是在搜索的同时，可以按照Facet条件进行分组统计，给出导航信息，改善搜索体验。</p>
<p>它并不会修改查询结果信息，只是在查询结果上根据分类添加了count信息， 然后用户根据count信息做进一步的查询</p>
<p><a href="http://10.10.60.51:8983/solr/techproducts/select?q=price:[0%20TO%20400]&amp;fl=id,name" target="_blank" rel="external">http://10.10.60.51:8983/solr/techproducts/select?q=price:[0%20TO%20400]&amp;fl=id,name</a> ,price&amp;facet=true&amp;facet.field=cat</p>
<h2 id="检索条件"><a href="#检索条件" class="headerlink" title="检索条件"></a>检索条件</h2><p>q：搜索字段，字段和值冒号分隔，支持or和and</p>
<p>fq：多个不同字段查询，默认and操作</p>
<p>sort：排序，asc升序</p>
<p>start，rows：分页</p>
<p>fl：字段field</p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>Per Solr Core:</p>
<p>core.properties defines specific properties for each core such as its name, the collection the<br>core belongs to, the location of the schema, and other parameters. For more details on core.pro<br>perties, see the section Defining core.properties.</p>
<p>solrconfig.xml controls high-level behavior. You can, for example, specify an alternate location<br>for the data directory. For more information on solrconfig.xml, see Configuring solrconfig.xml.</p>
<p>schema.xml (or managed-schema instead) describes the documents you will ask Solr to index.<br>Inside schema.xml, you define a document as a collection of fields. You get to define both the<br>field types and the fields themselves. Field type definitions are powerful and include information<br>about how Solr processes incoming field values and query values. For more information on schem<br>a.xml, see Documents, Fields, and Schema Design. If you are using Solr’s Schema API to<br>manage your fields, you would see managed-schema instead of schema.xml (see Managed<br>Schema Definition in SolrConfig for more information).</p>
<p>data/ The directory containing the low level index files.</p>
<h2 id="Solr-Start-Script-Reference"><a href="#Solr-Start-Script-Reference" class="headerlink" title="Solr Start Script Reference"></a>Solr Start Script Reference</h2><h3 id="Start-and-Restart"><a href="#Start-and-Restart" class="headerlink" title="Start and Restart"></a>Start and Restart</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">bin/solr start [options]</div><div class="line">bin/solr start -<span class="built_in">help</span></div><div class="line">bin/solr restart [options]</div><div class="line">bin/solr restart -<span class="built_in">help</span></div></pre></td></tr></table></figure>
<p>Available Parameters</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>-a “<string>“</string></td>
<td>Start Solr with additional JVM parameters</td>
<td>bin/solr start -a “-Xdebug -Xrunjdwp:transport=dt_socket, server=y,suspend=n,address=1044”</td>
</tr>
<tr>
<td>-cloud 或 -c</td>
<td>Start Solr in SolrCloud mode 同时启动内嵌的ZooKeeper</td>
<td>bin/solr start -c</td>
</tr>
<tr>
<td>-d <dir></dir></td>
<td>Start Solr in SolrCloud mode 同时启动内嵌的ZooKeeper</td>
<td>bin/solr start -c</td>
</tr>
</tbody>
</table>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
            <tag> Solr </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Git Note]]></title>
      <url>http://xiaozhuang.github.io/2016/08/21/git-note/</url>
      <content type="html"><![CDATA[<p>Git是一款免费、开源的分布式版本控制系统，用于敏捷高效地处理任何或小或大的项目。<br><a id="more"></a></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>配置用户名和邮箱</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">git config --global user.name <span class="string">"Your Name"</span></div><div class="line">git config --global user.email <span class="string">"email@example.com"</span></div><div class="line"><span class="comment"># 查看当前仓库配置</span></div><div class="line">git config -l</div></pre></td></tr></table></figure>
<p>注意git config命令的–global参数，用了这个参数，表示你这台机器上所有的Git仓库都会使用这个配置，当然也可以对某个仓库指定不同的用户名和Email地址。</p>
<h1 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h1><h2 id="创建版本库"><a href="#创建版本库" class="headerlink" title="创建版本库"></a>创建版本库</h2><p>版本库又名仓库，英文名repository，你可以简单理解成一个目录，这个目录里面的所有文件都可以被Git管理起来</p>
<p>通过git init命令把这个目录变成Git可以管理的仓库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#初试化版本库</span></div><div class="line">git init</div><div class="line"></div><div class="line"><span class="comment">#添加文件到版本库</span></div><div class="line">git add readme.txt</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#提交文件到仓库</span></div><div class="line"><span class="comment">#添加需要提交的文件</span></div><div class="line">git add readme.txt file2.txt</div><div class="line">git commit -m <span class="string">"wrote a readme file"</span></div></pre></td></tr></table></figure>
<h2 id="查看版本库当前状态"><a href="#查看版本库当前状态" class="headerlink" title="查看版本库当前状态"></a>查看版本库当前状态</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">git status</div><div class="line"></div><div class="line"><span class="comment">#查看变化内容</span></div><div class="line">git diff</div><div class="line">git diff filename</div></pre></td></tr></table></figure>
<h2 id="查看提交日志"><a href="#查看提交日志" class="headerlink" title="查看提交日志"></a>查看提交日志</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">log</span></div><div class="line">git <span class="built_in">log</span> --pretty=oneline --abbrev-commit</div><div class="line"></div><div class="line"><span class="comment"># 查看指定目录、文件日志</span></div><div class="line">git <span class="built_in">log</span> &lt;file&gt;</div><div class="line"></div><div class="line"><span class="comment"># 查看分支日志</span></div><div class="line">git <span class="built_in">log</span> &lt;branch-name&gt;</div></pre></td></tr></table></figure>
<h2 id="版本回退"><a href="#版本回退" class="headerlink" title="版本回退"></a>版本回退</h2><p>当丢弃本地未push到远程的提交时，使用git reset<br>当想对远程提交进行回滚时，使用<code>git revert</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#回退上一个版本</span></div><div class="line">git reset --hard HEAD^</div><div class="line"></div><div class="line"><span class="comment">#上上个版本</span></div><div class="line">git reset --hard HEAD^^</div><div class="line"></div><div class="line"><span class="comment">#往上100个版本</span></div><div class="line">git reset --hard HEAD~100</div><div class="line"></div><div class="line"><span class="comment">#会到指定版本，指定版本的前几位就可以</span></div><div class="line">git reset --hard 83ad53ca16e</div><div class="line"></div><div class="line"><span class="comment"># --soft Does not touch the index file or the working tree at all (but resets the head to &lt;commit&gt;, just like all modes do). This leaves all your changed files "Changes to be committed", as git status would put it.</span></div><div class="line"><span class="comment"># --mixed Resets the index but not the working tree (i.e., the changed files are preserved but not marked for commit) and reports what has not been updated. This is the default action.</span></div><div class="line"><span class="comment"># --hard Resets the index and working tree. Any changes to tracked files in the working tree since &lt;commit&gt; are discarded.</span></div><div class="line">git reset --soft --hard 83ad53ca16e</div><div class="line">git reset --mixed --hard 83ad53ca16e</div><div class="line">git reset --hard --hard 83ad53ca16e</div><div class="line"></div><div class="line"><span class="comment"># 回滚到远程分支对映版本</span></div><div class="line">git reset --hard origin/dev</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#命令执行记录和版本id</span></div><div class="line">git reflog</div><div class="line"></div><div class="line"><span class="comment"># Revert commit 撤销  一个提交  的同时会创建一个新的提交。这是一个安全的方法，因为它不会重写提交历史。</span></div><div class="line">git revert --hard 83ad53ca16e</div><div class="line"></div><div class="line"><span class="comment"># Revert mergec</span></div><div class="line"><span class="comment"># commit d875c3f063e046e407eeca3404d875dff75b2fc3</span></div><div class="line"><span class="comment"># Merge: ee4e380 4141e45</span></div><div class="line"><span class="comment"># Author: wangdianzhuang &lt;wangdianzhuang@jd.com&gt;</span></div><div class="line"><span class="comment"># Date:   Mon Dec 11 20:03:04 2017 +0800</span></div><div class="line"><span class="comment"># Merge branch 'master' of git.jd.com:wangdianzhuang/git-test into dev</span></div><div class="line"></div><div class="line"><span class="comment"># -m 1，撤销到 ee4e380 所代表的commit,撤销该commit造成的修改</span></div><div class="line">git revert -m 1 --hard d875c3f063e046e407eeca3404d875dff75b2fc3</div></pre></td></tr></table></figure>
<h2 id="工作区和暂存区"><a href="#工作区和暂存区" class="headerlink" title="工作区和暂存区"></a>工作区和暂存区</h2><p>工作区（Working Directory）：git版本控制的目录。</p>
<p>版本库（Repository）：git版本控制目录下的git文件夹。<br>Git的版本库里存了很多东西，其中最重要的就是称为stage（或者叫index）的暂存区，<br>还有Git为我们自动创建的第一个分支master，<br>以及指向master的一个指针叫HEAD</p>
<p>把文件往Git版本库里，分两步执行：</p>
<ul>
<li>用git add把文件添加进去，实际上就是把文件修改添加到暂存区</li>
<li>用git commit提交更改，实际上就是把暂存区的所有内容提交到当前分支</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#将文件移出暂存区（add 反向操作）</span></div><div class="line">git reset head &lt;file&gt;</div></pre></td></tr></table></figure>
<h2 id="管理修改"><a href="#管理修改" class="headerlink" title="管理修改"></a>管理修改</h2><p><code>为什么Git比其他版本控制系统设计得优秀，因为Git跟踪并管理的是修改，而非文件</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 查看工作区和版本库中最新版本区别</span></div><div class="line">git diff HEAD -- readme.txt</div></pre></td></tr></table></figure>
<h2 id="撤销修改"><a href="#撤销修改" class="headerlink" title="撤销修改"></a>撤销修改</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 丢弃工作区的修改,回到最近一次git commit或git add时的状态,其实是用版本库里的版本替换工作区的版本</span></div><div class="line">git checkout -- readme.txt</div></pre></td></tr></table></figure>
<h1 id="远程仓库"><a href="#远程仓库" class="headerlink" title="远程仓库"></a>远程仓库</h1><p>Git是分布式版本控制系统，同一个Git仓库，可以分布到不同的机器上。<br>每台机器的版本库其实都是一样的，并没有主次之分。</p>
<p>创建SSH Key</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ssh-keygen -t rsa -C <span class="string">"youremail@example.com"</span></div><div class="line"></div><div class="line"><span class="comment"># 在用户主目录里找到.ssh目录，里面有id_rsa和id_rsa.pub两个文件，这两个就是SSH Key的秘钥对，</span></div><div class="line"><span class="comment"># id_rsa是私钥，不能泄露出去，id_rsa.pub是公钥，可以放心地告诉任何人</span></div><div class="line"></div><div class="line"><span class="comment">#登陆GitHub，打开“Account settings”，“SSH Keys”页面：</span></div><div class="line"><span class="comment">#点“Add SSH Key”，填上任意Title，在Key文本框里粘贴id_rsa.pub文件的内容</span></div></pre></td></tr></table></figure>
<blockquote>
<p>执行ssh-keygen命令时<code>不要</code>输入密码</p>
</blockquote>
<h2 id="添加远程仓库"><a href="#添加远程仓库" class="headerlink" title="添加远程仓库"></a>添加远程仓库</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">git remote add origin git@github.com:xiaozhuang/note.git</div><div class="line"></div><div class="line"><span class="comment"># 添加多个远程仓库,远程仓库名称不同</span></div><div class="line">git remote add origin_git git@git.jd.com:wangdianzhuang/note.git</div><div class="line"></div><div class="line"><span class="comment"># 移除远程仓库</span></div><div class="line">git remote rm origin</div><div class="line"></div><div class="line"><span class="comment"># git push &lt;远程主机名&gt; &lt;本地分支名&gt;:&lt;远程分支名&gt;</span></div><div class="line">git push origin master:master</div><div class="line"></div><div class="line"><span class="comment"># 本地仓库推送至远程仓库，远程库的名字是origin</span></div><div class="line"><span class="comment"># -u参数，Git不但会把本地的master分支内容推送的远程新的master分支，还会把本地的master分支和远程的master分支关联起</span></div><div class="line">git push -u origin master</div><div class="line"></div><div class="line">git push origin master</div><div class="line"></div><div class="line"><span class="comment">#获取远程分支更新</span></div><div class="line"><span class="comment"># git pull &lt;远程主机名&gt; &lt;远程分支名&gt;:&lt;本地分支名&gt;</span></div><div class="line"><span class="comment"># 远程分支devgit与当前分支合并</span></div><div class="line">git pull origin devgit</div><div class="line"> </div><div class="line"><span class="comment"># 本地分支与远程分支关联</span></div><div class="line">git branch --<span class="built_in">set</span>-upstream-to=origin/devtest devtest</div></pre></td></tr></table></figure>
<h3 id="Updates-were-rejected-because-the-remote-contains-work-that-you-do"><a href="#Updates-were-rejected-because-the-remote-contains-work-that-you-do" class="headerlink" title="Updates were rejected because the remote contains work that you do"></a>Updates were rejected because the remote contains work that you do</h3><p>执行命令git push -u origin master</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#原因：远程仓库比本地仓库新</span></div><div class="line">git pull origin master --allow-unrelated-histories</div><div class="line"><span class="comment"># 再执行</span></div><div class="line">git push -u origin master</div><div class="line"></div><div class="line"><span class="comment">#推送分支至远程仓库</span></div><div class="line"><span class="comment">#The remote branch is automatically created when you push it to the remote server</span></div><div class="line"><span class="comment">#git push &lt;remote-name&gt; &lt;branch-name&gt;</span></div><div class="line"><span class="comment">#git push &lt;remote-name&gt; &lt;local-branch-name&gt;:&lt;remote-branch-name&gt;</span></div><div class="line">git push -u origin dev</div></pre></td></tr></table></figure>
<h1 id="分支管理"><a href="#分支管理" class="headerlink" title="分支管理"></a>分支管理</h1><p>分支在实际中有什么用呢？假设你准备开发一个新功能，但是需要两周才能完成，第一周你写了50%的代码，如果立刻提交，由于代码还没写完，不完整的代码库会导致别人不能干活了。如果等代码全部写完再一次提交，又存在丢失每天进度的巨大风险。</p>
<p>现在有了分支，就不用怕了。你创建了一个属于你自己的分支，别人看不到，还继续在原来的分支上正常工作，而你在自己的分支上干活，想提交就提交，直到开发完毕后，再一次性合并到原来的分支上，这样，既安全，又不影响别人工作。</p>
<h2 id="创建与合并分支"><a href="#创建与合并分支" class="headerlink" title="创建与合并分支"></a>创建与合并分支</h2><p> gh-pages分支是GitHub Page 的默认分支</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查看分支</span></div><div class="line">git branch</div><div class="line"><span class="comment"># 查看远程分支</span></div><div class="line">git branch -r</div><div class="line"><span class="comment"># 查看全部分支</span></div><div class="line">git branch -a</div><div class="line"></div><div class="line"><span class="comment">#创建并切换至新分支</span></div><div class="line"><span class="comment">#相当于git branch dev  &amp;&amp;　git checkout dev</span></div><div class="line">git checkout -b dev</div><div class="line"></div><div class="line"><span class="comment">#提交内容到新分支</span></div><div class="line">git add readme.txt </div><div class="line"><span class="comment"># 提交</span></div><div class="line">git commit -m <span class="string">"branch test"</span></div><div class="line"><span class="comment"># 提交并添加多行提交信息</span></div><div class="line">git commit</div><div class="line"></div><div class="line"><span class="comment"># 修改上一条提交信息</span></div><div class="line">git commit --amend</div><div class="line"><span class="comment">#切换回master分支</span></div><div class="line">git checkout master</div><div class="line">git checkout - <span class="comment">#切换至上一个分支</span></div><div class="line"></div><div class="line"><span class="comment">#把dev分支的工作成果合并到master分支</span></div><div class="line"><span class="comment">#git merge命令用于合并指定分支到当前分支。</span></div><div class="line">git merge dev</div><div class="line"><span class="comment"># 解决冲突</span></div><div class="line"></div><div class="line"><span class="comment">#删除分支</span></div><div class="line">git branch -d dev</div><div class="line"></div><div class="line"><span class="comment">#删除远程分支(推送空分支到远程分支)</span></div><div class="line">git push origin :&lt;branchName&gt;</div><div class="line"></div><div class="line"><span class="comment"># 直接删除远程分支</span></div><div class="line">git push origin --delete &lt;branchName&gt;</div></pre></td></tr></table></figure>
<h2 id="解决冲突"><a href="#解决冲突" class="headerlink" title="解决冲突"></a>解决冲突</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git merge feature1</div></pre></td></tr></table></figure>
<blockquote>
<p>Auto-merging readme.txt<br>CONFLICT (content): Merge conflict in readme.txt<br>Automatic merge failed; fix conflicts and then commit the result.</p>
</blockquote>
<p>Git用&lt;&lt;&lt;&lt;&lt;&lt;&lt;，=======，&gt;&gt;&gt;&gt;&gt;&gt;&gt;标记出不同分支的内容，我们修改如下后保存</p>
<p>再提交：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git add readme.txt </div><div class="line">git commit -m <span class="string">"conflict fixed"</span></div></pre></td></tr></table></figure>
<p>查看分支合并图</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">log</span> --graph --pretty=oneline --abbrev-commit</div><div class="line">git <span class="built_in">log</span> --graph</div></pre></td></tr></table></figure>
<p>撤销merge</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git reset --hard HEAD</div></pre></td></tr></table></figure>
<h1 id="分支管理策略"><a href="#分支管理策略" class="headerlink" title="分支管理策略"></a>分支管理策略</h1><h2 id="禁用Fast-forward模式"><a href="#禁用Fast-forward模式" class="headerlink" title="禁用Fast forward模式"></a>禁用Fast forward模式</h2><p>禁用Fast forward模式，Git就会在merge时生成一个新的commit<br>合并分支时，加上–no-ff参数就可以用普通模式合并，合并后的历史有分支，能看出来曾经做过合并，而fast forward合并就看不出来曾经做过合并。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git merge --no-ff -m <span class="string">"merge with no-ff"</span> dev</div></pre></td></tr></table></figure>
<h2 id="分支策略"><a href="#分支策略" class="headerlink" title="分支策略"></a>分支策略</h2><p>master分支应该是非常稳定的，也就是仅用来发布新版本。<br>干活都在dev分支上，也就是说，dev分支是不稳定的<br>你和你的小伙伴们每个人都在dev分支上干活，每个人都有自己的分支，时不时地往dev分支上合并就可以了</p>
<h1 id="Bug分支"><a href="#Bug分支" class="headerlink" title="Bug分支"></a>Bug分支</h1><p>bug分支命名<code>bugfix-xx</code><br>每个bug都可以通过一个新的临时分支来修复，修复后，合并分支，然后将临时分支删除。</p>
<p>当你接到一个修复一个代号101的bug的任务时，很自然地，你想创建一个分支issue-101来修复它，但是，等等，当前正在dev上进行的工作还没有提交</p>
<p>内容未提交无法切换分支</p>
<p>Git还提供了一个stash功能，可以把当前工作现场“储藏”起来，等以后恢复现场后继续工作</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#存储工作现场</span></div><div class="line">git stash</div><div class="line"></div><div class="line"><span class="comment">#切换分支，修复bug</span></div><div class="line"><span class="comment">#...</span></div><div class="line"></div><div class="line"><span class="comment">#查看恢复stash内容</span></div><div class="line">git stash list</div><div class="line"></div><div class="line"><span class="comment">#恢复stash内容</span></div><div class="line">git stash apply	<span class="comment">#恢复后，stash内容并不删除</span></div><div class="line">git stash drop <span class="comment">#删除stash内容</span></div><div class="line"><span class="comment">#或</span></div><div class="line">git stash pop <span class="comment">#恢复stash内容，同时把stash内容删除</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#多次stash，恢复的时候，先用git stash list查看，然后恢复指定的stash</span></div><div class="line">git stash apply stash@&#123;0&#125;</div></pre></td></tr></table></figure>
<h1 id="Feature分支"><a href="#Feature分支" class="headerlink" title="Feature分支"></a>Feature分支</h1><p>分支命名<code>feature-xxx</code><br>每添加一个新功能，最好新建一个feature分支，在上面开发，完成后，合并，最后，删除该feature分支。</p>
<h1 id="多人协作"><a href="#多人协作" class="headerlink" title="多人协作"></a>多人协作</h1><p>当你从远程仓库克隆时，实际上Git自动把本地的master分支和远程的master分支对应起来了，并且，远程仓库的默认名称是origin。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查看远程库的信息</span></div><div class="line">git remote</div><div class="line"></div><div class="line"><span class="comment">#查看远程仓库地址</span></div><div class="line">git remote -v</div><div class="line"></div><div class="line"><span class="comment">#推送分支，分支上的所有本地提交推送到远程库</span></div><div class="line">git push origin master</div><div class="line"><span class="comment">#强制推送到远程</span></div><div class="line">git push -f origin master</div><div class="line"></div><div class="line"><span class="comment">#检出远程分支</span></div><div class="line">git checkout -b dev origin/dev</div></pre></td></tr></table></figure>
<ul>
<li>master分支是主分支，因此要时刻与远程同步；</li>
<li>dev分支是开发分支，团队所有成员都需要在上面工作，所以也需要与远程同步；</li>
<li>bug分支只用于在本地修复bug，就没必要推到远程了，除非老板要看看你每周到底修复了几个bug；</li>
<li>feature分支是否推到远程，取决于你是否和你的小伙伴合作在上面开发。</li>
</ul>
<h1 id="标签管理"><a href="#标签管理" class="headerlink" title="标签管理"></a>标签管理</h1><p>Git的标签虽然是版本库的快照，但其实它就是指向某个commit的指针（跟分支很像对不对？但是分支可以移动，标签不能移动）</p>
<p>tag就是一个让人容易记住的有意义的名字，它跟某个commit绑在一起</p>
<h2 id="创建标签"><a href="#创建标签" class="headerlink" title="创建标签"></a>创建标签</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">git tag v1.0</div><div class="line"></div><div class="line"><span class="comment">#查看所有标签</span></div><div class="line">git tag</div><div class="line"></div><div class="line"><span class="comment">#在历史提交记录中添加标签</span></div><div class="line"><span class="comment"># 查看提交记录</span></div><div class="line">git <span class="built_in">log</span> --pretty=oneline --abbrev-commit</div><div class="line"><span class="comment"># 添加标签</span></div><div class="line">git tag v0.9 a1e85af</div><div class="line"></div><div class="line"><span class="comment">#创建带说明的标签</span></div><div class="line">git tag -a v0.1 -m <span class="string">"version 0.1 released"</span> 3628164</div><div class="line"></div><div class="line"><span class="comment">#查看标签信息</span></div><div class="line">git show v0.9</div><div class="line"></div><div class="line"><span class="comment">#删除标签</span></div><div class="line">git tag -d v0.1</div><div class="line"></div><div class="line"><span class="comment">#推送某个标签到远程</span></div><div class="line">git push origin v1.0</div><div class="line"><span class="comment">#一次性推送全部尚未推送到远程的本地标签</span></div><div class="line">git push origin --tags</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#删除远程标签</span></div><div class="line"><span class="comment">#先从本地删除</span></div><div class="line">git tag -d v0.9</div><div class="line"><span class="comment">#删除远程tag(推送空tab到远程tag)</span></div><div class="line">git push origin :refs/tags/v0.9</div><div class="line"></div><div class="line"><span class="comment">#删除远程tag</span></div><div class="line">git push origin --delete tag &lt;tagname&gt;</div><div class="line"></div><div class="line">git checkout -b v2.5 2.5</div></pre></td></tr></table></figure>
<h1 id="使用GitHub"><a href="#使用GitHub" class="headerlink" title="使用GitHub"></a>使用GitHub</h1><p>在GitHub上，可以任意Fork开源仓库；<br>自己拥有Fork后的仓库的读写权限；<br>可以推送pull request给官方仓库来贡献代码。</p>
<h1 id="自定义Git"><a href="#自定义Git" class="headerlink" title="自定义Git"></a>自定义Git</h1><h2 id="忽略特殊文件"><a href="#忽略特殊文件" class="headerlink" title="忽略特殊文件"></a>忽略特殊文件</h2><p>Git工作区的根目录下创建一个特殊的.gitignore文件，然后把要忽略的文件名填进去</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Windows:</span></div><div class="line">Thumbs.db</div><div class="line">ehthumbs.db</div><div class="line">Desktop.ini</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#检测某文件如何被忽略</span></div><div class="line">git check-ignore -v App.class</div></pre></td></tr></table></figure>
<h1 id="从其他分支检出指定文件和并至当前分支"><a href="#从其他分支检出指定文件和并至当前分支" class="headerlink" title="从其他分支检出指定文件和并至当前分支"></a>从其他分支检出指定文件和并至当前分支</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git checkout master</div><div class="line">git checkout dev file4.txt</div><div class="line">git checkout dev file5.txt file6.txt</div></pre></td></tr></table></figure>
<h1 id="不同项目使用不同git账号"><a href="#不同项目使用不同git账号" class="headerlink" title="不同项目使用不同git账号"></a>不同项目使用不同git账号</h1><p>~/.ssh/目录下不存在config文件，则新建一个，内容写上（不同中央仓库使用不同账号和不同私钥）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"># 该配置用于工作</div><div class="line"># Host 服务器别名</div><div class="line">Host 192.168.2.36</div><div class="line"># HostName 服务器ip地址或机器名</div><div class="line">HostName 192.168.2.36</div><div class="line"># User连接服务器的用户名</div><div class="line">User huanghs</div><div class="line"># IdentityFile 密匙文件的具体路径</div><div class="line">IdentityFile C:/Users/P/.ssh/id_rsa</div><div class="line"></div><div class="line"></div><div class="line"># 该配置用于个人 github 上</div><div class="line"># Host 服务器别名</div><div class="line">Host github.com</div><div class="line"># HostName 服务器ip地址或机器名</div><div class="line">HostName github.com</div><div class="line"># User连接服务器的用户名</div><div class="line">User hasonHuang</div><div class="line"># IdentityFile 密匙文件的具体路径</div><div class="line">IdentityFile C:/Users/P/.ssh/id_rsa_hason</div></pre></td></tr></table></figure>
<p>设置当前项目用户名和邮箱：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git config user.name <span class="string">"newname"</span></div><div class="line">git config user.email <span class="string">"newemail"</span></div></pre></td></tr></table></figure>
<ul>
<li><a href="http://blog.csdn.net/a258831020/article/details/50373060" title="Git使用多个帐号" target="_blank" rel="external">Git使用多个帐号</a>
</li>
</ul>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><ul>
<li><a href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000" title="Git教程-廖雪峰的官方网站" target="_blank" rel="external">Git教程-廖雪峰的官方网站</a>
</li>
</ul>
<h1 id="分支策略-1"><a href="#分支策略-1" class="headerlink" title="分支策略"></a>分支策略</h1><h2 id="fetct-And-rebase"><a href="#fetct-And-rebase" class="headerlink" title="fetct And rebase"></a>fetct And rebase</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">git fetch</div><div class="line">git rebase</div><div class="line"><span class="comment"># 解决冲突</span></div><div class="line">git add files</div><div class="line">git rebase --<span class="built_in">continue</span></div></pre></td></tr></table></figure>
<a href="https://segmentfault.com/q/1010000000430041" title="参考文档" target="_blank" rel="external">参考文档</a>
<a href="http://www.tuicool.com/articles/NzeQZz3" title="参考文档" target="_blank" rel="external">参考文档</a>
<h1 id="Git-记住账号、密码，不用每次pull和push都输入密码"><a href="#Git-记住账号、密码，不用每次pull和push都输入密码" class="headerlink" title="Git 记住账号、密码，不用每次pull和push都输入密码"></a>Git 记住账号、密码，不用每次pull和push都输入密码</h1><p>命令行输入：git config –global credential.helper store<br>表示凭证方式为存储<br>然后进行一次pull操作，输入账号密码之后，以后就不会再要求输入密码了</p>
<p>如果你连这次密码都不想输入的话，那么可以这么干：<br>打开git-bash<br>cd ~/<br>vim .git-credentials<br>输入 <a href="http://{username}:{password}@source.jd.com" target="_blank" rel="external">http://{username}:{password}@source.jd.com</a><br>然后退出保存就可以了</p>
<h1 id="恢复删除的stash"><a href="#恢复删除的stash" class="headerlink" title="恢复删除的stash"></a>恢复删除的stash</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 查看已删除stash</span></div><div class="line">git fsck --lost-found</div><div class="line"></div><div class="line"><span class="comment"># 使用git show 查看dangling commit的id</span></div><div class="line">git show 8dd73fa8d14880182f11e24dc10bca570b6127d7</div><div class="line"></div><div class="line"><span class="comment"># 执行git merge进行恢复</span></div><div class="line">git merge 8dd73fa8d14880182f11e24dc10bca570b6127d7</div></pre></td></tr></table></figure>
<h1 id="使用Beyond-Compare作为比较-amp-合并工具"><a href="#使用Beyond-Compare作为比较-amp-合并工具" class="headerlink" title="使用Beyond Compare作为比较&amp;合并工具"></a>使用Beyond Compare作为比较&amp;合并工具</h1><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>Open the file <code>c:\users\username\.gitconfig</code> in a text editor.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[diff]</div><div class="line">	tool = bc4</div><div class="line">[difftool &quot;bc4&quot;]</div><div class="line">	cmd = \&quot;d:/program files (x86)/beyond compare 4/bcomp.exe\&quot; \&quot;$LOCAL\&quot; \&quot;$REMOTE\&quot;</div><div class="line">[merge]</div><div class="line">	tool = bc4</div><div class="line">[mergetool &quot;bc4&quot;]</div><div class="line">	cmd = \&quot;d:/program files (x86)/beyond compare 4/bcomp.exe\&quot; \&quot;$LOCAL\&quot; \&quot;$REMOTE\&quot; \&quot;$BASE\&quot; \&quot;$MERGED\&quot;</div><div class="line">	trustExitCode = true</div><div class="line">[mergetool]</div><div class="line">	keepBackup = false</div></pre></td></tr></table></figure>
<blockquote>
<p>keepBackup = false<br>执行合并后，带有冲突标记的原始文件默认保存为带有 .orig 扩展名的文件；设置不保留原始冲突文件</p>
</blockquote>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 比较文件</span></div><div class="line">git difftool &lt;filename&gt;</div><div class="line"><span class="comment"># 解决冲突</span></div><div class="line">git mergetool &lt;filename&gt;</div></pre></td></tr></table></figure>
<h2 id="Beyond-Compare解决冲突"><a href="#Beyond-Compare解决冲突" class="headerlink" title="Beyond Compare解决冲突"></a>Beyond Compare解决冲突</h2><img src="/2016/08/21/git-note/182190-20161031184505205-1842561751.png" alt="182190-20161031184505205-1842561751.png" title="">
<p>由上图可以看出，左边是当前分支的版本，右边的是需要合并的分支的版本，中间的是相同部分的版本，处理冲突的策略大概有以下几种：</p>
<ul>
<li>当前分支版本替换合并分支版本，点击绿色的箭头。</li>
<li>合并分支版本替换当前分支版本，点击粉色的箭头。</li>
<li>同时需要两个版本的内容，点击绿色或粉色的箭头，然后把另外的分支的内容拷贝到下方的文本编辑框。</li>
<li>最后，点击红色的感叹号，表示已解决冲突</li>
</ul>
<a href="http://www.cnblogs.com/Erik_Xu/p/5655525.html" title="使用Beyond Compare作为差异比较工具" target="_blank" rel="external">使用Beyond Compare作为差异比较工具</a>
<h1 id="分支策略-2"><a href="#分支策略-2" class="headerlink" title="分支策略"></a>分支策略</h1><h2 id="fetct-And-rebase-1"><a href="#fetct-And-rebase-1" class="headerlink" title="fetct And rebase"></a>fetct And rebase</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 衍合远程分支</span></div><div class="line"><span class="comment"># 切换至目标分支，获取远程更新</span></div><div class="line"><span class="comment"># git fetch取回所有分支（branch）的更新</span></div><div class="line">git fetch origin dev</div><div class="line"><span class="comment"># 执行rebase</span></div><div class="line">git rebase origin/dev</div><div class="line"><span class="comment"># 解决冲突</span></div><div class="line">git add files</div><div class="line">git rebase --<span class="built_in">continue</span></div><div class="line"><span class="comment"># 中止rebase</span></div><div class="line">git rebase --abort</div></pre></td></tr></table></figure>
<h2 id="合并分支"><a href="#合并分支" class="headerlink" title="合并分支"></a>合并分支</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># dev分支，获取更新</span></div><div class="line">git pull</div><div class="line"><span class="comment"># dev分支衍合进my-dev分支</span></div><div class="line"><span class="comment"># dev分支更新会衍合至my-dev</span></div><div class="line">git rebase dev my-dev</div><div class="line"><span class="comment"># 切换至dev分支，合并my-dev更新</span></div><div class="line">git merge my-dev</div><div class="line">git rebase --<span class="built_in">continue</span></div></pre></td></tr></table></figure>
<h1 id="分支管理策略-1"><a href="#分支管理策略-1" class="headerlink" title="分支管理策略"></a>分支管理策略</h1><ul>
<li>从dev创建<code>本地</code>需求分支feature-xxx</li>
<li>合并需求分支，到dev-test进行测试</li>
<li>测试通过后，更新dev分支，衍合dev更新到需求分支，合并需求分支到dev分支</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 从dev创建需求分支</span></div><div class="line">git checkout dev</div><div class="line">git checkout -b feature-xxx</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 合并需求分支到dev-test</span></div><div class="line"><span class="comment"># 1.更新dev-test</span></div><div class="line">git checkout dev-test</div><div class="line">git pull dev-test</div><div class="line"><span class="comment"># 2.合并需求分支到dev-test</span></div><div class="line">git merge feature-xxx</div><div class="line"><span class="comment"># 3.推送至远程</span></div><div class="line">git push</div><div class="line"><span class="comment"># 3.1推送失败，衍合远程更新，再推送</span></div><div class="line">git fetch origin dev-test</div><div class="line">git rebase origin/dev-test</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 测试通过，合并feature-xxx到dev</span></div><div class="line"><span class="comment"># 1.更新dev</span></div><div class="line">git checkout dev</div><div class="line">git pull dev</div><div class="line"><span class="comment"># 2.衍合dev更新到feature-xxx</span></div><div class="line">git rebase dev feature-xxx</div><div class="line"><span class="comment"># 3.合并feature-xxx到dev</span></div><div class="line">git checkout dev</div><div class="line">git merge feature-xxx</div><div class="line"><span class="comment"># 4.推送至远程</span></div><div class="line">git push</div><div class="line"><span class="comment"># 4.1推送失败，衍合远程更新，再推送</span></div><div class="line">git fetch origin dev</div><div class="line">git rebase origin/dev</div></pre></td></tr></table></figure>
<h2 id="补丁"><a href="#补丁" class="headerlink" title="补丁"></a>补丁</h2><h3 id="生成补丁"><a href="#生成补丁" class="headerlink" title="生成补丁"></a>生成补丁</h3><h3 id="应用补丁"><a href="#应用补丁" class="headerlink" title="应用补丁"></a>应用补丁</h3><h1 id="Toos"><a href="#Toos" class="headerlink" title="Toos"></a>Toos</h1><h2 id="Combining-multiple-commits-into-one-using-git-rebase"><a href="#Combining-multiple-commits-into-one-using-git-rebase" class="headerlink" title="Combining multiple commits into one using git rebase"></a>Combining multiple commits into one using git rebase</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">log</span> --oneline</div><div class="line"><span class="comment"># git rebase -i &lt;变动的commit的SHA-1&gt;</span></div><div class="line">git rebase -i 0d6402c</div><div class="line"><span class="comment"># 修改提交策略</span></div><div class="line">pick fc62e55 added file_size</div><div class="line">pick 9824bf4 fixed little thing</div><div class="line">pick 21d80a5 added number to <span class="built_in">log</span></div><div class="line">pick 76b9da6 added the apply <span class="built_in">command</span></div><div class="line"><span class="comment">#  p, pick = use commit 使用提交</span></div><div class="line"><span class="comment">#  e, edit = use commit, but stop for amending 使用提交，但是暂停以便进行修正</span></div><div class="line"><span class="comment">#  s, squash = use commit, but meld into previous commit 使用提交，但是把它与前一提交合并</span></div><div class="line"><span class="comment">#  以对这些行上下移动从而对提交进行重排序</span></div><div class="line">pick   fc62e55 added file_size</div><div class="line">squash 9824bf4 fixed little thing</div><div class="line">squash 21d80a5 added number to <span class="built_in">log</span></div><div class="line">squash 76b9da6 added the apply <span class="built_in">command</span></div><div class="line"></div><div class="line"><span class="comment"># 终止</span></div><div class="line">git rebase --abort</div></pre></td></tr></table></figure>
<h2 id="fatal-Cannot-update-paths-and-switch-to-branch-‘develop’-at-the-same-time"><a href="#fatal-Cannot-update-paths-and-switch-to-branch-‘develop’-at-the-same-time" class="headerlink" title="fatal: Cannot update paths and switch to branch ‘develop’ at the same time."></a>fatal: Cannot update paths and switch to branch ‘develop’ at the same time.</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 查看不到远程分支</span></div><div class="line">git branch -a</div><div class="line">git fetch</div><div class="line"></div><div class="line">git fetch origin_waybill</div><div class="line"></div><div class="line"><span class="comment"># 指定fetch远程仓库</span></div><div class="line">git fetch uat_origin</div></pre></td></tr></table></figure>
<h2 id="Overwrite-master-with-branch"><a href="#Overwrite-master-with-branch" class="headerlink" title="Overwrite master with branch"></a>Overwrite master with branch</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># rewrite local master branch.</span></div><div class="line"><span class="comment"># Reset &lt;branchname&gt; to &lt;startpoint&gt;</span></div><div class="line">git branch -f master dev_branch</div><div class="line"><span class="comment"># rewrite remote branch</span></div><div class="line">git push remote +dev_branch:master</div></pre></td></tr></table></figure>
<h2 id="保护分支"><a href="#保护分支" class="headerlink" title="保护分支"></a>保护分支</h2><p>登录 gitlab，进入项目页面，单击修改图标，选择“Protected Branches”</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> git </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Mongodb Note]]></title>
      <url>http://xiaozhuang.github.io/2016/08/21/mongodb_note/</url>
      <content type="html"><![CDATA[<p>MongoDB是为处理大数据而生的一款面向文档的数据库，由10gen公司开发和维护;<br>使用场景,Web应用程序、分析与记录应用程序，以及任何要求有中等级别缓存的应用程序。此外，由于能方便地存储无Schema数据，MongoDB还很适合保存事先无法知晓其数据结构的数据。</p>
<a id="more"></a>
<h1 id="MongoDB资源网站："><a href="#MongoDB资源网站：" class="headerlink" title="MongoDB资源网站："></a>MongoDB资源网站：</h1><ul>
<li><a href="https://www.mongodb.com/" title="MongoDB官网" target="_blank" rel="external">MongoDB官网</a></li>
<li><a href="http://www.mongoing.com/" title="MongoDB中文官网" target="_blank" rel="external">MongoDB中文官网</a></li>
<li><a href="https://docs.mongodb.com/" title="文档" target="_blank" rel="external">文档</a></li>
<li><a href="http://docs.mongoing.com/manual-zh/tutorial/text-search-with-rlp.html" title="中文文档" target="_blank" rel="external">中文文档</a></li>
<li><a href="https://github.com/mongodb/" title="github" target="_blank" rel="external">github</a></li>
<li><a href="https://jira.mongodb.org/secure/Dashboard.jspa" title="jira" target="_blank" rel="external">jira</a></li>
<li><a href="https://groups.google.com/forum/#!forum/mongodb-user" title="mongodb-user" target="_blank" rel="external">mongodb-user</a></li>
<li><a href="https://groups.google.com/forum/#!forum/mongo-cn" title="mongo-cn" target="_blank" rel="external">mongo-cn</a>
</li>
</ul>
<h1 id="sql数据库与nosql数据库对比"><a href="#sql数据库与nosql数据库对比" class="headerlink" title="sql数据库与nosql数据库对比"></a>sql数据库与nosql数据库对比</h1><table>
<thead>
<tr>
<th>sql数据库</th>
<th>nosql数据库 </th>
</tr>
</thead>
<tbody>
<tr>
<td>实时一致性</td>
<td>简单便捷</td>
</tr>
<tr>
<td>事务</td>
<td>方便扩展</td>
</tr>
<tr>
<td>多表联合查询</td>
<td>更好的性能</td>
</tr>
</tbody>
</table>
<h1 id="MongoDB特点"><a href="#MongoDB特点" class="headerlink" title="MongoDB特点"></a>MongoDB特点</h1><h2 id="无数据结构限制"><a href="#无数据结构限制" class="headerlink" title="无数据结构限制"></a>无数据结构限制</h2><ul>
<li>没有表结构，每条记录可以有完全不同的结构（不需要事先定义表结构再使用）</li>
<li>业务开发方便快捷</li>
</ul>
<h2 id="完全的索引支持"><a href="#完全的索引支持" class="headerlink" title="完全的索引支持"></a>完全的索引支持</h2><ul>
<li>单键索引，多键索引</li>
<li>数组索引</li>
<li>全文索引（不支持中文）</li>
<li>地理位置索引（2D）</li>
</ul>
<blockquote>
<p>redis支持key-value索引；hbase支持单索引，二级索引需要自己实现；</p>
</blockquote>
<h2 id="方便的冗余与扩展"><a href="#方便的冗余与扩展" class="headerlink" title="方便的冗余与扩展"></a>方便的冗余与扩展</h2><ul>
<li>复制集保证数据安全</li>
<li>分片扩展数据规模</li>
</ul>
<h2 id="良好的支持"><a href="#良好的支持" class="headerlink" title="良好的支持"></a>良好的支持</h2><ul>
<li>完善的文档</li>
<li>齐全的驱动支持</li>
</ul>
<h1 id="MongoDB安装"><a href="#MongoDB安装" class="headerlink" title="MongoDB安装"></a>MongoDB安装</h1><p>MongoDB版本，格式a.b.c，b为偶数代表稳定版</p>
<h2 id="编译源码或下载二进制安装包"><a href="#编译源码或下载二进制安装包" class="headerlink" title="编译源码或下载二进制安装包"></a>编译源码或下载二进制安装包</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#进入源码根目录，编译源码</span></div><div class="line">scons all</div></pre></td></tr></table></figure>
<p>二进制安装包下载地址:<br><a href="https://www.mongodb.com/download-center?jmp=nav#community" target="_blank" rel="external">https://www.mongodb.com/download-center?jmp=nav#community</a></p>
<h2 id="MongoDB程序"><a href="#MongoDB程序" class="headerlink" title="MongoDB程序"></a>MongoDB程序</h2><p>mongod：MongoDB执行程序<br>mongo：MongoDB客户端<br>mongoexport/mongoimport：导入/导出<br>mongodump/mongorestore：导入/导出二进制（数据备份）<br>mongooplog：操作日志回放<br>mongostat：MongoDB状态</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>创建MongoDB运行目录<br>conf：配置目录</p>
<blockquote>
<p>创建mongod.conf，添加配置：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">port=27017</div><div class="line">dbpath=data</div><div class="line">logpath=<span class="built_in">log</span>/mongod.log</div><div class="line"><span class="comment">#后台运行</span></div><div class="line">fork=<span class="literal">true</span></div><div class="line"><span class="comment">#开启认证</span></div><div class="line"><span class="comment">#auth = true</span></div></pre></td></tr></table></figure>
<p>data：数据目录<br>log：日志目录</p>
<h2 id="启动MongoDB"><a href="#启动MongoDB" class="headerlink" title="启动MongoDB"></a>启动MongoDB</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./bin/mongod -f conf/mongod.conf</div></pre></td></tr></table></figure>
<h2 id="使用客户端mongo连接数据库"><a href="#使用客户端mongo连接数据库" class="headerlink" title="使用客户端mongo连接数据库"></a>使用客户端mongo连接数据库</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./bin/mongo 127.0.0.1:27017/<span class="built_in">test</span></div></pre></td></tr></table></figure>
<h2 id="停止MongoDB服务"><a href="#停止MongoDB服务" class="headerlink" title="停止MongoDB服务"></a>停止MongoDB服务</h2><p>方式1：从客户端停止</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#切换到admin数据库</span></div><div class="line">use admin</div><div class="line"><span class="comment">#停止数据库服务器</span></div><div class="line">db.shutdownServer()</div></pre></td></tr></table></figure>
<p>方式2：结束进程，使用kill -15 [pid]</p>
<h1 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h1><h2 id="查看数据库"><a href="#查看数据库" class="headerlink" title="查看数据库"></a>查看数据库</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">show dbs</div></pre></td></tr></table></figure>
<h2 id="更改当前操作的数据库"><a href="#更改当前操作的数据库" class="headerlink" title="更改当前操作的数据库"></a>更改当前操作的数据库</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#可以切换到不存在的数据库，在数据库中添加数据时，MongoDB会自动创建数据库</span></div><div class="line">use demo_db</div></pre></td></tr></table></figure>
<h2 id="查看数据库中集合"><a href="#查看数据库中集合" class="headerlink" title="查看数据库中集合"></a>查看数据库中集合</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">show tables</div></pre></td></tr></table></figure>
<h2 id="集合中增加数据"><a href="#集合中增加数据" class="headerlink" title="集合中增加数据"></a>集合中增加数据</h2><p>集合不存在时自动创建</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#语法：db.数据集名.insert(JSON数据)</span></div><div class="line">db.demo_collection.insert(&#123;x:1&#125;)</div><div class="line">db.demo_collection.insert(&#123;x:2,y:2&#125;)</div><div class="line"></div><div class="line"><span class="comment">#使用js语法添加多条数据</span></div><div class="line"><span class="keyword">for</span>(i = 3;i &lt; 100;i++) db.demo_collection.insert(&#123;x:i&#125;)</div></pre></td></tr></table></figure>
<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#语法：db.数据集名.find(查询条件)，查询条件为空，查询全部</span></div><div class="line">db.demo_collection.find()</div><div class="line">db.demo_collection.find(&#123;x:1&#125;)</div><div class="line"></div><div class="line"><span class="comment">#查询数量条数</span></div><div class="line">db.demo_collection.find().count()</div><div class="line"></div><div class="line"><span class="comment">#查询偏移</span></div><div class="line">db.demo_collection.find().skip(3).<span class="built_in">limit</span>(2).sort(&#123;x:1&#125;)</div><div class="line"></div><div class="line"><span class="comment">#排序，&#123;字段：规则&#125;，1：正序，-1：倒序</span></div><div class="line">db.demo_collection.find().skip(3).<span class="built_in">limit</span>(2).sort(&#123;x:1&#125;)</div></pre></td></tr></table></figure>
<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#将符合条件的文档更新为&#123;x:999&#125;</span></div><div class="line">db.demo_collection.update(&#123;x:1&#125;,&#123;x:999&#125;);</div><div class="line"></div><div class="line"><span class="comment">#部分更新</span></div><div class="line">db.demo_collection.update(&#123;z:3&#125;,&#123;<span class="variable">$set</span>:&#123;y:99&#125;&#125;)</div><div class="line"></div><div class="line"><span class="comment">#更新数据不存在则insert</span></div><div class="line">db.demo_collection.update(&#123;y:100&#125;,&#123;y:999&#125;,<span class="literal">true</span>)</div><div class="line"></div><div class="line"><span class="comment">#若满足条件数据有多条，仅更新一条</span></div><div class="line">db.demo_collection.update(&#123;c:1&#125;,&#123;c:2&#125;)</div><div class="line"></div><div class="line"><span class="comment">#更新多条数据，更新多条数据只能使用 $ operators</span></div><div class="line">db.demo_collection.update(&#123;c:1&#125;,&#123;<span class="variable">$set</span>:&#123;c:2&#125;&#125;,<span class="literal">false</span>,<span class="literal">true</span>)</div></pre></td></tr></table></figure>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#执行删除必须指定条件，否则不删除任何数据</span></div><div class="line">db.demo_collection.remove(&#123;c:2&#125;)</div><div class="line"></div><div class="line"><span class="comment">#删除集合</span></div><div class="line">db.demo_collection.drop()</div></pre></td></tr></table></figure>
<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><h2 id="索引种类"><a href="#索引种类" class="headerlink" title="索引种类"></a>索引种类</h2><ul>
<li>_id索引</li>
<li>单键索引</li>
<li>多键索引</li>
<li>复合索引</li>
<li>过期索引</li>
<li>全文索引</li>
<li>地理位置索引</li>
</ul>
<h2 id="id索引"><a href="#id索引" class="headerlink" title="_id索引"></a>_id索引</h2><p>绝大多数集合默认创建的索引<br>对于每个插入的数据，MongoDB会自动生成一条唯一的_id字段</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查看集合中索引</span></div><div class="line">db.demo_collection.getIndexes()</div></pre></td></tr></table></figure>
<h2 id="单键索引"><a href="#单键索引" class="headerlink" title="单键索引"></a>单键索引</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 创建单键索引，索引可以重复创建，创建已存在的索引，返回success</span></div><div class="line"><span class="comment"># 索引值：1，正向索引；-1：逆向索引；</span></div><div class="line">db.demo_collection.ensureIndex(&#123;x:1&#125;)</div></pre></td></tr></table></figure>
<h2 id="多键索引"><a href="#多键索引" class="headerlink" title="多键索引"></a>多键索引</h2><p>多键索引与单键索引创建形式相同，区别在于字段的值<br>单键索引：值为一个单一的值，如：字符串，数字或日期<br>多键索引：值具有多个记录，如：数组</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#若已在x上创建单键索引，添加数据为数组的记录，MongoDB将为该记录创建多键索引</span></div><div class="line">db.demo_collection.insert(&#123;x:[1,2,3,4,5]&#125;)</div></pre></td></tr></table></figure>
<h2 id="复合索引"><a href="#复合索引" class="headerlink" title="复合索引"></a>复合索引</h2><p>当查询条件不只有一个时，需要创建符合索引</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">db.demo_collection.ensureIndex(&#123;x:1,y:-1&#125;)</div><div class="line"></div><div class="line"><span class="comment">#使用符合索引</span></div><div class="line">db.demo_collection.find(&#123;x:1,y:2&#125;)</div></pre></td></tr></table></figure>
<h2 id="过期索引"><a href="#过期索引" class="headerlink" title="过期索引"></a>过期索引</h2><p>一段时间后会过期的索引<br>索引过期后，响应的数据会被删除<br>适合存储一段时间后会失效的数据，如：用户登录信息，日志；</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#指定过期时间，单位：s</span></div><div class="line">db.demo_collection.ensureIndex(&#123;time:1&#125;,&#123;expireAfterSeconds:30&#125;)</div><div class="line"><span class="comment">#插入数据</span></div><div class="line">db.demo_collection.insert(&#123;</div><div class="line">	time:new Date()</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<blockquote>
<p>过期索引的限制</p>
<ul>
<li>存储在过期索引字段的值必须是时间类型，必须是ISODate或者ISODate数组，不能使用时间戳，否则不能被自动删除</li>
<li>指定ISODate数组，按最小时间进行删除</li>
<li>过期索引不能是符合索引</li>
<li>删除时间是不精确的，删除过程是有后台进程每60s跑一次，而且删除也需要时间，所以存在误差</li>
</ul>
</blockquote>
<h1 id="Spring应用中使用MongoDB"><a href="#Spring应用中使用MongoDB" class="headerlink" title="Spring应用中使用MongoDB"></a>Spring应用中使用MongoDB</h1>]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mongodb </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Groovy Note]]></title>
      <url>http://xiaozhuang.github.io/2016/08/11/groovy-note/</url>
      <content type="html"><![CDATA[<p>Groovy是运行在JVM上轻量级的、限制较少的、面向对象的动态语言。<br>动态语言的灵活性给我们带来了在应用执行时演进程序的优势。这远远超越了代码生成。<br>代码生成是20世纪才会考虑的技术。动态语言有更好的方式。<br><a id="more"></a></p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>groovyConsole:<br>启动：groovy-2.4.7path\bin\groovyConsole.bat<br>Ctrl+Enter:运行脚本<br>Ctrl+W:清除控制台输出</p>
<p>groovyConsole引入jar包，将jar包添加到{groovy.home}/lib/或{user.home}/.groovy/lib/目录下，重启groovyConsole</p>
<h1 id="面向java开发者的Groovy"><a href="#面向java开发者的Groovy" class="headerlink" title="面向java开发者的Groovy"></a>面向java开发者的Groovy</h1><h1 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h1><p>Groovy中闭包是去掉了冗长感的短小的匿名方法。</p>
<h2 id="闭包的便利性"><a href="#闭包的便利性" class="headerlink" title="闭包的便利性"></a>闭包的便利性</h2><p>Groovy中的闭包完全避免了代码的冗长，而且可以辅助创建<code>轻量级</code>、<code>可复用</code>的<code>代码片段</code>。</p>
<h2 id="Groovy闭包使用方式"><a href="#Groovy闭包使用方式" class="headerlink" title="Groovy闭包使用方式"></a>Groovy闭包使用方式</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> pickEven(n, block)&#123;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">2</span>;i &lt;= n; i++)&#123;</div><div class="line">		block(i)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">pickEven(<span class="number">10</span>,&#123;print it &#125;)</div><div class="line"></div><div class="line"><span class="comment">//当闭包是方法调用的最后一个参数时，可以将闭包附到方法调用上</span></div><div class="line">pickEven(<span class="number">10</span>) &#123;print it&#125;</div></pre></td></tr></table></figure>
<p>Groovy中闭包不能单独存在，只能<code>附到一个方法上</code>，或是<code>赋值给一个变量</code></p>
<p>闭包是一个函数，这里的变量都绑定到了一个上下文环境中，函数在其中执行</p>
<h2 id="向闭包传递参数"><a href="#向闭包传递参数" class="headerlink" title="向闭包传递参数"></a>向闭包传递参数</h2><p>对于单参数的闭包，it是该参数的默认名称。<br>如果传入的参数多于一个，就需要通过名字一一列出。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> tellFortune(closure)&#123;</div><div class="line">	closure <span class="keyword">new</span> Date(<span class="string">"09/20/2012"</span>), <span class="string">"Your day is filled with ceremony"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">tellFortune()&#123;date,fortune -&gt;</div><div class="line">	println <span class="string">"Fortune for $&#123;date&#125; is '$&#123;fortune&#125;'"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="使用闭包进行资源清理"><a href="#使用闭包进行资源清理" class="headerlink" title="使用闭包进行资源清理"></a>使用闭包进行资源清理</h2><p>自动处理文件流flush和close</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> FileWriter(<span class="string">'output.txt'</span>).withWriter&#123;</div><div class="line">	writer -&gt; writer.write(<span class="string">'a'</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>自定义类Resource，使用前自动调用open(),使用后自动调用close()</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Resource</span> &#123;</span></div><div class="line">	<span class="keyword">def</span> open()&#123;</div><div class="line">		print <span class="string">"opened..."</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">def</span> close()&#123;</div><div class="line">		print <span class="string">"closed"</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">def</span> read()&#123;</div><div class="line">		print <span class="string">"read..."</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">def</span> write()&#123;</div><div class="line">		print <span class="string">"write..."</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">def</span> <span class="keyword">static</span> use(closure)&#123;</div><div class="line">		<span class="keyword">def</span> r = <span class="keyword">new</span> Resource()</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			r.open()</div><div class="line">			closure(r)</div><div class="line">		&#125; <span class="keyword">finally</span>&#123;</div><div class="line">			r.close()</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">def</span> args)&#123;</div><div class="line">		<span class="comment">//使用</span></div><div class="line">		Resource.use(&#123; res -&gt;</div><div class="line">			res.read()</div><div class="line">			res.write()</div><div class="line">		&#125;)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>使用Execute Around Method模式<br>接收一个块作为参数。在方法中，把对该块的调用夹到对那对方法的调用中间。<br>先调用第一个方法，然后调用该块，最后调用第二个方法。</p>
</blockquote>
<h2 id="闭包与协程"><a href="#闭包与协程" class="headerlink" title="闭包与协程"></a>闭包与协程</h2><p>调用一个函数或方法会在程序的执行序列中创建一个新的作用域。在一个入口点（方法最上面的语句）进入函数，在方法完成之后，回到调用者的作用域。</p>
<p>协程（Coroutine）则支持多个入口点，每个入口点都是上次挂起调用的位置。<br>我们可以进入一个函数，执行部分代码，挂起，再回到调用者的上下文或作用域执行一些代码。之后我们可以在挂起的地方恢复该函数的执行。</p>
<p>java中，wait() 和 notify() 与多线程结合使用，可以协助实现协程。</p>
<p>闭包会让人产生“协程是在一个线程中执行”的感觉（或者说错觉）。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> iterate(n, closure)&#123;</div><div class="line">	<span class="number">1.</span>upto(n) &#123;</div><div class="line">		println <span class="string">"In iterate with value $&#123;it&#125;"</span></div><div class="line">		closure(it)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">println <span class="string">"Calling iterate"</span></div><div class="line"><span class="keyword">def</span> total = <span class="number">0</span></div><div class="line">iterate(<span class="number">4</span>)&#123;</div><div class="line">	total += it</div><div class="line">	println <span class="string">"In closure total so far is $&#123;total&#125;"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>输出：<br>Calling iterate<br>In iterate with value 1<br>In closure total so far is 1<br>In iterate with value 2<br>In closure total so far is 3<br>In iterate with value 3<br>In closure total so far is 6<br>In iterate with value 4<br>In closure total so far is 10</p>
</blockquote>
<h2 id="科里化闭包-Curried-Closure"><a href="#科里化闭包-Curried-Closure" class="headerlink" title="科里化闭包(Curried Closure)"></a>科里化闭包(Curried Closure)</h2><p>带有预绑定参数的闭包叫做科里化闭包</p>
<p>对一个闭包调用curry()，预先绑定参数</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> tellFortunes(closure)&#123;</div><div class="line">	Date date = <span class="keyword">new</span> Date(<span class="string">"09/20/2012"</span>);</div><div class="line">	<span class="comment">//closure date, "Your day is filled with ceremony"</span></div><div class="line">	<span class="comment">//closure date, "They're features, not bugs"</span></div><div class="line">	</div><div class="line">	<span class="comment">//可以通过科里化避免重复发送date,postfortune保存科里化之后的闭包</span></div><div class="line">	<span class="keyword">def</span> postfortune = closure.curry(date)</div><div class="line">	</div><div class="line">	postfortune <span class="string">"Your day is filled with ceremony"</span></div><div class="line">	postfortune <span class="string">"They're features, not bugs"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">tellFortunes()&#123;date, fortune -&gt;</div><div class="line">	println <span class="string">"Fortune for $&#123;date&#125; is '$&#123;fortune&#125;'"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>科里化后面的形参，可以使用rcurry().<br>科里化位于形参列表中间的形参，可以使用ncurry()<br>ncurry()有两个版本</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//科里化位于位置n的形参</span></div><div class="line"><span class="keyword">public</span> Closure&lt;V&gt; ncurry(<span class="keyword">int</span> n,Object argument)</div><div class="line"></div><div class="line"><span class="comment">//科里化从n开始的多个参数</span></div><div class="line"><span class="keyword">public</span> Closure&lt;V&gt; ncurry(<span class="keyword">int</span> n,Object...argument)</div></pre></td></tr></table></figure>
<h2 id="动态闭包"><a href="#动态闭包" class="headerlink" title="动态闭包"></a>动态闭包</h2><p>动态检查闭包是否提供以及闭包参数数量和类型</p>
<p>检查闭包是否提供</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> doSomeThing(closure)&#123;</div><div class="line">        <span class="keyword">if</span>(closure)&#123;</div><div class="line">            closure()</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            println <span class="string">"Using default implementation"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">doSomeThing()&#123;</div><div class="line">    println <span class="string">"Use specialized implementation"</span></div><div class="line">&#125;</div><div class="line">doSomeThing()</div></pre></td></tr></table></figure>
<p>检查形参个数（maximumNumberOfParameters属性或getMaximumNumberOfParameters()方法）</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//计算税额</span></div><div class="line"><span class="keyword">def</span> completeOrder(amount, taxComputer)&#123;</div><div class="line">	tax = <span class="number">0</span></div><div class="line">	<span class="keyword">if</span>(taxComputer.maximumNumberOfParameters ==<span class="number">2</span>)&#123;<span class="comment">//期望传入税率</span></div><div class="line">		tax = taxComputer(amount, <span class="number">6.05</span>)</div><div class="line">	&#125;<span class="keyword">else</span>&#123;<span class="comment">//税额计算闭包，不需传递税率</span></div><div class="line">		tax = taxComputer(amount)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	println <span class="string">"Sales tax is $&#123;tax&#125;"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">completeOrder(<span class="number">100</span>)&#123; it * <span class="number">0.0825</span>&#125;</div><div class="line"></div><div class="line">completeOrder(<span class="number">100</span>)&#123; amount, rate -&gt; amount *(rate/<span class="number">100</span>)&#125;</div></pre></td></tr></table></figure>
<p>检查参数类型（parametertypes属性或getParameterTypes()方法获知参数类型）</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> examine(closure)&#123;</div><div class="line">    println <span class="string">"$closure.maximumNumberOfParameters parameter(s) ginven:"</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span>(aParameter <span class="keyword">in</span> closure.parameterTypes)&#123;</div><div class="line">    	println aParameter.name</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">examine()&#123;&#125;</div><div class="line">examine()&#123;it&#125;</div><div class="line">examine()&#123;-&gt;&#125;</div><div class="line">examine()&#123;vall -&gt;&#125;</div><div class="line">examine()&#123;Date val1 -&gt;&#125;</div><div class="line">examine()&#123;Date val1,val2 -&gt;&#125;</div><div class="line">examine()&#123;Date val1, String val2 -&gt;&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>输出：<br>1 parameter(s) ginven:<br>java.lang.Object<br>1 parameter(s) ginven:<br>java.lang.Object<br>0 parameter(s) ginven:<br>1 parameter(s) ginven:<br>java.lang.Object<br>1 parameter(s) ginven:<br>java.util.Date<br>2 parameter(s) ginven:<br>java.util.Date<br>java.lang.Object<br>2 parameter(s) ginven:<br>java.util.Date<br>java.lang.String</p>
</blockquote>
<p>即便一个闭包没有使用任何参数，就像{} 或 {it}，它也会接受一个参数（名字默认为it）<br>如果希望闭包完全不接受任何参数，必须使用{ -&gt; }语法</p>
<h2 id="闭包委托"><a href="#闭包委托" class="headerlink" title="闭包委托"></a>闭包委托</h2><p>Groovy中的闭包远远超越了简单的匿名函数<br>Groovy闭包支持方法委托，而且提供了方法分派能力</p>
<p>this、owner和delegate是闭包的三个属性，用于确定由哪个对象处理该闭包内的方法调用</p>
<p>this指向该闭包所绑定的对象(即该闭包的类的实例对象)<br>owner指向定义它的对象<br>一般delegate设置为owner，但可对其加以修改，以挖掘出Groovy的一些元编程能力</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> examiningClosure(closure)&#123;</div><div class="line">	closure()</div><div class="line">&#125;</div><div class="line"></div><div class="line">examiningClosure()&#123;</div><div class="line">	println <span class="string">"In First Closure:"</span></div><div class="line">	println <span class="string">"class is "</span> + getClass().name</div><div class="line">	println <span class="string">"this is "</span> + <span class="keyword">this</span> + <span class="string">", supper:"</span> + <span class="keyword">this</span>.getClass().superclass</div><div class="line">	println <span class="string">"owner is "</span> + owner + <span class="string">", supper:"</span> + owner.getClass().superclass.name</div><div class="line">	println <span class="string">"delegate is "</span> + delegate + <span class="string">", super:"</span> + delegate.getClass().superclass.name</div><div class="line"></div><div class="line">	examiningClosure()&#123;</div><div class="line">		println <span class="string">"In First Closure:"</span></div><div class="line">		println <span class="string">"class is "</span> +  getClass().name</div><div class="line">		println <span class="string">"this is "</span> + <span class="keyword">this</span> + <span class="string">", supper:"</span> + <span class="keyword">this</span>.getClass().superclass.name</div><div class="line">		println <span class="string">"owner is "</span> + owner + <span class="string">", supper:"</span> + owner.getClass().superclass.name</div><div class="line">		println <span class="string">"delegate is "</span> + delegate + <span class="string">", super:"</span> + delegate.getClass().superclass.name</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In First Closure:<br>class is ConsoleScript0<code>$</code>_run_closure1<br>this is ConsoleScript0@2bdc426f, supper:class groovy.lang.Script<br>owner is ConsoleScript0@2bdc426f, supper:groovy.lang.Script<br>delegate is ConsoleScript0@2bdc426f, super:groovy.lang.Script<br>In First Closure:<br>class is ConsoleScript0<code>$</code>_run_closure1<code>$</code>_closure2<br>this is ConsoleScript0@2bdc426f, supper:groovy.lang.Script<br>owner is ConsoleScript0<code>$</code>_run_closure1@66cd72d, supper:groovy.lang.Closure<br>delegate is ConsoleScript0<code>$</code>_run_closure1@66cd72d, super:groovy.lang.Closure</p>
<p>在闭包内引用的变量或方法都会绑定到this，它负责处理任何方法调用，以及对任何属性或变量的访问。<br>如果this无法处理，则转向owner，最后是delegate</p>
<p>方法调用示例</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handler</span>&#123;</span></div><div class="line">	<span class="keyword">def</span> f1()&#123;</div><div class="line">		println <span class="string">"f1 of Handler called ..."</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">def</span> f2()&#123;</div><div class="line">		println <span class="string">"f2 of Handler called ..."</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span>&#123;</span></div><div class="line">	<span class="keyword">def</span> f1()&#123;</div><div class="line">		println <span class="string">"f1 of Example called ..."</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">def</span> f2()&#123;</div><div class="line">		println <span class="string">"f2 of Example called ..."</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">def</span> foo(closure)&#123;</div><div class="line">		closure.delegate = <span class="keyword">new</span> Handler()</div><div class="line">		closure()</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> f1()&#123;</div><div class="line">	println <span class="string">"f1 of Script called ..."</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">new</span> Example().foo()&#123;</div><div class="line">	<span class="comment">//1.this指向ConsoleScript实例，调用ConsoleScript.f1()</span></div><div class="line">	f1()</div><div class="line">	<span class="comment">//2.owner执向ConsoleScript实例，delegate执向Handler实例</span></div><div class="line">	<span class="comment">//调用Handler实例f2()</span></div><div class="line">	f2()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>f1 of Script called …<br>f2 of Handler called …</p>
</blockquote>
<h2 id="尾递归"><a href="#尾递归" class="headerlink" title="尾递归"></a>尾递归</h2><p>递归可以通过子问题的解决方案来解决主干问题。</p>
<p>借助编译器优化和语言支持，递归程序可以转换为迭代过程。<br>使用这种变换，可以编写出性能极高而且非常优雅的代码，还能获得简单迭代的效率优势。</p>
<p>计算阶乘</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> factorial  </div><div class="line"></div><div class="line">factorial = &#123;<span class="keyword">int</span> number, BigInteger theFactorial -&gt;</div><div class="line">	number == <span class="number">1</span> ? theFactorial : </div><div class="line">		factorial.trampoline(number <span class="number">-1</span>, number * theFactorial)</div><div class="line">&#125;.trampoline()</div><div class="line"></div><div class="line"></div><div class="line">println <span class="string">"factorial of 5 is $&#123;factorial(5, 1)&#125;"</span></div><div class="line"><span class="comment">//输出计算结果位数</span></div><div class="line">println <span class="string">"number of bits in the result is $&#123;factorial(5000, 1).bitCount()&#125;"</span></div></pre></td></tr></table></figure>
<blockquote>
<p>factorial of 5 is 120<br>number of bits in the result is 24654</p>
</blockquote>
<p>使用方法封装，使第二个参数为1</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">def</span> factorial(<span class="keyword">int</span> factorialFor)&#123;</div><div class="line">    <span class="keyword">def</span> tailFactorial</div><div class="line"></div><div class="line">    <span class="comment">//闭包使用默认值</span></div><div class="line">    tailFactorial = &#123;<span class="keyword">int</span> number, BigInteger theFactorial =  <span class="number">1</span> -&gt;</div><div class="line">        number == <span class="number">1</span> ? theFactorial : </div><div class="line">            tailFactorial.trampoline(number <span class="number">-1</span>, number * theFactorial)</div><div class="line">    &#125;.trampoline()</div><div class="line"></div><div class="line">    tailFactorial(factorialFor)</div><div class="line">&#125;</div><div class="line"></div><div class="line">println <span class="string">"factorial of 5 is $&#123;factorial(5)&#125;"</span></div><div class="line">println <span class="string">"number of bits in the result is $&#123;factorial(5000).bitCount()&#125;"</span></div></pre></td></tr></table></figure>
<blockquote>
<p>factorial of 5 is 120<br>number of bits in the result is 24654</p>
</blockquote>
<p>Groovy通过闭包上的一个便捷方法实现尾递归。这避免了对语言及其语法的整体影响，在减少内存占用的同时使编程变得更为优雅。</p>
<p>trampoline()性能比简单递归或纯碎迭代差一些。</p>
<h2 id="使用记忆化改进性能"><a href="#使用记忆化改进性能" class="headerlink" title="使用记忆化改进性能"></a>使用记忆化改进性能</h2><p>计算27寸长杆最大收益</p>
<h1 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h1><h2 id="字面常量与表达式"><a href="#字面常量与表达式" class="headerlink" title="字面常量与表达式"></a>字面常量与表达式</h2><h3 id="Groovy中使用单引号创建字面常量。"><a href="#Groovy中使用单引号创建字面常量。" class="headerlink" title="Groovy中使用单引号创建字面常量。"></a>Groovy中使用单引号创建字面常量。</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">println <span class="string">'He said, "That is Groovy"'</span></div></pre></td></tr></table></figure>
<blockquote>
<p>He said, “That is Groovy”</p>
</blockquote>
<h3 id="显示创建字符"><a href="#显示创建字符" class="headerlink" title="显示创建字符"></a>显示创建字符</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> mychar = <span class="string">'a'</span> <span class="keyword">as</span> <span class="keyword">char</span></div><div class="line">println mychar</div></pre></td></tr></table></figure>
<blockquote>
<p>有任何方法调用需要，Groovy可能会隐式地创建Character对象</p>
</blockquote>
<h3 id="对Stirng中的表达式进行求值运算，必须使用双引号"><a href="#对Stirng中的表达式进行求值运算，必须使用双引号" class="headerlink" title="对Stirng中的表达式进行求值运算，必须使用双引号"></a>对Stirng中的表达式进行求值运算，必须使用双引号</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">value = <span class="number">25</span></div><div class="line">println <span class="string">'The value is $&#123;value&#125;'</span></div></pre></td></tr></table></figure>
<blockquote>
<p>The value is ${value}</p>
</blockquote>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">value = <span class="number">25</span></div><div class="line">println <span class="string">"The value is $&#123;value&#125;"</span></div></pre></td></tr></table></figure>
<blockquote>
<p>The value is 25</p>
</blockquote>
<h3 id="java的String是不可变的，Groovy信守这种不可变性"><a href="#java的String是不可变的，Groovy信守这种不可变性" class="headerlink" title="java的String是不可变的，Groovy信守这种不可变性"></a>java的String是不可变的，Groovy信守这种不可变性</h3><p>可以使用[]操作符读取一个字符，不过不能修改</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">str = <span class="string">'hello'</span></div><div class="line">println str[<span class="number">2</span>]</div></pre></td></tr></table></figure>
<blockquote>
<p>a</p>
</blockquote>
<h3 id="使用双引号-“”-或正斜杠-创建表达式。"><a href="#使用双引号-“”-或正斜杠-创建表达式。" class="headerlink" title="使用双引号(“”)或正斜杠(//)创建表达式。"></a>使用双引号(“”)或正斜杠(//)创建表达式。</h3><p>双引号经常用于创建字符串表达式，正斜线用于正则表达式。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">value = <span class="number">12</span></div><div class="line"><span class="comment">//Groovy将$用于嵌入表达式。使用转移符（\）来打印$</span></div><div class="line">println <span class="string">"He paid \$$&#123;value&#125; for that"</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//表达式是简单变量名，或简单的属性存取器（accessor），包裹表达式的&#123;&#125;是可选的</span></div><div class="line">println <span class="string">"He paid \$$value for that."</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//定义字符串时使用正斜线，不必转义$</span></div><div class="line">println (<span class="regexp">/He  paid $$value for that./</span>)</div></pre></td></tr></table></figure>
<h3 id="Groovy惰性求值（lazy-evaluation）"><a href="#Groovy惰性求值（lazy-evaluation）" class="headerlink" title="Groovy惰性求值（lazy evaluation）"></a>Groovy惰性求值（lazy evaluation）</h3><p>即把一个表达式保存在一个字符串中，稍后再打印</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">what = <span class="keyword">new</span> StringBuilder(<span class="string">'fence'</span>)</div><div class="line">text = <span class="string">"The cow jumped over the $what"</span></div><div class="line">println text</div><div class="line"></div><div class="line">what.replace(<span class="number">0</span>, <span class="number">5</span>, <span class="string">"moon"</span>)</div><div class="line">println text</div><div class="line"></div><div class="line"><span class="comment">//需要惰性计算的字符串，Groovy自动使用GString类型</span></div><div class="line">println text.getClass().name</div><div class="line">println text.getClass().superclass</div></pre></td></tr></table></figure>
<blockquote>
<p>The cow jumped over the fence<br>The cow jumped over the moon<br>org.codehaus.groovy.runtime.GStringImpl<br>class groovy.lang.GString</p>
</blockquote>
<h2 id="GString-的惰性求值问题"><a href="#GString-的惰性求值问题" class="headerlink" title="GString 的惰性求值问题"></a>GString 的惰性求值问题</h2><p>表达式中使用的变量为不可变类型时，在表达式中简单替换它们无效</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">price = <span class="number">684.71</span></div><div class="line">company = <span class="string">'Google'</span></div><div class="line">quote = <span class="string">"Today $company stock closed at $price"</span></div><div class="line">println quote</div><div class="line"></div><div class="line">stocks = [<span class="string">Apple :</span> <span class="number">663.01</span>,<span class="string">Microsoft :</span> <span class="number">30.95</span>]</div><div class="line"></div><div class="line">stocks.each &#123; key,value -&gt;</div><div class="line">    company = key</div><div class="line">    price = value</div><div class="line">    println quote</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Today Google stock closed at 684.71<br>Today Google stock closed at 684.71<br>Today Google stock closed at 684.71</p>
</blockquote>
<p>GString表达式如何求值。<br>如果其中包含一个变量，变量的值会被简单地打印到一个Writer，通常是一个StringWriter。<br>如果GString包含一个闭包，该闭包会被调用；如果闭包接收一个参数，GString会把Writer对象作为参数发给它；如果闭包接收不止一个参数，调用失败。</p>
<p>使用闭包替换变量</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">price = <span class="number">684.71</span></div><div class="line">company = <span class="string">'Google'</span></div><div class="line"></div><div class="line">priceClosure = &#123; it.write(<span class="string">"$price"</span>)&#125;</div><div class="line">companyClosure = &#123;it.write(company)&#125;</div><div class="line"></div><div class="line">quote = <span class="string">"Today $&#123;companyClosure&#125; stock closed at $&#123;priceClosure&#125;"</span></div><div class="line"></div><div class="line">println quote</div><div class="line"></div><div class="line">stocks = [<span class="string">Apple :</span> <span class="number">663.01</span>,<span class="string">Microsoft :</span> <span class="number">30.95</span>]</div><div class="line"></div><div class="line">stocks.each &#123; key,value -&gt;</div><div class="line">    company = key</div><div class="line">    price = value</div><div class="line">    println quote</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>简化闭包代码</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">price = <span class="number">684.71</span></div><div class="line">company = <span class="string">'Google'</span></div><div class="line"></div><div class="line">priceClosure = &#123;-&gt; price &#125;</div><div class="line">companyClosure = &#123;-&gt; company &#125;</div><div class="line"></div><div class="line">quote = <span class="string">"Today $&#123;companyClosure&#125; stock closed at $&#123;priceClosure&#125;"</span></div><div class="line"></div><div class="line">println quote</div><div class="line"></div><div class="line">stocks = [<span class="string">Apple :</span> <span class="number">663.01</span>,<span class="string">Microsoft :</span> <span class="number">30.95</span>]</div><div class="line"></div><div class="line">stocks.each &#123; key,value -&gt;</div><div class="line">    company = key</div><div class="line">    price = value</div><div class="line">    println quote</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Today Google stock closed at 684.71<br>Today Apple stock closed at 663.01<br>Today Microsoft stock closed at 30.95</p>
</blockquote>
<p>表达式包含闭包</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">price = <span class="number">684.71</span></div><div class="line">company = <span class="string">'Google'</span></div><div class="line"></div><div class="line">quote = <span class="string">"Today $&#123;-&gt; company&#125; stock closed at $&#123;-&gt; price&#125;"</span></div><div class="line"></div><div class="line">println quote</div><div class="line"></div><div class="line">stocks = [<span class="string">Apple :</span> <span class="number">663.01</span>,<span class="string">Microsoft :</span> <span class="number">30.95</span>]</div><div class="line"></div><div class="line">stocks.each &#123; key,value -&gt;</div><div class="line">    company = key</div><div class="line">    price = value</div><div class="line">    println quote</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Today Google stock closed at 684.71<br>Today Apple stock closed at 663.01<br>Today Microsoft stock closed at 30.95</p>
</blockquote>
<p>如果希望改变表达式中可使用的引用，并且希望他们的当前值被用于惰性求值中；<br>不要在表达式中直接替换他们，而要使用一个无参闭包。</p>
<h2 id="多行字符串"><a href="#多行字符串" class="headerlink" title="多行字符串"></a>多行字符串</h2><h3 id="通过将字符串包含在3个单引号内（’’’…’’’）定义多行字面常亮"><a href="#通过将字符串包含在3个单引号内（’’’…’’’）定义多行字面常亮" class="headerlink" title="通过将字符串包含在3个单引号内（’’’…’’’）定义多行字面常亮"></a>通过将字符串包含在3个单引号内（’’’…’’’）定义多行字面常亮</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">memo = <span class="string">'''Serveral of you raised concerns about long meetings.</span></div><div class="line">To discuss this, we will be holding a 3 hour meetings starting</div><div class="line">at 9AM tomorrow. All getting this memo are required to attend.</div><div class="line">...'''</div><div class="line"></div><div class="line">println memo</div></pre></td></tr></table></figure>
<blockquote>
<p>Serveral of you raised concerns about long meetings.<br>To discuss this, we will be holding a 3 hour meetings starting<br>at 9AM tomorrow. All getting this memo are required to attend.<br>…</p>
</blockquote>
<h3 id="可以使用3个双引号创建包含表达式的多行字符串"><a href="#可以使用3个双引号创建包含表达式的多行字符串" class="headerlink" title="可以使用3个双引号创建包含表达式的多行字符串"></a>可以使用3个双引号创建包含表达式的多行字符串</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">price = <span class="number">251.12</span></div><div class="line"></div><div class="line">message = <span class="string">"""We're very pleased to announce</span></div><div class="line">that our stock price hit a high of \$$&#123;price&#125; per share"""</div><div class="line"></div><div class="line">println message</div></pre></td></tr></table></figure>
<blockquote>
<p>We’re very pleased to announce<br>that our stock price hit a high of <code>$</code>251.12 per share</p>
</blockquote>
<p>多行字符串表达式创建xml</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">langs = [<span class="string">'C++'</span>:<span class="string">'Stroustrup'</span>,<span class="string">'Java'</span>:<span class="string">'Gosling'</span>,<span class="string">'Lisp'</span>:<span class="string">'McCarthy'</span>]</div><div class="line">content = <span class="string">''</span></div><div class="line"></div><div class="line">langs.each&#123; language,author -&gt;</div><div class="line">    fragment = <span class="string">"""</span></div><div class="line">        &lt;language name="$&#123;language&#125;"&gt;</div><div class="line">        &lt;author&gt;$&#123;author&#125;&lt;/author&gt;</div><div class="line">        &lt;/language&gt;</div><div class="line">    """</div><div class="line"></div><div class="line">    content += fragment</div><div class="line">&#125;</div><div class="line"></div><div class="line">xml = <span class="string">"&lt;languages&gt;$&#123;content&#125;&lt;/languages&gt;"</span></div><div class="line">println xml</div></pre></td></tr></table></figure>
<h3 id="字符串便捷方法"><a href="#字符串便捷方法" class="headerlink" title="字符串便捷方法"></a>字符串便捷方法</h3><h4 id="String的execute"><a href="#String的execute" class="headerlink" title="String的execute()"></a>String的execute()</h4><p>可以创建一个process对象，只需几行代码就可以执行系统级进程。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">println <span class="string">"node -v"</span>.execute().text</div></pre></td></tr></table></figure>
<blockquote>
<p>v6.1.0</p>
</blockquote>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">str = <span class="string">"It's a rainy day in Seattle"</span></div><div class="line">println str</div><div class="line"></div><div class="line">str -= <span class="string">"rainy"</span></div><div class="line">println str</div></pre></td></tr></table></figure>
<h4 id="String-重载操作符"><a href="#String-重载操作符" class="headerlink" title="String 重载操作符"></a>String 重载操作符</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">str = <span class="string">"It's a rainy rainy day in Seattle"</span></div><div class="line">println str</div><div class="line"></div><div class="line"><span class="comment">//public String plus(Object value)</span></div><div class="line"><span class="comment">//Appends the String representation of the given operand to this CharSequence.</span></div><div class="line">str += <span class="string">" plus"</span></div><div class="line">println str</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//public String minus(Object target)</span></div><div class="line"><span class="comment">//Remove a part of a CharSequence by replacing the first occurrence of target within self with '' and returns the result.</span></div><div class="line">str -= <span class="string">"rainy"</span></div><div class="line">println str</div><div class="line"></div><div class="line"><span class="comment">//public String multiply(Number factor)</span></div><div class="line"><span class="comment">//Repeat a CharSequence a certain number of times.</span></div><div class="line">str *= <span class="number">2</span></div><div class="line">println str</div><div class="line"></div><div class="line"><span class="comment">//List tokenize() </span></div><div class="line"><span class="comment">//List tokenize(CharSequence token) </span></div><div class="line"><span class="comment">//Tokenize a CharSequence (with a whitespace as the delimiter).</span></div><div class="line">str = str.tokenize()</div><div class="line">println str</div></pre></td></tr></table></figure>
<blockquote>
<p>It’s a rainy rainy day in Seattle<br>It’s a rainy rainy day in Seattle plus<br>It’s a  rainy day in Seattle plus<br>It’s a  rainy day in Seattle plusIt’s a  rainy day in Seattle plus<br>[It’s, a, rainy, day, in, Seattle, plusIt’s, a, rainy, day, in, Seattle, plus]</p>
</blockquote>
<h4 id="String-迭代"><a href="#String-迭代" class="headerlink" title="String 迭代"></a>String 迭代</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span>(ch = <span class="string">'a'</span>;ch &lt; <span class="string">'d'</span>;ch++)&#123;</div><div class="line">    println ch;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span>(str <span class="keyword">in</span> <span class="string">'held'</span>..<span class="string">'helm'</span>)&#123;</div><div class="line">    print <span class="string">"$&#123;str&#125; "</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>a<br>b<br>c<br>held hele helf helg helh heli helj helk hell helm </p>
</blockquote>
<h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><h4 id="操作符"><a href="#操作符" class="headerlink" title="~操作符"></a>~操作符</h4><p>~操作符可以方便的创建RegEx模式（）</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">obj = ~<span class="string">"hello"</span></div><div class="line">println obj.getClass().name</div></pre></td></tr></table></figure>
<blockquote>
<p>java.util.regex.Pattern</p>
</blockquote>
<h4 id="和-操作符"><a href="#和-操作符" class="headerlink" title="=~ 和 ==~ 操作符"></a>=~ 和 ==~ 操作符</h4><p>=~ 执行RegEX部分匹配<br>==~ 执行RegEx精确匹配</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//pattern = "(G|g)roovy"</span></div><div class="line"></div><div class="line"><span class="comment">//正斜线有以个优势：不必对反斜线进行转义。/\d*\w*/与"\\d*\\w*"等价</span></div><div class="line">pattern = <span class="regexp">/(G|g)roovy/</span></div><div class="line"></div><div class="line">text = <span class="string">'Groovy is Hip'</span></div><div class="line"></div><div class="line"><span class="keyword">if</span>(text =~ pattern)</div><div class="line">	println <span class="string">"match"</span></div><div class="line"><span class="keyword">else</span></div><div class="line">	println <span class="string">"no match"</span></div><div class="line"></div><div class="line"><span class="keyword">if</span>(text ==~ pattern)</div><div class="line">	println <span class="string">"match"</span></div><div class="line"><span class="keyword">else</span></div><div class="line">	println <span class="string">"no match"</span></div></pre></td></tr></table></figure>
<blockquote>
<p>match<br>no match</p>
</blockquote>
<p>=~操作符会返回一个Matcher对象，是一个java.util.regex.Matcher实例</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">matcher = <span class="string">'Groovy is groovy'</span> =~ <span class="regexp">/(G|g)roovy/</span></div><div class="line">print <span class="string">"Size of matcher is $&#123;matcher.size()&#125;"</span></div><div class="line">println <span class="string">" with elements $&#123;matcher[0]&#125; and $&#123;matcher[1]&#125;."</span></div></pre></td></tr></table></figure>
<blockquote>
<p>Size of matcher is 2with elements [Groovy, G] and [groovy, g].</p>
</blockquote>
<p>可以使用replaceFirst()或replaceAll()方法替换文本</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">str = <span class="string">'Groovy is groovy,really groovy'</span></div><div class="line">println str</div><div class="line"></div><div class="line">result = (str =~ <span class="regexp">/groovy/</span>).replaceAll(<span class="string">'hip'</span>)</div><div class="line">println result</div></pre></td></tr></table></figure>
<blockquote>
<p>Groovy is groovy,really groovy<br>Groovy is hip,really hip</p>
</blockquote>
<h1 id="使用集合类"><a href="#使用集合类" class="headerlink" title="使用集合类"></a>使用集合类</h1><h2 id="使用List"><a href="#使用List" class="headerlink" title="使用List"></a>使用List</h2><h3 id="创建java-util-ArrayList"><a href="#创建java-util-ArrayList" class="headerlink" title="创建java.util.ArrayList"></a>创建java.util.ArrayList</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">lst = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>];</div><div class="line">println lst</div><div class="line"></div><div class="line">println lst.getClass().name</div></pre></td></tr></table></figure>
<blockquote>
<p>[1, 3, 4, 1, 8, 9, 2, 6]<br>java.util.ArrayList</p>
</blockquote>
<h3 id="使用-操作符可获取List中的元素"><a href="#使用-操作符可获取List中的元素" class="headerlink" title="使用[]操作符可获取List中的元素"></a>使用[]操作符可获取List中的元素</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">lst = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>];</div><div class="line">println lst[<span class="number">0</span>]</div><div class="line">println lst[lst.size() <span class="number">-1</span>]</div><div class="line"></div><div class="line"><span class="comment">//使用负索引将从右向左开始遍历</span></div><div class="line">println lst[<span class="number">-1</span>]</div><div class="line">println lst[<span class="number">-2</span>]</div><div class="line"></div><div class="line"><span class="comment">//使用Range对象获得集合中的几个连续的值</span></div><div class="line">println lst[<span class="number">2.</span><span class="number">.5</span>]</div><div class="line">println lst[<span class="number">-6.</span>.<span class="number">-3</span>]</div><div class="line"></div><div class="line">subLst = lst[<span class="number">2.</span><span class="number">.5</span>]</div><div class="line"><span class="comment">//使用dump()分析实例详细信息</span></div><div class="line">println subLst.dump()</div><div class="line"></div><div class="line">subLst[<span class="number">0</span>] = <span class="number">55</span></div><div class="line">println <span class="string">"After subLst[0]=55 lst = $lst"</span></div></pre></td></tr></table></figure>
<blockquote>
<p>1<br>6<br>6<br>2<br>[4, 1, 8, 9]<br>[4, 1, 8, 9]</p>
<p><java.util.arraylist@fedbf elementdata="[4," 1,="" 8,="" 9]="" size="4" modcount="1"><br>After subLst[0]=55 lst = [1, 3, 4, 1, 8, 9, 2, 6]</java.util.arraylist@fedbf></p>
</blockquote>
<h2 id="迭代ArrayList"><a href="#迭代ArrayList" class="headerlink" title="迭代ArrayList"></a>迭代ArrayList</h2><h3 id="使用List的each方法"><a href="#使用List的each方法" class="headerlink" title="使用List的each方法"></a>使用List的each方法</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">lst = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>];</div><div class="line"></div><div class="line"><span class="comment">//使用内部迭代器</span></div><div class="line">lst.each&#123; </div><div class="line">print it + <span class="string">' '</span></div><div class="line">&#125;</div><div class="line">println <span class="string">''</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//反向迭代</span></div><div class="line">lst.reverseEach&#123; print it + <span class="string">' '</span>&#125;</div><div class="line">println <span class="string">''</span></div><div class="line"></div><div class="line"><span class="comment">//迭代过程获取索引</span></div><div class="line">lst.eachWithIndex&#123;elem, index -&gt;</div><div class="line">    print elem + <span class="string">' '</span></div><div class="line">    print index + <span class="string">'\n'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//求和</span></div><div class="line">total = <span class="number">0</span></div><div class="line">lst.each&#123;</div><div class="line">    total += it</div><div class="line">&#125;</div><div class="line">println <span class="string">"Total is $total"</span></div><div class="line"></div><div class="line"><span class="comment">//数组值*2后生成新数组</span></div><div class="line">doubled = []</div><div class="line">lst.each&#123;</div><div class="line">	<span class="comment">//&lt;&lt;操作符（映射到leftShift()方法）</span></div><div class="line">    doubled &lt;&lt; it * <span class="number">2</span></div><div class="line">&#125;</div><div class="line">println doubled</div></pre></td></tr></table></figure>
<blockquote>
<p>1 3 4 1 8 9 2 6<br>6 2 9 8 1 4 3 1<br>1 0<br>3 1<br>4 2<br>1 3<br>8 4<br>9 5<br>2 6<br>6 7<br>Total is 34<br>[2, 6, 8, 2, 16, 18, 4, 12]</p>
</blockquote>
<h3 id="使用List的collect方法"><a href="#使用List的collect方法" class="headerlink" title="使用List的collect方法"></a>使用List的collect方法</h3><p>collect方法会把闭包的返回值收集(即collect一词的本意)到一个集合中，最后返回这个新生成的结果集合。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">lst = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>];</div><div class="line">println lst.collect &#123; it*<span class="number">2</span> &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>[2, 6, 8, 2, 16, 18, 4, 12]</p>
</blockquote>
<h3 id="使用查找方法"><a href="#使用查找方法" class="headerlink" title="使用查找方法"></a>使用查找方法</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">lst = [<span class="number">4</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>];</div><div class="line"><span class="comment">//find()会找到第一次出现的匹配对象</span></div><div class="line">println lst.find &#123; it == <span class="number">2</span>&#125;</div><div class="line"><span class="comment">//可以在附到find()上的闭包中指定任何条件</span></div><div class="line">println lst.find&#123; it &gt; <span class="number">4</span> &#125;</div><div class="line"></div><div class="line"><span class="comment">//返回所有找到的对象</span></div><div class="line">println lst.findAll&#123; it == <span class="number">2</span> &#125;</div><div class="line">println lst.findAll&#123; it &gt; <span class="number">4</span> &#125;</div><div class="line"></div><div class="line"><span class="comment">//查找第一个匹配对象的位置</span></div><div class="line">println lst.findIndexOf&#123; it == <span class="number">2</span> &#125;</div></pre></td></tr></table></figure>
<h3 id="list上的其他便捷方法"><a href="#list上的其他便捷方法" class="headerlink" title="list上的其他便捷方法"></a>list上的其他便捷方法</h3><p>一个字符串集合，计算其中总的字符数</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">lst = [<span class="string">'Programming'</span>,<span class="string">'In'</span>,<span class="string">'Groovy'</span>];</div><div class="line"></div><div class="line"><span class="comment">//方法1：迭代</span></div><div class="line">count = <span class="number">0</span></div><div class="line">lst.each&#123;</div><div class="line">    count += it.size()</div><div class="line">&#125;</div><div class="line">println count</div><div class="line"></div><div class="line"><span class="comment">//collect()方法返回集合，并调用sum()方法</span></div><div class="line">println lst.collect&#123; it.size() &#125;.sum()</div><div class="line"></div><div class="line"><span class="comment">//inject()会对集合中的每一个元素调用闭包。</span></div><div class="line"><span class="comment">//inject()会把注入的一个初试值当做第一个参数，放到第一次闭包的调用中。</span></div><div class="line"><span class="comment">//之后它会把从闭包获得的结果注入到随后对闭包的调用中。</span></div><div class="line">println lst.inject(<span class="number">0</span>)&#123; carryOver, element -&gt; carryOver + element.size() &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>19<br>19<br>19</p>
</blockquote>
<p>join()会迭代每个元素，然后将每个元素和作为输入参数给定的字符连接起来<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">lst = [<span class="string">'Programming'</span>,<span class="string">'In'</span>,<span class="string">'Groovy'</span>];</div><div class="line">println lst.join(<span class="string">' '</span>)</div></pre></td></tr></table></figure></p>
<blockquote>
<p>Programming In Groovy</p>
</blockquote>
<p>通过索引替换List中的元素</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">lst[<span class="number">0</span>] = [<span class="string">'Be'</span>, <span class="string">'Productive'</span>]</div><div class="line">println lst</div><div class="line"></div><div class="line"><span class="comment">//使用flatten()方法将List拉平</span></div><div class="line">lst = lst.flatten()</div><div class="line">println lst</div></pre></td></tr></table></figure>
<p>使用 - 操作符（minus()）方法</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">lst = [<span class="string">'Programming'</span>,<span class="string">'In'</span>,<span class="string">'Groovy'</span>];</div><div class="line">println lst - [<span class="string">'Productive'</span>,<span class="string">'Groovy'</span>]</div></pre></td></tr></table></figure>
<blockquote>
<p>[Programming, In]</p>
</blockquote>
<p>使用reverse()方法获取反向排列的副本</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">lst = [<span class="string">'Programming'</span>,<span class="string">'In'</span>,<span class="string">'Groovy'</span>];</div><div class="line">println lst.reverse()</div></pre></td></tr></table></figure>
<p>使用展开操作符<em>（spread operator）
</em>操作符，将集合拆成单个对象</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">lst = [<span class="string">'Programming'</span>,<span class="string">'In'</span>,<span class="string">'Groovy'</span>];</div><div class="line"></div><div class="line">println lst.size()</div><div class="line">println lst*.size()</div><div class="line"></div><div class="line"><span class="keyword">def</span> words(a, b, c)&#123;</div><div class="line">    println <span class="string">"$a $b $c"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//将List打散为参数</span></div><div class="line">words(*lst)</div></pre></td></tr></table></figure>
<blockquote>
<p>3<br>[11, 2, 6]<br>Programming In Groovy</p>
</blockquote>
<h2 id="使用Map类"><a href="#使用Map类" class="headerlink" title="使用Map类"></a>使用Map类</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//创建Map</span></div><div class="line">langs = [<span class="string">'C++'</span>:<span class="string">'Stroustrup'</span>, <span class="string">'Java'</span> : <span class="string">'gosling'</span> , <span class="string">'Lisp'</span> : <span class="string">'McCarthy'</span>]</div><div class="line">println langs.getClass().name</div><div class="line"></div><div class="line"><span class="comment">//使用[]操作符，访问一个键的值</span></div><div class="line">println langs[<span class="string">'Java'</span>]</div><div class="line">println langs[<span class="string">'C++'</span>]</div><div class="line"></div><div class="line"><span class="comment">//可以把键用作好像是Map的一个属性</span></div><div class="line">println langs.Java</div><div class="line"><span class="comment">//C++的++与映射next()方法的++操作符冲突，需要使用单引号，将键值看做一个String</span></div><div class="line">println langs.<span class="string">'C++'</span></div><div class="line"></div><div class="line"><span class="comment">//定义Map时，对于不冲突的键名，可以省略引号</span></div><div class="line">langs2 = [<span class="string">'C++'</span>:<span class="string">'Stroustrup'</span>, <span class="string">Java :</span> <span class="string">'gosling'</span> , <span class="string">Lisp :</span> <span class="string">'McCarthy'</span>]</div><div class="line">println langs2</div></pre></td></tr></table></figure>
<blockquote>
<p>java.util.LinkedHashMap<br>gosling<br>Stroustrup<br>gosling<br>Stroustrup<br>[C++:Stroustrup, Java:gosling, Lisp:McCarthy]</p>
</blockquote>
<p>注：不能在Map上调用class属性，Map会假定class这个名字指向的是一个（不存在的）键，而放回null。<br>在实例上要总是使用getClass()</p>
<h2 id="Map迭代"><a href="#Map迭代" class="headerlink" title="Map迭代"></a>Map迭代</h2><h3 id="Map的each-方法"><a href="#Map的each-方法" class="headerlink" title="Map的each()方法"></a>Map的each()方法</h3><p>如果闭包只有一个参数，each()会把一个MapEntry实例发送给该参数。<br>如果想单独获得键和值，只需在闭包中提供两个参数。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">langs = [<span class="string">'C++'</span>:<span class="string">'Stroustrup'</span>, <span class="string">'Java'</span> : <span class="string">'gosling'</span> , <span class="string">'Lisp'</span> : <span class="string">'McCarthy'</span>]</div><div class="line"></div><div class="line">langs.each&#123; entry -&gt;</div><div class="line">	println <span class="string">"Language $entry.key was authored by $entry.value"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">langs.each&#123; language, author -&gt;</div><div class="line">	println <span class="string">"Language $language was authored by $author"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Language C++ was authored by Stroustrup<br>Language Java was authored by gosling<br>Language Lisp was authored by McCarthy<br>Language C++ was authored by Stroustrup<br>Language Java was authored by gosling<br>Language Lisp was authored by McCarthy</p>
</blockquote>
<h3 id="Map的collect方法"><a href="#Map的collect方法" class="headerlink" title="Map的collect方法"></a>Map的collect方法</h3><p>与ArrayList中的conllect()方法类似的是，都返回一个列表。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">langs = [<span class="string">'C++'</span>:<span class="string">'Stroustrup'</span>, <span class="string">'Java'</span> : <span class="string">'gosling'</span> , <span class="string">'Lisp'</span> : <span class="string">'McCarthy'</span>]</div><div class="line"></div><div class="line">println langs.collect &#123;language,author -&gt;</div><div class="line">    language.replaceAll(<span class="string">"[+]"</span>,<span class="string">"P"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>[CPP, Java, Lisp]</p>
</blockquote>
<h3 id="Map的find-和-findAll方法"><a href="#Map的find-和-findAll方法" class="headerlink" title="Map的find 和 findAll方法"></a>Map的find 和 findAll方法</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">println <span class="string">"Looking for the first language with name greater than 3 characters"</span></div><div class="line"></div><div class="line"><span class="comment">//find</span></div><div class="line">entry = langs.find&#123; language,author -&gt;</div><div class="line">	language.size() &gt; <span class="number">3</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">println <span class="string">"Found $entry.key written by $entry.value"</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//findAll</span></div><div class="line">selected = langs.findAll&#123; language,author -&gt;</div><div class="line">	language.size() &gt; <span class="number">3</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">selected.each&#123; key, value -&gt;</div><div class="line">	println <span class="string">"Found $key written by $value"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Looking for the first language with name greater than 3 characters<br>Found Java written by gosling<br>Found Java written by gosling<br>Found Lisp written by McCarthy</p>
</blockquote>
<h3 id="Map上的其他便捷方法"><a href="#Map上的其他便捷方法" class="headerlink" title="Map上的其他便捷方法"></a>Map上的其他便捷方法</h3><p>只想确定集合中是否有任何元素满足某些条件，用any()<br>检查是否所用元素都满足给定条件，用every()</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">langs = [<span class="string">'C++'</span>:<span class="string">'Stroustrup'</span>, <span class="string">'Java'</span> : <span class="string">'gosling'</span> , <span class="string">'Lisp'</span> : <span class="string">'McCarthy'</span>]</div><div class="line"></div><div class="line">println langs.any&#123; language,author -&gt;</div><div class="line">    language =~ <span class="string">"[^A-Za-z]"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">println langs.every &#123; language,author -&gt;</div><div class="line">    language =~ <span class="string">"[^A-Za-z]"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>true<br>false</p>
</blockquote>
<p>基于某些标准对Map中的元素进行分组,使用groupBy</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">friends = [ <span class="string">briang :</span> <span class="string">'Brian Goetz'</span>, <span class="string">brians :</span> <span class="string">'Brian Sletten'</span>, </div><div class="line">    <span class="string">davidb :</span> <span class="string">'David Bock'</span>, <span class="string">davidg :</span> <span class="string">'David Geary'</span>,</div><div class="line">    <span class="string">scottd :</span> <span class="string">'Scott Davis'</span>, <span class="string">scottl :</span> <span class="string">'Scott Leberknight'</span>, </div><div class="line">    <span class="string">stuarth :</span> <span class="string">'Stuart Halloway'</span>]</div><div class="line"></div><div class="line">groupByFirstName = friends.groupBy &#123; it.value.split(<span class="string">' '</span>)[<span class="number">0</span>] &#125;</div><div class="line"></div><div class="line">groupByFirstName.each &#123; firstName, buddies -&gt;</div><div class="line">    println <span class="string">"$firstName : $&#123;buddies.collect &#123; key, fullName -&gt; fullName&#125;.join(', ')&#125;"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="探索GDK"><a href="#探索GDK" class="headerlink" title="探索GDK"></a>探索GDK</h1><p>当处在同一JVM中时，Java端和Groovy端使用的是同一个对象。<br>对于Groovy端看到的对象，因为Groovy向其中添加了便于使用、可以提高开发效率的方法，所以看上去更时髦。</p>
<h2 id="使用Object类的扩展"><a href="#使用Object类的扩展" class="headerlink" title="使用Object类的扩展"></a>使用Object类的扩展</h2><p>Groovy对java.lang.Object的扩展</p>
<h3 id="dump和inspect方法"><a href="#dump和inspect方法" class="headerlink" title="dump和inspect方法"></a>dump和inspect方法</h3><p>dump()是我们得以一窥对象内部。可用于调试、日志和学习。<br>它会展示出目标实例的类型（class）、散列码及字段。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">str = <span class="string">'hello'</span></div><div class="line">println str</div><div class="line">println str.dump()</div></pre></td></tr></table></figure>
<blockquote>
<p>hello</p>
<java.lang.string@5e918d2 value="hello" hash="99162322">

</java.lang.string@5e918d2></blockquote>
<p>inspect()方法旨在说明创建一个对象需要提供什么。<br>如果类没有实现该方法，会简单地返回tostring()所返回的内容。<br>该方法可以帮助类的使用者在运行时确定应该提供的内容。</p>
<h3 id="使用with-方法"><a href="#使用with-方法" class="headerlink" title="使用with()方法"></a>使用with()方法</h3><p>JavaScript和VBScript都有with这个有好的特性，支持创建一个上下文（context）。<br>在with作用域内调用的任何方法，都会被定向到该上下文对象。<br>（Groovy中with()作为identity()的同义词引入，可以互换使用）</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">lst = [<span class="number">1</span>,<span class="number">2</span>]</div><div class="line">lst.with&#123;</div><div class="line">    add(<span class="number">3</span>)</div><div class="line">    add(<span class="number">4</span>)</div><div class="line">    println size()</div><div class="line">    println contains(<span class="number">3</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p> 4<br>true<br>this is ConsoleScript2@7673b483<br>owner is ConsoleScript2@7673b483<br>delegate is [1, 2, 3, 4]</p>
</blockquote>
<p>调用with()方法时，它会将闭包的delegate属性设置到调用with()的对象上，<br>以将闭包内的调用路由到上下文对象</p>
<h3 id="使用sleep"><a href="#使用sleep" class="headerlink" title="使用sleep"></a>使用sleep</h3><p>添加到Object上的sleep()方法应该叫酣睡(soundSleep)，<br>因为在跟定的毫秒数时间（近似）内睡眠时，方法会忽略中断。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">thread = Thread.start&#123;</div><div class="line">    println <span class="string">"Thread started"</span></div><div class="line">    startTime = System.nanoTime()</div><div class="line">    <span class="keyword">new</span> Object().sleep(<span class="number">2000</span>)</div><div class="line">    endTime = System.nanoTime()</div><div class="line">    println <span class="string">"Thread done in $&#123;(endTime - startTime)/10**9&#125; seconds"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">new</span> Object().sleep(<span class="number">100</span>)</div><div class="line">println <span class="string">"Let's interrupt that thread"</span></div><div class="line">thread.interrupt()</div><div class="line"><span class="comment">// join() 方法是让调用该方法的主线程执行run()时暂时卡住，等run()执行完成后， 主线程再调用执行join()后面的代码</span></div><div class="line">thread.join()</div></pre></td></tr></table></figure>
<blockquote>
<p>Thread started<br>Let’s interrupt that thread<br>Thread done in 1.999289306 seconds</p>
</blockquote>
<p>sleep()方法一个变种，接收一个处理中断的闭包<br>闭包返回true，sleep()将被中断，否则，将继续</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">thread = Thread.start&#123;</div><div class="line">    println <span class="string">"Thread started"</span></div><div class="line">    startTime = System.nanoTime()</div><div class="line">    <span class="keyword">new</span> Object().sleep(<span class="number">2000</span>)&#123;</div><div class="line">        println <span class="string">"Interrupted ..."</span> + it</div><div class="line">        <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line">    endTime = System.nanoTime()</div><div class="line">    println <span class="string">"Thread done in $&#123;(endTime - startTime)/10**9&#125; seconds"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">new</span> Object().sleep(<span class="number">100</span>)</div><div class="line">println <span class="string">"Let's interrupt that thread"</span></div><div class="line">thread.interrupt()</div><div class="line">thread.join()</div></pre></td></tr></table></figure>
<blockquote>
<p>Thread started<br>Let’s interrupt that thread<br>Interrupted …java.lang.InterruptedException: sleep interrupted<br>Thread done in 0.099872478 seconds</p>
</blockquote>
<h3 id="间接访问属性"><a href="#间接访问属性" class="headerlink" title="间接访问属性"></a>间接访问属性</h3><p>使用[]操作符（映射到Groovy添加的getAt()方法）动态地访问属性。<br>该操作符用于赋值语句的左侧，则映射到putAt()方法</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span>&#123;</span></div><div class="line">	<span class="keyword">int</span> miles, fuelLevel</div><div class="line">&#125;</div><div class="line"></div><div class="line">car = <span class="keyword">new</span> Car(<span class="string">fuelLevel:</span> <span class="number">80</span>, <span class="string">miles:</span><span class="number">25</span>)</div><div class="line"></div><div class="line"><span class="comment">//可能通过输入来填充，或来自Web应用中的动态表单</span></div><div class="line">properties = [<span class="string">'miles'</span>,<span class="string">'fuelLevel'</span>]</div><div class="line"></div><div class="line">properties.each &#123; name -&gt;</div><div class="line">	println <span class="string">"$name = $&#123;car[name]&#125;"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">car[properties[<span class="number">1</span>]] = <span class="number">100</span></div><div class="line"></div><div class="line">println <span class="string">"fuelLevel now is $&#123;car.fuelLevel&#125;"</span></div></pre></td></tr></table></figure>
<blockquote>
<p>miles = 25<br>fuelLevel = 80<br>fuelLevel now is 100</p>
</blockquote>
<p>使用间接访问属性，可以轻松编写一个高阶函数，让它接受属性名列表和一个实例，并以XML、HTML或其他我们期望的格式输出属性名和他们的值。</p>
<h3 id="间接调用方法"><a href="#间接调用方法" class="headerlink" title="间接调用方法"></a>间接调用方法</h3><p>以String接收方法名，并调用该方法。</p>
<p>使用反射需要从实例或去Class元对象，调用getMethod()获取Method实例，最后在该实例上调用invoke()方法，并需要处理异常。</p>
<p>Groovy中只调用invokeMethod()方法。Groovy中的所有对象都支持该方法。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>&#123;</span></div><div class="line">    <span class="keyword">def</span> walk()&#123; println <span class="string">"Walking ..."</span> &#125;</div><div class="line"></div><div class="line">    <span class="keyword">def</span> walk(<span class="keyword">int</span> miles)&#123; println <span class="string">"Walking $miles miles..."</span> &#125;</div><div class="line"></div><div class="line">    <span class="keyword">def</span> walk(<span class="keyword">int</span> miles, String where)&#123; println <span class="string">"Walking $miles miles $where..."</span>&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">perter = <span class="keyword">new</span> Person()</div><div class="line"></div><div class="line">perter.invokeMethod(<span class="string">"walk"</span>,<span class="literal">null</span>)</div><div class="line">perter.invokeMethod(<span class="string">"walk"</span>,<span class="number">10</span>)</div><div class="line">perter.invokeMethod(<span class="string">"walk"</span>, [<span class="number">2</span>,<span class="string">'uphill'</span>] <span class="keyword">as</span> Object[])</div></pre></td></tr></table></figure>
<blockquote>
<p>Walking …<br>Walking 10 miles…<br>Walking 2 miles uphill…</p>
</blockquote>
<h2 id="其他扩展"><a href="#其他扩展" class="headerlink" title="其他扩展"></a>其他扩展</h2><h3 id="数组扩展"><a href="#数组扩展" class="headerlink" title="数组扩展"></a>数组扩展</h3><p>所有数组类型，都可以使用Range对象作为索引，返回一个子数组。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span>[] arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</div><div class="line">arrRange = arr[<span class="number">2.</span><span class="number">.4</span>]</div><div class="line">println arrRange</div><div class="line"></div><div class="line"><span class="comment">//子数组和原数组独立</span></div><div class="line">arrRange[<span class="number">0</span>] = <span class="number">10</span></div><div class="line">println arrRange</div><div class="line">println arr</div></pre></td></tr></table></figure>
<blockquote>
<p>[3, 4, 5]<br>[10, 4, 5]<br>[1, 2, 3, 4, 5, 6]</p>
</blockquote>
<h3 id="java-lang的扩展"><a href="#java-lang的扩展" class="headerlink" title="java.lang的扩展"></a>java.lang的扩展</h3><p>Number(Integer和Double就扩展自该类)添加了迭代器方法upto()和downto()，还有step()方法。<br>这些方法有助于对一个范围内的值进行迭代。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="number">0.</span>upto(<span class="number">3</span>) &#123;</div><div class="line">    print <span class="string">"$&#123;it&#125; "</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">print <span class="string">"\n"</span></div><div class="line"></div><div class="line"><span class="number">0.</span>step(<span class="number">10</span>,<span class="number">2</span>)&#123;</div><div class="line">    print <span class="string">"$&#123;it&#125; "</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>0 1 2 3<br>0 2 4 6 8 </p>
</blockquote>
<p>Process类提供了访问stdin、stdout和stderr命令的便捷方法，分别对应out、in和err属性。<br>还有一个text属性，提供完整的标准输出或来自进程的响应。<br>一次性读取完整的标准错误，可以在进程实例上使用err.text</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">process = <span class="string">"mysql --user=root --password=123456"</span>.execute()</div><div class="line"></div><div class="line"><span class="comment">//通过process的out属性获取OutputStream</span></div><div class="line"><span class="comment">//可以通过&lt;&lt;写入内容</span></div><div class="line"><span class="comment">//也可以通过OutputStream的withWriter()方法写入内容，withWriter()同时完成写入数据后刷新并关闭流</span></div><div class="line">process.out.withWriter &#123;</div><div class="line">    <span class="comment">//&lt;&lt;操作符，可以以管道方式链接到另一个进程中</span></div><div class="line">    it &lt;&lt; <span class="string">"show databases;"</span></div><div class="line">    it &lt;&lt; <span class="string">"use mysql;"</span></div><div class="line">    it &lt;&lt; <span class="string">"select host,user from mysql.user;"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">println process.<span class="keyword">in</span>.text</div><div class="line"><span class="comment">//或println process.text</span></div></pre></td></tr></table></figure>
<blockquote>
<p>Database<br>information_schema<br>mysql<br>performance_schema<br>sys<br>weatherinfo<br>host    user<br>%    root<br>localhost    mysql.sys</p>
</blockquote>
<p>String[] 也支持execute()方法，第一个元素被当作命令，其余元素被视作该命令的参数。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">String[] command = [<span class="string">'node'</span>,<span class="string">'-v'</span>]</div><div class="line">println <span class="string">"Calling $&#123;command.join(' ')&#125;"</span></div><div class="line">println command.execute().text</div></pre></td></tr></table></figure>
<blockquote>
<p>Calling node -v<br>v4.5.0</p>
</blockquote>
<p>启动线程00</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> printThreadInfo(msg) &#123;</div><div class="line">  <span class="keyword">def</span> currentThread = Thread.currentThread()</div><div class="line">  println <span class="string">"$msg Thread is $&#123;currentThread&#125;. Daemon? $&#123;currentThread.isDaemon()&#125;"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">printThreadInfo <span class="string">'Main'</span></div><div class="line"></div><div class="line"><span class="comment">//启动非守护线程</span></div><div class="line">Thread.start &#123; </div><div class="line">  printThreadInfo <span class="string">"Started"</span></div><div class="line">  sleep(<span class="number">3000</span>) &#123; println <span class="string">"Interrupted"</span> &#125;</div><div class="line">  println <span class="string">"Finished Started"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">sleep(<span class="number">1000</span>)</div><div class="line"></div><div class="line"><span class="comment">//启动守护线程</span></div><div class="line">Thread.startDaemon &#123;</div><div class="line">  printThreadInfo <span class="string">"Started Daemon"</span></div><div class="line">  sleep(<span class="number">5000</span>) &#123; println <span class="string">"Interrupted"</span> &#125;</div><div class="line">  println <span class="string">"Finished Started Daemon"</span> <span class="comment">// Will not get here</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Main Thread is Thread[Thread-3,6,main]. Daemon? false<br>Started Thread is Thread[Thread-4,6,main]. Daemon? false<br>Started Daemon Thread is Thread[Thread-5,6,main]. Daemon? true<br>Result: Thread[Thread-5,6,main]Finished Started<br>Finished Started Daemon</p>
</blockquote>
<p>注：已上为正确输出，仅在首次启动GroovyConsole时运行正确<br>之后的输出为：</p>
<blockquote>
<p>Main Thread is Thread[Thread-9,6,main]. Daemon? false<br>Started Thread is Thread[Thread-10,6,main]. Daemon? false<br>Result: Thread[Thread-11,6,main]Started Daemon Thread is Thread[Thread-11,6,main]. Daemon? true<br>Finished Started<br>Finished Started Daemon</p>
</blockquote>
<h3 id="使用java-io扩展"><a href="#使用java-io扩展" class="headerlink" title="使用java.io扩展"></a>使用java.io扩展</h3><p>java.io包中的File类加入了很多方法。<br>其中eachFile()、eachDir()（及其变种）可接受闭包，为目录和文件的导航与迭代提供便捷方式。</p>
<p>Groovy通过向BufferedReader、InputStream和File添加text属性，可以把文件的全部内容读到一个String中。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">println <span class="keyword">new</span> File(<span class="string">"C:\\Users\\wangdz\\Desktop\\data.txt"</span>).text</div></pre></td></tr></table></figure>
<blockquote>
<p>groovy<br>file<br>read</p>
</blockquote>
<p>一次读取并处理一行</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> File(<span class="string">"C:\\Users\\wangdz\\Desktop\\data.txt"</span>).eachLine&#123; line -&gt;</div><div class="line">    println line</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>groovy<br>file<br>read</p>
</blockquote>
<p>只去满足特定条件的那些行文本，使用filterLine()</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">println <span class="keyword">new</span> File(<span class="string">"C:\\Users\\wangdz\\Desktop\\data.txt"</span>).filterLine&#123; it =~ <span class="regexp">/groovy/</span> &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>groovy</p>
</blockquote>
<p>如果想使用完毕自动刷新并关闭输入流，可以使用withStream()；<br>Writer有类似方法，withWriter()；</p>
<p>InputStream的withReader()会创建一个BufferedReader（被附到输入流上），并将其传递给接受参数的闭包。</p>
<p>InputStream和DataInputStream中的输入可以通过调用iterator()，获的一个Iterator，然后使用迭代器对输入进行迭代。<br>也可以便利地迭代ObjectInputStream中的对象。</p>
<p>InputStream上的便捷方法，Reader上也有。</p>
<p>OutputStream、ObjectOutputStream和writer类通过leftShife()方法（操作符&lt;&lt;）向文件或流写入内容。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> File(<span class="string">"C:\\Users\\wangdz\\Desktop\\dataOut.txt"</span>).withWriter&#123; file -&gt;</div><div class="line">    file &lt;&lt; <span class="string">"some data..."</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="使用java-util的扩展"><a href="#使用java-util的扩展" class="headerlink" title="使用java.util的扩展"></a>使用java.util的扩展</h3><p>List、Set、SortedMap和SortedSet都加入了asImmutable()，用于获取各自实例的一个不可变实例。<br>这些类还加入了一个asSynchronized()方法，用于创建线程安全的实例。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</div><div class="line">println arr.dump()</div><div class="line">arr_immutable = arr.asImmutable()</div><div class="line">println arr_immutable.dump()</div><div class="line">println arr_immutable[<span class="number">0</span>] == <span class="number">9</span></div></pre></td></tr></table></figure>
<blockquote>
<p><java.util.arraylist@7861 elementdata="[1," 2,="" 3]="" size="3" modcount="1"></java.util.arraylist@7861></p>
<p><java.util.collections`$`unmodifiablerandomaccesslist@7861 list="[1," 2,="" 3]="" c="[1,"><br>false</java.util.collections`$`unmodifiablerandomaccesslist@7861></p>
</blockquote>
<p>Iterator支持inject()方法</p>
<p>java.util.Timer加入了runAfter()方法，该方法接受一个闭包，闭包将在给定的延时（单位毫秒）之后运行。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">println <span class="keyword">new</span> java.text.SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>).format(<span class="keyword">new</span> java.util.Date())</div><div class="line"></div><div class="line">timer = <span class="keyword">new</span> java.util.Timer()</div><div class="line">timer.runAfter(<span class="number">3000</span>)&#123;</div><div class="line">    println <span class="string">"run afert delay time"</span></div><div class="line">    println <span class="keyword">new</span> java.text.SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>).format(<span class="keyword">new</span> java.util.Date())</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>2016-09-19 20:41:00<br>Result: org.codehaus.groovy.runtime.DefaultGroovyMethods<code>$</code>2@1fc720f7run afert delay time<br>2016-09-19 20:41:03</p>
</blockquote>
<h2 id="使用扩展模块定制方法"><a href="#使用扩展模块定制方法" class="headerlink" title="使用扩展模块定制方法"></a>使用扩展模块定制方法</h2><p>使用扩展模块（extension-modules）特性，可以在编译时向现有类添加实例方法或静态方法，并在运行时应用它们。</p>
<p>实现方法：</p>
<ul>
<li>添加的方法定义在一个扩展模块类中</li>
<li>清单文件(manifest)中添加描述信息，告诉Groovy编译器要查找的扩展模块</li>
</ul>
<h1 id="处理xml"><a href="#处理xml" class="headerlink" title="处理xml"></a>处理xml</h1><p>Groovy缓解了解析和创建xml文档之苦。</p>
<h2 id="解析XML"><a href="#解析XML" class="headerlink" title="解析XML"></a>解析XML</h2><p>Groovy解析器相当强大，并且使用方便，还支持命名空间。</p>
<p>language.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--</span></div><div class="line"> ! Excerpted from "Programming Groovy, 2nd Edition",</div><div class="line"> ! published by The Pragmatic Bookshelf.</div><div class="line"> ! Copyrights apply to this code. It may not be used to create training material, </div><div class="line"> ! courses, books, articles, and the like. Contact us if you are in doubt.</div><div class="line"> ! We make no guarantees that this code is fit for any purpose. </div><div class="line"> ! Visit http://www.pragmaticprogrammer.com/titles/vslg2 for more book information.</div><div class="line">--&gt;</div><div class="line"><span class="tag">&lt;<span class="name">languages</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">language</span> <span class="attr">name</span>=<span class="string">"C++"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">author</span>&gt;</span>Stroustrup<span class="tag">&lt;/<span class="name">author</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">language</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">language</span> <span class="attr">name</span>=<span class="string">"Java"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">author</span>&gt;</span>Gosling<span class="tag">&lt;/<span class="name">author</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">language</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">language</span> <span class="attr">name</span>=<span class="string">"Lisp"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">author</span>&gt;</span>McCarthy<span class="tag">&lt;/<span class="name">author</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">language</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">language</span> <span class="attr">name</span>=<span class="string">"Modula-2"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">author</span>&gt;</span>Wirth<span class="tag">&lt;/<span class="name">author</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">language</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">language</span> <span class="attr">name</span>=<span class="string">"Oberon-2"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">author</span>&gt;</span>Wirth<span class="tag">&lt;/<span class="name">author</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">language</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">language</span> <span class="attr">name</span>=<span class="string">"Pascal"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">author</span>&gt;</span>Wirth<span class="tag">&lt;/<span class="name">author</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">language</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">languages</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="使用DOMCategory"><a href="#使用DOMCategory" class="headerlink" title="使用DOMCategory"></a>使用DOMCategory</h3><p>使用DOMCategory通过类GPath（Groovy path expression，即Groovy路径表达式）在Dom结构中导航<br>GPath可以帮助导航对象（Plain Old Java Object和Plain Old Groovy Object,即POJO和POGO）和XML的层次结构</p>
<p>通过子元素的名字就能访问所有<code>子元素</code><br>属性名钱放一个@可以获得该<code>属性</code>的值</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">document = groovy.xml.DOMBuilder.parse(<span class="keyword">new</span> FileReader(<span class="string">'C:\\Users\\wangdz\\Desktop\\language.xml'</span>))</div><div class="line">rootElement = document.documentElement</div><div class="line"></div><div class="line"><span class="comment">//使用DOMCategory，必须把代码放在use()块内</span></div><div class="line">use(groovy.xml.dom.DOMCategory)&#123;</div><div class="line">    println <span class="string">"Language and authors"</span></div><div class="line">    languages = rootElement.language</div><div class="line">     languages.each&#123; language -&gt;</div><div class="line">         println <span class="string">"$&#123; language.@name&#125; authored by $&#123;language.author[0].text() &#125;"</span></div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Language and authors<br>language authored by Stroustrup<br>language authored by Gosling<br>language authored by McCarthy<br>language authored by Wirth<br>language authored by Wirth<br>language authored by Wirth</p>
</blockquote>
<h3 id="使用XMLParser"><a href="#使用XMLParser" class="headerlink" title="使用XMLParser"></a>使用XMLParser</h3><p>groovy.util.XMLParser利用Groovy的动态类和元编程能力，可以直接使用名字访问文档中的成员。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//与DOMCategory不同，没有使用FileReader，使用FileReader效果一样</span></div><div class="line">languages = <span class="keyword">new</span> XmlParser().parse(<span class="string">'C:\\Users\\wangdz\\Desktop\\language.xml'</span>)</div><div class="line"></div><div class="line">println <span class="string">"Language And Authors"</span></div><div class="line"></div><div class="line"><span class="comment">//获得的节点，忽略了根节点</span></div><div class="line">languages.each&#123;</div><div class="line">    println <span class="string">"$&#123;it.@name&#125; authored by $&#123;it.author[0].text()&#125;"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> languagesByAuthor = &#123; authorName -&gt;</div><div class="line">    languages.findAll&#123; it.author[<span class="number">0</span>].text() == authorName &#125;.collect &#123;</div><div class="line">        it.<span class="meta">@name</span></div><div class="line">    &#125;.join(<span class="string">', '</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line">println <span class="string">"Languages by Write:"</span> + languagesByAuthor(<span class="string">'Wirth'</span>)</div></pre></td></tr></table></figure>
<blockquote>
<p>Language And Authors<br>C++ authored by Stroustrup<br>Java authored by Gosling<br>Lisp authored by McCarthy<br>Modula-2 authored by Wirth<br>Oberon-2 authored by Wirth<br>Pascal authored by Wirth<br>Languages by Write:Modula-2, Oberon-2, Pascal</p>
</blockquote>
<p>与DOMCategory的主要区别在于，不需要使用use()块。<br>XMLParser向元素中添加了便捷的迭代器，如each()、collect()、find()等，便于实现导航</p>
<p>XMLParser的不足；<br>没用保留XML InfoSet，而且忽略了文档中的XML注释和处理指令。</p>
<p>它的便捷性使其成为应对大部分常见处理需求的极好工具</p>
<h3 id="使用XMLSlurper"><a href="#使用XMLSlurper" class="headerlink" title="使用XMLSlurper"></a>使用XMLSlurper</h3><p>对于较大的文档，XMLParser的内存使用让人难以忍受<br>XMLSlurper可以处理这种情况</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">languages = <span class="keyword">new</span> XmlSlurper().parse(<span class="string">'C:\\Users\\wangdz\\Desktop\\language.xml'</span>)</div><div class="line"></div><div class="line">println <span class="string">"Language And Authors"</span></div><div class="line"></div><div class="line"><span class="comment">//节点访问从根节点开始，与XMLParser不同，与DOMCategory相同</span></div><div class="line">languages.language.each&#123;</div><div class="line">    println <span class="string">"$&#123;it.@name&#125; authored by $&#123;it.author[0].text()&#125;"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> languagesByAuthor = &#123; authorName -&gt;</div><div class="line">    languages.language.findAll&#123; it.author[<span class="number">0</span>].text() == authorName &#125;.collect &#123;</div><div class="line">        it.<span class="meta">@name</span></div><div class="line">    &#125;.join(<span class="string">', '</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line">println <span class="string">"Languages by Write:"</span> + languagesByAuthor(<span class="string">'Wirth'</span>)</div></pre></td></tr></table></figure>
<blockquote>
<p>Language And Authors<br>C++ authored by Stroustrup<br>Java authored by Gosling<br>Lisp authored by McCarthy<br>Modula-2 authored by Wirth<br>Oberon-2 authored by Wirth<br>Pascal authored by Wirth<br>Languages by Write:Modula-2, Oberon-2, Pascal</p>
</blockquote>
<p>命名空间可以帮助处理名字冲突<br>命名空间不是URL，但是他们需要保持唯一性</p>
<p>computerAndNaturalLanguages.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--</span></div><div class="line"> ! Excerpted from "Programming Groovy, 2nd Edition",</div><div class="line"> ! published by The Pragmatic Bookshelf.</div><div class="line"> ! Copyrights apply to this code. It may not be used to create training material, </div><div class="line"> ! courses, books, articles, and the like. Contact us if you are in doubt.</div><div class="line"> ! We make no guarantees that this code is fit for any purpose. </div><div class="line"> ! Visit http://www.pragmaticprogrammer.com/titles/vslg2 for more book information.</div><div class="line">--&gt;</div><div class="line"><span class="tag">&lt;<span class="name">languages</span> <span class="attr">xmlns:computer</span>=<span class="string">"Computer"</span> <span class="attr">xmlns:natural</span>=<span class="string">"Natural"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">computer:language</span> <span class="attr">name</span>=<span class="string">"Java"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">computer:language</span> <span class="attr">name</span>=<span class="string">"Groovy"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">computer:language</span> <span class="attr">name</span>=<span class="string">"Erlang"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">natural:language</span> <span class="attr">name</span>=<span class="string">"English"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">natural:language</span> <span class="attr">name</span>=<span class="string">"German"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">natural:language</span> <span class="attr">name</span>=<span class="string">"French"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">languages</span>&gt;</span></div></pre></td></tr></table></figure>
<p>要引用查询中的一个命名空间，就要为命名空间关联一个前缀；使用declareNamespace()方法实现这种关联</p>
<p>element.name将返回所有name的子元素<br>element.’ns:name’则仅返回ns关联的命名空间下的元素，其中ns为命名空间关联的前缀</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">languages = <span class="keyword">new</span> XmlSlurper().parse(<span class="string">'C:\\Users\\wangdz\\Desktop\\computerAndNaturalLanguages.xml'</span>).declareNamespace(<span class="string">human:</span><span class="string">'Natural'</span>)</div><div class="line"></div><div class="line">println <span class="string">"Languages:"</span></div><div class="line">println languages.language.collect&#123; it.<span class="meta">@name</span> &#125;.join(<span class="string">', '</span>)</div><div class="line"></div><div class="line">println <span class="string">"Natural languages:"</span></div><div class="line">println languages.<span class="string">'human:language'</span>.collect&#123; it.<span class="meta">@name</span> &#125;.join(<span class="string">', '</span>)</div></pre></td></tr></table></figure>
<blockquote>
<p>Languages:<br>Java, Groovy, Erlang, English, German, French<br>Natural languages:<br>English, German, French</p>
</blockquote>
<h2 id="创建XML"><a href="#创建XML" class="headerlink" title="创建XML"></a>创建XML</h2><p>使用GString在字符串中嵌入表达式能力，再加上Groovy用于创建多行字符串的设施</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">langs = [<span class="string">'C++'</span>:<span class="string">'Stroustrup'</span>,<span class="string">'Java'</span>:<span class="string">'Gosling'</span>,<span class="string">'Lisp'</span>:<span class="string">'McCarthy'</span>]</div><div class="line">content = <span class="string">''</span></div><div class="line"></div><div class="line">langs.each&#123; language,author -&gt;</div><div class="line">    fragment = <span class="string">"""</span></div><div class="line">        &lt;language name="$&#123;language&#125;"&gt;</div><div class="line">        &lt;author&gt;$&#123;author&#125;&lt;/author&gt;</div><div class="line">        &lt;/language&gt;</div><div class="line">    """</div><div class="line"></div><div class="line">    content += fragment</div><div class="line">&#125;</div><div class="line"></div><div class="line">xml = <span class="string">"&lt;languages&gt;$&#123;content&#125;&lt;/languages&gt;"</span></div><div class="line">println xml</div></pre></td></tr></table></figure>
<p>也可以选择MarkupBuilder或StreamingMarkupBuilder,从任意源创建XML格式的数据输出。<br>这是Groovy应用偏爱的方法，因为生成器提供的便捷性使创建XML文档变得非常容易。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">langs = [<span class="string">'C++'</span>:<span class="string">'Stroustrup'</span>,<span class="string">'Java'</span>:<span class="string">'Gosling'</span>,<span class="string">'Lisp'</span>:<span class="string">'McCarthy'</span>]</div><div class="line"></div><div class="line">xmlDocument = <span class="keyword">new</span> groovy.xml.StreamingMarkupBuilder().bind&#123;</div><div class="line">    <span class="comment">//xml声明</span></div><div class="line">    mkp.xmlDeclaration()</div><div class="line">    <span class="comment">//声明，命名空间</span></div><div class="line">    mkp.declareNamespace(<span class="string">computer:</span> <span class="string">"Computer"</span>)</div><div class="line">    languages&#123;</div><div class="line">        <span class="comment">//添加注释</span></div><div class="line">        comment &lt;&lt; <span class="string">"Create using StreamingMarkupBuilder"</span></div><div class="line">        <span class="comment">//遍历Map</span></div><div class="line">        langs.each&#123; key, value -&gt;</div><div class="line">            computer.language(<span class="string">name:</span>key)&#123;</div><div class="line">                author (value)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">println xmlDocument</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version='1.0'?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">languages</span> <span class="attr">xmlns:computer</span>=<span class="string">'Computer'</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!--Create using StreamingMarkupBuilder--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">computer:language</span> <span class="attr">name</span>=<span class="string">'C++'</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">author</span>&gt;</span>Stroustrup<span class="tag">&lt;/<span class="name">author</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">computer:language</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">computer:language</span> <span class="attr">name</span>=<span class="string">'Java'</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">author</span>&gt;</span>Gosling<span class="tag">&lt;/<span class="name">author</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">computer:language</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">computer:language</span> <span class="attr">name</span>=<span class="string">'Lisp'</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">author</span>&gt;</span>McCarthy<span class="tag">&lt;/<span class="name">author</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">computer:language</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">languages</span>&gt;</span></div></pre></td></tr></table></figure>
<p>如果我们的用户不喜欢维护XML配置文件，他们可以创建基于Groovy的DSL，再将DSL转为底层框架或库期望的XML格式</p>
<h1 id="使用数据库"><a href="#使用数据库" class="headerlink" title="使用数据库"></a>使用数据库</h1><p>GSQL是JDBC的包装器，为轻松访问数据库提供了很多便捷方法<br>GSQL脚本中的数据要多于代码，信噪比很高</p>
<h2 id="连接到数据库"><a href="#连接到数据库" class="headerlink" title="连接到数据库"></a>连接到数据库</h2><p>groovy.sql.Sql类有两个版本</p>
<ul>
<li>接收数据库URL、用户ID、密码和数据库驱动的名字作为参数</li>
<li>接收一个java.sql.Connection实例，或者一个java.sql.DataSource实例</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">userid = <span class="string">'root'</span></div><div class="line">password = <span class="string">'123456'</span></div><div class="line"><span class="keyword">def</span> sql = groovy.sql.Sql.newInstance(<span class="string">'jdbc:mysql://localhost:3306/weatherinfo?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false'</span>,userid,password,<span class="string">'com.mysql.jdbc.Driver'</span>)</div><div class="line"></div><div class="line">println sql.connection.catalog</div></pre></td></tr></table></figure>
<blockquote>
<p>weatherinfo</p>
</blockquote>
<h2 id="Select操作"><a href="#Select操作" class="headerlink" title="Select操作"></a>Select操作</h2><p>迭代表中的数据，只需使用eachRow()，并提供执行的SQL和处理每行数据的闭包</p>
<p>eachRow()提供GroovyResultSet对象来访问表中列，可直接使用列名，也可以使用索引</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">userid = <span class="string">'root'</span></div><div class="line">password = <span class="string">'123456'</span></div><div class="line"><span class="keyword">def</span> sql = groovy.sql.Sql.newInstance(<span class="string">'jdbc:mysql://localhost:3306/weatherinfo?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false'</span>,userid,password,<span class="string">'com.mysql.jdbc.Driver'</span>)</div><div class="line"></div><div class="line">printf <span class="string">"%-20s%s\n"</span>,<span class="string">'City'</span>,<span class="string">'Temperature'</span></div><div class="line"></div><div class="line">sql.eachRow(<span class="string">'SELECT * FROM weather'</span>)&#123;</div><div class="line">    printf <span class="string">"%-20s%s\n"</span>,it.city,it[<span class="number">1</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>City                Temperature<br>Austin              48<br>Baton Rouge         57<br>Jackson             50<br>Montgomery          53<br>Phoenix             67<br>Sacramento          66<br>Santa Fe            27<br>Tallahassee         59</p>
</blockquote>
<p>eachRow()的另一个重载版本，接受两个闭包<br>一个用于元数据，一个用于数据<br>元数据的闭包仅调用一次（在SQL语句执行之后），并以一个ResultSetMetaData实例为参数<br>另一个闭包对结果中每一行调用一次</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">userid = <span class="string">'root'</span></div><div class="line">password = <span class="string">'123456'</span></div><div class="line"><span class="keyword">def</span> sql = groovy.sql.Sql.newInstance(<span class="string">'jdbc:mysql://localhost:3306/weatherinfo?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false'</span>,userid,password,<span class="string">'com.mysql.jdbc.Driver'</span>)</div><div class="line"></div><div class="line">processMeta = &#123; metaData -&gt;</div><div class="line">    metaData.columnCount.times &#123; i -&gt;</div><div class="line">        printf <span class="string">"%-20s"</span>, metaData.getColumnLabel(i+<span class="number">1</span>)</div><div class="line">    &#125;</div><div class="line">    println <span class="string">""</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">sql.eachRow(<span class="string">'SELECT * FROM weather'</span>,processMeta)&#123;</div><div class="line">    printf <span class="string">"%-20s%s\n"</span>,it.city,it[<span class="number">1</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Sql实例的rows()方法,返回结果数据的ArrayList实例</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">userid = <span class="string">'root'</span></div><div class="line">password = <span class="string">'123456'</span></div><div class="line"><span class="keyword">def</span> sql = groovy.sql.Sql.newInstance(<span class="string">'jdbc:mysql://localhost:3306/weatherinfo?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false'</span>,userid,password,<span class="string">'com.mysql.jdbc.Driver'</span>)</div><div class="line"></div><div class="line">rows = sql.rows(<span class="string">'SELECT * FROM weather'</span>)</div><div class="line"></div><div class="line">println rows</div></pre></td></tr></table></figure>
<blockquote>
<p>[[city:Austin, temperature:48], [city:Baton Rouge, temperature:57], [city:Jackson, temperature:50], [city:Montgomery, temperature:53], [city:Phoenix, temperature:67], [city:Sacramento, temperature:66], [city:Santa Fe, temperature:27], [city:Tallahassee, temperature:59]]</p>
</blockquote>
<p>firstRow()方法，仅得到结果的第一行</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">userid = <span class="string">'root'</span></div><div class="line">password = <span class="string">'123456'</span></div><div class="line"><span class="keyword">def</span> sql = groovy.sql.Sql.newInstance(<span class="string">'jdbc:mysql://localhost:3306/weatherinfo?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false'</span>,userid,password,<span class="string">'com.mysql.jdbc.Driver'</span>)</div><div class="line"></div><div class="line">row = sql.firstRow(<span class="string">'SELECT * FROM weather'</span>)</div><div class="line"></div><div class="line">println row</div></pre></td></tr></table></figure>
<blockquote>
<p>[city:Austin, temperature:48]</p>
</blockquote>
<p>call()方法，执行存储过程<br>withStatement()方法，设置一个将在查询之前调用的闭包，如在执行之前拦截并修改SQL查询</p>
<h2 id="将数据转换为XML"><a href="#将数据转换为XML" class="headerlink" title="将数据转换为XML"></a>将数据转换为XML</h2><p>将从数据库获取的数据用Groovy生成器创建数据的不同表示</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">userid = <span class="string">'root'</span></div><div class="line">password = <span class="string">'123456'</span></div><div class="line"><span class="keyword">def</span> sql = groovy.sql.Sql.newInstance(<span class="string">'jdbc:mysql://localhost:3306/weatherinfo?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false'</span>,userid,password,<span class="string">'com.mysql.jdbc.Driver'</span>)</div><div class="line"></div><div class="line">writer = <span class="keyword">new</span> StringWriter()</div><div class="line"></div><div class="line">bldr = <span class="keyword">new</span> groovy.xml.MarkupBuilder()</div><div class="line"></div><div class="line">bldr.weather &#123;</div><div class="line">    sql.eachRow(<span class="string">'SELECT * FROM `weather`'</span>)&#123;</div><div class="line">        city(<span class="string">'name'</span>:it.city,<span class="string">temperature:</span>it.temperature)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">println writer</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">weather</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">city</span> <span class="attr">name</span>=<span class="string">'Austin'</span> <span class="attr">temperature</span>=<span class="string">'48'</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">city</span> <span class="attr">name</span>=<span class="string">'Baton Rouge'</span> <span class="attr">temperature</span>=<span class="string">'57'</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">city</span> <span class="attr">name</span>=<span class="string">'Jackson'</span> <span class="attr">temperature</span>=<span class="string">'50'</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">city</span> <span class="attr">name</span>=<span class="string">'Montgomery'</span> <span class="attr">temperature</span>=<span class="string">'53'</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">city</span> <span class="attr">name</span>=<span class="string">'Phoenix'</span> <span class="attr">temperature</span>=<span class="string">'67'</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">city</span> <span class="attr">name</span>=<span class="string">'Sacramento'</span> <span class="attr">temperature</span>=<span class="string">'66'</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">city</span> <span class="attr">name</span>=<span class="string">'Santa Fe'</span> <span class="attr">temperature</span>=<span class="string">'27'</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">city</span> <span class="attr">name</span>=<span class="string">'Tallahassee'</span> <span class="attr">temperature</span>=<span class="string">'59'</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">weather</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="使用DataSet"><a href="#使用DataSet" class="headerlink" title="使用DataSet"></a>使用DataSet</h2><p>Sql类的dataSet()方法接收一个表名，并返回一个虚拟代理–直到迭代时，才去取实际的行<br>使用findAll()添加过滤条件<br>使用each()迭代数据</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">userid = <span class="string">'root'</span></div><div class="line">password = <span class="string">'123456'</span></div><div class="line"><span class="keyword">def</span> sql = groovy.sql.Sql.newInstance(<span class="string">'jdbc:mysql://localhost:3306/weatherinfo?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false'</span>,userid,password,<span class="string">'com.mysql.jdbc.Driver'</span>)</div><div class="line"></div><div class="line">dataSet = sql.dataSet(<span class="string">'weather'</span>)</div><div class="line">citiesBelowFreezing = dataSet.findAll &#123; it.temperature &lt; <span class="number">32</span> &#125;</div><div class="line">println <span class="string">'Cities below freezing:'</span></div><div class="line"></div><div class="line">citiesBelowFreezing.each &#123; it</div><div class="line">	println it.city</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>这个demo没有运行通过</p>
</blockquote>
<p>##　插入与更新</p>
<p>使用DataSet插入数据；add()方法接收一个数据的Map，用其中的数据创建一行</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">userid = <span class="string">'root'</span></div><div class="line">password = <span class="string">'123456'</span></div><div class="line"><span class="keyword">def</span> sql = groovy.sql.Sql.newInstance(<span class="string">'jdbc:mysql://localhost:3306/weatherinfo?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false'</span>,userid,password,<span class="string">'com.mysql.jdbc.Driver'</span>)</div><div class="line"></div><div class="line">println <span class="string">"Number of cities :"</span> + sql.rows(<span class="string">"SELECT * FROM `weather`"</span>).size()</div><div class="line"></div><div class="line">dataSet = sql.dataSet(<span class="string">'weather'</span>)</div><div class="line"><span class="comment">//通过DataSet添加数据</span></div><div class="line">dataSet.add(<span class="string">city:</span> <span class="string">'Denver'</span>, <span class="string">temperature:</span><span class="number">19</span>)</div><div class="line"></div><div class="line">println <span class="string">"Number of cities :"</span> + sql.rows(<span class="string">"SELECT * FROM `weather`"</span>).size();</div></pre></td></tr></table></figure>
<blockquote>
<p>Number of cities :8<br>Number of cities :9</p>
</blockquote>
<p>更传统的方式是使用SQL类的execute()或executeInsert()</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">userid = <span class="string">'root'</span></div><div class="line">password = <span class="string">'123456'</span></div><div class="line"><span class="keyword">def</span> sql = groovy.sql.Sql.newInstance(<span class="string">'jdbc:mysql://localhost:3306/weatherinfo?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false'</span>,userid,password,<span class="string">'com.mysql.jdbc.Driver'</span>)</div><div class="line"></div><div class="line">temperature = <span class="number">50</span>;</div><div class="line">sql.executeInsert(<span class="string">"""INSERT INTO `weather` (city, temperature)</span></div><div class="line">    VALUES ('Oklahoma City', $&#123;temperature&#125;)""")</div><div class="line"></div><div class="line">println sql.firstRow(</div><div class="line">    <span class="string">"SELECT * FROM `weather` WHERE city = 'Oklahoma City'"</span>)</div></pre></td></tr></table></figure>
<blockquote>
<p>[city:Oklahoma City, temperature:50]</p>
</blockquote>
<h2 id="访问Microsoft-Excel"><a href="#访问Microsoft-Excel" class="headerlink" title="访问Microsoft Excel"></a>访问Microsoft Excel</h2><p>可以使用Sql类类访问Microsoft Excel</p>
<p>JKD.version&lt;=1.7<br>jkd8 移除了sun.jdbc.odbc.jdbcodbcdriver</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> sql = groovy.sql.Sql.newInstance(<span class="string">"""jdbc:odbc:Driver=</span></div><div class="line">    &#123;Microsoft Excel Driver (*.xls, *.xlsx, *.xlsm, *.xlsb)&#125;;</div><div class="line">    DBQ=D:/temp/weather.xlsx;READONLY=false""",<span class="string">''</span>,<span class="string">''</span>)</div><div class="line"></div><div class="line">println <span class="string">"City\t\tTemperature"</span></div><div class="line"></div><div class="line">sql.eachRow(<span class="string">'SELECT * FROM [temperatures$]'</span>)&#123;</div><div class="line">    println <span class="string">"$&#123;it.city&#125;\t\t$&#123;it.temperature&#125;"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>City        Temperature<br>Denver        19.0<br>Boston        12.0<br>New York        22.0</p>
</blockquote>
<h1 id="使用脚本和类"><a href="#使用脚本和类" class="headerlink" title="使用脚本和类"></a>使用脚本和类</h1><h2 id="Java和Groovy的混合"><a href="#Java和Groovy的混合" class="headerlink" title="Java和Groovy的混合"></a>Java和Groovy的混合</h2><p>Groovy代码中使用Groovy脚本，可以使用GroovyShell<br>Java类中使用Groovy脚本，可以使用JSR223提供的ScriptEngine API</p>
<p>Java中使用Groovy类，或Groovy中使用Java类，可以利用Groovy的联合编译（joint-compilation）工具</p>
<h2 id="运行Groovy代码"><a href="#运行Groovy代码" class="headerlink" title="运行Groovy代码"></a>运行Groovy代码</h2><p>groovy命令，自动在内存中编译代码并执行</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Greet.groovy</span></div><div class="line">println ([<span class="string">'Groovy'</span>,<span class="string">'Rocks!'</span>].join(<span class="string">' '</span>))</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">groovy Greet.groovy</div><div class="line"><span class="comment">#或</span></div><div class="line">groovy Greet</div></pre></td></tr></table></figure>
<blockquote>
<p>Groovy Rocks!</p>
</blockquote>
<p>将groovyc编译器，编译代码，创建字节码，使用java命令运行<br>需要将groovy-all-2.1.0.jar（在GROOVY_HOME的embeddable目录下）放到classpath下</p>
<p>在classpath中添加句号(.),这样java命令就可以找到当前目录下的类</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Greet.groovy</span></div><div class="line">println ([<span class="string">'Groovy'</span>,<span class="string">'Rocks!'</span>].join(<span class="string">' '</span>))</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">groovyc Greet.groovy</div><div class="line"><span class="comment">#或</span></div><div class="line">groovyc *.groovy</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -classpath groovy-all-2.1.0.jar:. Greet</div></pre></td></tr></table></figure>
<blockquote>
<p>java 运行Groovy编译的class，没有成功<br>错误: 找不到或无法加载主类 Greet</p>
</blockquote>
<h2 id="Groovy中使用Groovy类"><a href="#Groovy中使用Groovy类" class="headerlink" title="Groovy中使用Groovy类"></a>Groovy中使用Groovy类</h2><p>Groovy代码中使用Groovy类，只需确保该类在classpath下，可以使用Groovy源码也可以使用编译成.class文件</p>
<p>Groovy代码中引用Groovy类时，Groovy以该类名在classpath下查找.groovy文件；如果找不到，则查找.class文件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//src/Car.groovy</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span>&#123;</span></div><div class="line">	<span class="keyword">int</span> year = <span class="number">2008</span></div><div class="line">	<span class="keyword">int</span> miles</div><div class="line"></div><div class="line">	String toString()&#123;</div><div class="line">		<span class="string">"Car: year:$year, miles: $miles"</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//useCar.groovy</span></div><div class="line">println <span class="keyword">new</span> Car()</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">groovy -classpath src userCar</div></pre></td></tr></table></figure>
<blockquote>
<p>Car: year:2008, miles: 0</p>
</blockquote>
<p>将src目录下的Car.groovy替换为编译后的Car.class,使用groovy命令运行，成功<br>将两个groovy文件都替换为编译后的class文件，使用java命令运行，失败</p>
<p>将Groovy类编译为jar，在eclipe中引用，并在java中使用，没问题</p>
<h2 id="利用联合编译混合使用Groovy和Java"><a href="#利用联合编译混合使用Groovy和Java" class="headerlink" title="利用联合编译混合使用Groovy和Java"></a>利用联合编译混合使用Groovy和Java</h2><p>Java中可以方便的使用Groovy类编译好的.class文件或JAR包</p>
<p>来自Java的字节码和来自Groovy的字节码，对Java而言没有区别</p>
<p>groovyc支持联合编译，-J前缀标志传给Java编译器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">groovyc -j AJavaClass.java UseJavaClass.groovy -Jsource 1.6</div></pre></td></tr></table></figure>
<h2 id="在Java中创建与传递Groovy闭包"><a href="#在Java中创建与传递Groovy闭包" class="headerlink" title="在Java中创建与传递Groovy闭包"></a>在Java中创建与传递Groovy闭包</h2><p>Groovy调用闭包，使用一个名为call()的特殊方法<br>Java中创建闭包，只需一个包含call()方法的类</p>
<p>Groovy要向闭包中传递参数，需确保call()方法有接收实参的形参</p>
<h2 id="在Java中调用Groovy的动态方法"><a href="#在Java中调用Groovy的动态方法" class="headerlink" title="在Java中调用Groovy的动态方法"></a>在Java中调用Groovy的动态方法</h2><p>Groovy对象都实现了GroovyObject接口，该接口有一个invokeMethod()方法<br>Java端可以用invokeMethod()方法调用Groovy使用元编程动态定义的方法</p>
<h2 id="Groovy中使用Java类"><a href="#Groovy中使用Java类" class="headerlink" title="Groovy中使用Java类"></a>Groovy中使用Java类</h2><p>import类后，可直接使用</p>
<h2 id="Groovy中使用Groovy脚本"><a href="#Groovy中使用Groovy脚本" class="headerlink" title="Groovy中使用Groovy脚本"></a>Groovy中使用Groovy脚本</h2><h2 id="Java中使用Groovy脚本"><a href="#Java中使用Groovy脚本" class="headerlink" title="Java中使用Groovy脚本"></a>Java中使用Groovy脚本</h2><h1 id="探索元对象协议"><a href="#探索元对象协议" class="headerlink" title="探索元对象协议"></a>探索元对象协议</h1><p>元编程（metaprogramming）意味着编写能够操作程序的程序，包括操作程序本身</p>
<p>Groovy这样的动态语言通过元对象协议（MetaObject Protocol,MOP）提供了这种能力</p>
<p>利用Groovy的MOP，创建类、编写单元测试和引入模拟对象都很容易</p>
<p>Groovy中，使用MOP可以动态调用方法，在运行时合成类和方法</p>
<h2 id="Groovy对象"><a href="#Groovy对象" class="headerlink" title="Groovy对象"></a>Groovy对象</h2><p>Groovy对象是带有附加功能的java对象</p>
<p>Groovy应用中使用3类对象：</p>
<ul>
<li>POJO（Plain Old Java Object）普通的Java对象，使用Java或JVM上的其他语言创建</li>
<li>POGO（Plain Old Groovy Object）Groovy对象，扩展了java.lang.Object，同时实现了groovy.lang.GroovyObject</li>
<li>Groovy拦截器,扩展了GroovyInterceptable的Groovy对象，具有方法拦截功能</li>
</ul>
<p>Groovy源码，GroovyObject.java代码片段</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> groovy.lang</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GrovyObject</span>&#123;</span></div><div class="line">	Object invokeMethod(String name, Object args);</div><div class="line">	Object getProperty(String property);</div><div class="line">	<span class="keyword">void</span> setProperty(String property,Object newValue);</div><div class="line">	MetaClass getMetaClass();</div><div class="line">	<span class="keyword">void</span> setMetaClass(MetaClass metaClass);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>getMetaClass()和setMetaClass()使创建代理拦截POGO上的方法调用、在POGO上上注入方法变得容易</p>
<p>一旦类被加载到JVM中，就不能修改元对象Class，可以通过setMetaClass()修改它的MetaClass</p>
<p>GroovyInterceptable接口是扩展了GroovyObject的标记接口，实现该接口的对象上的所有方法调用，都会被invokeMethod()方法拦截</p>
<p>Groovy支持对POJO和POGO进行元编程。<br>对于POGO，Groovy维护了MetaClass的一个MetaClassRegistry<br>POGO有一个MetaClass的直接引用</p>
<p>对于POJO，Groovy将方法调用委托给通过MetaClassRegistry取得的MetaClass<br>MetaClass上定义的任何拦截器和方法，都优先于POJO原来的方法</p>
<p>对于实现了GroovyInterceptable接口的POGO，所有调用都路由到invokeMethod()</p>
<p>对于没有实现GroovyInterceptable接口的POGO<br>方法查找顺序为：</p>
<ul>
<li>MetaClass中的方法</li>
<li>POGO上的方法</li>
<li>类型为Closure的字段</li>
<li>POGO的methodMissing()方法</li>
<li>POGO的invokeMethod()方法</li>
</ul>
<p>invokeMethod()默认实现抛出MissingMethodException异常</p>
<h2 id="查询方法与属性"><a href="#查询方法与属性" class="headerlink" title="查询方法与属性"></a>查询方法与属性</h2><p>在运行时可以查询对象的方法和属性</p>
<p>使用MetaObjectProtocol的方法获取元方法和元属性（MetaClass扩展了MetaObjectProtoCol）</p>
<ul>
<li>getMetaMethod()获取元方法</li>
<li>getStaticMetaMethod()获取静态方法</li>
<li>getMetaMethods()和getStaticMetaMethods()获取重载方法的列表</li>
<li>getMetaProperty()和getStaticMetaProperty()获取元属性</li>
<li>respondsTo()检查方法是否存在</li>
<li>hasProperty()检查属性是否存在</li>
</ul>
<p>使用获得的metaMethod调用方法</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">str = <span class="string">"hello"</span></div><div class="line">methodName = <span class="string">'toUpperCase'</span></div><div class="line"></div><div class="line"><span class="comment">//获取元方法</span></div><div class="line">methodOfInterest = str.metaClass.getMetaMethod(methodName)</div><div class="line"></div><div class="line"><span class="comment">//在实例上调用元方法</span></div><div class="line">println methodOfInterest.invoke(methodName)</div></pre></td></tr></table></figure>
<blockquote>
<p>HELLO</p>
</blockquote>
<p>使用respondsTo()检查方法是否存在<br>参数：查询的实例、查询的方法名以及逗号分隔的提供给该方法的参数</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">print <span class="string">"Does String respond to toUpperCase()?"</span></div><div class="line">println String.metaClass.respondsTo(str,<span class="string">'toUpperCase'</span>)?'yes':<span class="string">'no'</span></div><div class="line">print <span class="string">"Does String respond to compareTo(String)?"</span></div><div class="line">println String.metaClass.respondsTo(str,<span class="string">'compareTo'</span>,<span class="string">"test"</span>)?'yes':<span class="string">'no'</span></div><div class="line">print <span class="string">"Does String respond to compareTo(int)?"</span></div><div class="line">println String.metaClass.respondsTo(str,<span class="string">'toUpperCase'</span>,<span class="number">5</span>)?'yes':<span class="string">'no'</span></div></pre></td></tr></table></figure>
<blockquote>
<p>Does String respond to toUpperCase()?yes<br>Does String respond to compareTo(String)?yes<br>Does String respond to compareTo(int)?no</p>
</blockquote>
<h2 id="动态访问对象"><a href="#动态访问对象" class="headerlink" title="动态访问对象"></a>动态访问对象</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> printInfo(obj)&#123;</div><div class="line">    usrRequestedProperty = <span class="string">'bytes'</span></div><div class="line">    usrRequestedMethod = <span class="string">'toUpperCase'</span></div><div class="line">    </div><div class="line">    <span class="comment">//使用索引操作符[]访问属性</span></div><div class="line">    println obj[usrRequestedProperty]</div><div class="line">    <span class="comment">//使用点号访问属性</span></div><div class="line">    println obj.<span class="string">"$usrRequestedProperty"</span></div><div class="line">    </div><div class="line">    <span class="comment">//使用点号和调用符号调用方法</span></div><div class="line">    println obj.<span class="string">"$usrRequestedMethod"</span>()</div><div class="line">    <span class="comment">//使用invokeMethod调用方法</span></div><div class="line">    println obj.invokeMethod(usrRequestedMethod,<span class="literal">null</span>)   </div><div class="line">&#125;</div><div class="line">    </div><div class="line">printInfo(<span class="string">'hello'</span>)</div></pre></td></tr></table></figure>
<blockquote>
<p>[104, 101, 108, 108, 111]<br>[104, 101, 108, 108, 111]<br>HELLO<br>HELLO</p>
</blockquote>
<p>迭代对象的所有属性，使用properties属性或getProperties()方法</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">println <span class="string">"Properties of 'hello' are:"</span></div><div class="line"><span class="string">'hello'</span>.properties.each&#123;</div><div class="line">	println it</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Properties of ‘hello’ are:<br>class=class java.lang.String<br>bytes=[B@52bdbdf1<br>empty=false</p>
</blockquote>
<h1 id="使用MOP拦截方法"><a href="#使用MOP拦截方法" class="headerlink" title="使用MOP拦截方法"></a>使用MOP拦截方法</h1><p>Groovy中拦截方法调有两种方式：<br>实现GroovyInterceptable接口的对象拦截<br>MetaClass拦截</p>
<h2 id="使用GroovyInterceptable拦截方法"><a href="#使用GroovyInterceptable拦截方法" class="headerlink" title="使用GroovyInterceptable拦截方法"></a>使用GroovyInterceptable拦截方法</h2><p>一个Groovy对象，实现了GroovyInterceptable接口，<br>调用该对象上的任何一个方法(无论是否存在)，都会调用invokeMethod()</p>
<p>即GroovyInterceptable的invokeMethod()方法劫持了该对象上的所有方法调用</p>
<blockquote>
<p>注：如果一个对象的MetaClass上实现了invokeMethod()，不管方法是否存在，都会调用该方法</p>
</blockquote>
<p>使用GroovyInterceptable拦截方法调用，适于拦截作者是我们自己的类中的方法</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> <span class="keyword">implements</span> <span class="title">GroovyInterceptable</span> &#123;</span></div><div class="line"></div><div class="line">	<span class="keyword">public</span> Car() &#123;</div><div class="line">		<span class="comment">// TODO Auto-generated constructor stub</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">def</span> check()&#123;</div><div class="line">		System.out.println <span class="string">"check called ..."</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">def</span> start()&#123;</div><div class="line">		System.out.println <span class="string">"start called..."</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">def</span> drive()&#123;</div><div class="line">		System.out.println <span class="string">"drive called..."</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">def</span> invokeMethod(String name, args)&#123;</div><div class="line">		System.out.println (<span class="string">"Call to $name intercepted..."</span>)</div><div class="line">		</div><div class="line">		<span class="keyword">if</span>(name != <span class="string">'check'</span>)&#123;</div><div class="line">			System.out.println(<span class="string">"running filter..."</span>)</div><div class="line">			Car.metaClass.getMetaMethod(<span class="string">'check'</span>).invoke(<span class="keyword">this</span>,<span class="literal">null</span>)</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="keyword">def</span> validMethod = Car.metaClass.getMetaMethod(name, args)</div><div class="line">		</div><div class="line">		<span class="keyword">if</span>(validMethod != <span class="literal">null</span>)&#123;</div><div class="line">			<span class="comment">//调用当前对象中方法</span></div><div class="line">			validMethod.invoke(<span class="keyword">this</span>, args)</div><div class="line">		&#125;<span class="keyword">else</span>&#123;</div><div class="line">			<span class="comment">//调用metaClass上的方法</span></div><div class="line">			Car.metaClass.invokeMethod(<span class="keyword">this</span>,name,args)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">def</span> args)&#123;</div><div class="line">		<span class="keyword">def</span> Car car = <span class="keyword">new</span> Car()</div><div class="line">		car.start()</div><div class="line">		car.drive()</div><div class="line">		car.check()</div><div class="line">		</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			car.sleep()</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			<span class="comment">//e.printStackTrace()</span></div><div class="line">			println e</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Call to start intercepted…<br>running filter…<br>check called …<br>start called…<br>Call to drive intercepted…<br>running filter…<br>check called …<br>drive called…<br>Call to check intercepted…<br>check called …<br>Call to sleep intercepted…<br>running filter…<br>check called …<br>org.codehaus.groovy.runtime.metaclass.MethodSelectionException: Could not find which method sleep() to invoke from this list:<br>  public static void java.lang.Object#sleep(long)<br>  public static void java.lang.Object#sleep(long, groovy.lang.Closure)</p>
<p>注：<br>  这里输出使用System.out.println ()替换println()<br>  因为println()是Groovy在Object上注入的一个方法，调用它会被invokeMethod()拦截，造成java.lang.StackOverflowError</p>
</blockquote>
<h2 id="使用MetaClass拦截方法"><a href="#使用MetaClass拦截方法" class="headerlink" title="使用MetaClass拦截方法"></a>使用MetaClass拦截方法</h2><p>对于无权修改类的源代码，或类是java类的情况，可以使用在MetaClass上实现invokeMethod()方法，并以此拦截方法</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car2</span> &#123;</span></div><div class="line"></div><div class="line">	<span class="keyword">public</span> Car() &#123;</div><div class="line">		<span class="comment">// TODO Auto-generated constructor stub</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">def</span> check()&#123;</div><div class="line">		System.out.println <span class="string">"check called ..."</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">def</span> start()&#123;</div><div class="line">		System.out.println <span class="string">"start called..."</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">def</span> drive()&#123;</div><div class="line">		System.out.println <span class="string">"drive called..."</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">def</span> args)&#123;</div><div class="line">		<span class="comment">//invokeMethod()拦截所有方法调用</span></div><div class="line">		Car2.metaClass.invokeMethod = &#123;String name, params -&gt;</div><div class="line">			System.out.print(<span class="string">"Call to $name intercepted..."</span>)</div><div class="line">			<span class="keyword">if</span>(name != <span class="string">'check'</span>)&#123;</div><div class="line">				System.out.print(<span class="string">"running filter..."</span>)</div><div class="line">				<span class="comment">//delegate指向要拦截方法的目标对象</span></div><div class="line">				Car2.metaClass.getMetaMethod(<span class="string">"check"</span>).invoke(delegate, <span class="literal">null</span>)</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">			<span class="keyword">def</span> validMethod = Car2.metaClass.getMetaMethod(name, params)</div><div class="line">			</div><div class="line">			<span class="keyword">if</span>(validMethod != <span class="literal">null</span>)&#123;</div><div class="line">				validMethod.invoke(delegate, params)</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				Car2.metaClass.invokeMissingMethod(delegate, name,args)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="keyword">def</span> Car2 car = <span class="keyword">new</span> Car2()</div><div class="line">		car.start()</div><div class="line">		car.drive()</div><div class="line">		car.check()</div><div class="line">		</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			car.sleep()</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			<span class="comment">//e.printStackTrace()</span></div><div class="line">			println e</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Call to start intercepted…running filter…check called …<br>start called…<br>Call to drive intercepted…running filter…check called …<br>drive called…<br>Call to check intercepted…check called …<br>Call to sleep intercepted…running filter…check called …<br>org.codehaus.groovy.runtime.metaclass.MethodSelectionException: Could not find which method sleep() to invoke from this list:<br>  public static void java.lang.Object#sleep(long)<br>  public static void java.lang.Object#sleep(long, groovy.lang.Closure)</p>
</blockquote>
<p>只是拦截不存在的方法调用，应该使用methodMissing()代替invokeMethod()</p>
<p>可以在MetaClass上<code>同时提供invokeMethod()和methodMissing()</code>，<code>invokeMethond()优先于methodMissing()</code></p>
<h1 id="MOP方法注入"><a href="#MOP方法注入" class="headerlink" title="MOP方法注入"></a>MOP方法注入</h1><p>可以动态地向类中添加方法</p>
<h2 id="使用分类注入方法"><a href="#使用分类注入方法" class="headerlink" title="使用分类注入方法"></a>使用分类注入方法</h2><p>分类(category) 是一种能够修改类的MetaClass的对象<br>这种修改仅在代码块的作用域和执行线程内有效，退出代码块时，恢复原状</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StringUtil</span>&#123;</span></div><div class="line">	<span class="comment">//self参数被指派为目标实例</span></div><div class="line">    <span class="keyword">def</span> <span class="keyword">static</span> toSSN(self)&#123;</div><div class="line">        <span class="keyword">if</span>(self.size() == <span class="number">9</span>)&#123;</div><div class="line">            <span class="string">"$&#123;self[0..2]&#125;-$&#123;self[3..4]&#125;-$&#123;self[5..8]&#125;"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">use(StringUtil)&#123;</div><div class="line">    println <span class="string">"123456789"</span>.toSSN()</div><div class="line">    println <span class="keyword">new</span> StringBuilder(<span class="string">"987654321"</span>).toSSN()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    println <span class="string">"123456789"</span>.toSSN()</div><div class="line">    &#125;<span class="keyword">catch</span>(MissingMethodException ex)&#123;</div><div class="line">        println ex.message</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>123-45-6789<br>987-65-4321<br>No signature of method: java.lang.String.toSSN() is applicable for argument types: () values: []<br>Possible solutions: toSet(), toURI(), toURI(), toURL(), toURL(), toLong()</p>
</blockquote>
<p>使用@Category注解，让Groovy将实例方法转变为静态方法</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//限定了使用类型，可指定为Object</span></div><div class="line"><span class="meta">@Category</span>(String)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StringUtilAnnotated</span>&#123;</span></div><div class="line">	<span class="keyword">def</span> toSSN()&#123;</div><div class="line">		<span class="keyword">if</span>(size() == <span class="number">9</span>)&#123;</div><div class="line">            <span class="string">"$&#123;this[0..2]&#125;-$&#123;this[3..4]&#125;-$&#123;this[5..8]&#125;"</span></div><div class="line">        &#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">use(StringUtilAnnotated)&#123;</div><div class="line">	 println <span class="string">"123456789"</span>.toSSN()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>123-45-6789</p>
</blockquote>
<p>第一个参数指向方法调用的目标。其他参数放在后面</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Category</span>(String)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StringUtilAnnotated</span>&#123;</span></div><div class="line">    <span class="keyword">def</span> toSSN(param1)&#123;</div><div class="line">        <span class="keyword">if</span>(size() == <span class="number">9</span>)&#123;</div><div class="line">            <span class="string">"$&#123;param1&#125;-$&#123;this[0..2]&#125;-$&#123;this[3..4]&#125;-$&#123;this[5..8]&#125;"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">use(StringUtilAnnotated)&#123;</div><div class="line">     println <span class="string">"123456789"</span>.toSSN(<span class="string">"SSN"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>SSN-123-45-6789</p>
</blockquote>
<p>可使用多个分类，带入多组方法<br>存在同名方法时，列表中后面分类优先级高</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">use(StringUtil,FindUtil)&#123;</div><div class="line">	<span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>use()可以嵌套使用，内部分类优先于外部的</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">use(StringUtil)&#123;</div><div class="line">	<span class="comment">//...</span></div><div class="line">	use(FindUtil)&#123;</div><div class="line">		<span class="comment">//...</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用分类拦截方法</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Helper</span>&#123;</span></div><div class="line">    <span class="keyword">def</span> <span class="keyword">static</span> toString(String self)&#123;</div><div class="line">        <span class="keyword">def</span> method = self.metaClass.methods.find&#123;</div><div class="line">            it.name == <span class="string">'toString'</span></div><div class="line">        &#125;</div><div class="line">        <span class="string">'!!'</span> + method.invoke(self,<span class="literal">null</span>) + <span class="string">'!!'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">use(Helper)&#123;</div><div class="line">    println <span class="string">'hello'</span>.toString()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与GroovyInterceptable接口和metaClass.invokeMethod拦截方法不同，<br>分类拦截方法，需要为每个目标方法编写一个拦截方法</p>
<p>应该将分类用于方法注入，而不是方法拦截</p>
<h2 id="使用ExpandoMetaClass注入方法"><a href="#使用ExpandoMetaClass注入方法" class="headerlink" title="使用ExpandoMetaClass注入方法"></a>使用ExpandoMetaClass注入方法</h2><p>通过向类的MetaClass添加方法可以实现向类中注入方法，不同于分类中局限于一个块，<br>这种注入方法是全局可用的。</p>
<p>ExpandoMetaClass可以添加方法、属性、构造器和静态方法，也可以从其他类借方法，甚至向POGO和POJO中注入方法。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Integer.metaClass.daysFromNow = &#123;</div><div class="line">    Calendar today = Calendar.instance</div><div class="line">    <span class="comment">//delegate引用指向目标对象</span></div><div class="line">    today.add(Calendar.DAY_OF_YEAR,delegate)</div><div class="line">    today.time</div><div class="line">&#125;</div><div class="line"></div><div class="line">println <span class="number">5.</span>daysFromNow()</div></pre></td></tr></table></figure>
<blockquote>
<p>Tue Oct 18 20:40:45 CST 2016</p>
</blockquote>
<p>多个类中添加相同方法<br>闭包保存到一个变量中，并指派给类</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">daysFromNow = &#123;</div><div class="line">    Calendar today = Calendar.instance</div><div class="line">    today.add(Calendar.DAY_OF_YEAR,(<span class="keyword">int</span>)delegate)</div><div class="line">    today.time</div><div class="line">&#125;</div><div class="line"></div><div class="line">Integer.metaClass.daysFromNow = daysFromNow</div><div class="line">Long.metaClass.daysFromNow = daysFromNow</div><div class="line"></div><div class="line"></div><div class="line">println <span class="number">5.</span>daysFromNow()</div><div class="line">println <span class="number">5</span>L.daysFromNow()</div></pre></td></tr></table></figure>
<blockquote>
<p>Tue Oct 18 20:46:15 CST 2016<br>Tue Oct 18 20:46:15 CST 2016</p>
</blockquote>
<p>向类中注入静态方法，将其加入MetaClass的statics属性中</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Integer.metaClass.<span class="string">'static'</span>.isEven = &#123; val -&gt;</div><div class="line">    val%<span class="number">2</span> == <span class="number">0</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">println <span class="string">"Is 2 even? "</span> + Integer.isEven(<span class="number">2</span>)</div><div class="line">println <span class="string">"Is 3 even? "</span> + Integer.isEven(<span class="number">3</span>)</div></pre></td></tr></table></figure>
<blockquote>
<p>Is 2 even? true<br>Is 3 even? false</p>
</blockquote>
<p>通过名为constructor的特殊属性加入构造器</p>
<p>使用&lt;&lt;添加构造器（使用&lt;&lt;覆盖现有构造器，Groovy报错）</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//添加参数类型为Calendar的构造器，返回当前日期天数</span></div><div class="line">Integer.metaClass.constructor &lt;&lt; &#123; Calendar calendar -&gt;</div><div class="line">    <span class="keyword">new</span> Integer(calendar.get(Calendar.DAY_OF_YEAR))</div><div class="line">&#125;</div><div class="line">println <span class="keyword">new</span> Integer(Calendar.instance)</div></pre></td></tr></table></figure>
<blockquote>
<p>287</p>
</blockquote>
<p>使用=替换现有构造器</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Integer.metaClass.constructor &lt;&lt; &#123; Calendar calendar -&gt;</div><div class="line">    <span class="keyword">new</span> Integer(calendar.get(Calendar.DAY_OF_YEAR))</div><div class="line">&#125;</div><div class="line"></div><div class="line">Integer.metaClass.constructor = &#123; <span class="keyword">int</span> val -&gt;</div><div class="line">    println <span class="string">"Intercepting constructor call"</span></div><div class="line">    <span class="comment">//覆盖的构造器内仍然可以使用反射调用原来的实现</span></div><div class="line">    constructor = Integer.<span class="keyword">class</span>.getConstructor(Integer.TYPE)</div><div class="line">    constructor.newInstance(val)</div><div class="line">&#125;</div><div class="line"></div><div class="line">println <span class="keyword">new</span> Integer(<span class="number">4</span>)</div><div class="line">println <span class="keyword">new</span> Integer(Calendar.instance)</div></pre></td></tr></table></figure>
<blockquote>
<p>Intercepting constructor call<br>4<br>Intercepting constructor call<br>287</p>
</blockquote>
<p>添加一两个方法，可以使用ClassName.metaClass.method = {…}<br>Groovy提供了一种可以将方法分组的方式，组织成叫做ExpandoMetaClass(EMC)DSL的方便语法</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">Integer.metaClass &#123;</div><div class="line">    daysFromNow = &#123;</div><div class="line">        Calendar today = Calendar.instance</div><div class="line">        today.add(Calendar.DAY_OF_YEAR,(<span class="keyword">int</span>)delegate)</div><div class="line">        today.time</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//添加静态方法</span></div><div class="line">    <span class="string">'static'</span> &#123;</div><div class="line">        inEven = &#123; val -&gt;</div><div class="line">            val%<span class="number">2</span> == <span class="number">0</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//添加&amp;替换构造函数</span></div><div class="line">    constructor = &#123;Calendar calendar -&gt;</div><div class="line">        <span class="keyword">new</span> Integer(calendar.get(Calendar.DAY_OF_YEAR))        </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    constructor = &#123;<span class="keyword">int</span> val -&gt;</div><div class="line">        println <span class="string">"Intercepting constructor call"</span></div><div class="line">        constructor = Integer.<span class="keyword">class</span>.getConstructor(Integer.TYPE)</div><div class="line">        constructor.newInstance(val)    </div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">println <span class="number">5.</span>daysFromNow()</div><div class="line"></div><div class="line">println <span class="string">"Is 2 even? "</span> + Integer.isEven(<span class="number">2</span>)</div><div class="line">println <span class="string">"Is 3 even? "</span> + Integer.isEven(<span class="number">3</span>)</div><div class="line"></div><div class="line">println <span class="keyword">new</span> Integer(<span class="number">4</span>)</div><div class="line">println <span class="keyword">new</span> Integer(Calendar.instance)</div></pre></td></tr></table></figure>
<blockquote>
<p>Tue Oct 18 21:26:50 CST 2016<br>Is 2 even? true<br>Is 3 even? false<br>Intercepting constructor call<br>4<br>Intercepting constructor call<br>287</p>
</blockquote>
<p>利用ExpandoMethodClass可以将方法注入到POJO和POGO中，因此，可以在所有类中使用动态能力。</p>
<p>注入的方法只能从Groovy代码内调用，不能从编译过的java代码中调用，也不能从java代码中通过反射来使用<br>有一种变通方案，java中通过invokeMethod()来调用Groovy中元编程动态定义的方法</p>
<h2 id="向具体实例中注入方法"><a href="#向具体实例中注入方法" class="headerlink" title="向具体实例中注入方法"></a>向具体实例中注入方法</h2><p>可以创建一个ExpandoMetaClass实例，将方法加入其中，对其进行初始化(说明方法/属性添加完成)，再将其附到想要增强的事例上。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Persion</span>&#123;</span></div><div class="line">    <span class="keyword">def</span> play()&#123;</div><div class="line">        println <span class="string">"playing ..."</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> emc = <span class="keyword">new</span> ExpandoMetaClass(Person)</div><div class="line">emc.sing = &#123; -&gt;</div><div class="line">    <span class="string">'oh baby baby'</span></div><div class="line">&#125;</div><div class="line">emc.initialize()</div><div class="line"></div><div class="line"><span class="keyword">def</span> jack = <span class="keyword">new</span> Person()</div><div class="line"><span class="keyword">def</span> paul = <span class="keyword">new</span> Person()</div><div class="line"></div><div class="line">jack.metaClass = emc</div><div class="line"></div><div class="line"></div><div class="line">println jack.sing()</div><div class="line"></div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    paul.sing()</div><div class="line">&#125;<span class="keyword">catch</span>(ex)&#123;</div><div class="line">    println ex</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//去掉注入的方法</span></div><div class="line">jack.metaClass = <span class="literal">null</span></div><div class="line"></div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    jack.play()</div><div class="line">    jack.sing()</div><div class="line">&#125;<span class="keyword">catch</span>(ex)&#123;</div><div class="line">    println ex</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>oh baby baby<br>groovy.lang.MissingMethodException: No signature of method: Person.sing() is applicable for argument types: () values: []<br>Possible solutions: find(), find(groovy.lang.Closure), is(java.lang.Object), any(), print(java.io.PrintWriter), any(groovy.lang.Closure)<br>playing …<br>groovy.lang.MissingMethodException: No signature of method: Person.sing() is applicable for argument types: () values: []<br>Possible solutions: find(), find(groovy.lang.Closure), is(java.lang.Object), any(), print(java.io.PrintWriter), any(groovy.lang.Closure)</p>
</blockquote>
<p>可以将方法注入到从具体事例获得的metaClass中</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>&#123;</span></div><div class="line">    <span class="keyword">def</span> play()&#123;</div><div class="line">        println <span class="string">"playing ..."</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> jack = <span class="keyword">new</span> Person()</div><div class="line"><span class="keyword">def</span> paul = <span class="keyword">new</span> Person()</div><div class="line"></div><div class="line">jack.metaClass.sing = &#123;</div><div class="line">    <span class="string">'oh baby baby...'</span></div><div class="line">&#125;</div><div class="line">println jack.sing()</div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    paul.sing()</div><div class="line">&#125;<span class="keyword">catch</span>(ex)&#123;</div><div class="line">    println ex</div><div class="line">&#125;</div><div class="line"></div><div class="line">jack.metaClass = <span class="literal">null</span></div><div class="line"></div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    jack.play()</div><div class="line">    jack.sing()</div><div class="line">&#125;<span class="keyword">catch</span>(ex)&#123;</div><div class="line">    println ex</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>oh baby baby…<br>groovy.lang.MissingMethodException: No signature of method: Person.sing() is applicable for argument types: () values: []<br>Possible solutions: find(), find(groovy.lang.Closure), is(java.lang.Object), any(), print(java.io.PrintWriter), any(groovy.lang.Closure)<br>playing …<br>groovy.lang.MissingMethodException: No signature of method: Person.sing() is applicable for argument types: () values: []<br>Possible solutions: find(), find(groovy.lang.Closure), is(java.lang.Object), any(), print(java.io.PrintWriter), any(groovy.lang.Closure)</p>
</blockquote>
<p>使用EMC DSL将方法分组，注入多个方法</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Persion</span>&#123;</span></div><div class="line">    <span class="keyword">def</span> play()&#123;</div><div class="line">        println <span class="string">"playing ..."</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> jack = <span class="keyword">new</span> Person()</div><div class="line"></div><div class="line">jack.metaClass&#123;</div><div class="line">    sing = &#123; -&gt;</div><div class="line">        <span class="string">'ho baby baby'</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    dance = &#123; -&gt;</div><div class="line">        <span class="string">'start the music...'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">println jack.sing()</div><div class="line">println jack.dance()</div></pre></td></tr></table></figure>
<blockquote>
<p>ho baby baby<br>start the music…</p>
</blockquote>
<h2 id="使用Mixin注入方法"><a href="#使用Mixin注入方法" class="headerlink" title="使用Mixin注入方法"></a>使用Mixin注入方法</h2><p>Groovy的Mixin是一种运行时能力，可以将多个类中的实现引入进来或混入。</p>
<p>调用方法时，Groovy先将调用路由到混入的类中，如果该方法不存在，再由主类处理。<br>可以将多个类混入到一个类中，后加入的Mixin优先级高。</p>
<h3 id="使用-Mixin注解语法注入"><a href="#使用-Mixin注解语法注入" class="headerlink" title="使用@Mixin注解语法注入"></a>使用@Mixin注解语法注入</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Friend</span> &#123;</span></div><div class="line">	<span class="keyword">def</span> listen()&#123;</div><div class="line">		<span class="string">"$name is listening as a friend"</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Mixin</span>(Friend)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></div><div class="line">	String firstName</div><div class="line">	String lastName</div><div class="line">	String getName()&#123;</div><div class="line">		<span class="string">"$firstName $lastName"</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">john = <span class="keyword">new</span> Person(<span class="string">firstName:</span><span class="string">"John"</span>,<span class="string">lastName:</span><span class="string">"Smith"</span>)</div><div class="line">println john.listen()</div></pre></td></tr></table></figure>
<blockquote>
<p>John Smith is listening as a friend</p>
</blockquote>
<p>使用注解混入多个类:@Mixin([Friend, Teacher])</p>
<h3 id="使用静态初试化器注入"><a href="#使用静态初试化器注入" class="headerlink" title="使用静态初试化器注入"></a>使用静态初试化器注入</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Friend</span> &#123;</span></div><div class="line">    <span class="keyword">def</span> listen()&#123;</div><div class="line">        <span class="string">"$name is listening as a friend"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></div><div class="line">	<span class="comment">//静态初试化器注入</span></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        mixin Friend</div><div class="line">    &#125;</div><div class="line">    String firstName</div><div class="line">    String lastName</div><div class="line">    String getName()&#123;</div><div class="line">        <span class="string">"$firstName $lastName"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">john = <span class="keyword">new</span> Person(<span class="string">firstName:</span><span class="string">"John"</span>,<span class="string">lastName:</span><span class="string">"Smith"</span>)</div><div class="line">println john.listen()</div></pre></td></tr></table></figure>
<blockquote>
<p>John Smith is listening as a friend</p>
</blockquote>
<p>注解注入和静态初试化器注入，只能由类的作者使用<br>没有类的源码或不想修改类的源码，就不能使用这种方式</p>
<h3 id="调用mixin-方法向Groovy和Java类中注入方法"><a href="#调用mixin-方法向Groovy和Java类中注入方法" class="headerlink" title="调用mixin()方法向Groovy和Java类中注入方法"></a>调用mixin()方法向Groovy和Java类中注入方法</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Friend</span> &#123;</span></div><div class="line">    <span class="keyword">def</span> listen()&#123;</div><div class="line">        <span class="string">"$name is listening as a friend"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span>&#123;</span></div><div class="line">    String name</div><div class="line">&#125;</div><div class="line"></div><div class="line">Dog.mixin Friend</div><div class="line"></div><div class="line">buddy = <span class="keyword">new</span> Dog(<span class="string">name:</span> <span class="string">"Buddy"</span>)</div><div class="line"></div><div class="line">println buddy.listen()</div></pre></td></tr></table></figure>
<blockquote>
<p>Buddy is listening as a friend</p>
</blockquote>
<h3 id="向类的实例中混入类"><a href="#向类的实例中混入类" class="headerlink" title="向类的实例中混入类"></a>向类的实例中混入类</h3><p>通过在实例的metaClass上调用mixin()方法</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Friend</span> &#123;</span></div><div class="line">	<span class="keyword">def</span> listen()&#123;</div><div class="line">		<span class="string">"$name is listening as a friend"</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span> &#123;</span></div><div class="line">	String name</div><div class="line">&#125;</div><div class="line"></div><div class="line">socks = <span class="keyword">new</span> Cat(<span class="string">name:</span><span class="string">"Socks"</span>)</div><div class="line">socks.metaClass.mixin Friend</div><div class="line">println socks.listen()</div></pre></td></tr></table></figure>
<blockquote>
<p>Socks is listening as a friend</p>
</blockquote>
<h3 id="类中使用多个Mixin"><a href="#类中使用多个Mixin" class="headerlink" title="类中使用多个Mixin"></a>类中使用多个Mixin</h3><p>当混入多个类时，所有这些类的方法在目标类中都是可用的</p>
<p>通过编程实现，可将这些方法以调用链条的方式链接起来</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Writer</span>&#123;</span></div><div class="line">	<span class="keyword">abstract</span> <span class="keyword">void</span> write(String message)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StringWriter</span> <span class="keyword">extends</span> <span class="title">Writer</span>&#123;</span></div><div class="line">	<span class="keyword">def</span> target = <span class="keyword">new</span> StringBuilder()</div><div class="line"></div><div class="line">	<span class="keyword">void</span> write(String message)&#123;</div><div class="line">		target.append(message)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	String toString()&#123;</div><div class="line">		target.toString()</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> writeStuff(writer)&#123;</div><div class="line">	writer.write(<span class="string">"This is stupid"</span>)</div><div class="line">	println writer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//通过create方法，向Writer中添加过滤器</span></div><div class="line"><span class="keyword">def</span> create(theWriter, Object [] filters = [])&#123;</div><div class="line">	<span class="keyword">def</span> instance = theWriter.newInstance()</div><div class="line">	filters.each &#123;filter -&gt;</div><div class="line">		instance.metaClass.mixin filter</div><div class="line">	&#125;</div><div class="line">	instance</div><div class="line">&#125;</div><div class="line"></div><div class="line">writeStuff(create(StringWriter))</div></pre></td></tr></table></figure>
<blockquote>
<p>This is stupid</p>
</blockquote>
<p>Groovy提供了一个名为mixedIn的属性，为实例保存有序的Mixin列表<br>添加的Mixin构成一个链条，通向被混入的目标实例</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Writer</span>&#123;</span></div><div class="line">    <span class="keyword">abstract</span> <span class="keyword">void</span> write(String message)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StringWriter</span> <span class="keyword">extends</span> <span class="title">Writer</span>&#123;</span></div><div class="line">    <span class="keyword">def</span> target = <span class="keyword">new</span> StringBuilder()</div><div class="line"></div><div class="line">    <span class="keyword">void</span> write(String message)&#123;</div><div class="line">        target.append(message)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    String toString()&#123;</div><div class="line">        target.toString()</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> writeStuff(writer)&#123;</div><div class="line">    writer.write(<span class="string">"This is stupid"</span>)</div><div class="line">    println writer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> create(theWriter, Object [] filters = [])&#123;</div><div class="line">    <span class="keyword">def</span> instance = theWriter.newInstance()</div><div class="line">    filters.each &#123;filter -&gt;</div><div class="line">        instance.metaClass.mixin filter</div><div class="line">    &#125;</div><div class="line">    instance</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//writeStuff(create(StringWriter))</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//将信息转为大写</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UppercaseFilter</span> &#123;</span></div><div class="line">    <span class="keyword">void</span> write(String message)&#123;</div><div class="line">        <span class="keyword">def</span> allUpper = message.toUpperCase()</div><div class="line"></div><div class="line">        <span class="comment">//处理后的数据传递给下一个处理器</span></div><div class="line">        invokeOnPreviousMixin(metaClass,<span class="string">"write"</span>,allUpper)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">Object.metaClass.invokeOnPreviousMixin = &#123;</div><div class="line">    MetaClass currentMixinMetaClass, String method, Object[] args -&gt;</div><div class="line">    <span class="comment">//目标实例</span></div><div class="line">    <span class="keyword">def</span> previousMixin = delegate.getClass()</div><div class="line">    <span class="comment">//遍历找到当前mixin前的mixin</span></div><div class="line">    <span class="keyword">for</span>(mixin <span class="keyword">in</span> mixedIn.mixinClasses)&#123;</div><div class="line">        <span class="keyword">if</span>(mixin.mixinClass.theClass == currentMixinMetaClass.delegate.theClass) <span class="keyword">break</span></div><div class="line">        previousMixin = mixin.mixinClass.theClass</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//调用前一个mixin中方法</span></div><div class="line">    mixedIn[previousMixin].<span class="string">"$method"</span>(*args)</div><div class="line">&#125;</div><div class="line"></div><div class="line">writeStuff(create(StringWriter,UppercaseFilter))</div></pre></td></tr></table></figure>
<blockquote>
<p>THIS IS STUPID</p>
</blockquote>
<p>添加脏词处理过滤器</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Writer</span>&#123;</span></div><div class="line">    <span class="keyword">abstract</span> <span class="keyword">void</span> write(String message)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StringWriter</span> <span class="keyword">extends</span> <span class="title">Writer</span>&#123;</span></div><div class="line">    <span class="keyword">def</span> target = <span class="keyword">new</span> StringBuilder()</div><div class="line"></div><div class="line">    <span class="keyword">void</span> write(String message)&#123;</div><div class="line">        target.append(message)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    String toString()&#123;</div><div class="line">        target.toString()</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> writeStuff(writer)&#123;</div><div class="line">    writer.write(<span class="string">"This is stupid"</span>)</div><div class="line">    println writer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> create(theWriter, Object [] filters = [])&#123;</div><div class="line">    <span class="keyword">def</span> instance = theWriter.newInstance()</div><div class="line">    filters.each &#123;filter -&gt;</div><div class="line">        instance.metaClass.mixin filter</div><div class="line">    &#125;</div><div class="line">    instance</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//writeStuff(create(StringWriter))</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UppercaseFilter</span> &#123;</span></div><div class="line">    <span class="keyword">void</span> write(String message)&#123;</div><div class="line">        <span class="keyword">def</span> allUpper = message.toUpperCase()</div><div class="line">        invokeOnPreviousMixin(metaClass,<span class="string">"write"</span>,allUpper)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">Object.metaClass.invokeOnPreviousMixin = &#123;</div><div class="line">    MetaClass currentMixinMetaClass, String method, Object[] args -&gt;</div><div class="line">    <span class="comment">//目标实例</span></div><div class="line">    <span class="keyword">def</span> previousMixin = delegate.getClass()</div><div class="line">    <span class="comment">//遍历找到当前mixin前的mixin</span></div><div class="line">    <span class="keyword">for</span>(mixin <span class="keyword">in</span> mixedIn.mixinClasses)&#123;</div><div class="line">        <span class="keyword">if</span>(mixin.mixinClass.theClass == currentMixinMetaClass.delegate.theClass) <span class="keyword">break</span></div><div class="line">        previousMixin = mixin.mixinClass.theClass</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//调用前一个mixin中方法</span></div><div class="line">    mixedIn[previousMixin].<span class="string">"$method"</span>(*args)</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//writeStuff(create(StringWriter,UppercaseFilter))</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//脏字处理过滤器</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProfanityFilter</span>&#123;</span></div><div class="line">    <span class="keyword">void</span> write(String message)&#123;</div><div class="line">        <span class="keyword">def</span> filtered = message.replaceAll(<span class="string">'stupid'</span>,<span class="string">'s*****'</span>)</div><div class="line">        invokeOnPreviousMixin(metaClass, <span class="string">'write'</span>, filtered)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">writeStuff(create(StringWriter,UppercaseFilter,ProfanityFilter)) </div><div class="line">writeStuff(create(StringWriter,ProfanityFilter,UppercaseFilter))</div></pre></td></tr></table></figure>
<blockquote>
<p>THIS IS S<strong>*</strong><br>THIS IS STUPID</p>
</blockquote>
<p>将Mixin链接起来实现扩展的设计，是装饰模式（Decorator Pattern）的一个实现</p>
<h1 id="MOP方法合成"><a href="#MOP方法合成" class="headerlink" title="MOP方法合成"></a>MOP方法合成</h1><p>方法注入：编写代码是知道想要添加到一个或多个类中的方法的名字<br>方法合成：调用时动态确定方法的行为</p>
<p>合成的方法可能直到调用时才会作为独立的方法存在<br>Grails创建者Graeme Rocher称其为“拦截、缓存、调用”模式</p>
<h2 id="使用methodMissing合成方法"><a href="#使用methodMissing合成方法" class="headerlink" title="使用methodMissing合成方法"></a>使用methodMissing合成方法</h2><p>通过methodMissing()拦截对不存在的方法的调用<br>通过propertyMissing()拦截对不存在属性的访问</p>
<p>基于定义的约定推断其语义，动态地为不存在的方法或属性实现相应逻辑</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>&#123;</span></div><div class="line">    <span class="keyword">def</span> work()&#123;</div><div class="line">        <span class="string">"working ..."</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">def</span> plays = [<span class="string">'Tennis'</span>,<span class="string">'VolleyBall'</span>,<span class="string">'BasketBall'</span>]</div><div class="line"></div><div class="line">    <span class="keyword">def</span> methodMissing(String name, args)&#123;</div><div class="line">        System.out.println <span class="string">"methodMissing called for $name"</span></div><div class="line">        <span class="keyword">def</span> methodInList = plays.find&#123; it == name.split(<span class="string">'play'</span>)[<span class="number">1</span>] &#125;</div><div class="line">        <span class="keyword">if</span>(methodInList)&#123;</div><div class="line">            <span class="string">"playing $&#123;name.split('play')[1]&#125; ..."</span></div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MissingMethodException(name, Person.<span class="keyword">class</span>, args)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">jack = <span class="keyword">new</span> Person()</div><div class="line"></div><div class="line">println jack.work()</div><div class="line">println jack.playTennis()</div><div class="line">println jack.playBasketBall()</div><div class="line">println jack.playVolleyBall()</div><div class="line">println jack.playTennis()</div><div class="line"></div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    println jack.playPolitics()</div><div class="line">&#125;<span class="keyword">catch</span>(ex)&#123;</div><div class="line">    println ex</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>working …<br>methodMissing called for playTennis<br>playing Tennis …<br>methodMissing called for playBasketBall<br>playing BasketBall …<br>methodMissing called for playVolleyBall<br>playing VolleyBall …<br>methodMissing called for playTennis<br>playing Tennis …<br>methodMissing called for playPolitics<br>groovy.lang.MissingMethodException: No signature of method: Person.playPolitics() is applicable for argument types: () values: []</p>
</blockquote>
<p>第一次调用时合成方法，将其注入到MetaClass中缓存下来，然后调用注入的方法</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>&#123;</span></div><div class="line">    <span class="keyword">def</span> work()&#123;</div><div class="line">        <span class="string">"working ..."</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">def</span> plays = [<span class="string">'Tennis'</span>,<span class="string">'VolleyBall'</span>,<span class="string">'BasketBall'</span>]</div><div class="line"></div><div class="line">    <span class="keyword">def</span> methodMissing(String name, args)&#123;</div><div class="line">        System.out.println <span class="string">"methodMissing called for $name"</span></div><div class="line">        <span class="keyword">def</span> methodInList = plays.find&#123; it == name.split(<span class="string">'play'</span>)[<span class="number">1</span>] &#125;</div><div class="line">        <span class="keyword">if</span>(methodInList)&#123;</div><div class="line">            <span class="keyword">def</span> impl = &#123;Object[] vargs -&gt;</div><div class="line">                <span class="string">"playing $&#123;name.split('play')[1]&#125;"</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//Person instance = this;</span></div><div class="line"></div><div class="line">            Person.metaClass.<span class="string">"$name"</span> = impl<span class="comment">//注入生成的方法</span></div><div class="line"></div><div class="line">            impl(args)<span class="comment">//调用生成的方法</span></div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MissingMethodException(name, Person.<span class="keyword">class</span>, args)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">jack = <span class="keyword">new</span> Person()</div><div class="line"></div><div class="line">println jack.work()</div><div class="line">println jack.playTennis()</div><div class="line">println jack.playBasketBall()</div><div class="line">println jack.playVolleyBall()</div><div class="line">println jack.playTennis()</div><div class="line"></div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    println jack.playPolitics()</div><div class="line">&#125;<span class="keyword">catch</span>(ex)&#123;</div><div class="line">    println ex</div><div class="line">&#125;</div><div class="line"></div><div class="line">sunday = <span class="keyword">new</span> Person()</div><div class="line">println sunday.playTennis()</div></pre></td></tr></table></figure>
<blockquote>
<p>working …<br>methodMissing called for playTennis<br>playing Tennis<br>methodMissing called for playBasketBall<br>playing BasketBall<br>methodMissing called for playVolleyBall<br>playing VolleyBall<br>methodMissing called for playTennis<br>playing Tennis<br>methodMissing called for playPolitics<br>groovy.lang.MissingMethodException: No signature of method: Person.playPolitics() is applicable for argument types: () values: []<br>playing Tennis</p>
</blockquote>
<h2 id="使用ExpandoMetaClass合成方法"><a href="#使用ExpandoMetaClass合成方法" class="headerlink" title="使用ExpandoMetaClass合成方法"></a>使用ExpandoMetaClass合成方法</h2><p>对于无权编辑类的源文件或并非POGO类，可以使用ExpandoMetaClass合成方法</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>&#123;</span></div><div class="line">    <span class="keyword">def</span> work()&#123;</div><div class="line">        <span class="string">"working ..."</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Person.metaClass.methodMissing = &#123;String name, args -&gt;</div><div class="line">    <span class="keyword">def</span> plays = [<span class="string">'Tennis'</span>,<span class="string">'VolleyBall'</span>,<span class="string">'BasketBall'</span>]</div><div class="line">    System.out.println <span class="string">"methodMissing called for $name"</span></div><div class="line">    <span class="keyword">def</span> methodInList = plays.find&#123; it == name.split(<span class="string">'play'</span>)[<span class="number">1</span>] &#125;</div><div class="line">    <span class="keyword">if</span>(methodInList)&#123;</div><div class="line">        <span class="keyword">def</span> impl = &#123;Object[] vargs -&gt;</div><div class="line">            <span class="string">"playing $&#123;name.split('play')[1]&#125;"</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Person.metaClass.<span class="string">"$name"</span> = impl<span class="comment">//注入生成的方法</span></div><div class="line"></div><div class="line">        impl(args)<span class="comment">//调用生成的方法</span></div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MissingMethodException(name, Person.<span class="keyword">class</span>, args)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">jack = <span class="keyword">new</span> Person()</div><div class="line"></div><div class="line">println jack.work()</div><div class="line">println jack.playTennis()</div><div class="line">println jack.playBasketBall()</div><div class="line">println jack.playVolleyBall()</div><div class="line">println jack.playTennis()</div><div class="line"></div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    println jack.playPolitics()</div><div class="line">&#125;<span class="keyword">catch</span>(ex)&#123;</div><div class="line">    println ex</div><div class="line">&#125;</div><div class="line"></div><div class="line">sunday = <span class="keyword">new</span> Person()</div><div class="line">println sunday.playTennis()</div></pre></td></tr></table></figure>
<blockquote>
<p>working …<br>methodMissing called for playTennis<br>playing Tennis<br>methodMissing called for playBasketBall<br>playing BasketBall<br>methodMissing called for playVolleyBall<br>playing VolleyBall<br>playing Tennis<br>methodMissing called for playPolitics<br>groovy.lang.MissingMethodException: No signature of method: Person.playPolitics() is applicable for argument types: () values: []<br>playing Tennis</p>
</blockquote>
<h2 id="为实例合成方法"><a href="#为实例合成方法" class="headerlink" title="为实例合成方法"></a>为实例合成方法</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></div><div class="line">    <span class="keyword">def</span> work()&#123;</div><div class="line">        <span class="string">"working ..."</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> emc = <span class="keyword">new</span> ExpandoMetaClass(Person)</div><div class="line">emc.methodMissing = &#123; String name, args -&gt;</div><div class="line">    <span class="string">"I'm Jack of all trades... I can $name"</span></div><div class="line">&#125;</div><div class="line">emc.initialize()</div><div class="line"></div><div class="line"><span class="keyword">def</span> jack = <span class="keyword">new</span> Person()</div><div class="line"><span class="keyword">def</span> paul = <span class="keyword">new</span> Person()</div><div class="line"></div><div class="line">jack.metaClass = emc</div><div class="line"></div><div class="line">println jack.sing()</div><div class="line">println jack.dance()</div><div class="line">println jack.juggle()</div><div class="line"></div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    paul.sing()</div><div class="line">&#125;<span class="keyword">catch</span>(ex)&#123;</div><div class="line">    println ex</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>I’m Jack of all trades… I can sing<br>I’m Jack of all trades… I can dance<br>I’m Jack of all trades… I can juggle<br>groovy.lang.MissingMethodException: No signature of method: Person.sing() is applicable for argument types: () values: []<br>Possible solutions: find(), find(groovy.lang.Closure), is(java.lang.Object), any(), print(java.io.PrintWriter), any(groovy.lang.Closure)</p>
</blockquote>
<h3 id="invokeMethod-与-methodMissing的对比"><a href="#invokeMethod-与-methodMissing的对比" class="headerlink" title="invokeMethod 与 methodMissing的对比"></a>invokeMethod 与 methodMissing的对比</h3><p>处理对不存在方法的调用，应该实现methodMissing()，因为它开销较低<br>拦截所有方法调用使用invokeMethod()</p>
<h2 id="invokeMethod-和methodMissing-调用顺序梳理"><a href="#invokeMethod-和methodMissing-调用顺序梳理" class="headerlink" title="invokeMethod()和methodMissing()调用顺序梳理"></a>invokeMethod()和methodMissing()调用顺序梳理</h2><h3 id="实现GroovyInterceptable接口POGO上invokeMethod-和methodMissing-调用顺序"><a href="#实现GroovyInterceptable接口POGO上invokeMethod-和methodMissing-调用顺序" class="headerlink" title="实现GroovyInterceptable接口POGO上invokeMethod()和methodMissing()调用顺序"></a>实现GroovyInterceptable接口POGO上invokeMethod()和methodMissing()调用顺序</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">GroovyInterceptable</span> &#123;</span></div><div class="line">	<span class="comment">//1</span></div><div class="line">    <span class="keyword">def</span> invokeMethod(String name, args)&#123;</div><div class="line">        System.out.println(<span class="string">"Call Method $name intercepted ..."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//4</span></div><div class="line">    <span class="keyword">def</span> methodMissing(String name,args)&#123;</div><div class="line">        System.out.println(<span class="string">"Call Missing Method $name intercepted ..."</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//2</span></div><div class="line">Person.metaClass.invokeMethod = &#123;String name,args -&gt;</div><div class="line">    println <span class="string">"Call Method $name intercepted By metaClass invokeMethod..."</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//3</span></div><div class="line">Person.metaClass.methodMissing = &#123;String name,args -&gt;</div><div class="line">    println <span class="string">"Call Missing $name intercepted By metaClass methodMissing..."</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">new</span> Person().getName()</div></pre></td></tr></table></figure>
<p>调用顺序：</p>
<ul>
<li>POGO上invokeMethod()</li>
<li>metaClass上invokeMethod()</li>
<li>metaClass上methodMissing()</li>
<li>POGO上methodMissing() </li>
</ul>
<p>因此，POGO方法的调用无法通过覆盖metaClass属性上invokeMethod()方法拦截<br>POGO上invokeMethod()对未实现的方法调用metaClass上invokeMethod()<br>metaClass上nvokeMethod()对未实现的方法调用invokeMissingMethod()</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">GroovyInterceptable</span> &#123;</span></div><div class="line">    <span class="keyword">void</span> getName()&#123;</div><div class="line">        System.out.println(<span class="string">'sunday'</span>)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">def</span> invokeMethod(String name, args)&#123;</div><div class="line">        System.out.println(<span class="string">"Call Method $name intercepted ..."</span>);</div><div class="line"><span class="comment">//        def validMethod = Person.metaClass.getMetaMethod(name);</span></div><div class="line"><span class="comment">//        if(validMethod != null)&#123;</span></div><div class="line"><span class="comment">//            validMethod.invoke(this, null)</span></div><div class="line"><span class="comment">//        &#125;else&#123;</span></div><div class="line"><span class="comment">//            Person.metaClass.invokeMethod(this, name, args)</span></div><div class="line"><span class="comment">//        &#125;</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">def</span> methodMissing(String name,args)&#123;</div><div class="line">        System.out.println(<span class="string">"Call Missing Method $name intercepted ..."</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Person.metaClass.invokeMethod = &#123;String name,args -&gt;</div><div class="line">    println <span class="string">"Call Method $name intercepted By metaClass invokeMethod..."</span></div><div class="line"><span class="comment">//    def validMethod = Person.metaClass.getMetaMethod(name);</span></div><div class="line"><span class="comment">//        if(validMethod != null)&#123;</span></div><div class="line"><span class="comment">//            validMethod.invoke(delegate, null)</span></div><div class="line"><span class="comment">//        &#125;else&#123;</span></div><div class="line"><span class="comment">//            Person.metaClass.invokeMissingMethod(delegate, name, args)</span></div><div class="line"><span class="comment">//        &#125;</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">Person.metaClass.methodMissing = &#123;String name,args -&gt;</div><div class="line">    println <span class="string">"Call Method $name intercepted By metaClass methodMissing..."</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">new</span> Person().getName()</div><div class="line"><span class="keyword">new</span> Person().getFirstName()</div></pre></td></tr></table></figure>
<blockquote>
<p>Call Method getName intercepted …<br>sunday<br>Call Method getFirstName intercepted …<br>Call Method getFirstName intercepted By metaClass invokeMethod…<br>Call Method getFirstName intercepted By metaClass methodMissing…</p>
</blockquote>
<h3 id="没有实现GroovyInterceptable接口POGO上invokeMethod-和methodMissing-调用顺序"><a href="#没有实现GroovyInterceptable接口POGO上invokeMethod-和methodMissing-调用顺序" class="headerlink" title="没有实现GroovyInterceptable接口POGO上invokeMethod()和methodMissing()调用顺序"></a>没有实现GroovyInterceptable接口POGO上invokeMethod()和methodMissing()调用顺序</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>&#123;</span></div><div class="line">    <span class="keyword">void</span> getName()&#123;</div><div class="line">        System.out.println(<span class="string">'sunday'</span>)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">def</span> invokeMethod(String name, args)&#123;</div><div class="line">        System.out.println(<span class="string">"Call Method $name intercepted ..."</span>);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">def</span> methodMissing(String name,args)&#123;</div><div class="line">        System.out.println(<span class="string">"Call Missing Method $name intercepted ..."</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Person.metaClass.invokeMethod = &#123;String name,args -&gt;</div><div class="line">    println <span class="string">"Call Method $name intercepted By metaClass invokeMethod..."</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">Person.metaClass.methodMissing = &#123;String name,args -&gt;</div><div class="line">    println <span class="string">"Call Method $name intercepted By metaClass methodMissing..."</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">new</span> Person().getName()</div><div class="line"><span class="keyword">new</span> Person().getFirstName()</div></pre></td></tr></table></figure>
<p>调用顺序：</p>
<ul>
<li>metaClass上invokeMethod()</li>
<li>metaClass上methodMissing()</li>
<li>POGO上methodMissing()</li>
<li>POGO上invokeMethod()</li>
</ul>
<p>其中metaClass上invokeMethod()会劫持所有方法调用，其他方法在方法不存在时才调用</p>
<h1 id="MOP技术汇总"><a href="#MOP技术汇总" class="headerlink" title="MOP技术汇总"></a>MOP技术汇总</h1><h2 id="使用Expando创建动态类"><a href="#使用Expando创建动态类" class="headerlink" title="使用Expando创建动态类"></a>使用Expando创建动态类</h2><p>Groovy中可以完全在运行时创建一个类</p>
<p>Groovy的Expando动态合成类，可在构建时使用一个Map为其制定属性和方法，也可动态地随时指定</p>
<p>使用Expando创建类的两种方式</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">carA = <span class="keyword">new</span> Expando()</div><div class="line">carB = <span class="keyword">new</span> Expando(<span class="string">year:</span> <span class="number">2012</span>, <span class="string">miles:</span><span class="number">0</span>)</div><div class="line"></div><div class="line">carA.year = <span class="number">2012</span></div><div class="line">carA.miles = <span class="number">10</span></div><div class="line"></div><div class="line">println <span class="string">"carA: "</span> + carA</div><div class="line">println <span class="string">"carB: "</span> + carB</div></pre></td></tr></table></figure>
<blockquote>
<p>carA: {year=2012, miles=10}<br>carB: {year=2012, miles=0}</p>
</blockquote>
<p>动态创建方法</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">carA = <span class="keyword">new</span> Expando(<span class="string">year:</span> <span class="number">2012</span>, <span class="string">miles:</span><span class="number">0</span>,<span class="string">turn:</span>&#123;println <span class="string">'turning...'</span>&#125;)</div><div class="line"></div><div class="line">carA.drive = &#123;</div><div class="line">    miles += <span class="number">10</span></div><div class="line">    println <span class="string">"$miles miles driven"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">carA.[<span class="string">'brand'</span>] = <span class="string">'audi'</span></div><div class="line"></div><div class="line">carA.drive()</div><div class="line">carA.turn()</div><div class="line">println carA</div></pre></td></tr></table></figure>
<blockquote>
<p>40 miles driven<br>turning…<br>{year=2012, miles=0, turn=ConsoleScript74$_run_closure1@79aba442, drive=ConsoleScript74$_run_closure2@44915e6e, brand=audi}</p>
</blockquote>
<p>在运行时合成类，可以使用Expando。它是轻量级的，而且非常灵活<br>单元测试创建模拟（Mock）对象时，该特性会大放光彩</p>
<h2 id="方法委托"><a href="#方法委托" class="headerlink" title="方法委托"></a>方法委托</h2><p>继承关系保留给is-a或kind-of关系；大多数情况，应该首选委托</p>
<h2 id="Groovy通过MOP轻松实现委托"><a href="#Groovy通过MOP轻松实现委托" class="headerlink" title="Groovy通过MOP轻松实现委托"></a>Groovy通过MOP轻松实现委托</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker</span>&#123;</span></div><div class="line">	<span class="keyword">def</span> simpleWork1(spec)&#123;</div><div class="line">		println <span class="string">"worker does work1 with spec $spec"</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">def</span> simpleWork2()&#123;</div><div class="line">		println <span class="string">"worker does work2"</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Expert</span> &#123;</span></div><div class="line">	<span class="keyword">def</span> advancedWork1(spec)&#123;</div><div class="line">		println <span class="string">"Expert does work1 with spec $spec"</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">def</span> advancedWork2(scope, spec)&#123;</div><div class="line">		println <span class="string">"Expert does work2 with scope $scope spec $spec"</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Manager</span> &#123;</span></div><div class="line">	<span class="keyword">def</span> worker = <span class="keyword">new</span> Worker()</div><div class="line">	<span class="keyword">def</span> expert = <span class="keyword">new</span> Expert()</div><div class="line">	<span class="keyword">def</span> schedule() &#123; println <span class="string">"Schedule ..."</span>&#125;</div><div class="line">	<span class="keyword">def</span> methodMissing(String name, args)&#123;</div><div class="line">		println <span class="string">"intercepting call to $name ..."</span></div><div class="line">		<span class="keyword">def</span> delegateTo = <span class="literal">null</span></div><div class="line"></div><div class="line">		<span class="keyword">if</span>(name =~ <span class="regexp">/^simple/</span>)&#123; delegateTo = worker &#125;</div><div class="line">		<span class="keyword">if</span>(name =~ <span class="regexp">/^advanced/</span>)&#123; delegateTo = expert &#125;</div><div class="line">		<span class="comment">//检查委托方法是否存在</span></div><div class="line">		<span class="keyword">if</span>(delegateTo.metaClass.respondsTo(delegateTo, name, args))&#123;</div><div class="line">			Manager instance = <span class="keyword">this</span></div><div class="line">			<span class="comment">//委托方法注入当前实例</span></div><div class="line">			instance.metaClass.<span class="string">"$name"</span> = &#123; Object[] varArgs -&gt;</div><div class="line">				<span class="comment">//调用委托方法</span></div><div class="line">				delegateTo.invokeMethod(name, varArgs)</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			delegateTo.invokeMethod(name,args)</div><div class="line">		&#125;<span class="keyword">else</span>&#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> MissingMethodException(name, Manager.<span class="keyword">class</span>, args)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">peter = <span class="keyword">new</span> Manager()</div><div class="line">peter.schedule()</div><div class="line">peter.simpleWork1(<span class="string">'fast'</span>)</div><div class="line">peter.simpleWork1(<span class="string">'quality'</span>)</div><div class="line"></div><div class="line">peter.simpleWork2()</div><div class="line">peter.simpleWork2()</div><div class="line"></div><div class="line">peter.advancedWork1(<span class="string">'fast'</span>)</div><div class="line">peter.advancedWork1(<span class="string">'quality'</span>)</div><div class="line"></div><div class="line">peter.advancedWork2(<span class="string">'prototype'</span>, <span class="string">'fast'</span>)</div><div class="line">peter.advancedWork2(<span class="string">'product'</span>, <span class="string">'quality'</span>)</div><div class="line"></div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">	peter.simpleWork3()</div><div class="line">&#125;<span class="keyword">catch</span>(Exception ex)&#123;</div><div class="line">	println ex</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Schedule …<br>intercepting call to simpleWork1 …<br>worker does work1 with spec fast<br>worker does work1 with spec quality<br>intercepting call to simpleWork2 …<br>worker does work2<br>worker does work2<br>intercepting call to advancedWork1 …<br>Expert does work1 with spec fast<br>Expert does work1 with spec quality<br>intercepting call to advancedWork2 …<br>Expert does work2 with scope prototype spec fast<br>Expert does work2 with scope product spec quality<br>intercepting call to simpleWork3 …<br>groovy.lang.MissingMethodException: No signature of method: Manager.simpleWork3() is applicable for argument types: () values: []</p>
</blockquote>
<p>使用初试化块重构实现委托代码</p>
<p>重构之后代码结构</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Manager</span> &#123;</span></div><div class="line">	&#123; delegateCallsTo Worker, Expert&#125;</div><div class="line"></div><div class="line">	<span class="keyword">def</span> schedule() &#123; println <span class="string">"Schedule ..."</span>&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//委托工具方法</span></div><div class="line">Object.metaClass.delegateCallsTo = &#123; Class... klassOfDelegates -&gt;</div><div class="line">	<span class="comment">//初试化委托列表</span></div><div class="line">	<span class="keyword">def</span> objectOfDelegates = klassOfDelegates.collect&#123; it.newInstance() &#125;</div><div class="line">	delegate.metaClass.methodMissing = &#123; String name, args -&gt;</div><div class="line">		println <span class="string">"intercepting call to $name..."</span></div><div class="line"></div><div class="line">		<span class="comment">//查找委托方法</span></div><div class="line">		<span class="keyword">def</span> delegateTo = objectOfDelegates.find &#123;</div><div class="line">			it.metaClass.respondsTo(it, name, args)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(delegateTo)&#123;</div><div class="line">			<span class="comment">//注入委托方法</span></div><div class="line">			delegate.metaClass.<span class="string">"$&#123;name&#125;"</span> = &#123; Object[] varArgs -&gt;</div><div class="line">				delegateTo.invokeMethod(name, varArgs)</div><div class="line">			&#125;</div><div class="line">			<span class="comment">//调用委托方法</span></div><div class="line">			delegateTo.invokeMethod(name, args)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> MissingMethodException(name, delegate.getClass(), args)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">peter = <span class="keyword">new</span> Manager()</div><div class="line">peter.schedule()</div><div class="line">peter.simpleWork1(<span class="string">'fast'</span>)</div><div class="line">peter.simpleWork1(<span class="string">'quality'</span>)</div><div class="line"></div><div class="line">peter.simpleWork2()</div><div class="line">peter.simpleWork2()</div><div class="line"></div><div class="line">peter.advancedWork1(<span class="string">'fast'</span>)</div><div class="line">peter.advancedWork1(<span class="string">'quality'</span>)</div><div class="line"></div><div class="line">peter.advancedWork2(<span class="string">'prototype'</span>, <span class="string">'fast'</span>)</div><div class="line">peter.advancedWork2(<span class="string">'product'</span>, <span class="string">'quality'</span>)</div><div class="line"></div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    peter.simpleWork3()</div><div class="line">&#125;<span class="keyword">catch</span>(Exception ex)&#123;</div><div class="line">    println ex</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Schedule …<br>intercepting call to simpleWork1…<br>worker does work1 with spec fast<br>worker does work1 with spec quality<br>intercepting call to simpleWork2…<br>worker does work2<br>worker does work2<br>intercepting call to advancedWork1…<br>Expert does work1 with spec fast<br>Expert does work1 with spec quality<br>intercepting call to advancedWork2…<br>Expert does work2 with scope prototype spec fast<br>Expert does work2 with scope product spec quality<br>intercepting call to simpleWork3…<br>groovy.lang.MissingMethodException: No signature of method: Manager.simpleWork3() is applicable for argument types: () values: []</p>
</blockquote>
<p>先添加的委托类先调用</p>
<h2 id="Groovy使用-Delegate注解实现静态委托"><a href="#Groovy使用-Delegate注解实现静态委托" class="headerlink" title="Groovy使用@Delegate注解实现静态委托"></a>Groovy使用@Delegate注解实现静态委托</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker</span> &#123;</span></div><div class="line">	<span class="keyword">def</span> work()&#123;</div><div class="line">		println <span class="string">'get work done'</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">def</span> analyze()&#123;</div><div class="line">		println <span class="string">'analyze...'</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">def</span> writeReport()&#123;</div><div class="line">		println <span class="string">'get report written'</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Expert</span> &#123;</span></div><div class="line">	<span class="keyword">def</span> analyze()&#123;</div><div class="line">		println <span class="string">"expert analysis..."</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Manager</span> &#123;</span></div><div class="line">	<span class="meta">@Delegate</span> Expert expert = <span class="keyword">new</span> Expert()</div><div class="line">	<span class="meta">@Delegate</span> Worker worker = <span class="keyword">new</span> Worker()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> bernie = <span class="keyword">new</span> Manager()</div><div class="line">bernie.analyze()</div><div class="line">bernie.writeReport()</div></pre></td></tr></table></figure>
<blockquote>
<p>expert analysis…<br>get report written</p>
</blockquote>
<p>委托类中的同名方法，后引入进来的同名方法，被忽略</p>
<h1 id="应用编译时元编程"><a href="#应用编译时元编程" class="headerlink" title="应用编译时元编程"></a>应用编译时元编程</h1><p>现在主要是框架或工具的编写者使用<br>在编译时分析和修改程序结构<br>编译时元编程，正是某些强大的特性和基于Groovy的工具背后的魔力所在</p>
<p>使用编译时元编程分析代码结构、拦截方法及注入行为</p>
<p>#Groovy生成器</p>
<h2 id="构建XML"><a href="#构建XML" class="headerlink" title="构建XML"></a>构建XML</h2><p>Groovy几乎使处理XML变成一种乐趣</p>
<p>调用的不存在的方法，假定是子元素的名字<br>调用方法传递的Map参数（如language(name: value)）,当作元素的属性<br>当个参数，（如author(value)），表示元素内容</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">writer = new StringWriter()</div><div class="line"></div><div class="line">bldr = new groovy.xml.MarkupBuilder(writer)</div><div class="line">bldr.languages &#123;</div><div class="line">    language(name:'C++')&#123; author('Stroustrup')&#125;</div><div class="line">    language(name:'Java')&#123; author('Gosling') &#125;</div><div class="line">    language(name:'List')&#123; author('McCarthy') &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">println writer</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">languages</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">language</span> <span class="attr">name</span>=<span class="string">'C++'</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">author</span>&gt;</span>Stroustrup<span class="tag">&lt;/<span class="name">author</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">language</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">language</span> <span class="attr">name</span>=<span class="string">'Java'</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">author</span>&gt;</span>Gosling<span class="tag">&lt;/<span class="name">author</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">language</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">language</span> <span class="attr">name</span>=<span class="string">'List'</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">author</span>&gt;</span>McCarthy<span class="tag">&lt;/<span class="name">author</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">language</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">languages</span>&gt;</span></div></pre></td></tr></table></figure>
<p>MarkupBuilder适合小到中性文档。<br>文档非常大时（若干兆），可以使用StreamingMarkupBuilder</p>
<h2 id="构建JSON"><a href="#构建JSON" class="headerlink" title="构建JSON"></a>构建JSON</h2><p>只需将实例发送给groovy.json.JsonBuilder的构造器<br>调用writeTo()方法，可将生成的JSON格式写入到一个Writer中</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></div><div class="line">    String first</div><div class="line">    String last</div><div class="line">    <span class="keyword">def</span> sigs</div><div class="line">    <span class="keyword">def</span> tools</div><div class="line">&#125;</div><div class="line"></div><div class="line">john = <span class="keyword">new</span> Person(<span class="string">first:</span><span class="string">"John"</span>, <span class="string">last:</span><span class="string">"Smith"</span>, <span class="string">sigs:</span>[<span class="string">'Java'</span>,<span class="string">'Groovy'</span>], <span class="string">tools:</span> [<span class="string">'script'</span>:<span class="string">'Groovy'</span>, <span class="string">'test'</span>: <span class="string">'Spock'</span>])</div><div class="line">bldr = <span class="keyword">new</span> groovy.json.JsonBuilder(john)</div><div class="line">writer = <span class="keyword">new</span> StringWriter()</div><div class="line">bldr.writeTo(writer)</div><div class="line">println writer</div></pre></td></tr></table></figure>
<blockquote>
<p>{“first”:”John”,”last”:”Smith”,”tools”:{“script”:”Groovy”,”test”:”Spock”},”sigs”:[“Java”,”Groovy”]}</p>
</blockquote>
<p>自定义输出格式</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">john = <span class="keyword">new</span> Person(<span class="string">first:</span><span class="string">"John"</span>, <span class="string">last:</span><span class="string">"Smith"</span>, <span class="string">sigs:</span>[<span class="string">'Java'</span>,<span class="string">'Groovy'</span>], <span class="string">tools:</span> [<span class="string">'script'</span>:<span class="string">'Groovy'</span>, <span class="string">'test'</span>: <span class="string">'Spock'</span>])</div><div class="line">bldr = <span class="keyword">new</span> groovy.json.JsonBuilder()</div><div class="line">bldr &#123;</div><div class="line">    firstName john.first</div><div class="line">    lastName john.last</div><div class="line">    <span class="string">"special interest groups"</span> john.sigs</div><div class="line">    <span class="string">"preferred tools"</span> &#123;</div><div class="line">        numberOfTools john.tools.size()</div><div class="line">        tools john.tools</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">writer = <span class="keyword">new</span> StringWriter()</div><div class="line">bldr.writeTo(writer)</div><div class="line">println writer</div></pre></td></tr></table></figure>
<blockquote>
<p>{“firstName”:”John”,”lastName”:”Smith”,”special interest groups”:[“Java”,”Groovy”],”preferred tools”:{“numberOfTools”:2,”tools”:{“script”:”Groovy”,”test”:”Spock”}}}</p>
</blockquote>
<p>创建时就将JSON变为流，可以使用StreamingJsonBuilder代替JsonBuilder</p>
<h2 id="解析JSON"><a href="#解析JSON" class="headerlink" title="解析JSON"></a>解析JSON</h2><p>利用Groovy提供的JsonSlurper，从JSON数据创建HashMap<br>parseText()读取包含在String中的JSON数据<br>parse()从Reader或文件中读取JSON数据</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> sluper = <span class="keyword">new</span> groovy.json.JsonSlurper()</div><div class="line"><span class="comment">//def person = sluper.parse(new FileReader('C:\\Users\\wangdz\\Desktop\\person.json'))</span></div><div class="line"><span class="keyword">def</span> person = sluper.parseText(<span class="string">'&#123;"first":"John","last":"Smith","tools":&#123;"script":"Groovy","test":"Spock"&#125;,"sigs":["Java","Groovy"]&#125;'</span>)</div><div class="line"></div><div class="line">println <span class="string">"$person.first $person.last is interested in $&#123;person.sigs.join(', ')&#125;"</span></div></pre></td></tr></table></figure>
<blockquote>
<p>John Smith is interested in Java, Groovy</p>
</blockquote>
<h2 id="构建Swing应用"><a href="#构建Swing应用" class="headerlink" title="构建Swing应用"></a>构建Swing应用</h2><p>Groovy为创建Swing应用提供了一个生成器。</p>
<p>如果要创建任何较大型的Swing应用，建议研究下Griffon项目。<br>Griffon是构建于Groovy之上的框架，使用“约定优于配置”的原则创建Swing应用。<br>它不仅减轻了创建GUI的痛苦，还可以跨多个线程正确地处理事件。</p>
<h2 id="使用元编程定制器"><a href="#使用元编程定制器" class="headerlink" title="使用元编程定制器"></a>使用元编程定制器</h2><p>定制生成器有两种方式：</p>
<ul>
<li>利用Groovy元编程能力，一切自己来</li>
<li>使用Groovy提供的BuilderSupport或FactoryBuilderSupport </li>
</ul>
<h1 id="单元测试和模拟"><a href="#单元测试和模拟" class="headerlink" title="单元测试和模拟"></a>单元测试和模拟</h1><p>单元测试对于元编程至关重要<br>但元测试类似对软件进行锻炼，能够改进代码的健康度</p>
<h2 id="对Java和Groovy代码执行单元测试"><a href="#对Java和Groovy代码执行单元测试" class="headerlink" title="对Java和Groovy代码执行单元测试"></a>对Java和Groovy代码执行单元测试</h2><p>单元测试必须满足FAIR条件</p>
<ul>
<li>快速（fast）</li>
<li>自动化（automated）</li>
<li>隔离（isolated）</li>
<li>可重复（repeatable）</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListTest</span> <span class="keyword">extends</span> <span class="title">GroovyTestCase</span> &#123;</span></div><div class="line">	<span class="keyword">void</span> testListSize()&#123;</div><div class="line">		<span class="keyword">def</span> lst = [<span class="number">1</span> , <span class="number">2</span>]</div><div class="line">		assertEquals <span class="string">"ArrayList size must be 2"</span>, <span class="number">2</span>, lst.size()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>.<br>Time: 0<br>OK (1 test)</p>
</blockquote>
<p>Groovy内置了JUnit,可以使用JUnit中的任何assert方法<br>Groovy添加了更多assert方法<br>如：assertArrayEquals()、assertLength()、assertContains()、assertToString()、assertInspect()、assertScript()和shouldFail()等</p>
<p>编写单元测试时，考虑编写3种类型测试：正面测试、负面测试和异常测试</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
            <tag> Groovy </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Gradle Note]]></title>
      <url>http://xiaozhuang.github.io/2016/07/30/gradle-note/</url>
      <content type="html"><![CDATA[<p>Gradle 是java软件开发中的自动化构建工具，类似于传统工具如Ant和Maven。<br>Gradle吸收或沿用了Maven中比较成功的一些实践，但相对Maven和Ant又有极强的扩展。<br><a id="more"></a></p>
<h1 id="开始使用Gradle"><a href="#开始使用Gradle" class="headerlink" title="开始使用Gradle"></a>开始使用Gradle</h1><p>Gradle构建脚本的<br>在shell中执行gradle命令时，Gradle会寻找名为build.gradle的文件</p>
<p>构建脚本</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">task helloWord&#123;</div><div class="line">	<span class="comment">//最后执行</span></div><div class="line">	doLast&#123;</div><div class="line">		println <span class="string">'Hello world!'</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gradle -q helloWord</div></pre></td></tr></table></figure>
<h2 id="使用左移符号简单代表doLast"><a href="#使用左移符号简单代表doLast" class="headerlink" title="使用左移符号简单代表doLast"></a>使用左移符号简单代表doLast</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">task helloWord &lt;&lt; &#123;</div><div class="line">	println <span class="string">'Hello world!'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="动态任务定义和任务链"><a href="#动态任务定义和任务链" class="headerlink" title="动态任务定义和任务链"></a>动态任务定义和任务链</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">task startSession &lt;&lt; &#123;</div><div class="line">	chant();</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">def</span> chant() &#123;</div><div class="line">	<span class="comment">//能够直接访问ant任务</span></div><div class="line">	ant.echo(<span class="string">message:</span><span class="string">'Repeat after me...'</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//动态创建3个任务</span></div><div class="line"><span class="number">3.</span>times &#123;</div><div class="line">	<span class="comment">//Groovy自动地暴露一个隐式变量it来指定循环迭代的次数</span></div><div class="line">	task <span class="string">"yayGradle$it"</span> &lt;&lt; &#123;</div><div class="line">		println <span class="string">'Gradle rocks'</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//任务依赖</span></div><div class="line">yayGradle0.dependsOn startSession</div><div class="line">yayGradle2.dependsOn yayGradle1,yayGradle0</div><div class="line">task groupTherapy(<span class="string">dependsOn:</span>yayGradle2)</div></pre></td></tr></table></figure>
<p>运行脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gradle groupTherapy</div></pre></td></tr></table></figure>
<h2 id="列出项目中所有可用的task"><a href="#列出项目中所有可用的task" class="headerlink" title="列出项目中所有可用的task"></a>列出项目中所有可用的task</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">gradle -q task</div><div class="line"></div><div class="line"><span class="comment">#显示依赖任务</span></div><div class="line">gradle -q tasks --all</div></pre></td></tr></table></figure>
<h2 id="任务执行"><a href="#任务执行" class="headerlink" title="任务执行"></a>任务执行</h2><p>一次执行多个任务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gradle yayGradle0 groupTherapy</div></pre></td></tr></table></figure>
<p>任务通常只会执行一次，无论它们在命令行中指定还是作为另一个任务的依赖</p>
<h3 id="任务名缩写"><a href="#任务名缩写" class="headerlink" title="任务名缩写"></a>任务名缩写</h3><p>Gradle能够以驼峰式的缩写在命令行上运行任务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gradle gT</div></pre></td></tr></table></figure>
<p>任务名的缩写必须是唯一的，Gradle才能找到相应的任务</p>
<h3 id="在执行时排除一个任务"><a href="#在执行时排除一个任务" class="headerlink" title="在执行时排除一个任务"></a>在执行时排除一个任务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gradle groupTherapy -x yayGradle0</div></pre></td></tr></table></figure>
<p>Gradle排除的任务yayGradle0和它的依赖任务startSession，这个概念叫做智能排除。</p>
<h3 id="命令行选项"><a href="#命令行选项" class="headerlink" title="命令行选项"></a>命令行选项</h3><p>简单示例<br>将日志级别改变到INFO</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gradle groupTherapy -i</div></pre></td></tr></table></figure>
<p>发生错误时打印堆栈信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gradle groupTherapy -s</div></pre></td></tr></table></figure>
<p>组合使用多个选项<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">gradle groupTherapy -is</div><div class="line"></div><div class="line">gradle groupTherapy -i<span class="_">-s</span></div></pre></td></tr></table></figure></p>
<h4 id="重要选项"><a href="#重要选项" class="headerlink" title="重要选项"></a>重要选项</h4><p>-?,h,–help:打印所有可用的命令行选项，包含描述信息<br>-b,–build-file:指定构建脚本文件，默认构建脚本文件为build.gradle<br>–offline:以离线模式运行构建，仅在本地缓存中检查依赖是否存在</p>
<h4 id="参数选项"><a href="#参数选项" class="headerlink" title="参数选项"></a>参数选项</h4><p>-D,–system-prop:JVM参数，Gradle是以一个JVM进程运行的<br>-P,–project-prop:项目参数，是构建脚本中可用的变量</p>
<h4 id="日志选项"><a href="#日志选项" class="headerlink" title="日志选项"></a>日志选项</h4><p>-i,–info:默认设置下Gradle构建不会输出大量信息，通过将Gradle的日志级别改变到INFO以获得更多信息。<br>-s,–stacktrace:在有异常抛出时打印堆栈信息<br>-q,–quiet:减少构建出错时打印出的错误日志</p>
<h4 id="帮助任务"><a href="#帮助任务" class="headerlink" title="帮助任务"></a>帮助任务</h4><p>tasks:显示项目中所有可运行的task，包含描述信息。项目中应用的插件可能会提供一些额外的task。<br>properties:显示项目中所用可用属性。某些属性由Gradle的project对象提供，其他属性都由用户定义。</p>
<h3 id="Gradle守护进程"><a href="#Gradle守护进程" class="headerlink" title="Gradle守护进程"></a>Gradle守护进程</h3><p>守护进程已后台运行方式运行Gradle。一旦启动，gradle命令就会在后续构建中重用之前创建的守护进程，以避免启动时造成的开销。</p>
<p>启动方式：添加 –daemon选项，如：gradle groupTherapy –daemon</p>
<p>守护进程只会被创建一次</p>
<p>守护进程会在3小时空闲时间后自动过期</p>
<p>执行构建时不使用守护进程：–no-daemon</p>
<p>手动停止守护进程：gradle –stop</p>
<h1 id="通过范例学习构建Gradle项目"><a href="#通过范例学习构建Gradle项目" class="headerlink" title="通过范例学习构建Gradle项目"></a>通过范例学习构建Gradle项目</h1><h2 id="初始化java项目"><a href="#初始化java项目" class="headerlink" title="初始化java项目"></a>初始化java项目</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">gradle init --<span class="built_in">type</span> java-library --<span class="built_in">test</span>-framework spock</div><div class="line"></div><div class="line">gradle init --<span class="built_in">type</span> java-library --<span class="built_in">test</span>-framework testng</div></pre></td></tr></table></figure>
<h2 id="构建项目"><a href="#构建项目" class="headerlink" title="构建项目"></a>构建项目</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gradle build</div></pre></td></tr></table></figure>
<p>构建过程中标记为UP-TO-DATE的消息，表示跳过的任务。Gradle的增量式构建支持自动鉴别不需要被运行的任务。</p>
<h2 id="定制项目"><a href="#定制项目" class="headerlink" title="定制项目"></a>定制项目</h2><h3 id="定制项目结构"><a href="#定制项目结构" class="headerlink" title="定制项目结构"></a>定制项目结构</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//修改目录结构</span></div><div class="line">sourceSets&#123;</div><div class="line">	main&#123;</div><div class="line">		java &#123;</div><div class="line">			srcDirs = [<span class="string">'src'</span>]</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	test&#123;</div><div class="line">		java&#123;</div><div class="line">			srcDirs = [<span class="string">'test'</span>]</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//编译目录</span></div><div class="line">buildDir = <span class="string">'out'</span></div><div class="line"></div><div class="line"><span class="comment">//设置编译版本</span></div><div class="line">sourceCompatibility = <span class="number">1.7</span></div><div class="line"></div><div class="line"><span class="comment">//指定入口函数</span></div><div class="line">jar &#123;</div><div class="line">	manifest &#123;</div><div class="line">		attributes <span class="string">'Main-Class'</span>:<span class="string">'com.sunday.to_do.App'</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="配置和使用外部依赖"><a href="#配置和使用外部依赖" class="headerlink" title="配置和使用外部依赖"></a>配置和使用外部依赖</h2><h3 id="定义仓库"><a href="#定义仓库" class="headerlink" title="定义仓库"></a>定义仓库</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">repositories &#123;</div><div class="line">    <span class="comment">// Use 'jcenter' for resolving your dependencies.</span></div><div class="line">    <span class="comment">// You can declare any Maven/Ivy/file repository here.</span></div><div class="line"></div><div class="line">    <span class="comment">//使用mavenLocal()配置maven的本地仓库后</span></div><div class="line">    <span class="comment">//gradle默认会按以下顺序去查找本地的仓库：USER_HOME/.m2/settings.xml &gt;&gt; M2_HOME/conf/settings.xml &gt;&gt; USER_HOME/.m2/repository</span></div><div class="line">    mavenLocal()</div><div class="line">    </div><div class="line">    jcenter()</div><div class="line"></div><div class="line">    <span class="comment">//Maven</span></div><div class="line">    <span class="comment">//mavenCentral()</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="设置Gradle的JVM选项信息"><a href="#设置Gradle的JVM选项信息" class="headerlink" title="设置Gradle的JVM选项信息"></a>设置Gradle的JVM选项信息</h2><p>使用环境变量GRADLE_OPTS<br>如设置最大堆内存：GRADLE_OPTS=”-Xmx1024m”</p>
<p>更好的方式是将变量添加到$GRADLE_HOME/bin目录下的Gradle启动脚本中。</p>
<h2 id="设置项目编码"><a href="#设置项目编码" class="headerlink" title="设置项目编码"></a>设置项目编码</h2><p>compileJava.options.encoding = ‘UTF-8’</p>
<h2 id="Gradle-做Web开发"><a href="#Gradle-做Web开发" class="headerlink" title="Gradle 做Web开发"></a>Gradle 做Web开发</h2><h3 id="添加web组件"><a href="#添加web组件" class="headerlink" title="添加web组件"></a>添加web组件</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//将java插件换成war组件</span></div><div class="line"><span class="comment">//war 插件扩展自java插件，不需要在构建脚本中应用java插件</span></div><div class="line">apply <span class="string">plugin:</span> <span class="string">'war'</span></div><div class="line"></div><div class="line"><span class="comment">//在dependencies中，添加web需要的依赖</span></div><div class="line"><span class="comment">//编译时需要，但由运行时提供</span></div><div class="line">providedCompile <span class="string">'javax.servlet:servlet-api:2.5'</span></div><div class="line"><span class="comment">//编译时不需要，但运行时需要，会成为war文件的一部分</span></div><div class="line">runtime <span class="string">'javax.servlet:jstl:1.1.2'</span></div></pre></td></tr></table></figure>
<p>Web应用默认约定的源代码目录是src/main/webapp</p>
<p>定制war插件目录，参考War插件DSL指南</p>
<h3 id="使用jetty插件运行项目"><a href="#使用jetty插件运行项目" class="headerlink" title="使用jetty插件运行项目"></a>使用jetty插件运行项目</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">apply <span class="string">plugin:</span> <span class="string">'jetty'</span></div><div class="line"></div><div class="line"><span class="comment">//jerry运行参数，默认contextPath项目名，端口：8080</span></div><div class="line">jettyRun &#123;</div><div class="line">    httpPort = <span class="number">9090</span></div><div class="line">    contextPath = <span class="string">'todo'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用jetty运行项目：gradle jettyRun</p>
<h1 id="构建脚本概要"><a href="#构建脚本概要" class="headerlink" title="构建脚本概要"></a>构建脚本概要</h1><h1 id="构建块"><a href="#构建块" class="headerlink" title="构建块"></a>构建块</h1><p>每个构建包含至少一个project，进而又包含一个或多个task。<br>projcet和task暴露的属性可以用来控制构建</p>
<h2 id="项目"><a href="#项目" class="headerlink" title="项目"></a>项目</h2><p>项目（project）代表一个正在构建的组件（比如一个jar文件）或一个想要完成的目标（如部署应用程序）</p>
<p>当访问属性和方法时，不需要使用project变量————它假设你是指Projcet实例</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">setDescription(<span class="string">"myProject"</span>)		<span class="comment">//不显示使用project变量设置项目描述</span></div><div class="line">println <span class="string">"Description of project $name: "</span> + project.description 		<span class="comment">//访问project属性</span></div></pre></td></tr></table></figure>
<h2 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h2><p>task的功能：任务动作(task action)和任务依赖(task dependency)</p>
<p>task可以定义依赖于其他Task、动作序列和执行条件</p>
<h2 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h2><p>每个project和task实例都提供了可以通过getter和setter方法访问的属性</p>
<h3 id="扩展属性"><a href="#扩展属性" class="headerlink" title="扩展属性"></a>扩展属性</h3><p>Gradle允许用户通过扩展属性自定义变量（以键值对形式存储）</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//只在初始化时需要使用ext命名空间</span></div><div class="line">project.ext.myProp = <span class="string">'myValue'</span></div><div class="line"></div><div class="line">ext&#123;</div><div class="line">	someOtherProp = <span class="number">123</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//访问扩展属性</span></div><div class="line"><span class="keyword">assert</span> myProp == <span class="string">'myValue'</span></div><div class="line">println project.someOtherProp</div></pre></td></tr></table></figure>
<h3 id="Gradle属性"><a href="#Gradle属性" class="headerlink" title="Gradle属性"></a>Gradle属性</h3><p>Gradle属性可以通过在gradle.properties文件中声明<br>这个文件位于<code>&lt;USER_HOME&gt;/.gradle目录</code>或<code>项目的根目录</code>下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#定义</div><div class="line">exampleProp=myProp</div></pre></td></tr></table></figure>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//访问</span></div><div class="line">println <span class="string">"exampleProp is $exampleProp"</span></div></pre></td></tr></table></figure>
<blockquote>
<p>试验中，项目根目录下的gradle.properties文件中配置的属性可以访问，</p>
<p><user_home>/.gradle目录下gradle.properties文件中配置的属性访问不到</user_home></p>
</blockquote>
<p>每个用户只能有一个Gradle属性文件位于<user_home>/.gradle目录下</user_home></p>
<h3 id="其他方式"><a href="#其他方式" class="headerlink" title="其他方式"></a>其他方式</h3><ul>
<li>项目属性通过-P 命令行选项提供</li>
<li>系统属性通过-D 命令行选项提供</li>
<li>环境属性按如下模式提供ORG_GRADLE_PROJECT_peopertyName=someValue</li>
</ul>
<h2 id="使用task"><a href="#使用task" class="headerlink" title="使用task"></a>使用task</h2><p>每个新创建的task都是org.gradle.api.DefaultTask类型的，标准的org.gradle.api.Task实现</p>
<h3 id="项目版本管理"><a href="#项目版本管理" class="headerlink" title="项目版本管理"></a>项目版本管理</h3><h2 id="Gradle-的内置task类型"><a href="#Gradle-的内置task类型" class="headerlink" title="Gradle 的内置task类型"></a>Gradle 的内置task类型</h2><h1 id="依赖管理"><a href="#依赖管理" class="headerlink" title="依赖管理"></a>依赖管理</h1><h1 id="Gradle测试"><a href="#Gradle测试" class="headerlink" title="Gradle测试"></a>Gradle测试</h1><p>自动化测试分为3种，单元测试、集成测试和功能测试</p>
<h2 id="测试配置"><a href="#测试配置" class="headerlink" title="测试配置"></a>测试配置</h2><p>testCompile：测试代码编译时依赖</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">	testCompile <span class="string">'junit:junit:4.12'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>testRuntime：测试代码编译时不需要使用，但运行时需要使用的依赖</p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
            <tag> Gradle </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java RegEx]]></title>
      <url>http://xiaozhuang.github.io/2016/07/21/Java-RegEx/</url>
      <content type="html"><![CDATA[<p>自java1.4.0以后，java就内建了正则表达式包， java.utile.regex,它的API毫不复杂（可以称得上简单），提供了强大而有创意的功能。<br>对Unicode的支持很棒，文档清晰，运行速度也很快。<br>它能够用来匹配CharSequence对象，所以使用起来非常方便。<br><a id="more"></a></p>
<h1 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h1><h2 id="函数式"><a href="#函数式" class="headerlink" title="函数式"></a>函数式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//数据检测</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String CHECK_UPLOAD_REGEX = <span class="string">"^\\&#123;.*\"success\"\\:true.*&#125;$"</span>;</div><div class="line"><span class="comment">//数据</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String response_data = <span class="string">"&#123;\"success\":true,\"fileid\":[\"2\"],\"filePath\":\"2016/07/19/17/5006828089.jpg\"&#125;"</span>;</div><div class="line"><span class="keyword">if</span>(Pattern.matches(CHECK_UPLOAD_REGEX,response_data))&#123;</div><div class="line">	<span class="comment">//matched</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//文本替换</span></div><div class="line"><span class="comment">//不使用正则，普通替换</span></div><div class="line">String url = <span class="string">"editUrl=\"~/entities/Temp4/edit\""</span>;</div><div class="line">String replace = url.replace(<span class="string">"~/entities/Temp4"</span>, <span class="string">"~/entities/temp1"</span>);</div><div class="line">System.out.println(replace);</div><div class="line"></div><div class="line"><span class="comment">//点号可以匹配行结束符</span></div><div class="line">String CABLE_AREA_REGEX = <span class="string">"(?s)&lt;!-- cable --&gt;.*?&lt;!-- /cable --&gt;"</span>;</div><div class="line"><span class="comment">// 多行</span></div><div class="line">sequence.replaceAll(<span class="string">"(?m)^\\s+"</span>,<span class="string">""</span>);</div><div class="line"><span class="comment">//使用正则，不区分大小写替换</span></div><div class="line">String replaceAll = url.replaceAll(<span class="string">"(?i)~/entities/temp4"</span>, <span class="string">"~/entities/temp1"</span>);</div><div class="line">System.out.println(replaceAll);</div></pre></td></tr></table></figure>
<h2 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a>面向对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//捕获文件路径正则</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String CAPTURE_FILEPATH_REGEX = <span class="string">"\"filePath\":(\"[^\"]*\")"</span>;</div><div class="line"><span class="comment">//数据</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String response_data = <span class="string">"&#123;\"success\":true,\"fileid\":[\"2\"],\"filePath\":\"2016/07/19/17/5006828089.jpg\"&#125;"</span>;</div><div class="line"><span class="comment">//定义并编译正则</span></div><div class="line">Pattern capture_filepath_regex_compile = Pattern.compile(CAPTURE_FILEPATH_REGEX);</div><div class="line"><span class="comment">//进行数据匹配</span></div><div class="line">Matcher capture_filepath_regex_matcher = capture_filepath_regex_compile.matcher(response_data);</div><div class="line"><span class="comment">// matches() 尝试将整个区域与模式匹配</span></div><div class="line"><span class="keyword">if</span>(capture_filepath_regex_matcher.find())&#123;</div><div class="line">    <span class="comment">//返回由以前匹配操作所匹配的输入子序列</span></div><div class="line">    String matchedText = capture_filepath_regex_matcher.group();</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> matchedFrom = capture_filepath_regex_matcher.start();</div><div class="line">    <span class="keyword">int</span> matchedTo = capture_filepath_regex_matcher.end();</div><div class="line">    System.out.println(<span class="string">"matched [ "</span> + matchedText + <span class="string">" ] from "</span>+ matchedFrom + <span class="string">" to "</span>+ matchedTo + <span class="string">"."</span>);</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="comment">//捕获组是从 1 开始从左到右的索引。组零表示整个模式，因此表达式 m.group(0) 等效于 m.group()</span></div><div class="line">    <span class="comment">// 不包含捕获型括号时，m.group(1) = m.group()</span></div><div class="line">    String filePath = capture_filepath_regex_matcher.group(<span class="number">1</span>);</div><div class="line">    System.out.println(filePath);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>matched [“filePath”:”2016/07/19/17/5006828089.jpg”] from 31 to 72.<br>“2016/07/19/17/5006828089.jpg”</p>
</blockquote>
<h1 id="java-util-regex使用"><a href="#java-util-regex使用" class="headerlink" title="java.util.regex使用"></a>java.util.regex使用</h1><p>java.util.regex.Pattern 是编译好的正则表达式<br>java.util.regex.Matcher 对应单独的实例，表示正则表达式应用到某个具体的目标字符串上,用来进行实际的匹配尝试（使用find），以及查询结果（使用group、start和end方法）</p>
<h2 id="Matcher对象"><a href="#Matcher对象" class="headerlink" title="Matcher对象"></a>Matcher对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//每组捕获型括号对应的信息，通过group(num)、start(num)、end(num)方法获取</span></div><div class="line"><span class="comment">//匹配的输入子序列</span></div><div class="line">String java.util.regex.MatchResult.group()</div><div class="line"><span class="comment">//编号num的捕获型括号匹配的内容,group(0) 等于group()</span></div><div class="line">String java.util.regex.MatchResult.group(<span class="keyword">int</span> num)</div><div class="line"></div><div class="line"><span class="comment">//匹配的初始索引</span></div><div class="line"><span class="keyword">int</span> java.util.regex.MatchResult.start()</div><div class="line"><span class="comment">//编号num的捕获型括号起点，start(0) 等于start()</span></div><div class="line"><span class="keyword">int</span> java.util.regex.MatchResult.start(<span class="keyword">int</span> num)</div><div class="line"></div><div class="line"><span class="comment">//匹配的结束索引</span></div><div class="line"><span class="keyword">int</span> java.util.regex.MatchResult.end()</div><div class="line"><span class="comment">//编号num的捕获型括号终点，end(0) 等于end()</span></div><div class="line"><span class="keyword">int</span> java.util.regex.MatchResult.end(<span class="keyword">int</span> num)</div><div class="line"></div><div class="line"><span class="comment">//获取当前使用的pattern</span></div><div class="line">Pattern java.util.regex.Matcher.pattern()</div><div class="line"><span class="comment">//更改pattern</span></div><div class="line">Matcher java.util.regex.Matcher.usePattern(Pattern)</div><div class="line"></div><div class="line"><span class="comment">//尝试匹配，每次都在上次尝试之后尝试新的匹配</span></div><div class="line"><span class="keyword">boolean</span> java.util.regex.Matcher.find()</div><div class="line"><span class="comment">// 重置此匹配器(检索范围为整个目标字符)，然后从距离开头offset个字符的位置开始查找</span></div><div class="line"><span class="keyword">boolean</span> java.util.regex.Matcher.find(<span class="keyword">int</span> offset)</div><div class="line"></div><div class="line"><span class="comment">// pattern捕获型括号数目</span></div><div class="line"><span class="keyword">int</span> java.util.regex.Matcher.groupCount()</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 正在表达式能否`完全`匹配当前检索范围的那段文本</span></div><div class="line"><span class="keyword">boolean</span> java.util.regex.Matcher.matches()</div><div class="line"></div><div class="line"><span class="comment">// 从当前目标字符串开头开始，能否在当前检索范围内找到匹配</span></div><div class="line">java.util.regex.Matcher.lookingAt()</div><div class="line"></div><div class="line"><span class="comment">//返回此匹配器的匹配状态</span></div><div class="line"><span class="comment">//包含group、start、end、groupCount方法</span></div><div class="line">MatchResult MatchResult java.util.regex.Matcher.toMatchResult()</div></pre></td></tr></table></figure>
<h2 id="替换"><a href="#替换" class="headerlink" title="替换"></a>替换</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">String regex = <span class="string">"(\\w)132"</span>;</div><div class="line">String text = <span class="string">"wangdz13230321524sunday132545"</span>;</div><div class="line">System.out.println(<span class="string">"text:"</span>+text);</div><div class="line"><span class="comment">//定义并编译正则</span></div><div class="line">Pattern pattern = Pattern.compile(regex);</div><div class="line"><span class="comment">//进行数据匹配</span></div><div class="line">Matcher matcher = pattern.matcher(text);</div><div class="line"></div><div class="line"></div><div class="line">String replaceAll = matcher.replaceAll(<span class="string">"$1182"</span>);</div><div class="line">System.out.println(<span class="string">"replaceAll:"</span>+replaceAll);</div><div class="line"></div><div class="line"></div><div class="line">String replaceFirst = matcher.replaceFirst(<span class="string">"$1182"</span>);</div><div class="line">System.out.println(<span class="string">"replaceFirst:"</span>+replaceFirst);</div></pre></td></tr></table></figure>
<blockquote>
<p>text:wangdz13230321524sunday132545<br>replaceAll:wangdz18230321524sunday182545<br>replaceFirst:wangdz18230321524sunday132545</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//替换目标字符串中与正则匹配的全部子串，放回替换之后的副本</span></div><div class="line">String java.util.regex.Matcher.replaceAll(String replacement)</div><div class="line"></div><div class="line">String.replaceAll(regex, replacement)</div><div class="line">等于 Pattern.compile(regex).matcher(text).replaceAll(replacement)</div><div class="line"></div><div class="line"><span class="comment">//仅对第一次匹配（如果存在）进行替换，String也提供了replaceFirst方法</span></div><div class="line">String java.util.regex.Matcher.replaceFirst(String replacement)</div></pre></td></tr></table></figure>
<h2 id="replacement-参数"><a href="#replacement-参数" class="headerlink" title="replacement 参数"></a>replacement 参数</h2><p>replacement参数在插入到匹配结果之前，会进行特殊处理</p>
<p>$1、$2之类会替换为对应编号的捕获型括号匹配的文本（$0 表示所有匹配的文本）<br>如果<code>只有3组</code>捕获型括号，则$25被视为$2然后是’5’<br>如果有12组捕获型括号，如果希望使用<code>第一组</code>捕获型括号，然后是’2’，应该这样’$1\2’</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//对replacement中的特殊字符添加转义，避免特殊处理</span></div><div class="line">String java.util.regex.Matcher.quoteReplacement(String replacement)</div></pre></td></tr></table></figure>
<h2 id="高级查找-替换"><a href="#高级查找-替换" class="headerlink" title="高级查找-替换"></a>高级查找-替换</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">String text = <span class="string">"--&gt;one+test&lt;&lt;--"</span>;</div><div class="line">String regex = <span class="string">"\\w+"</span>;</div><div class="line">StringBuffer result = <span class="keyword">new</span> StringBuffer();</div><div class="line"></div><div class="line">Pattern compile = Pattern.compile(regex);</div><div class="line">Matcher matcher = compile.matcher(text);</div><div class="line"></div><div class="line"><span class="keyword">while</span>(matcher.find())&#123;</div><div class="line">    matcher.appendReplacement(result, <span class="string">"XXX"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">matcher.appendTail(result);</div><div class="line"></div><div class="line">System.out.println(<span class="string">"result:"</span>+result);</div></pre></td></tr></table></figure>
<blockquote>
<p>result:–&gt;XXX+XXX&lt;&lt;–</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//正则表达式应用成功后（通常是find）马上调用appendReplacement，会把两个字符串添加到StringBuffer</span></div><div class="line"><span class="comment">//第一个，目标字符串匹配之前的文本</span></div><div class="line"><span class="comment">//第二个，特殊处理的replacement字符串</span></div><div class="line">Matcher java.util.regex.Matcher.appendReplacement(StringBuffer sb, String replacement)</div><div class="line"></div><div class="line"><span class="comment">//匹配停止后，将剩下的文本附加到StringBuffer</span></div><div class="line">StringBuffer java.util.regex.Matcher.appendTail(StringBuffer sb)</div></pre></td></tr></table></figure>
<h2 id="原地查找-替换"><a href="#原地查找-替换" class="headerlink" title="原地查找-替换"></a>原地查找-替换</h2><p>Matcher使用于任何实现了CharSequence接口的类，能够对目标文本实时地、原地（in place）的修改。</p>
<p>StringBuffer和StringBuilder是两种常见的实现了CharSequence接口的类</p>
<p>等长替换</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">StringBuilder text = <span class="keyword">new</span> StringBuilder(<span class="string">"It's SO very RUDE to shout!"</span>);  </div><div class="line"><span class="comment">//\p&#123;Lu&#125;大写字母</span></div><div class="line"><span class="comment">//\p&#123;Lt&#125;单词开头的字母</span></div><div class="line">Matcher matcher = Pattern.compile(<span class="string">"\\b[\\p&#123;Lu&#125;\\p&#123;Lt&#125;]+\\b"</span>).matcher(text);</div><div class="line"><span class="keyword">while</span>(matcher.find())&#123;</div><div class="line">    text.replace(matcher.start(), matcher.end(), matcher.group().toLowerCase());</div><div class="line">&#125;</div><div class="line">System.out.println(text);</div></pre></td></tr></table></figure>
<h2 id="长度变化的替换"><a href="#长度变化的替换" class="headerlink" title="长度变化的替换"></a>长度变化的替换</h2><p>长度变化的替换，需要调整“匹配指针”（在目标字符串中进行下一次find的开始位置）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">StringBuilder text = <span class="keyword">new</span> StringBuilder(<span class="string">"It's SO very RUDE to shout!"</span>);</div><div class="line"></div><div class="line">Matcher matcher = Pattern.compile(<span class="string">"\\b[\\p&#123;Lu&#125;\\p&#123;Lt&#125;]+\\b"</span>).matcher(text);</div><div class="line"><span class="keyword">int</span> matchPointer = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="comment">//java.util.regex.Matcher.find(int start)</span></div><div class="line"><span class="comment">//重置此匹配器，然后尝试查找匹配该模式、从指定索引开始的输入序列的下一个子序列。</span></div><div class="line"><span class="keyword">while</span> (matcher.find(matchPointer)) &#123;</div><div class="line">    String replaceString = <span class="string">"&lt;b&gt;"</span> + matcher.group().toLowerCase() + <span class="string">"&lt;/b&gt;"</span>;</div><div class="line">    text.replace(matcher.start(), matcher.end(), replaceString);</div><div class="line">    <span class="comment">//调整匹配指针位置</span></div><div class="line">    matchPointer = matcher.start() + replaceString.length();</div><div class="line">&#125;</div><div class="line"></div><div class="line">System.out.println(text);</div></pre></td></tr></table></figure>
<h2 id="元字符"><a href="#元字符" class="headerlink" title="元字符"></a>元字符</h2><p>Java的正则流派，java.util.regex使用传统型NFA</p>
<table>
<thead>
<tr>
<th>元字符</th>
<th>作用 </th>
</tr>
</thead>
<tbody>
<tr>
<td>(?: … )</td>
<td>非捕获型括号</td>
</tr>
<tr>
<td>?+ 、*+ 、++ 、 {m,n}+</td>
<td>占有优先量词</td>
</tr>
<tr>
<td>\b</td>
<td>单词分解符</td>
</tr>
</tbody>
</table>
<h3 id="字符缩略表示法"><a href="#字符缩略表示法" class="headerlink" title="字符缩略表示法"></a>字符缩略表示法</h3><p>\a    报警。ASCII中<bel>字符，八进制编码007<br>\b    退格。ASCII中<bs>字符，八进制编码010（许多流派中，\b只有在字符组内部才表示这样的意义，否则代表单词分解符）<br>\e    Escape字符。ASCII中<esc>字符，八进制编码033<br>\f    进纸符。ASCII中<ff>字符，八进制编码014<br>\n    换行符。Unix和DOS/Windows中，ASCII中<lf>字符，八进制编码012。MacOS中，对应ASCII中<cr>字符，十进制编码015。java中，不论什么平台，都对应ASCII中<code>&lt;LF&gt;</code>字符。<br>\r    回车。Unix和DOS/Windows中，ASCII的<cr>字符。MacOS中，对应ASCII中<lf>字符。java中，不论什么平台，都对应ASCII的<code>&lt;CR&gt;</code>字符<br>\t    水平制表符。ASCII中<ht>字符，八进制编码011<br>\v    垂直制表符。ASCII中<vt>字符，八进制编码013</vt></ht></lf></cr></cr></lf></ff></esc></bs></bel></p>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
            <tag> RegEX </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Apache Commons]]></title>
      <url>http://xiaozhuang.github.io/2016/07/21/apache-commons/</url>
      <content type="html"><![CDATA[<p>Apache Commons笔记<br><a id="more"></a></p>
<h1 id="beanutils"><a href="#beanutils" class="headerlink" title="beanutils"></a>beanutils</h1><h2 id="Map与Object互转"><a href="#Map与Object互转" class="headerlink" title="Map与Object互转"></a>Map与Object互转</h2><p>Apache Commons BeanUtils</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanUtils;</div><div class="line"><span class="keyword">import</span> org.codehaus.jackson.map.ObjectMapper;</div><div class="line"></div><div class="line"><span class="comment">//1.Object --&gt; Map</span></div><div class="line">Map&lt;String, String&gt; describe = BeanUtils.describe(<span class="keyword">new</span> Person(<span class="string">"sunday"</span>,<span class="number">21</span>));</div><div class="line">System.out.println(describe);</div><div class="line"></div><div class="line"><span class="comment">//2.Object --&gt; Map</span></div><div class="line">Map&lt;String, Object&gt; describe2 = PropertyUtils.describe(serviceNoInfo);</div><div class="line">System.out.println(describe2);</div><div class="line"></div><div class="line"><span class="comment">//3.Object --&gt; Map</span></div><div class="line">Map&lt;Object, Object&gt; map2 = <span class="keyword">new</span> BeanMap(pojo);</div><div class="line">System.out.println(map2);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//1.Map --&gt; Object</span></div><div class="line">Person person = <span class="keyword">new</span> Person();</div><div class="line">BeanUtils.populate(person, map);</div><div class="line">System.out.println(person);</div><div class="line"></div><div class="line"><span class="comment">//2.Map --&gt; Object</span></div><div class="line">Person pojo = mapper.convertValue(map, Person.class);</div><div class="line">System.out.println(pojo);</div></pre></td></tr></table></figure>
<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- jackson 1.x --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.jackson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core-asl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.jackson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-mapper-asl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/commons-beanutils/commons-beanutils --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h1 id="commons-fileupload"><a href="#commons-fileupload" class="headerlink" title="commons-fileupload"></a>commons-fileupload</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/commons-fileupload/commons-fileupload --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">org.apache.commons.fileupload.util.<span class="function">Streams</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">copy</span><span class="params">(InputStream pInputStream,OutputStream pOutputStream, <span class="keyword">boolean</span> pClose)</span></div></pre></td></tr></table></figure>
<h1 id="commons-lang3"><a href="#commons-lang3" class="headerlink" title="commons-lang3"></a>commons-lang3</h1><h2 id="字符串检测"><a href="#字符串检测" class="headerlink" title="字符串检测"></a>字符串检测</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"> String str = <span class="string">"test"</span>;</div><div class="line"><span class="keyword">if</span>(StringUtils.isEmpty(str))&#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span>(StringUtils.isBlank(str))&#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="集合检查"><a href="#集合检查" class="headerlink" title="集合检查"></a>集合检查</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(CollectionUtils.isEmpty(<span class="keyword">new</span> ArrayList&lt;&gt;()))&#123;</div><div class="line">    System.out.println(<span class="string">"empty list"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
            <tag> Tools </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[JavaSE]]></title>
      <url>http://xiaozhuang.github.io/2016/07/21/javase/</url>
      <content type="html"><![CDATA[<blockquote>
<p>大学零零散散搞了不到四年的Java，我相信很多人都跟我一样，JavaSE基础没打牢，就急忙忙、兴冲冲的搞JavaEE了，然后学习一下前台开发(html、css、JavaScript)，有可能还搞搞jQuery、extjs，再然后是Struts、hibernate、spring，然后听说找工作得会Linux、Oracle，又去学，在这个过程中，是否迷失了，虽然学习面很广，但就像《神雕侠侣》中黄药师评价杨过，博而不精、杂而不纯，这一串下来，感觉做Java开发好难，并不是学着难，而是知识面太广了，又要精通这个，又要精通那个。<br>—— <a href="http://blog.csdn.net/ghsau/article/details/7421217" title="Java线程(一)：线程安全与不安全" target="_blank" rel="external">Java线程(一)：线程安全与不安全</a></p>
</blockquote>
<a id="more"></a>
<h1 id="jdk安装"><a href="#jdk安装" class="headerlink" title="jdk安装"></a>jdk安装</h1><p>jdk8安装，自动添加环境变量<br>C:\ProgramData\Oracle\Java\javapath;<br>其中java命令指向jre下java.exe</p>
<h1 id="面向对象三大特征"><a href="#面向对象三大特征" class="headerlink" title="面向对象三大特征"></a>面向对象三大特征</h1><p>封装：封装就是将数据或函数等集合在一个单元中</p>
<ul>
<li>隐藏实现细节,仅对外公开接口</li>
<li>保证数据的安全,将变化隔离</li>
</ul>
<p>继承：当两个类具有相同的特征（属性）和行为（方法）时，可以将相同的部分抽取出来放到一个类中作为父类，其它类继承这个父类。<br>多态：指允许不同类的对象对同一消息做出响应。</p>
<h1 id="Java基础"><a href="#Java基础" class="headerlink" title="Java基础"></a>Java基础</h1><h2 id="float-与-double"><a href="#float-与-double" class="headerlink" title="float 与 double"></a>float 与 double</h2><p>float是单精度浮点数，内存分配4个字节，占32位，有效小数位6-7位<br>double是双精度浮点数，内存分配8个字节，占64位，有效小数位15位</p>
<h2 id="int-和-Integer区别"><a href="#int-和-Integer区别" class="headerlink" title="int 和 Integer区别"></a>int 和 Integer区别</h2><p>int 默认值为 0<br>Integer 默认值为null</p>
<h2 id="String-format-String-format-Object…-args"><a href="#String-format-String-format-Object…-args" class="headerlink" title="String.format(String format,Object… args)"></a>String.format(String format,Object… args)</h2><p>使用指定的格式字符串和参数返回一个格式化字符串<br><code>jdk1.5+</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">String sqlTp = <span class="string">"SELECT * FROM `uam_user`WHERE `USER_ID` IN ('%s')"</span>;</div><div class="line">String sql1 = String.format(sqlTp,<span class="string">"user1"</span>);</div><div class="line"><span class="comment">//结果：SELECT * FROM `uam_user`WHERE `USER_ID` IN ('user1')</span></div><div class="line">String sql2 = String.format(sqlTp,<span class="string">"'user1,user2'"</span>.replace(<span class="string">","</span>, <span class="string">"','"</span>));</div><div class="line"><span class="comment">//结果：SELECT * FROM `uam_user`WHERE `USER_ID` IN ('user1','user2')</span></div></pre></td></tr></table></figure>
<h2 id="基本数据类型转换"><a href="#基本数据类型转换" class="headerlink" title="基本数据类型转换"></a>基本数据类型转换</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// long转int</span></div><div class="line">Long num  = <span class="number">100L</span>;</div><div class="line">num.intValue();</div><div class="line"></div><div class="line"><span class="comment">// Integer 转 String</span></div><div class="line">Integer.toString(number)</div></pre></td></tr></table></figure>
<h2 id="HashCode"><a href="#HashCode" class="headerlink" title="HashCode"></a>HashCode</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// java.lang.String.hashCode()</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> h = hash;</div><div class="line">    <span class="keyword">int</span> len = count;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (h == <span class="number">0</span> &amp;&amp; len &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">int</span> off = offset;</div><div class="line">        <span class="keyword">char</span> val[] = value;</div><div class="line"></div><div class="line">        <span class="comment">//每个字符</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</div><div class="line">            h = <span class="number">31</span>*h + val[off++];</div><div class="line">        &#125;</div><div class="line">        hash = h;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> h;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="近似数"><a href="#近似数" class="headerlink" title="近似数"></a>近似数</h2><p><code>jdk1.0</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//java.lang.Math</span></div><div class="line"><span class="keyword">double</span> quarter = <span class="number">0.25</span>;</div><div class="line"><span class="keyword">double</span> half = <span class="number">0.5</span>;</div><div class="line"><span class="keyword">double</span> three_fourths = <span class="number">0.75</span>;</div><div class="line"><span class="comment">//四舍五入</span></div><div class="line">Math.round(quarter);<span class="comment">//0</span></div><div class="line">Math.round(half);<span class="comment">//1</span></div><div class="line">Math.round(three_fourths);<span class="comment">//1</span></div><div class="line"><span class="comment">//进一法</span></div><div class="line">Math.ceil(quarter);<span class="comment">//1.0</span></div><div class="line"><span class="comment">//去尾法</span></div><div class="line">Math.floor(three_fourths);<span class="comment">//0.0</span></div></pre></td></tr></table></figure>
<h2 id="随机数"><a href="#随机数" class="headerlink" title="随机数"></a>随机数</h2><p>伪随机数：真正意义上的随机数（或者随机事件）在某次产生过程中是按照实验过程中表现的分布概率随机产生的，其结果是不可预测的，是不可见的。而计算机中的随机函数是按照一定算法模拟产生的，其结果是确定的，是可见的。我们可以这样认为这个可预见的结果其出现的概率是100%。所以用计算机随机函数所产生的“随机数”并不随机，是伪随机数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">        Random rand = <span class="keyword">new</span> Random();</div><div class="line"><span class="comment">//      nextInt()  返回下一个伪随机数</span></div><div class="line"><span class="comment">//      nextBoolean()  生成一个随机的boolean值，生成true和false的值几率相等</span></div><div class="line"><span class="comment">//      nextDouble()  生成一个随机的double值，数值介于[0,1.0)之间</span></div><div class="line"><span class="comment">//      nextInt(int n)  生成一个随机的int值，该值介于[0,n)的区间</span></div><div class="line"><span class="comment">//      nextFloat()  伪随机地生成并返回一个从 0.0f（包括）到 1.0f（包括）范围内均匀选择（大致）的 float 值</span></div><div class="line"><span class="comment">//      double nextGaussian()返回下一个伪随机数，它是取自此随机数生成器序列的、呈高斯（“正态”）分布的 double 值，其平均值是 0.0，标准差是 1.0</span></div><div class="line">        </div><div class="line">        </div><div class="line"><span class="comment">//      Random(long seed)使用单个 long 种子创建一个新的随机数生成器。该种子是伪随机数生成器的内部状态的初始值</span></div><div class="line"><span class="comment">//      setSeed(long seed)该方法的作用是重新设置Random对象中的种子数。设置完种子数以后的Random对象和相同种子数使用new关键字创建出的Random对象相同。</span></div></pre></td></tr></table></figure>
<h2 id="获取当前执行的方法"><a href="#获取当前执行的方法" class="headerlink" title="获取当前执行的方法"></a>获取当前执行的方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Thread.currentThread().getStackTrace()[<span class="number">1</span>].getMethodName();</div></pre></td></tr></table></figure>
<h2 id="多继承"><a href="#多继承" class="headerlink" title="多继承"></a>多继承</h2><p>Java类是单继承的，接口可以多继承。</p>
<h2 id="字符串拼接"><a href="#字符串拼接" class="headerlink" title="字符串拼接"></a>字符串拼接</h2><p><code>模板</code><br><code>替换</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">final</span> String MOBILE_RETURN_CODE_PREFIX = <span class="string">"WW"</span>;</div><div class="line">        </div><div class="line">StringBuffer billCode = <span class="keyword">new</span> StringBuffer();</div><div class="line">billCode.append(MOBILE_RETURN_CODE_PREFIX);</div><div class="line"></div><div class="line">billCode.append(String.format(<span class="string">"%010d"</span>, <span class="number">10000L</span>));<span class="comment">//字符串格式化10位数字，前端补零</span></div><div class="line"></div><div class="line">System.out.println(billCode.toString());</div><div class="line"></div><div class="line">String ROLE_1_CONTENT = <span class="string">"运单[&#123;0&#125;]客户申请取消，请拦截！确认拦截成功后，请及时审核拦截申请！"</span>;</div><div class="line">String content = MessageFormat.format(ROLE_1_CONTENT, <span class="string">"VC40898997812"</span>);</div><div class="line">System.out.println(content);</div></pre></td></tr></table></figure>
<h1 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 获取与系统有关的路径分隔符k</span></div><div class="line">File.separator</div></pre></td></tr></table></figure>
<h2 id="获取classpath路径"><a href="#获取classpath路径" class="headerlink" title="获取classpath路径"></a>获取classpath路径</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 方法1：</span></div><div class="line"><span class="comment">// 相对路径为相对App3所在包路径；</span></div><div class="line"><span class="comment">// 绝对路径为相对classpath路径</span></div><div class="line"><span class="comment">// 若路径指定的文件或文件夹不存在，则返回空</span></div><div class="line"><span class="comment">// jar包中Class使用相对路径获取资源java.lang.NullPointerException</span></div><div class="line">String path = App3.class.getResource(<span class="string">"/"</span>).getPath();</div><div class="line">String path2 = App3.class.getResource(<span class="string">"./"</span>).getPath();</div><div class="line"></div><div class="line"><span class="comment">// 方法2：</span></div><div class="line"><span class="comment">// 获取App3加载路径根，即classpath路径</span></div><div class="line"><span class="comment">// 若App3在jar包中，则返回jar包路径</span></div><div class="line">String path3 = App3.class.getProtectionDomain().getCodeSource().getLocation().getPath();</div></pre></td></tr></table></figure>
<h2 id="创建临时文件"><a href="#创建临时文件" class="headerlink" title="创建临时文件"></a>创建临时文件</h2><p>windows临时文件位置：<br>C:\Users\xxx\AppData\Local\Temp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 在默认临时文件目录中创建一个空文件，使用给定前缀和后缀生成其名称</span></div><div class="line"><span class="comment">// 文件名为，前缀 + 随机序列 + 后缀</span></div><div class="line">File.createTempFile(String prefix, String suffix) </div><div class="line"></div><div class="line"><span class="comment">// 在指定目录中创建一个新的空文件，使用给定的前缀和后缀字符串生成其名称。</span></div><div class="line">File.createTempFile(String prefix, String suffix, File directory)</div></pre></td></tr></table></figure>
<h2 id="写文件-img2base64"><a href="#写文件-img2base64" class="headerlink" title="写文件 img2base64"></a>写文件 img2base64</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// import org.apache.commons.codec.binary.Base64;</span></div><div class="line"><span class="comment">// import org.apache.commons.io.IOUtils;</span></div><div class="line"></div><div class="line"> <span class="comment">//图片转base64，不包含header</span></div><div class="line">URL url = App.class.getResource(<span class="string">"/github5.png"</span>);</div><div class="line"><span class="keyword">byte</span>[] imageBytes = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    imageBytes = IOUtils.toByteArray(url);</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125;</div><div class="line"><span class="keyword">byte</span>[] base64EncodedByteArray = Base64.encodeBase64(imageBytes);</div><div class="line">System.out.println(<span class="keyword">new</span> String(base64EncodedByteArray));</div><div class="line"></div><div class="line"><span class="comment">//base64转图片，base64不包含header</span></div><div class="line"><span class="keyword">try</span> (FileOutputStream imageOutFile = <span class="keyword">new</span> FileOutputStream(App.class.getResource(<span class="string">"/"</span>).getPath() + <span class="string">"github52.jpeg"</span>))&#123;</div><div class="line">    imageOutFile.write(Base64.decodeBase64(base64EncodedByteArray));</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="文件保存"><a href="#文件保存" class="headerlink" title="文件保存"></a>文件保存</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    InputStream is = <span class="keyword">new</span> FileInputStream(<span class="string">"/Users/pankaj/source.txt"</span>);</div><div class="line">    </div><div class="line">    OutputStream os = <span class="keyword">new</span> FileOutputStream(<span class="string">"/Users/pankaj/new_source.txt"</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</div><div class="line">    <span class="keyword">int</span> bytesRead;</div><div class="line">    <span class="comment">//read from is to buffer</span></div><div class="line">    <span class="keyword">while</span>((bytesRead = is.read(buffer)) !=-<span class="number">1</span>)&#123;</div><div class="line">        os.write(buffer, <span class="number">0</span>, bytesRead);</div><div class="line">    &#125;</div><div class="line">    is.close();</div><div class="line">    <span class="comment">//flush OutputStream to write any buffered data to file</span></div><div class="line">    os.flush();</div><div class="line">    os.close();</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="递归文件目录"><a href="#递归文件目录" class="headerlink" title="递归文件目录"></a>递归文件目录</h2><p><code>递归</code><br><code>所以文件</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//路径</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String OUTPUT_ROOT_PATH = System.getProperty(<span class="string">"user.dir"</span>)</div><div class="line">            + File.separator + <span class="string">"sqlscripts"</span>;</div><div class="line"></div><div class="line">File scriptDir = <span class="keyword">new</span> File(OUTPUT_ROOT_PATH);</div><div class="line"><span class="keyword">if</span>(!scriptDir.exists())&#123;</div><div class="line">    scriptDir.mkdirs();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 指定路径、文件过滤器、目录过滤器</span></div><div class="line">Collection&lt;File&gt; listFiles = FileUtils.listFiles(<span class="keyword">new</span> File(OUTPUT_ROOT_PATH), <span class="keyword">new</span> SuffixFileFilter(<span class="string">"xml"</span>),TrueFileFilter.INSTANCE);</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- pom --&gt;</span></div><div class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/commons-io/commons-io --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h1 id="对象操作"><a href="#对象操作" class="headerlink" title="对象操作"></a>对象操作</h1><h2 id="Map深拷贝"><a href="#Map深拷贝" class="headerlink" title="Map深拷贝"></a>Map深拷贝</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Map&lt;String, Object&gt; dataClone = <span class="keyword">new</span> HashMap&lt;String, Object&gt;(data);</div></pre></td></tr></table></figure>
<h2 id="对象深拷贝"><a href="#对象深拷贝" class="headerlink" title="对象深拷贝"></a>对象深拷贝</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// org.apache.commons.lang3.SerializationUtils</span></div><div class="line"><span class="comment">// 对象需实现Serializable接口</span></div><div class="line">Foo foo = <span class="keyword">new</span> Foo();</div><div class="line">foo.setId(<span class="number">1</span>);</div><div class="line">Foo clone = SerializationUtils.clone(foo);</div></pre></td></tr></table></figure>
<h2 id="同名属性拷贝"><a href="#同名属性拷贝" class="headerlink" title="同名属性拷贝"></a>同名属性拷贝</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">Bar orig = <span class="keyword">new</span> Bar();</div><div class="line">orig.setId(<span class="number">111</span>);</div><div class="line">orig.setName(<span class="string">"sunday"</span>);</div><div class="line"></div><div class="line">Foo dest = <span class="keyword">new</span> Foo();</div><div class="line"><span class="comment">//方式1 commons-beanutils</span></div><div class="line"><span class="comment">//org.apache.commons.beanutils.BeanUtils</span></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    BeanUtils.copyProperties(dest, orig);</div><div class="line">&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125;</div><div class="line">System.out.println(dest);</div><div class="line"></div><div class="line"><span class="comment">//方式2 cglib</span></div><div class="line"><span class="comment">//net.sf.cglib.beans.BeanCopier</span></div><div class="line">Foo foo = <span class="keyword">new</span> Foo();</div><div class="line">BeanCopier bc = BeanCopier.create(Bar.class, Foo.class, <span class="keyword">false</span>);</div><div class="line">bc.copy(orig, foo, <span class="keyword">null</span>);</div><div class="line">System.out.println(foo);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// object to map</span></div><div class="line">ObjectMapper oMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line"></div><div class="line">Student obj = <span class="keyword">new</span> Student();</div><div class="line">obj.setName(<span class="string">"mkyong"</span>);</div><div class="line">obj.setAge(<span class="number">34</span>);</div><div class="line">obj.setSkills(Arrays.asList(<span class="string">"java"</span>,<span class="string">"node"</span>));</div><div class="line"><span class="comment">// object -&gt; Map</span></div><div class="line">Map&lt;String, Object&gt; map = oMapper.convertValue(obj, Map.class);</div></pre></td></tr></table></figure>
<h2 id="使用参数创建List"><a href="#使用参数创建List" class="headerlink" title="使用参数创建List"></a>使用参数创建List</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">List&lt;String&gt; asList = Arrays.asList(<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>);</div></pre></td></tr></table></figure>
<h1 id="数组移除元素java-lang-UnsupportedOperationException"><a href="#数组移除元素java-lang-UnsupportedOperationException" class="headerlink" title="数组移除元素java.lang.UnsupportedOperationException"></a>数组移除元素java.lang.UnsupportedOperationException</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// List&lt;String&gt; list = new ArrayList&lt;&gt;();</span></div><div class="line"><span class="comment">// list.add("a");</span></div><div class="line"><span class="comment">// list.add("b");</span></div><div class="line"><span class="comment">// list.add("c");  </span></div><div class="line">List&lt;String&gt; list = Arrays.asList(<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>);</div><div class="line"><span class="keyword">for</span>(Iterator&lt;String&gt; it = list.iterator(); it.hasNext();)&#123;  </div><div class="line">    String it_tmp = it.next(); </div><div class="line">    <span class="keyword">if</span>(it_tmp.equals(<span class="string">"b"</span>))&#123;</div><div class="line">        it.remove();</div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Arrays.asList()返回固定大小的集合，不支持remove</p>
</blockquote>
<h2 id="获取本机ip"><a href="#获取本机ip" class="headerlink" title="获取本机ip"></a>获取本机ip</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**返回本地主机。*/</span> </div><div class="line">InetAddress addr = InetAddress.getLocalHost(); </div><div class="line"><span class="comment">/**返回 IP 地址字符串（以文本表现形式）*/</span> </div><div class="line">String ip; = addr.getHostAddress();</div></pre></td></tr></table></figure>
<h1 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//爬楼梯问题</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">up</span><span class="params">(<span class="keyword">int</span> to)</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(to &lt; <span class="number">1</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();<span class="comment">//参数非法异常</span></div><div class="line">    </div><div class="line">    <span class="keyword">if</span>(<span class="number">1</span> == to)&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="number">2</span> == to)&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">2</span>;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">return</span> up(to - <span class="number">1</span>) + up(to -<span class="number">2</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 断言异常：java.lang.AssertionError</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 主键重复异常： org.springframework.dao.DuplicateKeyException</span></div></pre></td></tr></table></figure>
<h2 id="常用异常类型"><a href="#常用异常类型" class="headerlink" title="常用异常类型"></a>常用异常类型</h2><table>
<thead>
<tr>
<th>类型</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>IllegalArgumentException</td>
<td>非法参数异常</td>
</tr>
</tbody>
</table>
<h1 id="调试技巧"><a href="#调试技巧" class="headerlink" title="调试技巧"></a>调试技巧</h1><h2 id="日志代理"><a href="#日志代理" class="headerlink" title="日志代理"></a>日志代理</h2><p>logging proxy是一个子类的对象，可窃取方法调用，并进行日志记录，然后调用超类中的方法</p>
<h2 id="打印堆栈"><a href="#打印堆栈" class="headerlink" title="打印堆栈"></a>打印堆栈</h2><p>代码中任意位置插入下面语句可获得堆栈跟踪</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Thread.dumpStack()</div></pre></td></tr></table></figure>
<h2 id="处理非捕获异常"><a href="#处理非捕获异常" class="headerlink" title="处理非捕获异常"></a>处理非捕获异常</h2><p>调用静态的Thread.setDefaultUncaughtExceptionHandler方法改变非捕获异常处理器</p>
<h2 id="观察类加载过程"><a href="#观察类加载过程" class="headerlink" title="观察类加载过程"></a>观察类加载过程</h2><p>-verbose标志启动java虚拟机</p>
<h2 id="使用jconsole显示虚拟机性能统计"><a href="#使用jconsole显示虚拟机性能统计" class="headerlink" title="使用jconsole显示虚拟机性能统计"></a>使用jconsole显示虚拟机性能统计</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jconsole processID</div></pre></td></tr></table></figure>
<h1 id="日期"><a href="#日期" class="headerlink" title="日期"></a>日期</h1><h2 id="日期转换"><a href="#日期转换" class="headerlink" title="日期转换"></a>日期转换</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// String -&gt; Date</span></div><div class="line">SimpleDateFormat format = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</div><div class="line">format.parse(datetime);</div><div class="line"></div><div class="line"><span class="comment">// Date -&gt; String</span></div><div class="line">format.format(date);</div></pre></td></tr></table></figure>
<h1 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h1><p>log4j规定了默认的几个级别：trace&lt;debug&lt;info&lt;warn&lt;error&lt;fatal</p>
<h1 id="log4j-换行"><a href="#log4j-换行" class="headerlink" title="log4j 换行"></a>log4j 换行</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String lineSeparator = System.getProperty(<span class="string">"line.separator"</span>);</div><div class="line">LOGGER.info(<span class="string">"Person's name is  &#123;&#125; .&#123;&#125;"</span>, person.getName(), lineSeparator);</div></pre></td></tr></table></figure>
<h1 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h1><p>@Description</p>
<p>{@link com.jd.etms.waybill.common.constant.OrderRelationTypeEnum}</p>
<h1 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h1><h2 id="接口过时"><a href="#接口过时" class="headerlink" title="接口过时"></a>接口过时</h2><p>@Deprecated</p>
<h1 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h1><h2 id="JDK"><a href="#JDK" class="headerlink" title="JDK"></a>JDK</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> Exception &#123;</div><div class="line">    ByteArrayOutputStream baos = <span class="keyword">null</span>;</div><div class="line">    ObjectOutputStream oos = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        baos = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        oos = <span class="keyword">new</span> ObjectOutputStream(baos);</div><div class="line">        oos.writeObject(obj);</div><div class="line">        oos.flush();</div><div class="line">        <span class="keyword">byte</span>[] bytes = baos.toByteArray();</div><div class="line">        <span class="keyword">return</span> bytes;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logger.error(<span class="string">"serialize-error:"</span>, e);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">if</span>(oos != <span class="keyword">null</span>)&#123;</div><div class="line">            oos.close();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(baos != <span class="keyword">null</span>)&#123;</div><div class="line">            baos.close();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">unserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    ByteArrayInputStream bais = <span class="keyword">null</span>;</div><div class="line">    ObjectInputStream ois = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        bais = <span class="keyword">new</span> ByteArrayInputStream(bytes);</div><div class="line">        ois = <span class="keyword">new</span> ObjectInputStream(bais);</div><div class="line">        <span class="keyword">return</span> ois.readObject();</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logger.error(<span class="string">"unserialize-error:"</span>, e);</div><div class="line">    &#125; <span class="keyword">finally</span>&#123;</div><div class="line">        <span class="keyword">if</span>(ois != <span class="keyword">null</span>)&#123;</div><div class="line">            ois.close();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(bais != <span class="keyword">null</span>)&#123;</div><div class="line">            bais.close();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="SerialVersionUid"><a href="#SerialVersionUid" class="headerlink" title="SerialVersionUid"></a>SerialVersionUid</h1><p>用一个称为 serialVersionUID 的版本号与每个可序列化类相关联，该序列号在反序列化过程中用于验证序列化对象的发送者和接收者是否为该对象加载了与序列化兼容的类</p>
<p>强烈建议 所有可序列化类都显式声明 serialVersionUID 值</p>
<p>两种方式：<br> private static final long serialVersionUID = 1L;<br> private static final long serialVersionUID = -2805284943658356093L;</p>
<p>一般采用第一种就行了，简单。<br>第二种能够保证每次更改类结构后改变版本号，但还是要手工去生成</p>
<h1 id="java异常处理"><a href="#java异常处理" class="headerlink" title="java异常处理"></a>java异常处理</h1><p>printStackTrace的堆栈跟踪功能显示出程序运行到当前类的执行流程，但只提供了一些最基本的信息，<br>未能说明实际导致错误的原因，同时也不易解读。</p>
<p>printStackTrace 可以出现在开发和测试阶段，不应该出现在运行阶段</p>
<p>调用printStackTrace算不上已经“处理好了异常”</p>
<h1 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h1><h2 id="for循环优化"><a href="#for循环优化" class="headerlink" title="for循环优化"></a>for循环优化</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Vector vect = <span class="keyword">new</span> Vector(<span class="number">1000</span>);</div><div class="line"><span class="keyword">for</span>( inti=<span class="number">0</span>; i &lt; vect.size(); i++)&#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//优化，减少1000次size()的系统调用开销</span></div><div class="line"><span class="keyword">int</span> size = vect.size();</div><div class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; size; i++)&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 检查循环内效率不高的地方</span></div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt;<span class="number">100000</span>;i++)&#123;</div><div class="line">    <span class="keyword">if</span> (i%<span class="number">10</span> == <span class="number">9</span>) &#123;</div><div class="line">    <span class="comment">// 每十次执行一次</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span>(inti =<span class="number">0</span>,j =<span class="number">10</span>; i&lt;<span class="number">100000</span>; i++,j--)&#123;　</div><div class="line">    <span class="keyword">if</span>(j == <span class="number">0</span>)&#123;</div><div class="line">        <span class="comment">// 每十次执行一次</span></div><div class="line">        j = <span class="number">10</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="数组复制"><a href="#数组复制" class="headerlink" title="数组复制"></a>数组复制</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> size = <span class="number">1000</span>;</div><div class="line">String[] strArray1 = <span class="keyword">new</span> String[size];</div><div class="line">String[] strArray2 = <span class="keyword">new</span> String[size];</div><div class="line"><span class="keyword">for</span>(inti=<span class="number">0</span>;i&lt;size;i++)&#123; <span class="comment">// 赋值</span></div><div class="line">    strArray1 = (<span class="keyword">new</span> String(<span class="string">"Array: "</span> + i));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//优先使用API</span></div><div class="line">System.arraycopy(strArray1,<span class="number">0</span>,strArray2,<span class="number">0</span>,size); <span class="comment">// 复制</span></div></pre></td></tr></table></figure>
<h2 id="减少I-O操作"><a href="#减少I-O操作" class="headerlink" title="减少I/O操作"></a>减少I/O操作</h2><p>用BufferedReader 代替Reader，用BufferedWriter代替Writer来进行处理I/O操作</p>
<p>同样可以用BufferedInputStream代替InputStream都可以获得性能的提高</p>
<h1 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h1><h2 id="load-xml-conf"><a href="#load-xml-conf" class="headerlink" title="load xml conf"></a>load xml conf</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Properties;</div><div class="line"><span class="comment">//生成完成输出图案</span></div><div class="line">Properties donePattern = <span class="keyword">new</span> Properties();</div><div class="line"></div><div class="line"><span class="keyword">try</span> (InputStream doneResourceAsStream = <span class="keyword">this</span>.getClass().getClassLoader()</div><div class="line">                     .getResourceAsStream(<span class="string">"done.xml"</span>))&#123;</div><div class="line">    donePattern.loadFromXML(doneResourceAsStream);</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">comment</span>&gt;</span>执行完成控制台图案<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"done_logo"</span>&gt;</span></div><div class="line">        &lt;![CDATA[</div><div class="line">          _____   ____  _   _ ______</div><div class="line">         |  __ \ / __ \| \ | |  ____|</div><div class="line">         | |  | | |  | |  \| | |__</div><div class="line">         | |  | | |  | | . ` |  __|</div><div class="line">         | |__| | |__| | |\  | |____</div><div class="line">         |_____/ \____/|_| \_|______|</div><div class="line">        ]]&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">List&lt;String&gt; sorted_keys = <span class="keyword">new</span> ArrayList&lt;String&gt;(params.keySet());</div><div class="line">Collections.sort(sorted_keys);<span class="comment">//自然升序排序</span></div></pre></td></tr></table></figure>
<h2 id="shutdown-hook"><a href="#shutdown-hook" class="headerlink" title="shutdown hook"></a>shutdown hook</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//将hook线程添加到运行时环境中去</span></div><div class="line">Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        applicationContext.close();</div><div class="line">        System.out.println(<span class="string">"shutdown hook run..."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;));</div></pre></td></tr></table></figure>
<h2 id="javaSE-运行"><a href="#javaSE-运行" class="headerlink" title="javaSE 运行"></a>javaSE 运行</h2><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">@echo off</div><div class="line">set TITLE=日志堆栈输出验证</div><div class="line">echo "--------------------------------"</div><div class="line">echo "日志堆栈输出验证"</div><div class="line">echo "--------------------------------"</div><div class="line">rem 解决以管理员运行，不能定位到当前目录问题</div><div class="line">cd /d %~dp0</div><div class="line">rem 保存当前目录</div><div class="line">set SERVICE_PATH="%cd%"</div><div class="line">rem 设置JAVA_HOME变量</div><div class="line">set JAVA_HOME=%SERVICE_PATH%\jdk1.7.0_79</div><div class="line">rem %JAVA_HOME%\bin\java -Dfile.encoding=UTF-8 -jar %SERVICE_PATH%\link_webservice.jar</div><div class="line">%JAVA_HOME%\bin\java -server -Xmx512m -Dfile.encoding=UTF-8 -classpath "./classes;./libs/*" com.sunday.log4j2_learn.ExctptionApp</div><div class="line">pause</div></pre></td></tr></table></figure>
<h2 id="3DES加密"><a href="#3DES加密" class="headerlink" title="3DES加密"></a>3DES加密</h2><p>对称加密</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.security.Security;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.crypto.Cipher;</div><div class="line"><span class="keyword">import</span> javax.crypto.SecretKey;</div><div class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 3DES加密</div><div class="line"> * 主要依靠唯一密钥来确保数据加密解密的安全</div><div class="line"> * <span class="doctag">@author</span> SHANHY(365384722@QQ.COM)</div><div class="line"> * <span class="doctag">@date</span> 2015-8-18</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreeDES</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String Algorithm = <span class="string">"DESede"</span>; <span class="comment">// 定义 加密算法,可用 DES,DESede(即3DES),Blowfish</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 加密方法</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> keybyte</div><div class="line">     *            加密密钥，长度为24字节</div><div class="line">     * <span class="doctag">@param</span> src</div><div class="line">     *            被加密的数据缓冲区（源）</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@author</span> SHANHY</div><div class="line">     * <span class="doctag">@date</span> 2015-8-18</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encryptMode(<span class="keyword">byte</span>[] keybyte, <span class="keyword">byte</span>[] src) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 生成密钥</span></div><div class="line">            SecretKey deskey = <span class="keyword">new</span> SecretKeySpec(keybyte, Algorithm);</div><div class="line"></div><div class="line">            <span class="comment">// 加密</span></div><div class="line">            Cipher c1 = Cipher.getInstance(Algorithm);</div><div class="line">            c1.init(Cipher.ENCRYPT_MODE, deskey);</div><div class="line">            <span class="keyword">return</span> c1.doFinal(src);</div><div class="line">        &#125; <span class="keyword">catch</span> (java.security.NoSuchAlgorithmException e1) &#123;</div><div class="line">            e1.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (javax.crypto.NoSuchPaddingException e2) &#123;</div><div class="line">            e2.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (java.lang.Exception e3) &#123;</div><div class="line">            e3.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 解密</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> keybyte</div><div class="line">     *            加密密钥，长度为24字节</div><div class="line">     * <span class="doctag">@param</span> src</div><div class="line">     *            加密后的缓冲区</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@author</span> SHANHY</div><div class="line">     * <span class="doctag">@date</span> 2015-8-18</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] decryptMode(<span class="keyword">byte</span>[] keybyte, <span class="keyword">byte</span>[] src) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 生成密钥</span></div><div class="line">            SecretKey deskey = <span class="keyword">new</span> SecretKeySpec(keybyte, Algorithm);</div><div class="line"></div><div class="line">            <span class="comment">// 解密</span></div><div class="line">            Cipher c1 = Cipher.getInstance(Algorithm);</div><div class="line">            c1.init(Cipher.DECRYPT_MODE, deskey);</div><div class="line">            <span class="keyword">return</span> c1.doFinal(src);</div><div class="line">        &#125; <span class="keyword">catch</span> (java.security.NoSuchAlgorithmException e1) &#123;</div><div class="line">            e1.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (javax.crypto.NoSuchPaddingException e2) &#123;</div><div class="line">            e2.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (java.lang.Exception e3) &#123;</div><div class="line">            e3.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 转换成十六进制字符串</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> b</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@author</span> SHANHY</div><div class="line">     * <span class="doctag">@date</span> 2015-8-18</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">byte2hex</span><span class="params">(<span class="keyword">byte</span>[] b)</span> </span>&#123;</div><div class="line">        String hs = <span class="string">""</span>;</div><div class="line">        String stmp = <span class="string">""</span>;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> n = <span class="number">0</span>; n &lt; b.length; n++) &#123;</div><div class="line">            stmp = (java.lang.Integer.toHexString(b[n] &amp; <span class="number">0XFF</span>));</div><div class="line">            <span class="keyword">if</span> (stmp.length() == <span class="number">1</span>)</div><div class="line">                hs = hs + <span class="string">"0"</span> + stmp;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                hs = hs + stmp;</div><div class="line">            <span class="keyword">if</span> (n &lt; b.length - <span class="number">1</span>)</div><div class="line">                hs = hs + <span class="string">":"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> hs.toUpperCase();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 测试</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> args</div><div class="line">     * <span class="doctag">@author</span> SHANHY</div><div class="line">     * <span class="doctag">@date</span> 2015-8-18</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="comment">// 添加新安全算法,如果用JCE就要把它添加进去</span></div><div class="line">        Security.addProvider(<span class="keyword">new</span> com.sun.crypto.provider.SunJCE());</div><div class="line"></div><div class="line">        <span class="comment">// 24字节的密钥</span></div><div class="line">        <span class="comment">// 3DES的密钥必须是24位的byte数组</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] keyBytes = &#123; <span class="number">0x11</span>, <span class="number">0x22</span>, <span class="number">0x4F</span>, <span class="number">0x58</span>, (<span class="keyword">byte</span>) <span class="number">0x88</span>, <span class="number">0x10</span>, <span class="number">0x40</span>, <span class="number">0x38</span>, <span class="number">0x28</span>, <span class="number">0x25</span>, <span class="number">0x79</span>, <span class="number">0x51</span>, (<span class="keyword">byte</span>) <span class="number">0xCB</span>, (<span class="keyword">byte</span>) <span class="number">0xDD</span>, <span class="number">0x55</span>, <span class="number">0x66</span>, <span class="number">0x77</span>, <span class="number">0x29</span>, <span class="number">0x74</span>, (<span class="keyword">byte</span>) <span class="number">0x98</span>, <span class="number">0x30</span>, <span class="number">0x40</span>, <span class="number">0x36</span>, (<span class="keyword">byte</span>) <span class="number">0xE2</span> &#125;;</div><div class="line">        String szSrc = <span class="string">"This is a 3DES test. 测试"</span>;</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"加密前的字符串:"</span> + szSrc);</div><div class="line"></div><div class="line">        <span class="keyword">byte</span>[] encoded = encryptMode(keyBytes, szSrc.getBytes());</div><div class="line">        System.out.println(<span class="string">"加密后的字符串:"</span> + <span class="keyword">new</span> String(encoded));</div><div class="line"></div><div class="line">        <span class="keyword">byte</span>[] srcBytes = decryptMode(keyBytes, encoded);</div><div class="line">        System.out.println(<span class="string">"解密后的字符串:"</span> + (<span class="keyword">new</span> String(srcBytes)));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="List截取"><a href="#List截取" class="headerlink" title="List截取"></a>List截取</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">List&lt;String&gt; list = Arrays.asList(<span class="string">"1"</span>, <span class="string">"2"</span>, <span class="string">"3"</span>);</div><div class="line">System.out.println(list.subList(<span class="number">1</span>, list.size()));</div></pre></td></tr></table></figure>
<h2 id="参数校验"><a href="#参数校验" class="headerlink" title="参数校验"></a>参数校验</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// com.google.common.base.Preconditions#checkArgument(boolean, java.lang.Object)</span></div><div class="line">Object obj = <span class="keyword">null</span>;</div><div class="line">Preconditions.checkArgument(obj != <span class="keyword">null</span>, <span class="string">"参数obj为空！"</span>);</div></pre></td></tr></table></figure>
<h2 id="延迟重试（retry-with-delay）"><a href="#延迟重试（retry-with-delay）" class="headerlink" title="延迟重试（retry with delay）"></a>延迟重试（retry with delay）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> tryCount = <span class="number">0</span>;</div><div class="line">String data = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">boolean</span> dataIsEmpty = <span class="keyword">true</span>;</div><div class="line"><span class="keyword">do</span> &#123;</div><div class="line">    data = getData();</div><div class="line">    dataIsEmpty = StringUtils.isEmpty(data);</div><div class="line">    <span class="comment">//获取数据失败，延迟</span></div><div class="line">    <span class="keyword">if</span>(dataIsEmpty)&#123;</div><div class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</div><div class="line">        ++tryCount;</div><div class="line">        System.out.println(<span class="string">"休眠。。。"</span>);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        System.out.println(<span class="string">"成功获的数据。。。"</span>);</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">while</span>(dataIsEmpty &amp;&amp; tryCount &lt; retry_timeout);</div><div class="line"></div><div class="line">System.out.println(data);</div></pre></td></tr></table></figure>
<h2 id="加载多个properties文件"><a href="#加载多个properties文件" class="headerlink" title="加载多个properties文件"></a>加载多个properties文件</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Properties properties = <span class="keyword">new</span> Properties();</div><div class="line">properties.load(<span class="keyword">new</span> FileInputStream(<span class="string">"file1.properties"</span>));</div><div class="line"></div><div class="line">Properties properties2 = <span class="keyword">new</span> Properties();</div><div class="line">properties2.load(<span class="keyword">new</span> FileInputStream(<span class="string">"file2.properties"</span>));</div><div class="line">properties.putAll(properties2);</div></pre></td></tr></table></figure>
<h2 id="文件复制"><a href="#文件复制" class="headerlink" title="文件复制"></a>文件复制</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Apache Commons IO FileUtils</span></div><div class="line">FileUtils.copyFile(source, dest);</div><div class="line"></div><div class="line"><span class="comment">// Java 7 or higher</span></div><div class="line">Files.copy(source.toPath(), dest.toPath());</div></pre></td></tr></table></figure>
<h2 id="创建多级目录"><a href="#创建多级目录" class="headerlink" title="创建多级目录"></a>创建多级目录</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">File files = <span class="keyword">new</span> File(<span class="string">"C:\\Directory2\\Sub2\\Sub-Sub2"</span>);</div><div class="line"><span class="keyword">if</span> (!files.exists()) &#123;</div><div class="line">    <span class="keyword">if</span> (files.mkdirs()) &#123;</div><div class="line">        System.out.println(<span class="string">"Multiple directories are created!"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        System.out.println(<span class="string">"Failed to create multiple directories!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="注解-1"><a href="#注解-1" class="headerlink" title="注解"></a>注解</h1><h2 id="内置注解"><a href="#内置注解" class="headerlink" title="内置注解"></a>内置注解</h2><h3 id="作用于Java代码的注解"><a href="#作用于Java代码的注解" class="headerlink" title="作用于Java代码的注解"></a>作用于Java代码的注解</h3><ul>
<li>@Override 检查某个方法<code>是否是复写的方法</code>，如果这个方法在父类或者实现的接口中未找到，编译会出错。</li>
<li>@Deprecated 标记某个<code>方法或者类被废弃</code>，如果使用该类或者方法，编译过程会报警告</li>
<li>@SuppressWarnings 通知编译器忽略关于被标注的参数的警告</li>
<li>@SafeVarargs 忽略关于调用含有泛型参数的方法或者构造器的警告，1.7新增注解</li>
<li>@FunctionalInterface 表明某一个声明的接口将被用作功能性接口，1.8新增注解 </li>
</ul>
<p>元注解（Meta Annotation） </p>
<ul>
<li><p>@Retention 指明被标注的注解在什么时候使用（也就是注解什么时候会被保留） </p>
<ul>
<li><code>仅在源代码中保留</code>，在编译过程中丢弃（RetentionPolicy.SOURCE）</li>
<li>注解<code>在编译过程中保存到class文件</code>，在class文件被加载时候忽略（RetentionPolicy.CLASS）</li>
<li>注解在class文件加载时候被读取，也就是<code>运行中注解可用</code>，可以通过反射获取注解信息（RetentionPolicy.RUNTIME）</li>
</ul>
</li>
<li><p>@Documented 指明在生成Javadoc时候，被标注的注解将被写入Javadoc文档中</p>
</li>
<li><p>@Target 指明被标注的注解的作用范围 </p>
<ul>
<li>ElementType.TYPE:用于描述类、接口(包括注解类型) 或enum声明</li>
<li>ElementType.FIELD:用于描述域</li>
<li>ElementType.METHOD:用于描述方法</li>
<li>ElementType.PARAMETER:用于描述参数</li>
<li>ElementType.CONSTRUCTOR:用于描述构造器</li>
<li>ElementType.LOCAL_VARIABLE:用于描述局部变量</li>
<li>ElementType.ANNOTATION_TYPE:用于描述注解</li>
<li>ElementType.PACKAGE:用于描述包</li>
</ul>
</li>
<li><p>@Inherited  指明被标注的注解是被继承的，也就是说如果一个@Inherited修饰的annotation类型被用于一个类，则这个annotation也会作用于改类的子类。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="meta">@Target</span>(ElementType.TYPE) <span class="comment">//on class level</span></div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> TesterInfo &#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> Priority &#123;</div><div class="line">       LOW, MEDIUM, HIGH</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function">Priority <span class="title">priority</span><span class="params">()</span> <span class="keyword">default</span> Priority.MEDIUM</span>;</div><div class="line"></div><div class="line">    String[] tags() <span class="keyword">default</span> <span class="string">""</span>;</div><div class="line"></div><div class="line">    <span class="function">String <span class="title">createdBy</span><span class="params">()</span> <span class="keyword">default</span> "Mkyong"</span>;</div><div class="line"></div><div class="line">    <span class="function">String <span class="title">lastModified</span><span class="params">()</span> <span class="keyword">default</span> "03/01/2014"</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@TesterInfo</span>(</div><div class="line">    priority = Priority.HIGH,</div><div class="line">    createdBy = <span class="string">"mkyong.com"</span>,</div><div class="line">    tags = &#123;<span class="string">"sales"</span>,<span class="string">"test"</span> &#125;</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestExample</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Class&lt;TestExample&gt; obj = TestExample.class;</div><div class="line"><span class="keyword">if</span> (obj.isAnnotationPresent(TesterInfo.class)) &#123;</div><div class="line">    Annotation annotation = obj.getAnnotation(TesterInfo.class);</div><div class="line">    TesterInfo testerInfo = (TesterInfo) annotation;</div><div class="line">&#125;</div><div class="line"><span class="keyword">for</span> (Method method : obj.getDeclaredMethods()) &#123;</div><div class="line">    <span class="keyword">if</span> (method.isAnnotationPresent(Test.class)) &#123;</div><div class="line">        Annotation annotation = method.getAnnotation(Test.class);</div><div class="line">        Test test = (Test) annotation;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="使用的Class文件来自哪个jar包"><a href="#使用的Class文件来自哪个jar包" class="headerlink" title="使用的Class文件来自哪个jar包"></a>使用的Class文件来自哪个jar包</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">URL location = Logger.class.getProtectionDomain().getCodeSource().getLocation();</div><div class="line">System.out.println(location);</div></pre></td></tr></table></figure>
<h2 id="查看编译版本"><a href="#查看编译版本" class="headerlink" title="查看编译版本"></a>查看编译版本</h2><p>javap -verbose MyClass | findstr “major”</p>
<p>jdk版本和major version对应关系<br>J2SE 8 = 52,<br>J2SE 7 = 51,<br>J2SE 6.0 = 50,<br>J2SE 5.0 = 49,<br>JDK 1.4 = 48,<br>JDK 1.3 = 47,<br>JDK 1.2 = 46,<br>JDK 1.1 = 45</p>
<h1 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h1><h2 id="静态方法泛型"><a href="#静态方法泛型" class="headerlink" title="静态方法泛型"></a>静态方法泛型</h2><p>静态方法操作的应用数据类型不确定，可以将泛型定义在方法上 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;W&gt; <span class="function"><span class="keyword">void</span> <span class="title">staticMethod</span><span class="params">(W w)</span></span>&#123;  </div><div class="line">    System.out.println(<span class="string">"staticMethod :"</span>+ w);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Spring 4]]></title>
      <url>http://xiaozhuang.github.io/2016/07/21/spring4/</url>
      <content type="html"><![CDATA[<p>Spring框架是以简化java EE应用程序的开发为目标而创建的。<br><a id="more"></a></p>
<h1 id="IOC"><a href="#IOC" class="headerlink" title="IOC"></a>IOC</h1><h2 id="Spring配置的可选方案"><a href="#Spring配置的可选方案" class="headerlink" title="Spring配置的可选方案"></a>Spring配置的可选方案</h2><ul>
<li>XML中显示配置</li>
<li>Java中显示配置</li>
<li>隐式的bean发现机制和自动装配</li>
</ul>
<p>建议尽可能地使用自动装配的机制，显示配置越少越好。<br>推荐使用类型安全且比XML更强大的JavaConfig。<br>只有需要使用便利地XML命名空间，并且在JavaConfig中没有同样的实现时，才应该使用XML。</p>
<h2 id="自动装配bean"><a href="#自动装配bean" class="headerlink" title="自动装配bean"></a>自动装配bean</h2><p>Spring 从两个角度实现自动化装配:</p>
<ul>
<li>组件扫描（component scanning）：发现应用上下文中所创建的bean。</li>
<li>自动装配（autowiring）：自动满足bean之间的依赖。</li>
</ul>
<h2 id="组件扫描的bean命名"><a href="#组件扫描的bean命名" class="headerlink" title="组件扫描的bean命名"></a>组件扫描的bean命名</h2><p>bean的ID默认为类名将首字母变为小写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//注解指定bean名称</span></div><div class="line"><span class="meta">@Component</span>(<span class="string">"cDPlayer"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CDPlayer</span> <span class="keyword">implements</span> <span class="title">MediaPlayer</span></span>&#123;&#125;</div></pre></td></tr></table></figure>
<h2 id="设置组件扫描的基础包"><a href="#设置组件扫描的基础包" class="headerlink" title="设置组件扫描的基础包"></a>设置组件扫描的基础包</h2><p>@Configuration</p>
<h3 id="默认基础包"><a href="#默认基础包" class="headerlink" title="默认基础包"></a>默认基础包</h3><p>@ComponentScan默认以配置类所在的包作为基础包</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@ComponentScan</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CDPlayerConfig</span> </span>&#123; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="String指定基础包"><a href="#String指定基础包" class="headerlink" title="String指定基础包"></a>String指定基础包</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.sunday"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CDPlayerConfig</span> </span>&#123; </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@ComponentScan</span>(basePackages=&#123;<span class="string">"com.sunday.controller"</span>,<span class="string">"com.sunday.services"</span>&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CDPlayerConfig</span> </span>&#123; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Class指定基础包"><a href="#Class指定基础包" class="headerlink" title="Class指定基础包"></a>Class指定基础包</h3><p>这些类所在的包将作为组件扫描的基础包（推荐使用这种方式）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@ComponentScan</span>(basePackageClasses=&#123;MediaPlayer.class&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CDPlayerConfig</span> </span>&#123; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以考虑在包中创建一个用来进行扫描的空标记接口（marker interface）</p>
<h2 id="通过java代码配置bean"><a href="#通过java代码配置bean" class="headerlink" title="通过java代码配置bean"></a>通过java代码配置bean</h2><p>在进行显示的配置时，javaConfig是更好的方案，它更为强大、类型安全且对重构友好。</p>
<h3 id="创建配置类"><a href="#创建配置类" class="headerlink" title="创建配置类"></a>创建配置类</h3><p>@Configuration注解表明类时配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CDPlayerConfig</span> </span>&#123; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="声明简单bean"><a href="#声明简单bean" class="headerlink" title="声明简单bean"></a>声明简单bean</h3><p>编写一个方法，该方法会创建所需类型的实例，然后给这个方法添加@bean注解。</p>
<p>@bean注解告诉Sring这个方法将会放回一个对象，该对象要注册为Spring应用上下文中的bean。<br>方法体中包含了最终<code>产生bean实例的逻辑</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> CompactDisc <span class="title">sgtPeppers</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> SgtPeppers();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//默认，bean的ID与带有@Bean注解的方法名是一样的</span></div><div class="line"><span class="comment">//通过name属性指定不同的名字</span></div><div class="line"><span class="meta">@Bean</span>(name = <span class="string">"sgtPeppers"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> CompactDisc <span class="title">sgtPeppers</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> SgtPeppers();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="借助javaConfig实现注入"><a href="#借助javaConfig实现注入" class="headerlink" title="借助javaConfig实现注入"></a>借助javaConfig实现注入</h3><p>方式1：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> CompactDisc <span class="title">sgtPeppers</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> SgtPeppers();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> MediaPlayer <span class="title">cDPlayer</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="comment">//通过调用sgtPeppers()实现注入</span></div><div class="line">	<span class="comment">//看起来CompactDisc是通过调用sgtPeppers获取的，但并非完全如此</span></div><div class="line">	<span class="comment">//sgtPeppers()是@bean注解的方法，Spring会拦截所有对它的调用，并确保直接放回该方法所创建的bean</span></div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> CDPlayer(sgtPeppers());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>方式2：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> CompactDisc <span class="title">sgtPeppers</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> SgtPeppers();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//将需要注入的对象，作为参数添加到参数列表</span></div><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> MediaPlayer <span class="title">cDPlayer</span><span class="params">(CompactDisc compactDisc)</span></span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> CDPlayer(compactDisc);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过这种方式引用其他bean通常是最佳的选择<br>它不会要求将CompactDisc生命到同一配置类中</p>
<h2 id="导入和混合配置"><a href="#导入和混合配置" class="headerlink" title="导入和混合配置"></a>导入和混合配置</h2><h3 id="JavaConfig配置导入"><a href="#JavaConfig配置导入" class="headerlink" title="JavaConfig配置导入"></a>JavaConfig配置导入</h3><p>使用<code>@Import</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@Import</span>(&#123;CDPlayerConfig.class&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationConfig</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="JavaConfig混合XML配置"><a href="#JavaConfig混合XML配置" class="headerlink" title="JavaConfig混合XML配置"></a>JavaConfig混合XML配置</h3><p>使用<code>@ImportResource</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@ImportResource</span>(<span class="string">"classpath:cd-config.xml"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationConfig</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="XML配置混合JavaConfig配置"><a href="#XML配置混合JavaConfig配置" class="headerlink" title="XML配置混合JavaConfig配置"></a>XML配置混合JavaConfig配置</h3><p>使用JavaConfig创建bean，添加到xml配置中</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"soundsystem.CDPlayerConfig"</span> /&gt;</span></div></pre></td></tr></table></figure>
<h1 id="读取配置文件"><a href="#读取配置文件" class="headerlink" title="读取配置文件"></a>读取配置文件</h1><h2 id="JavaConfig"><a href="#JavaConfig" class="headerlink" title="JavaConfig"></a>JavaConfig</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@PropertySources</span>(&#123;</div><div class="line">    <span class="meta">@PropertySource</span>(<span class="string">"classpath:db.properties"</span>),</div><div class="line">    <span class="meta">@PropertySource</span>(<span class="string">"classpath:redis.properties"</span>)</div><div class="line">&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> Environment env;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> JedisConnectionFactory <span class="title">jedisConnFactory</span><span class="params">(@Value(<span class="string">"$&#123;redis.usePool&#125;"</span>)</span> <span class="keyword">boolean</span> usePool)</span>&#123;</div><div class="line">        String redisHost = env.getProperty(<span class="string">"redis.host"</span>);</div><div class="line">        </div><div class="line">        JedisConnectionFactory jedisConnectionFactory = <span class="keyword">new</span> JedisConnectionFactory();</div><div class="line">        jedisConnectionFactory.setHostName(redisHost);</div><div class="line">        jedisConnectionFactory.setUsePool(usePool);</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> jedisConnectionFactory;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Conditional"><a href="#Conditional" class="headerlink" title="Conditional"></a>Conditional</h2><p><code>条件注册</code><br>@Conditional 只有在特定条件满足时才启用一些配置</p>
<p>除了自自定义Condition之外，Spring-boot还提供了很多Condition给我们用</p>
<a href="https://fangjian0423.github.io/2017/05/16/springboot-condition-annotation/" title="SpringBoot源码分析之条件注解的底层实现" target="_blank" rel="external">SpringBoot源码分析之条件注解的底层实现</a>
<p>@ConditionalOnBean（仅仅在当前上下文中存在某个对象时，才会实例化一个Bean）<br>@ConditionalOnClass（某个class位于类路径上，才会实例化一个Bean）<br>@ConditionalOnExpression（当表达式为true的时候，才会实例化一个Bean）<br>@ConditionalOnMissingBean（仅仅在当前上下文中不存在某个对象时，才会实例化一个Bean）<br>@ConditionalOnMissingClass（某个class类路径上不存在的时候，才会实例化一个Bean）<br>@ConditionalOnNotWebApplication（不是web应用）</p>
<h1 id="面向切面的Spring"><a href="#面向切面的Spring" class="headerlink" title="面向切面的Spring"></a>面向切面的Spring</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sunday.spring_boot_learn.aspect;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</div><div class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</div><div class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</div><div class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</div><div class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Sunday on 2017/5/17.</div><div class="line"> */</div><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpAspect</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(HttpAspect.class);</div><div class="line"></div><div class="line">    <span class="meta">@Pointcut</span>(<span class="string">"execution(public * com.sunday.spring_boot_learn.controller.PersonController.*(..))"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">()</span></span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="comment">//    @Before("log()")</span></div><div class="line"><span class="comment">//    public void doBefore(JoinPoint joinPoint)&#123;</span></div><div class="line"><span class="comment">//        //类名和方法名</span></div><div class="line"><span class="comment">//        logger.debug("before invoke: &#123;&#125;.&#123;&#125;() args=&#123;&#125;",</span></div><div class="line"><span class="comment">//                joinPoint.getSignature().getDeclaringTypeName(),</span></div><div class="line"><span class="comment">//                joinPoint.getSignature().getName(),</span></div><div class="line"><span class="comment">//                joinPoint.getArgs());</span></div><div class="line"><span class="comment">//    &#125;</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//    @After("log()")</span></div><div class="line"><span class="comment">//    public void doAfter(JoinPoint joinPoint)&#123;</span></div><div class="line"><span class="comment">//        logger.debug("after invoke: &#123;&#125;.&#123;&#125;() args=&#123;&#125;",</span></div><div class="line"><span class="comment">//                joinPoint.getSignature().getDeclaringTypeName(),</span></div><div class="line"><span class="comment">//                joinPoint.getSignature().getName(),</span></div><div class="line"><span class="comment">//                joinPoint.getArgs());</span></div><div class="line"><span class="comment">//    &#125;</span></div><div class="line"></div><div class="line">    <span class="meta">@Around</span>(<span class="string">"log()"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">doAround</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        logger.debug(<span class="string">"before invoke: &#123;&#125;.&#123;&#125;() args=&#123;&#125;"</span>,</div><div class="line">                joinPoint.getSignature().getDeclaringTypeName(),</div><div class="line">                joinPoint.getSignature().getName(),</div><div class="line">                joinPoint.getArgs());</div><div class="line"></div><div class="line">        Object result = joinPoint.proceed();</div><div class="line"></div><div class="line"></div><div class="line">        logger.debug(<span class="string">"after invoke: &#123;&#125;.&#123;&#125;() args=&#123;&#125;"</span>,</div><div class="line">                joinPoint.getSignature().getDeclaringTypeName(),</div><div class="line">                joinPoint.getSignature().getName(),</div><div class="line">                joinPoint.getArgs());</div><div class="line"></div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@AfterReturning</span>(returning = <span class="string">"object"</span>, pointcut = <span class="string">"log()"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfterReturning</span><span class="params">(Object object)</span></span>&#123;</div><div class="line">        logger.debug(<span class="string">"response=&#123;&#125;"</span>, object);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="注解事务"><a href="#注解事务" class="headerlink" title="注解事务"></a>注解事务</h1><p>@Transactional 注解</p>
<ul>
<li>name              指定事务管理器</li>
<li>propagation       事务传播行为，默认值 REQUIRED</li>
<li>isolation         事务隔离度，默认值 DEFAULT</li>
<li>timeout           事务的超时时间，默认值为-1，单位是秒</li>
<li>readOnly          是否为只读事务，默认值为 false</li>
<li>rollbackFor       能够触发事务回滚的异常类型</li>
<li>noRollbackFor     指定的异常类型，不回滚事务</li>
</ul>
<h2 id="事务传播行为"><a href="#事务传播行为" class="headerlink" title="事务传播行为"></a>事务传播行为</h2><table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>TransactionDefinition.PROPAGATION_REQUIRED</td>
<td><code>默认值</code>，如果当前存在事务，则加入该事务；如果当前没有事务，则创建一个新的事务</td>
</tr>
<tr>
<td>TransactionDefinition.PROPAGATION_REQUIRES_NEW</td>
<td>创建一个新的事务，如果当前存在事务，则把当前事务挂起</td>
</tr>
<tr>
<td>TransactionDefinition.PROPAGATION_SUPPORTS</td>
<td>如果当前存在事务，则加入该事务；如果当前没有事务，则以非事务的方式继续运行</td>
</tr>
<tr>
<td>TransactionDefinition.PROPAGATION_NOT_SUPPORTED</td>
<td>以非事务方式运行，如果当前存在事务，则把当前事务挂起</td>
</tr>
<tr>
<td>TransactionDefinition.PROPAGATION_NEVER</td>
<td>以非事务方式运行，如果当前存在事务，则抛出异常</td>
</tr>
<tr>
<td>TransactionDefinition.PROPAGATION_MANDATORY</td>
<td>如果当前存在事务，则加入该事务；如果当前没有事务，则抛出异常</td>
</tr>
<tr>
<td>TransactionDefinition.PROPAGATION_NESTED</td>
<td>如果当前存在事务，则创建一个事务作为当前事务的嵌套事务来运行；如果当前没有事务，则该取值等价于REQUIRED</td>
</tr>
</tbody>
</table>
<h2 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h2><table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>TransactionDefinition.ISOLATION_DEFAULT</td>
<td><code>默认值</code>，默认隔离级别</td>
</tr>
<tr>
<td>TransactionDefinition.ISOLATION_READ_UNCOMMITTED</td>
<td>未提交读（Read uncommitted）</td>
</tr>
<tr>
<td>TransactionDefinition.ISOLATION_READ_COMMITTED</td>
<td>已提交读（Read committed）</td>
</tr>
<tr>
<td>TransactionDefinition.ISOLATION_REPEATABLE_READ</td>
<td>可重复读（Repeatable read）</td>
</tr>
<tr>
<td>TransactionDefinition.ISOLATION_SERIALIZABLE</td>
<td>可串行化（Serializable）</td>
</tr>
</tbody>
</table>
<h2 id="事务的只读属性"><a href="#事务的只读属性" class="headerlink" title="事务的只读属性"></a>事务的只读属性</h2><p>如果确定只对事务性资源进行只读操作，那么我们可以将事务标志为只读的，以<code>提高事务处理的性能</code></p>
<h2 id="事务的回滚规则"><a href="#事务的回滚规则" class="headerlink" title="事务的回滚规则"></a>事务的回滚规则</h2><p>默认情况下，如果在事务中抛出了未检查异常（继承自 RuntimeException 的异常）或者 Error，则 Spring 将回滚事务；除此之外，Spring 不会回滚事务。</p>
<h2 id="注解方式的事务使用注意事项"><a href="#注解方式的事务使用注意事项" class="headerlink" title="注解方式的事务使用注意事项"></a>注解方式的事务使用注意事项</h2><p>@Transactional 只能应用到 public 方法才有效<br>若不是 public，就不会获取@Transactional 的属性配置信息，最终会造成不会用 TransactionInterceptor 来拦截该目标方法进行事务管理</p>
<h2 id="不加-Transactional"><a href="#不加-Transactional" class="headerlink" title="不加@Transactional"></a>不加@Transactional</h2><p>不管写不写transaction，事务是肯定有的。<br>只是<code>默认单条sql一个事务</code>，<br>如果我们在Service层的方法上加Transaction注解，那么事务的范围就会扩大，包含在service方法执行的所有sql</p>
<h1 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h1><h2 id="生成md5"><a href="#生成md5" class="headerlink" title="生成md5"></a>生成md5</h2><p><code>spring-core-3.0.3.RELEASE.jar</code><br>org.springframework.util.DigestUtils</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DigestUtils.md5DigestAsHex(filePath.getBytes()).toUpperCase();</div></pre></td></tr></table></figure>
<h1 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h1><p>spring mvc 3以及之前版本可能存在的一个<br>redirect引起的内存泄露问题<br>示例为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(method = RequestMethod.POST)  </div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">onPost</span><span class="params">()</span> </span>&#123;  </div><div class="line">    <span class="comment">// ...  </span></div><div class="line">    <span class="keyword">return</span> <span class="string">"redirect:form.html?entityId="</span> + entityId;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AbstractCachingViewResolver中viewCache缓存视图<br>redirect这个时候，使用的是整个从controller方法中返回的字符串，做为view name</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(method = RequestMethod.POST)    </div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">onPost</span><span class="params">(RedirectAttributes redirectAttrs)</span> </span>&#123;    </div><div class="line">    <span class="comment">// ...  </span></div><div class="line">    redirectAttrs.addAttribute(<span class="string">"entityId"</span>, entityId)  </div><div class="line">    <span class="keyword">return</span> <span class="string">"redirect:form.html?entityId=&#123;entityId&#125;"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java </tag>
            
            <tag> Sriing </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java Request Wrapper]]></title>
      <url>http://xiaozhuang.github.io/2016/06/30/request-wrapper/</url>
      <content type="html"><![CDATA[<p>问题：Filer拦截请求，通过request.getInputStream()获取RequestBody中内容，之后Filter再调用request.getInputStream()或request.getReader()抛异常java.lang.IllegalStateException<br>原因：request.getInputStream()与request.getReader()只能调用一次的问题<br>解决方法：使用HttpServletRequestWrapper<br><a id="more"></a></p>
<h1 id="定义Request包装器"><a href="#定义Request包装器" class="headerlink" title="定义Request包装器"></a>定义Request包装器</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> bingo.linksdk.uam_data_filter.common;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.BufferedReader;</div><div class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.InputStreamReader;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.ServletInputStream;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequestWrapper;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestBodyRequestWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String _body;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get_body</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> _body;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestBodyRequestWrapper</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(request);</div><div class="line">        _body = <span class="string">""</span>;</div><div class="line">        BufferedReader bufferedReader = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            bufferedReader = request.getReader();</div><div class="line">            String line = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</div><div class="line">                _body += line;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                bufferedReader.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ServletInputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">final</span> ByteArrayInputStream byteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(_body.getBytes());</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServletInputStream() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">                <span class="keyword">return</span> byteArrayInputStream.read();</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> BufferedReader <span class="title">getReader</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(<span class="keyword">this</span>.getInputStream()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Filter中使用Request包装器"><a href="#Filter中使用Request包装器" class="headerlink" title="Filter中使用Request包装器"></a>Filter中使用Request包装器</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">RequestBodyRequestWrapper requestBodyRequestWrapper = <span class="keyword">new</span> RequestBodyRequestWrapper((HttpServletRequest)request);</div><div class="line">String requestBody = requestBodyRequestWrapper.get_body();</div><div class="line"><span class="comment">//...</span></div><div class="line">chain.doFilter(requestBodyRequestWrapper, response);</div></pre></td></tr></table></figure>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><ul>
<li><a href="http://stackoverflow.com/questions/7318632/" title="stackoverflow.com" target="_blank" rel="external">java.lang.IllegalStateException</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Java EE </tag>
            
            <tag> Request Wrapper </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Cordeva]]></title>
      <url>http://xiaozhuang.github.io/2016/06/28/cordeva/</url>
      <content type="html"><![CDATA[<p>Apache Cordova allows for building native mobile applications using HTML, CSS and JavaScript.<br><a id="more"></a></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>系统:win7x64<br>基础软件:nodejs<br>系统环境变量:<br>Java JDK: installed .<br>Android SDK: installed<br>Android target: installed android-19,android-21,android-22,android-23,Google Inc.:Google APIs:19,Google Inc.:Google APIs (x86 System Image):19,Google Inc.:Google APIs:23<br>Gradle: installed</p>
<h2 id="Installing-Cordova-CLI"><a href="#Installing-Cordova-CLI" class="headerlink" title="Installing Cordova CLI"></a>Installing Cordova CLI</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -g cordova</div></pre></td></tr></table></figure>
<h2 id="Create-the-App"><a href="#Create-the-App" class="headerlink" title="Create the App"></a>Create the App</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cordova create hello com.example.hello HelloWorld</div></pre></td></tr></table></figure>
<h2 id="Add-Platforms"><a href="#Add-Platforms" class="headerlink" title="Add Platforms"></a>Add Platforms</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> hello</div><div class="line">cordova platform add ios --save</div><div class="line">cordova platform add android --save</div><div class="line">cordova platform ls</div></pre></td></tr></table></figure>
<h2 id="Install-the-Crosswalk-WebView-plugin"><a href="#Install-the-Crosswalk-WebView-plugin" class="headerlink" title="Install the Crosswalk WebView plugin"></a>Install the Crosswalk WebView plugin</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cordova plugin add cordova-plugin-crosswalk-webview</div><div class="line">cordova plugin remove cordova-plugin-crosswalk-webview</div></pre></td></tr></table></figure>
<h2 id="view-currently-installed-plugins"><a href="#view-currently-installed-plugins" class="headerlink" title="view currently installed plugins"></a>view currently installed plugins</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cordova plugin ls</div></pre></td></tr></table></figure>
<h2 id="Build-the-App"><a href="#Build-the-App" class="headerlink" title="Build the App"></a>Build the App</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># build the project for all platforms</span></div><div class="line">cordova build</div><div class="line"><span class="comment"># build to specific platforms</span></div><div class="line">cordova build android</div></pre></td></tr></table></figure>
<h2 id="Test-the-App"><a href="#Test-the-App" class="headerlink" title="Test the App"></a>Test the App</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cordova run android</div></pre></td></tr></table></figure>
<h2 id="Using-Plugman-to-Manage-Plugins"><a href="#Using-Plugman-to-Manage-Plugins" class="headerlink" title="Using Plugman to Manage Plugins"></a>Using Plugman to Manage Plugins</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">npm install -g plugman</div><div class="line"></div><div class="line"><span class="built_in">cd</span> F:\Lenovo\cordova\cordova_app\platforms\</div><div class="line"></div><div class="line">plugman search battery</div><div class="line"><span class="comment">#在指定平台目录下安装插件</span></div><div class="line"><span class="comment">#plugman install --platform &lt;platform&gt; --project &lt;directory&gt; --plugin &lt;plugin&gt; [--variable NAME=VALUE]</span></div><div class="line">plugman --install --platform android --project android --plugin cordova-plugin-battery-status</div><div class="line"></div><div class="line"><span class="comment">#cordova-plugin-console</span></div><div class="line">plugman install --platform android --project android --plugin cordova-plugin-console</div></pre></td></tr></table></figure>
<p>#inappbrowser<br>cordova-plugin-inappbrowser</p>
<p>应用内打开链接</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">window</span>.open(<span class="string">'https://m.baidu.com/'</span>,<span class="string">'_blank'</span>,);</div></pre></td></tr></table></figure>
<h1 id="xwalk命令行参数"><a href="#xwalk命令行参数" class="headerlink" title="xwalk命令行参数"></a>xwalk命令行参数</h1><p>assets文件夹下添加文件xwalk-command-line</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#允许跨域</div><div class="line">xwalk --disable-web-security</div></pre></td></tr></table></figure>
<h2 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h2><h3 id="每次执行cordova-build-android过程中下载gradle-2-2-1-all-zip"><a href="#每次执行cordova-build-android过程中下载gradle-2-2-1-all-zip" class="headerlink" title="每次执行cordova build android过程中下载gradle-2.2.1-all.zip"></a>每次执行cordova build android过程中下载gradle-2.2.1-all.zip</h3><p>手动下载gradle-2.2.1-all.zip，拷贝到类似目录下C:\Users\Sunday.gradle\wrapper\dists\gradle-2.2.1-all\2m8005s69iu8v0oiejfej094b</p>
<h3 id="Refused-to-execute-inline-event-handler-because-it-violates-the-following-Content-Security-Policy-directive-“default-src-‘self’-data-gap-https-ssl-gstatic-com-‘unsafe-eval’”-Either-the-‘unsafe-inline’-keyword-a-hash-‘sha256-…’-or-a-nonce-‘nonce-…’-is-required-to-enable-inline-execution-Note-also-that-‘script-src’-was-not-explicitly-set-so-‘default-src’-is-used-as-a-fallback-”-source-file-android-asset-www-index-html-40"><a href="#Refused-to-execute-inline-event-handler-because-it-violates-the-following-Content-Security-Policy-directive-“default-src-‘self’-data-gap-https-ssl-gstatic-com-‘unsafe-eval’”-Either-the-‘unsafe-inline’-keyword-a-hash-‘sha256-…’-or-a-nonce-‘nonce-…’-is-required-to-enable-inline-execution-Note-also-that-‘script-src’-was-not-explicitly-set-so-‘default-src’-is-used-as-a-fallback-”-source-file-android-asset-www-index-html-40" class="headerlink" title="Refused to execute inline event handler because it violates the following Content Security Policy directive: “default-src ‘self’ data: gap: https://ssl.gstatic.com ‘unsafe-eval’”. Either the ‘unsafe-inline’ keyword, a hash (‘sha256-…’), or a nonce (‘nonce-…’) is required to enable inline execution. Note also that ‘script-src’ was not explicitly set, so ‘default-src’ is used as a fallback.”, source: file:///android_asset/www/index.html (40)"></a>Refused to execute inline event handler because it violates the following Content Security Policy directive: “default-src ‘self’ data: gap: <a href="https://ssl.gstatic.com" target="_blank" rel="external">https://ssl.gstatic.com</a> ‘unsafe-eval’”. Either the ‘unsafe-inline’ keyword, a hash (‘sha256-…’), or a nonce (‘nonce-…’) is required to enable inline execution. Note also that ‘script-src’ was not explicitly set, so ‘default-src’ is used as a fallback.”, source: file:///android_asset/www/index.html (40)</h3><p>注释掉index第一行</p>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *">

<h3 id="cordova-首页为远程网页时，后续链接在外部浏览器中打开的问题"><a href="#cordova-首页为远程网页时，后续链接在外部浏览器中打开的问题" class="headerlink" title="cordova 首页为远程网页时，后续链接在外部浏览器中打开的问题"></a>cordova 首页为远程网页时，后续链接在外部浏览器中打开的问题</h3><p>在config.xml中添加：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--允许webview打开远程页面--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">access</span> <span class="attr">origin</span>=<span class="string">"*"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">access</span> <span class="attr">origin</span>=<span class="string">"http://*/*"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">access</span> <span class="attr">origin</span>=<span class="string">"https://*/*"</span> /&gt;</span></div><div class="line"><span class="comment">&lt;!--页为远程网页时，后续链接在webview打开--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">allow-navigation</span> <span class="attr">href</span>=<span class="string">"http://*/*"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">allow-navigation</span> <span class="attr">href</span>=<span class="string">"https://*/*"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p>即可允许所有http请求。</p>
<h3 id="Cordova-Plugins-and-thread-blocking"><a href="#Cordova-Plugins-and-thread-blocking" class="headerlink" title="Cordova Plugins and thread blocking"></a>Cordova Plugins and thread blocking</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cordova.getThreadPool().execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="执行cordova-platform-add-android-下载gradle"><a href="#执行cordova-platform-add-android-下载gradle" class="headerlink" title="执行cordova platform add android 下载gradle"></a>执行cordova platform add android 下载gradle</h3><p>先把等待的这个路径的压缩包下载下来（<a href="http://services.gradle.org/distributions/gradle-2.2.1-all.zip），" target="_blank" rel="external">http://services.gradle.org/distributions/gradle-2.2.1-all.zip），</a><br>然后直接放到系统目录中，我的系统目录是：<br>D:\userprofile\sqgyck.gradle\wrapper\dists\gradle-2.2.1-all\2m8005s69iu8v0oiejfej094b</p>
<h3 id="android-不同版本兼容处理"><a href="#android-不同版本兼容处理" class="headerlink" title="android 不同版本兼容处理"></a>android 不同版本兼容处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.HONEYCOMB) &#123;</div><div class="line">     ActionBar actionBar = getActionBar();</div><div class="line">     actionBar.setDisplayHomeAsUpEnabled(<span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="PluginManager-THREAD-WARNING-exec-call-to-Camera-takePicture-blocked-the-main-thread-for-68ms-Plugin-should-use-CordovaInterface-getThreadPool"><a href="#PluginManager-THREAD-WARNING-exec-call-to-Camera-takePicture-blocked-the-main-thread-for-68ms-Plugin-should-use-CordovaInterface-getThreadPool" class="headerlink" title="PluginManager: THREAD WARNING: exec() call to Camera.takePicture blocked the main thread for 68ms. Plugin should use CordovaInterface.getThreadPool()."></a>PluginManager: THREAD WARNING: exec() call to Camera.takePicture blocked the main thread for 68ms. Plugin should use CordovaInterface.getThreadPool().</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">cordova.getThreadPool().execute(</div><div class="line">	<span class="keyword">new</span> Runnable() &#123;</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">);</div></pre></td></tr></table></figure>
<h1 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h1><h2 id="cordova-plugin-camera"><a href="#cordova-plugin-camera" class="headerlink" title="cordova-plugin-camera"></a>cordova-plugin-camera</h2><p>Take pictures with the device camera.<br><a href="https://www.npmjs.com/package/cordova-plugin-camera" target="_blank" rel="external">https://www.npmjs.com/package/cordova-plugin-camera</a></p>
]]></content>
      
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> Cordeva </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[FIS]]></title>
      <url>http://xiaozhuang.github.io/2016/06/28/fis/</url>
      <content type="html"><![CDATA[<p>FIS3 是面向前端的工程构建工具。解决前端工程中性能优化、资源加载（异步、同步、按需、预加载、依赖管理、合并、内嵌）、模块化开发、自动化工具、开发规范、代码部署等问题。<br><a id="more"></a></p>
<h1 id="速查表"><a href="#速查表" class="headerlink" title="速查表"></a>速查表</h1><p>命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 构建项目</span></div><div class="line">fis3 release -d ../output</div><div class="line"></div><div class="line"><span class="comment"># 指定构建环境prod为环境名</span></div><div class="line">fis3 release prod</div></pre></td></tr></table></figure>
<p>配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// 资源添加md5戳</span></div><div class="line">fis.match(<span class="string">'*.js'</span>, &#123;</div><div class="line">  <span class="attr">useHash</span>: <span class="literal">false</span></div><div class="line">&#125;)</div><div class="line"></div><div class="line">fis.match(<span class="string">'*.&#123;js,css,png&#125;'</span>, &#123;</div><div class="line">  <span class="attr">useHash</span>: <span class="literal">true</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 资源压缩</span></div><div class="line">fis.match(<span class="string">'*.js'</span>, &#123;</div><div class="line">  <span class="comment">// fis-optimizer-uglify-js 插件进行压缩，已内置</span></div><div class="line">  optimizer: fis.plugin(<span class="string">'uglify-js'</span>)</div><div class="line">&#125;);</div><div class="line"></div><div class="line">fis.match(<span class="string">'*.css'</span>, &#123;</div><div class="line">  <span class="comment">// fis-optimizer-clean-css 插件进行压缩，已内置</span></div><div class="line">  optimizer: fis.plugin(<span class="string">'clean-css'</span>)</div><div class="line">&#125;);</div><div class="line"></div><div class="line">fis.match(<span class="string">'*.png'</span>, &#123;</div><div class="line">  <span class="comment">// fis-optimizer-png-compressor 插件进行压缩，已内置</span></div><div class="line">  optimizer: fis.plugin(<span class="string">'png-compressor'</span>)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#可使用cnpm替代npm</span></div><div class="line">npm install -g fis3</div><div class="line">fis3 -v</div></pre></td></tr></table></figure>
<h1 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h1><p>FIS3 的构建<code>不会修改源码</code>，而是会通过用户设置，将构建结果输出到指定的目录。</p>
<blockquote>
<p>FIS3 配置文件（默认fis-conf.js）所在的目录为项目根目录</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查看构建命令帮助</span></div><div class="line">fis3 release -h</div><div class="line"></div><div class="line"><span class="comment">#fis3 release -d &lt;path&gt;</span></div><div class="line"><span class="comment">#构建发布到output 目录下</span></div><div class="line">fis3 release -d ./output</div><div class="line">fis3 release -d D:\output</div></pre></td></tr></table></figure>
<h1 id="资源定位"><a href="#资源定位" class="headerlink" title="资源定位"></a>资源定位</h1><p>构建过程中对资源 URI 进行了替换，替换成了绝对 URL。通俗点讲就是相对路径换成了绝对路径。</p>
<p>资源定位能力，可以有效地分离开发路径与部署路径之间的关系<br>资源可以发布到任何静态资源服务器的任何路径上，而不用担心线上运行时找不到它们</p>
<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><p>默认配置文件为 fis-conf.js</p>
<h2 id="设置规则"><a href="#设置规则" class="headerlink" title="设置规则"></a>设置规则</h2><p>fis.match(selector, props);</p>
<p>FIS3 把匹配文件路径的路径作为selector，匹配到的文件会分配给它设置的 <code>props</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">fis.match(<span class="string">'*.css'</span>, &#123;</div><div class="line">  <span class="attr">useHash</span>: <span class="literal">false</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">fis.match(<span class="string">'*.png'</span>, &#123;</div><div class="line">  <span class="attr">useHash</span>: <span class="literal">false</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<blockquote>
<p>两条规则 A 和 B，它俩同时命中了文件 test.js，如果 A 在 B 前面，B 的属性会覆盖 A 的同名属性。不同名属性追加到 test.js 的 File 对象上。</p>
</blockquote>
<p>fis.media()<br>提供多种状态功能，比如有些配置是仅供开发环境下使用，有些则是仅供生产环境使用的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">fis.match(<span class="string">'*'</span>, &#123;</div><div class="line">  <span class="attr">useHash</span>: <span class="literal">false</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">fis.media(<span class="string">'prod'</span>).match(<span class="string">'*.js'</span>, &#123;</div><div class="line">  <span class="attr">optimizer</span>: fis.plugin(<span class="string">'uglify-js'</span>)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#fis3 release &lt;media&gt;</span></div><div class="line">fis3 release prod</div></pre></td></tr></table></figure>
<p>fis.media() 可以使配置文件变为多份（多个状态，一个状态一份配置）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">fis.media(<span class="string">'rd'</span>).match(<span class="string">'*'</span>, &#123;</div><div class="line">  <span class="attr">deploy</span>: fis.plugin(<span class="string">'http-push'</span>, &#123;</div><div class="line">    <span class="attr">receiver</span>: <span class="string">'http://remote-rd-host/receiver.php'</span></div><div class="line">  &#125;)</div><div class="line">&#125;);</div><div class="line"></div><div class="line">fis.media(<span class="string">'qa'</span>).match(<span class="string">'*'</span>, &#123;</div><div class="line">  <span class="attr">deploy</span>: fis.plugin(<span class="string">'http-push'</span>, &#123;</div><div class="line">    <span class="attr">receiver</span>: <span class="string">'http://remote-qa-host/receiver.php'</span></div><div class="line">  &#125;)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>fis3 release rd</code> push 到 RD 的远端机器上<br><code>fis3 release qa</code> push 到 QA 的远端机器上</p>
<blockquote>
<p>media dev 已经被占用，默认情况下不加 <media> 参数时默认为 dev</media></p>
</blockquote>
<h2 id="更多配置接口"><a href="#更多配置接口" class="headerlink" title="更多配置接口"></a>更多配置接口</h2><p>执行 <code>fis3 inspect</code> 查看文件命中属性的情况<br>fis3 inspect 是一个非常重要的命令，可以查看文件分配到的属性，这些属性决定了文件将如何被编译处理。</p>
<p>fis3 inspect <media> 查看特定 media 的分配情况</media></p>
<h2 id="更多信息"><a href="#更多信息" class="headerlink" title="更多信息"></a>更多信息</h2><h3 id="文件指纹"><a href="#文件指纹" class="headerlink" title="文件指纹"></a>文件指纹</h3><p>文件指纹，唯一标识一个文件。<br>FIS3 选择的是添加 MD5 戳，直接修改文件的 URL，而不是在其后添加 query</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">fis.match(<span class="string">'*.&#123;js,css,png&#125;'</span>, &#123;</div><div class="line">  <span class="attr">useHash</span>: <span class="literal">true</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="压缩资源"><a href="#压缩资源" class="headerlink" title="压缩资源"></a>压缩资源</h3><p>为了减少资源网络传输的大小，通过压缩器对 js、css、图片进行压缩</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">fis.match(<span class="string">'*.js'</span>, &#123;</div><div class="line">  <span class="comment">// fis-optimizer-uglify-js 插件进行压缩，已内置</span></div><div class="line">  optimizer: fis.plugin(<span class="string">'uglify-js'</span>)</div><div class="line">&#125;);</div><div class="line"></div><div class="line">fis.match(<span class="string">'*.css'</span>, &#123;</div><div class="line">  <span class="comment">// fis-optimizer-clean-css 插件进行压缩，已内置</span></div><div class="line">  optimizer: fis.plugin(<span class="string">'clean-css'</span>)</div><div class="line">&#125;);</div><div class="line"></div><div class="line">fis.match(<span class="string">'*.png'</span>, &#123;</div><div class="line">  <span class="comment">// fis-optimizer-png-compressor 插件进行压缩，已内置</span></div><div class="line">  optimizer: fis.plugin(<span class="string">'png-compressor'</span>)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="CssSprite图片合并"><a href="#CssSprite图片合并" class="headerlink" title="CssSprite图片合并"></a>CssSprite图片合并</h3><p>压缩了静态资源，我们还可以对图片进行合并，来减少请求数量<br>FIS3 构建会对 CSS 中，路径带 <code>?__sprite</code> 的图片进行合并。为了节省编译的时间，分配到 <code>useSprite: true</code> 的 CSS 文件才会被处理。</p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><ul>
<li><a href="http://fis.baidu.com/" title="FIS文档" target="_blank" rel="external">FIS文档</a>
</li>
</ul>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Buid </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Chocolatey Install]]></title>
      <url>http://xiaozhuang.github.io/2016/06/16/ChocolateyInstall/</url>
      <content type="html"><![CDATA[<p>Chocolatey is a package manager for Windows similar to yum and apt-get.<br>There is an official provider for Windows 10/Windows Server 2016’s built-in package manager (PowerShell PackageManagement) coming in summer 2016.</p>
<a id="more"></a>
<h1 id="Requirements："><a href="#Requirements：" class="headerlink" title="Requirements："></a>Requirements：</h1><p>Windows 7+ / Windows Server 2003+<br>PowerShell v2+<br>.NET Framework 4+ (the installation will attempt to install .NET 4.0 if you do not have it installed)</p>
<h1 id="安装："><a href="#安装：" class="headerlink" title="安装："></a>安装：</h1><p>以管理员运行cmd执行<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@powershell -NoProfile -ExecutionPolicy Bypass -Command <span class="string">"iex ((new-object net.webclient).DownloadString('https://chocolatey.org/install.ps1'))"</span> &amp;&amp; SET PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey\bin</div></pre></td></tr></table></figure></p>
<blockquote>
<p>默认安装位置：C:\ProgramData\chocolatey</p>
</blockquote>
<h1 id="Chocolatey的使用"><a href="#Chocolatey的使用" class="headerlink" title="Chocolatey的使用"></a>Chocolatey的使用</h1><h2 id="search命令"><a href="#search命令" class="headerlink" title="search命令"></a>search命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">choco search 关键字</div><div class="line">或</div><div class="line">cinst 关键字</div></pre></td></tr></table></figure>
<h2 id="install命令"><a href="#install命令" class="headerlink" title="install命令"></a>install命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">choco install 软件包名称</div><div class="line"><span class="comment">#或</span></div><div class="line">clist 软件包名称</div></pre></td></tr></table></figure>
<h2 id="update命令"><a href="#update命令" class="headerlink" title="update命令"></a>update命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">choco upgrade 软件包名称</div></pre></td></tr></table></figure>
<h2 id="uninstall命令"><a href="#uninstall命令" class="headerlink" title="uninstall命令"></a>uninstall命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">choco uninstall 软件包名称</div></pre></td></tr></table></figure>
<h2 id="ChocolateyGUI"><a href="#ChocolateyGUI" class="headerlink" title="ChocolateyGUI"></a>ChocolateyGUI</h2><p>如果不想在命令行下搜索和安装软件包，可以安装ChocolateyGUI，这是一个图形化的界面，可以方便的执行上述命令。<br><code>依赖dotNetFramework 4.5,Win7安装过程中更新PowerShell</code><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">choco install chocolateygui</div></pre></td></tr></table></figure></p>
<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><h2 id="安装7Zip"><a href="#安装7Zip" class="headerlink" title="安装7Zip"></a>安装7Zip</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cinst 7Zip</div></pre></td></tr></table></figure>
<h2 id="安装Node-js"><a href="#安装Node-js" class="headerlink" title="安装Node.js"></a>安装Node.js</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cinst node.js</div></pre></td></tr></table></figure>
<h2 id="安装IE10"><a href="#安装IE10" class="headerlink" title="安装IE10"></a>安装IE10</h2><p><code>Windows 7</code><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cinst IE10</div></pre></td></tr></table></figure></p>
<h2 id="安装Visual-Studio-2013-Ultimate"><a href="#安装Visual-Studio-2013-Ultimate" class="headerlink" title="安装Visual Studio 2013 Ultimate"></a>安装Visual Studio 2013 Ultimate</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cinst VisualStudio2013Ultimate</div></pre></td></tr></table></figure>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><ul>
<li><a href="https://chocolatey.org/install" title="chocolatey官网" target="_blank" rel="external">chocolatey官网</a></li>
<li><a href="http://blog.csdn.net/u011054333/article/details/51484943" title="Windows下的包管理器Chocolatey" target="_blank" rel="external">Windows下的包管理器Chocolatey</a></li>
<li><a href="Windows环境下的apt-get:Chocolatey" title="http://jingyan.baidu.com/article/456c463b6501330a583144d3.html Windows环境下的apt-get:Chocolatey"></a>
</li>
</ul>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Chocolatey </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Redis Install On CentOS]]></title>
      <url>http://xiaozhuang.github.io/2016/05/29/redis-install/</url>
      <content type="html"><![CDATA[<p>版本信息：</p>
<ul>
<li>CentOS 6.5x64</li>
<li>Redis 3.2.0</li>
</ul>
<a id="more"></a>
<h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">yum install -y gcc*</div><div class="line">yum install -y tcl</div><div class="line">yum install -y wget</div></pre></td></tr></table></figure>
<h1 id="下载并编译Redis"><a href="#下载并编译Redis" class="headerlink" title="下载并编译Redis"></a>下载并编译Redis</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">wget http://download.redis.io/releases/redis-3.2.0.tar.gz</div><div class="line">tar -xzvf redis-3.2.0.tar.gz -C /usr/<span class="built_in">local</span>/</div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/redis-3.2.0</div><div class="line">make</div><div class="line">make <span class="built_in">test</span></div><div class="line">make install <span class="comment">#安装Redis命令</span></div></pre></td></tr></table></figure>
<h1 id="修改Redis配置文件"><a href="#修改Redis配置文件" class="headerlink" title="修改Redis配置文件"></a>修改Redis配置文件</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /usr/<span class="built_in">local</span>/redis-3.2.0/redis.conf</div></pre></td></tr></table></figure>
<ol>
<li>允许通过任意ip地址访问Redis，原配置无法远程访问Redis<br>bind 127.0.0.1 改为 bind 0.0.0.0</li>
<li>设置密码<br>requirepass redispassword</li>
</ol>
<h1 id="安装Redis"><a href="#安装Redis" class="headerlink" title="安装Redis"></a>安装Redis</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/redis-3.2.0/utils</div><div class="line">./install_server.sh</div></pre></td></tr></table></figure>
<p>安装过程会提示输入Redis端口号、配置文件位置、日志位置、数据存储位置等信息<br>参考位置:</p>
<ul>
<li>配置：/var/redis/6379.conf</li>
<li>日志：/var/redis/log/redis_6379.log</li>
<li>数据：/var/redis/6379</li>
</ul>
<p>安装过程中将自动添加Redis服务开机自启<br>安装完成后Redis将自动启动</p>
<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">service redis_6379 status</div><div class="line">service redis_6379 start</div></pre></td></tr></table></figure>
<h1 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h1><p>Redis没有设置密码情况下可以使用以下命令,停止Redis服务；<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service redis_6379 stop</div></pre></td></tr></table></figure></p>
<p>若Redis设置了密码，执行这条命令会报错(error) NOAUTH Authentication required.<br>解决办法，使用Redis客户端登录Redis，再执行shutdown命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">redis-cli -a redispassword</div><div class="line">shutdown</div></pre></td></tr></table></figure></p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档:"></a>参考文档:</h1><ul>
<li><a href="http://www.cnblogs.com/haoxinyue/p/3620648.html" title="CentOS6.5下安装Redis2.8.7" target="_blank" rel="external">CentOS6.5下安装Redis2.8.7</a></li>
<li><a href="https://www.openprogrammer.info/2015/05/10/how-to-install-redis-3-x-on-new-centos-6-6-server/" title="How to install Redis 3.x on new CentOS 6.6 server" target="_blank" rel="external">How to install Redis 3.x on new CentOS 6.6 server</a>
<blockquote>
<p>注：该文章中yum -y update和yum -y upgrade命令，本人以为不可取</p>
</blockquote>
</li>
<li><a href="http://stackoverflow.com/questions/23396336/shutdown-redis-server-from-command-line" title="receive the error (error) NOAUTH Authentication required." target="_blank" rel="external">receive the error (error) NOAUTH Authentication required.</a>
</li>
</ul>
<h1 id="Redis-集群"><a href="#Redis-集群" class="headerlink" title="Redis 集群"></a>Redis 集群</h1><h2 id="Redis-集群的优势"><a href="#Redis-集群的优势" class="headerlink" title="Redis 集群的优势:"></a>Redis 集群的优势:</h2><p>自动分割数据到不同的节点上。<br>整个集群的部分节点失败或者不可达的情况下能够继续处理命令。</p>
<h2 id="Redis-集群的数据分片"><a href="#Redis-集群的数据分片" class="headerlink" title="Redis 集群的数据分片"></a>Redis 集群的数据分片</h2><p>Redis 集群没有使用一致性hash, 而是引入了 哈希槽的概念.<br>Redis 集群有16384个哈希槽,每个key通过CRC16校验后对16384取模来决定放置哪个槽.集群的每个节点负责一部分hash槽</p>
<h2 id="Redis-集群的主从复制模型"><a href="#Redis-集群的主从复制模型" class="headerlink" title="Redis 集群的主从复制模型"></a>Redis 集群的主从复制模型</h2><p>集群使用了主从复制模型,每个节点都会有N-1个slave.</p>
<h2 id="搭建并使用Redis集群"><a href="#搭建并使用Redis集群" class="headerlink" title="搭建并使用Redis集群"></a>搭建并使用Redis集群</h2><h3 id="配置节点"><a href="#配置节点" class="headerlink" title="配置节点"></a>配置节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">port 7000</div><div class="line">cluster-enabled yes</div><div class="line"># 节点配置文件的路径</div><div class="line">cluster-config-file nodes.conf</div><div class="line">cluster-node-timeout 5000</div><div class="line">appendonly yes</div></pre></td></tr></table></figure>
<p>要让集群正常运作至少需要三个主节点，不过在刚开始试用集群功能时， 强烈建议使用六个节点： 其中三个为主节点， 而其余三个则是各个主节点的从节点。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 启动节点</span></div><div class="line">../redis-server ./redis.conf</div></pre></td></tr></table></figure>
<h3 id="配置集群"><a href="#配置集群" class="headerlink" title="配置集群"></a>配置集群</h3><p>redis-trib 配置集群</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 建一个新的集群</span></div><div class="line"><span class="comment"># –replicas 1 表示为集群中的每个主节点创建一个从节点</span></div><div class="line">./redis-trib.rb create --replicas 1 127.0.0.1:7000 127.0.0.1:7001 \</div><div class="line">127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Hexo 学习笔记]]></title>
      <url>http://xiaozhuang.github.io/2016/05/28/hexo-note/</url>
      <content type="html"><![CDATA[<p>Hexo 是高效的静态站点生成框架，基于 Node.js。 通过 Hexo 可以轻松地使用 Markdown 编写文章，除 Markdown 本身的语法之外，还可以使用 Hexo 提供的 标签插件 快速的插入特定形式的内容<br><a id="more"></a></p>
<h1 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h1><h2 id="安装Node-js"><a href="#安装Node-js" class="headerlink" title="安装Node.js"></a>安装Node.js</h2><p>Hexo依赖0.12.*以上版本node.js</p>
<h2 id="安装Hexo-1"><a href="#安装Hexo-1" class="headerlink" title="安装Hexo"></a>安装Hexo</h2><p><code>注：windows以管理员运行cmd执行执行命令</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -g hexo-cli</div></pre></td></tr></table></figure>
<h2 id="Hexo初始化"><a href="#Hexo初始化" class="headerlink" title="Hexo初始化"></a>Hexo初始化</h2><p>进入将安装Hexo目录，Hexo初始化命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo init</div></pre></td></tr></table></figure></p>
<p>执行npm依赖包安装指令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install</div></pre></td></tr></table></figure></p>
<h2 id="生成部署文件"><a href="#生成部署文件" class="headerlink" title="生成部署文件"></a>生成部署文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo g</div></pre></td></tr></table></figure>
<h2 id="启动本地web服务器，预览博客"><a href="#启动本地web服务器，预览博客" class="headerlink" title="启动本地web服务器，预览博客"></a>启动本地web服务器，预览博客</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo s</div></pre></td></tr></table></figure>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><p><code>注：括号内为命令简写</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#生成静态文件，会在当前目录下生成一个新的叫做public的文件夹</span></div><div class="line">hexo generate (hexo g)</div><div class="line"><span class="comment">#启动本地web服务，用于博客的预览</span></div><div class="line">hexo server (hexo s)</div><div class="line"><span class="comment">#清除Hexo已生成的静态文件</span></div><div class="line">hexo clean</div><div class="line"><span class="comment">#部署博客到远端服务器</span></div><div class="line">hexo deploy (hexo d)</div><div class="line"><span class="comment">#生成静态文件完成后部署</span></div><div class="line">hexo generate --deploy</div><div class="line"><span class="comment">#监视文件变动</span></div><div class="line"><span class="comment">#Hexo 能够监视文件变动并立即重新生成静态文件，在生成时会比对文件的 SHA1 checksum，只要文件变动就会写入</span></div><div class="line">hexo generate --watch</div></pre></td></tr></table></figure></p>
<h1 id="部署博客到Github-Pages"><a href="#部署博客到Github-Pages" class="headerlink" title="部署博客到Github Pages"></a>部署博客到Github Pages</h1><p>每个帐号只能有一个仓库来存放个人主页，而且仓库的名字必须是username/username.github.io，这是特殊的命名约定。你可以通过<a href="http://username.github.io" target="_blank" rel="external">http://username.github.io</a> 来访问你的个人主页。</p>
<h2 id="配置SSH"><a href="#配置SSH" class="headerlink" title="配置SSH"></a>配置SSH</h2><h3 id="删除已有SSH信息"><a href="#删除已有SSH信息" class="headerlink" title="删除已有SSH信息"></a>删除已有SSH信息</h3><p>查看个人目录(C:\Users\username.ssh)下是否存在id_rsa、id_rsa.pub、known_hosts三个文件,如果存在删除这三个文件</p>
<h3 id="设置用户名和邮箱"><a href="#设置用户名和邮箱" class="headerlink" title="设置用户名和邮箱:"></a>设置用户名和邮箱:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git config --global user.name xxx</div><div class="line">git config --global user.email xxx@xxx.com</div></pre></td></tr></table></figure>
<h3 id="生成SSH公钥："><a href="#生成SSH公钥：" class="headerlink" title="生成SSH公钥："></a>生成SSH公钥：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ssh-keygen -t rsa -C xxx@xxx.com</div></pre></td></tr></table></figure>
<h3 id="将生成的SSH公钥添加到github："><a href="#将生成的SSH公钥添加到github：" class="headerlink" title="将生成的SSH公钥添加到github："></a>将生成的SSH公钥添加到github：</h3><p>拷贝C:\Users\username.ssh\id_rsa.pub内容<br>在网页版github settings页面，SSH and GPG keys 中添加生成的公钥</p>
<h3 id="测试SSH配置："><a href="#测试SSH配置：" class="headerlink" title="测试SSH配置："></a>测试SSH配置：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh git@github.com</div></pre></td></tr></table></figure>
<p>配置成功会显示以下打大致内容<br>The authenticity of host ‘github.com (192.30.252.128)’ can’t be established.<br>RSA key fingerprint is 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48.<br>Are you sure you want to continue connecting (yes/no)? yes<br>Warning: Permanently added ‘github.com,192.30.252.128’ (RSA) to the list of known hosts.<br>Hi git-xuhao! You’ve successfully authenticated, but GitHub does not provide shell access.<br>Connection to github.com closed.</p>
<h2 id="部署博客到github"><a href="#部署博客到github" class="headerlink" title="部署博客到github"></a>部署博客到github</h2><h3 id="修改博客网站配置文件Deployment部分"><a href="#修改博客网站配置文件Deployment部分" class="headerlink" title="修改博客网站配置文件Deployment部分"></a>修改博客网站配置文件Deployment部分</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Deployment</span></div><div class="line"><span class="comment">## Docs: https://hexo.io/docs/deployment.html</span></div><div class="line"><span class="attr">deploy:</span></div><div class="line"><span class="attr">  type:</span> <span class="string">git</span></div><div class="line"><span class="attr">  repo:</span> <span class="attr">https://github.com/username/username.github.io.git</span></div><div class="line"><span class="attr">  branch:</span> <span class="string">master</span></div></pre></td></tr></table></figure>
<h3 id="安装npm依赖"><a href="#安装npm依赖" class="headerlink" title="安装npm依赖"></a>安装npm依赖</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install hexo-deployer-git --save</div></pre></td></tr></table></figure>
<h3 id="部署博客到服务器"><a href="#部署博客到服务器" class="headerlink" title="部署博客到服务器"></a>部署博客到服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo deploy</div></pre></td></tr></table></figure>
<p>部署过程需要输入github用户名和密码</p>
<h1 id="添加搜索（Local-Search）"><a href="#添加搜索（Local-Search）" class="headerlink" title="添加搜索（Local Search）"></a>添加搜索（Local Search）</h1><h2 id="安装-hexo-generator-search，在站点的根目录下执行以下命令："><a href="#安装-hexo-generator-search，在站点的根目录下执行以下命令：" class="headerlink" title="安装 hexo-generator-search，在站点的根目录下执行以下命令："></a>安装 hexo-generator-search，在站点的根目录下执行以下命令：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install hexo-generator-search --save</div></pre></td></tr></table></figure>
<h2 id="修改站点配置文件"><a href="#修改站点配置文件" class="headerlink" title="修改站点配置文件"></a>修改站点配置文件</h2><h3 id="新增以下内容到任意位置："><a href="#新增以下内容到任意位置：" class="headerlink" title="新增以下内容到任意位置："></a>新增以下内容到任意位置：</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attr">search:</span></div><div class="line"><span class="attr">  path:</span> <span class="string">search.xml</span></div><div class="line"><span class="attr">  field:</span> <span class="string">post</span></div></pre></td></tr></table></figure>
<h3 id="修改url-配置为站点域名"><a href="#修改url-配置为站点域名" class="headerlink" title="修改url:配置为站点域名"></a>修改url:配置为站点域名</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">url:</span> <span class="attr">http://username.github.io/</span></div></pre></td></tr></table></figure>
<h1 id="写作"><a href="#写作" class="headerlink" title="写作"></a>写作</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#创建文章</span></div><div class="line">hexo new [title]</div><div class="line"><span class="comment">#创建分类</span></div><div class="line">hexo new page tags</div><div class="line"><span class="comment">#创建标签</span></div><div class="line">hexo new page categories</div></pre></td></tr></table></figure>
<h2 id="添加图片"><a href="#添加图片" class="headerlink" title="添加图片"></a>添加图片</h2><h3 id="文章资源文件夹"><a href="#文章资源文件夹" class="headerlink" title="文章资源文件夹"></a>文章资源文件夹</h3><p>Hexo提供了组织化的方式来管理资源,资源可以分布在各个文章上，通过将 <code>config.yml</code>文件中的 <code>post_asset_folder</code> 选项设为 <code>true</code> 来打开。<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">post_asset_folder:</span> <span class="literal">true</span></div></pre></td></tr></table></figure></p>
<p>资源文件管理功能打开后，Hexo将会在每一次通过 hexo new title命令创建新文章时自动创建一个文件夹,这个资源文件夹与 markdown 文件同名。将所有与文章有关的资源放在这个关联文件夹中，可以通过相对路径来引用它们</p>
<h3 id="相对路径引用"><a href="#相对路径引用" class="headerlink" title="相对路径引用"></a>相对路径引用</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;% asset_img slug [title] %&#125;</div><div class="line">资源链接</div><div class="line">&#123;% asset_link slug [title] %&#125;</div><div class="line">&#123;% asset_path slug %&#125;</div><div class="line">&#123;% link text url title %&#125;</div></pre></td></tr></table></figure>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><img src="/2016/05/28/hexo-note/github.png" alt="github Logo image" title="github Logo image">

<blockquote><p>NEW: DevDocs now comes with syntax highlighting. <a href="http://devdocs.io" target="_blank" rel="external">http://devdocs.io</a></p>
<footer><strong>@DevDocs</strong><cite><a href="https://twitter.com/devdocs/status/356095192085962752" target="_blank" rel="external">twitter.com/devdocs/status/356095192085962752</a></cite></footer></blockquote>
<h2 id="表格"><a href="#表格" class="headerlink" title="表格"></a>表格</h2><table>
<thead>
<tr>
<th>元字符</th>
<th>作用 </th>
</tr>
</thead>
<tbody>
<tr>
<td>(?: … )</td>
<td>非捕获型括号</td>
</tr>
<tr>
<td>?+ 、*+ 、++ 、 {m,n}+</td>
<td>占有优先量词</td>
</tr>
</tbody>
</table>
<h1 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h1><ul>
<li><a href="http://ms.csdn.net/geek/72697" title="基于Hexo+GitHub Pages 免费搭建个人博客最强教程" target="_blank" rel="external">基于Hexo+GitHub Pages 免费搭建个人博客最强教程</a></li>
<li><a href="http://theme-next.iissnan.com/" title="NexT主题" target="_blank" rel="external">NexT主题</a></li>
<li><a href="https://hexo.io/zh-cn/docs/" title="Hexo文档" target="_blank" rel="external">Hexo文档</a>
</li>
</ul>
]]></content>
      
        <categories>
            
            <category> Note </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
